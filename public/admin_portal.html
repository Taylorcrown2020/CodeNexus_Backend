<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamondback Coding | Admin Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
:root {
    --bg-void: #050506;
    --bg-primary: #0a0a0c;
    --bg-secondary: #101014;
    --bg-tertiary: #16161b;
    --bg-elevated: #1c1c22;
    --bg-hover: #222229;
    --border-subtle: rgba(255,255,255,0.04);
    --border-default: rgba(255,255,255,0.08);
    --border-strong: rgba(255,255,255,0.12);
    --text-primary: #f4f4f5;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --text-faint: #52525b;
--accent-amber: #22c55e;
--accent-amber-dim: rgba(34,197,94,0.12);
--accent-amber-glow: rgba(34,197,94,0.25);
--accent-copper: #16a34a;
--accent-rust: #15803d;
    --status-new: #3b82f6;
    --status-pending: #f59e0b;
    --status-contacted: #10b981;
    --status-closed: #8b5cf6;
    --status-lost: #ef4444;
    --status-draft: #71717a;
    --status-sent: #3b82f6;
    --status-paid: #10b981;
    --status-overdue: #ef4444;
    --priority-high: #ef4444;
    --priority-medium: #f59e0b;
    --priority-low: #71717a;
    --font-display: 'Outfit', -apple-system, sans-serif;
    --font-mono: 'Space Mono', monospace;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 20px;
    --shadow-glow: 0 0 60px rgba(245,158,11,0.08);
    --shadow-lg: 0 12px 40px rgba(0,0,0,0.5);
    --sidebar-width: 280px;
    --topbar-height: 72px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
    font-family: var(--font-display);
    background: var(--bg-void);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { 
    background: var(--border-strong); 
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: padding-box;
}
::-webkit-scrollbar-thumb:hover { background: var(--accent-amber); background-clip: padding-box; }

/* ========================================
   QR CODE STYLES
======================================== */
.qr-code-section {
    margin-top: 30px;
    padding: 24px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-subtle);
    text-align: center;
}

.qr-code-container {
    display: inline-block;
    padding: 20px;
    background: white;
    border-radius: var(--radius-md);
    margin: 16px auto;
}

.qr-code-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent-amber);
    margin-bottom: 8px;
}

.qr-code-instructions {
    font-size: 13px;
    color: var(--text-secondary);
    max-width: 400px;
    margin: 12px auto 0;
    line-height: 1.6;
}

.payment-url {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-muted);
    background: var(--bg-hover);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    margin-top: 12px;
    word-break: break-all;
}

/* ========================================
   SIDEBAR
======================================== */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: var(--sidebar-width);
    height: 100vh;
    background: var(--bg-primary);
    border-right: 1px solid var(--border-subtle);
    display: flex;
    flex-direction: column;
    z-index: 100;
    overflow: hidden;
}

.sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 1px;
    height: 100%;
    background: linear-gradient(180deg, var(--accent-amber) 0%, transparent 50%, var(--accent-amber) 100%);
    opacity: 0.3;
}

.sidebar-header {
    padding: 28px 24px;
    border-bottom: 1px solid var(--border-subtle);
    position: relative;
}

.logo {
    display: flex;
    align-items: center;
    gap: 14px;
}

.logo-mark {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-rust) 100%);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 4px 20px rgba(245,158,11,0.3);
}

.logo-mark::before {
    content: '';
    position: absolute;
    inset: -2px;
    background: linear-gradient(135deg, var(--accent-amber), transparent);
    border-radius: var(--radius-md);
    opacity: 0.5;
    z-index: -1;
}

.logo-mark svg {
    width: 24px;
    height: 24px;
    color: var(--bg-void);
}

.logo-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.logo-title {
    font-weight: 800;
    font-size: 17px;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-amber) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.logo-subtitle {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--text-muted);
}

.sidebar-nav {
    flex: 1;
    padding: 20px 16px;
    overflow-y: auto;
}

.nav-section {
    margin-bottom: 28px;
}

.nav-section-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-faint);
    padding: 0 12px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nav-section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border-subtle), transparent);
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    position: relative;
    margin-bottom: 4px;
}

.nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
    transform: translateX(4px);
}

.nav-item.active {
    background: var(--accent-amber-dim);
    color: var(--accent-amber);
    box-shadow: inset 0 0 0 1px var(--accent-amber-dim);
}

.nav-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 24px;
    background: var(--accent-amber);
    border-radius: 0 3px 3px 0;
    box-shadow: 0 0 12px var(--accent-amber);
}

.nav-icon {
    width: 18px;
    height: 18px;
    opacity: 0.7;
    flex-shrink: 0;
}

.nav-item.active .nav-icon { opacity: 1; }

.nav-badge {
    margin-left: auto;
    background: var(--accent-amber);
    color: var(--bg-void);
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 12px;
    min-width: 22px;
    text-align: center;
    font-family: var(--font-mono);
}

.sidebar-footer {
    padding: 20px;
    border-top: 1px solid var(--border-subtle);
    background: linear-gradient(180deg, transparent 0%, var(--bg-secondary) 100%);
}

.user-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid var(--border-subtle);
}

.user-card:hover {
    background: var(--bg-hover);
    border-color: var(--border-default);
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-rust) 100%);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: var(--bg-void);
}

.user-info { flex: 1; min-width: 0; }

.user-name {
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-role {
    font-size: 11px;
    color: var(--text-muted);
}

.logout-icon {
    width: 18px;
    height: 18px;
    color: var(--text-muted);
    transition: color 0.2s ease;
}

.user-card:hover .logout-icon { color: var(--status-lost); }

/* ========================================
   MAIN CONTENT
======================================== */
.main-content {
    margin-left: var(--sidebar-width);
    min-height: 100vh;
    background: var(--bg-void);
}

.topbar {
    position: sticky;
    top: 0;
    height: var(--topbar-height);
    background: rgba(5,5,6,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 36px;
    z-index: 50;
}

.page-header {
    display: flex;
    align-items: center;
    gap: 16px;
}

.page-title {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-title::before {
    content: '';
    width: 4px;
    height: 24px;
    background: var(--accent-amber);
    border-radius: 2px;
    box-shadow: 0 0 12px var(--accent-amber);
}

.topbar-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ========================================
   BUTTONS
======================================== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 11px 20px;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    white-space: nowrap;
    position: relative;
    overflow: hidden;
}

.btn svg { width: 16px; height: 16px; }

.btn-primary {
    background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-copper) 100%);
    color: var(--bg-void);
    box-shadow: 0 4px 16px rgba(245,158,11,0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(245,158,11,0.4);
}

.btn-primary:active { transform: translateY(0); }

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-default);
}

.btn-secondary:hover {
    background: var(--bg-hover);
    border-color: var(--border-strong);
    transform: translateY(-1px);
}

.btn-danger {
    background: rgba(239,68,68,0.1);
    color: var(--status-lost);
    border: 1px solid rgba(239,68,68,0.2);
}

.btn-danger:hover {
    background: var(--status-lost);
    color: #fff;
    border-color: var(--status-lost);
}

.btn-success {
    background: rgba(16,185,129,0.1);
    color: var(--status-contacted);
    border: 1px solid rgba(16,185,129,0.2);
}

.btn-success:hover {
    background: var(--status-contacted);
    color: #fff;
    border-color: var(--status-contacted);
}

.btn-sm {
    padding: 8px 14px;
    font-size: 12px;
}

.btn-sm svg { width: 14px; height: 14px; }

.btn-icon {
    width: 40px;
    height: 40px;
    padding: 0;
    border-radius: var(--radius-sm);
}

/* ========================================
   CONTENT AREA
======================================== */
.content {
    padding: 36px;
    max-width: 1600px;
}

/* ========================================
   STATS GRID
======================================== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 36px;
}

.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-amber), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stat-card:hover {
    border-color: var(--border-default);
    transform: translateY(-4px);
    box-shadow: var(--shadow-glow);
}

.stat-card:hover::before { opacity: 1; }

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.stat-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-icon svg { width: 18px; height: 18px; }

.stat-icon.amber { background: var(--accent-amber-dim); color: var(--accent-amber); }
.stat-icon.blue { background: rgba(59,130,246,0.12); color: var(--status-new); }
.stat-icon.green { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.stat-icon.purple { background: rgba(139,92,246,0.12); color: var(--status-closed); }
.stat-icon.red { background: rgba(239,68,68,0.12); color: var(--status-lost); }

.stat-value {
    font-size: 36px;
    font-weight: 800;
    letter-spacing: -0.03em;
    font-family: var(--font-mono);
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-change {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    margin-top: 8px;
    color: var(--text-muted);
}

.stat-change.positive { color: var(--status-contacted); }
.stat-change.negative { color: var(--status-lost); }

/* ========================================
   CONTROLS BAR
======================================== */
.controls-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 300px;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 12px 18px 12px 48px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.search-input:focus {
    outline: none;
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px var(--accent-amber-dim), var(--shadow-glow);
}

.search-input::placeholder { color: var(--text-muted); }

.search-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    width: 18px;
    height: 18px;
    transition: color 0.2s ease;
}

.search-input:focus + .search-icon,
.search-box:focus-within .search-icon { color: var(--accent-amber); }

.filter-group {
    display: flex;
    gap: 4px;
    background: var(--bg-primary);
    padding: 5px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.filter-btn {
    padding: 9px 16px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-btn:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.filter-btn.active {
    background: var(--accent-amber);
    color: var(--bg-void);
}

/* ========================================
   DATA TABLE
======================================== */
.table-container {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: var(--bg-secondary);
}

.data-table th {
    padding: 14px 18px;
    text-align: left;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border-subtle);
    white-space: nowrap;
}

.data-table td {
    padding: 16px 18px;
    font-size: 13px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: middle;
}

.data-table tbody tr {
    transition: all 0.2s ease;
    cursor: pointer;
}

.data-table tbody tr:hover {
    background: var(--bg-hover);
}

.data-table tbody tr:last-child td { border-bottom: none; }

.contact-cell {
    display: flex;
    align-items: center;
    gap: 14px;
}

.contact-avatar {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-hover));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
    flex-shrink: 0;
    border: 1px solid var(--border-subtle);
}

.contact-info { min-width: 0; }

.contact-name {
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-email {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ========================================
   STATUS BADGES
======================================== */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.status-new { background: rgba(59,130,246,0.12); color: var(--status-new); }
.status-new .status-dot { background: var(--status-new); }
.status-pending { background: rgba(245,158,11,0.12); color: var(--status-pending); }
.status-pending .status-dot { background: var(--status-pending); }
.status-contacted { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.status-contacted .status-dot { background: var(--status-contacted); }
.status-closed { background: rgba(139,92,246,0.12); color: var(--status-closed); }
.status-closed .status-dot { background: var(--status-closed); }
.status-lost, .status-churned, .status-cancelled { background: rgba(239,68,68,0.12); color: var(--status-lost); }
.status-lost .status-dot, .status-churned .status-dot, .status-cancelled .status-dot { background: var(--status-lost); }
.status-onboarding { background: rgba(6,182,212,0.12); color: #06b6d4; }
.status-onboarding .status-dot { background: #06b6d4; }
.status-in-progress { background: rgba(59,130,246,0.12); color: var(--status-new); }
.status-in-progress .status-dot { background: var(--status-new); }
.status-review { background: rgba(245,158,11,0.12); color: var(--status-pending); }
.status-review .status-dot { background: var(--status-pending); }
.status-completed { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.status-completed .status-dot { background: var(--status-contacted); }
.status-on-hold { background: rgba(113,113,122,0.12); color: var(--text-muted); }
.status-on-hold .status-dot { background: var(--text-muted); }
.status-draft { background: rgba(113,113,122,0.12); color: var(--status-draft); }
.status-draft .status-dot { background: var(--status-draft); }
.status-sent { background: rgba(59,130,246,0.12); color: var(--status-sent); }
.status-sent .status-dot { background: var(--status-sent); }
.status-paid { background: rgba(16,185,129,0.12); color: var(--status-paid); }
.status-paid .status-dot { background: var(--status-paid); }
.status-overdue { background: rgba(239,68,68,0.12); color: var(--status-overdue); }
.status-overdue .status-dot { background: var(--status-overdue); }

.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
}

.priority-high { background: rgba(239,68,68,0.12); color: var(--priority-high); }
.priority-medium { background: rgba(245,158,11,0.12); color: var(--priority-medium); }
.priority-low { background: rgba(113,113,122,0.12); color: var(--priority-low); }

/* ========================================
   TABLE ACTIONS
======================================== */
.table-actions {
    display: flex;
    gap: 6px;
}

.table-action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
}

.table-action-btn:hover {
    background: var(--bg-hover);
    border-color: var(--border-default);
    color: var(--text-primary);
}

.table-action-btn.danger:hover {
    background: rgba(239,68,68,0.12);
    border-color: var(--status-lost);
    color: var(--status-lost);
}

.table-action-btn svg { width: 14px; height: 14px; }

.table-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-top: 1px solid var(--border-subtle);
    background: var(--bg-secondary);
}

.table-info {
    font-size: 13px;
    color: var(--text-muted);
}

/* ========================================
   EMPTY STATE
======================================== */
.empty-state {
    padding: 80px 24px;
    text-align: center;
}

.empty-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 20px;
    color: var(--text-faint);
    opacity: 0.5;
}

.empty-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.empty-description {
    font-size: 14px;
    color: var(--text-muted);
    max-width: 320px;
    margin: 0 auto;
}

/* ========================================
   MODAL
======================================== */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 200;
    align-items: flex-start;
    justify-content: center;
    padding: 48px 24px;
    overflow-y: auto;
}

.modal-overlay.active { display: flex; }

.modal {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 800px;
    box-shadow: var(--shadow-lg), var(--shadow-glow);
    animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal.wide { max-width: 1100px; }

@keyframes modalSlide {
    from { opacity: 0; transform: translateY(-24px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 28px;
    border-bottom: 1px solid var(--border-subtle);
}

.modal-title {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 12px;
}

.modal-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: var(--accent-amber);
    border-radius: 2px;
}

.modal-close {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-hover);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-default);
}

.modal-body {
    padding: 28px;
    max-height: calc(100vh - 280px);
    overflow-y: auto;
}

.modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 28px;
    border-top: 1px solid var(--border-subtle);
    background: var(--bg-secondary);
    border-radius: 0 0 var(--radius-xl) var(--radius-xl);
}

/* ========================================
   FORM ELEMENTS
======================================== */
.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width { grid-column: 1 / -1; }

.form-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-label .required { color: var(--status-lost); }

.form-input,
.form-select,
.form-textarea {
    padding: 12px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px var(--accent-amber-dim);
}

.form-input::placeholder,
.form-textarea::placeholder { color: var(--text-muted); }

.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 40px;
}

.form-textarea {
    min-height: 120px;
    resize: vertical;
}

/* ========================================
   DETAIL SECTIONS
======================================== */
.detail-section {
    margin-bottom: 28px;
}

.detail-section:last-child { margin-bottom: 0; }

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 18px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-subtle);
}

.section-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent-amber);
}

.section-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border-subtle), transparent);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.detail-item {
    background: var(--bg-tertiary);
    padding: 14px 16px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.detail-item.full-width { grid-column: 1 / -1; }

.detail-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 6px;
}

.detail-value {
    font-size: 14px;
    color: var(--text-primary);
    word-break: break-word;
}

/* ========================================
   NOTES
======================================== */
.notes-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 18px;
    max-height: 320px;
    overflow-y: auto;
}

.note-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-left: 3px solid var(--accent-amber);
    border-radius: var(--radius-md);
    padding: 14px 16px;
}

.note-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.note-author {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
}

.note-date {
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--font-mono);
}

.note-text {
    font-size: 13px;
    color: var(--text-primary);
    line-height: 1.7;
}

.note-empty {
    text-align: center;
    padding: 32px;
    color: var(--text-muted);
    font-size: 14px;
}

/* ========================================
   EXPENSE SECTION
======================================== */
.expense-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 18px;
    max-height: 400px;
    overflow-y: auto;
}

.expense-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.expense-item:hover {
    border-color: var(--border-default);
    background: var(--bg-hover);
}

.expense-item.selected {
    border-color: var(--accent-amber);
    background: var(--accent-amber-dim);
}

.expense-checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid var(--border-strong);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.expense-checkbox:hover { border-color: var(--accent-amber); }

.expense-checkbox.checked {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.expense-checkbox svg {
    width: 14px;
    height: 14px;
    color: var(--bg-void);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.expense-checkbox.checked svg { opacity: 1; }

.expense-content { flex: 1; min-width: 0; }

.expense-description {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.expense-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: var(--text-muted);
}

.expense-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.expense-amount {
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-amber);
    font-family: var(--font-mono);
    white-space: nowrap;
}

.expense-actions {
    display: flex;
    gap: 6px;
}

.expense-empty {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    font-size: 14px;
}

/* ========================================
   INVOICE PREVIEW
======================================== */
.invoice-preview {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.invoice-preview-header {
    padding: 32px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.invoice-company {
    display: flex;
    align-items: center;
    gap: 16px;
}

.invoice-company-logo {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--accent-amber), var(--accent-rust));
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.invoice-company-logo svg {
    width: 28px;
    height: 28px;
    color: var(--bg-void);
}

.invoice-company-name {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.invoice-company-tagline {
    font-size: 12px;
    color: var(--text-muted);
}

.invoice-info {
    text-align: right;
}

.invoice-title {
    font-size: 32px;
    font-weight: 800;
    color: var(--accent-amber);
    letter-spacing: -0.02em;
    margin-bottom: 8px;
}

.invoice-number {
    font-size: 14px;
    color: var(--text-secondary);
    font-family: var(--font-mono);
}

.invoice-preview-body { padding: 32px; }

.invoice-parties {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 32px;
    margin-bottom: 32px;
}

.invoice-party-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 12px;
}

.invoice-party-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.invoice-party-details {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.7;
}

.invoice-dates {
    display: flex;
    gap: 32px;
    margin-bottom: 32px;
}

.invoice-date-item {
    background: var(--bg-tertiary);
    padding: 14px 20px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.invoice-date-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.invoice-date-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.invoice-items-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
}

.invoice-items-table th {
    text-align: left;
    padding: 14px 16px;
    background: var(--bg-tertiary);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-items-table th:last-child { text-align: right; }

.invoice-items-table td {
    padding: 16px;
    font-size: 14px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-items-table td:last-child {
    text-align: right;
    font-family: var(--font-mono);
    font-weight: 600;
}

.invoice-items-table tbody tr:hover { background: var(--bg-hover); }

.invoice-totals {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
}

.invoice-total-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 280px;
    padding: 10px 0;
}

.invoice-total-label {
    font-size: 13px;
    color: var(--text-secondary);
}

.invoice-total-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.invoice-total-row.grand {
    border-top: 2px solid var(--accent-amber);
    margin-top: 8px;
    padding-top: 16px;
}

.invoice-total-row.grand .invoice-total-label {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}

.invoice-total-row.grand .invoice-total-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-amber);
}

.invoice-preview-footer {
    padding: 24px 32px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-subtle);
}

/* Invoice Preview Improvements */
.invoice-preview {
    border-top: 4px solid var(--accent-amber);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.invoice-preview-header {
    padding: 40px 32px;
    background: var(--bg-tertiary);
}

.invoice-company-logo {
    width: 64px;
    height: 64px;
}

.invoice-company-logo svg {
    width: 32px;
    height: 32px;
}

.invoice-number {
    font-size: 16px;
    letter-spacing: 0.05em;
}

.invoice-items-table th {
    font-size: 11px;
    color: var(--accent-amber);
}

.invoice-items-table td {
    font-size: 15px;
}

.invoice-items-table tbody tr:hover {
    background: rgba(245,158,11,0.03);
}

.invoice-totals {
    background: var(--bg-tertiary);
    padding: 24px;
    border-radius: var(--radius-md);
    margin-top: 20px;
    border-top: 2px solid var(--border-subtle);
    padding-top: 24px;
}

.invoice-total-row.grand .invoice-total-value {
    font-size: 32px;
}

.invoice-notes-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.invoice-notes-text {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.7;
}

/* ========================================
   CARDS GRID (Employees/Invoices)
======================================== */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.card:hover {
    border-color: var(--border-default);
    transform: translateY(-4px);
    box-shadow: var(--shadow-glow);
}

.employee-card .card-header {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 20px;
}

.employee-avatar-lg {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, var(--accent-amber), var(--accent-rust));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: var(--bg-void);
    flex-shrink: 0;
}

.employee-details { flex: 1; min-width: 0; }

.employee-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.employee-role {
    font-size: 13px;
    color: var(--accent-amber);
    font-weight: 600;
}

.employee-meta {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.employee-meta-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: var(--text-secondary);
}

.employee-meta-item svg {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
}

.employee-stats {
    display: flex;
    gap: 16px;
    padding-top: 20px;
    border-top: 1px solid var(--border-subtle);
}

.employee-stat {
    flex: 1;
    text-align: center;
}

.employee-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.employee-stat-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.card-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.card-actions .btn { flex: 1; }

/* ========================================
   INVOICE CARDS
======================================== */
/* Invoice Card Improvements */
.invoice-card {
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.invoice-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--text-primary), var(--text-secondary));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.invoice-card:hover::before {
    opacity: 1;
}

.invoice-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-card-number {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
    letter-spacing: 0.02em;
}

.invoice-card-customer {
    font-size: 14px;
    color: var(--text-secondary);
    margin-top: 6px;
}

.invoice-card-amount {
    font-size: 32px;
    font-weight: 800;
    color: var(--text-primary);
    font-family: var(--font-mono);
    margin-bottom: 20px;
    letter-spacing: -0.02em;
}

.invoice-card-meta {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-subtle);
}

.invoice-card-meta-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
    background: var(--bg-secondary);
    padding: 12px 14px;
    border-radius: var(--radius-sm);
}

.invoice-card-meta-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.invoice-card-meta-value {
    font-size: 14px;
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-weight: 600;
}

.invoice-card:hover .invoice-card-amount {
    color: var(--text-primary);
}

/* ========================================
   ANALYTICS
======================================== */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
}

.analytics-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 28px;
}

.analytics-card.full-width { grid-column: 1 / -1; }

.analytics-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
}

.analytics-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
}

.chart-container {
    height: 220px;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    padding-top: 24px;
}

.chart-bar {
    flex: 1;
    background: linear-gradient(180deg, var(--accent-amber-dim) 0%, rgba(245,158,11,0.05) 100%);
    border-radius: 6px 6px 0 0;
    position: relative;
    min-height: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--accent-amber-dim);
    border-bottom: none;
}

.chart-bar:hover {
    background: linear-gradient(180deg, var(--accent-amber) 0%, var(--accent-amber-dim) 100%);
    border-color: var(--accent-amber);
}

.chart-bar-label {
    position: absolute;
    bottom: -28px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: var(--text-muted);
    white-space: nowrap;
    font-weight: 500;
}

.chart-bar-value {
    position: absolute;
    top: -24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent-amber);
    font-family: var(--font-mono);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.chart-bar:hover .chart-bar-value { opacity: 1; }

.metrics-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.metric-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.metric-label {
    font-size: 13px;
    color: var(--text-secondary);
}

.metric-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.progress-bar {
    height: 8px;
    background: var(--bg-hover);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-amber), var(--accent-rust));
    border-radius: 4px;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ========================================
   SETTINGS
======================================== */
.settings-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 32px;
}

.settings-nav {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.settings-nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
}

.settings-nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.settings-nav-item.active {
    background: var(--accent-amber-dim);
    color: var(--accent-amber);
}

.settings-nav-item svg { width: 18px; height: 18px; }

.settings-panel {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 28px;
}

.settings-section { margin-bottom: 36px; }
.settings-section:last-child { margin-bottom: 0; }

.settings-section-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 6px;
}

.settings-section-desc {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 24px;
}

.setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 0;
    border-bottom: 1px solid var(--border-subtle);
}

.setting-row:last-child { border-bottom: none; }

.setting-info { flex: 1; }

.setting-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.setting-desc {
    font-size: 13px;
    color: var(--text-muted);
}

.toggle {
    position: relative;
    width: 50px;
    height: 28px;
}

.toggle input { opacity: 0; width: 0; height: 0; }

.toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--bg-hover);
    border: 1px solid var(--border-default);
    border-radius: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.toggle-slider::before {
    content: '';
    position: absolute;
    height: 22px;
    width: 22px;
    left: 2px;
    bottom: 2px;
    background: var(--text-secondary);
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.toggle input:checked + .toggle-slider {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.toggle input:checked + .toggle-slider::before {
    transform: translateX(22px);
    background: var(--bg-void);
}

/* ========================================
   TASKS
======================================== */
.tasks-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.task-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 20px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.task-item:hover { border-color: var(--border-default); }

.task-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border-strong);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.task-checkbox:hover { border-color: var(--accent-amber); }

.task-checkbox.checked {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.task-checkbox svg {
    width: 14px;
    height: 14px;
    color: var(--bg-void);
    opacity: 0;
}

.task-checkbox.checked svg { opacity: 1; }

.task-content { flex: 1; min-width: 0; }

.task-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 6px;
}

.task-item.completed .task-title {
    text-decoration: line-through;
    color: var(--text-muted);
}

.task-meta {
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 12px;
    color: var(--text-muted);
}

.task-due {
    display: flex;
    align-items: center;
    gap: 6px;
}

.task-due.overdue { color: var(--status-lost); }

/* ========================================
   TOAST NOTIFICATIONS
======================================== */
.toast-container {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 300;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 20px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    animation: toastSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 320px;
}

@keyframes toastSlide {
    from { opacity: 0; transform: translateX(100%) scale(0.95); }
    to { opacity: 1; transform: translateX(0) scale(1); }
}

.toast-icon {
    width: 22px;
    height: 22px;
    flex-shrink: 0;
}

.toast.success .toast-icon { color: var(--status-contacted); }
.toast.error .toast-icon { color: var(--status-lost); }
.toast.warning .toast-icon { color: var(--status-pending); }

.toast-message {
    font-size: 14px;
    color: var(--text-primary);
    flex: 1;
}

.toast-close {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.toast-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

/* ========================================
   TABS
======================================== */
.tabs {
    display: flex;
    gap: 4px;
    background: var(--bg-primary);
    padding: 5px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
    margin-bottom: 24px;
}

.tab {
    padding: 10px 20px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tab:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.tab.active {
    background: var(--accent-amber);
    color: var(--bg-void);
}

/* ========================================
   RESPONSIVE
======================================== */
@media (max-width: 1200px) {
    .analytics-grid { grid-template-columns: 1fr; }
    .settings-layout { grid-template-columns: 1fr; }
    .settings-nav { flex-direction: row; flex-wrap: wrap; }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    .sidebar.active { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .topbar { padding: 0 20px; }
    .content { padding: 24px; }
    .form-grid,
    .detail-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .controls-bar {
        flex-direction: column;
        align-items: stretch;
    }
    .search-box { min-width: 100%; }
    .invoice-parties { grid-template-columns: 1fr; }
    .modal { margin: 16px; }
}

/* ========================================
   PRINT STYLES (for invoices)
======================================== */
@media print {
    body {
        background: white !important;
        color: black !important;
    }
    .sidebar,
    .topbar,
    .modal-overlay,
    .toast-container,
    .btn { display: none !important; }
    .main-content { margin-left: 0 !important; }
    .invoice-preview {
        background: white !important;
        border: none !important;
        box-shadow: none !important;
    }
}
/* ========================================
   LIGHT MODE OVERRIDES
======================================== */
body.light-mode {
    background: #f5f5f7;
}

body.light-mode .sidebar {
    background: #ffffff;
    border-right-color: rgba(0,0,0,0.08);
}

body.light-mode .sidebar::before {
    background: linear-gradient(180deg, var(--accent-amber) 0%, transparent 50%, var(--accent-amber) 100%);
}

body.light-mode .topbar {
    background: rgba(255,255,255,0.9);
    border-bottom-color: rgba(0,0,0,0.08);
}

body.light-mode .logo-title {
    background: linear-gradient(135deg, #1a1a1a 0%, var(--accent-amber) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

body.light-mode .stat-value {
    background: linear-gradient(135deg, #1a1a1a 0%, #495057 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

body.light-mode .data-table thead {
    background: #f8f9fa;
}

body.light-mode .modal {
    background: #ffffff;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
}

body.light-mode .modal-footer {
    background: #f8f9fa;
}

body.light-mode .invoice-preview {
    background: #ffffff;
}

body.light-mode .invoice-preview-header {
    background: #f8f9fa;
}

body.light-mode .form-input,
body.light-mode .form-select,
body.light-mode .form-textarea {
    background: #ffffff;
    border-color: rgba(0,0,0,0.15);
    color: #1a1a1a;
}

body.light-mode .form-input:focus,
body.light-mode .form-select:focus,
body.light-mode .form-textarea:focus {
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px rgba(245,158,11,0.15);
}

body.light-mode .search-input {
    background: #ffffff;
    border-color: rgba(0,0,0,0.12);
}

body.light-mode .filter-group {
    background: #ffffff;
    border-color: rgba(0,0,0,0.12);
}

body.light-mode .toast {
    background: #ffffff;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

body.light-mode ::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
}

body.light-mode ::-webkit-scrollbar-thumb:hover {
    background: var(--accent-amber);
}
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-mark">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <div class="logo-title">Diamondback Coding</div>
                    <div class="logo-subtitle">Admin Portal</div>
                </div>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <div class="nav-item active" data-section="dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    Dashboard
                </div>
                <div class="nav-item" data-section="analytics">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18 17V9"/>
                        <path d="M13 17V5"/>
                        <path d="M8 17v-3"/>
                    </svg>
                    Analytics
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Pipeline</div>
                <div class="nav-item" data-section="leads">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    All Leads
                    <span class="nav-badge" id="leadsBadge">0</span>
                </div>
                <div class="nav-item" data-section="new">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    New
                    <span class="nav-badge" id="newBadge">0</span>
                </div>
                <div class="nav-item" data-section="pending">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Pending
                    <span class="nav-badge" id="pendingBadge">0</span>
                </div>
                <div class="nav-item" data-section="contacted">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
                    </svg>
                    Contacted
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <div class="nav-item" data-section="customers">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Customers
                    <span class="nav-badge" id="customersBadge">0</span>
                </div>
                <div class="nav-item" data-section="employees">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                    </svg>
                    Team
                </div>
                <div class="nav-item" data-section="invoices">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    Invoices
                    <span class="nav-badge" id="invoicesBadge">0</span>
                </div>
                <div class="nav-item" data-section="tasks">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    Tasks
                </div>
                <div class="nav-item" data-section="projects">
    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
    </svg>
    Project Timelines
</div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <div class="nav-item" data-section="settings">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </div>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-card" onclick="logout()">
                <div class="user-avatar">AD</div>
                <div class="user-info">
                    <div class="user-name">Admin User</div>
                    <div class="user-role">Administrator</div>
                </div>
                <svg class="logout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="topbar">
            <div class="page-header">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="topbar-actions">
                <button class="btn btn-secondary" onclick="openExportModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                </button>
                <button class="btn btn-primary" onclick="openCreateModal('lead')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Lead
                </button>
            </div>
        </header>
        
        <div class="content" id="contentArea">
            <!-- Content will be dynamically loaded -->
        </div>
    </main>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title" id="detailModalTitle">Lead Details</h2>
                <button class="modal-close" onclick="closeDetailModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="detailModalBody"></div>
            <div class="modal-footer" id="detailModalFooter"></div>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="createModalTitle">Create Lead</h2>
                <button class="modal-close" onclick="closeCreateModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="createModalBody"></div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title" id="invoiceModalTitle">Create Invoice</h2>
                <button class="modal-close" onclick="closeInvoiceModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="invoiceModalBody"></div>
            <div class="modal-footer" id="invoiceModalFooter"></div>
        </div>
    </div>

    // Add this field to the invoice details form:
<div class="form-group full-width">
    <label class="form-label">Invoice Description (for payment page)</label>
    <input type="text" class="form-input" id="invoiceShortDescription" 
           placeholder="e.g., Website Development Services" 
           maxlength="100">
</div>

    <!-- Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Record Payment</h2>
            <button class="modal-close" onclick="closePaymentModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body" id="paymentModalBody"></div>
    </div>
</div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
// ========================================
// STATE & CONFIGURATION
// ========================================
const API_URL = window.location.origin;
const FRONTEND_BASE_URL = 'https://diamondbackcoding.com';
let authToken = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');

const state = {
    leads: [],
    customers: [],
    employees: [],
    invoices: [],
    tasks: [],
    currentSection: 'dashboard',
    currentFilter: 'all',
    currentLead: null,
    currentInvoice: null,
    selectedExpenses: [],
    searchQuery: '',
    settings: {
        emailNotifications: true,
        pushNotifications: false,
        darkMode: true,
        autoAssign: false,
        weeklyReport: true
    }
};

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', async function() {
    if (!authToken) {
        window.location.href = '/admin';
        return;
    }
    
    try {
        const r = await fetch(`${API_URL}/api/admin/verify`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            localStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminToken');
            window.location.href = '/admin';
            return;
        }
    } catch (e) {
        console.error('Token verification failed:', e);
        window.location.href = '/admin';
        return;
    }
    
    await loadAllData();
loadSettings();  // ADD THIS LINE
setupNavigation();
renderSection('dashboard');
});

// ========================================
// DATA LOADING
// ========================================
async function loadAllData() {
    await Promise.all([
        loadLeads(),
        loadEmployees(),
        loadInvoices(),
        loadTasks()
    ]);
    updateBadges();
}

async function loadLeads() {
    try {
        const r = await fetch(`${API_URL}/api/leads`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (r.status === 401 || r.status === 403) {
            logout();
            return;
        }
        
        const d = await r.json();
        if (d.success) {
            state.leads = (d.leads || []).filter(l => !l.is_customer);
            state.customers = (d.leads || []).filter(l => l.is_customer);
        }
    } catch (e) {
        console.error('Error loading leads:', e);
    }
}

async function loadEmployees() {
    try {
        const r = await fetch(`${API_URL}/api/employees`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            console.error('Failed to load employees, status:', r.status);
            return;
        }
        
        const d = await r.json();
        console.log('Loaded employees:', d); // Debug log
        
        if (d.success) {
            state.employees = d.employees || [];
        }
    } catch (e) {
        console.error('Error loading employees:', e);
    }
}

async function loadInvoices() {
    try {
        const r = await fetch(`${API_URL}/api/invoices`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!r.ok) return;
        const d = await r.json();
        if (d.success) {
            state.invoices = (d.invoices || []).map(inv => {
                // Parse items if they're stored as JSON string
                if (typeof inv.items === 'string') {
                    try {
                        inv.items = JSON.parse(inv.items);
                    } catch (e) {
                        inv.items = [];
                    }
                }
                // Ensure customer name is set
                if (!inv.customer_name && inv.first_name) {
                    inv.customer_name = `${inv.first_name} ${inv.last_name || ''}`.trim();
                }
                if (!inv.customer_name && inv.name) {
                    inv.customer_name = inv.name;
                }
                if (!inv.customer_email && inv.email) {
                    inv.customer_email = inv.email;
                }
                if (!inv.customer_company && inv.company) {
                    inv.customer_company = inv.company;
                }
                return inv;
            });
        }
    } catch (e) {
        console.error('Error loading invoices:', e);
    }
}

async function loadTasks() {
    state.tasks = [
        { id: 1, title: 'Follow up with new leads', dueDate: '2026-01-20', assignee: 'Admin', completed: false, priority: 'high' },
        { id: 2, title: 'Prepare weekly report', dueDate: '2026-01-22', assignee: 'Admin', completed: false, priority: 'medium' },
        { id: 3, title: 'Review contract terms', dueDate: '2026-01-18', assignee: 'Admin', completed: true, priority: 'low' },
        { id: 4, title: 'Schedule team meeting', dueDate: '2026-01-25', assignee: 'Admin', completed: false, priority: 'medium' }
    ];
}

async function loadExpenses(leadId) {
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/expenses?includeInvoiced=false`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!r.ok) return [];
        const d = await r.json();
        return d.success ? d.expenses || [] : [];
    } catch (e) {
        console.error('Error loading expenses:', e);
        return [];
    }
}

function updateBadges() {
    const n = state.leads.filter(l => l.status === 'new').length;
    const p = state.leads.filter(l => l.status === 'pending').length;
    const unpaidInvoices = state.invoices.filter(i => i.status !== 'paid' && i.status !== 'cancelled').length;
    
    document.getElementById('leadsBadge').textContent = state.leads.length;
    document.getElementById('newBadge').textContent = n;
    document.getElementById('pendingBadge').textContent = p;
    document.getElementById('customersBadge').textContent = state.customers.length;
    document.getElementById('invoicesBadge').textContent = unpaidInvoices;
}

// ========================================
// NAVIGATION
// ========================================
function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const s = this.dataset.section;
            if (s) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                renderSection(s);
            }
        });
    });
}

function renderSection(section) {
    state.currentSection = section;
    state.searchQuery = ''; // Reset search when switching sections
    
    // Set appropriate filter based on section
    if (section === 'leads') {
        state.currentFilter = 'all';
    } else if (section === 'new' || section === 'pending' || section === 'contacted') {
        state.currentFilter = section;
    } else if (section === 'invoices') {
        state.currentFilter = state.currentFilter || 'all'; // Keep existing filter or set to all
    } else {
        state.currentFilter = 'all';
    }

    const titles = {
        dashboard: 'Dashboard',
        analytics: 'Analytics',
        leads: 'All Leads',
        new: 'New Leads',
        pending: 'Pending Leads',
        contacted: 'Contacted Leads',
        customers: 'Customers',
        employees: 'Team Management',
        invoices: 'Invoices',
    tasks: 'Tasks',
    projects: 'Project Timelines',
    settings: 'Settings'
    };
    
    document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
    
    // Update topbar actions based on section
    const topbarActions = document.querySelector('.topbar-actions');
    let actionButtons = `
        <button class="btn btn-secondary" onclick="openExportModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Export
        </button>
    `;
    
    // Add section-specific action button
    if (section === 'leads' || section === 'new' || section === 'pending' || section === 'contacted') {
        actionButtons += `
            <button class="btn btn-primary" onclick="openCreateModal('lead')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Lead
            </button>
        `;
    } else if (section === 'invoices') {
        actionButtons += `
            <button class="btn btn-primary" onclick="showInvoiceLeadSelector()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                Create Invoice
            </button>
        `;
    } else if (section === 'employees') {
        actionButtons += `
            <button class="btn btn-primary" onclick="openCreateModal('employee')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Employee
            </button>
        `;
    } else if (section === 'tasks') {
        actionButtons += `
            <button class="btn btn-primary" onclick="openCreateModal('task')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Task
            </button>
        `;
        } else if (section === 'projects') {
    actionButtons += `
        <button class="btn btn-primary" onclick="openProjectTimelineModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
            Create Project Timeline
        </button>
    `;
    } else if (section === 'dashboard') {
        actionButtons += `
            <button class="btn btn-primary" onclick="openCreateModal('lead')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Lead
            </button>
        `;
    }
    
    topbarActions.innerHTML = actionButtons;
    
    const content = document.getElementById('contentArea');
    
switch (section) {
    case 'dashboard': renderDashboard(content); break;
    case 'analytics': renderAnalytics(content); break;
    case 'leads':
    case 'new':
    case 'pending':
    case 'contacted':
        state.currentFilter = section === 'leads' ? 'all' : section;
        renderLeadsTable(content, 'leads');
        break;
    case 'customers': renderLeadsTable(content, 'customers'); break;
    case 'employees': renderEmployees(content); break;
        case 'invoices': renderInvoices(content); break;
case 'tasks': renderTasks(content); break;
case 'projects': renderProjects(content); break;
case 'settings': renderSettings(content); break;
    }
}

function showInvoiceLeadSelector() {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Select Customer/Lead for Invoice';
    
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    
    bodyEl.innerHTML = `
        <div class="form-group">
            <label class="form-label">Search Customer/Lead</label>
            <input type="text" class="form-input" id="leadSearch" placeholder="Search by name or email..." oninput="filterLeadSelector()">
        </div>
        <div id="leadSelectorList" style="max-height: 400px; overflow-y: auto; margin-top: 16px;">
            ${allLeadsAndCustomers.map(lead => `
                <div class="expense-item" style="cursor: pointer; margin-bottom: 8px;" onclick="selectLeadForInvoice(${lead.id})">
                    <div class="contact-avatar">${getInitials(lead.name)}</div>
                    <div class="expense-content">
                        <div class="expense-description">${lead.name}</div>
                        <div class="expense-meta">
                            <span>${lead.email}</span>
                            ${lead.company ? `<span>${lead.company}</span>` : ''}
                        </div>
                    </div>
                    <span class="status-badge status-${lead.is_customer ? 'contacted' : lead.status}">
                        ${lead.is_customer ? 'Customer' : 'Lead'}
                    </span>
                </div>
            `).join('')}
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
        </div>
    `;
    
    modal.classList.add('active');
}

function filterLeadSelector() {
    const search = document.getElementById('leadSearch').value.toLowerCase();
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    const filtered = search 
        ? allLeadsAndCustomers.filter(l => 
            l.name.toLowerCase().includes(search) || 
            l.email.toLowerCase().includes(search) ||
            (l.company && l.company.toLowerCase().includes(search))
          )
        : allLeadsAndCustomers;
    
    document.getElementById('leadSelectorList').innerHTML = filtered.map(lead => `
        <div class="expense-item" style="cursor: pointer; margin-bottom: 8px;" onclick="selectLeadForInvoice(${lead.id})">
            <div class="contact-avatar">${getInitials(lead.name)}</div>
            <div class="expense-content">
                <div class="expense-description">${lead.name}</div>
                <div class="expense-meta">
                    <span>${lead.email}</span>
                    ${lead.company ? `<span>${lead.company}</span>` : ''}
                </div>
            </div>
            <span class="status-badge status-${lead.is_customer ? 'contacted' : lead.status}">
                ${lead.is_customer ? 'Customer' : 'Lead'}
            </span>
        </div>
    `).join('');
}

function selectLeadForInvoice(leadId) {
    closeCreateModal();
    openCreateModal('invoice', leadId);
}
// ========================================
// RENDER FUNCTIONS
// ========================================
function renderDashboard(content) {
    const totalLeads = state.leads.length;
    const newLeads = state.leads.filter(l => l.status === 'new').length;
    const activeCustomers = state.customers.length;
    const pendingInvoices = state.invoices.filter(i => i.status !== 'paid' && i.status !== 'cancelled' && i.status !== 'void').length;
    const totalRevenue = state.invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
    const pendingRevenue = state.invoices.filter(i => i.status !== 'paid' && i.status !== 'cancelled' && i.status !== 'void').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);

    content.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Total Leads</span>
                    <div class="stat-icon blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${totalLeads}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    ${newLeads} new this week
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Active Customers</span>
                    <div class="stat-icon green">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${activeCustomers}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    Growing
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Pending Invoices</span>
                    <div class="stat-icon amber">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${pendingInvoices}</div>
                <div class="stat-change">$${pendingRevenue.toLocaleString()} awaiting payment</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Total Revenue</span>
                    <div class="stat-icon purple">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">$${totalRevenue.toLocaleString()}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    12% from last month
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 36px;">
            <div class="table-container">
                <div style="padding: 20px 18px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 15px; font-weight: 700;">Recent Leads</h3>
                    <button class="btn btn-sm btn-secondary" onclick="renderSection('leads')">View All</button>
                </div>
                ${renderLeadsTableHTML(state.leads.slice(0, 5))}
            </div>
            
            <div class="table-container">
                <div style="padding: 20px 18px; border-bottom: 1px solid var(--border-subtle);">
                    <h3 style="font-size: 15px; font-weight: 700;">Upcoming Tasks</h3>
                </div>
                <div style="padding: 16px;">
                    ${state.tasks.filter(t => !t.completed).slice(0, 5).map(task => `
                        <div class="task-item" style="margin-bottom: 10px;">
                            <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="task-content">
                                <div class="task-title">${task.title}</div>
                                <div class="task-meta">
                                    <div class="task-due ${new Date(task.dueDate) < new Date() ? 'overdue' : ''}">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        ${formatDate(task.dueDate)}
                                    </div>
                                    <span class="priority-badge priority-${task.priority}">${task.priority}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function renderAnalytics(content) {
    const monthlyLeads = getMonthlyData(state.leads);
    const monthlyCustomers = getMonthlyData(state.customers);
    const monthlyRevenue = getMonthlyRevenue();
    
    // Calculate real stats
    const totalLeads = state.leads.length;
    const totalCustomers = state.customers.length;
    const totalInvoices = state.invoices.length;
    const paidInvoices = state.invoices.filter(i => i.status === 'paid').length;
    const pendingInvoices = state.invoices.filter(i => i.status !== 'paid' && i.status !== 'cancelled' && i.status !== 'void').length;
    const overdueInvoices = state.invoices.filter(i => i.status === 'overdue').length;
    
    // Calculate max value for chart scaling
    const maxLeads = Math.max(...monthlyLeads, 1);
    
    content.innerHTML = `
        <div class="analytics-grid">
            <div class="analytics-card full-width">
                <div class="analytics-header">
                    <h3 class="analytics-title">Monthly Lead Generation</h3>
                </div>
                <div class="chart-container">
                    ${monthlyLeads.map((count, i) => `
                        <div class="chart-bar" style="height: ${(count / maxLeads) * 180}px; min-height: ${count > 0 ? '24px' : '4px'};">
                            <div class="chart-bar-value">${count}</div>
                            <div class="chart-bar-label">${getMonthName(i)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Revenue Overview</h3>
                </div>
                <div class="metrics-list">
                    <div class="metric-item">
                        <span class="metric-label">Total Revenue (Paid)</span>
                        <span class="metric-value" style="color: var(--status-contacted);">$${monthlyRevenue.total.toLocaleString()}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Pending Revenue</span>
                        <span class="metric-value" style="color: var(--status-pending);">$${monthlyRevenue.pending.toLocaleString()}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Overdue Revenue</span>
                        <span class="metric-value" style="color: var(--status-lost);">$${monthlyRevenue.overdue.toLocaleString()}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Total Outstanding</span>
                        <span class="metric-value">$${(monthlyRevenue.pending + monthlyRevenue.overdue).toLocaleString()}</span>
                    </div>
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Conversion Rate</h3>
                </div>
                <div style="text-align: center; padding: 40px 0;">
                    <div style="font-size: 48px; font-weight: 800; color: var(--accent-amber); font-family: var(--font-mono);">
                        ${calculateConversionRate()}%
                    </div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Lead to Customer</div>
                    <div class="progress-bar" style="margin-top: 20px;">
                        <div class="progress-fill" style="width: ${calculateConversionRate()}%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 16px; font-size: 12px; color: var(--text-muted);">
                        <span>${totalLeads} Leads</span>
                        <span>${totalCustomers} Customers</span>
                    </div>
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Invoice Summary</h3>
                </div>
                <div class="metrics-list">
                    <div class="metric-item">
                        <span class="metric-label">Total Invoices</span>
                        <span class="metric-value">${totalInvoices}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Paid</span>
                        <span class="metric-value" style="color: var(--status-contacted);">${paidInvoices}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Pending</span>
                        <span class="metric-value" style="color: var(--status-pending);">${pendingInvoices}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Overdue</span>
                        <span class="metric-value" style="color: var(--status-lost);">${overdueInvoices}</span>
                    </div>
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Lead Status Breakdown</h3>
                </div>
                <div class="metrics-list">
                    <div class="metric-item">
                        <span class="metric-label">
                            <span class="status-badge status-new" style="padding: 3px 8px; font-size: 10px;">
                                <span class="status-dot"></span>New
                            </span>
                        </span>
                        <span class="metric-value">${state.leads.filter(l => l.status === 'new').length}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <span class="status-badge status-pending" style="padding: 3px 8px; font-size: 10px;">
                                <span class="status-dot"></span>Pending
                            </span>
                        </span>
                        <span class="metric-value">${state.leads.filter(l => l.status === 'pending').length}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <span class="status-badge status-contacted" style="padding: 3px 8px; font-size: 10px;">
                                <span class="status-dot"></span>Contacted
                            </span>
                        </span>
                        <span class="metric-value">${state.leads.filter(l => l.status === 'contacted').length}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <span class="status-badge status-closed" style="padding: 3px 8px; font-size: 10px;">
                                <span class="status-dot"></span>Closed
                            </span>
                        </span>
                        <span class="metric-value">${state.leads.filter(l => l.status === 'closed').length}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <span class="status-badge status-lost" style="padding: 3px 8px; font-size: 10px;">
                                <span class="status-dot"></span>Lost
                            </span>
                        </span>
                        <span class="metric-value">${state.leads.filter(l => l.status === 'lost').length}</span>
                    </div>
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Team Overview</h3>
                </div>
                <div class="metrics-list">
                    <div class="metric-item">
                        <span class="metric-label">Total Employees</span>
                        <span class="metric-value">${state.employees.length}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Assigned Leads</span>
                        <span class="metric-value">${state.leads.filter(l => l.assigned_to).length}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Unassigned Leads</span>
                        <span class="metric-value">${state.leads.filter(l => !l.assigned_to).length}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Active Tasks</span>
                        <span class="metric-value">${state.tasks.filter(t => !t.completed).length}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderLeadsTable(content, type) {
    const data = type === 'customers' ? state.customers : state.leads;
    const filtered = filterLeads(data);
    
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search ${type}..." value="${state.searchQuery}" oninput="handleSearch(this.value)">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            
            ${type === 'leads' ? `
            <div class="filter-group">
                <button class="filter-btn ${state.currentFilter === 'all' ? 'active' : ''}" onclick="filterLeads('all')">All</button>
                <button class="filter-btn ${state.currentFilter === 'new' ? 'active' : ''}" onclick="filterLeads('new')">New</button>
                <button class="filter-btn ${state.currentFilter === 'pending' ? 'active' : ''}" onclick="filterLeads('pending')">Pending</button>
                <button class="filter-btn ${state.currentFilter === 'contacted' ? 'active' : ''}" onclick="filterLeads('contacted')">Contacted</button>
                <button class="filter-btn ${state.currentFilter === 'closed' ? 'active' : ''}" onclick="filterLeads('closed')">Closed</button>
            </div>
            ` : ''}
        </div>
        
        <div class="table-container">
            ${filtered.length > 0 ? renderLeadsTableHTML(filtered) : `
                <div class="empty-state">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div class="empty-title">No ${type} found</div>
                    <div class="empty-description">
                        ${state.searchQuery ? 'Try adjusting your search' : `Get started by creating your first ${type === 'leads' ? 'lead' : 'customer'}`}
                    </div>
                </div>
            `}
        </div>
    `;
}

function renderLeadsTableHTML(leads) {
    return `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Contact</th>
                    <th>Company</th>
                    <th>Project Type</th>
                    <th>Budget</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Assigned To</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${leads.map(lead => `
                    <tr onclick="openDetailModal('lead', ${lead.id})">
                        <td>
                            <div class="contact-cell">
                                <div class="contact-avatar">${getInitials(lead.name)}</div>
                                <div class="contact-info">
                                    <div class="contact-name">${lead.name}</div>
                                    <div class="contact-email">${lead.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>${lead.company || '-'}</td>
                        <td>${lead.project_type || '-'}</td>
                        <td>${lead.budget ? `$${parseFloat(lead.budget).toLocaleString()}` : '-'}</td>
                        <td>
                            <span class="status-badge status-${lead.status}">
                                <span class="status-dot"></span>
                                ${lead.status}
                            </span>
                        </td>
                        <td>
                            <span class="priority-badge priority-${lead.priority || 'low'}">
                                ${lead.priority || 'low'}
                            </span>
                        </td>
                        <td>
    ${lead.assigned_to ? `
        <div style="display: flex; align-items: center; gap: 8px;">
            <div class="contact-avatar" style="width: 28px; height: 28px; font-size: 10px;">${getInitials(lead.employee_name || 'Unknown')}</div>
            <span style="font-size: 12px;">${lead.employee_name || 'Unknown'}</span>
        </div>
    ` : '<span style="color: var(--text-muted);">Unassigned</span>'}
</td>
                        <td onclick="event.stopPropagation()">
                            <div class="table-actions">
                                <button class="table-action-btn" onclick="openDetailModal('lead', ${lead.id})" title="View Details">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                                <button class="table-action-btn" onclick="openCreateModal('invoice', ${lead.id})" title="Create Invoice">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                    </svg>
                                </button>
                                <button class="table-action-btn danger" onclick="deleteLead(${lead.id})" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="table-footer">
            <div class="table-info">Showing ${leads.length} ${leads.length === 1 ? 'result' : 'results'}</div>
        </div>
    `;
}

function renderEmployees(content) {
    console.log('renderEmployees called, employees:', state.employees);
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search team members..." oninput="handleSearch(this.value)">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal('employee')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Employee
            </button>
        </div>
        
        <div class="cards-grid">
            ${state.employees.map(emp => `
                <div class="card employee-card">
                    <div class="card-header">
                        <div class="employee-avatar-lg">${getInitials(emp.name)}</div>
                        <div class="employee-details">
                            <div class="employee-name">${emp.name}</div>
                            <div class="employee-role">${emp.role}</div>
                        </div>
                    </div>
                    <div class="employee-meta">
                        <div class="employee-meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            ${emp.email}
                        </div>
                        <div class="employee-meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
                            </svg>
                            ${emp.phone || 'N/A'}
                        </div>
                        <div class="employee-meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            Joined ${formatDate(emp.created_at)}
                        </div>
                    </div>
                    <div class="employee-stats">
                        <div class="employee-stat">
                            <div class="employee-stat-value">${emp.projects_assigned || 0}</div>
                            <div class="employee-stat-label">Projects</div>
                        </div>
                        <div class="employee-stat">
                            <div class="employee-stat-value">${emp.tasks_completed || 0}</div>
                            <div class="employee-stat-label">Tasks</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="openDetailModal('employee', ${emp.id})">View</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${emp.id})">Delete</button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderInvoices(content) {
    // Filter by status first
    let filtered = state.invoices;
    if (state.currentFilter && state.currentFilter !== 'all') {
        filtered = filtered.filter(inv => inv.status === state.currentFilter);
    }
    
    // Then apply search
    if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        filtered = filtered.filter(inv => 
            inv.invoice_number.toLowerCase().includes(query) ||
            (inv.customer_name && inv.customer_name.toLowerCase().includes(query)) ||
            (inv.customer_email && inv.customer_email.toLowerCase().includes(query)) ||
            (inv.customer_company && inv.customer_company.toLowerCase().includes(query))
        );
    }
    
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" id="invoiceSearch" placeholder="Search invoices by number or customer..." value="${state.searchQuery}" onkeyup="handleInvoiceSearch(event)">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <div class="filter-group">
                <button class="filter-btn ${state.currentFilter === 'all' ? 'active' : ''}" onclick="filterInvoices('all')">All</button>
                <button class="filter-btn ${state.currentFilter === 'draft' ? 'active' : ''}" onclick="filterInvoices('draft')">Draft</button>
                <button class="filter-btn ${state.currentFilter === 'sent' ? 'active' : ''}" onclick="filterInvoices('sent')">Sent</button>
                <button class="filter-btn ${state.currentFilter === 'paid' ? 'active' : ''}" onclick="filterInvoices('paid')">Paid</button>
                <button class="filter-btn ${state.currentFilter === 'overdue' ? 'active' : ''}" onclick="filterInvoices('overdue')">Overdue</button>
            </div>
        </div>
        
        <div class="cards-grid">
            ${filtered.length > 0 ? filtered.map(inv => `
                <div class="card invoice-card">
                    <div class="invoice-card-header" onclick="openDetailModal('invoice', ${inv.id})">
                        <div>
                            <div class="invoice-card-number">${inv.invoice_number}</div>
                            <div class="invoice-card-customer">${inv.customer_name || 'Unknown'}</div>
                        </div>
                        <span class="status-badge status-${inv.status}">
                            <span class="status-dot"></span>
                            ${inv.status}
                        </span>
                    </div>
                    <div onclick="openDetailModal('invoice', ${inv.id})">
                        <div class="invoice-card-amount">$${parseFloat(inv.total_amount).toLocaleString()}</div>
                        <div class="invoice-card-meta">
                            <div class="invoice-card-meta-item">
                                <div class="invoice-card-meta-label">Issued</div>
                                <div class="invoice-card-meta-value">${formatDate(inv.issue_date)}</div>
                            </div>
                            <div class="invoice-card-meta-item">
                                <div class="invoice-card-meta-label">Due</div>
                                <div class="invoice-card-meta-value">${formatDate(inv.due_date)}</div>
                            </div>
                        </div>
                    </div>
                    ${inv.status !== 'paid' ? `
                        <div style="display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <button class="btn btn-sm btn-success" style="flex: 1;" onclick="event.stopPropagation(); openPaymentModal(${inv.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                Mark Paid
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteInvoice(${inv.id})" title="Delete Invoice">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    ` : `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle); text-align: center;">
                            <span style="color: var(--status-contacted); font-size: 13px; font-weight: 600;">
                                <svg style="width: 14px; height: 14px; display: inline; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                Paid ${inv.paid_at ? formatDate(inv.paid_at) : ''}
                            </span>
                        </div>
                    `}
                </div>
            `).join('') : `
                <div style="grid-column: 1 / -1;">
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div class="empty-title">No invoices found</div>
                        <div class="empty-description">
                            ${state.searchQuery ? 'Try adjusting your search' : 'Create your first invoice to get started'}
                        </div>
                    </div>
                </div>
            `}
        </div>
    `;
}

function renderTasks(content) {
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search tasks...">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal('task')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Task
            </button>
        </div>
        
        <div class="tasks-container">
            ${state.tasks.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <div class="task-due ${new Date(task.dueDate) < new Date() && !task.completed ? 'overdue' : ''}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                ${formatDate(task.dueDate)}
                            </div>
                            <span>${task.assignee}</span>
                            <span class="priority-badge priority-${task.priority}">${task.priority}</span>
                        </div>
                    </div>
                    <div class="table-actions">
                        <button class="table-action-btn danger" onclick="deleteTask(${task.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderSettings(content) {
    content.innerHTML = `
        <div class="settings-layout">
            <div class="settings-nav">
                <div class="settings-nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/>
                        <path d="M12 14c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z"/>
                    </svg>
                    Profile
                </div>
                <div class="settings-nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    Notifications
                </div>
                <div class="settings-nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    Security
                </div>
            </div>
            
            <div class="settings-panel">
                <div class="settings-section">
                    <h3 class="settings-section-title">Notification Preferences</h3>
                    <p class="settings-section-desc">Manage how you receive notifications</p>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label">Email Notifications</div>
                            <div class="setting-desc">Receive notifications via email</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${state.settings.emailNotifications ? 'checked' : ''} onchange="toggleSetting('emailNotifications')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label">Push Notifications</div>
                            <div class="setting-desc">Receive push notifications in browser</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${state.settings.pushNotifications ? 'checked' : ''} onchange="toggleSetting('pushNotifications')">
<span class="toggle-slider"></span>
</label>
</div>
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Weekly Reports</div>
                        <div class="setting-desc">Get weekly summary via email</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.weeklyReport ? 'checked' : ''} onchange="toggleSetting('weeklyReport')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Appearance</h3>
                <p class="settings-section-desc">Customize the look and feel</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Dark Mode</div>
                        <div class="setting-desc">Use dark theme across the app</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.darkMode ? 'checked' : ''} onchange="toggleSetting('darkMode')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Automation</h3>
                <p class="settings-section-desc">Configure automated workflows</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Auto-assign Leads</div>
                        <div class="setting-desc">Automatically assign new leads to team members</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.autoAssign ? 'checked' : ''} onchange="toggleSetting('autoAssign')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
`;
}
// ========================================
// MODAL FUNCTIONS
// ========================================
async function openDetailModal(type, id) {
const modal = document.getElementById('detailModal');
const titleEl = document.getElementById('detailModalTitle');
const bodyEl = document.getElementById('detailModalBody');
const footerEl = document.getElementById('detailModalFooter');
if (type === 'lead') {
    const lead = [...state.leads, ...state.customers].find(l => l.id === id);
    if (!lead) return;
    
state.currentLead = lead;
const expenses = await loadExpenses(id);
const notes = lead.notes ? JSON.parse(lead.notes) : [];
const leadInvoices = state.invoices.filter(inv => inv.lead_id === id);
    
    titleEl.textContent = `${lead.is_customer ? 'Customer' : 'Lead'} Details`;
    
    bodyEl.innerHTML = `
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Contact Information</h3>
            </div>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">${lead.name}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${lead.email}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone</div>
                    <div class="detail-value">${lead.phone || 'N/A'}</div>
                </div>
<div class="detail-item">
    <div class="detail-label">Company</div>
    <div class="detail-value">${lead.company || 'N/A'}</div>
</div>
<div class="detail-item full-width">
    <div class="detail-label">Billing Address</div>
    <div class="detail-value">
        ${lead.address_line1 || lead.address_line2 || lead.city ? `
            ${lead.address_line1 ? lead.address_line1 + '<br>' : ''}
            ${lead.address_line2 ? lead.address_line2 + '<br>' : ''}
            ${lead.city ? lead.city + ', ' : ''}${lead.state || ''} ${lead.zip_code || ''}
            ${lead.country && lead.country !== 'USA' ? '<br>' + lead.country : ''}
        ` : '<span style="color: var(--text-muted);">No address on file</span>'}
        <button class="btn btn-sm btn-secondary" style="margin-top: 8px;" onclick="editAddress(${lead.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit Address
        </button>
    </div>
</div>
                <div class="detail-item full-width">
                    <div class="detail-label">Message</div>
                    <div class="detail-value">${lead.message || 'N/A'}</div>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Project Details</h3>
            </div>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Project Type</div>
                    <div class="detail-value">${lead.project_type || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Budget</div>
                    <div class="detail-value">${lead.budget ? `$${parseFloat(lead.budget).toLocaleString()}` : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Timeline</div>
                    <div class="detail-value">${lead.timeline || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge status-${lead.status}">
                            <span class="status-dot"></span>
                            ${lead.status}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Priority</div>
                    <div class="detail-value">
                        <span class="priority-badge priority-${lead.priority || 'low'}">${lead.priority || 'low'}</span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Created</div>
                    <div class="detail-value">${formatDate(lead.created_at)}</div>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Expenses</h3>
            </div>
            <div class="expense-list">
                ${expenses.length > 0 ? expenses.map(exp => `
                    <div class="expense-item ${state.selectedExpenses.includes(exp.id) ? 'selected' : ''}" data-expense-id="${exp.id}">
                        <div class="expense-checkbox ${state.selectedExpenses.includes(exp.id) ? 'checked' : ''}" onclick="toggleExpense(${exp.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <div class="expense-content">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-meta">
                                <div class="expense-meta-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    ${formatDate(exp.expense_date)}
                                </div>
                                ${exp.category ? `<span>${exp.category}</span>` : ''}
                            </div>
                        </div>
                        <div class="expense-amount">$${parseFloat(exp.amount).toLocaleString()}</div>
                        <div class="expense-actions">
                            <button class="table-action-btn danger" onclick="event.stopPropagation(); deleteExpense(${exp.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('') : '<div class="expense-empty">No expenses recorded yet</div>'}
            </div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="openCreateModal('expense', ${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Expense
            </button>
        </div>
        
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Invoices</h3>
            </div>
            <div class="expense-list">
                ${leadInvoices.length > 0 ? leadInvoices.map(inv => `
                    <div class="expense-item" style="cursor: pointer;" onclick="closeDetailModal(); setTimeout(() => openDetailModal('invoice', ${inv.id}), 100);">
                        <div class="expense-content">
                            <div class="expense-description" style="font-family: var(--font-mono); font-weight: 600;">${inv.invoice_number}</div>
                            <div class="expense-meta">
                                <div class="expense-meta-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    ${formatDate(inv.issue_date)}
                                </div>
                                <span>Due: ${formatDate(inv.due_date)}</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="status-badge status-${inv.status}">
                                <span class="status-dot"></span>
                                ${inv.status}
                            </span>
                            <div class="expense-amount">$${parseFloat(inv.total_amount).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('') : '<div class="expense-empty">No invoices yet</div>'}
            </div>
            ${leadInvoices.length > 0 ? `
                <div style="display: flex; gap: 16px; margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-subtle);">
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Total Invoiced</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--text-primary); font-family: var(--font-mono);">$${leadInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0).toLocaleString()}</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Paid</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--status-contacted); font-family: var(--font-mono);">$${leadInvoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0).toLocaleString()}</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Outstanding</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--status-pending); font-family: var(--font-mono);">$${leadInvoices.filter(inv => inv.status !== 'paid' && inv.status !== 'cancelled').reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0).toLocaleString()}</div>
                    </div>
                </div>
            ` : ''}
        </div>
        
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Notes</h3>
            </div>
            <div class="notes-list">
                ${notes.length > 0 ? notes.map(note => `
                    <div class="note-item">
                        <div class="note-header">
                            <span class="note-author">${note.author || 'Admin'}</span>
                            <span class="note-date">${formatDate(note.date)}</span>
                        </div>
                        <div class="note-text">${note.text}</div>
                    </div>
                `).join('') : '<div class="note-empty">No notes yet</div>'}
            </div>
            <div class="form-group full-width">
                <textarea class="form-textarea" id="newNote" placeholder="Add a new note..."></textarea>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addNote(${id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Note
                </button>
            </div>
        </div>
    `;
    
    footerEl.innerHTML = `
    <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>

    <button class="btn btn-secondary" onclick="changeLeadStatus(${id})">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12 6 12 12 16 14"/>
    </svg>
    Change Status
</button>
    
    ${!lead.is_customer ? `
        <button class="btn btn-success" onclick="convertToCustomer(${id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <polyline points="17 11 19 13 23 9"/>
            </svg>
            Convert to Customer
        </button>
    ` : ''}
    
    <button class="btn btn-secondary" onclick="assignEmployee(${id})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
        </svg>
        Assign Employee
    </button>
    
    <button class="btn btn-secondary" onclick="changePriority(${id})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        Change Priority
    </button>
        ${state.selectedExpenses.length > 0 ? `
            <button class="btn btn-success" onclick="createInvoiceFromExpenses()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                Create Invoice (${state.selectedExpenses.length} selected)
            </button>
        ` : `
            <button class="btn btn-primary" onclick="openCreateModal('invoice', ${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                Create Invoice
            </button>
        `}
        <button class="btn btn-danger" onclick="deleteLead(${id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Delete
        </button>
    `;
} else if (type === 'invoice') {
    const invoice = state.invoices.find(i => i.id === id);
    if (!invoice) return;
    
    state.currentInvoice = invoice;
    
    titleEl.textContent = 'Invoice Details';
    bodyEl.innerHTML = await renderInvoicePreview(invoice); // ADD await here!
    
    // REPLACE THE ENTIRE footerEl.innerHTML with this:
    let footerButtons = `
        <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
    `;
    
    // Add Mark as Paid button if not already paid
    if (invoice.status !== 'paid' && invoice.status !== 'void' && invoice.status !== 'cancelled') {
        footerButtons += `
            <button class="btn btn-success" onclick="openPaymentModal(${invoice.id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Mark as Paid
            </button>
        `;
    }
    
    // Add print button
    footerButtons += `
        <button class="btn btn-primary" onclick="printInvoice()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"/>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <rect x="6" y="14" width="12" height="8"/>
            </svg>
            Print Invoice
        </button>
    `;
    
    // Add delete button (only for non-paid invoices)
    if (invoice.status !== 'paid') {
        footerButtons += `
            <button class="btn btn-danger" onclick="deleteInvoice(${invoice.id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete Invoice
            </button>
        `;
    }
    
    footerEl.innerHTML = footerButtons;
}

modal.classList.add('active');
}
async function renderInvoicePreview(invoice) {
    const items = invoice.items || [];
    const taxAmount = parseFloat(invoice.tax_amount || 0);
    const discount = parseFloat(invoice.discount_amount || 0);
    
    // Generate or use existing Stripe payment link
    let paymentUrl = null;

    // If invoice already has a Stripe payment link, use it
    if (invoice.stripe_payment_link) {
        paymentUrl = invoice.stripe_payment_link;
        console.log(' Using existing payment link:', paymentUrl);
    } else if (invoice.id && invoice.status !== 'paid') {
        // Create new payment link
        try {
            console.log(' Creating payment link for invoice:', invoice.id);
            const response = await fetch(`${API_URL}/api/invoices/${invoice.id}/payment-link`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.paymentLink) {
                    paymentUrl = data.paymentLink;
                    invoice.stripe_payment_link = data.paymentLink;
                    console.log(' Stripe payment link created:', paymentUrl);
                } else {
                    console.warn(' Payment link creation returned success but no link');
                }
            } else {
                const errorText = await response.text();
                console.error(' Failed to create payment link:', response.status, errorText);
            }
        } catch (error) {
            console.error(' Error generating payment link:', error);
        }
    }

    // If no payment link available, use fallback
    if (!paymentUrl) {
        paymentUrl = `${FRONTEND_BASE_URL}/invoice/${invoice.invoice_number}`;
        console.log(' Using fallback URL:', paymentUrl);
    }
    
    // Generate unique QR code ID
    const qrCodeId = `qr-code-${invoice.id || Date.now()}`;
    
    const html = `
        <div class="invoice-preview">
            <div class="invoice-preview-header">
                <div class="invoice-company">
                    <div class="invoice-company-logo">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <div>
                        <div class="invoice-company-name">Diamondback Coding</div>
                        <div class="invoice-company-tagline">Premium Development Services</div>
                    </div>
                </div>
                <div class="invoice-info">
                    <div class="invoice-title">INVOICE</div>
                    <div class="invoice-number">#${invoice.invoice_number}</div>
                </div>
            </div>
            
            <div class="invoice-preview-body">
                <div class="invoice-parties">
                    <div>
                        <div class="invoice-party-label">From</div>
                        <div class="invoice-party-name">Diamondback Coding</div>
                        <div class="invoice-party-details">
                            15709 Spillman Ranch Loop<br>
                            Austin, TX 78738<br>
                            diamondbackcoding@gmail.com
                        </div>
                    </div>
                    <div>
                        <div class="invoice-party-label">Bill To</div>
                        <div class="invoice-party-name">${invoice.customer_name || 'Customer'}</div>
<div class="invoice-party-details">
    ${timeline.clientCompany ? timeline.clientCompany + '<br>' : ''}
    ${timeline.clientEmail || ''}${timeline.clientPhone || timeline.clientAddress ? '<br>' : ''}
    ${timeline.clientPhone || ''}${timeline.clientAddress ? '<br>' : ''}
    ${timeline.clientAddress ? timeline.clientAddress.replace(/\n/g, '<br>') : ''}
</div>
                    </div>
                </div>
                
                <div class="invoice-dates">
                    <div class="invoice-date-item">
                        <div class="invoice-date-label">Issue Date</div>
                        <div class="invoice-date-value">${formatDate(invoice.issue_date)}</div>
                    </div>
                    <div class="invoice-date-item">
                        <div class="invoice-date-label">Due Date</div>
                        <div class="invoice-date-value">${formatDate(invoice.due_date)}</div>
                    </div>
                </div>
                
                <table class="invoice-items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity || 1}</td>
                                <td>$${parseFloat(item.unit_price || item.amount).toLocaleString()}</td>
                                <td>$${parseFloat(item.amount).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="invoice-totals">
                    <div class="invoice-total-row">
                        <span class="invoice-total-label">Subtotal</span>
                        <span class="invoice-total-value">$${parseFloat(invoice.subtotal).toLocaleString()}</span>
                    </div>
                    ${taxAmount > 0 ? `
                        <div class="invoice-total-row">
                            <span class="invoice-total-label">Tax (${invoice.tax_rate}%)</span>
                            <span class="invoice-total-value">$${taxAmount.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    ${discount > 0 ? `
                        <div class="invoice-total-row">
                            <span class="invoice-total-label">Discount</span>
                            <span class="invoice-total-value">-$${discount.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    <div class="invoice-total-row grand">
                        <span class="invoice-total-label">Total</span>
                        <span class="invoice-total-value">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                    </div>
                </div>
                
                ${invoice.status !== 'paid' ? `
                    <div class="qr-code-section">
                        <div class="qr-code-title">
                            <svg style="width: 20px; height: 20px; display: inline; margin-right: 6px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            Scan to Pay
                        </div>
                        <div class="qr-code-container" id="${qrCodeId}"></div>
                        <div class="qr-code-instructions">
                            Scan this QR code with your phone's camera to quickly access the secure payment portal. You can pay via credit card, bank transfer, or other accepted payment methods.
                        </div>
                        <div class="payment-url">
                            ${paymentUrl}
                        </div>
                    </div>
                ` : ''}
            </div>
            
            ${invoice.notes ? `
                <div class="invoice-preview-footer">
                    <div class="invoice-notes-title">Notes</div>
                    <div class="invoice-notes-text">${invoice.notes}</div>
                </div>
            ` : ''}
        </div>
    `;
    
    // Generate QR code after a small delay to ensure DOM is ready
    setTimeout(() => {
        const qrElement = document.getElementById(qrCodeId);
        if (qrElement && invoice.status !== 'paid') {
            // Clear any existing QR code
            qrElement.innerHTML = '';
            
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                console.error(' QRCode library not loaded');
                qrElement.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">QR code library not available</p>';
                return;
            }
            
            try {
                // Generate QR code
                new QRCode(qrElement, {
                    text: paymentUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#1a1a1a",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                console.log(' QR code generated for:', paymentUrl);
            } catch (error) {
                console.error(' QR code generation failed:', error);
                qrElement.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">QR code generation failed</p>';
            }
        }
    }, 100);
    
    return html;
}
function closeDetailModal() {
document.getElementById('detailModal').classList.remove('active');
state.currentLead = null;
state.selectedExpenses = [];
}
function openCreateModal(type, leadId = null) {
const modal = document.getElementById('createModal');
const titleEl = document.getElementById('createModalTitle');
const bodyEl = document.getElementById('createModalBody');
if (type === 'lead') {
    titleEl.textContent = 'Create New Lead';
    bodyEl.innerHTML = `
        <form id="createLeadForm" onsubmit="handleCreateLead(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Name <span class="required">*</span></label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email <span class="required">*</span></label>
                    <input type="email" class="form-input" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" name="phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" name="company">
                </div>
                <div class="form-group">
                    <label class="form-label">Project Type</label>
                    <select class="form-select" name="project_type">
                        <option value="">Select type...</option>
                        <option value="Web Development">Web Development</option>
                        <option value="Mobile App">Mobile App</option>
                        <option value="E-commerce">E-commerce</option>
                        <option value="Custom Software">Custom Software</option>
                        <option value="Consulting">Consulting</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Budget</label>
                    <input type="number" class="form-input" name="budget" step="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="new">New</option>
                        <option value="pending">Pending</option>
                        <option value="contacted">Contacted</option>
                        <option value="closed">Closed</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" name="priority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" name="message"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Lead</button>
            </div>
        </form>
    `;
} else if (type === 'expense') {
    titleEl.textContent = 'Add Expense';
    bodyEl.innerHTML = `
        <form id="createExpenseForm" onsubmit="handleCreateExpense(event, ${leadId})">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Description <span class="required">*</span></label>
                    <input type="text" class="form-input" name="description" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount <span class="required">*</span></label>
                    <input type="number" class="form-input" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-input" name="quantity" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" name="expense_date" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" name="category">
                        <option value="">Select category...</option>
                        <option value="Development">Development</option>
                        <option value="Design">Design</option>
                        <option value="Hosting">Hosting</option>
                        <option value="Consulting">Consulting</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" name="notes" rows="3"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </div>
        </form>
    `;
} else if (type === 'invoice') {
    openInvoiceModal(leadId);
    return;
} else if (type === 'employee') {
    titleEl.textContent = 'Add Team Member';
    bodyEl.innerHTML = `
        <form id="createEmployeeForm" onsubmit="handleCreateEmployee(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Name <span class="required">*</span></label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email <span class="required">*</span></label>
                    <input type="email" class="form-input" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" name="phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <input type="text" class="form-input" name="role" placeholder="e.g., Developer, Designer">
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Employee</button>
            </div>
        </form>
    `;
} else if (type === 'task') {
    titleEl.textContent = 'Create Task';
    bodyEl.innerHTML = `
        <form id="createTaskForm" onsubmit="handleCreateTask(event)">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Task Title <span class="required">*</span></label>
                    <input type="text" class="form-input" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" name="dueDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" name="priority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Assignee</label>
                    <input type="text" class="form-input" name="assignee" value="Admin">
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Task</button>
            </div>
        </form>
    `;
}

modal.classList.add('active');
}
function closeCreateModal() {
document.getElementById('createModal').classList.remove('active');
}
async function openInvoiceModal(leadId) {
    const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    if (!lead) return;
    
    const expenses = await loadExpenses(leadId);
    const selectedExpenses = state.selectedExpenses.length > 0 
        ? expenses.filter(e => state.selectedExpenses.includes(e.id))
        : expenses;

    const modal = document.getElementById('invoiceModal');
    const titleEl = document.getElementById('invoiceModalTitle');
    const bodyEl = document.getElementById('invoiceModalBody');
    const footerEl = document.getElementById('invoiceModalFooter');

    titleEl.textContent = 'Create Invoice';

    const invoiceNumber = `INV-${Date.now().toString().slice(-6)}`;
    const today = new Date().toISOString().split('T')[0];
    const dueDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    bodyEl.innerHTML = `
        <div class="tabs">
            <button class="tab active" onclick="switchInvoiceTab('details')">Details</button>
            <button class="tab" onclick="switchInvoiceTab('items')">Items</button>
            <button class="tab" onclick="switchInvoiceTab('preview')">Preview</button>
        </div>
        
        <div id="invoiceDetailsTab">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Invoice Number</label>
                    <input type="text" class="form-input" id="invoiceNumber" value="${invoiceNumber}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="invoiceStatus">
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Invoice Description (for payment page) <span class="required">*</span></label>
                    <input type="text" class="form-input" id="invoiceShortDescription" 
                           placeholder="e.g., Website Development Services" 
                           maxlength="100" required>
                    <small style="font-size: 11px; color: var(--text-muted); margin-top: 4px; display: block;">
                        This appears on the Stripe payment page
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Issue Date</label>
                    <input type="date" class="form-input" id="invoiceIssueDate" value="${today}">
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="invoiceDueDate" value="${dueDate}">
                </div>
                <div class="form-group">
                    <label class="form-label">Tax Rate (%)</label>
                    <input type="number" class="form-input" id="invoiceTaxRate" value="0" step="0.01" oninput="recalculateInvoice()">
                </div>
                <div class="form-group">
                    <label class="form-label">Discount</label>
                    <input type="number" class="form-input" id="invoiceDiscount" value="0" step="0.01" oninput="recalculateInvoice()">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="invoiceNotes" placeholder="Payment terms, thank you message, etc."></textarea>
                </div>
            </div>
        </div>
        
        <div id="invoiceItemsTab" style="display: none;">
            <div id="invoiceItemsList">
                ${selectedExpenses.map((exp, idx) => `
                    <div class="expense-item selected" data-item-index="${idx}">
                        <div class="expense-content">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-meta">
                                <div class="expense-meta-item">Qty: ${exp.quantity || 1}</div>
                                <div class="expense-meta-item">${exp.category || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="expense-amount">$${parseFloat(exp.amount).toLocaleString()}</div>
                        <div class="expense-actions">
                            <button class="table-action-btn danger" onclick="removeInvoiceItem(${idx})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="addCustomInvoiceItem()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Custom Item
            </button>
        </div>
        
        <div id="invoicePreviewTab" style="display: none;"></div>
    `;

    // Store invoice data in state
    state.currentInvoice = {
        leadId,
        lead,
        items: selectedExpenses.map(exp => ({
            description: exp.description,
            quantity: exp.quantity || 1,
            unit_price: parseFloat(exp.amount),
            amount: parseFloat(exp.amount) * (exp.quantity || 1),
            expense_id: exp.id
        }))
    };

    footerEl.innerHTML = `
        <button class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveInvoice()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
                <polyline points="7 3 7 8 15 8"/>
            </svg>
            Save Invoice
        </button>
    `;

    modal.classList.add('active');
}
function closeInvoiceModal() {
document.getElementById('invoiceModal').classList.remove('active');
state.currentInvoice = null;
}
// ========================================
// FORM HANDLERS
// ========================================
async function handleCreateLead(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    try {
        const r = await fetch(`${API_URL}/api/leads`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) {
            const errorData = await r.json();
            throw new Error(errorData.message || 'Failed to create lead');
        }
        
        // Force complete data reload
        await loadAllData();
        closeCreateModal();
        showToast('Lead created successfully', 'success');
        renderSection(state.currentSection);
    } catch (e) {
        console.error('Create lead error:', e);
        showToast(e.message || 'Error creating lead', 'error');
    }
}
async function handleCreateExpense(event, leadId) {
event.preventDefault();
const form = event.target;
const formData = new FormData(form);
const data = Object.fromEntries(formData.entries());
try {
    const r = await fetch(`${API_URL}/api/leads/${leadId}/expenses`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(data)
    });
    
    if (!r.ok) throw new Error('Failed to create expense');
    
    closeCreateModal();
    showToast('Expense added successfully', 'success');
    openDetailModal('lead', leadId);
} catch (e) {
    showToast('Error adding expense', 'error');
}
}
async function handleCreateEmployee(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    console.log('Creating employee with data:', data);
    
    if (!data.name || !data.email) {
        showToast('Name and email are required', 'error');
        return;
    }
    
    try {
        const r = await fetch(`${API_URL}/api/employees`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                name: data.name.trim(),
                email: data.email.trim(),
                phone: data.phone || null,
                role: data.role || 'Team Member'
            })
        });
        
        const result = await r.json();
        console.log('Server response:', result);
        
        if (!r.ok || !result.success) {
            throw new Error(result.message || 'Failed to create employee');
        }
        
        await loadEmployees();
        closeCreateModal();
        showToast('Employee added successfully', 'success');
        renderSection('employees');
    } catch (e) {
        console.error('Create employee error:', e);
        showToast(e.message || 'Error adding employee', 'error');
    }
}
function handleCreateTask(event) {
event.preventDefault();
const form = event.target;
const formData = new FormData(form);
const data = Object.fromEntries(formData.entries());
const newTask = {
    id: state.tasks.length + 1,
    title: data.title,
    dueDate: data.dueDate,
    assignee: data.assignee,
    priority: data.priority,
    completed: false
};

state.tasks.push(newTask);
closeCreateModal();
showToast('Task created successfully', 'success');
renderSection('tasks');
}
// ========================================
// INVOICE FUNCTIONS
// ========================================
function switchInvoiceTab(tab) {
document.querySelectorAll('#invoiceModal .tab').forEach(t => t.classList.remove('active'));
document.querySelector(`#invoiceModal .tab:nth-child(${tab === 'details' ? 1 : tab === 'items' ? 2 : 3})`).classList.add('active');
document.getElementById('invoiceDetailsTab').style.display = tab === 'details' ? 'block' : 'none';
document.getElementById('invoiceItemsTab').style.display = tab === 'items' ? 'block' : 'none';
document.getElementById('invoicePreviewTab').style.display = tab === 'preview' ? 'block' : 'none';

if (tab === 'preview') {
    updateInvoicePreview();
}
}
function recalculateInvoice() {
if (state.currentInvoice) {
const subtotal = state.currentInvoice.items.reduce((sum, item) => sum + parseFloat(item.amount), 0);
const taxRate = parseFloat(document.getElementById('invoiceTaxRate').value) || 0;
const discount = parseFloat(document.getElementById('invoiceDiscount').value) || 0;
    state.currentInvoice.subtotal = subtotal;
    state.currentInvoice.tax_amount = subtotal * (taxRate / 100);
    state.currentInvoice.discount_amount = discount;
    state.currentInvoice.total_amount = subtotal + state.currentInvoice.tax_amount - discount;
}
}
function addCustomInvoiceItem() {
const description = prompt('Item description:');
if (!description) return;
const quantity = parseInt(prompt('Quantity:', '1')) || 1;
const unitPrice = parseFloat(prompt('Unit price:', '0')) || 0;

const item = {
    description,
    quantity,
    unit_price: unitPrice,
    amount: quantity * unitPrice
};

state.currentInvoice.items.push(item);
recalculateInvoice();

const list = document.getElementById('invoiceItemsList');
const idx = state.currentInvoice.items.length - 1;
list.innerHTML += `
    <div class="expense-item selected" data-item-index="${idx}">
        <div class="expense-content">
            <div class="expense-description">${item.description}</div>
            <div class="expense-meta">
                <div class="expense-meta-item">Qty: ${item.quantity}</div>
                <div class="expense-meta-item">@ $${item.unit_price.toLocaleString()}</div>
            </div>
        </div>
        <div class="expense-amount">$${item.amount.toLocaleString()}</div>
        <div class="expense-actions">
            <button class="table-action-btn danger" onclick="removeInvoiceItem(${idx})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
    </div>
`;
}
function removeInvoiceItem(idx) {
state.currentInvoice.items.splice(idx, 1);
recalculateInvoice();
document.querySelector(`[data-item-index="${idx}"]`).remove();
}
function updateInvoicePreview() {
recalculateInvoice();
const invoice = {
    invoice_number: document.getElementById('invoiceNumber').value,
    issue_date: document.getElementById('invoiceIssueDate').value,
    due_date: document.getElementById('invoiceDueDate').value,
    customer_name: state.currentInvoice.lead.name,
    customer_email: state.currentInvoice.lead.email,
    customer_company: state.currentInvoice.lead.company,
    subtotal: state.currentInvoice.subtotal,
    tax_rate: parseFloat(document.getElementById('invoiceTaxRate').value) || 0,
    tax_amount: state.currentInvoice.tax_amount,
    discount_amount: state.currentInvoice.discount_amount,
    total_amount: state.currentInvoice.total_amount,
    notes: document.getElementById('invoiceNotes').value,
    items: state.currentInvoice.items
};

document.getElementById('invoicePreviewTab').innerHTML = renderInvoicePreview(invoice);
}
async function saveInvoice() {
    if (!state.currentInvoice || state.currentInvoice.items.length === 0) {
        showToast('Please add at least one item to the invoice', 'error');
        return;
    }
    
    const shortDescription = document.getElementById('invoiceShortDescription').value.trim();
    if (!shortDescription) {
        showToast('Please enter an invoice description', 'error');
        return;
    }
    
    recalculateInvoice();

    const invoiceData = {
        invoice_number: document.getElementById('invoiceNumber').value,
        lead_id: state.currentInvoice.leadId,
        issue_date: document.getElementById('invoiceIssueDate').value,
        due_date: document.getElementById('invoiceDueDate').value,
        subtotal: state.currentInvoice.subtotal,
        tax_rate: parseFloat(document.getElementById('invoiceTaxRate').value) || 0,
        tax_amount: state.currentInvoice.tax_amount,
        discount_amount: state.currentInvoice.discount_amount,
        total_amount: state.currentInvoice.total_amount,
        status: document.getElementById('invoiceStatus').value,
        short_description: shortDescription, // ADD THIS LINE
        notes: document.getElementById('invoiceNotes').value,
        items: state.currentInvoice.items
    };

    try {
        const r = await fetch(`${API_URL}/api/invoices`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(invoiceData)
        });
        
        if (!r.ok) throw new Error('Failed to create invoice');
        
        await loadInvoices();
        updateBadges();
        closeInvoiceModal();
        closeDetailModal();
        showToast('Invoice created successfully', 'success');
        renderSection('invoices');
    } catch (e) {
        showToast('Error creating invoice', 'error');
    }
}
async function createInvoiceFromExpenses() {
if (state.selectedExpenses.length === 0) {
showToast('Please select expenses first', 'error');
return;
}
closeDetailModal();
await openInvoiceModal(state.currentLead.id);
}
// ========================================
// UTILITY FUNCTIONS
// ========================================
function toggleExpense(expenseId) {
const idx = state.selectedExpenses.indexOf(expenseId);
if (idx > -1) {
state.selectedExpenses.splice(idx, 1);
} else {
state.selectedExpenses.push(expenseId);
}
const checkbox = document.querySelector(`[data-expense-id="${expenseId}"] .expense-checkbox`);
const item = document.querySelector(`[data-expense-id="${expenseId}"]`);

if (state.selectedExpenses.includes(expenseId)) {
    checkbox.classList.add('checked');
    item.classList.add('selected');
} else {
    checkbox.classList.remove('checked');
    item.classList.remove('selected');
}

openDetailModal('lead', state.currentLead.id);
}
async function addNote(leadId) {
const text = document.getElementById('newNote').value.trim();
if (!text) return;
const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
const notes = lead.notes ? JSON.parse(lead.notes) : [];

notes.push({
    text,
    author: 'Admin',
    date: new Date().toISOString()
});

try {
    const r = await fetch(`${API_URL}/api/leads/${leadId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({ notes: JSON.stringify(notes) })
    });
    
    if (!r.ok) throw new Error('Failed to add note');
    
    await loadLeads();
    showToast('Note added successfully', 'success');
    openDetailModal('lead', leadId);
} catch (e) {
    showToast('Error adding note', 'error');
}
}
async function deleteLead(id) {
if (!confirm('Are you sure you want to delete this lead?')) return;
try {
    const r = await fetch(`${API_URL}/api/leads/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete lead');
    
    await loadLeads();
    updateBadges();
    closeDetailModal();
    showToast('Lead deleted successfully', 'success');
    renderSection(state.currentSection);
} catch (e) {
    showToast('Error deleting lead', 'error');
}
}
async function deleteExpense(id) {
if (!confirm('Are you sure you want to delete this expense?')) return;
try {
    const r = await fetch(`${API_URL}/api/expenses/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete expense');
    
    showToast('Expense deleted successfully', 'success');
    openDetailModal('lead', state.currentLead.id);
} catch (e) {
    showToast('Error deleting expense', 'error');
}
}

// Delete Invoice Function
async function deleteInvoice(id) {
    const invoice = state.invoices.find(i => i.id === id);
    
    if (!confirm(`Are you sure you want to delete invoice ${invoice?.invoice_number || id}?`)) {
        return;
    }
    
    try {
        const r = await fetch(`${API_URL}/api/invoices/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            const data = await r.json();
            throw new Error(data.message || 'Failed to delete invoice');
        }
        
        await loadInvoices();
        await loadLeads();
        updateBadges();
        closeDetailModal();
        showToast('Invoice deleted successfully', 'success');
        renderSection('invoices');
    } catch (e) {
        showToast(e.message || 'Error deleting invoice', 'error');
    }
}

// Open Payment Modal
function openPaymentModal(invoiceId) {
    const invoice = state.invoices.find(i => i.id === invoiceId);
    if (!invoice) return;
    
    const modal = document.getElementById('paymentModal');
    const bodyEl = document.getElementById('paymentModalBody');
    
    bodyEl.innerHTML = `
        <form id="paymentForm" onsubmit="handlePaymentSubmit(event, ${invoiceId})">
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: var(--radius-md); margin-bottom: 24px; border: 1px solid var(--border-subtle);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Invoice Number</span>
                    <span style="color: var(--text-primary); font-weight: 600; font-family: var(--font-mono);">${invoice.invoice_number}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Customer</span>
                    <span style="color: var(--text-primary); font-weight: 600;">${invoice.customer_name || 'Unknown'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border-subtle); margin-top: 12px;">
                    <span style="color: var(--text-secondary); font-size: 14px; font-weight: 600;">Total Amount</span>
                    <span style="color: var(--accent-amber); font-weight: 800; font-size: 24px; font-family: var(--font-mono);">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Payment Method <span class="required">*</span></label>
                    <select class="form-select" name="paymentMethod" required>
                        <option value="">Select method...</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="ACH">ACH</option>
                        <option value="Check">Check</option>
                        <option value="Cash">Cash</option>
                        <option value="PayPal">PayPal</option>
                        <option value="Stripe">Stripe</option>
                        <option value="Venmo">Venmo</option>
                        <option value="Zelle">Zelle</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Reference</label>
                    <input type="text" class="form-input" name="paymentReference" placeholder="Transaction ID, Check #, etc.">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Payment Notes</label>
                    <textarea class="form-textarea" name="paymentNotes" rows="3" placeholder="Additional payment details..."></textarea>
                </div>
            </div>
            
            <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); padding: 16px; border-radius: var(--radius-md); margin-top: 24px;">
                <div style="display: flex; gap: 12px; align-items: flex-start;">
                    <svg style="width: 20px; height: 20px; color: var(--status-contacted); flex-shrink: 0; margin-top: 2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <div>
                        <div style="font-weight: 600; color: var(--status-contacted); margin-bottom: 4px;">Payment Processing</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            When you mark this invoice as paid:
                            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                <li>The customer will be marked as ACTIVE</li>
                                <li>Their lifetime value will be updated</li>
                                <li>A payment note will be added to their record</li>
                                <li>Invoice status will change to PAID</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                <button type="submit" class="btn btn-success">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Confirm Payment
                </button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

// Close Payment Modal
function closePaymentModal() {
    document.getElementById('paymentModal').classList.remove('active');
}

// Handle Payment Submission
async function handlePaymentSubmit(event, invoiceId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {
        status: 'paid',
        paymentMethod: formData.get('paymentMethod'),
        paymentReference: formData.get('paymentReference'),
        paymentNotes: formData.get('paymentNotes')
    };
    
    try {
        const r = await fetch(`${API_URL}/api/invoices/${invoiceId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) throw new Error('Failed to update invoice status');
        
        const result = await r.json();
        
        await loadInvoices();
        await loadLeads();
        updateBadges();
        closePaymentModal();
        closeDetailModal();
        showToast('Payment recorded successfully! Customer updated to ACTIVE status.', 'success');
        renderSection('invoices');
    } catch (e) {
        showToast('Error recording payment', 'error');
    }
}

async function deleteEmployee(id) {
if (!confirm('Are you sure you want to delete this employee?')) return;
try {
    const r = await fetch(`${API_URL}/api/employees/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete employee');
    
    await loadEmployees();
    showToast('Employee deleted successfully', 'success');
    renderSection('employees');
} catch (e) {
    showToast('Error deleting employee', 'error');
}
}
function deleteTask(id) {
state.tasks = state.tasks.filter(t => t.id !== id);
showToast('Task deleted successfully', 'success');
renderSection('tasks');
}
function toggleTask(id) {
const task = state.tasks.find(t => t.id === id);
if (task) {
task.completed = !task.completed;
renderSection('tasks');
}
}
function filterLeads(type) {
state.currentFilter = type;
renderSection(state.currentSection);
}
function handleInvoiceSearch(event) {
    state.searchQuery = event.target.value.toLowerCase();
    renderSection('invoices');
}
function filterInvoices(status) {
    state.currentFilter = status;
    renderSection('invoices');
}
function handleSearch(query) {
state.searchQuery = query.toLowerCase();
renderSection(state.currentSection);
}
function toggleSetting(setting) {
    state.settings[setting] = !state.settings[setting];
    
    // Save to localStorage
    localStorage.setItem('adminSettings', JSON.stringify(state.settings));
    
    // Apply the setting
    applySettings();
    
    showToast('Setting updated', 'success');
}

function applySettings() {
    // Apply dark/light mode
    if (state.settings.darkMode) {
        document.documentElement.style.setProperty('--bg-void', '#050506');
        document.documentElement.style.setProperty('--bg-primary', '#0a0a0c');
        document.documentElement.style.setProperty('--bg-secondary', '#101014');
        document.documentElement.style.setProperty('--bg-tertiary', '#16161b');
        document.documentElement.style.setProperty('--bg-elevated', '#1c1c22');
        document.documentElement.style.setProperty('--bg-hover', '#222229');
        document.documentElement.style.setProperty('--text-primary', '#f4f4f5');
        document.documentElement.style.setProperty('--text-secondary', '#a1a1aa');
        document.documentElement.style.setProperty('--text-muted', '#71717a');
        document.documentElement.style.setProperty('--text-faint', '#52525b');
        document.documentElement.style.setProperty('--border-subtle', 'rgba(255,255,255,0.04)');
        document.documentElement.style.setProperty('--border-default', 'rgba(255,255,255,0.08)');
        document.documentElement.style.setProperty('--border-strong', 'rgba(255,255,255,0.12)');
        document.body.classList.remove('light-mode');
    } else {
        // Light mode colors
        document.documentElement.style.setProperty('--bg-void', '#f5f5f7');
        document.documentElement.style.setProperty('--bg-primary', '#ffffff');
        document.documentElement.style.setProperty('--bg-secondary', '#f8f9fa');
        document.documentElement.style.setProperty('--bg-tertiary', '#f1f3f5');
        document.documentElement.style.setProperty('--bg-elevated', '#ffffff');
        document.documentElement.style.setProperty('--bg-hover', '#e9ecef');
        document.documentElement.style.setProperty('--text-primary', '#1a1a1a');
        document.documentElement.style.setProperty('--text-secondary', '#495057');
        document.documentElement.style.setProperty('--text-muted', '#6c757d');
        document.documentElement.style.setProperty('--text-faint', '#adb5bd');
        document.documentElement.style.setProperty('--border-subtle', 'rgba(0,0,0,0.06)');
        document.documentElement.style.setProperty('--border-default', 'rgba(0,0,0,0.1)');
        document.documentElement.style.setProperty('--border-strong', 'rgba(0,0,0,0.15)');
        document.body.classList.add('light-mode');
    }
}

function loadSettings() {
    const saved = localStorage.getItem('adminSettings');
    if (saved) {
        try {
            state.settings = { ...state.settings, ...JSON.parse(saved) };
        } catch (e) {
            console.error('Error loading settings:', e);
        }
    }
    applySettings();
}
function printInvoice() {
    const invoice = state.currentInvoice;
    if (!invoice) {
        showToast('No invoice selected', 'error');
        return;
    }
    
    const items = invoice.items || [];
    const taxAmount = parseFloat(invoice.tax_amount || 0);
    const discount = parseFloat(invoice.discount_amount || 0);
    
    const paymentUrl = invoice.stripe_payment_link || `${FRONTEND_BASE_URL}/invoice/${invoice.invoice_number}`;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Invoice ${invoice.invoice_number}</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; color: #1a1a1a; background: #fff; }
                .container { max-width: 800px; margin: 0 auto; }
                .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 30px; border-bottom: 4px solid #22c55e; margin-bottom: 30px; }
                .company-info h1 { font-size: 24px; font-weight: 800; margin-bottom: 5px; }
                .company-info p { color: #666; font-size: 13px; }
                .invoice-title { font-size: 32px; font-weight: 800; color: #22c55e; }
                .invoice-number { font-size: 14px; color: #666; }
                .parties { display: flex; justify-content: space-between; margin-bottom: 30px; }
                .party-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #22c55e; margin-bottom: 8px; }
                .party-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
                .party-details { font-size: 13px; color: #555; line-height: 1.6; }
                .dates { display: flex; gap: 30px; margin-bottom: 30px; }
                .date-item { background: #f5f5f5; padding: 12px 16px; border-radius: 6px; }
                .date-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #666; }
                .date-value { font-size: 14px; font-weight: 600; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                th { text-align: left; padding: 12px; background: #f5f5f5; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #666; }
                td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
                .totals { text-align: right; }
                .total-row { display: flex; justify-content: flex-end; margin-bottom: 8px; }
                .total-label { width: 150px; text-align: right; padding-right: 20px; color: #666; }
                .total-value { width: 100px; text-align: right; font-weight: 600; }
                .grand-total { font-size: 24px; color: #22c55e; font-weight: 800; border-top: 2px solid #22c55e; padding-top: 12px; margin-top: 12px; }
                @media print { body { padding: 20px; } }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <div class="company-info">
                        <h1>Diamondback Coding</h1>
                        <p>Premium Development Services</p>
                        <p>15709 Spillman Ranch Loop, Austin, TX 78738</p>
                        <p>diamondbackcoding@gmail.com</p>
                    </div>
                    <div style="text-align: right;">
                        <div class="invoice-title">INVOICE</div>
                        <div class="invoice-number">#${invoice.invoice_number}</div>
                    </div>
                </div>
                
                <div class="parties">
                    <div>
                        <div class="party-label">From</div>
                        <div class="party-name">Diamondback Coding</div>
                        <div class="party-details">15709 Spillman Ranch Loop<br>Austin, TX 78738</div>
                    </div>
                    <div>
                        <div class="party-label">Bill To</div>
                        <div class="party-name">${invoice.customer_name || 'Customer'}</div>
                        <div class="party-details">
                            ${invoice.customer_company ? invoice.customer_company + '<br>' : ''}
                            ${invoice.customer_email || ''}
                        </div>
                    </div>
                </div>
                
                <div class="dates">
                    <div class="date-item">
                        <div class="date-label">Issue Date</div>
                        <div class="date-value">${formatDate(invoice.issue_date)}</div>
                    </div>
                    <div class="date-item">
                        <div class="date-label">Due Date</div>
                        <div class="date-value">${formatDate(invoice.due_date)}</div>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th style="text-align: right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity || 1}</td>
                                <td>$${parseFloat(item.unit_price || item.amount).toLocaleString()}</td>
                                <td style="text-align: right;">$${parseFloat(item.amount).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="totals">
                    <div class="total-row">
                        <span class="total-label">Subtotal</span>
                        <span class="total-value">$${parseFloat(invoice.subtotal).toLocaleString()}</span>
                    </div>
                    ${taxAmount > 0 ? `
                        <div class="total-row">
                            <span class="total-label">Tax (${invoice.tax_rate}%)</span>
                            <span class="total-value">$${taxAmount.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    ${discount > 0 ? `
                        <div class="total-row">
                            <span class="total-label">Discount</span>
                            <span class="total-value">-$${discount.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    <div class="total-row grand-total">
                        <span class="total-label">Total</span>
                        <span class="total-value">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                    </div>
                </div>
                
                ${invoice.notes ? `<div style="margin-top: 30px; padding: 16px; background: #f5f5f5; border-radius: 6px;"><strong>Notes:</strong> ${invoice.notes}</div>` : ''}
            </div>
            <script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }<\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}
function openExportModal() {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Export Data';
    bodyEl.innerHTML = `
        <div class="form-group">
            <label class="form-label">What would you like to export?</label>
            <select class="form-select" id="exportType">
                <option value="leads">All Leads</option>
                <option value="customers">All Customers</option>
                <option value="invoices">All Invoices</option>
                <option value="employees">All Employees</option>
                <option value="all">Everything</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Export Format</label>
            <select class="form-select" id="exportFormat">
                <option value="csv">CSV (Excel compatible)</option>
                <option value="json">JSON</option>
            </select>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="performExport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
            </button>
        </div>
    `;
    
    modal.classList.add('active');
}

function performExport() {
    const exportType = document.getElementById('exportType').value;
    const exportFormat = document.getElementById('exportFormat').value;
    
    let data = [];
    let filename = '';
    
    switch (exportType) {
        case 'leads':
            data = state.leads;
            filename = 'leads';
            break;
        case 'customers':
            data = state.customers;
            filename = 'customers';
            break;
        case 'invoices':
            data = state.invoices;
            filename = 'invoices';
            break;
        case 'employees':
            data = state.employees;
            filename = 'employees';
            break;
        case 'all':
            data = {
                leads: state.leads,
                customers: state.customers,
                invoices: state.invoices,
                employees: state.employees
            };
            filename = 'all_data';
            break;
    }
    
    if (exportFormat === 'csv') {
        if (exportType === 'all') {
            // Export each type as separate CSV
            downloadCSV(state.leads, 'leads');
            downloadCSV(state.customers, 'customers');
            downloadCSV(state.invoices, 'invoices');
            downloadCSV(state.employees, 'employees');
        } else {
            downloadCSV(data, filename);
        }
    } else {
        downloadJSON(data, filename);
    }
    
    closeCreateModal();
    showToast('Export completed successfully', 'success');
}

function downloadCSV(data, filename) {
    if (!data || data.length === 0) {
        showToast(`No ${filename} data to export`, 'warning');
        return;
    }
    
    // Get headers from first object
    const headers = Object.keys(data[0]);
    
    // Build CSV content
    let csv = headers.join(',') + '\n';
    
    data.forEach(row => {
        const values = headers.map(header => {
            let value = row[header];
            
            // Handle null/undefined
            if (value === null || value === undefined) {
                return '';
            }
            
            // Handle objects/arrays (like notes or items)
            if (typeof value === 'object') {
                value = JSON.stringify(value);
            }
            
            // Convert to string and escape quotes
            value = String(value).replace(/"/g, '""');
            
            // Wrap in quotes if contains comma, newline, or quotes
            if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                value = `"${value}"`;
            }
            
            return value;
        });
        csv += values.join(',') + '\n';
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
}

function downloadJSON(data, filename) {
    if (!data || (Array.isArray(data) && data.length === 0)) {
        showToast(`No ${filename} data to export`, 'warning');
        return;
    }
    
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(link.href);
}
function logout() {
localStorage.removeItem('adminToken');
sessionStorage.removeItem('adminToken');
window.location.href = '/admin';
}
function showToast(message, type = 'success') {
const container = document.getElementById('toastContainer');
const icons = {
success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
};
const toast = document.createElement('div');
toast.className = `toast ${type}`;
toast.innerHTML = `
    <div class="toast-icon">${icons[type]}</div>
    <div class="toast-message">${message}</div>
    <button class="toast-close" onclick="this.parentElement.remove()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </button>
`;

container.appendChild(toast);
setTimeout(() => toast.remove(), 5000);
}

// ========================================
// LEAD ACTION FUNCTIONS (MISSING!)
// ========================================

// Change lead status
// Change lead status - WITH UI MODAL
async function changeLeadStatus(leadId) {
    const statuses = ['new', 'pending', 'contacted', 'closed', 'lost'];
    const currentLead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    const currentStatus = currentLead?.status || 'new';
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Change Status';
    bodyEl.innerHTML = `
        <form id="changeStatusForm" onsubmit="handleChangeStatus(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Status</label>
                <select class="form-select" name="status" required>
                    ${statuses.map(s => `
                        <option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s.toUpperCase()}</option>
                    `).join('')}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleChangeStatus(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const status = formData.get('status');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ status })
        });
        
        if (!r.ok) throw new Error('Failed to update status');
        
        await loadAllData();
        closeCreateModal();
        showToast('Status updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating status', 'error');
    }
}

// Convert lead to customer
async function convertToCustomer(leadId) {
    if (!confirm('Convert this lead to a customer?')) return;
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ 
                status: 'closed',
                isCustomer: true,
                customerStatus: 'active'
            })
        });
        
        if (!r.ok) throw new Error('Failed to convert to customer');
        
        await loadAllData();
        closeDetailModal();
        showToast('Lead converted to customer successfully!', 'success');
        renderSection('customers');
    } catch (e) {
        showToast('Error converting to customer', 'error');
    }
}

// Assign employee to lead
async function assignEmployee(leadId) {
    if (state.employees.length === 0) {
        showToast('No employees available. Add employees first.', 'warning');
        return;
    }
    
    const employeeOptions = state.employees.map(emp => 
        `<option value="${emp.id}">${emp.name} (${emp.role})</option>`
    ).join('');
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Assign Employee';
    bodyEl.innerHTML = `
        <form id="assignEmployeeForm" onsubmit="handleAssignEmployee(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Employee</label>
                <select class="form-select" name="employeeId" required>
                    <option value="">Choose employee...</option>
                    ${employeeOptions}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Assign</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleAssignEmployee(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const employeeId = formData.get('employeeId');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/assign`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ employeeId: parseInt(employeeId) })
        });
        
        if (!r.ok) throw new Error('Failed to assign employee');
        
        await loadAllData();
        closeCreateModal();
        showToast('Employee assigned successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error assigning employee', 'error');
    }
}

// Change lead priority
async function changePriority(leadId) {
    const priorities = ['low', 'medium', 'high'];
    const currentLead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    const currentPriority = currentLead?.priority || 'medium';
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Change Priority';
    bodyEl.innerHTML = `
        <form id="changePriorityForm" onsubmit="handleChangePriority(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Priority</label>
                <select class="form-select" name="priority" required>
                    ${priorities.map(p => `
                        <option value="${p}" ${p === currentPriority ? 'selected' : ''}>${p.toUpperCase()}</option>
                    `).join('')}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleChangePriority(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const priority = formData.get('priority');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/priority`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ priority })
        });
        
        if (!r.ok) throw new Error('Failed to update priority');
        
        await loadAllData();
        closeCreateModal();
        showToast('Priority updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating priority', 'error');
    }
}

// Edit customer/lead address
function editAddress(leadId) {
    const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    if (!lead) return;
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Edit Billing Address';
    bodyEl.innerHTML = `
        <form id="editAddressForm" onsubmit="handleEditAddress(event, ${leadId})">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Address Line 1</label>
                    <input type="text" class="form-input" name="address_line1" value="${lead.address_line1 || ''}" placeholder="Street address">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Address Line 2</label>
                    <input type="text" class="form-input" name="address_line2" value="${lead.address_line2 || ''}" placeholder="Apt, suite, unit, etc. (optional)">
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" class="form-input" name="city" value="${lead.city || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">State / Province</label>
                    <input type="text" class="form-input" name="state" value="${lead.state || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">ZIP / Postal Code</label>
                    <input type="text" class="form-input" name="zip_code" value="${lead.zip_code || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <input type="text" class="form-input" name="country" value="${lead.country || 'USA'}">
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Address</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

// ========================================
// RENDER PROJECTS
// ========================================
function renderProjects(content) {
    const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
    
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" id="projectSearch" placeholder="Search projects by client name, company, or project..." onkeyup="handleProjectSearch(event)">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <button class="btn btn-primary" onclick="openProjectTimelineModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                </svg>
                Create Project Timeline
            </button>
        </div>
        
        <div class="cards-grid" id="projectTimelinesGrid">
            ${savedTimelines.length > 0 ? savedTimelines.map((timeline, index) => `
                <div class="card" style="cursor: pointer;" onclick="viewProjectTimeline(${index})">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${timeline.clientName}</div>
                            <div style="font-size: 13px; color: var(--text-muted);">${timeline.clientCompany || 'No company'}</div>
                        </div>
                        <span class="status-badge status-${timeline.status || 'pending'}">
                            <span class="status-dot"></span>
                            ${timeline.status || 'Draft'}
                        </span>
                    </div>
                    <div style="margin-bottom: 16px;">
                        ${timeline.packages.map(pkg => `
                            <span style="display: inline-block; background: var(--accent-amber-dim); color: var(--accent-amber); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 6px; margin-bottom: 6px;">${servicePackages[pkg]?.name || pkg}</span>
                        `).join('')}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                        <div style="font-size: 12px; color: var(--text-muted);">
                            Created: ${formatDate(timeline.createdAt)}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="table-action-btn" onclick="event.stopPropagation(); exportProjectTimeline(${index})" title="Export">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                            </button>
                            <button class="table-action-btn danger" onclick="event.stopPropagation(); deleteProjectTimeline(${index})" title="Delete">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') : `
                <div style="grid-column: 1 / -1;">
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                        </svg>
                        <div class="empty-title">No Project Timelines Yet</div>
                        <div class="empty-description">Create your first project timeline to get started</div>
                    </div>
                </div>
            `}
        </div>
    `;
}

// Handle project search
function handleProjectSearch(event) {
    const query = event.target.value.toLowerCase();
    filterProjectTimelines(query);
}

// Open Project Timeline Modal
function openProjectTimelineModal() {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Create Project Timeline & SLA';
    
    // Initialize package selection
    window.selectedPackages = [];
    
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    const today = new Date().toISOString().split('T')[0];
    
    bodyEl.innerHTML = `
        <div class="form-grid">
            <div class="form-group full-width">
                <label class="form-label">Select Existing Client (Optional)</label>
                <select class="form-select" id="timelineClient" onchange="populateClientInfo()">
                    <option value="">New Client / Manual Entry</option>
                    ${allLeadsAndCustomers.map(lead => `
                        <option value="${lead.id}">${lead.name}${lead.company ? ' - ' + lead.company : ''} (${lead.email})</option>
                    `).join('')}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Client Name <span class="required">*</span></label>
                <input type="text" class="form-input" id="timelineClientName" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Company</label>
                <input type="text" class="form-input" id="timelineClientCompany">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email <span class="required">*</span></label>
                <input type="email" class="form-input" id="timelineClientEmail" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-input" id="timelineClientPhone">
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Client Address</label>
                <textarea class="form-textarea" id="timelineClientAddress" rows="2" placeholder="Street address, City, State ZIP"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Estimated Start Date</label>
                <input type="date" class="form-input" id="timelineStartDate" value="${today}">
            </div>
            
            <div class="form-group">
                <label class="form-label">Estimated Completion Date</label>
                <input type="date" class="form-input" id="timelineEndDate">
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Project Name / Description</label>
                <input type="text" class="form-input" id="timelineProjectName" placeholder="e.g., Company Website Redesign, E-commerce Store, etc.">
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Select Service Packages <span class="required">*</span></label>
                <div id="packagesList" style="display: grid; gap: 12px; margin-top: 12px; max-height: 400px; overflow-y: auto; padding-right: 8px;">
                    
                    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--status-contacted); margin-top: 8px; padding: 8px; background: rgba(16,185,129,0.1); border-radius: var(--radius-sm);">
                        FREE PACKAGES - No Payment Required
                    </div>
                    
                    ${Object.entries(servicePackages).filter(([key, pkg]) => pkg.isFree).map(([key, pkg]) => `
                        <div class="expense-item" style="cursor: pointer; border: 2px solid var(--status-contacted);" onclick="togglePackageSelection('${key}', this)">
                            <div class="expense-checkbox" id="pkg-check-${key}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="expense-content" style="flex: 1;">
                                <div class="expense-description">
                                    ${pkg.name}
                                    <span style="margin-left: 8px; background: var(--status-contacted); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700;">FREE</span>
                                </div>
                                <div class="expense-meta">
                                    <span>${pkg.description}</span>
                                    <span>Duration: ${pkg.duration}</span>
                                </div>
                            </div>
                            <div class="expense-amount" style="color: var(--status-contacted);">FREE</div>
                        </div>
                    `).join('')}
                    
                    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--accent-amber); margin-top: 16px; padding: 8px; background: var(--accent-amber-dim); border-radius: var(--radius-sm);">
                        PAID PACKAGES - Payment Due Upon Completion
                    </div>
                    
                    ${Object.entries(servicePackages).filter(([key, pkg]) => !pkg.isFree).map(([key, pkg]) => `
                        <div class="expense-item" style="cursor: pointer;" onclick="togglePackageSelection('${key}', this)">
                            <div class="expense-checkbox" id="pkg-check-${key}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="expense-content" style="flex: 1;">
                                <div class="expense-description">${pkg.name}</div>
                                <div class="expense-meta">
                                    <span>${pkg.description}</span>
                                    <span>Duration: ${pkg.duration}</span>
                                </div>
                            </div>
                            <div class="expense-amount">${pkg.price === 0 ? 'Custom' : '$' + pkg.price.toLocaleString()}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="form-group full-width" id="paymentTermsSection" style="display: none;">
                <label class="form-label">Payment Terms</label>
                <select class="form-select" id="paymentTerms">
                    <option value="completion">100% Due Upon Project Completion</option>
                    <option value="net30">Net 30 (Payment due 30 days after completion)</option>
                    <option value="net15">Net 15 (Payment due 15 days after completion)</option>
                    <option value="milestone">Milestone-Based (Split across project phases)</option>
                    <option value="custom">Custom Payment Plan</option>
                </select>
            </div>
            
            <div class="form-group full-width" id="customPaymentSection" style="display: none;">
                <label class="form-label">Custom Payment Details</label>
                <textarea class="form-textarea" id="customPaymentDetails" rows="2" placeholder="Describe the custom payment arrangement..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Include Monthly Maintenance?</label>
                <select class="form-select" id="maintenanceIncluded" onchange="toggleMaintenanceOptions()">
                    <option value="no">No Maintenance Included</option>
                    <option value="free">Yes - FREE Maintenance Included</option>
                    <option value="paid">Yes - Paid Maintenance Included</option>
                </select>
            </div>
            
            <div class="form-group" id="maintenanceFeeSection" style="display: none;">
                <label class="form-label">Monthly Maintenance Fee ($)</label>
                <input type="number" class="form-input" id="maintenanceFee" value="59.99" step="0.01" min="0">
            </div>
            
            <div class="form-group full-width" id="maintenanceDetailsSection" style="display: none;">
                <label class="form-label">Maintenance Details / What's Included</label>
                <textarea class="form-textarea" id="maintenanceDetails" rows="2" placeholder="Bug fixes, security updates, content changes, etc.">Bug fixes, security updates, minor content modifications (up to 2 hours/month), plugin/software updates, uptime monitoring, priority email support.</textarea>
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Special Requirements / Scope Notes</label>
                <textarea class="form-textarea" id="timelineScope" rows="3" placeholder="Any specific features, integrations, or requirements for this project..."></textarea>
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Additional Notes / Terms</label>
                <textarea class="form-textarea" id="timelineNotes" rows="2" placeholder="Any other notes or special terms..."></textarea>
            </div>
        </div>
        
        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md); margin-top: 20px;">
            <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--accent-amber); margin-bottom: 8px;">Selected Packages Summary</div>
            <div id="packagesSummary" style="font-size: 13px; color: var(--text-muted);">No packages selected</div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
            <button type="button" class="btn btn-secondary" onclick="previewProjectTimeline()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                Preview SLA
            </button>
            <button type="button" class="btn btn-primary" onclick="saveProjectTimeline()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                Save Timeline
            </button>
        </div>
    `;
    
    // Add event listener for payment terms
    setTimeout(function() {
        const paymentTermsSelect = document.getElementById('paymentTerms');
        if (paymentTermsSelect) {
            paymentTermsSelect.addEventListener('change', function() {
                const customSection = document.getElementById('customPaymentSection');
                if (this.value === 'custom') {
                    customSection.style.display = 'block';
                } else {
                    customSection.style.display = 'none';
                }
            });
        }
    }, 100);
    
    modal.classList.add('active');
}

function toggleMaintenanceOptions() {
    const maintenanceSelect = document.getElementById('maintenanceIncluded');
    const feeSection = document.getElementById('maintenanceFeeSection');
    const detailsSection = document.getElementById('maintenanceDetailsSection');
    
    if (maintenanceSelect.value === 'no') {
        feeSection.style.display = 'none';
        detailsSection.style.display = 'none';
    } else if (maintenanceSelect.value === 'free') {
        feeSection.style.display = 'none';
        detailsSection.style.display = 'block';
    } else if (maintenanceSelect.value === 'paid') {
        feeSection.style.display = 'block';
        detailsSection.style.display = 'block';
    }
}

function populateClientInfo() {
    const select = document.getElementById('timelineClient');
    const leadId = parseInt(select.value);
    
    if (!leadId) {
        // Clear fields if "New Client" selected
        document.getElementById('timelineClientName').value = '';
        document.getElementById('timelineClientCompany').value = '';
        document.getElementById('timelineClientEmail').value = '';
        document.getElementById('timelineClientPhone').value = '';
        return;
    }
    
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    const lead = allLeadsAndCustomers.find(l => l.id === leadId);
    
    if (lead) {
        document.getElementById('timelineClientName').value = lead.name || '';
        document.getElementById('timelineClientCompany').value = lead.company || '';
        document.getElementById('timelineClientEmail').value = lead.email || '';
        document.getElementById('timelineClientPhone').value = lead.phone || '';
        
        // Also populate address if available
        if (document.getElementById('timelineClientAddress')) {
            const addressParts = [];
            if (lead.address_line1) addressParts.push(lead.address_line1);
            if (lead.address_line2) addressParts.push(lead.address_line2);
            if (lead.city) addressParts.push(lead.city + ', ' + (lead.state || '') + ' ' + (lead.zip_code || ''));
            document.getElementById('timelineClientAddress').value = addressParts.join('\n');
        }
    }
}

// Update packages summary
function updatePackagesSummary() {
    const summaryEl = document.getElementById('packagesSummary');
    const paymentSection = document.getElementById('paymentTermsSection');
    const maintenanceSection = document.getElementById('maintenanceSection');
    const maintenanceFeeSection = document.getElementById('maintenanceFeeSection');
    
    if (window.selectedPackages.length === 0) {
        summaryEl.innerHTML = 'No packages selected';
        if (paymentSection) paymentSection.style.display = 'none';
        if (maintenanceSection) maintenanceSection.style.display = 'none';
        if (maintenanceFeeSection) maintenanceFeeSection.style.display = 'none';
        return;
    }
    
    let total = 0;
    let hasPaidPackage = false;
    let hasFreePackage = false;
    let hasMaintenanceEligible = false;
    
    const packages = window.selectedPackages.map(function(key) {
        const pkg = servicePackages[key];
        if (pkg.isFree) {
            hasFreePackage = true;
        } else {
            hasPaidPackage = true;
            total += pkg.price;
        }
        // Check if package has support period (eligible for maintenance)
        if (key === 'starter-website' || key === 'professional-website' || key === 'enterprise-website') {
            hasMaintenanceEligible = true;
        }
        return pkg.name + (pkg.isFree ? ' (FREE)' : ' ($' + pkg.price.toLocaleString() + ')');
    });
    
    let summaryHtml = '<div style="margin-bottom: 8px;">' + packages.join(', ') + '</div>';
    
    if (hasPaidPackage) {
        summaryHtml += '<div style="font-size: 16px; font-weight: 700; color: var(--accent-amber);">Total Investment: $' + total.toLocaleString() + '</div>';
        summaryHtml += '<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;"> Payment due upon project completion</div>';
    } else if (hasFreePackage) {
        summaryHtml += '<div style="font-size: 16px; font-weight: 700; color: var(--status-contacted);">Total: FREE</div>';
        summaryHtml += '<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;"> No payment required for free packages</div>';
    }
    
    summaryEl.innerHTML = summaryHtml;
    
    // Show/hide payment terms section (only for paid packages)
    if (paymentSection) {
        paymentSection.style.display = hasPaidPackage ? 'block' : 'none';
    }
    
    // Show/hide maintenance sections (only for packages with support periods)
    if (maintenanceSection) {
        maintenanceSection.style.display = hasMaintenanceEligible ? 'block' : 'none';
    }
    if (maintenanceFeeSection) {
        maintenanceFeeSection.style.display = hasMaintenanceEligible ? 'block' : 'none';
    }
}

async function handleEditAddress(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = {
        address_line1: formData.get('address_line1'),
        address_line2: formData.get('address_line2'),
        city: formData.get('city'),
        state: formData.get('state'),
        zip_code: formData.get('zip_code'),
        country: formData.get('country')
    };
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) throw new Error('Failed to update address');
        
        await loadAllData();
        closeCreateModal();
        showToast('Address updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating address', 'error');
    }
}

// Helper functions
function formatDate(dateString) {
if (!dateString) return 'N/A';
const date = new Date(dateString);
return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function getInitials(name) {
return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}
function getMonthlyData(leads) {
const months = new Array(6).fill(0);
const now = new Date();
leads.forEach(lead => {
    const created = new Date(lead.created_at);
    const monthDiff = (now.getFullYear() - created.getFullYear()) * 12 + (now.getMonth() - created.getMonth());
    if (monthDiff >= 0 && monthDiff < 6) {
        months[5 - monthDiff]++;
    }
});

return months;
}
function getMonthlyRevenue() {
const total = state.invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
const pending = state.invoices.filter(i => i.status === 'sent').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
const overdue = state.invoices.filter(i => i.status === 'overdue').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
return { total, pending, overdue };
}
function getMonthName(index) {
const names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
const month = new Date().getMonth() - (5 - index);
return names[month < 0 ? month + 12 : month];
}
function calculateConversionRate() {
if (state.leads.length === 0) return 0;
return Math.round((state.customers.length / (state.leads.length + state.customers.length)) * 100);
}
function filterLeads(data) {
let filtered = data;
if (state.currentFilter !== 'all') {
    filtered = filtered.filter(l => l.status === state.currentFilter);
}

if (state.searchQuery) {
    filtered = filtered.filter(l => 
        l.name.toLowerCase().includes(state.searchQuery) ||
        l.email.toLowerCase().includes(state.searchQuery) ||
        (l.company && l.company.toLowerCase().includes(state.searchQuery))
    );
}

return filtered;
}
// ========================================
// PROJECT TIMELINE / ORDER OF EVENTS SYSTEM
// ========================================

const servicePackages = {
    // FREE WEBSITE PACKAGES (No free maintenance, very basic SEO)
    'free-basic': {
        name: 'Free Basic Website',
        description: 'Entry-level website for startups and small businesses',
        price: 0,
        duration: '1-2 weeks',
        isFree: true,
        phases: [
            {
                name: 'Quick Setup & Planning',
                duration: '1-2 days',
                tasks: [
                    'Brief consultation call (30 minutes)',
                    'Basic requirements gathering',
                    'Template selection',
                    'Content outline approval'
                ]
            },
            {
                name: 'Development & Setup',
                duration: '3-5 days',
                tasks: [
                    'Up to 5 basic pages (Home, About, Services, Contact, One custom page)',
                    'Template-based design',
                    'Mobile-responsive layout',
                    'Basic contact form',
                    'Very basic on-page SEO (title tags, meta descriptions only)'
                ]
            },
            {
                name: 'Launch',
                duration: '1-2 days',
                tasks: [
                    'Basic testing',
                    'Domain connection assistance',
                    'Free subdomain deployment (yourname.render.app)',
                    'Basic Google Analytics setup',
                    'Quick 15-minute walkthrough'
                ]
            }
        ],
        features: [
            'Up to 5 basic pages',
            'Template-based design',
            'Mobile responsive',
            'Basic contact form',
            'Very basic SEO (titles & meta only)',
            'Free subdomain hosting',
            'Google Analytics',
            'NO free maintenance period',
            'NO admin dashboard',
            'NO CRM features',
            'NO custom integrations'
        ],
        notes: 'Perfect for getting online quickly. Upgrade to paid packages for advanced features. Monthly maintenance available for additional fee.'
    },
    
    'free-portfolio': {
        name: 'Free Portfolio Website',
        description: 'Showcase your work with a simple portfolio site',
        price: 0,
        duration: '1-2 weeks',
        isFree: true,
        phases: [
            {
                name: 'Portfolio Planning',
                duration: '1-2 days',
                tasks: [
                    'Brief consultation (30 minutes)',
                    'Portfolio structure planning',
                    'Gallery/project showcase setup',
                    'Content requirements list'
                ]
            },
            {
                name: 'Development',
                duration: '4-6 days',
                tasks: [
                    'Up to 6 pages (Home, About, Portfolio/Gallery, Services, Contact, Resume/Bio)',
                    'Portfolio/gallery template setup',
                    'Project showcase sections',
                    'Image optimization',
                    'Basic contact form',
                    'Very basic SEO'
                ]
            },
            {
                name: 'Launch',
                duration: '1-2 days',
                tasks: [
                    'Testing across devices',
                    'Free subdomain deployment',
                    'Basic analytics setup',
                    '15-minute training on updating portfolio'
                ]
            }
        ],
        features: [
            'Up to 6 pages',
            'Portfolio/gallery showcase',
            'Project display sections',
            'Template-based design',
            'Mobile responsive',
            'Image optimization',
            'Basic contact form',
            'Very basic SEO',
            'Free subdomain hosting',
            'NO free maintenance',
            'NO custom features'
        ],
        notes: 'Great for freelancers, artists, photographers. Monthly maintenance available for fee.'
    },
    
    'free-business-card': {
        name: 'Free Business Card Website',
        description: 'Simple one-page site with essential business info',
        price: 0,
        duration: '3-5 days',
        isFree: true,
        phases: [
            {
                name: 'Setup',
                duration: '1 day',
                tasks: [
                    'Quick 20-minute consultation',
                    'Business info collection',
                    'Single-page layout selection'
                ]
            },
            {
                name: 'Development',
                duration: '2-3 days',
                tasks: [
                    'Single-page website (all content on one page)',
                    'Sections: Header, About, Services, Contact',
                    'Template-based modern design',
                    'Mobile responsive',
                    'Click-to-call & email buttons',
                    'Google Maps embed',
                    'Very basic SEO'
                ]
            },
            {
                name: 'Launch',
                duration: '1 day',
                tasks: [
                    'Quick testing',
                    'Free subdomain deployment',
                    'Basic analytics',
                    'Quick handoff'
                ]
            }
        ],
        features: [
            'Single-page design',
            'Essential business sections',
            'Click-to-call/email buttons',
            'Google Maps integration',
            'Template-based design',
            'Mobile responsive',
            'Very basic SEO',
            'Free subdomain hosting',
            'NO multi-page navigation',
            'NO free maintenance',
            'NO custom features'
        ],
        notes: 'Perfect for establishing basic online presence quickly. Monthly maintenance available for fee.'
    },
    
    'free-landing-page': {
        name: 'Free Landing Page',
        description: 'Single focused landing page for campaigns or lead generation',
        price: 0,
        duration: '3-5 days',
        isFree: true,
        phases: [
            {
                name: 'Campaign Planning',
                duration: '1 day',
                tasks: [
                    '20-minute strategy call',
                    'Campaign goal identification',
                    'Call-to-action planning',
                    'Lead capture form setup'
                ]
            },
            {
                name: 'Development',
                duration: '2-3 days',
                tasks: [
                    'Single focused landing page',
                    'Conversion-focused template design',
                    'Lead capture form',
                    'Call-to-action buttons',
                    'Mobile responsive',
                    'Very basic SEO for target keyword'
                ]
            },
            {
                name: 'Launch',
                duration: '1 day',
                tasks: [
                    'Form testing',
                    'Free subdomain deployment',
                    'Basic conversion tracking',
                    'Quick handoff'
                ]
            }
        ],
        features: [
            'Single landing page',
            'Conversion-focused design',
            'Lead capture form',
            'Mobile responsive',
            'Call-to-action optimization',
            'Very basic SEO',
            'Free subdomain hosting',
            'Basic conversion tracking',
            'NO multi-page site',
            'NO free maintenance',
            'NO advanced integrations'
        ],
        notes: 'Ideal for campaigns, promotions, or testing ideas. Monthly maintenance available for fee.'
    },
    
    'starter-website': {
        name: 'Starter Package - $1,499',
        description: 'Perfect for small businesses getting started online',
        price: 1499,
        duration: '2-3 weeks',
        phases: [
            {
                name: 'Discovery & Planning',
                duration: '2-3 days',
                tasks: [
                    'Initial consultation and requirements gathering',
                    'Brand guidelines review',
                    'Content strategy planning',
                    'Wireframe approval',
                    'Contract execution and 50% deposit collection'
                ]
            },
            {
                name: 'Design & Development',
                duration: '1-2 weeks',
                tasks: [
                    'Up to 15 custom-designed pages',
                    'Modern, professional UI design',
                    'Mobile-responsive layout implementation',
                    'Contact form integration',
                    'Basic SEO setup',
                    'Performance-optimized frontend'
                ]
            },
            {
                name: 'User System & Database',
                duration: '3-4 days',
                tasks: [
                    'Custom basic user login & authentication',
                    'Secure admin dashboard access',
                    'PostgreSQL database setup',
                    'Admin panel for managing leads & submissions',
                    'Role-ready structure for future expansion'
                ]
            },
            {
                name: 'Lead Capture & CRM',
                duration: '2-3 days',
                tasks: [
                    'Contact forms with lead capture',
                    'Leads stored securely in database',
                    'Basic CRM setup (leads & contacts)',
                    'Status tracking for new & contacted leads'
                ]
            },
            {
                name: 'Optional Integrations',
                duration: '1-2 days',
                tasks: [
                    'Email automation integration (if requested)',
                    'SMS marketing automation (if requested)',
                    'Stripe or Shopify billing integration (if requested)',
                    'E-commerce ready with cart system (if requested)',
                    'Form-triggered notifications'
                ]
            },
            {
                name: 'Testing & Launch',
                duration: '2-3 days',
                tasks: [
                    'Cross-browser testing',
                    'Mobile responsiveness check',
                    'Client review and revisions',
                    'Domain setup and deployment to Render',
                    'SSL certificate installation',
                    'Google Analytics setup',
                    'Final 50% payment collection',
                    '90 days of free add-ons begins',
                    '90 days of free priority support begins'
                ]
            }
        ],
        features: [
            'Up to 15 custom-designed pages',
            'Mobile responsive design',
            'Contact form integration',
            'Basic SEO optimization',
            'Custom user login & authentication',
            'Secure admin dashboard',
            'PostgreSQL database',
            'Basic CRM for leads',
            'Render deployment',
            'Google Analytics setup',
            '90 days of free add-ons',
            '90 days of free priority support',
            'Optional: Email/SMS automation',
            'Optional: Stripe/Shopify integration',
            'Optional: E-commerce cart system'
        ],
        notes: 'Some features may require third-party services or usage-based fees (SMS, email, payment processing)'
    },
    
    'professional-website': {
        name: 'Professional Package - $2,999',
        description: 'Comprehensive solution for growing businesses',
        price: 2999,
        duration: '4-6 weeks',
        phases: [
            {
                name: 'Strategy & Planning',
                duration: '1 week',
                tasks: [
                    'In-depth business analysis',
                    'Competitor research',
                    'User persona development',
                    'Site architecture planning (up to 25 pages)',
                    'Content strategy development',
                    'Contract execution and 50% deposit collection'
                ]
            },
            {
                name: 'Design Phase',
                duration: '1-2 weeks',
                tasks: [
                    'Custom design mockups (2-3 concepts)',
                    'Design revision rounds',
                    'UI/UX optimization',
                    'Brand integration',
                    'Design system creation',
                    'Mobile-responsive layouts'
                ]
            },
            {
                name: 'Development Phase',
                duration: '2-3 weeks',
                tasks: [
                    'Up to 25 custom-designed pages',
                    'Frontend development',
                    'Advanced CMS integration',
                    'Custom user logins & account management',
                    'Expanded admin dashboard functionality',
                    'Blog/news section development',
                    'Advanced contact forms',
                    'Newsletter integration'
                ]
            },
            {
                name: 'Advanced Features',
                duration: '3-5 days',
                tasks: [
                    'Advanced CRM setup (leads & contacts)',
                    'Lead status pipelines & categorization',
                    'Admin-side lead notes & tracking',
                    'E-commerce ready (up to 10 products)',
                    'Advanced business analytics & KPIs',
                    'Custom data tracking for user activity'
                ]
            },
            {
                name: 'SEO & Performance',
                duration: '2-3 days',
                tasks: [
                    'Advanced SEO implementation',
                    'Performance optimization',
                    'Security hardening',
                    'Google Analytics & Search Console setup',
                    'Social media integration',
                    'Live chat integration'
                ]
            },
            {
                name: 'Testing & Launch',
                duration: '3-5 days',
                tasks: [
                    'Comprehensive QA testing',
                    'Security audit',
                    'Client training sessions',
                    'Staged deployment to Render',
                    'Post-launch monitoring',
                    'Final 50% payment collection',
                    '120 days of free add-ons begins',
                    '120 days of free priority support begins'
                ]
            }
        ],
        features: [
            'Up to 25 custom-designed pages',
            'Custom design (unlimited revisions)',
            'Advanced CMS integration',
            'Blog/news section',
            'Advanced contact forms',
            'Newsletter integration',
            'E-commerce ready (up to 10 products)',
            'Advanced SEO package',
            'Social media integration',
            'Google Analytics & Search Console',
            'Live chat integration',
            'Advanced CRM with pipelines',
            'Custom analytics & KPIs',
            'Performance optimization',
            'Security hardening',
            '120 days of free add-ons',
            '120 days of free priority support'
        ],
        notes: 'Some features may require third-party services or usage-based fees'
    },
    
    'enterprise-website': {
        name: 'Enterprise Package - Custom Pricing',
        description: 'Full-scale solution for established businesses',
        price: 0, // Custom pricing
        duration: '8-12 weeks',
        phases: [
            {
                name: 'Discovery & Strategy',
                duration: '2 weeks',
                tasks: [
                    'Stakeholder interviews',
                    'Comprehensive market research',
                    'User journey mapping',
                    'Technical requirements analysis',
                    'Information architecture planning',
                    'Content audit and strategy',
                    'Conversion optimization planning',
                    'Contract execution and initial payment'
                ]
            },
            {
                name: 'Design & Prototyping',
                duration: '3-4 weeks',
                tasks: [
                    'Multiple design concepts',
                    'Interactive prototypes',
                    'User testing and feedback',
                    'Accessibility compliance review',
                    'Design system development',
                    'Brand guidelines integration'
                ]
            },
            {
                name: 'Development & Integration',
                duration: '4-6 weeks',
                tasks: [
                    'Unlimited custom-designed pages',
                    'Custom backend development',
                    'API integrations',
                    'Third-party service connections',
                    'Database architecture',
                    'Advanced CMS customization',
                    'E-commerce implementation (unlimited products)',
                    'User portal/membership system',
                    'Multi-language support',
                    'Security implementation'
                ]
            },
            {
                name: 'Advanced Systems',
                duration: '1-2 weeks',
                tasks: [
                    'Advanced analytics and reporting',
                    'Marketing automation integration',
                    'CRM integration',
                    'API development',
                    'Advanced security features',
                    'Custom admin dashboard',
                    'A/B testing setup',
                    'Conversion rate optimization'
                ]
            },
            {
                name: 'Testing, Training & Launch',
                duration: '1-2 weeks',
                tasks: [
                    'Extensive QA testing',
                    'Load and performance testing',
                    'Security penetration testing',
                    'Staff training program',
                    'Documentation creation',
                    'Phased rollout strategy',
                    'Post-launch optimization',
                    'Final payment collection',
                    '12 months of premium support begins'
                ]
            }
        ],
        features: [
            'Unlimited custom pages',
            'Fully custom design and development',
            'Advanced CMS with custom modules',
            'E-commerce platform (unlimited products)',
            'User portal/membership system',
            'Multi-language support',
            'Advanced analytics and reporting',
            'Marketing automation integration',
            'CRM integration',
            'API development',
            'Third-party integrations',
            'Advanced security features',
            'Dedicated project manager',
            'Custom admin dashboard',
            'A/B testing setup',
            'Conversion rate optimization',
            '12 months of premium support',
            'Priority bug fixes',
            'Monthly performance reports'
        ],
        notes: 'Pricing varies based on project scope and requirements'
    },
    
    'seo-services': {
        name: 'SEO Services - $199/month',
        description: 'Comprehensive SEO optimization for Hill Country businesses',
        price: 199,
        duration: 'Ongoing monthly service',
        phases: [
            {
                name: 'Initial SEO Audit',
                duration: '1 week',
                tasks: [
                    'Comprehensive website SEO audit',
                    'Keyword research for Hill Country markets',
                    'Competitor analysis',
                    'Technical SEO assessment',
                    'Current ranking baseline report'
                ]
            },
            {
                name: 'Monthly Optimization',
                duration: 'Ongoing',
                tasks: [
                    'On-page SEO optimization',
                    'Content optimization for target keywords',
                    'Local SEO improvements',
                    'Google My Business optimization',
                    'Local citation building',
                    'Schema markup updates',
                    'Performance monitoring'
                ]
            },
            {
                name: 'Monthly Reporting',
                duration: 'Monthly',
                tasks: [
                    'Keyword ranking tracking',
                    'Traffic analysis',
                    'Conversion tracking',
                    'Competitor ranking comparisons',
                    'Monthly performance reports',
                    'Strategy adjustments'
                ]
            }
        ],
        features: [
            'Keyword research (Hill Country focus)',
            'On-page SEO optimization',
            'Technical SEO fixes',
            'Local SEO optimization',
            'Google My Business management',
            'Schema markup implementation',
            'Content optimization',
            'Monthly performance reports',
            'Keyword ranking tracking',
            'Google Analytics monitoring',
            'Competitor analysis',
            'Review generation support'
        ],
        notes: 'Results typically visible within 3-6 months'
    },
    
    'digital-marketing': {
        name: 'Digital Marketing Services - Custom Pricing',
        description: 'Comprehensive marketing campaigns for growth',
        price: 0, // Custom pricing
        duration: 'Custom campaign duration',
        phases: [
            {
                name: 'Strategy Development',
                duration: '1-2 weeks',
                tasks: [
                    'Marketing goals definition',
                    'Target audience research',
                    'Platform selection',
                    'Budget allocation planning',
                    'Campaign strategy creation',
                    'Content calendar development'
                ]
            },
            {
                name: 'Campaign Setup',
                duration: '1 week',
                tasks: [
                    'Account setup (Facebook, Google, etc.)',
                    'Audience targeting configuration',
                    'Ad creative development',
                    'Landing page optimization',
                    'Tracking pixel installation',
                    'Conversion goals setup'
                ]
            },
            {
                name: 'Campaign Management',
                duration: 'Ongoing',
                tasks: [
                    'Daily campaign monitoring',
                    'A/B testing',
                    'Budget optimization',
                    'Ad creative updates',
                    'Audience refinement',
                    'Performance analysis',
                    'Weekly optimization'
                ]
            },
            {
                name: 'Reporting & Optimization',
                duration: 'Ongoing',
                tasks: [
                    'Weekly performance reports',
                    'Monthly strategy sessions',
                    'ROI analysis',
                    'Campaign adjustments',
                    'Conversion rate optimization',
                    'Competitive analysis'
                ]
            }
        ],
        features: [
            'Social media marketing (Facebook, Instagram, LinkedIn)',
            'Google Ads (Search, Display, LSA)',
            'Facebook & Instagram Ads',
            'Email marketing campaigns',
            'Content marketing',
            'Lead generation campaigns',
            'Retargeting campaigns',
            'Analytics & reporting',
            'A/B testing',
            'ROI tracking',
            'Custom audience creation',
            'Campaign optimization'
        ],
        notes: 'Pricing varies based on campaign complexity and ad spend budget'
    }
};

// STANDARDIZED WEBSITE DEVELOPMENT PROCESS
// This applies to ALL website projects regardless of package
const standardWebsitePhases = [
    {
        name: 'Discovery & Planning Meeting',
        duration: '1 week',
        tasks: [
            'Initial meeting to discuss your preferences and expectations',
            'Review project timeline and what will be delivered',
            'Understand your industry, business needs, and target audience',
            'Define the message and persona your website needs to convey',
            'Establish clear goals for the website'
        ]
    },
    {
        name: 'Draft Development & Iteration',
        duration: '2-4 weeks (varies by package)',
        tasks: [
            'Start Round 1 draft of the website design',
            'Two (2) progress meetings per week during this phase',
            'Review feedback and make revisions each round',
            'Continue rounds until you approve a final draft',
            'As many revisions as needed to get it right'
        ]
    },
    {
        name: 'Functionality & Systems Integration',
        duration: '1-2 weeks',
        tasks: [
            'Turn the approved draft into a fully functional website',
            'Integrate all systems (forms, databases, CRM, etc.)',
            'Add all technical features included in your package',
            'Implement SEO and analytics tracking'
        ]
    },
    {
        name: 'Soft Deployment & Testing',
        duration: '3-5 days',
        tasks: [
            'Deploy website to a private testing environment',
            'Send you a private link to review and test the site',
            'You test everything and provide any final feedback',
            'We fix any issues that come up'
        ]
    },
    {
        name: 'Go-Live Deployment',
        duration: '1-2 days',
        tasks: [
            'Set an agreed-upon go-live date',
            'Confirm all issues are resolved before go-live',
            'Connect your domain and make the site live',
            'Site goes live on the scheduled date',
            'Monitor for 24 hours after launch',
            'Provide training on how to manage your site'
        ]
    }
];

// Preview Project Timeline
function previewProjectTimeline() {
    if (window.selectedPackages.length === 0) {
        showToast('Please select at least one service package', 'error');
        return;
    }
    
    const clientName = document.getElementById('timelineClientName').value;
    if (!clientName) {
        showToast('Please enter a client name', 'error');
        return;
    }
    
    // Check if any paid packages selected
    let hasPaidPackage = false;
    let totalPrice = 0;
    window.selectedPackages.forEach(function(key) {
        if (servicePackages[key] && !servicePackages[key].isFree) {
            hasPaidPackage = true;
            totalPrice += servicePackages[key].price;
        }
    });
    
    const maintenanceIncluded = document.getElementById('maintenanceIncluded').value;
    
    const timeline = {
        clientId: document.getElementById('timelineClient').value || null,
        clientName: clientName,
        clientCompany: document.getElementById('timelineClientCompany').value,
        clientEmail: document.getElementById('timelineClientEmail').value,
        clientPhone: document.getElementById('timelineClientPhone').value,
        clientAddress: document.getElementById('timelineClientAddress').value,
        startDate: document.getElementById('timelineStartDate').value,
        endDate: document.getElementById('timelineEndDate').value,
        projectName: document.getElementById('timelineProjectName').value,
        scope: document.getElementById('timelineScope').value,
        notes: document.getElementById('timelineNotes').value,
        packages: window.selectedPackages,
        totalPrice: totalPrice,
        isFreeProject: !hasPaidPackage,
        paymentTerms: hasPaidPackage ? (document.getElementById('paymentTerms') ? document.getElementById('paymentTerms').value : 'completion') : 'none',
        customPaymentDetails: document.getElementById('customPaymentDetails') ? document.getElementById('customPaymentDetails').value : '',
        maintenanceIncluded: maintenanceIncluded,
        maintenanceFee: maintenanceIncluded === 'paid' ? (parseFloat(document.getElementById('maintenanceFee').value) || 59.99) : 0,
        maintenanceDetails: document.getElementById('maintenanceDetails') ? document.getElementById('maintenanceDetails').value : '',
        status: 'draft',
        createdAt: new Date().toISOString()
    };
    
    closeCreateModal();
    openTimelinePreviewModal(timeline);
}

// Toggle package selection
function togglePackageSelection(packageKey, element) {
    const checkbox = document.getElementById(`pkg-check-${packageKey}`);
    const index = window.selectedPackages.indexOf(packageKey);
    
    if (index > -1) {
        window.selectedPackages.splice(index, 1);
        checkbox.classList.remove('checked');
        element.classList.remove('selected');
    } else {
        window.selectedPackages.push(packageKey);
        checkbox.classList.add('checked');
        element.classList.add('selected');
    }
    
    updatePackagesSummary();
}

// Save Project Timeline
function saveProjectTimeline() {
    if (window.selectedPackages.length === 0) {
        showToast('Please select at least one service package', 'error');
        return;
    }
    
    const clientName = document.getElementById('timelineClientName').value;
    if (!clientName) {
        showToast('Please enter a client name', 'error');
        return;
    }
    
    const clientEmail = document.getElementById('timelineClientEmail').value;
    if (!clientEmail) {
        showToast('Please enter a client email', 'error');
        return;
    }
    
    // Check if any paid packages selected
    let hasPaidPackage = false;
    let totalPrice = 0;
    window.selectedPackages.forEach(function(key) {
        if (servicePackages[key] && !servicePackages[key].isFree) {
            hasPaidPackage = true;
            totalPrice += servicePackages[key].price;
        }
    });
    
    const maintenanceIncluded = document.getElementById('maintenanceIncluded').value;
    
    const timeline = {
        clientId: document.getElementById('timelineClient').value || null,
        clientName: clientName,
        clientCompany: document.getElementById('timelineClientCompany').value,
        clientEmail: clientEmail,
        clientPhone: document.getElementById('timelineClientPhone').value,
        clientAddress: document.getElementById('timelineClientAddress').value,
        startDate: document.getElementById('timelineStartDate').value,
        endDate: document.getElementById('timelineEndDate').value,
        projectName: document.getElementById('timelineProjectName').value,
        scope: document.getElementById('timelineScope').value,
        notes: document.getElementById('timelineNotes').value,
        packages: window.selectedPackages,
        totalPrice: totalPrice,
        isFreeProject: !hasPaidPackage,
        paymentTerms: hasPaidPackage ? (document.getElementById('paymentTerms') ? document.getElementById('paymentTerms').value : 'completion') : 'none',
        customPaymentDetails: document.getElementById('customPaymentDetails') ? document.getElementById('customPaymentDetails').value : '',
        maintenanceIncluded: maintenanceIncluded,
        maintenanceFee: maintenanceIncluded === 'paid' ? (parseFloat(document.getElementById('maintenanceFee').value) || 59.99) : 0,
        maintenanceDetails: document.getElementById('maintenanceDetails') ? document.getElementById('maintenanceDetails').value : '',
        status: 'draft',
        createdAt: new Date().toISOString()
    };
    
    // Save to localStorage
    const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
    savedTimelines.unshift(timeline);
    localStorage.setItem('projectTimelines', JSON.stringify(savedTimelines));
    
    closeCreateModal();
    showToast('Project timeline saved successfully', 'success');
    renderSection('projects');
}

// Open Timeline Preview Modal
function openTimelinePreviewModal(timeline) {
    const modal = document.getElementById('detailModal');
    const titleEl = document.getElementById('detailModalTitle');
    const bodyEl = document.getElementById('detailModalBody');
    const footerEl = document.getElementById('detailModalFooter');

    titleEl.textContent = 'Project Timeline & SLA Preview';

    // Important: first set basic structure with tabs
    bodyEl.innerHTML = `
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="timeline">Timeline</button>
            <button class="tab" data-tab="preview">Full SLA Preview</button>
        </div>

        <div id="tab-overview" class="tab-content" style="padding: 24px;">
            <h3 style="margin-bottom: 16px;">Quick Summary</h3>
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: var(--radius-md);">
                <strong>Client:</strong> ${timeline.clientName}${timeline.clientCompany ? ' / ' + timeline.clientCompany : ''}<br>
                <strong>Project:</strong> ${timeline.projectName || 'Web Development Project'}<br>
                <strong>Packages:</strong> ${timeline.packages.map(k => servicePackages[k]?.name || k).join(', ')}<br>
                <strong>Total:</strong> ${timeline.isFreeProject ? 'FREE' : '$' + timeline.totalPrice.toLocaleString()}<br>
                <strong>Start:</strong> ${formatDate(timeline.startDate)}  <strong>End:</strong> ${formatDate(timeline.endDate || 'TBD')}
            </div>
        </div>

        <div id="tab-timeline" class="tab-content" style="display:none; padding: 24px;">
            <!-- You can put simplified timeline here if you want -->
            <h3>Phases Overview</h3>
            <p>(Detailed timeline appears in Full SLA Preview tab)</p>
        </div>

        <div id="tab-preview" class="tab-content" style="display:none;"></div>
    `;

    footerEl.innerHTML = `
        <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
        <button class="btn btn-primary" onclick="exportTimelineAsPDF()">
            Export as PDF
        </button>
    `;

    modal.classList.add('active');

    // Store for export
    window.currentTimelinePreview = timeline;

    // ------------------ IMPORTANT PART ------------------
    // Activate click handlers for tabs
    document.querySelectorAll('#detailModal .tab').forEach(tab => {
        tab.addEventListener('click', function () {
            // Remove active from all tabs
            document.querySelectorAll('#detailModal .tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Hide all contents
            document.querySelectorAll('#detailModal .tab-content').forEach(c => c.style.display = 'none');

            // Show selected
            const tabId = 'tab-' + this.dataset.tab;
            const content = document.getElementById(tabId);
            if (content) {
                content.style.display = 'block';

                // Special case: when user clicks "Full SLA Preview" tab  generate content
                if (this.dataset.tab === 'preview') {
                    content.innerHTML = generateTimelineHTML(timeline);

                    // Optional: re-generate QR codes or other dynamic elements if needed
                    setTimeout(() => {
                        // If you have QR code logic here, re-run it
                    }, 100);
                }
            }
        });
    });

    // Show overview by default
    document.querySelector('#detailModal .tab[data-tab="overview"]').click();
}

// Generate Timeline HTML (generates the SLA document)
function generateTimelineHTML(timeline) {
    // Use the SAME HTML generation logic as PDF export
    let totalPrice = 0;
    let hasPaidPackage = false;
    
    timeline.packages.forEach(function(key) {
        if (servicePackages[key] && !servicePackages[key].isFree) {
            hasPaidPackage = true;
            totalPrice += servicePackages[key].price;
        }
    });
    
    const companySignatureDate = formatDate(timeline.createdAt);
    const documentId = `SLA-${new Date(timeline.createdAt).getFullYear()}-${String(Date.now()).slice(-6)}`;
    
    // Get longest support period
    let longestSupportPeriod = 0;
    timeline.packages.forEach(key => {
        if (key === 'starter-website') longestSupportPeriod = Math.max(longestSupportPeriod, 90);
        if (key === 'professional-website') longestSupportPeriod = Math.max(longestSupportPeriod, 120);
        if (key === 'enterprise-website') longestSupportPeriod = Math.max(longestSupportPeriod, 365);
    });
    
    // Build packages HTML
    let packagesListHtml = '';
    timeline.packages.forEach(function(key) {
        if (servicePackages[key]) {
            const pkg = servicePackages[key];
            packagesListHtml += '<span style="display: inline-block; background: var(--accent-amber-dim); color: var(--accent-amber); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin: 4px;">' + pkg.name + (pkg.isFree ? ' (FREE)' : '') + '</span>';
        }
    });
    
    // Build phases HTML
    let phasesHtml = '';
    let phaseNumber = 1;
    timeline.packages.forEach(function(packageKey) {
        const pkg = servicePackages[packageKey];
        if (!pkg) return;
        
        phasesHtml += '<div style="margin-bottom: 24px; padding: 20px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md);">';
        phasesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--accent-amber);">';
        phasesHtml += '<div><div style="font-size: 16px; font-weight: 700; color: var(--text-primary);">' + pkg.name + '</div>';
        phasesHtml += '<div style="font-size: 12px; color: var(--text-secondary);">' + pkg.description + '</div></div>';
        phasesHtml += '<div style="text-align: right;"><div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted);">Duration</div>';
        phasesHtml += '<div style="font-size: 14px; font-weight: 700; color: var(--text-primary);">' + pkg.duration + '</div></div></div>';
        
        if (pkg.phases) {
            pkg.phases.forEach(function(phase) {
                phasesHtml += '<div style="margin-bottom: 16px; padding-left: 16px; border-left: 3px solid var(--accent-amber);">';
                phasesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                phasesHtml += '<div><span style="display: inline-block; background: var(--accent-amber); color: var(--bg-void); padding: 2px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; margin-right: 8px;">Phase ' + phaseNumber + '</span>';
                phasesHtml += '<span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">' + phase.name + '</span></div>';
                phasesHtml += '<span style="font-size: 11px; color: var(--text-muted); background: var(--bg-hover); padding: 4px 10px; border-radius: var(--radius-sm);">' + phase.duration + '</span></div>';
                phasesHtml += '<ul style="list-style: none; padding: 0; margin: 0;">';
                
                phase.tasks.forEach(function(task) {
                    phasesHtml += '<li style="display: flex; align-items: flex-start; gap: 8px; padding: 5px 0; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border-subtle);">';
                    phasesHtml += '<svg style="width: 14px; height: 14px; color: var(--accent-amber); flex-shrink: 0; margin-top: 3px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
                    phasesHtml += task + '</li>';
                });
                
                phasesHtml += '</ul></div>';
                phaseNumber++;
            });
        }
        
        // Features list
        if (pkg.features) {
            phasesHtml += '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">';
            phasesHtml += '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px;">Included Features</div>';
            phasesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
            pkg.features.forEach(function(feature) {
                phasesHtml += '<span style="background: var(--bg-hover); color: var(--text-secondary); padding: 3px 8px; border-radius: 12px; font-size: 10px; border: 1px solid var(--border-subtle);">' + feature + '</span>';
            });
            phasesHtml += '</div></div>';
        }
        
        phasesHtml += '</div>';
    });
    
    // Payment terms
    let paymentTermsHtml = '';
    if (timeline.isFreeProject || !hasPaidPackage) {
        paymentTermsHtml = 'No Payment Required';
    } else {
        switch (timeline.paymentTerms) {
            case 'completion':
                paymentTermsHtml = '50% Deposit + 50% on Completion';
                break;
            case 'net30':
                paymentTermsHtml = 'Net 30 (Payment due 30 days after completion)';
                break;
            case 'net15':
                paymentTermsHtml = 'Net 15 (Payment due 15 days after completion)';
                break;
            case 'milestone':
                paymentTermsHtml = 'Milestone-Based (Split across project phases)';
                break;
            case 'custom':
                paymentTermsHtml = timeline.customPaymentDetails || 'Custom Payment Plan';
                break;
            default:
                paymentTermsHtml = '50% Deposit + 50% on Completion';
        }
    }
    
    // Maintenance section
    let maintenanceHtml = '';
    if (timeline.maintenanceIncluded && timeline.maintenanceIncluded !== 'no') {
        maintenanceHtml = '<div style="background: var(--bg-tertiary); padding: 20px; border: 1px solid var(--border-subtle); border-left: 4px solid ' + (timeline.maintenanceIncluded === 'free' ? 'var(--status-contacted)' : 'var(--accent-amber)') + '; border-radius: var(--radius-md); margin-bottom: 24px;">';
        maintenanceHtml += '<div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 12px;">Maintenance & Support Terms</div>';
        
        if (timeline.maintenanceIncluded === 'free') {
            maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: var(--status-contacted); margin-bottom: 12px;"> FREE Maintenance';
            if (longestSupportPeriod > 0) {
                maintenanceHtml += ' During ' + longestSupportPeriod + '-Day Support Period';
            }
            maintenanceHtml += '</div>';
        } else if (timeline.maintenanceIncluded === 'paid') {
            maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">Post-Support Maintenance: $' + parseFloat(timeline.maintenanceFee || 59.99).toFixed(2) + '/month';
            if (longestSupportPeriod > 0) {
                maintenanceHtml += ' (After ' + longestSupportPeriod + '-Day Free Support Period)';
            }
            maintenanceHtml += '</div>';
        }
        
        maintenanceHtml += '<div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">';
        if (timeline.maintenanceDetails) {
            maintenanceHtml += timeline.maintenanceDetails;
        } else {
            maintenanceHtml += 'Bug fixes, security updates, minor content modifications (up to 2 hours/month), plugin/software updates, uptime monitoring, priority email support.';
        }
        maintenanceHtml += '</div></div>';
    } else if (longestSupportPeriod > 0) {
        maintenanceHtml = '<div style="background: var(--bg-tertiary); padding: 20px; border: 1px solid var(--border-subtle); border-left: 4px solid var(--accent-amber); border-radius: var(--radius-md); margin-bottom: 24px;">';
        maintenanceHtml += '<div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 12px;">Post-Launch Support</div>';
        maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">' + longestSupportPeriod + ' Days of FREE Priority Support Included</div>';
        maintenanceHtml += '<div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">Following project launch, you will receive ' + longestSupportPeriod + ' days of free priority support including bug fixes, technical assistance, and minor adjustments.</div></div>';
    }
    
    // Scope section
    let scopeHtml = '';
    if (timeline.scope) {
        scopeHtml = '<div style="background: var(--bg-tertiary); padding: 16px; border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 24px;">';
        scopeHtml += '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px;">Project Scope / Special Requirements</div>';
        scopeHtml += '<p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.7;">' + timeline.scope + '</p></div>';
    }
    
    // Return the SAME structure as PDF
    return `
        <div style="padding: 24px;">
            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md); margin-bottom: 32px; border-left: 4px solid var(--accent-amber);">
                <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 12px;">Agreement Overview</div>
                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                    This Service Level Agreement is entered into as of <strong>${companySignatureDate}</strong> by and between 
                    <strong>Diamondback Coding</strong> and <strong>${timeline.clientName}${timeline.clientCompany ? ' / ' + timeline.clientCompany : ''}</strong>.
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 32px;">
                <div>
                    <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 6px;">Service Provider</div>
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Diamondback Coding</div>
                    <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;">
                        15709 Spillman Ranch Loop<br>
                        Austin, TX 78738<br>
                        diamondbackcoding@gmail.com<br>
                        (940) 217-8680
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-hover); border-radius: var(--radius-sm);">
                        <div style="font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px;">Company Signature</div>
                        <div style="font-family: cursive; font-size: 20px; color: var(--accent-amber); margin-bottom: 4px;">Diamondback Coding</div>
                        <div style="font-size: 10px; color: var(--text-muted);">Digitally Signed: ${companySignatureDate}</div>
                    </div>
                </div>
                <div>
                    <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 6px;">Client</div>
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">${timeline.clientName}</div>
                    <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;">
                        ${timeline.clientCompany ? timeline.clientCompany + '<br>' : ''}
                        ${timeline.clientEmail || ''}${timeline.clientPhone || timeline.clientAddress ? '<br>' : ''}
                        ${timeline.clientPhone || ''}${timeline.clientAddress ? '<br>' : ''}
                        ${timeline.clientAddress ? timeline.clientAddress.replace(/\n/g, '<br>') : ''}
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-hover); border-radius: var(--radius-sm); border: 2px dashed var(--border-strong);">
                        <div style="font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px;">Client Signature Required</div>
                        <div style="height: 40px; border-bottom: 1px solid var(--text-muted); margin-bottom: 4px;"></div>
                        <div style="font-size: 10px; color: var(--text-muted);">Date: _______________</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 32px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Project Details</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Project Name</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${timeline.projectName || 'Web Development Project'}</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Estimated Start Date</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${formatDate(timeline.startDate)}</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Total Investment</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${timeline.isFreeProject ? 'FREE' : '$' + totalPrice.toLocaleString()}</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Payment Terms</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${paymentTermsHtml}</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 32px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Selected Services</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${packagesListHtml}
                </div>
            </div>
            
            ${scopeHtml}

            <!-- STANDARDIZED WEBSITE DEVELOPMENT TIMELINE -->
<div style="margin-bottom: 32px;">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Website Development Process</div>
    
    <div style="margin-bottom: 32px; padding: 24px; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle);">
        ${standardWebsitePhases.map((phase, index) => `
            <div style="margin-bottom: 20px; padding-left: 20px; border-left: 3px solid var(--accent-amber);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div>
                        <span style="display: inline-block; background: var(--accent-amber); color: var(--bg-void); padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; margin-right: 8px;">Phase ${index + 1}</span>
                        <span style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${phase.name}</span>
                    </div>
                    <span style="font-size: 12px; color: var(--text-muted); background: var(--bg-hover); padding: 4px 10px; border-radius: var(--radius-sm);">${phase.duration}</span>
                </div>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    ${phase.tasks.map(task => `
                        <li style="display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border-subtle);">
                            <svg style="width: 16px; height: 16px; color: var(--accent-amber); flex-shrink: 0; margin-top: 2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 11 12 14 22 4"/>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                            ${task}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `).join('')}
    </div>
</div>

<!-- DETAILED PROJECT TIMELINE -->
<div style="margin-bottom: 32px;">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Detailed Project Timeline</div>
            
            <div style="margin-bottom: 32px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Service Level Commitments</div>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex-shrink: 0; width: 24px; height: 24px; background: var(--accent-amber); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-void); font-weight: 700; font-size: 12px;">1</div>
                        <div><div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Timeline Adherence</div><div style="font-size: 13px; color: var(--text-secondary);">Provider commits to delivering all project phases within specified timeframes.</div></div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex-shrink: 0; width: 24px; height: 24px; background: var(--accent-amber); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-void); font-weight: 700; font-size: 12px;">2</div>
                        <div><div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Communication Response Time</div><div style="font-size: 13px; color: var(--text-secondary);">Provider will respond within 24 business hours (Mon-Fri, 8 AM - 5 PM CST).</div></div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex-shrink: 0; width: 24px; height: 24px; background: var(--accent-amber); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-void); font-weight: 700; font-size: 12px;">3</div>
                        <div><div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Quality Assurance</div><div style="font-size: 13px; color: var(--text-secondary);">All deliverables undergo comprehensive testing across major browsers and devices.</div></div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex-shrink: 0; width: 24px; height: 24px; background: var(--accent-amber); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-void); font-weight: 700; font-size: 12px;">4</div>
                        <div><div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Post-Launch Support</div><div style="font-size: 13px; color: var(--text-secondary);">Free priority support period begins immediately after launch.</div></div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 32px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Detailed Project Timeline</div>
                ${phasesHtml}
            </div>
            
            ${maintenanceHtml}
            
            <div style="background: var(--bg-tertiary); padding: 20px; border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 24px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 12px;">Client Responsibilities</div>
                <ul style="margin: 12px 0 0 20px; padding: 0; font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                    <li style="margin-bottom: 8px;">Provide all required content within 3 business days of request</li>
                    <li style="margin-bottom: 8px;">Respond to design/development reviews within 5 business days</li>
                    <li style="margin-bottom: 8px;">Attend scheduled bi-weekly progress meetings during draft phase</li>
                    <li style="margin-bottom: 8px;">Designate a single point of contact for project communications</li>
                    <li style="margin-bottom: 8px;">Make payments according to agreed schedule</li>
                    <li style="margin-bottom: 8px;">Provide access to necessary accounts, hosting, and domain credentials</li>
                </ul>
            </div>
            
            <div style="background: var(--bg-hover); padding: 20px; border: 1px solid var(--border-subtle); border-radius: var(--radius-md); border-left: 4px solid var(--accent-amber); margin-bottom: 24px;">
                <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--accent-amber); margin-bottom: 8px;">Governing Law</div>
                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.7;">
                    This Agreement shall be governed by the laws of the State of Texas. Any disputes shall be resolved in Texas state or federal courts.
                </div>
            </div>
            
            ${timeline.notes ? '<div style="margin-top: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-md); border-left: 3px solid var(--accent-amber);"><div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">Additional Notes</div><div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">' + timeline.notes + '</div></div>' : ''}
            
            <div style="background: rgba(245,158,11,0.1); border: 2px solid var(--accent-amber); padding: 20px; border-radius: var(--radius-md); text-align: center; margin-top: 32px;">
                <div style="font-size: 14px; font-weight: 700; color: var(--accent-amber); margin-bottom: 8px;"> Client Signature Required</div>
                <div style="font-size: 13px; color: var(--text-secondary);">Please sign and date this SLA in the Client section above. This document becomes legally binding once both parties have signed.</div>
            </div>
        </div>
    `;
}
// View saved project timeline
function viewProjectTimeline(index) {
const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
const timeline = savedTimelines[index];
if (!timeline) {
    showToast('Timeline not found', 'error');
    return;
}

window.currentTimelineIndex = index;
openTimelinePreviewModal(timeline);
}

function getPaymentTermsText(timeline) {
    if (timeline.isFreeProject) {
        return 'No Payment Required';
    }
    
    switch (timeline.paymentTerms) {
        case 'completion':
            return '100% Due Upon Completion';
        case 'net30':
            return 'Net 30 Days After Completion';
        case 'net15':
            return 'Net 15 Days After Completion';
        case 'milestone':
            return 'Milestone-Based Payments';
        case 'custom':
            return timeline.customPaymentDetails || 'Custom Payment Plan';
        default:
            return '100% Due Upon Completion';
    }
}

// Delete project timeline
function deleteProjectTimeline(index) {
if (!confirm('Are you sure you want to delete this project timeline?')) return;
const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
savedTimelines.splice(index, 1);
localStorage.setItem('projectTimelines', JSON.stringify(savedTimelines));

showToast('Timeline deleted successfully', 'success');
renderSection('projects');
}
// Export project timeline
function exportProjectTimeline(index) {
const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
const timeline = savedTimelines[index];
if (!timeline) {
    showToast('Timeline not found', 'error');
    return;
}

window.currentTimelinePreview = timeline;
exportTimelineAsPDF();
}
function exportTimelineAsPDF() {
    const timeline = window.currentTimelinePreview;
    if (!timeline) {
        showToast('No timeline to export', 'error');
        return;
    }
    
    closeDetailModal();
    
    setTimeout(function() {
        let totalPrice = 0;
        let hasPaidPackage = false;
        
        timeline.packages.forEach(function(key) {
            if (servicePackages[key] && !servicePackages[key].isFree) {
                hasPaidPackage = true;
                totalPrice += servicePackages[key].price;
            }
        });
        
        const companySignatureDate = formatDate(timeline.createdAt);
        const documentId = 'SLA-' + new Date(timeline.createdAt).getFullYear() + '-' + String(Date.now()).slice(-6);
        
        // Get longest support period
        let longestSupportPeriod = 0;
        timeline.packages.forEach(key => {
            if (key === 'starter-website') longestSupportPeriod = Math.max(longestSupportPeriod, 90);
            if (key === 'professional-website') longestSupportPeriod = Math.max(longestSupportPeriod, 120);
            if (key === 'enterprise-website') longestSupportPeriod = Math.max(longestSupportPeriod, 365);
        });
        
        // Build packages HTML
        let packagesListHtml = '';
        timeline.packages.forEach(function(key) {
            if (servicePackages[key]) {
                const pkg = servicePackages[key];
                packagesListHtml += '<div style="display: inline-block; background: #f8f9fa; border: 1px solid #22c55e; color: #000; padding: 6px 14px; border-radius: 4px; font-size: 11px; font-weight: 600; margin: 0 8px 8px 0;">' + pkg.name + (pkg.isFree ? ' <span style="color: #22c55e;">(FREE)</span>' : '') + '</div>';
            }
        });
        
        // Build standardized phases
        let standardPhasesHtml = '<div style="margin-bottom: 40px;">' +
            '<div style="font-size: 13px; font-weight: 700; color: #22c55e; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #22c55e;">WEBSITE DEVELOPMENT PROCESS</div>';

        standardWebsitePhases.forEach(function(phase, index) {
            standardPhasesHtml += '<div style="margin-bottom: 24px; background: #f8f9fa; padding: 20px; border-left: 4px solid #22c55e; border-radius: 4px;">';
            standardPhasesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
            standardPhasesHtml += '<div style="display: flex; align-items: center; gap: 10px;">';
            standardPhasesHtml += '<span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #22c55e; color: white; border-radius: 50%; font-size: 13px; font-weight: 700;">' + (index + 1) + '</span>';
            standardPhasesHtml += '<span style="font-size: 15px; font-weight: 700; color: #000;">' + phase.name + '</span></div>';
            standardPhasesHtml += '<span style="font-size: 12px; color: #666; background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd;">' + phase.duration + '</span></div>';
            standardPhasesHtml += '<ul style="list-style: none; padding: 0; margin: 12px 0 0 0;">';
            
            phase.tasks.forEach(function(task) {
                standardPhasesHtml += '<li style="padding: 8px 0; padding-left: 28px; position: relative; font-size: 12px; color: #333; line-height: 1.6;">';
                standardPhasesHtml += '<span style="position: absolute; left: 8px; top: 8px; color: #22c55e; font-weight: bold;"></span>';
                standardPhasesHtml += task + '</li>';
            });
            
            standardPhasesHtml += '</ul></div>';
        });

        standardPhasesHtml += '</div>';
        
        // Build detailed phases HTML
        let phasesHtml = '';
        let phaseNumber = 1;
        timeline.packages.forEach(function(packageKey) {
            const pkg = servicePackages[packageKey];
            if (!pkg) return;
            
            phasesHtml += '<div style="margin-bottom: 30px; background: white; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden;">';
            phasesHtml += '<div style="background: #22c55e; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;">';
            phasesHtml += '<div><div style="font-size: 16px; font-weight: 700;">' + pkg.name + '</div>';
            phasesHtml += '<div style="font-size: 12px; opacity: 0.95; margin-top: 2px;">' + pkg.description + '</div></div>';
            phasesHtml += '<div style="text-align: right;"><div style="font-size: 10px; text-transform: uppercase; opacity: 0.9;">Duration</div>';
            phasesHtml += '<div style="font-size: 14px; font-weight: 700;">' + pkg.duration + '</div></div></div>';
            
            phasesHtml += '<div style="padding: 20px;">';
            
            if (pkg.phases) {
                pkg.phases.forEach(function(phase) {
                    phasesHtml += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                    phasesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
                    phasesHtml += '<div><span style="display: inline-block; background: #000; color: white; padding: 4px 10px; border-radius: 3px; font-size: 10px; font-weight: 700; margin-right: 8px;">PHASE ' + phaseNumber + '</span>';
                    phasesHtml += '<span style="font-size: 14px; font-weight: 600; color: #000;">' + phase.name + '</span></div>';
                    phasesHtml += '<span style="font-size: 11px; color: #666; background: #f8f9fa; padding: 4px 10px; border-radius: 3px;">' + phase.duration + '</span></div>';
                    phasesHtml += '<ul style="list-style: none; padding: 0; margin: 0;">';
                    
                    phase.tasks.forEach(function(task) {
                        phasesHtml += '<li style="padding: 6px 0; padding-left: 24px; position: relative; font-size: 12px; color: #444; line-height: 1.5;">';
                        phasesHtml += '<span style="position: absolute; left: 4px; top: 6px; color: #22c55e; font-weight: bold;"></span>';
                        phasesHtml += task + '</li>';
                    });
                    
                    phasesHtml += '</ul></div>';
                    phaseNumber++;
                });
            }
            
            // Features list
            if (pkg.features) {
                phasesHtml += '<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #f0f0f0;">';
                phasesHtml += '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #22c55e; margin-bottom: 12px;">INCLUDED FEATURES</div>';
                phasesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
                pkg.features.forEach(function(feature) {
                    phasesHtml += '<span style="background: #f8f9fa; color: #333; padding: 4px 10px; border-radius: 3px; font-size: 10px; border: 1px solid #e0e0e0;">' + feature + '</span>';
                });
                phasesHtml += '</div></div>';
            }
            
            phasesHtml += '</div></div>';
        });
        
        // Payment terms
        let paymentTermsHtml = '';
        if (timeline.isFreeProject || !hasPaidPackage) {
            paymentTermsHtml = 'No Payment Required';
        } else {
            switch (timeline.paymentTerms) {
                case 'completion':
                    paymentTermsHtml = '50% Deposit + 50% on Completion';
                    break;
                case 'net30':
                    paymentTermsHtml = '50% Deposit + 50% Net 30';
                    break;
                case 'net15':
                    paymentTermsHtml = '50% Deposit + 50% Net 15';
                    break;
                case 'milestone':
                    paymentTermsHtml = 'Milestone-Based Payments';
                    break;
                case 'custom':
                    paymentTermsHtml = timeline.customPaymentDetails || 'Custom Payment Plan';
                    break;
                default:
                    paymentTermsHtml = '50% Deposit + 50% on Completion';
            }
        }
        
        // Maintenance section
        let maintenanceHtml = '';
        if (timeline.maintenanceIncluded && timeline.maintenanceIncluded !== 'no') {
            maintenanceHtml = '<div style="background: #f8f9fa; padding: 20px; border: 1px solid #e0e0e0; border-left: 4px solid #22c55e; border-radius: 4px; margin-bottom: 30px;">';
            maintenanceHtml += '<div style="font-size: 13px; font-weight: 700; color: #22c55e; margin-bottom: 12px; text-transform: uppercase;">Maintenance & Support Terms</div>';
            
            if (timeline.maintenanceIncluded === 'free') {
                maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: #000; margin-bottom: 10px;"> FREE Maintenance';
                if (longestSupportPeriod > 0) {
                    maintenanceHtml += ' During ' + longestSupportPeriod + '-Day Support Period';
                }
                maintenanceHtml += '</div>';
            } else if (timeline.maintenanceIncluded === 'paid') {
                maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: #000; margin-bottom: 10px;">Monthly Maintenance: $' + parseFloat(timeline.maintenanceFee || 59.99).toFixed(2) + '/month';
                if (longestSupportPeriod > 0) {
                    maintenanceHtml += ' (After ' + longestSupportPeriod + '-Day Free Period)';
                }
                maintenanceHtml += '</div>';
            }
            
            maintenanceHtml += '<div style="font-size: 12px; color: #444; line-height: 1.6;">';
            if (timeline.maintenanceDetails) {
                maintenanceHtml += timeline.maintenanceDetails;
            } else {
                maintenanceHtml += 'Includes: Bug fixes, security updates, minor content modifications (up to 2 hours/month), plugin updates, uptime monitoring, and priority support.';
            }
            maintenanceHtml += '</div></div>';
        } else if (longestSupportPeriod > 0) {
            maintenanceHtml = '<div style="background: #f8f9fa; padding: 20px; border: 1px solid #e0e0e0; border-left: 4px solid #22c55e; border-radius: 4px; margin-bottom: 30px;">';
            maintenanceHtml += '<div style="font-size: 13px; font-weight: 700; color: #22c55e; margin-bottom: 12px; text-transform: uppercase;">Post-Launch Support</div>';
            maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: #000; margin-bottom: 10px;">' + longestSupportPeriod + ' Days of FREE Priority Support Included</div>';
            maintenanceHtml += '<div style="font-size: 12px; color: #444; line-height: 1.6;">Following project launch, you will receive ' + longestSupportPeriod + ' days of free priority support including bug fixes, technical assistance, and minor adjustments.</div></div>';
        }
        
        // Scope section
        let scopeHtml = '';
        if (timeline.scope) {
            scopeHtml = '<div style="background: #f8f9fa; padding: 18px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 30px;">';
            scopeHtml += '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #22c55e; margin-bottom: 8px;">Project Scope / Special Requirements</div>';
            scopeHtml += '<p style="font-size: 12px; color: #444; margin: 0; line-height: 1.6;">' + timeline.scope + '</p></div>';
        }
        
        const printWindow = window.open('', '_blank', 'width=900,height=700');
        
        if (!printWindow) {
            showToast('Please allow popups to export', 'error');
            return;
        }
        
        const htmlContent = '<!DOCTYPE html>' +
        '<html>' +
        '<head>' +
            '<title>SLA - ' + timeline.clientName + '</title>' +
            '<style>' +
                '* { margin: 0; padding: 0; box-sizing: border-box; }' +
                'body { font-family: "Segoe UI", Arial, sans-serif; background: #ffffff; color: #000; line-height: 1.5; }' +
                '.container { max-width: 900px; margin: 0 auto; }' +
                '.page { background: white; padding: 50px; }' +
                '@media print { body { margin: 0; } .page { padding: 40px; page-break-inside: avoid; } }' +
            '</style>' +
        '</head>' +
        '<body>' +
            '<div class="container">' +
                '<div class="page">' +
                    // HEADER WITH GREEN BAR
                    '<div style="background: #22c55e; padding: 30px 40px; margin: -50px -50px 40px -50px; border-radius: 0;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                            '<div>' +
                                '<div style="font-size: 32px; font-weight: 800; color: white; letter-spacing: -0.5px; margin-bottom: 4px;">DIAMONDBACK CODING</div>' +
                                '<div style="font-size: 12px; color: rgba(255,255,255,0.95); font-weight: 500; letter-spacing: 1px;">PREMIUM DEVELOPMENT SERVICES</div>' +
                            '</div>' +
                            '<div style="text-align: right;">' +
                                '<div style="font-size: 11px; color: rgba(255,255,255,0.9); font-weight: 600; margin-bottom: 4px;">DOCUMENT ID</div>' +
                                '<div style="font-size: 13px; color: white; font-weight: 700; font-family: monospace;">' + documentId + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    // TITLE
                    '<div style="text-align: center; margin-bottom: 40px;">' +
                        '<div style="font-size: 28px; font-weight: 800; color: #000; margin-bottom: 8px; letter-spacing: -0.5px;">SERVICE LEVEL AGREEMENT</div>' +
                        '<div style="font-size: 13px; color: #666; font-weight: 500;">Project Timeline & Terms of Service</div>' +
                    '</div>' +
                    
                    // AGREEMENT OVERVIEW
                    '<div style="background: #f8f9fa; padding: 24px; border-left: 4px solid #22c55e; border-radius: 4px; margin-bottom: 40px;">' +
                        '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #22c55e; margin-bottom: 12px;">Agreement Overview</div>' +
                        '<div style="font-size: 12px; color: #444; line-height: 1.7;">This Service Level Agreement ("Agreement") is entered into as of <strong>' + companySignatureDate + '</strong> by and between <strong>Diamondback Coding</strong> ("Provider"), a Texas-based web development company, and <strong>' + timeline.clientName + (timeline.clientCompany ? ' / ' + timeline.clientCompany : '') + '</strong> ("Client").</div>' +
                    '</div>' +
                    
                    // PARTIES (TWO COLUMNS)
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">' +
                        // PROVIDER
                        '<div style="background: white; border: 2px solid #e0e0e0; border-radius: 4px; padding: 24px;">' +
                            '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #22c55e; margin-bottom: 12px;">Service Provider</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #000; margin-bottom: 8px;">Diamondback Coding</div>' +
                            '<div style="font-size: 11px; color: #666; line-height: 1.6; margin-bottom: 16px;">' +
                                '15709 Spillman Ranch Loop<br>' +
                                'Austin, TX 78738<br>' +
                                'diamondbackcoding@gmail.com<br>' +
                                '(940) 217-8680' +
                            '</div>' +
                            '<div style="background: #f8f9fa; padding: 16px; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                '<div style="font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 8px;">Authorized Signature</div>' +
                                '<div style="font-family: Brush Script MT, cursive; font-size: 28px; color: #22c55e; margin-bottom: 4px; line-height: 1;">Diamondback Coding</div>' +
                                '<div style="height: 1px; background: #22c55e; margin: 8px 0;"></div>' +
                                '<div style="font-size: 10px; color: #666;">Date: ' + companySignatureDate + '</div>' +
                                '<div style="font-size: 9px; color: #999; margin-top: 4px;">Digitally Authorized Representative</div>' +
                            '</div>' +
                        '</div>' +
                        
                        // CLIENT
                        '<div style="background: white; border: 2px solid #e0e0e0; border-radius: 4px; padding: 24px;">' +
                            '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #22c55e; margin-bottom: 12px;">Client</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #000; margin-bottom: 8px;">' + timeline.clientName + '</div>' +
                            '<div style="font-size: 11px; color: #666; line-height: 1.6; margin-bottom: 16px;">' +
                                (timeline.clientCompany ? timeline.clientCompany + '<br>' : '') +
                                (timeline.clientEmail || '') + (timeline.clientPhone || timeline.clientAddress ? '<br>' : '') +
                                (timeline.clientPhone || '') + (timeline.clientAddress ? '<br>' : '') +
                                (timeline.clientAddress ? timeline.clientAddress.replace(/\n/g, '<br>') : '') +
                            '</div>' +
                            '<div style="background: white; padding: 16px; border-radius: 4px; border: 2px dashed #22c55e;">' +
                                '<div style="font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 8px;">Client Signature Required</div>' +
                                '<div style="height: 50px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>' +
                                '<div style="font-size: 10px; color: #666;">Date: _______________</div>' +
                                '<div style="font-size: 9px; color: #999; margin-top: 8px; line-height: 1.4;">By signing, Client agrees to all terms, timelines, and pricing outlined in this SLA.</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    // PROJECT DETAILS (4 BOXES)
                    '<div style="margin-bottom: 40px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #22c55e; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #22c55e;">PROJECT DETAILS</div>' +
                        '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">' +
                            '<div style="background: #f8f9fa; padding: 18px; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #666; margin-bottom: 6px;">Project Name</div>' +
                                '<div style="font-size: 15px; font-weight: 700; color: #000;">' + (timeline.projectName || 'Web Development Project') + '</div>' +
                            '</div>' +
                            '<div style="background: #f8f9fa; padding: 18px; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #666; margin-bottom: 6px;">Start Date</div>' +
                                '<div style="font-size: 15px; font-weight: 700; color: #000; font-family: monospace;">' + formatDate(timeline.startDate) + '</div>' +
                            '</div>' +
                            '<div style="background: #22c55e; padding: 18px; border-radius: 4px;">' +
                                '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.9); margin-bottom: 6px;">Total Investment</div>' +
                                '<div style="font-size: 22px; font-weight: 800; color: white; font-family: monospace;">' + (timeline.isFreeProject ? 'FREE' : '$' + totalPrice.toLocaleString()) + '</div>' +
                            '</div>' +
                            '<div style="background: #000; padding: 18px; border-radius: 4px;">' +
                                '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.7); margin-bottom: 6px;">Payment Terms</div>' +
                                '<div style="font-size: 13px; font-weight: 700; color: white; line-height: 1.3;">' + paymentTermsHtml + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    // SELECTED SERVICES
                    '<div style="margin-bottom: 40px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #22c55e; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #22c55e;">SELECTED SERVICES</div>' +
                        '<div>' + packagesListHtml + '</div>' +
                    '</div>' +
                    
                    scopeHtml +
                    
                    // STANDARDIZED PHASES
                    standardPhasesHtml +
                    
                    // SERVICE LEVEL COMMITMENTS
                    '<div style="margin-bottom: 40px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #22c55e; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #22c55e;">SERVICE LEVEL COMMITMENTS</div>' +
                        '<div style="display: grid; gap: 16px;">' +
                            '<div style="display: flex; gap: 12px; align-items: start;">' +
                                '<div style="flex-shrink: 0; width: 32px; height: 32px; background: #22c55e; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">1</div>' +
                                '<div><div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 4px;">Timeline Adherence</div><div style="font-size: 12px; color: #666; line-height: 1.5;">Provider commits to delivering all project phases within specified timeframes, subject to timely Client feedback and approval.</div></div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 12px; align-items: start;">' +
                                '<div style="flex-shrink: 0; width: 32px; height: 32px; background: #22c55e; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">2</div>' +
                                '<div><div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 4px;">Communication Response Time</div><div style="font-size: 12px; color: #666; line-height: 1.5;">Provider will respond to Client inquiries within 24 business hours during regular business hours (Mon-Fri, 8 AM - 5 PM CST).</div></div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 12px; align-items: start;">' +
                                '<div style="flex-shrink: 0; width: 32px; height: 32px; background: #22c55e; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">3</div>' +
                                '<div><div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 4px;">Quality Assurance</div><div style="font-size: 12px; color: #666; line-height: 1.5;">All deliverables undergo comprehensive testing across major browsers and devices before client review.</div></div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 12px; align-items: start;">' +
                                '<div style="flex-shrink: 0; width: 32px; height: 32px; background: #22c55e; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">4</div>' +
                                '<div><div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 4px;">Post-Launch Support</div><div style="font-size: 12px; color: #666; line-height: 1.5;">Free priority support period begins immediately after launch (duration specified in selected package).</div></div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    // DETAILED TIMELINE
                    '<div style="margin-bottom: 40px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #22c55e; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #22c55e;">DETAILED PROJECT TIMELINE</div>' +
                        phasesHtml +
                    '</div>' +
                    
                    maintenanceHtml +
                    
                    // CLIENT RESPONSIBILITIES
                    '<div style="background: #f8f9fa; padding: 24px; border: 1px solid #e0e0e0; border-left: 4px solid #000; border-radius: 4px; margin-bottom: 30px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 16px; text-transform: uppercase;">Client Responsibilities</div>' +
                        '<ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #444; line-height: 1.8;">' +
                            '<li style="margin-bottom: 8px;">Provide all required content, images, and materials within 3 business days of request</li>' +
                            '<li style="margin-bottom: 8px;">Respond to design/development reviews within 5 business days</li>' +
                            '<li style="margin-bottom: 8px;">Attend scheduled bi-weekly progress meetings during draft phase</li>' +
                            '<li style="margin-bottom: 8px;">Designate a single point of contact for project communications</li>' +
                            '<li style="margin-bottom: 8px;">Make payments according to the agreed schedule</li>' +
                            '<li style="margin-bottom: 8px;">Provide access to necessary accounts, hosting, and domain credentials</li>' +
                            '<li>Notify Provider immediately of any changes to project scope or requirements</li>' +
                        '</ul>' +
                    '</div>' +
                    
                    // GOVERNING LAW
                    '<div style="background: #fff; padding: 20px; border: 2px solid #e0e0e0; border-radius: 4px; margin-bottom: 30px;">' +
                        '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #22c55e; margin-bottom: 8px;">Governing Law</div>' +
                        '<div style="font-size: 11px; color: #666; line-height: 1.6;">This Agreement shall be governed by and construed in accordance with the laws of the State of Texas, without regard to its conflict of law provisions. Any disputes arising from this Agreement shall be resolved in the state or federal courts located in Texas.</div>' +
                    '</div>' +
                    
                    (timeline.notes ? '<div style="background: #f8f9fa; padding: 20px; border: 1px solid #e0e0e0; border-left: 4px solid #22c55e; border-radius: 4px; margin-bottom: 30px;"><div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #22c55e; margin-bottom: 8px;">Additional Notes</div><div style="font-size: 12px; color: #444; line-height: 1.6;">' + timeline.notes + '</div></div>' : '') +
                    
                    // SIGNATURE REMINDER
                    '<div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 24px; border-radius: 4px; text-align: center; margin-bottom: 40px;">' +
                        '<div style="font-size: 15px; font-weight: 700; margin-bottom: 8px;"> CLIENT SIGNATURE REQUIRED</div>' +
                        '<div style="font-size: 12px; opacity: 0.95; line-height: 1.5;">Please sign and date this SLA in the Client section above. This document becomes legally binding once both parties have signed.</div>' +
                    '</div>' +
                    
                    // FOOTER
                    '<div style="text-align: center; padding-top: 30px; border-top: 2px solid #e0e0e0;">' +
                        '<div style="font-size: 12px; color: #666; margin-bottom: 6px;">Questions about this SLA?</div>' +
                        '<div style="font-size: 11px; color: #999; margin-bottom: 12px;">Contact us at diamondbackcoding@gmail.com or (940) 217-8680</div>' +
                        '<div style="font-size: 10px; color: #bbb;">Document ID: ' + documentId + '  Generated: ' + companySignatureDate + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>' +
        '</body>' +
        '</html>';
        
        printWindow.document.write(htmlContent);
        printWindow.document.close();
    }, 300);
}
// Filter project timelines
function filterProjectTimelines(query) {
    const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
    let filtered;
    if (query) {
        filtered = savedTimelines.filter(function(t) {
            return t.clientName.toLowerCase().indexOf(query.toLowerCase()) !== -1 ||
                (t.clientCompany && t.clientCompany.toLowerCase().indexOf(query.toLowerCase()) !== -1) ||
                (t.projectName && t.projectName.toLowerCase().indexOf(query.toLowerCase()) !== -1);
        });
    } else {
        filtered = savedTimelines;
    }
    renderProjectsList(filtered, savedTimelines);
}
function renderProjectsList(filtered, allTimelines) {
    const grid = document.getElementById('projectTimelinesGrid');
    if (filtered.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1 / -1;"><div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><div class="empty-title">No Results Found</div><div class="empty-description">Try adjusting your search terms</div></div></div>';
        return;
    }

    let html = '';
    filtered.forEach(function(timeline) {
        const originalIndex = allTimelines.findIndex(function(t) { return t.createdAt === timeline.createdAt; });
        let packagesHtml = '';
        timeline.packages.forEach(function(pkg) {
            const pkgName = servicePackages[pkg] ? servicePackages[pkg].name : pkg;
            packagesHtml += '<span style="display: inline-block; background: var(--accent-amber-dim); color: var(--accent-amber); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 6px; margin-bottom: 6px;">' + pkgName + '</span>';
        });
        
        html += '<div class="card" style="cursor: pointer;" onclick="viewProjectTimeline(' + originalIndex + ')">' +
            '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">' +
                '<div>' +
                    '<div style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">' + timeline.clientName + '</div>' +
                    '<div style="font-size: 13px; color: var(--text-muted);">' + (timeline.clientCompany || 'No company') + '</div>' +
                '</div>' +
                '<span class="status-badge status-' + (timeline.status || 'pending') + '">' +
                    '<span class="status-dot"></span>' +
                    (timeline.status || 'Draft') +
                '</span>' +
            '</div>' +
            '<div style="margin-bottom: 16px;">' + packagesHtml + '</div>' +
            '<div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-subtle);">' +
                '<div style="font-size: 12px; color: var(--text-muted);">Created: ' + formatDate(timeline.createdAt) + '</div>' +
                '<div style="display: flex; gap: 8px;">' +
                    '<button class="table-action-btn" onclick="event.stopPropagation(); exportProjectTimeline(' + originalIndex + ')" title="Export">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>' +
                    '</button>' +
                    '<button class="table-action-btn danger" onclick="event.stopPropagation(); deleteProjectTimeline(' + originalIndex + ')" title="Delete">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>' +
                    '</button>' +
                '</div>' +
            '</div>' +
        '</div>';
    });
    
    grid.innerHTML = html;
}

</script>
</body>
</html>