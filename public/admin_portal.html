<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamondback Coding | Admin Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
:root {
    --bg-void: #050506;
    --bg-primary: #0a0a0c;
    --bg-secondary: #101014;
    --bg-tertiary: #16161b;
    --bg-elevated: #1c1c22;
    --bg-hover: #222229;
    --border-subtle: rgba(255,255,255,0.04);
    --border-default: rgba(255,255,255,0.08);
    --border-strong: rgba(255,255,255,0.12);
    --text-primary: #f4f4f5;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --text-faint: #52525b;
--accent-amber: #22c55e;
--accent-amber-dim: rgba(34,197,94,0.12);
--accent-amber-glow: rgba(34,197,94,0.25);
--accent-copper: #16a34a;
--accent-rust: #15803d;
    --status-new: #3b82f6;
    --status-pending: #f59e0b;
    --status-contacted: #10b981;
    --status-closed: #8b5cf6;
    --status-lost: #ef4444;
    --status-draft: #71717a;
    --status-sent: #3b82f6;
    --status-paid: #10b981;
    --status-overdue: #ef4444;
    --priority-high: #ef4444;
    --priority-medium: #f59e0b;
    --priority-low: #71717a;
    --font-display: 'Outfit', -apple-system, sans-serif;
    --font-mono: 'Space Mono', monospace;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 20px;
    --shadow-glow: 0 0 60px rgba(245,158,11,0.08);
    --shadow-lg: 0 12px 40px rgba(0,0,0,0.5);
    --sidebar-width: 280px;
    --topbar-height: 72px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
    font-family: var(--font-display);
    background: var(--bg-void);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { 
    background: var(--border-strong); 
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: padding-box;
}
::-webkit-scrollbar-thumb:hover { background: var(--accent-amber); background-clip: padding-box; }

/* ========================================
   SIDEBAR
======================================== */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: var(--sidebar-width);
    height: 100vh;
    background: var(--bg-primary);
    border-right: 1px solid var(--border-subtle);
    display: flex;
    flex-direction: column;
    z-index: 100;
    overflow: hidden;
}

.sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 1px;
    height: 100%;
    background: linear-gradient(180deg, var(--accent-amber) 0%, transparent 50%, var(--accent-amber) 100%);
    opacity: 0.3;
}

.sidebar-header {
    padding: 28px 24px;
    border-bottom: 1px solid var(--border-subtle);
    position: relative;
}

.logo {
    display: flex;
    align-items: center;
    gap: 14px;
}

.logo-mark {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-rust) 100%);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 4px 20px rgba(245,158,11,0.3);
}

.logo-mark::before {
    content: '';
    position: absolute;
    inset: -2px;
    background: linear-gradient(135deg, var(--accent-amber), transparent);
    border-radius: var(--radius-md);
    opacity: 0.5;
    z-index: -1;
}

.logo-mark svg {
    width: 24px;
    height: 24px;
    color: var(--bg-void);
}

.logo-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.logo-title {
    font-weight: 800;
    font-size: 17px;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-amber) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.logo-subtitle {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--text-muted);
}

.sidebar-nav {
    flex: 1;
    padding: 20px 16px;
    overflow-y: auto;
}

.nav-section {
    margin-bottom: 28px;
}

.nav-section-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-faint);
    padding: 0 12px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nav-section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border-subtle), transparent);
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    position: relative;
    margin-bottom: 4px;
}

.nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
    transform: translateX(4px);
}

.nav-item.active {
    background: var(--accent-amber-dim);
    color: var(--accent-amber);
    box-shadow: inset 0 0 0 1px var(--accent-amber-dim);
}

.nav-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 24px;
    background: var(--accent-amber);
    border-radius: 0 3px 3px 0;
    box-shadow: 0 0 12px var(--accent-amber);
}

.nav-icon {
    width: 18px;
    height: 18px;
    opacity: 0.7;
    flex-shrink: 0;
}

.nav-item.active .nav-icon { opacity: 1; }

.nav-badge {
    margin-left: auto;
    background: var(--accent-amber);
    color: var(--bg-void);
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 12px;
    min-width: 22px;
    text-align: center;
    font-family: var(--font-mono);
}

.sidebar-footer {
    padding: 20px;
    border-top: 1px solid var(--border-subtle);
    background: linear-gradient(180deg, transparent 0%, var(--bg-secondary) 100%);
}

.user-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid var(--border-subtle);
}

.user-card:hover {
    background: var(--bg-hover);
    border-color: var(--border-default);
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-rust) 100%);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: var(--bg-void);
}

.user-info { flex: 1; min-width: 0; }

.user-name {
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-role {
    font-size: 11px;
    color: var(--text-muted);
}

.logout-icon {
    width: 18px;
    height: 18px;
    color: var(--text-muted);
    transition: color 0.2s ease;
}

.user-card:hover .logout-icon { color: var(--status-lost); }

/* ========================================
   MAIN CONTENT
======================================== */
.main-content {
    margin-left: var(--sidebar-width);
    min-height: 100vh;
    background: var(--bg-void);
}

.topbar {
    position: sticky;
    top: 0;
    height: var(--topbar-height);
    background: rgba(5,5,6,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 36px;
    z-index: 50;
}

.page-header {
    display: flex;
    align-items: center;
    gap: 16px;
}

.page-title {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-title::before {
    content: '';
    width: 4px;
    height: 24px;
    background: var(--accent-amber);
    border-radius: 2px;
    box-shadow: 0 0 12px var(--accent-amber);
}

.topbar-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ========================================
   BUTTONS
======================================== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 11px 20px;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    white-space: nowrap;
    position: relative;
    overflow: hidden;
}

.btn svg { width: 16px; height: 16px; }

.btn-primary {
    background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-copper) 100%);
    color: var(--bg-void);
    box-shadow: 0 4px 16px rgba(245,158,11,0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(245,158,11,0.4);
}

.btn-primary:active { transform: translateY(0); }

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-default);
}

.btn-secondary:hover {
    background: var(--bg-hover);
    border-color: var(--border-strong);
    transform: translateY(-1px);
}

.btn-danger {
    background: rgba(239,68,68,0.1);
    color: var(--status-lost);
    border: 1px solid rgba(239,68,68,0.2);
}

.btn-danger:hover {
    background: var(--status-lost);
    color: #fff;
    border-color: var(--status-lost);
}

.btn-success {
    background: rgba(16,185,129,0.1);
    color: var(--status-contacted);
    border: 1px solid rgba(16,185,129,0.2);
}

.btn-success:hover {
    background: var(--status-contacted);
    color: #fff;
    border-color: var(--status-contacted);
}

.btn-sm {
    padding: 8px 14px;
    font-size: 12px;
}

.btn-sm svg { width: 14px; height: 14px; }

.btn-icon {
    width: 40px;
    height: 40px;
    padding: 0;
    border-radius: var(--radius-sm);
}

/* ========================================
   CONTENT AREA
======================================== */
.content {
    padding: 36px;
    max-width: 1600px;
}

/* ========================================
   STATS GRID
======================================== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 36px;
}

.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-amber), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stat-card:hover {
    border-color: var(--border-default);
    transform: translateY(-4px);
    box-shadow: var(--shadow-glow);
}

.stat-card:hover::before { opacity: 1; }

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.stat-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-icon svg { width: 18px; height: 18px; }

.stat-icon.amber { background: var(--accent-amber-dim); color: var(--accent-amber); }
.stat-icon.blue { background: rgba(59,130,246,0.12); color: var(--status-new); }
.stat-icon.green { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.stat-icon.purple { background: rgba(139,92,246,0.12); color: var(--status-closed); }
.stat-icon.red { background: rgba(239,68,68,0.12); color: var(--status-lost); }

.stat-value {
    font-size: 36px;
    font-weight: 800;
    letter-spacing: -0.03em;
    font-family: var(--font-mono);
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-change {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    margin-top: 8px;
    color: var(--text-muted);
}

.stat-change.positive { color: var(--status-contacted); }
.stat-change.negative { color: var(--status-lost); }

/* ========================================
   CONTROLS BAR
======================================== */
.controls-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 300px;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 12px 18px 12px 48px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.search-input:focus {
    outline: none;
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px var(--accent-amber-dim), var(--shadow-glow);
}

.search-input::placeholder { color: var(--text-muted); }

.search-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    width: 18px;
    height: 18px;
    transition: color 0.2s ease;
}

.search-input:focus + .search-icon,
.search-box:focus-within .search-icon { color: var(--accent-amber); }

.filter-group {
    display: flex;
    gap: 4px;
    background: var(--bg-primary);
    padding: 5px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.filter-btn {
    padding: 9px 16px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-btn:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.filter-btn.active {
    background: var(--accent-amber);
    color: var(--bg-void);
}

/* ========================================
   DATA TABLE
======================================== */
.table-container {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: var(--bg-secondary);
}

.data-table th {
    padding: 14px 18px;
    text-align: left;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border-subtle);
    white-space: nowrap;
}

.data-table td {
    padding: 16px 18px;
    font-size: 13px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: middle;
}

.data-table tbody tr {
    transition: all 0.2s ease;
    cursor: pointer;
}

.data-table tbody tr:hover {
    background: var(--bg-hover);
}

.data-table tbody tr:last-child td { border-bottom: none; }

.contact-cell {
    display: flex;
    align-items: center;
    gap: 14px;
}

.contact-avatar {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-hover));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
    flex-shrink: 0;
    border: 1px solid var(--border-subtle);
}

.contact-info { min-width: 0; }

.contact-name {
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-email {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ========================================
   STATUS BADGES
======================================== */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.status-new { background: rgba(59,130,246,0.12); color: var(--status-new); }
.status-new .status-dot { background: var(--status-new); }
.status-pending { background: rgba(245,158,11,0.12); color: var(--status-pending); }
.status-pending .status-dot { background: var(--status-pending); }
.status-contacted { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.status-contacted .status-dot { background: var(--status-contacted); }
.status-closed { background: rgba(139,92,246,0.12); color: var(--status-closed); }
.status-closed .status-dot { background: var(--status-closed); }
.status-lost, .status-churned, .status-cancelled { background: rgba(239,68,68,0.12); color: var(--status-lost); }
.status-lost .status-dot, .status-churned .status-dot, .status-cancelled .status-dot { background: var(--status-lost); }
.status-onboarding { background: rgba(6,182,212,0.12); color: #06b6d4; }
.status-onboarding .status-dot { background: #06b6d4; }
.status-in-progress { background: rgba(59,130,246,0.12); color: var(--status-new); }
.status-in-progress .status-dot { background: var(--status-new); }
.status-review { background: rgba(245,158,11,0.12); color: var(--status-pending); }
.status-review .status-dot { background: var(--status-pending); }
.status-completed { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.status-completed .status-dot { background: var(--status-contacted); }
.status-on-hold { background: rgba(113,113,122,0.12); color: var(--text-muted); }
.status-on-hold .status-dot { background: var(--text-muted); }
.status-draft { background: rgba(113,113,122,0.12); color: var(--status-draft); }
.status-draft .status-dot { background: var(--status-draft); }
.status-sent { background: rgba(59,130,246,0.12); color: var(--status-sent); }
.status-sent .status-dot { background: var(--status-sent); }
.status-paid { background: rgba(16,185,129,0.12); color: var(--status-paid); }
.status-paid .status-dot { background: var(--status-paid); }
.status-overdue { background: rgba(239,68,68,0.12); color: var(--status-overdue); }
.status-overdue .status-dot { background: var(--status-overdue); }

.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
}

.priority-high { background: rgba(239,68,68,0.12); color: var(--priority-high); }
.priority-medium { background: rgba(245,158,11,0.12); color: var(--priority-medium); }
.priority-low { background: rgba(113,113,122,0.12); color: var(--priority-low); }

/* ========================================
   TABLE ACTIONS
======================================== */
.table-actions {
    display: flex;
    gap: 6px;
}

.table-action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
}

.table-action-btn:hover {
    background: var(--bg-hover);
    border-color: var(--border-default);
    color: var(--text-primary);
}

.table-action-btn.danger:hover {
    background: rgba(239,68,68,0.12);
    border-color: var(--status-lost);
    color: var(--status-lost);
}

.table-action-btn svg { width: 14px; height: 14px; }

.table-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-top: 1px solid var(--border-subtle);
    background: var(--bg-secondary);
}

.table-info {
    font-size: 13px;
    color: var(--text-muted);
}

/* ========================================
   EMPTY STATE
======================================== */
.empty-state {
    padding: 80px 24px;
    text-align: center;
}

.empty-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 20px;
    color: var(--text-faint);
    opacity: 0.5;
}

.empty-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.empty-description {
    font-size: 14px;
    color: var(--text-muted);
    max-width: 320px;
    margin: 0 auto;
}

/* ========================================
   MODAL
======================================== */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 200;
    align-items: flex-start;
    justify-content: center;
    padding: 48px 24px;
    overflow-y: auto;
}

.modal-overlay.active { display: flex; }

.modal {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 800px;
    box-shadow: var(--shadow-lg), var(--shadow-glow);
    animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal.wide { max-width: 1100px; }

@keyframes modalSlide {
    from { opacity: 0; transform: translateY(-24px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 28px;
    border-bottom: 1px solid var(--border-subtle);
}

.modal-title {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 12px;
}

.modal-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: var(--accent-amber);
    border-radius: 2px;
}

.modal-close {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-hover);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-default);
}

.modal-body {
    padding: 28px;
    max-height: calc(100vh - 280px);
    overflow-y: auto;
}

.modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 28px;
    border-top: 1px solid var(--border-subtle);
    background: var(--bg-secondary);
    border-radius: 0 0 var(--radius-xl) var(--radius-xl);
}

/* ========================================
   FORM ELEMENTS
======================================== */
.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width { grid-column: 1 / -1; }

.form-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-label .required { color: var(--status-lost); }

.form-input,
.form-select,
.form-textarea {
    padding: 12px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px var(--accent-amber-dim);
}

.form-input::placeholder,
.form-textarea::placeholder { color: var(--text-muted); }

.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 40px;
}

.form-textarea {
    min-height: 120px;
    resize: vertical;
}

/* ========================================
   DETAIL SECTIONS
======================================== */
.detail-section {
    margin-bottom: 28px;
}

.detail-section:last-child { margin-bottom: 0; }

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 18px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-subtle);
}

.section-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent-amber);
}

.section-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border-subtle), transparent);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.detail-item {
    background: var(--bg-tertiary);
    padding: 14px 16px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.detail-item.full-width { grid-column: 1 / -1; }

.detail-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 6px;
}

.detail-value {
    font-size: 14px;
    color: var(--text-primary);
    word-break: break-word;
}

/* ========================================
   NOTES
======================================== */
.notes-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 18px;
    max-height: 320px;
    overflow-y: auto;
}

.note-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-left: 3px solid var(--accent-amber);
    border-radius: var(--radius-md);
    padding: 14px 16px;
}

.note-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.note-author {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
}

.note-date {
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--font-mono);
}

.note-text {
    font-size: 13px;
    color: var(--text-primary);
    line-height: 1.7;
}

.note-empty {
    text-align: center;
    padding: 32px;
    color: var(--text-muted);
    font-size: 14px;
}

/* ========================================
   EXPENSE SECTION
======================================== */
.expense-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 18px;
    max-height: 400px;
    overflow-y: auto;
}

.expense-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.expense-item:hover {
    border-color: var(--border-default);
    background: var(--bg-hover);
}

.expense-item.selected {
    border-color: var(--accent-amber);
    background: var(--accent-amber-dim);
}

.expense-checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid var(--border-strong);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.expense-checkbox:hover { border-color: var(--accent-amber); }

.expense-checkbox.checked {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.expense-checkbox svg {
    width: 14px;
    height: 14px;
    color: var(--bg-void);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.expense-checkbox.checked svg { opacity: 1; }

.expense-content { flex: 1; min-width: 0; }

.expense-description {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.expense-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: var(--text-muted);
}

.expense-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.expense-amount {
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-amber);
    font-family: var(--font-mono);
    white-space: nowrap;
}

.expense-actions {
    display: flex;
    gap: 6px;
}

.expense-empty {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    font-size: 14px;
}

/* ========================================
   INVOICE PREVIEW
======================================== */
.invoice-preview {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.invoice-preview-header {
    padding: 32px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.invoice-company {
    display: flex;
    align-items: center;
    gap: 16px;
}

.invoice-company-logo {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--accent-amber), var(--accent-rust));
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.invoice-company-logo svg {
    width: 28px;
    height: 28px;
    color: var(--bg-void);
}

.invoice-company-name {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.invoice-company-tagline {
    font-size: 12px;
    color: var(--text-muted);
}

.invoice-info {
    text-align: right;
}

.invoice-title {
    font-size: 32px;
    font-weight: 800;
    color: var(--accent-amber);
    letter-spacing: -0.02em;
    margin-bottom: 8px;
}

.invoice-number {
    font-size: 14px;
    color: var(--text-secondary);
    font-family: var(--font-mono);
}

.invoice-preview-body { padding: 32px; }

.invoice-parties {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 32px;
    margin-bottom: 32px;
}

.invoice-party-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 12px;
}

.invoice-party-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.invoice-party-details {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.7;
}

.invoice-dates {
    display: flex;
    gap: 32px;
    margin-bottom: 32px;
}

.invoice-date-item {
    background: var(--bg-tertiary);
    padding: 14px 20px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.invoice-date-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.invoice-date-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.invoice-items-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
}

.invoice-items-table th {
    text-align: left;
    padding: 14px 16px;
    background: var(--bg-tertiary);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-items-table th:last-child { text-align: right; }

.invoice-items-table td {
    padding: 16px;
    font-size: 14px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-items-table td:last-child {
    text-align: right;
    font-family: var(--font-mono);
    font-weight: 600;
}

.invoice-items-table tbody tr:hover { background: var(--bg-hover); }

.invoice-totals {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
}

.invoice-total-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 280px;
    padding: 10px 0;
}

.invoice-total-label {
    font-size: 13px;
    color: var(--text-secondary);
}

.invoice-total-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.invoice-total-row.grand {
    border-top: 2px solid var(--accent-amber);
    margin-top: 8px;
    padding-top: 16px;
}

.invoice-total-row.grand .invoice-total-label {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}

.invoice-total-row.grand .invoice-total-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-amber);
}

.invoice-preview-footer {
    padding: 24px 32px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-subtle);
}

/* Invoice Preview Improvements */
.invoice-preview {
    border-top: 4px solid var(--accent-amber);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.invoice-preview-header {
    padding: 40px 32px;
    background: var(--bg-tertiary);
}

.invoice-company-logo {
    width: 64px;
    height: 64px;
}

.invoice-company-logo svg {
    width: 32px;
    height: 32px;
}

.invoice-number {
    font-size: 16px;
    letter-spacing: 0.05em;
}

.invoice-items-table th {
    font-size: 11px;
    color: var(--accent-amber);
}

.invoice-items-table td {
    font-size: 15px;
}

.invoice-items-table tbody tr:hover {
    background: rgba(245,158,11,0.03);
}

.invoice-totals {
    background: var(--bg-tertiary);
    padding: 24px;
    border-radius: var(--radius-md);
    margin-top: 20px;
    border-top: 2px solid var(--border-subtle);
    padding-top: 24px;
}

.invoice-total-row.grand .invoice-total-value {
    font-size: 32px;
}

.invoice-notes-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.invoice-notes-text {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.7;
}

/* ========================================
   CARDS GRID (Employees/Invoices)
======================================== */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.card:hover {
    border-color: var(--border-default);
    transform: translateY(-4px);
    box-shadow: var(--shadow-glow);
}

.employee-card .card-header {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 20px;
}

.employee-avatar-lg {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, var(--accent-amber), var(--accent-rust));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: var(--bg-void);
    flex-shrink: 0;
}

.employee-details { flex: 1; min-width: 0; }

.employee-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.employee-role {
    font-size: 13px;
    color: var(--accent-amber);
    font-weight: 600;
}

.employee-meta {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.employee-meta-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: var(--text-secondary);
}

.employee-meta-item svg {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
}

.employee-stats {
    display: flex;
    gap: 16px;
    padding-top: 20px;
    border-top: 1px solid var(--border-subtle);
}

.employee-stat {
    flex: 1;
    text-align: center;
}

.employee-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.employee-stat-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.card-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.card-actions .btn { flex: 1; }

/* ========================================
   INVOICE CARDS
======================================== */
/* Invoice Card Improvements */
.invoice-card {
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.invoice-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--text-primary), var(--text-secondary));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.invoice-card:hover::before {
    opacity: 1;
}

.invoice-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-card-number {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
    letter-spacing: 0.02em;
}

.invoice-card-customer {
    font-size: 14px;
    color: var(--text-secondary);
    margin-top: 6px;
}

.invoice-card-amount {
    font-size: 32px;
    font-weight: 800;
    color: var(--text-primary);
    font-family: var(--font-mono);
    margin-bottom: 20px;
    letter-spacing: -0.02em;
}

.invoice-card-meta {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-subtle);
}

.invoice-card-meta-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
    background: var(--bg-secondary);
    padding: 12px 14px;
    border-radius: var(--radius-sm);
}

.invoice-card-meta-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.invoice-card-meta-value {
    font-size: 14px;
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-weight: 600;
}

.invoice-card:hover .invoice-card-amount {
    color: var(--text-primary);
}

/* ========================================
   ANALYTICS
======================================== */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
}

.analytics-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 28px;
}

.analytics-card.full-width { grid-column: 1 / -1; }

.analytics-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
}

.analytics-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
}

.chart-container {
    height: 220px;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    padding-top: 24px;
}

.chart-bar {
    flex: 1;
    background: linear-gradient(180deg, var(--accent-amber-dim) 0%, rgba(245,158,11,0.05) 100%);
    border-radius: 6px 6px 0 0;
    position: relative;
    min-height: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--accent-amber-dim);
    border-bottom: none;
}

.chart-bar:hover {
    background: linear-gradient(180deg, var(--accent-amber) 0%, var(--accent-amber-dim) 100%);
    border-color: var(--accent-amber);
}

.chart-bar-label {
    position: absolute;
    bottom: -28px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: var(--text-muted);
    white-space: nowrap;
    font-weight: 500;
}

.chart-bar-value {
    position: absolute;
    top: -24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent-amber);
    font-family: var(--font-mono);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.chart-bar:hover .chart-bar-value { opacity: 1; }

.metrics-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.metric-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.metric-label {
    font-size: 13px;
    color: var(--text-secondary);
}

.metric-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.progress-bar {
    height: 8px;
    background: var(--bg-hover);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-amber), var(--accent-rust));
    border-radius: 4px;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ========================================
   SETTINGS
======================================== */
.settings-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 32px;
}

.settings-nav {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.settings-nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
}

.settings-nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.settings-nav-item.active {
    background: var(--accent-amber-dim);
    color: var(--accent-amber);
}

.settings-nav-item svg { width: 18px; height: 18px; }

.settings-panel {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 28px;
}

.settings-section { margin-bottom: 36px; }
.settings-section:last-child { margin-bottom: 0; }

.settings-section-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 6px;
}

.settings-section-desc {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 24px;
}

.setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 0;
    border-bottom: 1px solid var(--border-subtle);
}

.setting-row:last-child { border-bottom: none; }

.setting-info { flex: 1; }

.setting-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.setting-desc {
    font-size: 13px;
    color: var(--text-muted);
}

.toggle {
    position: relative;
    width: 50px;
    height: 28px;
}

.toggle input { opacity: 0; width: 0; height: 0; }

.toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--bg-hover);
    border: 1px solid var(--border-default);
    border-radius: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.toggle-slider::before {
    content: '';
    position: absolute;
    height: 22px;
    width: 22px;
    left: 2px;
    bottom: 2px;
    background: var(--text-secondary);
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.toggle input:checked + .toggle-slider {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.toggle input:checked + .toggle-slider::before {
    transform: translateX(22px);
    background: var(--bg-void);
}

/* ========================================
   TASKS
======================================== */
.tasks-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.task-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 20px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.task-item:hover { border-color: var(--border-default); }

.task-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border-strong);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.task-checkbox:hover { border-color: var(--accent-amber); }

.task-checkbox.checked {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.task-checkbox svg {
    width: 14px;
    height: 14px;
    color: var(--bg-void);
    opacity: 0;
}

.task-checkbox.checked svg { opacity: 1; }

.task-content { flex: 1; min-width: 0; }

.task-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 6px;
}

.task-item.completed .task-title {
    text-decoration: line-through;
    color: var(--text-muted);
}

.task-meta {
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 12px;
    color: var(--text-muted);
}

.task-due {
    display: flex;
    align-items: center;
    gap: 6px;
}

.task-due.overdue { color: var(--status-lost); }

/* ========================================
   TOAST NOTIFICATIONS
======================================== */
.toast-container {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 300;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 20px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    animation: toastSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 320px;
}

@keyframes toastSlide {
    from { opacity: 0; transform: translateX(100%) scale(0.95); }
    to { opacity: 1; transform: translateX(0) scale(1); }
}

.toast-icon {
    width: 22px;
    height: 22px;
    flex-shrink: 0;
}

.toast.success .toast-icon { color: var(--status-contacted); }
.toast.error .toast-icon { color: var(--status-lost); }
.toast.warning .toast-icon { color: var(--status-pending); }

.toast-message {
    font-size: 14px;
    color: var(--text-primary);
    flex: 1;
}

.toast-close {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.toast-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

/* ========================================
   TABS
======================================== */
.tabs {
    display: flex;
    gap: 4px;
    background: var(--bg-primary);
    padding: 5px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
    margin-bottom: 24px;
}

.tab {
    padding: 10px 20px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tab:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.tab.active {
    background: var(--accent-amber);
    color: var(--bg-void);
}

/* ========================================
   RESPONSIVE
======================================== */
@media (max-width: 1200px) {
    .analytics-grid { grid-template-columns: 1fr; }
    .settings-layout { grid-template-columns: 1fr; }
    .settings-nav { flex-direction: row; flex-wrap: wrap; }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    .sidebar.active { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .topbar { padding: 0 20px; }
    .content { padding: 24px; }
    .form-grid,
    .detail-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .controls-bar {
        flex-direction: column;
        align-items: stretch;
    }
    .search-box { min-width: 100%; }
    .invoice-parties { grid-template-columns: 1fr; }
    .modal { margin: 16px; }
}

/* ========================================
   PRINT STYLES (for invoices)
======================================== */
@media print {
    body {
        background: white !important;
        color: black !important;
    }
    .sidebar,
    .topbar,
    .modal-overlay,
    .toast-container,
    .btn { display: none !important; }
    .main-content { margin-left: 0 !important; }
    .invoice-preview {
        background: white !important;
        border: none !important;
        box-shadow: none !important;
    }
}
/* ========================================
   LIGHT MODE OVERRIDES
======================================== */
body.light-mode {
    background: #f5f5f7;
}

body.light-mode .sidebar {
    background: #ffffff;
    border-right-color: rgba(0,0,0,0.08);
}

body.light-mode .sidebar::before {
    background: linear-gradient(180deg, var(--accent-amber) 0%, transparent 50%, var(--accent-amber) 100%);
}

body.light-mode .topbar {
    background: rgba(255,255,255,0.9);
    border-bottom-color: rgba(0,0,0,0.08);
}

body.light-mode .logo-title {
    background: linear-gradient(135deg, #1a1a1a 0%, var(--accent-amber) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

body.light-mode .stat-value {
    background: linear-gradient(135deg, #1a1a1a 0%, #495057 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

body.light-mode .data-table thead {
    background: #f8f9fa;
}

body.light-mode .modal {
    background: #ffffff;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
}

body.light-mode .modal-footer {
    background: #f8f9fa;
}

body.light-mode .invoice-preview {
    background: #ffffff;
}

body.light-mode .invoice-preview-header {
    background: #f8f9fa;
}

body.light-mode .form-input,
body.light-mode .form-select,
body.light-mode .form-textarea {
    background: #ffffff;
    border-color: rgba(0,0,0,0.15);
    color: #1a1a1a;
}

body.light-mode .form-input:focus,
body.light-mode .form-select:focus,
body.light-mode .form-textarea:focus {
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px rgba(245,158,11,0.15);
}

body.light-mode .search-input {
    background: #ffffff;
    border-color: rgba(0,0,0,0.12);
}

body.light-mode .filter-group {
    background: #ffffff;
    border-color: rgba(0,0,0,0.12);
}

body.light-mode .toast {
    background: #ffffff;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

body.light-mode ::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
}

body.light-mode ::-webkit-scrollbar-thumb:hover {
    background: var(--accent-amber);
}
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-mark">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <div class="logo-title">Diamondback Coding</div>
                    <div class="logo-subtitle">Admin Portal</div>
                </div>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <div class="nav-item active" data-section="dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    Dashboard
                </div>
                <div class="nav-item" data-section="analytics">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18 17V9"/>
                        <path d="M13 17V5"/>
                        <path d="M8 17v-3"/>
                    </svg>
                    Analytics
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Pipeline</div>
                <div class="nav-item" data-section="leads">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    All Leads
                    <span class="nav-badge" id="leadsBadge">0</span>
                </div>
                <div class="nav-item" data-section="new">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    New
                    <span class="nav-badge" id="newBadge">0</span>
                </div>
                <div class="nav-item" data-section="pending">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Pending
                    <span class="nav-badge" id="pendingBadge">0</span>
                </div>
                <div class="nav-item" data-section="contacted">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
                    </svg>
                    Contacted
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <div class="nav-item" data-section="customers">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Customers
                    <span class="nav-badge" id="customersBadge">0</span>
                </div>
                <div class="nav-item" data-section="employees">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                    </svg>
                    Team
                </div>
                <div class="nav-item" data-section="invoices">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    Invoices
                    <span class="nav-badge" id="invoicesBadge">0</span>
                </div>
                <div class="nav-item" data-section="tasks">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    Tasks
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <div class="nav-item" data-section="settings">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </div>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-card" onclick="logout()">
                <div class="user-avatar">AD</div>
                <div class="user-info">
                    <div class="user-name">Admin User</div>
                    <div class="user-role">Administrator</div>
                </div>
                <svg class="logout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="topbar">
            <div class="page-header">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="topbar-actions">
                <button class="btn btn-secondary" onclick="openExportModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                </button>
                <button class="btn btn-primary" onclick="openCreateModal('lead')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Lead
                </button>
            </div>
        </header>
        
        <div class="content" id="contentArea">
            <!-- Content will be dynamically loaded -->
        </div>
    </main>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title" id="detailModalTitle">Lead Details</h2>
                <button class="modal-close" onclick="closeDetailModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="detailModalBody"></div>
            <div class="modal-footer" id="detailModalFooter"></div>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="createModalTitle">Create Lead</h2>
                <button class="modal-close" onclick="closeCreateModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="createModalBody"></div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title" id="invoiceModalTitle">Create Invoice</h2>
                <button class="modal-close" onclick="closeInvoiceModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="invoiceModalBody"></div>
            <div class="modal-footer" id="invoiceModalFooter"></div>
        </div>
    </div>

    <!-- Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Record Payment</h2>
            <button class="modal-close" onclick="closePaymentModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body" id="paymentModalBody"></div>
    </div>
</div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
// ========================================
// STATE & CONFIGURATION
// ========================================
const API_URL = window.location.origin;
let authToken = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');

const state = {
    leads: [],
    customers: [],
    employees: [],
    invoices: [],
    tasks: [],
    currentSection: 'dashboard',
    currentFilter: 'all',
    currentLead: null,
    currentInvoice: null,
    selectedExpenses: [],
    searchQuery: '',
    settings: {
        emailNotifications: true,
        pushNotifications: false,
        darkMode: true,
        autoAssign: false,
        weeklyReport: true
    }
};

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', async function() {
    if (!authToken) {
        window.location.href = '/admin';
        return;
    }
    
    try {
        const r = await fetch(`${API_URL}/api/admin/verify`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            localStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminToken');
            window.location.href = '/admin';
            return;
        }
    } catch (e) {
        console.error('Token verification failed:', e);
        window.location.href = '/admin';
        return;
    }
    
    await loadAllData();
loadSettings();  // ADD THIS LINE
setupNavigation();
renderSection('dashboard');
});

// ========================================
// DATA LOADING
// ========================================
async function loadAllData() {
    await Promise.all([
        loadLeads(),
        loadEmployees(),
        loadInvoices(),
        loadTasks()
    ]);
    updateBadges();
}

async function loadLeads() {
    try {
        const r = await fetch(`${API_URL}/api/leads`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (r.status === 401 || r.status === 403) {
            logout();
            return;
        }
        
        const d = await r.json();
        if (d.success) {
            state.leads = (d.leads || []).filter(l => !l.is_customer);
            state.customers = (d.leads || []).filter(l => l.is_customer);
        }
    } catch (e) {
        console.error('Error loading leads:', e);
    }
}

async function loadEmployees() {
    try {
        const r = await fetch(`${API_URL}/api/employees`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            console.error('Failed to load employees, status:', r.status);
            return;
        }
        
        const d = await r.json();
        console.log('Loaded employees:', d); // Debug log
        
        if (d.success) {
            state.employees = d.employees || [];
        }
    } catch (e) {
        console.error('Error loading employees:', e);
    }
}

async function loadInvoices() {
    try {
        const r = await fetch(`${API_URL}/api/invoices`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!r.ok) return;
        const d = await r.json();
        if (d.success) {
            state.invoices = (d.invoices || []).map(inv => {
                // Parse items if they're stored as JSON string
                if (typeof inv.items === 'string') {
                    try {
                        inv.items = JSON.parse(inv.items);
                    } catch (e) {
                        inv.items = [];
                    }
                }
                // Ensure customer name is set
                if (!inv.customer_name && inv.first_name) {
                    inv.customer_name = `${inv.first_name} ${inv.last_name || ''}`.trim();
                }
                if (!inv.customer_name && inv.name) {
                    inv.customer_name = inv.name;
                }
                if (!inv.customer_email && inv.email) {
                    inv.customer_email = inv.email;
                }
                if (!inv.customer_company && inv.company) {
                    inv.customer_company = inv.company;
                }
                return inv;
            });
        }
    } catch (e) {
        console.error('Error loading invoices:', e);
    }
}

async function loadTasks() {
    state.tasks = [
        { id: 1, title: 'Follow up with new leads', dueDate: '2026-01-20', assignee: 'Admin', completed: false, priority: 'high' },
        { id: 2, title: 'Prepare weekly report', dueDate: '2026-01-22', assignee: 'Admin', completed: false, priority: 'medium' },
        { id: 3, title: 'Review contract terms', dueDate: '2026-01-18', assignee: 'Admin', completed: true, priority: 'low' },
        { id: 4, title: 'Schedule team meeting', dueDate: '2026-01-25', assignee: 'Admin', completed: false, priority: 'medium' }
    ];
}

async function loadExpenses(leadId) {
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/expenses?includeInvoiced=false`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!r.ok) return [];
        const d = await r.json();
        return d.success ? d.expenses || [] : [];
    } catch (e) {
        console.error('Error loading expenses:', e);
        return [];
    }
}

function updateBadges() {
    const n = state.leads.filter(l => l.status === 'new').length;
    const p = state.leads.filter(l => l.status === 'pending').length;
    const unpaidInvoices = state.invoices.filter(i => i.status !== 'paid' && i.status !== 'cancelled').length;
    
    document.getElementById('leadsBadge').textContent = state.leads.length;
    document.getElementById('newBadge').textContent = n;
    document.getElementById('pendingBadge').textContent = p;
    document.getElementById('customersBadge').textContent = state.customers.length;
    document.getElementById('invoicesBadge').textContent = unpaidInvoices;
}

// ========================================
// NAVIGATION
// ========================================
function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const s = this.dataset.section;
            if (s) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                renderSection(s);
            }
        });
    });
}

function renderSection(section) {
    state.currentSection = section;
    state.searchQuery = ''; // Reset search when switching sections
    
    // Set appropriate filter based on section
    if (section === 'leads') {
        state.currentFilter = 'all';
    } else if (section === 'new' || section === 'pending' || section === 'contacted') {
        state.currentFilter = section;
    } else if (section === 'invoices') {
        state.currentFilter = state.currentFilter || 'all'; // Keep existing filter or set to all
    } else {
        state.currentFilter = 'all';
    }

    const titles = {
        dashboard: 'Dashboard',
        analytics: 'Analytics',
        leads: 'All Leads',
        new: 'New Leads',
        pending: 'Pending Leads',
        contacted: 'Contacted Leads',
        customers: 'Customers',
        employees: 'Team Management',
        invoices: 'Invoices',
        tasks: 'Tasks',
        settings: 'Settings'
    };
    
    document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
    
    // Update topbar actions based on section
    const topbarActions = document.querySelector('.topbar-actions');
    let actionButtons = `
        <button class="btn btn-secondary" onclick="openExportModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Export
        </button>
    `;
    
    // Add section-specific action button
    if (section === 'leads' || section === 'new' || section === 'pending' || section === 'contacted') {
        actionButtons += `
            <button class="btn btn-primary" onclick="openCreateModal('lead')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Lead
            </button>
        `;
    } else if (section === 'invoices') {
        actionButtons += `
            <button class="btn btn-primary" onclick="showInvoiceLeadSelector()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                Create Invoice
            </button>
        `;
    } else if (section === 'employees') {
        actionButtons += `
            <button class="btn btn-primary" onclick="openCreateModal('employee')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Employee
            </button>
        `;
    } else if (section === 'tasks') {
        actionButtons += `
            <button class="btn btn-primary" onclick="openCreateModal('task')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Task
            </button>
        `;
    } else if (section === 'dashboard') {
        actionButtons += `
            <button class="btn btn-primary" onclick="openCreateModal('lead')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Lead
            </button>
        `;
    }
    
    topbarActions.innerHTML = actionButtons;
    
    const content = document.getElementById('contentArea');
    
    switch (section) {
        case 'dashboard': renderDashboard(content); break;
        case 'analytics': renderAnalytics(content); break;
        case 'leads':
        case 'new':
        case 'pending':
        case 'contacted':
            state.currentFilter = section === 'leads' ? 'all' : section;
            renderLeadsTable(content, 'leads');
            break;
        case 'customers': renderLeadsTable(content, 'customers'); break;
        case 'employees': renderEmployees(content); break;
        case 'invoices': renderInvoices(content); break;
        case 'tasks': renderTasks(content); break;
        case 'settings': renderSettings(content); break;
    }
}

function showInvoiceLeadSelector() {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Select Customer/Lead for Invoice';
    
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    
    bodyEl.innerHTML = `
        <div class="form-group">
            <label class="form-label">Search Customer/Lead</label>
            <input type="text" class="form-input" id="leadSearch" placeholder="Search by name or email..." oninput="filterLeadSelector()">
        </div>
        <div id="leadSelectorList" style="max-height: 400px; overflow-y: auto; margin-top: 16px;">
            ${allLeadsAndCustomers.map(lead => `
                <div class="expense-item" style="cursor: pointer; margin-bottom: 8px;" onclick="selectLeadForInvoice(${lead.id})">
                    <div class="contact-avatar">${getInitials(lead.name)}</div>
                    <div class="expense-content">
                        <div class="expense-description">${lead.name}</div>
                        <div class="expense-meta">
                            <span>${lead.email}</span>
                            ${lead.company ? `<span>${lead.company}</span>` : ''}
                        </div>
                    </div>
                    <span class="status-badge status-${lead.is_customer ? 'contacted' : lead.status}">
                        ${lead.is_customer ? 'Customer' : 'Lead'}
                    </span>
                </div>
            `).join('')}
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
        </div>
    `;
    
    modal.classList.add('active');
}

function filterLeadSelector() {
    const search = document.getElementById('leadSearch').value.toLowerCase();
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    const filtered = search 
        ? allLeadsAndCustomers.filter(l => 
            l.name.toLowerCase().includes(search) || 
            l.email.toLowerCase().includes(search) ||
            (l.company && l.company.toLowerCase().includes(search))
          )
        : allLeadsAndCustomers;
    
    document.getElementById('leadSelectorList').innerHTML = filtered.map(lead => `
        <div class="expense-item" style="cursor: pointer; margin-bottom: 8px;" onclick="selectLeadForInvoice(${lead.id})">
            <div class="contact-avatar">${getInitials(lead.name)}</div>
            <div class="expense-content">
                <div class="expense-description">${lead.name}</div>
                <div class="expense-meta">
                    <span>${lead.email}</span>
                    ${lead.company ? `<span>${lead.company}</span>` : ''}
                </div>
            </div>
            <span class="status-badge status-${lead.is_customer ? 'contacted' : lead.status}">
                ${lead.is_customer ? 'Customer' : 'Lead'}
            </span>
        </div>
    `).join('');
}

function selectLeadForInvoice(leadId) {
    closeCreateModal();
    openCreateModal('invoice', leadId);
}
// ========================================
// RENDER FUNCTIONS
// ========================================
function renderDashboard(content) {
    const totalLeads = state.leads.length;
    const newLeads = state.leads.filter(l => l.status === 'new').length;
    const activeCustomers = state.customers.length;
    const pendingInvoices = state.invoices.filter(i => i.status === 'sent' || i.status === 'overdue').length;
    const totalRevenue = state.invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
    
    content.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Total Leads</span>
                    <div class="stat-icon blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${totalLeads}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    ${newLeads} new this week
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Active Customers</span>
                    <div class="stat-icon green">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${activeCustomers}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    Growing
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Pending Invoices</span>
                    <div class="stat-icon amber">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${pendingInvoices}</div>
                <div class="stat-change">Awaiting payment</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Total Revenue</span>
                    <div class="stat-icon purple">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">$${totalRevenue.toLocaleString()}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    12% from last month
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 36px;">
            <div class="table-container">
                <div style="padding: 20px 18px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 15px; font-weight: 700;">Recent Leads</h3>
                    <button class="btn btn-sm btn-secondary" onclick="renderSection('leads')">View All</button>
                </div>
                ${renderLeadsTableHTML(state.leads.slice(0, 5))}
            </div>
            
            <div class="table-container">
                <div style="padding: 20px 18px; border-bottom: 1px solid var(--border-subtle);">
                    <h3 style="font-size: 15px; font-weight: 700;">Upcoming Tasks</h3>
                </div>
                <div style="padding: 16px;">
                    ${state.tasks.filter(t => !t.completed).slice(0, 5).map(task => `
                        <div class="task-item" style="margin-bottom: 10px;">
                            <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="task-content">
                                <div class="task-title">${task.title}</div>
                                <div class="task-meta">
                                    <div class="task-due ${new Date(task.dueDate) < new Date() ? 'overdue' : ''}">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        ${formatDate(task.dueDate)}
                                    </div>
                                    <span class="priority-badge priority-${task.priority}">${task.priority}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function renderAnalytics(content) {
    const monthlyLeads = getMonthlyData(state.leads);
    const monthlyRevenue = getMonthlyRevenue();
    
    content.innerHTML = `
        <div class="analytics-grid">
            <div class="analytics-card full-width">
                <div class="analytics-header">
                    <h3 class="analytics-title">Monthly Lead Generation</h3>
                    <div class="filter-group">
                        <button class="filter-btn active">6 Months</button>
                        <button class="filter-btn">1 Year</button>
                        <button class="filter-btn">All Time</button>
                    </div>
                </div>
                <div class="chart-container">
                    ${monthlyLeads.map((count, i) => `
                        <div class="chart-bar" style="height: ${(count / Math.max(...monthlyLeads)) * 180}px;">
                            <div class="chart-bar-value">${count}</div>
                            <div class="chart-bar-label">${getMonthName(i)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Revenue Overview</h3>
                </div>
                <div class="metrics-list">
                    <div class="metric-item">
                        <span class="metric-label">Total Revenue</span>
                        <span class="metric-value">$${monthlyRevenue.total.toLocaleString()}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Pending</span>
                        <span class="metric-value">$${monthlyRevenue.pending.toLocaleString()}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Overdue</span>
                        <span class="metric-value">$${monthlyRevenue.overdue.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Conversion Rate</h3>
                </div>
                <div style="text-align: center; padding: 40px 0;">
                    <div style="font-size: 48px; font-weight: 800; color: var(--accent-amber); font-family: var(--font-mono);">
                        ${calculateConversionRate()}%
                    </div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">Lead to Customer</div>
                    <div class="progress-bar" style="margin-top: 20px;">
                        <div class="progress-fill" style="width: ${calculateConversionRate()}%;"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderLeadsTable(content, type) {
    const data = type === 'customers' ? state.customers : state.leads;
    const filtered = filterLeads(data);
    
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search ${type}..." value="${state.searchQuery}" oninput="handleSearch(this.value)">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            
            ${type === 'leads' ? `
            <div class="filter-group">
                <button class="filter-btn ${state.currentFilter === 'all' ? 'active' : ''}" onclick="filterLeads('all')">All</button>
                <button class="filter-btn ${state.currentFilter === 'new' ? 'active' : ''}" onclick="filterLeads('new')">New</button>
                <button class="filter-btn ${state.currentFilter === 'pending' ? 'active' : ''}" onclick="filterLeads('pending')">Pending</button>
                <button class="filter-btn ${state.currentFilter === 'contacted' ? 'active' : ''}" onclick="filterLeads('contacted')">Contacted</button>
                <button class="filter-btn ${state.currentFilter === 'closed' ? 'active' : ''}" onclick="filterLeads('closed')">Closed</button>
            </div>
            ` : ''}
        </div>
        
        <div class="table-container">
            ${filtered.length > 0 ? renderLeadsTableHTML(filtered) : `
                <div class="empty-state">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div class="empty-title">No ${type} found</div>
                    <div class="empty-description">
                        ${state.searchQuery ? 'Try adjusting your search' : `Get started by creating your first ${type === 'leads' ? 'lead' : 'customer'}`}
                    </div>
                </div>
            `}
        </div>
    `;
}

function renderLeadsTableHTML(leads) {
    return `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Contact</th>
                    <th>Company</th>
                    <th>Project Type</th>
                    <th>Budget</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${leads.map(lead => `
                    <tr onclick="openDetailModal('lead', ${lead.id})">
                        <td>
                            <div class="contact-cell">
                                <div class="contact-avatar">${getInitials(lead.name)}</div>
                                <div class="contact-info">
                                    <div class="contact-name">${lead.name}</div>
                                    <div class="contact-email">${lead.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>${lead.company || '-'}</td>
                        <td>${lead.project_type || '-'}</td>
                        <td>${lead.budget ? `$${parseFloat(lead.budget).toLocaleString()}` : '-'}</td>
                        <td>
                            <span class="status-badge status-${lead.status}">
                                <span class="status-dot"></span>
                                ${lead.status}
                            </span>
                        </td>
                        <td>
                            <span class="priority-badge priority-${lead.priority || 'low'}">
                                ${lead.priority || 'low'}
                            </span>
                        </td>
                        <td onclick="event.stopPropagation()">
                            <div class="table-actions">
                                <button class="table-action-btn" onclick="openDetailModal('lead', ${lead.id})" title="View Details">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                                <button class="table-action-btn" onclick="openCreateModal('invoice', ${lead.id})" title="Create Invoice">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                    </svg>
                                </button>
                                <button class="table-action-btn danger" onclick="deleteLead(${lead.id})" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="table-footer">
            <div class="table-info">Showing ${leads.length} ${leads.length === 1 ? 'result' : 'results'}</div>
        </div>
    `;
}

function renderEmployees(content) {
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search team members..." oninput="handleSearch(this.value)">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal('employee')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Employee
            </button>
        </div>
        
        <div class="cards-grid">
            ${state.employees.map(emp => `
                <div class="card employee-card">
                    <div class="card-header">
                        <div class="employee-avatar-lg">${getInitials(emp.name)}</div>
                        <div class="employee-details">
                            <div class="employee-name">${emp.name}</div>
                            <div class="employee-role">${emp.role}</div>
                        </div>
                    </div>
                    <div class="employee-meta">
                        <div class="employee-meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            ${emp.email}
                        </div>
                        <div class="employee-meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
                            </svg>
                            ${emp.phone || 'N/A'}
                        </div>
                        <div class="employee-meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            Joined ${formatDate(emp.created_at)}
                        </div>
                    </div>
                    <div class="employee-stats">
                        <div class="employee-stat">
                            <div class="employee-stat-value">${emp.projects_assigned || 0}</div>
                            <div class="employee-stat-label">Projects</div>
                        </div>
                        <div class="employee-stat">
                            <div class="employee-stat-value">${emp.tasks_completed || 0}</div>
                            <div class="employee-stat-label">Tasks</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="openDetailModal('employee', ${emp.id})">View</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${emp.id})">Delete</button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderInvoices(content) {
    // Filter by status first
    let filtered = state.invoices;
    if (state.currentFilter && state.currentFilter !== 'all') {
        filtered = filtered.filter(inv => inv.status === state.currentFilter);
    }
    
    // Then apply search
    if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        filtered = filtered.filter(inv => 
            inv.invoice_number.toLowerCase().includes(query) ||
            (inv.customer_name && inv.customer_name.toLowerCase().includes(query)) ||
            (inv.customer_email && inv.customer_email.toLowerCase().includes(query)) ||
            (inv.customer_company && inv.customer_company.toLowerCase().includes(query))
        );
    }
    
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" id="invoiceSearch" placeholder="Search invoices by number or customer..." value="${state.searchQuery}" onkeyup="handleInvoiceSearch(event)">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <div class="filter-group">
                <button class="filter-btn ${state.currentFilter === 'all' ? 'active' : ''}" onclick="filterInvoices('all')">All</button>
                <button class="filter-btn ${state.currentFilter === 'draft' ? 'active' : ''}" onclick="filterInvoices('draft')">Draft</button>
                <button class="filter-btn ${state.currentFilter === 'sent' ? 'active' : ''}" onclick="filterInvoices('sent')">Sent</button>
                <button class="filter-btn ${state.currentFilter === 'paid' ? 'active' : ''}" onclick="filterInvoices('paid')">Paid</button>
                <button class="filter-btn ${state.currentFilter === 'overdue' ? 'active' : ''}" onclick="filterInvoices('overdue')">Overdue</button>
            </div>
        </div>
        
        <div class="cards-grid">
            ${filtered.length > 0 ? filtered.map(inv => `
                <div class="card invoice-card">
                    <div class="invoice-card-header" onclick="openDetailModal('invoice', ${inv.id})">
                        <div>
                            <div class="invoice-card-number">${inv.invoice_number}</div>
                            <div class="invoice-card-customer">${inv.customer_name || 'Unknown'}</div>
                        </div>
                        <span class="status-badge status-${inv.status}">
                            <span class="status-dot"></span>
                            ${inv.status}
                        </span>
                    </div>
                    <div onclick="openDetailModal('invoice', ${inv.id})">
                        <div class="invoice-card-amount">$${parseFloat(inv.total_amount).toLocaleString()}</div>
                        <div class="invoice-card-meta">
                            <div class="invoice-card-meta-item">
                                <div class="invoice-card-meta-label">Issued</div>
                                <div class="invoice-card-meta-value">${formatDate(inv.issue_date)}</div>
                            </div>
                            <div class="invoice-card-meta-item">
                                <div class="invoice-card-meta-label">Due</div>
                                <div class="invoice-card-meta-value">${formatDate(inv.due_date)}</div>
                            </div>
                        </div>
                    </div>
                    ${inv.status !== 'paid' ? `
                        <div style="display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <button class="btn btn-sm btn-success" style="flex: 1;" onclick="event.stopPropagation(); openPaymentModal(${inv.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                Mark Paid
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteInvoice(${inv.id})" title="Delete Invoice">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    ` : `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle); text-align: center;">
                            <span style="color: var(--status-contacted); font-size: 13px; font-weight: 600;">
                                <svg style="width: 14px; height: 14px; display: inline; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                Paid ${inv.paid_at ? formatDate(inv.paid_at) : ''}
                            </span>
                        </div>
                    `}
                </div>
            `).join('') : `
                <div style="grid-column: 1 / -1;">
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div class="empty-title">No invoices found</div>
                        <div class="empty-description">
                            ${state.searchQuery ? 'Try adjusting your search' : 'Create your first invoice to get started'}
                        </div>
                    </div>
                </div>
            `}
        </div>
    `;
}

function renderTasks(content) {
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search tasks...">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal('task')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Task
            </button>
        </div>
        
        <div class="tasks-container">
            ${state.tasks.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <div class="task-due ${new Date(task.dueDate) < new Date() && !task.completed ? 'overdue' : ''}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                ${formatDate(task.dueDate)}
                            </div>
                            <span>${task.assignee}</span>
                            <span class="priority-badge priority-${task.priority}">${task.priority}</span>
                        </div>
                    </div>
                    <div class="table-actions">
                        <button class="table-action-btn danger" onclick="deleteTask(${task.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderSettings(content) {
    content.innerHTML = `
        <div class="settings-layout">
            <div class="settings-nav">
                <div class="settings-nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/>
                        <path d="M12 14c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z"/>
                    </svg>
                    Profile
                </div>
                <div class="settings-nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    Notifications
                </div>
                <div class="settings-nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    Security
                </div>
            </div>
            
            <div class="settings-panel">
                <div class="settings-section">
                    <h3 class="settings-section-title">Notification Preferences</h3>
                    <p class="settings-section-desc">Manage how you receive notifications</p>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label">Email Notifications</div>
                            <div class="setting-desc">Receive notifications via email</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${state.settings.emailNotifications ? 'checked' : ''} onchange="toggleSetting('emailNotifications')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label">Push Notifications</div>
                            <div class="setting-desc">Receive push notifications in browser</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${state.settings.pushNotifications ? 'checked' : ''} onchange="toggleSetting('pushNotifications')">
<span class="toggle-slider"></span>
</label>
</div>
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Weekly Reports</div>
                        <div class="setting-desc">Get weekly summary via email</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.weeklyReport ? 'checked' : ''} onchange="toggleSetting('weeklyReport')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Appearance</h3>
                <p class="settings-section-desc">Customize the look and feel</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Dark Mode</div>
                        <div class="setting-desc">Use dark theme across the app</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.darkMode ? 'checked' : ''} onchange="toggleSetting('darkMode')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Automation</h3>
                <p class="settings-section-desc">Configure automated workflows</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Auto-assign Leads</div>
                        <div class="setting-desc">Automatically assign new leads to team members</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.autoAssign ? 'checked' : ''} onchange="toggleSetting('autoAssign')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
`;
}
// ========================================
// MODAL FUNCTIONS
// ========================================
async function openDetailModal(type, id) {
const modal = document.getElementById('detailModal');
const titleEl = document.getElementById('detailModalTitle');
const bodyEl = document.getElementById('detailModalBody');
const footerEl = document.getElementById('detailModalFooter');
if (type === 'lead') {
    const lead = [...state.leads, ...state.customers].find(l => l.id === id);
    if (!lead) return;
    
    state.currentLead = lead;
    const expenses = await loadExpenses(id);
    const notes = lead.notes ? JSON.parse(lead.notes) : [];
    
    titleEl.textContent = `${lead.is_customer ? 'Customer' : 'Lead'} Details`;
    
    bodyEl.innerHTML = `
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Contact Information</h3>
            </div>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">${lead.name}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${lead.email}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone</div>
                    <div class="detail-value">${lead.phone || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Company</div>
                    <div class="detail-value">${lead.company || 'N/A'}</div>
                </div>
                <div class="detail-item full-width">
                    <div class="detail-label">Message</div>
                    <div class="detail-value">${lead.message || 'N/A'}</div>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Project Details</h3>
            </div>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Project Type</div>
                    <div class="detail-value">${lead.project_type || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Budget</div>
                    <div class="detail-value">${lead.budget ? `$${parseFloat(lead.budget).toLocaleString()}` : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Timeline</div>
                    <div class="detail-value">${lead.timeline || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge status-${lead.status}">
                            <span class="status-dot"></span>
                            ${lead.status}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Priority</div>
                    <div class="detail-value">
                        <span class="priority-badge priority-${lead.priority || 'low'}">${lead.priority || 'low'}</span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Created</div>
                    <div class="detail-value">${formatDate(lead.created_at)}</div>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Expenses</h3>
            </div>
            <div class="expense-list">
                ${expenses.length > 0 ? expenses.map(exp => `
                    <div class="expense-item ${state.selectedExpenses.includes(exp.id) ? 'selected' : ''}" data-expense-id="${exp.id}">
                        <div class="expense-checkbox ${state.selectedExpenses.includes(exp.id) ? 'checked' : ''}" onclick="toggleExpense(${exp.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <div class="expense-content">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-meta">
                                <div class="expense-meta-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    ${formatDate(exp.expense_date)}
                                </div>
                                ${exp.category ? `<span>${exp.category}</span>` : ''}
                            </div>
                        </div>
                        <div class="expense-amount">$${parseFloat(exp.amount).toLocaleString()}</div>
                        <div class="expense-actions">
                            <button class="table-action-btn danger" onclick="event.stopPropagation(); deleteExpense(${exp.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('') : '<div class="expense-empty">No expenses recorded yet</div>'}
            </div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="openCreateModal('expense', ${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Expense
            </button>
        </div>
        
        <div class="detail-section">
            <div class="section-header">
                <h3 class="section-title">Notes</h3>
            </div>
            <div class="notes-list">
                ${notes.length > 0 ? notes.map(note => `
                    <div class="note-item">
                        <div class="note-header">
                            <span class="note-author">${note.author || 'Admin'}</span>
                            <span class="note-date">${formatDate(note.date)}</span>
                        </div>
                        <div class="note-text">${note.text}</div>
                    </div>
                `).join('') : '<div class="note-empty">No notes yet</div>'}
            </div>
            <div class="form-group full-width">
                <textarea class="form-textarea" id="newNote" placeholder="Add a new note..."></textarea>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addNote(${id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Note
                </button>
            </div>
        </div>
    `;
    
    footerEl.innerHTML = `
    <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>

    <button class="btn btn-secondary" onclick="changeLeadStatus(${id})">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12 6 12 12 16 14"/>
    </svg>
    Change Status
</button>
    
    ${!lead.is_customer ? `
        <button class="btn btn-success" onclick="convertToCustomer(${id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <polyline points="17 11 19 13 23 9"/>
            </svg>
            Convert to Customer
        </button>
    ` : ''}
    
    <button class="btn btn-secondary" onclick="assignEmployee(${id})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
        </svg>
        Assign Employee
    </button>
    
    <button class="btn btn-secondary" onclick="changePriority(${id})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        Change Priority
    </button>
        ${state.selectedExpenses.length > 0 ? `
            <button class="btn btn-success" onclick="createInvoiceFromExpenses()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                Create Invoice (${state.selectedExpenses.length} selected)
            </button>
        ` : `
            <button class="btn btn-primary" onclick="openCreateModal('invoice', ${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                Create Invoice
            </button>
        `}
        <button class="btn btn-danger" onclick="deleteLead(${id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Delete
        </button>
    `;
} else if (type === 'invoice') {
    const invoice = state.invoices.find(i => i.id === id);
    if (!invoice) return;
    
    state.currentInvoice = invoice; // ADD THIS LINE - it was missing!
    
    titleEl.textContent = 'Invoice Details';
    bodyEl.innerHTML = renderInvoicePreview(invoice);
    
    // REPLACE THE ENTIRE footerEl.innerHTML with this:
    let footerButtons = `
        <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
    `;
    
    // Add Mark as Paid button if not already paid
    if (invoice.status !== 'paid' && invoice.status !== 'void' && invoice.status !== 'cancelled') {
        footerButtons += `
            <button class="btn btn-success" onclick="openPaymentModal(${invoice.id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Mark as Paid
            </button>
        `;
    }
    
    // Add print button
    footerButtons += `
        <button class="btn btn-primary" onclick="printInvoice()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"/>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <rect x="6" y="14" width="12" height="8"/>
            </svg>
            Print Invoice
        </button>
    `;
    
    // Add delete button (only for non-paid invoices)
    if (invoice.status !== 'paid') {
        footerButtons += `
            <button class="btn btn-danger" onclick="deleteInvoice(${invoice.id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete Invoice
            </button>
        `;
    }
    
    footerEl.innerHTML = footerButtons;
}

modal.classList.add('active');
}
function renderInvoicePreview(invoice) {
const items = invoice.items || [];
const taxAmount = parseFloat(invoice.tax_amount || 0);
const discount = parseFloat(invoice.discount_amount || 0);
return `
    <div class="invoice-preview">
        <div class="invoice-preview-header">
            <div class="invoice-company">
                <div class="invoice-company-logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <div>
                    <div class="invoice-company-name">Diamondback Coding</div>
                    <div class="invoice-company-tagline">Premium Development Services</div>
                </div>
            </div>
            <div class="invoice-info">
                <div class="invoice-title">INVOICE</div>
                <div class="invoice-number">#${invoice.invoice_number}</div>
            </div>
        </div>
        
        <div class="invoice-preview-body">
            <div class="invoice-parties">
                <div>
                    <div class="invoice-party-label">From</div>
                    <div class="invoice-party-name">Diamondback Coding</div>
                    <div class="invoice-party-details">
                        123 Tech Street<br>
                        Austin, TX 78701<br>
                        contact@diamondbackcoding.com
                    </div>
                </div>
                <div>
                    <div class="invoice-party-label">Bill To</div>
                    <div class="invoice-party-name">${invoice.customer_name || 'Customer'}</div>
                    <div class="invoice-party-details">
                        ${invoice.customer_email || ''}<br>
                        ${invoice.customer_company || ''}
                    </div>
                </div>
            </div>
            
            <div class="invoice-dates">
                <div class="invoice-date-item">
                    <div class="invoice-date-label">Issue Date</div>
                    <div class="invoice-date-value">${formatDate(invoice.issue_date)}</div>
                </div>
                <div class="invoice-date-item">
                    <div class="invoice-date-label">Due Date</div>
                    <div class="invoice-date-value">${formatDate(invoice.due_date)}</div>
                </div>
            </div>
            
            <table class="invoice-items-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${items.map(item => `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.quantity || 1}</td>
                            <td>$${parseFloat(item.unit_price || item.amount).toLocaleString()}</td>
                            <td>$${parseFloat(item.amount).toLocaleString()}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="invoice-totals">
                <div class="invoice-total-row">
                    <span class="invoice-total-label">Subtotal</span>
                    <span class="invoice-total-value">$${parseFloat(invoice.subtotal).toLocaleString()}</span>
                </div>
                ${taxAmount > 0 ? `
                    <div class="invoice-total-row">
                        <span class="invoice-total-label">Tax (${invoice.tax_rate}%)</span>
                        <span class="invoice-total-value">$${taxAmount.toLocaleString()}</span>
                    </div>
                ` : ''}
                ${discount > 0 ? `
                    <div class="invoice-total-row">
                        <span class="invoice-total-label">Discount</span>
                        <span class="invoice-total-value">-$${discount.toLocaleString()}</span>
                    </div>
                ` : ''}
                <div class="invoice-total-row grand">
                    <span class="invoice-total-label">Total</span>
                    <span class="invoice-total-value">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                </div>
            </div>
        </div>
        
        ${invoice.notes ? `
            <div class="invoice-preview-footer">
                <div class="invoice-notes-title">Notes</div>
                <div class="invoice-notes-text">${invoice.notes}</div>
            </div>
        ` : ''}
    </div>
`;
}
function closeDetailModal() {
document.getElementById('detailModal').classList.remove('active');
state.currentLead = null;
state.selectedExpenses = [];
}
function openCreateModal(type, leadId = null) {
const modal = document.getElementById('createModal');
const titleEl = document.getElementById('createModalTitle');
const bodyEl = document.getElementById('createModalBody');
if (type === 'lead') {
    titleEl.textContent = 'Create New Lead';
    bodyEl.innerHTML = `
        <form id="createLeadForm" onsubmit="handleCreateLead(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Name <span class="required">*</span></label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email <span class="required">*</span></label>
                    <input type="email" class="form-input" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" name="phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" name="company">
                </div>
                <div class="form-group">
                    <label class="form-label">Project Type</label>
                    <select class="form-select" name="project_type">
                        <option value="">Select type...</option>
                        <option value="Web Development">Web Development</option>
                        <option value="Mobile App">Mobile App</option>
                        <option value="E-commerce">E-commerce</option>
                        <option value="Custom Software">Custom Software</option>
                        <option value="Consulting">Consulting</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Budget</label>
                    <input type="number" class="form-input" name="budget" step="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="new">New</option>
                        <option value="pending">Pending</option>
                        <option value="contacted">Contacted</option>
                        <option value="closed">Closed</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" name="priority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" name="message"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Lead</button>
            </div>
        </form>
    `;
} else if (type === 'expense') {
    titleEl.textContent = 'Add Expense';
    bodyEl.innerHTML = `
        <form id="createExpenseForm" onsubmit="handleCreateExpense(event, ${leadId})">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Description <span class="required">*</span></label>
                    <input type="text" class="form-input" name="description" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount <span class="required">*</span></label>
                    <input type="number" class="form-input" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-input" name="quantity" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" name="expense_date" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" name="category">
                        <option value="">Select category...</option>
                        <option value="Development">Development</option>
                        <option value="Design">Design</option>
                        <option value="Hosting">Hosting</option>
                        <option value="Consulting">Consulting</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" name="notes" rows="3"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </div>
        </form>
    `;
} else if (type === 'invoice') {
    openInvoiceModal(leadId);
    return;
} else if (type === 'employee') {
    titleEl.textContent = 'Add Team Member';
    bodyEl.innerHTML = `
        <form id="createEmployeeForm" onsubmit="handleCreateEmployee(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Name <span class="required">*</span></label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email <span class="required">*</span></label>
                    <input type="email" class="form-input" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" name="phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <input type="text" class="form-input" name="role" placeholder="e.g., Developer, Designer">
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Employee</button>
            </div>
        </form>
    `;
} else if (type === 'task') {
    titleEl.textContent = 'Create Task';
    bodyEl.innerHTML = `
        <form id="createTaskForm" onsubmit="handleCreateTask(event)">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Task Title <span class="required">*</span></label>
                    <input type="text" class="form-input" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" name="dueDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" name="priority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Assignee</label>
                    <input type="text" class="form-input" name="assignee" value="Admin">
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Task</button>
            </div>
        </form>
    `;
}

modal.classList.add('active');
}
function closeCreateModal() {
document.getElementById('createModal').classList.remove('active');
}
async function openInvoiceModal(leadId) {
const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
if (!lead) return;
const expenses = await loadExpenses(leadId);
const selectedExpenses = state.selectedExpenses.length > 0 
    ? expenses.filter(e => state.selectedExpenses.includes(e.id))
    : expenses;

const modal = document.getElementById('invoiceModal');
const titleEl = document.getElementById('invoiceModalTitle');
const bodyEl = document.getElementById('invoiceModalBody');
const footerEl = document.getElementById('invoiceModalFooter');

titleEl.textContent = 'Create Invoice';

const invoiceNumber = `INV-${Date.now().toString().slice(-6)}`;
const today = new Date().toISOString().split('T')[0];
const dueDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

bodyEl.innerHTML = `
    <div class="tabs">
        <button class="tab active" onclick="switchInvoiceTab('details')">Details</button>
        <button class="tab" onclick="switchInvoiceTab('items')">Items</button>
        <button class="tab" onclick="switchInvoiceTab('preview')">Preview</button>
    </div>
    
    <div id="invoiceDetailsTab">
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Invoice Number</label>
                <input type="text" class="form-input" id="invoiceNumber" value="${invoiceNumber}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="invoiceStatus">
                    <option value="draft">Draft</option>
                    <option value="sent">Sent</option>
                    <option value="paid">Paid</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">Issue Date</label>
<input type="date" class="form-input" id="invoiceIssueDate" value="${today}">
</div>
<div class="form-group">
<label class="form-label">Due Date</label>
<input type="date" class="form-input" id="invoiceDueDate" value="${dueDate}">
</div>
<div class="form-group">
<label class="form-label">Tax Rate (%)</label>
<input type="number" class="form-input" id="invoiceTaxRate" value="0" step="0.01" oninput="recalculateInvoice()">
</div>
<div class="form-group">
<label class="form-label">Discount</label>
<input type="number" class="form-input" id="invoiceDiscount" value="0" step="0.01" oninput="recalculateInvoice()">
</div>
<div class="form-group full-width">
<label class="form-label">Notes</label>
<textarea class="form-textarea" id="invoiceNotes" placeholder="Payment terms, thank you message, etc."></textarea>
</div>
</div>
</div>
    <div id="invoiceItemsTab" style="display: none;">
        <div id="invoiceItemsList">
            ${selectedExpenses.map((exp, idx) => `
                <div class="expense-item selected" data-item-index="${idx}">
                    <div class="expense-content">
                        <div class="expense-description">${exp.description}</div>
                        <div class="expense-meta">
                            <div class="expense-meta-item">Qty: ${exp.quantity || 1}</div>
                            <div class="expense-meta-item">${exp.category || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="expense-amount">$${parseFloat(exp.amount).toLocaleString()}</div>
                    <div class="expense-actions">
                        <button class="table-action-btn danger" onclick="removeInvoiceItem(${idx})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
        <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="addCustomInvoiceItem()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Custom Item
        </button>
    </div>
    
    <div id="invoicePreviewTab" style="display: none;"></div>
`;

// Store invoice data in state
state.currentInvoice = {
    leadId,
    lead,
    items: selectedExpenses.map(exp => ({
        description: exp.description,
        quantity: exp.quantity || 1,
        unit_price: parseFloat(exp.amount),
        amount: parseFloat(exp.amount) * (exp.quantity || 1),
        expense_id: exp.id
    }))
};

footerEl.innerHTML = `
    <button class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
    <button class="btn btn-primary" onclick="saveInvoice()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
        </svg>
        Save Invoice
    </button>
`;

modal.classList.add('active');
}
function closeInvoiceModal() {
document.getElementById('invoiceModal').classList.remove('active');
state.currentInvoice = null;
}
// ========================================
// FORM HANDLERS
// ========================================
async function handleCreateLead(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    try {
        const r = await fetch(`${API_URL}/api/leads`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) {
            const errorData = await r.json();
            throw new Error(errorData.message || 'Failed to create lead');
        }
        
        // Force complete data reload
        await loadAllData();
        closeCreateModal();
        showToast('Lead created successfully', 'success');
        renderSection(state.currentSection);
    } catch (e) {
        console.error('Create lead error:', e);
        showToast(e.message || 'Error creating lead', 'error');
    }
}
async function handleCreateExpense(event, leadId) {
event.preventDefault();
const form = event.target;
const formData = new FormData(form);
const data = Object.fromEntries(formData.entries());
try {
    const r = await fetch(`${API_URL}/api/leads/${leadId}/expenses`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(data)
    });
    
    if (!r.ok) throw new Error('Failed to create expense');
    
    closeCreateModal();
    showToast('Expense added successfully', 'success');
    openDetailModal('lead', leadId);
} catch (e) {
    showToast('Error adding expense', 'error');
}
}
async function handleCreateEmployee(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    console.log('Creating employee with data:', data); // Debug log
    
    try {
        const r = await fetch(`${API_URL}/api/employees`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await r.json();
        console.log('Server response:', result); // Debug log
        
        if (!r.ok) {
            throw new Error(result.message || 'Failed to create employee');
        }
        
        // Reload employees specifically
        await loadEmployees();
        closeCreateModal();
        showToast('Employee added successfully', 'success');
        renderSection('employees');
    } catch (e) {
        console.error('Create employee error:', e);
        showToast(e.message || 'Error adding employee', 'error');
    }
}
function handleCreateTask(event) {
event.preventDefault();
const form = event.target;
const formData = new FormData(form);
const data = Object.fromEntries(formData.entries());
const newTask = {
    id: state.tasks.length + 1,
    title: data.title,
    dueDate: data.dueDate,
    assignee: data.assignee,
    priority: data.priority,
    completed: false
};

state.tasks.push(newTask);
closeCreateModal();
showToast('Task created successfully', 'success');
renderSection('tasks');
}
// ========================================
// INVOICE FUNCTIONS
// ========================================
function switchInvoiceTab(tab) {
document.querySelectorAll('#invoiceModal .tab').forEach(t => t.classList.remove('active'));
document.querySelector(`#invoiceModal .tab:nth-child(${tab === 'details' ? 1 : tab === 'items' ? 2 : 3})`).classList.add('active');
document.getElementById('invoiceDetailsTab').style.display = tab === 'details' ? 'block' : 'none';
document.getElementById('invoiceItemsTab').style.display = tab === 'items' ? 'block' : 'none';
document.getElementById('invoicePreviewTab').style.display = tab === 'preview' ? 'block' : 'none';

if (tab === 'preview') {
    updateInvoicePreview();
}
}
function recalculateInvoice() {
if (state.currentInvoice) {
const subtotal = state.currentInvoice.items.reduce((sum, item) => sum + parseFloat(item.amount), 0);
const taxRate = parseFloat(document.getElementById('invoiceTaxRate').value) || 0;
const discount = parseFloat(document.getElementById('invoiceDiscount').value) || 0;
    state.currentInvoice.subtotal = subtotal;
    state.currentInvoice.tax_amount = subtotal * (taxRate / 100);
    state.currentInvoice.discount_amount = discount;
    state.currentInvoice.total_amount = subtotal + state.currentInvoice.tax_amount - discount;
}
}
function addCustomInvoiceItem() {
const description = prompt('Item description:');
if (!description) return;
const quantity = parseInt(prompt('Quantity:', '1')) || 1;
const unitPrice = parseFloat(prompt('Unit price:', '0')) || 0;

const item = {
    description,
    quantity,
    unit_price: unitPrice,
    amount: quantity * unitPrice
};

state.currentInvoice.items.push(item);
recalculateInvoice();

const list = document.getElementById('invoiceItemsList');
const idx = state.currentInvoice.items.length - 1;
list.innerHTML += `
    <div class="expense-item selected" data-item-index="${idx}">
        <div class="expense-content">
            <div class="expense-description">${item.description}</div>
            <div class="expense-meta">
                <div class="expense-meta-item">Qty: ${item.quantity}</div>
                <div class="expense-meta-item">@ $${item.unit_price.toLocaleString()}</div>
            </div>
        </div>
        <div class="expense-amount">$${item.amount.toLocaleString()}</div>
        <div class="expense-actions">
            <button class="table-action-btn danger" onclick="removeInvoiceItem(${idx})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
    </div>
`;
}
function removeInvoiceItem(idx) {
state.currentInvoice.items.splice(idx, 1);
recalculateInvoice();
document.querySelector(`[data-item-index="${idx}"]`).remove();
}
function updateInvoicePreview() {
recalculateInvoice();
const invoice = {
    invoice_number: document.getElementById('invoiceNumber').value,
    issue_date: document.getElementById('invoiceIssueDate').value,
    due_date: document.getElementById('invoiceDueDate').value,
    customer_name: state.currentInvoice.lead.name,
    customer_email: state.currentInvoice.lead.email,
    customer_company: state.currentInvoice.lead.company,
    subtotal: state.currentInvoice.subtotal,
    tax_rate: parseFloat(document.getElementById('invoiceTaxRate').value) || 0,
    tax_amount: state.currentInvoice.tax_amount,
    discount_amount: state.currentInvoice.discount_amount,
    total_amount: state.currentInvoice.total_amount,
    notes: document.getElementById('invoiceNotes').value,
    items: state.currentInvoice.items
};

document.getElementById('invoicePreviewTab').innerHTML = renderInvoicePreview(invoice);
}
async function saveInvoice() {
if (!state.currentInvoice || state.currentInvoice.items.length === 0) {
showToast('Please add at least one item to the invoice', 'error');
return;
}
recalculateInvoice();

const invoiceData = {
    invoice_number: document.getElementById('invoiceNumber').value,
    lead_id: state.currentInvoice.leadId,
    issue_date: document.getElementById('invoiceIssueDate').value,
    due_date: document.getElementById('invoiceDueDate').value,
    subtotal: state.currentInvoice.subtotal,
    tax_rate: parseFloat(document.getElementById('invoiceTaxRate').value) || 0,
    tax_amount: state.currentInvoice.tax_amount,
    discount_amount: state.currentInvoice.discount_amount,
    total_amount: state.currentInvoice.total_amount,
    status: document.getElementById('invoiceStatus').value,
    notes: document.getElementById('invoiceNotes').value,
    items: state.currentInvoice.items
};

try {
    const r = await fetch(`${API_URL}/api/invoices`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(invoiceData)
    });
    
    if (!r.ok) throw new Error('Failed to create invoice');
    
    await loadInvoices();
    updateBadges();
    closeInvoiceModal();
    closeDetailModal();
    showToast('Invoice created successfully', 'success');
    renderSection('invoices');
} catch (e) {
    showToast('Error creating invoice', 'error');
}
}
async function createInvoiceFromExpenses() {
if (state.selectedExpenses.length === 0) {
showToast('Please select expenses first', 'error');
return;
}
closeDetailModal();
await openInvoiceModal(state.currentLead.id);
}
// ========================================
// UTILITY FUNCTIONS
// ========================================
function toggleExpense(expenseId) {
const idx = state.selectedExpenses.indexOf(expenseId);
if (idx > -1) {
state.selectedExpenses.splice(idx, 1);
} else {
state.selectedExpenses.push(expenseId);
}
const checkbox = document.querySelector(`[data-expense-id="${expenseId}"] .expense-checkbox`);
const item = document.querySelector(`[data-expense-id="${expenseId}"]`);

if (state.selectedExpenses.includes(expenseId)) {
    checkbox.classList.add('checked');
    item.classList.add('selected');
} else {
    checkbox.classList.remove('checked');
    item.classList.remove('selected');
}

openDetailModal('lead', state.currentLead.id);
}
async function addNote(leadId) {
const text = document.getElementById('newNote').value.trim();
if (!text) return;
const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
const notes = lead.notes ? JSON.parse(lead.notes) : [];

notes.push({
    text,
    author: 'Admin',
    date: new Date().toISOString()
});

try {
    const r = await fetch(`${API_URL}/api/leads/${leadId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({ notes: JSON.stringify(notes) })
    });
    
    if (!r.ok) throw new Error('Failed to add note');
    
    await loadLeads();
    showToast('Note added successfully', 'success');
    openDetailModal('lead', leadId);
} catch (e) {
    showToast('Error adding note', 'error');
}
}
async function deleteLead(id) {
if (!confirm('Are you sure you want to delete this lead?')) return;
try {
    const r = await fetch(`${API_URL}/api/leads/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete lead');
    
    await loadLeads();
    updateBadges();
    closeDetailModal();
    showToast('Lead deleted successfully', 'success');
    renderSection(state.currentSection);
} catch (e) {
    showToast('Error deleting lead', 'error');
}
}
async function deleteExpense(id) {
if (!confirm('Are you sure you want to delete this expense?')) return;
try {
    const r = await fetch(`${API_URL}/api/expenses/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete expense');
    
    showToast('Expense deleted successfully', 'success');
    openDetailModal('lead', state.currentLead.id);
} catch (e) {
    showToast('Error deleting expense', 'error');
}
}

// Delete Invoice Function
async function deleteInvoice(id) {
    const invoice = state.invoices.find(i => i.id === id);
    
    if (!confirm(`Are you sure you want to delete invoice ${invoice.invoice_number}?\n\nThis will unmark all associated expenses so they can be invoiced again.`)) {
        return;
    }
    
    try {
        const r = await fetch(`${API_URL}/api/invoices/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            const data = await r.json();
            throw new Error(data.message || 'Failed to delete invoice');
        }
        
        await loadInvoices();
        await loadLeads();
        updateBadges();
        closeDetailModal();
        showToast('Invoice deleted successfully', 'success');
        renderSection('invoices');
    } catch (e) {
        showToast(e.message || 'Error deleting invoice', 'error');
    }
}

// Open Payment Modal
function openPaymentModal(invoiceId) {
    const invoice = state.invoices.find(i => i.id === invoiceId);
    if (!invoice) return;
    
    const modal = document.getElementById('paymentModal');
    const bodyEl = document.getElementById('paymentModalBody');
    
    bodyEl.innerHTML = `
        <form id="paymentForm" onsubmit="handlePaymentSubmit(event, ${invoiceId})">
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: var(--radius-md); margin-bottom: 24px; border: 1px solid var(--border-subtle);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Invoice Number</span>
                    <span style="color: var(--text-primary); font-weight: 600; font-family: var(--font-mono);">${invoice.invoice_number}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Customer</span>
                    <span style="color: var(--text-primary); font-weight: 600;">${invoice.customer_name || 'Unknown'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border-subtle); margin-top: 12px;">
                    <span style="color: var(--text-secondary); font-size: 14px; font-weight: 600;">Total Amount</span>
                    <span style="color: var(--accent-amber); font-weight: 800; font-size: 24px; font-family: var(--font-mono);">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Payment Method <span class="required">*</span></label>
                    <select class="form-select" name="paymentMethod" required>
                        <option value="">Select method...</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="ACH">ACH</option>
                        <option value="Check">Check</option>
                        <option value="Cash">Cash</option>
                        <option value="PayPal">PayPal</option>
                        <option value="Stripe">Stripe</option>
                        <option value="Venmo">Venmo</option>
                        <option value="Zelle">Zelle</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Reference</label>
                    <input type="text" class="form-input" name="paymentReference" placeholder="Transaction ID, Check #, etc.">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Payment Notes</label>
                    <textarea class="form-textarea" name="paymentNotes" rows="3" placeholder="Additional payment details..."></textarea>
                </div>
            </div>
            
            <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); padding: 16px; border-radius: var(--radius-md); margin-top: 24px;">
                <div style="display: flex; gap: 12px; align-items: flex-start;">
                    <svg style="width: 20px; height: 20px; color: var(--status-contacted); flex-shrink: 0; margin-top: 2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <div>
                        <div style="font-weight: 600; color: var(--status-contacted); margin-bottom: 4px;">Payment Processing</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            When you mark this invoice as paid:
                            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                <li>The customer will be marked as ACTIVE</li>
                                <li>Their lifetime value will be updated</li>
                                <li>A payment note will be added to their record</li>
                                <li>Invoice status will change to PAID</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                <button type="submit" class="btn btn-success">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Confirm Payment
                </button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

// Close Payment Modal
function closePaymentModal() {
    document.getElementById('paymentModal').classList.remove('active');
}

// Handle Payment Submission
async function handlePaymentSubmit(event, invoiceId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {
        status: 'paid',
        paymentMethod: formData.get('paymentMethod'),
        paymentReference: formData.get('paymentReference'),
        paymentNotes: formData.get('paymentNotes')
    };
    
    try {
        const r = await fetch(`${API_URL}/api/invoices/${invoiceId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) throw new Error('Failed to update invoice status');
        
        const result = await r.json();
        
        await loadInvoices();
        await loadLeads();
        updateBadges();
        closePaymentModal();
        closeDetailModal();
        showToast('Payment recorded successfully! Customer updated to ACTIVE status.', 'success');
        renderSection('invoices');
    } catch (e) {
        showToast('Error recording payment', 'error');
    }
}

async function deleteEmployee(id) {
if (!confirm('Are you sure you want to delete this employee?')) return;
try {
    const r = await fetch(`${API_URL}/api/employees/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete employee');
    
    await loadEmployees();
    showToast('Employee deleted successfully', 'success');
    renderSection('employees');
} catch (e) {
    showToast('Error deleting employee', 'error');
}
}
function deleteTask(id) {
state.tasks = state.tasks.filter(t => t.id !== id);
showToast('Task deleted successfully', 'success');
renderSection('tasks');
}
function toggleTask(id) {
const task = state.tasks.find(t => t.id === id);
if (task) {
task.completed = !task.completed;
renderSection('tasks');
}
}
function filterLeads(type) {
state.currentFilter = type;
renderSection(state.currentSection);
}
function handleInvoiceSearch(event) {
    state.searchQuery = event.target.value.toLowerCase();
    renderSection('invoices');
}
function filterInvoices(status) {
    state.currentFilter = status;
    renderSection('invoices');
}
function handleSearch(query) {
state.searchQuery = query.toLowerCase();
renderSection(state.currentSection);
}
function toggleSetting(setting) {
    state.settings[setting] = !state.settings[setting];
    
    // Save to localStorage
    localStorage.setItem('adminSettings', JSON.stringify(state.settings));
    
    // Apply the setting
    applySettings();
    
    showToast('Setting updated', 'success');
}

function applySettings() {
    // Apply dark/light mode
    if (state.settings.darkMode) {
        document.documentElement.style.setProperty('--bg-void', '#050506');
        document.documentElement.style.setProperty('--bg-primary', '#0a0a0c');
        document.documentElement.style.setProperty('--bg-secondary', '#101014');
        document.documentElement.style.setProperty('--bg-tertiary', '#16161b');
        document.documentElement.style.setProperty('--bg-elevated', '#1c1c22');
        document.documentElement.style.setProperty('--bg-hover', '#222229');
        document.documentElement.style.setProperty('--text-primary', '#f4f4f5');
        document.documentElement.style.setProperty('--text-secondary', '#a1a1aa');
        document.documentElement.style.setProperty('--text-muted', '#71717a');
        document.documentElement.style.setProperty('--text-faint', '#52525b');
        document.documentElement.style.setProperty('--border-subtle', 'rgba(255,255,255,0.04)');
        document.documentElement.style.setProperty('--border-default', 'rgba(255,255,255,0.08)');
        document.documentElement.style.setProperty('--border-strong', 'rgba(255,255,255,0.12)');
        document.body.classList.remove('light-mode');
    } else {
        // Light mode colors
        document.documentElement.style.setProperty('--bg-void', '#f5f5f7');
        document.documentElement.style.setProperty('--bg-primary', '#ffffff');
        document.documentElement.style.setProperty('--bg-secondary', '#f8f9fa');
        document.documentElement.style.setProperty('--bg-tertiary', '#f1f3f5');
        document.documentElement.style.setProperty('--bg-elevated', '#ffffff');
        document.documentElement.style.setProperty('--bg-hover', '#e9ecef');
        document.documentElement.style.setProperty('--text-primary', '#1a1a1a');
        document.documentElement.style.setProperty('--text-secondary', '#495057');
        document.documentElement.style.setProperty('--text-muted', '#6c757d');
        document.documentElement.style.setProperty('--text-faint', '#adb5bd');
        document.documentElement.style.setProperty('--border-subtle', 'rgba(0,0,0,0.06)');
        document.documentElement.style.setProperty('--border-default', 'rgba(0,0,0,0.1)');
        document.documentElement.style.setProperty('--border-strong', 'rgba(0,0,0,0.15)');
        document.body.classList.add('light-mode');
    }
}

function loadSettings() {
    const saved = localStorage.getItem('adminSettings');
    if (saved) {
        try {
            state.settings = { ...state.settings, ...JSON.parse(saved) };
        } catch (e) {
            console.error('Error loading settings:', e);
        }
    }
    applySettings();
}
function printInvoice() {
    const invoice = state.currentInvoice;
    if (!invoice) {
        showToast('No invoice selected', 'error');
        return;
    }
    
    const items = invoice.items || [];
    const taxAmount = parseFloat(invoice.tax_amount || 0);
    const discount = parseFloat(invoice.discount_amount || 0);
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Invoice ${invoice.invoice_number}</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    padding: 40px;
                    color: #1a1a1a;
                    line-height: 1.6;
                }
                .invoice-container {
                    max-width: 800px;
                    margin: 0 auto;
                    background: #fff;
                }
                .header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    padding-bottom: 30px;
                    border-bottom: 3px solid #22c55e;
                    margin-bottom: 30px;
                }
                .company-info h1 {
                    font-size: 28px;
                    font-weight: 800;
                    color: #1a1a1a;
                    margin-bottom: 5px;
                }
                .company-info p {
                    color: #666;
                    font-size: 14px;
                }
                .invoice-title {
                    text-align: right;
                }
                .invoice-title h2 {
                    font-size: 36px;
                    font-weight: 800;
                    color: #22c55e;
                    letter-spacing: -1px;
                }
                .invoice-title .invoice-number {
                    font-size: 16px;
                    color: #666;
                    font-family: monospace;
                }
                .parties {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 40px;
                }
                .party {
                    width: 45%;
                }
                .party-label {
                    font-size: 11px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    color: #22c55e;
                    margin-bottom: 10px;
                }
                .party-name {
                    font-size: 18px;
                    font-weight: 600;
                    margin-bottom: 5px;
                }
                .party-details {
                    font-size: 14px;
                    color: #555;
                }
                .dates {
                    display: flex;
                    gap: 40px;
                    margin-bottom: 40px;
                }
                .date-item {
                    background: #f8f9fa;
                    padding: 15px 25px;
                    border-radius: 8px;
                    border-left: 4px solid #22c55e;
                }
                .date-label {
                    font-size: 10px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    color: #888;
                    margin-bottom: 5px;
                }
                .date-value {
                    font-size: 16px;
                    font-weight: 600;
                    font-family: monospace;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 30px;
                }
                thead {
                    background: #1a1a1a;
                    color: #fff;
                }
                th {
                    padding: 15px;
                    text-align: left;
                    font-size: 11px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                th:last-child {
                    text-align: right;
                }
                td {
                    padding: 15px;
                    border-bottom: 1px solid #eee;
                    font-size: 14px;
                }
                td:last-child {
                    text-align: right;
                    font-family: monospace;
                    font-weight: 600;
                }
                tbody tr:hover {
                    background: #fafafa;
                }
                .totals {
                    display: flex;
                    justify-content: flex-end;
                }
                .totals-table {
                    width: 300px;
                }
                .total-row {
                    display: flex;
                    justify-content: space-between;
                    padding: 10px 0;
                    border-bottom: 1px solid #eee;
                }
                .total-row.grand {
                    border-top: 3px solid #22c55e;
                    border-bottom: none;
                    margin-top: 10px;
                    padding-top: 15px;
                }
                .total-label {
                    color: #666;
                }
                .total-value {
                    font-weight: 600;
                    font-family: monospace;
                }
                .total-row.grand .total-label {
                    font-size: 18px;
                    font-weight: 700;
                    color: #1a1a1a;
                }
                .total-row.grand .total-value {
                    font-size: 28px;
                    font-weight: 800;
                    color: #22c55e;
                }
                .footer {
                    margin-top: 50px;
                    padding-top: 30px;
                    border-top: 1px solid #eee;
                }
                .footer-title {
                    font-size: 11px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    color: #888;
                    margin-bottom: 10px;
                }
                .footer-text {
                    font-size: 14px;
                    color: #555;
                }
                .status-badge {
                    display: inline-block;
                    padding: 5px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 700;
                    text-transform: uppercase;
                    margin-top: 10px;
                }
                .status-draft { background: #f1f3f5; color: #666; }
                .status-sent { background: #e7f5ff; color: #1971c2; }
                .status-paid { background: #d3f9d8; color: #2f9e44; }
                .status-overdue { background: #ffe3e3; color: #e03131; }
                @media print {
                    body { padding: 20px; }
                    .invoice-container { max-width: 100%; }
                }
            </style>
        </head>
        <body>
            <div class="invoice-container">
                <div class="header">
                    <div class="company-info">
                        <h1>Diamondback Coding</h1>
                        <p>Premium Development Services</p>
                        <p>123 Tech Street, Austin, TX 78701</p>
                        <p>contact@diamondbackcoding.com</p>
                    </div>
                    <div class="invoice-title">
                        <h2>INVOICE</h2>
                        <div class="invoice-number">#${invoice.invoice_number}</div>
                        <span class="status-badge status-${invoice.status}">${invoice.status}</span>
                    </div>
                </div>
                
                <div class="parties">
                    <div class="party">
                        <div class="party-label">From</div>
                        <div class="party-name">Diamondback Coding</div>
                        <div class="party-details">
                            123 Tech Street<br>
                            Austin, TX 78701<br>
                            contact@diamondbackcoding.com
                        </div>
                    </div>
                    <div class="party">
                        <div class="party-label">Bill To</div>
                        <div class="party-name">${invoice.customer_name || 'Customer'}</div>
                        <div class="party-details">
                            ${invoice.customer_email || ''}<br>
                            ${invoice.customer_company || ''}
                        </div>
                    </div>
                </div>
                
                <div class="dates">
                    <div class="date-item">
                        <div class="date-label">Issue Date</div>
                        <div class="date-value">${formatDate(invoice.issue_date)}</div>
                    </div>
                    <div class="date-item">
                        <div class="date-label">Due Date</div>
                        <div class="date-value">${formatDate(invoice.due_date)}</div>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity || 1}</td>
                                <td>$${parseFloat(item.unit_price || item.amount).toLocaleString()}</td>
                                <td>$${parseFloat(item.amount).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="totals">
                    <div class="totals-table">
                        <div class="total-row">
                            <span class="total-label">Subtotal</span>
                            <span class="total-value">$${parseFloat(invoice.subtotal).toLocaleString()}</span>
                        </div>
                        ${taxAmount > 0 ? `
                            <div class="total-row">
                                <span class="total-label">Tax (${invoice.tax_rate}%)</span>
                                <span class="total-value">$${taxAmount.toLocaleString()}</span>
                            </div>
                        ` : ''}
                        ${discount > 0 ? `
                            <div class="total-row">
                                <span class="total-label">Discount</span>
                                <span class="total-value">-$${discount.toLocaleString()}</span>
                            </div>
                        ` : ''}
                        <div class="total-row grand">
                            <span class="total-label">Total</span>
                            <span class="total-value">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                
                ${invoice.notes ? `
                    <div class="footer">
                        <div class="footer-title">Notes</div>
                        <div class="footer-text">${invoice.notes}</div>
                    </div>
                ` : ''}
                
                <div class="footer">
                    <div class="footer-title">Payment Information</div>
                    <div class="footer-text">
                        Thank you for your business! Please remit payment by the due date.<br>
                        For questions, contact us at contact@diamondbackcoding.com
                    </div>
                </div>
            </div>
            
            <script>
                window.onload = function() {
                    window.print();
                }
            <\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}
function openExportModal() {
showToast('Export feature coming soon', 'warning');
}
function logout() {
localStorage.removeItem('adminToken');
sessionStorage.removeItem('adminToken');
window.location.href = '/admin';
}
function showToast(message, type = 'success') {
const container = document.getElementById('toastContainer');
const icons = {
success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
};
const toast = document.createElement('div');
toast.className = `toast ${type}`;
toast.innerHTML = `
    <div class="toast-icon">${icons[type]}</div>
    <div class="toast-message">${message}</div>
    <button class="toast-close" onclick="this.parentElement.remove()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </button>
`;

container.appendChild(toast);
setTimeout(() => toast.remove(), 5000);
}

// ========================================
// LEAD ACTION FUNCTIONS (MISSING!)
// ========================================

// Change lead status
// Change lead status - WITH UI MODAL
async function changeLeadStatus(leadId) {
    const statuses = ['new', 'pending', 'contacted', 'closed', 'lost'];
    const currentLead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    const currentStatus = currentLead?.status || 'new';
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Change Status';
    bodyEl.innerHTML = `
        <form id="changeStatusForm" onsubmit="handleChangeStatus(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Status</label>
                <select class="form-select" name="status" required>
                    ${statuses.map(s => `
                        <option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s.toUpperCase()}</option>
                    `).join('')}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleChangeStatus(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const status = formData.get('status');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ status })
        });
        
        if (!r.ok) throw new Error('Failed to update status');
        
        await loadAllData();
        closeCreateModal();
        showToast('Status updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating status', 'error');
    }
}

// Convert lead to customer
async function convertToCustomer(leadId) {
    if (!confirm('Convert this lead to a customer?')) return;
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ 
                status: 'closed',
                isCustomer: true,
                customerStatus: 'active'
            })
        });
        
        if (!r.ok) throw new Error('Failed to convert to customer');
        
        await loadAllData();
        closeDetailModal();
        showToast('Lead converted to customer successfully!', 'success');
        renderSection('customers');
    } catch (e) {
        showToast('Error converting to customer', 'error');
    }
}

// Assign employee to lead
async function assignEmployee(leadId) {
    if (state.employees.length === 0) {
        showToast('No employees available. Add employees first.', 'warning');
        return;
    }
    
    const employeeOptions = state.employees.map(emp => 
        `<option value="${emp.id}">${emp.name} (${emp.role})</option>`
    ).join('');
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Assign Employee';
    bodyEl.innerHTML = `
        <form id="assignEmployeeForm" onsubmit="handleAssignEmployee(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Employee</label>
                <select class="form-select" name="employeeId" required>
                    <option value="">Choose employee...</option>
                    ${employeeOptions}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Assign</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleAssignEmployee(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const employeeId = formData.get('employeeId');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/assign`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ employeeId: parseInt(employeeId) })
        });
        
        if (!r.ok) throw new Error('Failed to assign employee');
        
        await loadAllData();
        closeCreateModal();
        showToast('Employee assigned successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error assigning employee', 'error');
    }
}

// Change lead priority
async function changePriority(leadId) {
    const priorities = ['low', 'medium', 'high'];
    const currentLead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    const currentPriority = currentLead?.priority || 'medium';
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Change Priority';
    bodyEl.innerHTML = `
        <form id="changePriorityForm" onsubmit="handleChangePriority(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Priority</label>
                <select class="form-select" name="priority" required>
                    ${priorities.map(p => `
                        <option value="${p}" ${p === currentPriority ? 'selected' : ''}>${p.toUpperCase()}</option>
                    `).join('')}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleChangePriority(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const priority = formData.get('priority');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/priority`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ priority })
        });
        
        if (!r.ok) throw new Error('Failed to update priority');
        
        await loadAllData();
        closeCreateModal();
        showToast('Priority updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating priority', 'error');
    }
}

// Helper functions
function formatDate(dateString) {
if (!dateString) return 'N/A';
const date = new Date(dateString);
return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function getInitials(name) {
return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}
function getMonthlyData(leads) {
const months = new Array(6).fill(0);
const now = new Date();
leads.forEach(lead => {
    const created = new Date(lead.created_at);
    const monthDiff = (now.getFullYear() - created.getFullYear()) * 12 + (now.getMonth() - created.getMonth());
    if (monthDiff >= 0 && monthDiff < 6) {
        months[5 - monthDiff]++;
    }
});

return months;
}
function getMonthlyRevenue() {
const total = state.invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
const pending = state.invoices.filter(i => i.status === 'sent').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
const overdue = state.invoices.filter(i => i.status === 'overdue').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
return { total, pending, overdue };
}
function getMonthName(index) {
const names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
const month = new Date().getMonth() - (5 - index);
return names[month < 0 ? month + 12 : month];
}
function calculateConversionRate() {
if (state.leads.length === 0) return 0;
return Math.round((state.customers.length / (state.leads.length + state.customers.length)) * 100);
}
function filterLeads(data) {
let filtered = data;
if (state.currentFilter !== 'all') {
    filtered = filtered.filter(l => l.status === state.currentFilter);
}

if (state.searchQuery) {
    filtered = filtered.filter(l => 
        l.name.toLowerCase().includes(state.searchQuery) ||
        l.email.toLowerCase().includes(state.searchQuery) ||
        (l.company && l.company.toLowerCase().includes(state.searchQuery))
    );
}

return filtered;
}
</script>
</body>
</html>