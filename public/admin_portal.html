<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamondback CRM | Admin Portal</title>
    <meta name="description" content="Professional CRM & Project Management Dashboard">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
:root {
    /* Brand Colors - DIAMONDBACK */
    --brand-primary: #D4A574;
    --brand-gold: #D4A574;
    --brand-gold-light: #E5C4A0;
    --brand-gold-dark: #B88F5F;
    
    /* Dark Theme Colors */
    --bg-void: #000000;
    --bg-primary: #0a0a0a;
    --bg-secondary: #121212;
    --bg-tertiary: #1a1a1a;
    --bg-elevated: #1e1e1e;
    --bg-hover: rgba(212, 165, 116, 0.08);
    --bg-card: #141414;
    
    /* Borders */
    --border-subtle: rgba(255, 255, 255, 0.06);
    --border-default: rgba(255, 255, 255, 0.1);
    --border-strong: rgba(212, 165, 116, 0.2);
    --border-accent: rgba(212, 165, 116, 0.4);
    
    /* Text */
    --text-primary: #ffffff;
    --text-secondary: #b4b4b4;
    --text-muted: #808080;
    --text-faint: #4d4d4d;
    
    /* Accent Colors */
    --accent-primary: #D4A574;
    --accent-amber: #D4A574;
    --accent-amber-dim: rgba(212, 165, 116, 0.12);
    --accent-amber-glow: rgba(212, 165, 116, 0.25);
    --accent-copper: #B88F5F;
    --accent-rust: #A67C52;
    --accent-dim: rgba(212, 165, 116, 0.12);
    --accent-glow: rgba(212, 165, 116, 0.25);
    
    /* Status Colors */
    --status-new: #60a5fa;
    --status-pending: #f59e0b;
    --status-contacted: #10b981;
    --status-closed: #6b7280;
    --status-lost: #ef4444;
    --status-draft: #9ca3af;
    --status-sent: #3b82f6;
    --status-paid: #10b981;
    --status-overdue: #dc2626;
    --status-success: #10b981;
    --status-danger: #ef4444;
    
    /* Priority Colors */
    --priority-high: #ef4444;
    --priority-medium: #f59e0b;
    --priority-low: #6b7280;
    
    /* Typography */
    --font-display: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-mono: 'Space Mono', 'Courier New', monospace;
    
    /* Spacing & Layout */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
    --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.7);
    --shadow-glow: 0 0 40px rgba(212, 165, 116, 0.15);
    --sidebar-width: 280px;
    --topbar-height: 70px;
    
    /* Transitions */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
}

* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

html { 
    scroll-behavior: smooth; 
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body {
    font-family: var(--font-display);
    background: var(--bg-void);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
    font-size: 15px;
    font-weight: 400;
}

/* Modern Scrollbar */
::-webkit-scrollbar { 
    width: 10px; 
    height: 10px; 
}
::-webkit-scrollbar-track { 
    background: var(--bg-primary);
}
::-webkit-scrollbar-thumb { 
    background: linear-gradient(180deg, var(--brand-gold-dark), var(--brand-gold));
    border-radius: 10px;
    border: 2px solid var(--bg-primary);
}
::-webkit-scrollbar-thumb:hover { 
    background: linear-gradient(180deg, var(--brand-gold), var(--brand-gold-light));
}

/* ========================================
   QR CODE STYLES
======================================== */
.qr-code-section {
    margin-top: 30px;
    padding: 24px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-subtle);
    text-align: center;
}

.qr-code-container {
    display: inline-block;
    padding: 20px;
    background: white;
    border-radius: var(--radius-md);
    margin: 16px auto;
}

.qr-code-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent-amber);
    margin-bottom: 8px;
}

.qr-code-instructions {
    font-size: 13px;
    color: var(--text-secondary);
    max-width: 400px;
    margin: 12px auto 0;
    line-height: 1.6;
}

.payment-url {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-muted);
    background: var(--bg-hover);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    margin-top: 12px;
    word-break: break-all;
}

/* ========================================
   SIDEBAR
======================================== */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: var(--sidebar-width);
    height: 100vh;
    background: var(--bg-primary);
    border-right: 1px solid var(--border-subtle);
    display: flex;
    flex-direction: column;
    z-index: 100;
    overflow: hidden;
}

.sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 1px;
    height: 100%;
    background: linear-gradient(180deg, var(--accent-amber) 0%, transparent 50%, var(--accent-amber) 100%);
    opacity: 0.3;
}

.sidebar-header {
    padding: 28px 24px;
    border-bottom: 1px solid var(--border-subtle);
    position: relative;
}

.logo {
    display: flex;
    align-items: center;
    gap: 14px;
}

.logo-mark {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-rust) 100%);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 4px 20px rgba(245,158,11,0.3);
}

.logo-mark::before {
    content: '';
    position: absolute;
    inset: -2px;
    background: linear-gradient(135deg, var(--accent-amber), transparent);
    border-radius: var(--radius-md);
    opacity: 0.5;
    z-index: -1;
}

.logo-mark svg {
    width: 24px;
    height: 24px;
    color: var(--bg-void);
}

.logo-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.logo-title {
    font-weight: 800;
    font-size: 17px;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-amber) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.logo-subtitle {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--text-muted);
}

.sidebar-nav {
    flex: 1;
    padding: 20px 16px;
    overflow-y: auto;
}

.nav-section {
    margin-bottom: 28px;
}

.nav-section-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-faint);
    padding: 0 12px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nav-section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border-subtle), transparent);
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    position: relative;
    margin-bottom: 4px;
}

.nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
    transform: translateX(4px);
}

.nav-item.active {
    background: var(--accent-amber-dim);
    color: var(--accent-amber);
    box-shadow: inset 0 0 0 1px var(--accent-amber-dim);
}

.nav-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 24px;
    background: var(--accent-amber);
    border-radius: 0 3px 3px 0;
    box-shadow: 0 0 12px var(--accent-amber);
}

.nav-icon {
    width: 18px;
    height: 18px;
    opacity: 1;
    flex-shrink: 0;
    color: currentColor;
}

.nav-item.active .nav-icon { 
    opacity: 1;
    color: var(--accent-amber);
}

.nav-badge {
    margin-left: auto;
    background: var(--accent-amber);
    color: var(--bg-void);
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 12px;
    min-width: 22px;
    text-align: center;
    font-family: var(--font-mono);
}

.sidebar-footer {
    padding: 20px;
    border-top: 1px solid var(--border-subtle);
    background: linear-gradient(180deg, transparent 0%, var(--bg-secondary) 100%);
}

.user-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid var(--border-subtle);
}

.user-card:hover {
    background: var(--bg-hover);
    border-color: var(--border-default);
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-rust) 100%);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: var(--bg-void);
}

.user-info { flex: 1; min-width: 0; }

.user-name {
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-role {
    font-size: 11px;
    color: var(--text-muted);
}

.logout-icon {
    width: 18px;
    height: 18px;
    color: var(--text-muted);
    transition: color 0.2s ease;
}

.user-card:hover .logout-icon { color: var(--status-lost); }

/* ========================================
   MAIN CONTENT
======================================== */
.main-content {
    margin-left: var(--sidebar-width);
    min-height: 100vh;
    background: var(--bg-void);
}

.topbar {
    position: sticky;
    top: 0;
    height: var(--topbar-height);
    background: rgba(5,5,6,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 36px;
    z-index: 50;
}

.page-header {
    display: flex;
    align-items: center;
    gap: 16px;
}

.page-title {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-title::before {
    content: '';
    width: 4px;
    height: 24px;
    background: var(--accent-amber);
    border-radius: 2px;
    box-shadow: 0 0 12px var(--accent-amber);
}

.topbar-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ========================================
   BUTTONS
======================================== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 11px 20px;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    white-space: nowrap;
    position: relative;
    overflow: hidden;
}

.btn svg { width: 16px; height: 16px; }

/* Primary Button - Amber/Gold gradient with dark text */
.btn-primary {
    background: linear-gradient(135deg, #D4A574 0%, #B88F5F 100%);
    color: #000000;
    border: none;
    font-weight: 700;
    box-shadow: 0 4px 16px rgba(212,165,116,0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #E5C4A0 0%, #D4A574 100%);
    color: #000000;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(212,165,116,0.4);
}

.btn-primary:active { 
    transform: translateY(0);
    background: linear-gradient(135deg, #B88F5F 0%, #9A7A4F 100%);
    box-shadow: 0 2px 8px rgba(212,165,116,0.3);
}

/* Secondary Button - Neutral with good contrast */
.btn-secondary {
    background: #6b7280;
    color: #ffffff;
    border: 1.5px solid #6b7280;
    font-weight: 600;
}

.btn-secondary:hover {
    background: #4b5563;
    color: #ffffff;
    border-color: #4b5563;
    transform: translateY(-1px);
}

/* Danger Button - Lighter, more vibrant red */
.btn-danger {
    background: #f87171;
    color: #ffffff;
    border: 1.5px solid #f87171;
    font-weight: 600;
}

.btn-danger:hover {
    background: #ef4444;
    color: #ffffff;
    border-color: #ef4444;
    transform: translateY(-1px);
}

/* Success Button - Lighter, more vibrant green */
.btn-success {
    background: #4ade80;
    color: #ffffff;
    border: 1.5px solid #4ade80;
    font-weight: 600;
}

.btn-success:hover {
    background: #D4A574;
    color: #ffffff;
    border-color: #D4A574;
    transform: translateY(-1px);
}

/* Warning Button - Same as success (lighter green) */
.btn-warning {
    background: #4ade80;
    color: #ffffff;
    border: 1.5px solid #4ade80;
    font-weight: 600;
}

.btn-warning:hover {
    background: #D4A574;
    color: #ffffff;
    border-color: #B88F5F;
    transform: translateY(-1px);
}

.btn-sm {
    padding: 8px 14px;
    font-size: 12px;
}

.btn-sm svg { width: 14px; height: 14px; }

.btn-icon {
    width: 40px;
    height: 40px;
    padding: 0;
    border-radius: var(--radius-sm);
}

/* ========================================
   CONTENT AREA
======================================== */
.content {
    padding: 36px;
    max-width: 1600px;
}

/* ========================================
   STATS GRID
======================================== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 36px;
}

.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-amber), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stat-card:hover {
    border-color: var(--border-default);
    transform: translateY(-4px);
    box-shadow: var(--shadow-glow);
}

.stat-card:hover::before { opacity: 1; }

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.stat-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-icon svg { width: 18px; height: 18px; }

.stat-icon.amber { background: var(--accent-amber-dim); color: var(--accent-amber); }
.stat-icon.blue { background: rgba(59,130,246,0.12); color: var(--status-new); }
.stat-icon.green { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.stat-icon.purple { background: rgba(139,92,246,0.12); color: var(--status-closed); }
.stat-icon.red { background: rgba(239,68,68,0.12); color: var(--status-lost); }

.stat-value {
    font-size: 36px;
    font-weight: 800;
    letter-spacing: -0.03em;
    font-family: var(--font-mono);
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-change {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    margin-top: 8px;
    color: var(--text-muted);
}

.stat-change.positive { color: var(--status-contacted); }
.stat-change.negative { color: var(--status-lost); }

/* ========================================
   CONTROLS BAR
======================================== */
.controls-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 300px;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 12px 18px 12px 48px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.search-input:focus {
    outline: none;
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px var(--accent-amber-dim), var(--shadow-glow);
}

.search-input::placeholder { color: var(--text-muted); }

.search-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    width: 18px;
    height: 18px;
    transition: color 0.2s ease;
    pointer-events: none;
    z-index: 100;
}

.search-box:focus-within .search-icon { color: var(--accent-amber); }

.filter-group {
    display: flex;
    gap: 4px;
    background: var(--bg-primary);
    padding: 5px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.filter-btn {
    padding: 9px 16px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-btn:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.filter-btn.active {
    background: var(--accent-amber);
    color: var(--bg-void);
}

/* ========================================
   DATA TABLE
======================================== */
.table-container {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
}

.data-table thead {
    background: var(--bg-secondary);
}

.data-table th {
    padding: 14px 18px;
    text-align: left;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border-subtle);
    white-space: nowrap;
}

.data-table td {
    padding: 16px 18px;
    font-size: 13px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: middle;
}

.data-table tbody tr {
    transition: all 0.2s ease;
    cursor: pointer;
}

.data-table tbody tr:hover {
    background: var(--bg-hover);
}

.data-table tbody tr:last-child td { border-bottom: none; }

.contact-cell {
    display: flex;
    align-items: center;
    gap: 14px;
}

.contact-avatar {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-hover));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
    flex-shrink: 0;
    border: 1px solid var(--border-subtle);
}

.contact-info { min-width: 0; }

.contact-name {
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-email {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.action-buttons {
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}

.action-buttons .btn {
    flex-shrink: 0;
}

/* ========================================
   STATUS BADGES
======================================== */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.status-new { background: rgba(59,130,246,0.12); color: var(--status-new); }
.status-new .status-dot { background: var(--status-new); }
.status-pending { background: rgba(245,158,11,0.12); color: var(--status-pending); }
.status-pending .status-dot { background: var(--status-pending); }
.status-contacted { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.status-contacted .status-dot { background: var(--status-contacted); }
.status-closed { background: rgba(139,92,246,0.12); color: var(--status-closed); }
.status-closed .status-dot { background: var(--status-closed); }
.status-lost, .status-churned, .status-cancelled { background: rgba(239,68,68,0.12); color: var(--status-lost); }
.status-lost .status-dot, .status-churned .status-dot, .status-cancelled .status-dot { background: var(--status-lost); }
.status-onboarding { background: rgba(6,182,212,0.12); color: #06b6d4; }
.status-onboarding .status-dot { background: #06b6d4; }
.status-in-progress { background: rgba(59,130,246,0.12); color: var(--status-new); }
.status-in-progress .status-dot { background: var(--status-new); }
.status-review { background: rgba(245,158,11,0.12); color: var(--status-pending); }
.status-review .status-dot { background: var(--status-pending); }
.status-completed { background: rgba(16,185,129,0.12); color: var(--status-contacted); }
.status-completed .status-dot { background: var(--status-contacted); }
.status-on-hold { background: rgba(113,113,122,0.12); color: var(--text-muted); }
.status-on-hold .status-dot { background: var(--text-muted); }
.status-draft { background: rgba(113,113,122,0.12); color: var(--status-draft); }
.status-draft .status-dot { background: var(--status-draft); }
.status-sent { background: rgba(59,130,246,0.12); color: var(--status-sent); }
.status-sent .status-dot { background: var(--status-sent); }
.status-paid { background: rgba(16,185,129,0.12); color: var(--status-paid); }
.status-paid .status-dot { background: var(--status-paid); }
.status-overdue { background: rgba(239,68,68,0.12); color: var(--status-overdue); }
.status-overdue .status-dot { background: var(--status-overdue); }

.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
}

.priority-high { background: rgba(239,68,68,0.15); color: #ef4444; font-weight: 700; }
.priority-medium { background: rgba(212,165,116,0.15); color: #D4A574; font-weight: 700; }
.priority-low { background: rgba(113,113,122,0.15); color: #71717a; font-weight: 700; }

/* ========================================
   TABLE ACTIONS
======================================== */
.table-actions {
    display: flex;
    gap: 6px;
}

.table-action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
}

.table-action-btn:hover {
    background: var(--bg-hover);
    border-color: var(--border-default);
    color: var(--text-primary);
}

.table-action-btn.danger:hover {
    background: rgba(239,68,68,0.12);
    border-color: var(--status-lost);
    color: var(--status-lost);
}

.table-action-btn svg { width: 14px; height: 14px; }

.table-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-top: 1px solid var(--border-subtle);
    background: var(--bg-secondary);
}

.table-info {
    font-size: 13px;
    color: var(--text-muted);
}

/* ========================================
   EMPTY STATE
======================================== */
.empty-state {
    padding: 80px 24px;
    text-align: center;
}

.empty-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 20px;
    color: var(--text-faint);
    opacity: 0.5;
}

.empty-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.empty-description {
    font-size: 14px;
    color: var(--text-muted);
    max-width: 320px;
    margin: 0 auto;
}

/* ========================================
   MODAL
======================================== */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 200;
    align-items: flex-start;
    justify-content: center;
    padding: 48px 24px;
    overflow-y: auto;
}

.modal-overlay.active { display: flex; }

.modal {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 800px;
    box-shadow: var(--shadow-lg), var(--shadow-glow);
    animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal.wide { max-width: 1100px; }

@keyframes modalSlide {
    from { opacity: 0; transform: translateY(-24px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 28px;
    border-bottom: 1px solid var(--border-subtle);
}

.modal-title {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 12px;
}

.modal-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: var(--accent-amber);
    border-radius: 2px;
}

.modal-close {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-hover);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-default);
}

.modal-body {
    padding: 28px;
    max-height: calc(100vh - 280px);
    overflow-y: auto;
}

.modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 28px;
    border-top: 1px solid var(--border-subtle);
    background: var(--bg-secondary);
    border-radius: 0 0 var(--radius-xl) var(--radius-xl);
}

/* ========================================
   FORM ELEMENTS
======================================== */
.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width { grid-column: 1 / -1; }

.form-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-label .required { color: var(--status-lost); }

.form-input,
.form-select,
.form-textarea {
    padding: 12px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px var(--accent-amber-dim);
}

.form-input::placeholder,
.form-textarea::placeholder { color: var(--text-muted); }

.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 40px;
}

.form-textarea {
    min-height: 120px;
    resize: vertical;
}

/* ========================================
   DETAIL SECTIONS
======================================== */
.detail-section {
    margin-bottom: 28px;
}

.detail-section:last-child { margin-bottom: 0; }

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 18px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-subtle);
}

.section-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent-amber);
}

.section-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border-subtle), transparent);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.detail-item {
    background: var(--bg-tertiary);
    padding: 14px 16px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.detail-item.full-width { grid-column: 1 / -1; }

.detail-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 6px;
}

.detail-value {
    font-size: 14px;
    color: var(--text-primary);
    word-break: break-word;
}

/* ========================================
   NOTES
======================================== */
.notes-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 18px;
    max-height: 320px;
    overflow-y: auto;
}

.note-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-left: 3px solid var(--accent-amber);
    border-radius: var(--radius-md);
    padding: 14px 16px;
}

.note-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.note-author {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
}

.note-date {
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--font-mono);
}

.note-text {
    font-size: 13px;
    color: var(--text-primary);
    line-height: 1.7;
}

.note-empty {
    text-align: center;
    padding: 32px;
    color: var(--text-muted);
    font-size: 14px;
}

/* ========================================
   EXPENSE SECTION
======================================== */
.expense-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 18px;
    max-height: 400px;
    overflow-y: auto;
}

.expense-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.expense-item:hover {
    border-color: var(--border-default);
    background: var(--bg-hover);
}

.expense-item.selected {
    border-color: var(--accent-amber);
    background: var(--accent-amber-dim);
}

.expense-checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid var(--border-strong);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.expense-checkbox:hover { border-color: var(--accent-amber); }

.expense-checkbox.checked {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.expense-checkbox svg {
    width: 14px;
    height: 14px;
    color: var(--bg-void);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.expense-checkbox.checked svg { opacity: 1; }

.expense-content { flex: 1; min-width: 0; }

.expense-description {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.expense-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: var(--text-muted);
}

.expense-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.expense-amount {
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-amber);
    font-family: var(--font-mono);
    white-space: nowrap;
}

.expense-actions {
    display: flex;
    gap: 6px;
}

.expense-empty {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    font-size: 14px;
}

/* ========================================
   INVOICE PREVIEW
======================================== */
.invoice-preview {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.invoice-preview-header {
    padding: 32px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.invoice-company {
    display: flex;
    align-items: center;
    gap: 16px;
}

.invoice-company-logo {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--accent-amber), var(--accent-rust));
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.invoice-company-logo svg {
    width: 28px;
    height: 28px;
    color: var(--bg-void);
}

.invoice-company-name {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.invoice-company-tagline {
    font-size: 12px;
    color: var(--text-muted);
}

.invoice-info {
    text-align: right;
}

.invoice-title {
    font-size: 32px;
    font-weight: 800;
    color: var(--accent-amber);
    letter-spacing: -0.02em;
    margin-bottom: 8px;
}

.invoice-number {
    font-size: 14px;
    color: var(--text-secondary);
    font-family: var(--font-mono);
}

.invoice-preview-body { padding: 32px; }

.invoice-parties {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 32px;
    margin-bottom: 32px;
}

.invoice-party-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 12px;
}

.invoice-party-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.invoice-party-details {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.7;
}

.invoice-dates {
    display: flex;
    gap: 32px;
    margin-bottom: 32px;
}

.invoice-date-item {
    background: var(--bg-tertiary);
    padding: 14px 20px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.invoice-date-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.invoice-date-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.invoice-items-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
}

.invoice-items-table th {
    text-align: left;
    padding: 14px 16px;
    background: var(--bg-tertiary);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-items-table th:last-child { text-align: right; }

.invoice-items-table td {
    padding: 16px;
    font-size: 14px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-items-table td:last-child {
    text-align: right;
    font-family: var(--font-mono);
    font-weight: 600;
}

.invoice-items-table tbody tr:hover { background: var(--bg-hover); }

.invoice-totals {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
}

.invoice-total-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 280px;
    padding: 10px 0;
}

.invoice-total-label {
    font-size: 13px;
    color: var(--text-secondary);
}

.invoice-total-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.invoice-total-row.grand {
    border-top: 2px solid var(--accent-amber);
    margin-top: 8px;
    padding-top: 16px;
}

.invoice-total-row.grand .invoice-total-label {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}

.invoice-total-row.grand .invoice-total-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-amber);
}

.invoice-preview-footer {
    padding: 24px 32px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-subtle);
}

/* Invoice Preview Improvements */
.invoice-preview {
    border-top: 4px solid var(--accent-amber);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.invoice-preview-header {
    padding: 40px 32px;
    background: var(--bg-tertiary);
}

.invoice-company-logo {
    width: 64px;
    height: 64px;
}

.invoice-company-logo svg {
    width: 32px;
    height: 32px;
}

.invoice-number {
    font-size: 16px;
    letter-spacing: 0.05em;
}

.invoice-items-table th {
    font-size: 11px;
    color: var(--accent-amber);
}

.invoice-items-table td {
    font-size: 15px;
}

.invoice-items-table tbody tr:hover {
    background: rgba(245,158,11,0.03);
}

.invoice-totals {
    background: var(--bg-tertiary);
    padding: 24px;
    border-radius: var(--radius-md);
    margin-top: 20px;
    border-top: 2px solid var(--border-subtle);
    padding-top: 24px;
}

.invoice-total-row.grand .invoice-total-value {
    font-size: 32px;
}

.invoice-notes-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.invoice-notes-text {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.7;
}

/* ========================================
   CARDS GRID (Employees/Invoices)
======================================== */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.card:hover {
    border-color: var(--border-default);
    transform: translateY(-4px);
    box-shadow: var(--shadow-glow);
}

.employee-card .card-header {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 20px;
}

.employee-avatar-lg {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, var(--accent-amber), var(--accent-rust));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: var(--bg-void);
    flex-shrink: 0;
}

.employee-details { flex: 1; min-width: 0; }

.employee-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.employee-role {
    font-size: 13px;
    color: var(--accent-amber);
    font-weight: 600;
}

.employee-meta {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.employee-meta-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: var(--text-secondary);
}

.employee-meta-item svg {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
}

.employee-stats {
    display: flex;
    gap: 16px;
    padding-top: 20px;
    border-top: 1px solid var(--border-subtle);
}

.employee-stat {
    flex: 1;
    text-align: center;
}

.employee-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.employee-stat-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.card-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.card-actions .btn { flex: 1; }

/* ========================================
   INVOICE CARDS
======================================== */
/* Invoice Card Improvements */
.invoice-card {
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.invoice-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--text-primary), var(--text-secondary));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.invoice-card:hover::before {
    opacity: 1;
}

.invoice-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-subtle);
}

.invoice-card-number {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
    letter-spacing: 0.02em;
}

.invoice-card-customer {
    font-size: 14px;
    color: var(--text-secondary);
    margin-top: 6px;
}

.invoice-card-amount {
    font-size: 32px;
    font-weight: 800;
    color: var(--text-primary);
    font-family: var(--font-mono);
    margin-bottom: 20px;
    letter-spacing: -0.02em;
}

.invoice-card-meta {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-subtle);
}

.invoice-card-meta-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
    background: var(--bg-secondary);
    padding: 12px 14px;
    border-radius: var(--radius-sm);
}

.invoice-card-meta-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
}

.invoice-card-meta-value {
    font-size: 14px;
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-weight: 600;
}

.invoice-card:hover .invoice-card-amount {
    color: var(--text-primary);
}

/* ========================================
   ANALYTICS
======================================== */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
}

.analytics-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 28px;
}

.analytics-card.full-width { grid-column: 1 / -1; }

.analytics-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
}

.analytics-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
}

.chart-container {
    height: 220px;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    padding-top: 24px;
}

.chart-bar {
    flex: 1;
    background: linear-gradient(180deg, var(--accent-amber-dim) 0%, rgba(245,158,11,0.05) 100%);
    border-radius: 6px 6px 0 0;
    position: relative;
    min-height: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--accent-amber-dim);
    border-bottom: none;
}

.chart-bar:hover {
    background: linear-gradient(180deg, var(--accent-amber) 0%, var(--accent-amber-dim) 100%);
    border-color: var(--accent-amber);
}

.chart-bar-label {
    position: absolute;
    bottom: -28px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: var(--text-muted);
    white-space: nowrap;
    font-weight: 500;
}

.chart-bar-value {
    position: absolute;
    top: -24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent-amber);
    font-family: var(--font-mono);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.chart-bar:hover .chart-bar-value { opacity: 1; }

.metrics-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.metric-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.metric-label {
    font-size: 13px;
    color: var(--text-secondary);
}

.metric-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: var(--font-mono);
}

.progress-bar {
    height: 8px;
    background: var(--bg-hover);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-amber), var(--accent-rust));
    border-radius: 4px;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Toast Container */
#toastContainer {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 12px;
    pointer-events: none;
}

/* Toast Base */
.toast {
    min-width: 320px;
    max-width: 480px;
    background: var(--bg-elevated);
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 12px;
    pointer-events: auto;
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid transparent;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Toast Icon */
.toast-icon {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Toast Message */
.toast-message {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    line-height: 1.5;
    color: var(--text-primary);
}

/* Toast Close Button */
.toast-close {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    color: var(--text-muted);
    transition: all 0.2s;
    border-radius: 6px;
}

.toast-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

/* Toast Types */
.toast.success {
    border-left-color: #10b981;
}

.toast.success .toast-icon {
    color: #10b981;
}

.toast.error {
    border-left-color: #ef4444;
}

.toast.error .toast-icon {
    color: #ef4444;
}

.toast.warning {
    border-left-color: #f59e0b;
}

.toast.warning .toast-icon {
    color: #f59e0b;
}

.toast.info {
    border-left-color: #3b82f6;
}

.toast.info .toast-icon {
    color: #3b82f6;
}

/* Progress Bar */
.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: currentColor;
    opacity: 0.3;
    animation: progress 5s linear forwards;
}

@keyframes progress {
    from {
        width: 100%;
    }
    to {
        width: 0%;
    }
}

/* ========================================
   SETTINGS
======================================== */
.settings-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 32px;
}

.settings-nav {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.settings-nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
}

.settings-nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.settings-nav-item.active {
    background: var(--accent-amber-dim);
    color: var(--accent-amber);
}

.settings-nav-item svg { width: 18px; height: 18px; }

.settings-panel {
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 28px;
}

.settings-section { margin-bottom: 36px; }
.settings-section:last-child { margin-bottom: 0; }

.settings-section-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 6px;
}

.settings-section-desc {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 24px;
}

.setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 0;
    border-bottom: 1px solid var(--border-subtle);
}

.setting-row:last-child { border-bottom: none; }

.setting-info { flex: 1; }

.setting-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.setting-desc {
    font-size: 13px;
    color: var(--text-muted);
}

.toggle {
    position: relative;
    width: 50px;
    height: 28px;
}

.toggle input { opacity: 0; width: 0; height: 0; }

.toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--bg-hover);
    border: 1px solid var(--border-default);
    border-radius: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.toggle-slider::before {
    content: '';
    position: absolute;
    height: 22px;
    width: 22px;
    left: 2px;
    bottom: 2px;
    background: var(--text-secondary);
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.toggle input:checked + .toggle-slider {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.toggle input:checked + .toggle-slider::before {
    transform: translateX(22px);
    background: var(--bg-void);
}

/* ========================================
   TASKS
======================================== */
.tasks-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.task-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 20px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.task-item:hover { border-color: var(--border-default); }

.task-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border-strong);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.task-checkbox:hover { border-color: var(--accent-amber); }

.task-checkbox.checked {
    background: var(--accent-amber);
    border-color: var(--accent-amber);
}

.task-checkbox svg {
    width: 14px;
    height: 14px;
    color: var(--bg-void);
    opacity: 0;
}

.task-checkbox.checked svg { opacity: 1; }

.task-content { flex: 1; min-width: 0; }

.task-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 6px;
}

.task-item.completed .task-title {
    text-decoration: line-through;
    color: var(--text-muted);
}

.task-meta {
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 12px;
    color: var(--text-muted);
}

.task-due {
    display: flex;
    align-items: center;
    gap: 6px;
}

.task-due.overdue { color: var(--status-lost); }

.category-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.category-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f3f4f6;
}

.category-header h3 {
    margin: 0 0 8px 0;
    font-size: 20px;
}

.leads-list {
    margin-top: 16px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
}

.empty-state i {
    margin-bottom: 20px;
}

.empty-state h3 {
    margin: 0 0 12px 0;
    color: #111827;
}

.empty-state p {
    margin: 0;
    color: #6b7280;
}

/* ========================================
   TOAST NOTIFICATIONS
======================================== */
.toast-container {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 300;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 20px;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    animation: toastSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 320px;
}

@keyframes toastSlide {
    from { opacity: 0; transform: translateX(100%) scale(0.95); }
    to { opacity: 1; transform: translateX(0) scale(1); }
}

.toast-icon {
    width: 22px;
    height: 22px;
    flex-shrink: 0;
}

.toast.success .toast-icon { color: var(--status-contacted); }
.toast.error .toast-icon { color: var(--status-lost); }
.toast.warning .toast-icon { color: var(--status-pending); }

.toast-message {
    font-size: 14px;
    color: var(--text-primary);
    flex: 1;
}

.toast-close {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.toast-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

/* ========================================
   TABS
======================================== */
.tabs {
    display: flex;
    gap: 4px;
    background: var(--bg-primary);
    padding: 5px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
    margin-bottom: 24px;
}

.tab {
    padding: 10px 20px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tab:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.tab.active {
    background: var(--accent-amber);
    color: var(--bg-void);
}

/* Employee Cards */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
}

.card h3 {
    margin: 0 0 15px 0;
    color: #1f2937;
}

.card p {
    margin: 8px 0;
    color: #6b7280;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-secondary {
    background: #6b7280;
}

.btn-danger {
    background: #ef4444;
    margin-left: 8px;
}

.btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    padding: 4px 8px;
}

.btn-icon:hover {
    opacity: 0.7;
}

/* Client Portal Styles */
.uploads-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    padding: 24px;
}

.file-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    padding: 20px;
    border-radius: var(--radius-lg);
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.file-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

.file-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.file-name {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    word-break: break-word;
}

.file-meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
    color: var(--text-muted);
}

.form-section {
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
}

.form-row {
    display: grid;
    gap: 12px;
}

.milestone-field {
    position: relative;
    padding: 16px;
    background: var(--bg-hover);
    border-radius: var(--radius-sm);
    margin-bottom: 12px;
}

.milestone-field:hover {
    background: var(--bg-elevated);
}

/* Form input styles */
input[type="text"],
input[type="number"],
input[type="date"],
select,
textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: inherit;
    background: var(--bg-primary);
    color: var(--text-primary);
    transition: border-color 0.2s ease;
}

input[type="text"]:focus,
input[type="number"]:focus,
input[type="date"]:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: var(--accent-primary);
}

input[type="text"]::placeholder,
input[type="number"]::placeholder,
textarea::placeholder {
    color: var(--text-muted);
}

.ticket-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--border-default) !important;
}

#createModal .tab {
    padding: 8px 16px;
    background: var(--bg-hover);
    color: var(--text-primary);
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}

#createModal .tab.active {
    background: var(--accent-amber);
    color: white;
}

#createModal .tab:hover:not(.active) {
    background: var(--bg-secondary);
}

/* ========================================
   RESPONSIVE
======================================== */
@media (max-width: 1200px) {
    .analytics-grid { grid-template-columns: 1fr; }
    .settings-layout { grid-template-columns: 1fr; }
    .settings-nav { flex-direction: row; flex-wrap: wrap; }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    .sidebar.active { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .topbar { padding: 0 20px; }
    .content { padding: 24px; }
    .form-grid,
    .detail-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .controls-bar {
        flex-direction: column;
        align-items: stretch;
    }
    .search-box { min-width: 100%; }
    .invoice-parties { grid-template-columns: 1fr; }
    .modal { margin: 16px; }
}

/* ========================================
   PRINT STYLES (for invoices)
======================================== */
@media print {
    body {
        background: white !important;
        color: black !important;
    }
    .sidebar,
    .topbar,
    .modal-overlay,
    .toast-container,
    .btn { display: none !important; }
    .main-content { margin-left: 0 !important; }
    .invoice-preview {
        background: white !important;
        border: none !important;
        box-shadow: none !important;
    }
}
/* ========================================
   LIGHT MODE OVERRIDES
======================================== */
body.light-mode {
    background: #f5f5f7;
}

body.light-mode .sidebar {
    background: #ffffff;
    border-right-color: rgba(0,0,0,0.08);
}

body.light-mode .sidebar::before {
    background: linear-gradient(180deg, var(--accent-amber) 0%, transparent 50%, var(--accent-amber) 100%);
}

body.light-mode .topbar {
    background: rgba(255,255,255,0.9);
    border-bottom-color: rgba(0,0,0,0.08);
}

body.light-mode .logo-title {
    background: linear-gradient(135deg, #1a1a1a 0%, var(--accent-amber) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

body.light-mode .stat-value {
    background: linear-gradient(135deg, #1a1a1a 0%, #495057 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

body.light-mode .data-table thead {
    background: #f8f9fa;
}

body.light-mode .modal {
    background: #ffffff;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
}

body.light-mode .modal-footer {
    background: #f8f9fa;
}

body.light-mode .invoice-preview {
    background: #ffffff;
}

body.light-mode .invoice-preview-header {
    background: #f8f9fa;
}

body.light-mode .form-input,
body.light-mode .form-select,
body.light-mode .form-textarea {
    background: #ffffff;
    border-color: rgba(0,0,0,0.15);
    color: #1a1a1a;
}

body.light-mode .form-input:focus,
body.light-mode .form-select:focus,
body.light-mode .form-textarea:focus {
    border-color: var(--accent-amber);
    box-shadow: 0 0 0 3px rgba(245,158,11,0.15);
}

body.light-mode .search-input {
    background: #ffffff;
    border-color: rgba(0,0,0,0.12);
}

body.light-mode .filter-group {
    background: #ffffff;
    border-color: rgba(0,0,0,0.12);
}

body.light-mode .toast {
    background: #ffffff;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

body.light-mode ::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
}

body.light-mode ::-webkit-scrollbar-thumb:hover {
    background: var(--accent-amber);
}
/* ========================================
   MOBILE RESPONSIVE STYLES
   Add these styles to your existing <style> section
======================================== */

/* Mobile-specific CSS variables */
@media (max-width: 768px) {
    :root {
        --sidebar-width: 100%;
        --topbar-height: 60px;
    }
}

/* ========================================
   MOBILE LAYOUT ADJUSTMENTS
======================================== */

/* Hamburger Menu Button */
.mobile-menu-toggle {
    display: none;
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 10001;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 20px;
    line-height: 1;
    transition: var(--transition-fast);
}

.mobile-menu-toggle:hover {
    background: var(--bg-hover);
    border-color: var(--border-accent);
}

/* Sidebar Mobile Adjustments */
@media (max-width: 768px) {
    .mobile-menu-toggle {
        display: block;
    }

    .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        width: 280px;
        height: 100vh;
        z-index: 10000;
        transition: left var(--transition-base);
        box-shadow: var(--shadow-xl);
    }

    .sidebar.mobile-open {
        left: 0;
    }

    /* Overlay for mobile sidebar */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
    }

    .sidebar-overlay.active {
        display: block;
    }

    /* Main content adjustments */
    .main-content {
        margin-left: 0 !important;
        padding-left: 0 !important;
        width: 100% !important;
    }

    .topbar {
        left: 0 !important;
        width: 100% !important;
        padding: 12px 60px 12px 20px;
    }

    .content-wrapper {
        padding: 80px 16px 20px 16px !important;
    }
}

/* ========================================
   RESPONSIVE GRID LAYOUTS
======================================== */

@media (max-width: 1200px) {
    /* Stats grid: 2 columns on tablets */
    .stats-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

@media (max-width: 768px) {
    /* Stats grid: 1 column on mobile */
    .stats-grid {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }

    /* Cards grid adjustments */
    .cards-grid,
    .grid-2,
    .grid-3,
    .grid-4 {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }

    /* Form grids */
    .form-grid {
        grid-template-columns: 1fr !important;
    }
}

/* ========================================
   TABLE RESPONSIVENESS
======================================== */

@media (max-width: 768px) {
    /* Make tables horizontally scrollable */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px;
        padding: 0 16px;
    }

    table {
        min-width: 600px;
        font-size: 13px;
    }

    table th,
    table td {
        padding: 10px 8px !important;
        white-space: nowrap;
    }

    /* Alternative: Card-style table for very small screens */
    @media (max-width: 480px) {
        .table-responsive {
            display: block;
        }

        .table-responsive thead {
            display: none;
        }

        .table-responsive tbody,
        .table-responsive tr,
        .table-responsive td {
            display: block;
            width: 100%;
        }

        .table-responsive tr {
            margin-bottom: 16px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 12px;
            background: var(--bg-card);
        }

        .table-responsive td {
            text-align: right;
            padding: 8px 0 !important;
            border: none !important;
            position: relative;
            padding-left: 50% !important;
        }

        .table-responsive td:before {
            content: attr(data-label);
            position: absolute;
            left: 0;
            width: 45%;
            padding-right: 10px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
        }
    }
}

/* ========================================
   MODAL RESPONSIVENESS
======================================== */

@media (max-width: 768px) {
    .modal-content {
        width: 95% !important;
        max-width: 95% !important;
        margin: 20px auto !important;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }

    .modal-header {
        padding: 16px !important;
    }

    .modal-body {
        padding: 16px !important;
    }

    .modal-footer {
        padding: 16px !important;
        flex-direction: column;
        gap: 8px;
    }

    .modal-footer button {
        width: 100%;
    }
}

/* ========================================
   FORM RESPONSIVENESS
======================================== */

@media (max-width: 768px) {
    /* Stack form fields vertically */
    .form-row {
        flex-direction: column !important;
        gap: 12px !important;
    }

    .form-group {
        width: 100% !important;
    }

    /* Full width inputs */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
        width: 100% !important;
        font-size: 16px !important; /* Prevents zoom on iOS */
    }

    /* Button groups */
    .btn-group {
        flex-direction: column !important;
        width: 100%;
    }

    .btn-group button {
        width: 100% !important;
        margin: 4px 0 !important;
    }
}

/* ========================================
   CARD RESPONSIVENESS
======================================== */

@media (max-width: 768px) {
    .card {
        padding: 16px !important;
    }

    .card-header {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 12px !important;
    }

    .card-header-actions {
        width: 100%;
        justify-content: flex-start;
    }
}

/* ========================================
   TYPOGRAPHY ADJUSTMENTS
======================================== */

@media (max-width: 768px) {
    h1 { font-size: 24px !important; }
    h2 { font-size: 20px !important; }
    h3 { font-size: 18px !important; }
    h4 { font-size: 16px !important; }
    h5 { font-size: 14px !important; }
    
    body {
        font-size: 14px !important;
    }

    .page-title {
        font-size: 24px !important;
    }

    .page-subtitle {
        font-size: 13px !important;
    }
}

/* ========================================
   DASHBOARD-SPECIFIC ADJUSTMENTS
======================================== */

@media (max-width: 768px) {
    /* Chart containers */
    .chart-container {
        height: 250px !important;
    }

    /* Timeline items */
    .timeline-item {
        padding-left: 20px !important;
    }

    /* Activity feed */
    .activity-item {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px !important;
    }

    /* User avatar lists */
    .avatar-group .avatar {
        width: 32px !important;
        height: 32px !important;
    }
}

/* ========================================
   UTILITY CLASSES FOR MOBILE
======================================== */

/* Hide on mobile */
@media (max-width: 768px) {
    .hide-mobile {
        display: none !important;
    }
}

/* Show only on mobile */
.show-mobile {
    display: none !important;
}

@media (max-width: 768px) {
    .show-mobile {
        display: block !important;
    }
}

/* Text alignment on mobile */
@media (max-width: 768px) {
    .mobile-text-center {
        text-align: center !important;
    }

    .mobile-text-left {
        text-align: left !important;
    }
}

/* ========================================
   TOUCH-FRIENDLY IMPROVEMENTS
======================================== */

@media (max-width: 768px) {
    /* Increase touch targets */
    button,
    .btn,
    a.btn,
    .clickable {
        min-height: 44px;
        padding: 12px 20px;
    }

    /* Better spacing for touch */
    .action-buttons {
        gap: 12px !important;
    }

    /* Larger checkboxes and radio buttons */
    input[type="checkbox"],
    input[type="radio"] {
        width: 20px;
        height: 20px;
    }
}

/* ========================================
   ORIENTATION HANDLING
======================================== */

@media (max-width: 768px) and (orientation: landscape) {
    .modal-content {
        max-height: calc(100vh - 20px);
    }

    .sidebar {
        width: 240px;
    }
}

/* ========================================
   QR CODE MOBILE ADJUSTMENTS
======================================== */

@media (max-width: 768px) {
    .qr-code-section {
        padding: 16px;
    }

    .qr-code-container {
        padding: 15px;
        max-width: 100%;
    }

    .qr-code-container canvas {
        max-width: 100%;
        height: auto !important;
    }
}

/* ========================================
   PAGINATION MOBILE
======================================== */

@media (max-width: 768px) {
    .pagination {
        flex-wrap: wrap;
        gap: 6px;
    }

    .pagination button {
        min-width: 36px;
        padding: 8px 10px;
        font-size: 13px;
    }
}

/* ========================================
   FILTER/SEARCH BARS MOBILE
======================================== */

@media (max-width: 768px) {
    .filters-row,
    .search-bar-container {
        flex-direction: column !important;
        gap: 12px !important;
    }

    .search-input,
    .filter-select {
        width: 100% !important;
    }
}

/* ========================================
   TAB NAVIGATION MOBILE
======================================== */

@media (max-width: 768px) {
    .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .tabs::-webkit-scrollbar {
        display: none;
    }

    .tab-button {
        flex-shrink: 0;
        white-space: nowrap;
        font-size: 13px;
        padding: 10px 16px;
    }
}

/* ========================================
   PROFILE/SETTINGS PAGES
======================================== */

@media (max-width: 768px) {
    .profile-header {
        flex-direction: column !important;
        text-align: center;
    }

    .profile-avatar {
        margin: 0 auto 16px !important;
    }

    .settings-grid {
        grid-template-columns: 1fr !important;
    }
}
    </style>
</head>
<body>
<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <div class="logo-mark">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div class="logo-text">
                <div class="logo-title">DIAMONDBACK</div>
                <div class="logo-subtitle">Admin Portal</div>
            </div>
        </div>
    </div>
    
    <nav class="sidebar-nav">
        <!--  Overview  -->
        <div class="nav-section">
            <div class="nav-section-title">Overview</div>
            <div class="nav-item active" data-section="dashboard">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
                Dashboard
            </div>
            <div class="nav-item" data-section="analytics">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>
                </svg>
                Analytics
            </div>
        </div>

        <!--  Leads & Outreach  -->
        <div class="nav-section">
            <div class="nav-section-title">Leads &amp; Outreach</div>
            <div class="nav-item" data-section="leads">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                All Leads
                <span class="nav-badge" id="leadsBadge">0</span>
            </div>
            <div class="nav-item" data-section="new">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                New
                <span class="nav-badge" id="newBadge">0</span>
            </div>
            <div class="nav-item" data-section="pending">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
                Pending
                <span class="nav-badge" id="pendingBadge">0</span>
            </div>
            <div class="nav-item" data-section="contacted">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
                </svg>
                Contacted
            </div>
            <div class="nav-item" data-section="followups">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
                Follow Ups
                <span class="nav-badge" id="followupsBadge">0</span>
            </div>
            <div class="nav-item" data-section="pipeline">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                Sales Pipeline
            </div>
            <div class="nav-item" data-section="lead-scoring">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Lead Scoring
            </div>
        </div>

        <!--  Clients & Revenue  -->
        <div class="nav-section">
            <div class="nav-section-title">Clients &amp; Revenue</div>
            <div class="nav-item" data-section="customers">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                Customers
                <span class="nav-badge" id="customersBadge">0</span>
            </div>
            <div class="nav-item" data-section="clientPortal">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
                </svg>
                Client Portal
                <span class="nav-badge" id="clientPortalBadge">0</span>
            </div>
            <div class="nav-item" data-section="invoices">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                </svg>
                Invoices
                <span class="nav-badge" id="invoicesBadge">0</span>
            </div>
        </div>

        <!--  Projects & Work  -->
        <div class="nav-section">
            <div class="nav-section-title">Projects &amp; Work</div>
            <div class="nav-item" data-section="projects">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                </svg>
                Project Timelines
            </div>
            <div class="nav-item" data-section="tasks">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                Tasks
            </div>
            <div class="nav-item" data-section="documents">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                </svg>
                Documents
            </div>
        </div>

        <!--  Operations  -->
        <div class="nav-section">
            <div class="nav-section-title">Operations</div>
            <div class="nav-item" data-section="employees">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
                Team
            </div>
            <div class="nav-item" data-section="support">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Support Tickets
            </div>
            <div class="nav-item" data-section="recruitment">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Recruitment
            </div>
            <div class="nav-item" data-section="scoring-rules">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m5.196-15.804l-4.243 4.242m-6.364 6.364l-4.243 4.242m15.804 0l-4.242-4.242m-6.364-6.364l-4.242-4.242"/>
                </svg>
                Scoring Rules
            </div>
            <div class="nav-item" data-section="settings">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </div>
        </div>
    </nav>
    
    <div class="sidebar-footer">
        <div class="user-card" onclick="logout()">
            <div class="user-avatar">AD</div>
            <div class="user-info">
                <div class="user-name">Admin User</div>
                <div class="user-role">Administrator</div>
            </div>
            <svg class="logout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
        </div>
    </div>
</aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="topbar">
            <div class="page-header">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="topbar-actions">
                <button class="btn btn-secondary" onclick="openExportModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                </button>
                <button class="btn btn-primary" onclick="openCreateModal('lead')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Lead
                </button>
            </div>
        </header>
        
        <div class="content" id="contentArea">
            <!-- Content will be dynamically loaded -->
        </div>
    </main>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title" id="detailModalTitle">Lead Details</h2>
                <button class="modal-close" onclick="closeDetailModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="detailModalBody"></div>
            <div class="modal-footer" id="detailModalFooter"></div>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="createModalTitle">Create Lead</h2>
                <button class="modal-close" onclick="closeCreateModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="createModalBody"></div>
        </div>
    </div>

<!-- ==================== FOLLOW UPS SECTION ==================== -->
<div id="followUpsSection" class="content-section" style="display: none;">
    <div class="section-header">
        <div>
            <h2>Follow Ups</h2>
            <p class="section-subtitle">Manage and track lead follow-ups by category</p>
        </div>
        <div class="header-actions">
            <button class="btn-secondary" onclick="refreshFollowUps()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div id="followUpStats" class="stats-grid" style="margin-bottom: 30px;">
        <div class="stat-card">
            <div class="stat-icon" style="background: #f59e0b;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Total Pending</div>
                <div class="stat-value">0</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #ef4444;">
                <i class="fas fa-user-times"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Never Contacted</div>
                <div class="stat-value">0</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #10b981;">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">1-3 Days</div>
                <div class="stat-value">0</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #f97316;">
                <i class="fas fa-calendar-week"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">3-7 Days</div>
                <div class="stat-value">0</div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title" id="invoiceModalTitle">Create Invoice</h2>
                <button class="modal-close" onclick="closeInvoiceModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="invoiceModalBody"></div>
            <div class="modal-footer" id="invoiceModalFooter"></div>
        </div>
    </div>

    <!-- Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Record Payment</h2>
            <button class="modal-close" onclick="closePaymentModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body" id="paymentModalBody"></div>
    </div>
</div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
// ========================================
// STATE & CONFIGURATION
// ========================================
const API_URL = window.location.origin;
const API_BASE = API_URL; // Add this
const FRONTEND_BASE_URL = 'https://diamondbackcoding.com';
let authToken = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken') || localStorage.getItem('token') || sessionStorage.getItem('token');

// Helper function to get the current auth token
function getAuthToken() {
    // Check state first (fastest)
    if (state.authToken) {
        return state.authToken;
    }
    
    // Then check storage and cache it
    const token = localStorage.getItem('adminToken') || 
                  sessionStorage.getItem('adminToken') || 
                  localStorage.getItem('token') || 
                  sessionStorage.getItem('token') ||
                  authToken;
    
    if (token) {
        state.authToken = token; // Cache in state
        authToken = token; // Update global variable too
    }
    
    return token;
}

// Service Packages will be defined later but we need placeholder
let servicePackages = {};

const state = {
    leads: [],
    customers: [],
    employees: [],
    invoices: [],
    tasks: [],
    tickets: [], // Make sure this exists
    currentSection: 'dashboard',
    currentSettingsTab: 'profile',
    searchTerm: '',
    currentFilter: 'all',
    currentLead: null,
    currentInvoice: null,
    selectedExpenses: [],
    searchQuery: '',
    clientAccounts: [],
    clientUploads: [],
    currentClient: null,
    authToken: null, //  ADD THIS LINE
    settings: {
        emailNotifications: true,
        pushNotifications: false,
        darkMode: true,
        autoAssign: false,
        weeklyReport: true,
        sessionTimeout: 30,
        twoFactorAuth: false,
        ipWhitelistEnabled: false,
        ipWhitelist: []
    }
};

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', async function() {
    state.authToken = authToken;
    
    if (!authToken) {
        window.location.href = '/admin';
        return;
    }
    
    try {
        const r = await fetch(`${API_URL}/api/admin/verify`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            localStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminToken');
            window.location.href = '/admin';
            return;
        }
    } catch (e) {
        console.error('Token verification failed:', e);
        window.location.href = '/admin';
        return;
    }
    
    await loadAllData();
loadSettings();  // ADD THIS LINE
setupNavigation();
renderSection('dashboard');
});

// ========================================
// DATA LOADING
// ========================================
async function loadAllData() {
    await Promise.all([
        loadLeads(),
        loadEmployees(),
        loadInvoices(),
        loadTasks()
    ]);
    updateBadges();
}

async function loadLeads() {
    try {
        const r = await fetch(`${API_URL}/api/leads`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (r.status === 401 || r.status === 403) {
            logout();
            return;
        }
        
        const d = await r.json();
        if (d.success) {
            state.leads = (d.leads || []).filter(l => !l.is_customer);
            state.customers = (d.leads || []).filter(l => l.is_customer);
        }
    } catch (e) {
        console.error('Error loading leads:', e);
    }
}

async function loadEmployees() {
    try {
        const r = await fetch(`${API_URL}/api/employees`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            console.error('Failed to load employees, status:', r.status);
            return;
        }
        
        const d = await r.json();
        console.log('Loaded employees:', d); // Debug log
        
        if (d.success) {
            state.employees = d.employees || [];
        }
    } catch (e) {
        console.error('Error loading employees:', e);
    }
}

async function loadInvoices() {
    try {
        const r = await fetch(`${API_URL}/api/invoices`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!r.ok) return;
        const d = await r.json();
        if (d.success) {
            state.invoices = (d.invoices || []).map(inv => {
                // Parse items if they're stored as JSON string
                if (typeof inv.items === 'string') {
                    try {
                        inv.items = JSON.parse(inv.items);
                    } catch (e) {
                        inv.items = [];
                    }
                }
                // Ensure customer name is set
                if (!inv.customer_name && inv.first_name) {
                    inv.customer_name = `${inv.first_name} ${inv.last_name || ''}`.trim();
                }
                if (!inv.customer_name && inv.name) {
                    inv.customer_name = inv.name;
                }
                if (!inv.customer_email && inv.email) {
                    inv.customer_email = inv.email;
                }
                if (!inv.customer_company && inv.company) {
                    inv.customer_company = inv.company;
                }
                return inv;
            });
        }
    } catch (e) {
        console.error('Error loading invoices:', e);
    }
}

async function loadTasks() {
    try {
        const r = await fetch(`${API_URL}/api/tasks`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!r.ok) {
            console.error('Failed to load tasks:', r.status);
            state.tasks = [];
            return;
        }
        const d = await r.json();
        if (d.success) {
            // Convert server format to frontend format
            state.tasks = (d.tasks || []).map(task => ({
                id: task.id,
                title: task.title,
                description: task.description,
                dueDate: task.due_date,
                assignee: task.assigned_name || 'Unassigned',
                assigned_to: task.assigned_to,
                priority: task.priority,
                completed: task.completed,
                status: task.status,
                created_at: task.created_at,
                completed_at: task.completed_at
            }));
        } else {
            state.tasks = [];
        }
    } catch (e) {
        console.error('Load tasks error:', e);
        state.tasks = [];
    }
}

async function loadExpenses(leadId) {
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/expenses?includeInvoiced=false`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!r.ok) return [];
        const d = await r.json();
        return d.success ? d.expenses || [] : [];
    } catch (e) {
        console.error('Error loading expenses:', e);
        return [];
    }
}

async function updateBadges() {
    const n = state.leads.filter(l => l.status === 'new').length;
    const p = state.leads.filter(l => l.status === 'pending').length;
    const unpaidInvoices = state.invoices.filter(i => i.status !== 'paid' && i.status !== 'cancelled').length;
    
    document.getElementById('leadsBadge').textContent = state.leads.length;
    document.getElementById('newBadge').textContent = n;
    document.getElementById('pendingBadge').textContent = p;
    document.getElementById('customersBadge').textContent = state.customers.length;
    document.getElementById('invoicesBadge').textContent = unpaidInvoices;

    // Fetch follow-ups count  uses same endpoint as the Follow-Ups page so badge always matches
    try {
        const res = await fetch(`${API_URL}/api/follow-ups/by-temperature`, {
            headers: { 'Authorization': `Bearer ${state.authToken}`, 'Content-Type': 'application/json' }
        });
        if (res.ok) {
            const data = await res.json();
            const hot = (data.data?.hot || []).length;
            const cold = (data.data?.cold || []).length;
            const badge = document.getElementById('followupsBadge');
            if (badge) badge.textContent = hot + cold;
        }
    } catch (e) { /* non-fatal */ }
}

/* ========================================
   MOBILE MENU JAVASCRIPT
   Add this to your existing <script> section
======================================== */

// Add this near the top of your JavaScript, after DOM content loads

// Mobile menu functionality
function initMobileMenu() {
    // Create mobile menu toggle button if it doesn't exist
    if (!document.querySelector('.mobile-menu-toggle')) {
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'mobile-menu-toggle';
        toggleBtn.innerHTML = '';
        toggleBtn.setAttribute('aria-label', 'Toggle menu');
        document.body.appendChild(toggleBtn);

        // Create overlay for mobile sidebar
        const overlay = document.createElement('div');
        overlay.className = 'sidebar-overlay';
        document.body.appendChild(overlay);

        // Toggle sidebar on button click
        toggleBtn.addEventListener('click', function() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            
            // Change icon
            if (sidebar.classList.contains('mobile-open')) {
                toggleBtn.innerHTML = '';
            } else {
                toggleBtn.innerHTML = '';
            }
        });

        // Close sidebar when clicking overlay
        overlay.addEventListener('click', function() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            toggleBtn.innerHTML = '';
        });

        // Close sidebar when clicking a nav link (optional)
        const navLinks = document.querySelectorAll('.sidebar a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const overlay = document.querySelector('.sidebar-overlay');
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                    toggleBtn.innerHTML = '';
                }
            });
        });
    }
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', function() {
    initMobileMenu();
    
    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            // Close mobile menu if window is resized to desktop
            if (window.innerWidth > 768) {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                const toggleBtn = document.querySelector('.mobile-menu-toggle');
                
                if (sidebar) sidebar.classList.remove('mobile-open');
                if (overlay) overlay.classList.remove('active');
                if (toggleBtn) toggleBtn.innerHTML = '';
            }
        }, 250);
    });
});

// Optional: Add data-label attributes to table cells for mobile card view
function makeTablesResponsive() {
    const tables = document.querySelectorAll('table');
    
    tables.forEach(table => {
        const headers = table.querySelectorAll('th');
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            cells.forEach((cell, index) => {
                if (headers[index]) {
                    cell.setAttribute('data-label', headers[index].textContent);
                }
            });
        });
        
        // Add responsive class
        table.classList.add('table-responsive');
    });
}

// Call this after tables are rendered
// You can add this to your existing table rendering functions

// ========================================
// PROJECT TIMELINE / ORDER OF EVENTS SYSTEM
// ========================================

servicePackages = {
    // FREE WEBSITE PACKAGES (No free maintenance, very basic SEO)
    'free-basic': {
        name: 'Free Basic Website',
        description: 'Entry-level website for startups and small businesses',
        price: 0,
        duration: '1-2 weeks',
        isFree: true,
        phases: [
            {
                name: 'Quick Setup & Planning',
                duration: '1-2 days',
                tasks: [
                    'Brief consultation call (30 minutes)',
                    'Basic requirements gathering',
                    'Template selection',
                    'Content outline approval'
                ]
            },
            {
                name: 'Development & Setup',
                duration: '3-5 days',
                tasks: [
                    'Up to 5 basic pages (Home, About, Services, Contact, One custom page)',
                    'Template-based design',
                    'Mobile-responsive layout',
                    'Basic contact form',
                    'Very basic on-page SEO (title tags, meta descriptions only)'
                ]
            },
            {
                name: 'Launch',
                duration: '1-2 days',
                tasks: [
                    'Basic testing',
                    'Domain connection assistance',
                    'Free subdomain deployment (yourname.render.app)',
                    'Basic Google Analytics setup',
                    'Quick 15-minute walkthrough'
                ]
            }
        ],
        features: [
            'Up to 5 basic pages',
            'Template-based design',
            'Mobile responsive',
            'Basic contact form',
            'Very basic SEO (titles & meta only)',
            'Free subdomain hosting',
            'Google Analytics',
            'NO free maintenance period',
            'NO admin dashboard',
            'NO CRM features',
            'NO custom integrations'
        ],
        notes: 'Perfect for getting online quickly. Upgrade to paid packages for advanced features. Monthly maintenance available for additional fee.'
    },
    
    'free-portfolio': {
        name: 'Free Portfolio Website',
        description: 'Showcase your work with a simple portfolio site',
        price: 0,
        duration: '1-2 weeks',
        isFree: true,
        phases: [
            {
                name: 'Portfolio Planning',
                duration: '1-2 days',
                tasks: [
                    'Brief consultation (30 minutes)',
                    'Portfolio structure planning',
                    'Gallery/project showcase setup',
                    'Content requirements list'
                ]
            },
            {
                name: 'Development',
                duration: '4-6 days',
                tasks: [
                    'Up to 6 pages (Home, About, Portfolio/Gallery, Services, Contact, Resume/Bio)',
                    'Portfolio/gallery template setup',
                    'Project showcase sections',
                    'Image optimization',
                    'Basic contact form',
                    'Very basic SEO'
                ]
            },
            {
                name: 'Launch',
                duration: '1-2 days',
                tasks: [
                    'Testing across devices',
                    'Free subdomain deployment',
                    'Basic analytics setup',
                    '15-minute training on updating portfolio'
                ]
            }
        ],
        features: [
            'Up to 6 pages',
            'Portfolio/gallery showcase',
            'Project display sections',
            'Template-based design',
            'Mobile responsive',
            'Image optimization',
            'Basic contact form',
            'Very basic SEO',
            'Free subdomain hosting',
            'NO free maintenance',
            'NO custom features'
        ],
        notes: 'Great for freelancers, artists, photographers. Monthly maintenance available for fee.'
    },
    
    'free-business-card': {
        name: 'Free Business Card Website',
        description: 'Simple one-page site with essential business info',
        price: 0,
        duration: '3-5 days',
        isFree: true,
        phases: [
            {
                name: 'Setup',
                duration: '1 day',
                tasks: [
                    'Quick 20-minute consultation',
                    'Business info collection',
                    'Single-page layout selection'
                ]
            },
            {
                name: 'Development',
                duration: '2-3 days',
                tasks: [
                    'Single-page website (all content on one page)',
                    'Sections: Header, About, Services, Contact',
                    'Template-based modern design',
                    'Mobile responsive',
                    'Click-to-call & email buttons',
                    'Google Maps embed',
                    'Very basic SEO'
                ]
            },
            {
                name: 'Launch',
                duration: '1 day',
                tasks: [
                    'Quick testing',
                    'Free subdomain deployment',
                    'Basic analytics',
                    'Quick handoff'
                ]
            }
        ],
        features: [
            'Single-page design',
            'Essential business sections',
            'Click-to-call/email buttons',
            'Google Maps integration',
            'Template-based design',
            'Mobile responsive',
            'Very basic SEO',
            'Free subdomain hosting',
            'NO multi-page navigation',
            'NO free maintenance',
            'NO custom features'
        ],
        notes: 'Perfect for establishing basic online presence quickly. Monthly maintenance available for fee.'
    },
    
    'free-landing-page': {
        name: 'Free Landing Page',
        description: 'Single focused landing page for campaigns or lead generation',
        price: 0,
        duration: '3-5 days',
        isFree: true,
        phases: [
            {
                name: 'Campaign Planning',
                duration: '1 day',
                tasks: [
                    '20-minute strategy call',
                    'Campaign goal identification',
                    'Call-to-action planning',
                    'Lead capture form setup'
                ]
            },
            {
                name: 'Development',
                duration: '2-3 days',
                tasks: [
                    'Single focused landing page',
                    'Conversion-focused template design',
                    'Lead capture form',
                    'Call-to-action buttons',
                    'Mobile responsive',
                    'Very basic SEO for target keyword'
                ]
            },
            {
                name: 'Launch',
                duration: '1 day',
                tasks: [
                    'Form testing',
                    'Free subdomain deployment',
                    'Basic conversion tracking',
                    'Quick handoff'
                ]
            }
        ],
        features: [
            'Single landing page',
            'Conversion-focused design',
            'Lead capture form',
            'Mobile responsive',
            'Call-to-action optimization',
            'Very basic SEO',
            'Free subdomain hosting',
            'Basic conversion tracking',
            'NO multi-page site',
            'NO free maintenance',
            'NO advanced integrations'
        ],
        notes: 'Ideal for campaigns, promotions, or testing ideas. Monthly maintenance available for fee.'
    },
    
    'starter-website': {
        name: 'Starter Package - $1,499',
        description: 'Perfect for small businesses getting started online',
        price: 1499,
        duration: '2-3 weeks',
        phases: [
            {
                name: 'Discovery & Planning',
                duration: '2-3 days',
                tasks: [
                    'Initial consultation and requirements gathering',
                    'Brand guidelines review',
                    'Content strategy planning',
                    'Wireframe approval',
                    'Contract execution and 50% deposit collection'
                ]
            },
            {
                name: 'Design & Development',
                duration: '1-2 weeks',
                tasks: [
                    'Up to 15 custom-designed pages',
                    'Modern, professional UI design',
                    'Mobile-responsive layout implementation',
                    'Contact form integration',
                    'Basic SEO setup',
                    'Performance-optimized frontend'
                ]
            },
            {
                name: 'User System & Database',
                duration: '3-4 days',
                tasks: [
                    'Custom basic user login & authentication',
                    'Secure admin dashboard access',
                    'PostgreSQL database setup',
                    'Admin panel for managing leads & submissions',
                    'Role-ready structure for future expansion'
                ]
            },
            {
                name: 'Lead Capture & CRM',
                duration: '2-3 days',
                tasks: [
                    'Contact forms with lead capture',
                    'Leads stored securely in database',
                    'Basic CRM setup (leads & contacts)',
                    'Status tracking for new & contacted leads'
                ]
            },
            {
                name: 'Optional Integrations',
                duration: '1-2 days',
                tasks: [
                    'Email automation integration (if requested)',
                    'SMS marketing automation (if requested)',
                    'Stripe or Shopify billing integration (if requested)',
                    'E-commerce ready with cart system (if requested)',
                    'Form-triggered notifications'
                ]
            },
            {
                name: 'Testing & Launch',
                duration: '2-3 days',
                tasks: [
                    'Cross-browser testing',
                    'Mobile responsiveness check',
                    'Client review and revisions',
                    'Domain setup and deployment to Render',
                    'SSL certificate installation',
                    'Google Analytics setup',
                    'Final 50% payment collection',
                    '90 days of free add-ons begins',
                    '90 days of free priority support begins'
                ]
            }
        ],
        features: [
            'Up to 15 custom-designed pages',
            'Mobile responsive design',
            'Contact form integration',
            'Basic SEO optimization',
            'Custom user login & authentication',
            'Secure admin dashboard',
            'PostgreSQL database',
            'Basic CRM for leads',
            'Render deployment',
            'Google Analytics setup',
            '90 days of free add-ons',
            '90 days of free priority support',
            'Optional: Email/SMS automation',
            'Optional: Stripe/Shopify integration',
            'Optional: E-commerce cart system'
        ],
        notes: 'Some features may require third-party services or usage-based fees (SMS, email, payment processing)'
    },
    
    'professional-website': {
        name: 'Professional Package - $2,999',
        description: 'Comprehensive solution for growing businesses',
        price: 2999,
        duration: '4-6 weeks',
        phases: [
            {
                name: 'Strategy & Planning',
                duration: '1 week',
                tasks: [
                    'In-depth business analysis',
                    'Competitor research',
                    'User persona development',
                    'Site architecture planning (up to 25 pages)',
                    'Content strategy development',
                    'Contract execution and 50% deposit collection'
                ]
            },
            {
                name: 'Design Phase',
                duration: '1-2 weeks',
                tasks: [
                    'Custom design mockups (2-3 concepts)',
                    'Design revision rounds',
                    'UI/UX optimization',
                    'Brand integration',
                    'Design system creation',
                    'Mobile-responsive layouts'
                ]
            },
            {
                name: 'Development Phase',
                duration: '2-3 weeks',
                tasks: [
                    'Up to 25 custom-designed pages',
                    'Frontend development',
                    'Advanced CMS integration',
                    'Custom user logins & account management',
                    'Expanded admin dashboard functionality',
                    'Blog/news section development',
                    'Advanced contact forms',
                    'Newsletter integration'
                ]
            },
            {
                name: 'Advanced Features',
                duration: '3-5 days',
                tasks: [
                    'Advanced CRM setup (leads & contacts)',
                    'Lead status pipelines & categorization',
                    'Admin-side lead notes & tracking',
                    'E-commerce ready (up to 10 products)',
                    'Advanced business analytics & KPIs',
                    'Custom data tracking for user activity'
                ]
            },
            {
                name: 'SEO & Performance',
                duration: '2-3 days',
                tasks: [
                    'Advanced SEO implementation',
                    'Performance optimization',
                    'Security hardening',
                    'Google Analytics & Search Console setup',
                    'Social media integration',
                    'Live chat integration'
                ]
            },
            {
                name: 'Testing & Launch',
                duration: '3-5 days',
                tasks: [
                    'Comprehensive QA testing',
                    'Security audit',
                    'Client training sessions',
                    'Staged deployment to Render',
                    'Post-launch monitoring',
                    'Final 50% payment collection',
                    '120 days of free add-ons begins',
                    '120 days of free priority support begins'
                ]
            }
        ],
        features: [
            'Up to 25 custom-designed pages',
            'Custom design (unlimited revisions)',
            'Advanced CMS integration',
            'Blog/news section',
            'Advanced contact forms',
            'Newsletter integration',
            'E-commerce ready (up to 10 products)',
            'Advanced SEO package',
            'Social media integration',
            'Google Analytics & Search Console',
            'Live chat integration',
            'Advanced CRM with pipelines',
            'Custom analytics & KPIs',
            'Performance optimization',
            'Security hardening',
            '120 days of free add-ons',
            '120 days of free priority support'
        ],
        notes: 'Some features may require third-party services or usage-based fees'
    },
    
    'enterprise-website': {
        name: 'Enterprise Package - Custom Pricing',
        description: 'Full-scale solution for established businesses',
        price: 0, // Custom pricing
        duration: '8-12 weeks',
        phases: [
            {
                name: 'Discovery & Strategy',
                duration: '2 weeks',
                tasks: [
                    'Stakeholder interviews',
                    'Comprehensive market research',
                    'User journey mapping',
                    'Technical requirements analysis',
                    'Information architecture planning',
                    'Content audit and strategy',
                    'Conversion optimization planning',
                    'Contract execution and initial payment'
                ]
            },
            {
                name: 'Design & Prototyping',
                duration: '3-4 weeks',
                tasks: [
                    'Multiple design concepts',
                    'Interactive prototypes',
                    'User testing and feedback',
                    'Accessibility compliance review',
                    'Design system development',
                    'Brand guidelines integration'
                ]
            },
            {
                name: 'Development & Integration',
                duration: '4-6 weeks',
                tasks: [
                    'Unlimited custom-designed pages',
                    'Custom backend development',
                    'API integrations',
                    'Third-party service connections',
                    'Database architecture',
                    'Advanced CMS customization',
                    'E-commerce implementation (unlimited products)',
                    'User portal/membership system',
                    'Multi-language support',
                    'Security implementation'
                ]
            },
            {
                name: 'Advanced Systems',
                duration: '1-2 weeks',
                tasks: [
                    'Advanced analytics and reporting',
                    'Marketing automation integration',
                    'CRM integration',
                    'API development',
                    'Advanced security features',
                    'Custom admin dashboard',
                    'A/B testing setup',
                    'Conversion rate optimization'
                ]
            },
            {
                name: 'Testing, Training & Launch',
                duration: '1-2 weeks',
                tasks: [
                    'Extensive QA testing',
                    'Load and performance testing',
                    'Security penetration testing',
                    'Staff training program',
                    'Documentation creation',
                    'Phased rollout strategy',
                    'Post-launch optimization',
                    'Final payment collection',
                    '12 months of premium support begins'
                ]
            }
        ],
        features: [
            'Unlimited custom pages',
            'Fully custom design and development',
            'Advanced CMS with custom modules',
            'E-commerce platform (unlimited products)',
            'User portal/membership system',
            'Multi-language support',
            'Advanced analytics and reporting',
            'Marketing automation integration',
            'CRM integration',
            'API development',
            'Third-party integrations',
            'Advanced security features',
            'Dedicated project manager',
            'Custom admin dashboard',
            'A/B testing setup',
            'Conversion rate optimization',
            '12 months of premium support',
            'Priority bug fixes',
            'Monthly performance reports'
        ],
        notes: 'Pricing varies based on project scope and requirements'
    },
    
    'seo-services': {
        name: 'SEO Services - $199/month',
        description: 'Comprehensive SEO optimization for Hill Country businesses',
        price: 199,
        duration: 'Ongoing monthly service',
        phases: [
            {
                name: 'Initial SEO Audit',
                duration: '1 week',
                tasks: [
                    'Comprehensive website SEO audit',
                    'Keyword research for Hill Country markets',
                    'Competitor analysis',
                    'Technical SEO assessment',
                    'Current ranking baseline report'
                ]
            },
            {
                name: 'Monthly Optimization',
                duration: 'Ongoing',
                tasks: [
                    'On-page SEO optimization',
                    'Content optimization for target keywords',
                    'Local SEO improvements',
                    'Google My Business optimization',
                    'Local citation building',
                    'Schema markup updates',
                    'Performance monitoring'
                ]
            },
            {
                name: 'Monthly Reporting',
                duration: 'Monthly',
                tasks: [
                    'Keyword ranking tracking',
                    'Traffic analysis',
                    'Conversion tracking',
                    'Competitor ranking comparisons',
                    'Monthly performance reports',
                    'Strategy adjustments'
                ]
            }
        ],
        features: [
            'Keyword research (Hill Country focus)',
            'On-page SEO optimization',
            'Technical SEO fixes',
            'Local SEO optimization',
            'Google My Business management',
            'Schema markup implementation',
            'Content optimization',
            'Monthly performance reports',
            'Keyword ranking tracking',
            'Google Analytics monitoring',
            'Competitor analysis',
            'Review generation support'
        ],
        notes: 'Results typically visible within 3-6 months'
    },
    
    'digital-marketing': {
        name: 'Digital Marketing Services - Custom Pricing',
        description: 'Comprehensive marketing campaigns for growth',
        price: 0, // Custom pricing
        duration: 'Custom campaign duration',
        phases: [
            {
                name: 'Strategy Development',
                duration: '1-2 weeks',
                tasks: [
                    'Marketing goals definition',
                    'Target audience research',
                    'Platform selection',
                    'Budget allocation planning',
                    'Campaign strategy creation',
                    'Content calendar development'
                ]
            },
            {
                name: 'Campaign Setup',
                duration: '1 week',
                tasks: [
                    'Account setup (Facebook, Google, etc.)',
                    'Audience targeting configuration',
                    'Ad creative development',
                    'Landing page optimization',
                    'Tracking pixel installation',
                    'Conversion goals setup'
                ]
            },
            {
                name: 'Campaign Management',
                duration: 'Ongoing',
                tasks: [
                    'Daily campaign monitoring',
                    'A/B testing',
                    'Budget optimization',
                    'Ad creative updates',
                    'Audience refinement',
                    'Performance analysis',
                    'Weekly optimization'
                ]
            },
            {
                name: 'Reporting & Optimization',
                duration: 'Ongoing',
                tasks: [
                    'Weekly performance reports',
                    'Monthly strategy sessions',
                    'ROI analysis',
                    'Campaign adjustments',
                    'Conversion rate optimization',
                    'Competitive analysis'
                ]
            }
        ],
        features: [
            'Social media marketing (Facebook, Instagram, LinkedIn)',
            'Google Ads (Search, Display, LSA)',
            'Facebook & Instagram Ads',
            'Email marketing campaigns',
            'Content marketing',
            'Lead generation campaigns',
            'Retargeting campaigns',
            'Analytics & reporting',
            'A/B testing',
            'ROI tracking',
            'Custom audience creation',
            'Campaign optimization'
        ],
        notes: 'Pricing varies based on campaign complexity and ad spend budget'
    }
};

// STANDARDIZED WEBSITE DEVELOPMENT PROCESS
// This applies to ALL website projects regardless of package
const standardWebsitePhases = [
    {
        name: 'Discovery & Planning Meeting',
        duration: '1 week',
        tasks: [
            'Initial meeting to discuss your preferences and expectations',
            'Review project timeline and what will be delivered',
            'Understand your industry, business needs, and target audience',
            'Define the message and persona your website needs to convey',
            'Establish clear goals for the website'
        ]
    },
    {
        name: 'Draft Development & Iteration',
        duration: '2-4 weeks (varies by package)',
        tasks: [
            'Start Round 1 draft of the website design',
            'Two (2) progress meetings per week during this phase',
            'Review feedback and make revisions each round',
            'Continue rounds until you approve a final draft',
            'As many revisions as needed to get it right'
        ]
    },
    {
        name: 'Functionality & Systems Integration',
        duration: '1-2 weeks',
        tasks: [
            'Turn the approved draft into a fully functional website',
            'Integrate all systems (forms, databases, CRM, etc.)',
            'Add all technical features included in your package',
            'Implement SEO and analytics tracking'
        ]
    },
    {
        name: 'Soft Deployment & Testing',
        duration: '3-5 days',
        tasks: [
            'Deploy website to a private testing environment',
            'Send you a private link to review and test the site',
            'You test everything and provide any final feedback',
            'We fix any issues that come up'
        ]
    },
    {
        name: 'Go-Live Deployment',
        duration: '1-2 days',
        tasks: [
            'Set an agreed-upon go-live date',
            'Confirm all issues are resolved before go-live',
            'Connect your domain and make the site live',
            'Site goes live on the scheduled date',
            'Monitor for 24 hours after launch',
            'Provide training on how to manage your site'
        ]
    }
];

// ========================================
// NAVIGATION
// ========================================
function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const s = this.dataset.section;
            if (s) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                renderSection(s);
            }
        });
    });
}

async function loadTickets() {
    try {
        const token = getAuthToken();
        if (!token) {
            console.error('No authentication token found');
            showToast('Please log in to view tickets', 'error');
            state.tickets = [];
            return;
        }
        
        const response = await fetch(`${API_URL}/api/tickets`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            state.tickets = data.tickets || [];
        } else {
            console.error('Failed to load tickets:', response.status);
            state.tickets = [];
        }
    } catch (error) {
        console.error('Load tickets error:', error);
        state.tickets = [];
    }
}

// Example: Send individual email (adapt to your existing single send logic)
async function sendIndividualEmail(leadId) {
    // Find the lead from state so we can get name + email for the modal
    const lead = state.leads.find(l => l.id === parseInt(leadId)) || state.leads.find(l => l.id === leadId);
    if (!lead) {
        showToast('Lead not found', 'error');
        return;
    }
    showEmailModal(lead.id, lead.name, lead.email);
}

async function renderSection(section) {
    console.log('[RENDER] Switching to section:', section);
    
    state.currentSection = section;
    const content = document.getElementById('contentArea');
    
    if (!content) {
        console.error('[RENDER] Content area not found!');
        return;
    }
    
    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.dataset.section === section) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
    
    // Set appropriate filter based on section
    if (section === 'leads') {
        state.currentFilter = 'all';
    } else if (section === 'new' || section === 'pending' || section === 'contacted') {
        state.currentFilter = section;
    } else if (section === 'invoices') {
        state.currentFilter = state.currentFilter || 'all';
    } else {
        state.currentFilter = 'all';
    }

    // Set page title
    const titles = {
        dashboard: 'Dashboard',
        analytics: 'Analytics',
        leads: 'All Leads',
        new: 'New Leads',
        pending: 'Pending Leads',
        contacted: 'Contacted Leads',
        customers: 'Customers',
        employees: 'Team Management',
        invoices: 'Invoices',
        tasks: 'Tasks',
        projects: 'Project Timelines',
        settings: 'Settings',
        followups: 'Follow-Up Queue',
        tickets: 'Support Tickets',
        documents: 'Document Management',
        pipeline: 'Sales Pipeline',
        'lead-scoring': 'Lead Scoring',
        'scoring-rules': 'Scoring Rules',
        'client-portal': 'Client Portal',
        recruitment: 'Recruitment'
    };
    
    const pageTitleEl = document.getElementById('pageTitle');
    if (pageTitleEl) {
        pageTitleEl.textContent = titles[section] || 'Dashboard';
    }
    
    // Update topbar actions based on section
    const topbarActions = document.querySelector('.topbar-actions');
    if (topbarActions) {
        let actionButtons = `
            <button class="btn btn-secondary" onclick="openExportModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
            </button>
        `;
        
        // Add section-specific action buttons
        if (section === 'leads' || section === 'new' || section === 'pending' || section === 'contacted') {
            actionButtons += `
                <button class="btn btn-primary" onclick="openCreateModal('lead')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Lead
                </button>
            `;
        } else if (section === 'invoices') {
            actionButtons += `
                <button class="btn btn-primary" onclick="showInvoiceLeadSelector()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Create Invoice
                </button>
            `;
        } else if (section === 'employees') {
            actionButtons += `
                <button class="btn btn-primary" onclick="openCreateModal('employee')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Employee
                </button>
            `;
        } else if (section === 'tasks') {
            actionButtons += `
                <button class="btn btn-primary" onclick="openCreateModal('task')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Task
                </button>
            `;
        } else if (section === 'projects') {
            actionButtons += `
                <button class="btn btn-primary" onclick="openProjectTimelineModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                    Create Project Timeline
                </button>
            `;
        } else if (section === 'recruitment') {
            actionButtons += `
                <button class="btn btn-primary" onclick="openJobModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Create Job
                </button>
            `;
        } else if (section === 'dashboard') {
            actionButtons += `
                <button class="btn btn-primary" onclick="openCreateModal('lead')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Lead
                </button>
            `;
        }
        
        topbarActions.innerHTML = actionButtons;
    }
    
    console.log(' renderSection - about to switch to:', section);
    
    // Route to appropriate render function
    switch(section) {
        case 'dashboard':
            renderDashboard(content);
            break;
            
        case 'leads':
            renderLeadsTable(content, 'leads');
            break;

            case 'new':
    case 'pending':
    case 'contacted':
        renderLeadsTable(content, 'leads');
        break;
            
        case 'customers':
            renderLeadsTable(content, 'customers');
            break;
            
        case 'invoices':
            renderInvoices(content);
            break;
            
        case 'employees':
            renderEmployees(content);
            break;
            
        case 'tasks':
            renderTasks(content);
            break;
            
        case 'analytics':
            renderAnalytics(content);
            break;
            
        case 'settings':
            renderSettings(content);
            break;
            
        case 'projects':
            console.log(' Rendering projects section');
            renderProjects(content);
            break;
            
case 'support':
case 'tickets':
    renderTickets();
    break;
            
        case 'documents':
            renderDocuments(content);
            break;
            
        case 'pipeline':
            renderPipeline(content);
            break;
            
        case 'lead-scoring':
            renderLeadScoring(content);
            break;
            
        case 'scoring-rules':
            renderScoringRules(content);
            break;
            
case 'clientPortal':  // Add this case
case 'client-portal':
    renderClientPortal();
    break;
            
        case 'recruitment':
            await renderRecruitment(content);
            break;

        case 'followups':
            await renderFollowUps(content);
            break;
            
        default:
            content.innerHTML = `
                <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                    <h3>Section not found</h3>
                    <p>The section "${section}" doesn't exist</p>
                </div>
            `;
    }
}

function showInvoiceLeadSelector() {
console.log(' showInvoiceLeadSelector called');
    console.log(' State leads:', state.leads.length);
    console.log(' State customers:', state.customers.length);
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    console.log(' Modal found:', !!modal);
    console.log(' Title found:', !!titleEl);
    console.log(' Body found:', !!bodyEl);
    
    // Debug: Check if modal elements exist
    if (!modal) {
        console.error('createModal not found');
        showToast('Modal not found. Please refresh the page.', 'error');
        return;
    }
    if (!titleEl) {
        console.error('createModalTitle not found');
        showToast('Modal title element not found.', 'error');
        return;
    }
    if (!bodyEl) {
        console.error('createModalBody not found');
        showToast('Modal body element not found.', 'error');
        return;
    }
    
    titleEl.textContent = 'Select Customer/Lead for Invoice';
    
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    
    bodyEl.innerHTML = `
        <div class="form-group">
            <label class="form-label">Search Customer/Lead</label>
            <input type="text" class="form-input" id="leadSearch" placeholder="Search by name or email..." oninput="filterLeadSelector()">
        </div>
        <div id="leadSelectorList" style="max-height: 400px; overflow-y: auto; margin-top: 16px;">
            ${allLeadsAndCustomers.map(lead => `
                <div class="expense-item" style="cursor: pointer; margin-bottom: 8px;" onclick="selectLeadForInvoice(${lead.id})">
                    <div class="contact-avatar">${getInitials(lead.name)}</div>
                    <div class="expense-content">
                        <div class="expense-description">${lead.name}</div>
                        <div class="expense-meta">
                            <span>${lead.email}</span>
                            ${lead.company ? `<span>${lead.company}</span>` : ''}
                        </div>
                    </div>
                    <span class="status-badge status-${lead.is_customer ? 'contacted' : lead.status}">
                        ${lead.is_customer ? 'Customer' : 'Lead'}
                    </span>
                </div>
            `).join('')}
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
        </div>
    `;
    
    modal.classList.add('active');
    console.log('Modal opened successfully');
}

function filterLeadSelector() {
    const search = document.getElementById('leadSearch').value.toLowerCase();
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    const filtered = search 
        ? allLeadsAndCustomers.filter(l => 
            l.name.toLowerCase().includes(search) || 
            l.email.toLowerCase().includes(search) ||
            (l.company && l.company.toLowerCase().includes(search))
          )
        : allLeadsAndCustomers;
    
    document.getElementById('leadSelectorList').innerHTML = filtered.map(lead => `
        <div class="expense-item" style="cursor: pointer; margin-bottom: 8px;" onclick="selectLeadForInvoice(${lead.id})">
            <div class="contact-avatar">${getInitials(lead.name)}</div>
            <div class="expense-content">
                <div class="expense-description">${lead.name}</div>
                <div class="expense-meta">
                    <span>${lead.email}</span>
                    ${lead.company ? `<span>${lead.company}</span>` : ''}
                </div>
            </div>
            <span class="status-badge status-${lead.is_customer ? 'contacted' : lead.status}">
                ${lead.is_customer ? 'Customer' : 'Lead'}
            </span>
        </div>
    `).join('');
}

function selectLeadForInvoice(leadId) {
    closeCreateModal();
    openCreateModal('invoice', leadId);
}

function showClientSelectionForInvoice() {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Create Invoice - Select Client';
    
    const clients = [...state.customers, ...state.leads];
    
    bodyEl.innerHTML = `
        <div style="margin-bottom: 16px;">
            <input type="text" class="form-input" id="clientSearch" 
                   placeholder="Search clients..." 
                   oninput="filterClientList(this.value)">
        </div>
        <div id="clientList" style="max-height: 400px; overflow-y: auto;">
            ${clients.map(client => `
                <div class="client-item" onclick="selectClientForNewInvoice(${client.id})" 
                     style="padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;"
                     onmouseover="this.style.background='var(--bg-secondary)'" 
                     onmouseout="this.style.background='transparent'">
                    <div style="font-weight: 600;">${client.name}</div>
                    <div style="font-size: 13px; color: var(--text-muted);">${client.email}</div>
                    ${client.company ? `<div style="font-size: 12px; color: var(--text-muted);">${client.company}</div>` : ''}
                </div>
            `).join('')}
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
        </div>
    `;
    
    modal.classList.add('active');
}

function selectClientForNewInvoice(leadId) {
    console.log(' Client selected, opening invoice modal for lead:', leadId);
    closeCreateModal();
    // Longer delay to ensure modal is fully closed
    setTimeout(() => {
        openInvoiceModal(leadId);
    }, 300); // Increase from 100ms to 300ms
}

function filterClientList(searchTerm) {
    const clients = [...state.customers, ...state.leads];
    const filtered = clients.filter(c => 
        c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (c.company && c.company.toLowerCase().includes(searchTerm.toLowerCase()))
    );
    
    const listEl = document.getElementById('clientList');
    listEl.innerHTML = filtered.map(client => `
        <div class="client-item" onclick="selectClientForNewInvoice(${client.id})" 
             style="padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;"
             onmouseover="this.style.background='var(--bg-secondary)'" 
             onmouseout="this.style.background='transparent'">
            <div style="font-weight: 600;">${client.name}</div>
            <div style="font-size: 13px; color: var(--text-muted);">${client.email}</div>
            ${client.company ? `<div style="font-size: 12px; color: var(--text-muted);">${client.company}</div>` : ''}
        </div>
    `).join('');
}
// ========================================
// RENDER FUNCTIONS
// ========================================
// ========================================
// RENDERING FUNCTIONS
// ========================================

// 1. RENDER LEADS TABLE (MISSING)
function renderLeadsTable(content, type) {
    // Determine what data to show based on section and filter
    let data;
    if (type === 'customers') {
        data = state.customers;
    } else {
        // For leads section, apply status filter if we're in a status-specific section
        data = state.leads;
        
        // If current section is a status filter (new/pending/contacted), apply it
        if (state.currentSection === 'new' || state.currentSection === 'pending' || state.currentSection === 'contacted') {
            data = data.filter(l => l.status === state.currentSection);
        }
    }
    
    // Apply additional filters
    const filtered = filterLeads(data);
    
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" class="search-input" placeholder="Search ${type}..." 
                       value="${state.searchTerm || ''}"
                       onkeyup="handleSearch(this.value)">
            </div>
            <div class="filter-group">
                <button class="filter-btn ${state.currentFilter === 'all' ? 'active' : ''}" 
                        onclick="setLeadFilter('all')">All</button>
                <button class="filter-btn ${state.currentFilter === 'new' ? 'active' : ''}" 
                        onclick="setLeadFilter('new')">New</button>
                <button class="filter-btn ${state.currentFilter === 'pending' ? 'active' : ''}" 
                        onclick="setLeadFilter('pending')">Pending</button>
                <button class="filter-btn ${state.currentFilter === 'contacted' ? 'active' : ''}" 
                        onclick="setLeadFilter('contacted')">Contacted</button>
            </div>
        </div>
        <div class="table-container">
            ${renderLeadsTableHTML(filtered)}
        </div>
    `;
}

// Helper: Render table HTML
function renderLeadsTableHTML(data) {
    if (!data || data.length === 0) {
        return `
            <div style="text-align: center; padding: 60px 20px; color: #666;">
                <h3>No ${state.currentSection === 'customers' ? 'customers' : 'leads'} found</h3>
            </div>
        `;
    }

    return `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Company</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${data.map(lead => `
                    <tr onclick="openDetailModal('lead', ${lead.id})">
                        <td>${lead.name || 'No Name'}</td>
                        <td>${lead.email}</td>
                        <td>${lead.company || '-'}</td>
                        <td>
                            <span class="badge badge-${lead.status || 'new'}">
                                ${(lead.status || 'new').charAt(0).toUpperCase() + (lead.status || 'new').slice(1)}
                            </span>
                        </td>
                        <td>${formatDate(lead.created_at)}</td>
                        <td>
<button class="btn-icon" onclick="event.stopPropagation(); openDetailModal('lead', ${lead.id})" title="View Lead">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path>
        <circle cx="12" cy="12" r="3"></circle>
    </svg>
</button>

<button class="btn-icon" onclick="event.stopPropagation(); deleteLead(${lead.id})" title="Delete Lead">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6l-1 14H6L5 6"></path>
        <path d="M10 11v6"></path>
        <path d="M14 11v6"></path>
        <path d="M9 6V4h6v2"></path>
    </svg>
</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// 2. RENDER EMPLOYEES (MISSING)
function renderEmployees(content) {
    if (!state.employees || state.employees.length === 0) {
        content.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
                <h3>No employees yet</h3>
                <p>Click "Add Employee" to get started</p>
            </div>
        `;
        return;
    }

    content.innerHTML = `
        <div class="cards-grid">
            ${state.employees.map(emp => `
                <div class="card">
                    <h3>${emp.name}</h3>
                    <p><strong>Email:</strong> ${emp.email}</p>
                    <p><strong>Role:</strong> ${emp.role || 'Team Member'}</p>
                    ${emp.phone ? `<p><strong>Phone:</strong> ${emp.phone}</p>` : ''}
                    ${emp.start_date ? `<p><strong>Start Date:</strong> ${formatDate(emp.start_date)}</p>` : ''}
                    ${emp.end_date ? `<p><strong>End Date:</strong> ${formatDate(emp.end_date)}</p>` : ''}
                    ${emp.is_active === false ? `<p style="color: var(--status-error);"><strong>Status:</strong> Inactive</p>` : ''}
                    <div style="margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-primary" 
                                onclick="editEmployee(${emp.id})">
                            Edit
                        </button>
                        <button class="btn btn-sm btn-secondary" 
                                onclick="openDetailModal('employee', ${emp.id})">
                            Details
                        </button>
                        <button class="btn btn-sm btn-danger" 
                                onclick="deleteEmployee(${emp.id})">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// 3. FILTER LEADS (MISSING)
function filterLeads(data) {
    let filtered = [...data];
    
    // Only apply filter if it's not 'all' AND we're NOT in a status-specific section
    // (because status-specific sections already filtered the data)
    const isInStatusSection = ['new', 'pending', 'contacted'].includes(state.currentSection);
    
    if (state.currentFilter && state.currentFilter !== 'all' && !isInStatusSection) {
        filtered = filtered.filter(lead => lead.status === state.currentFilter);
    }
    
    // Apply search
    if (state.searchTerm) {
        const term = state.searchTerm.toLowerCase();
        filtered = filtered.filter(lead => 
            (lead.name && lead.name.toLowerCase().includes(term)) ||
            (lead.email && lead.email.toLowerCase().includes(term)) ||
            (lead.company && lead.company.toLowerCase().includes(term))
        );
    }
    
    return filtered;
}

// 4. SEARCH HANDLER (MISSING)
function handleSearch(searchTerm) {
    state.searchTerm = searchTerm;
    renderSection(state.currentSection);
}

// 5. FILTER HANDLER (MISSING)
function setLeadFilter(filter) {
    state.currentFilter = filter;
    renderSection(state.currentSection);
}

// 6. DELETE EMPLOYEE (MISSING)
async function deleteEmployee(employeeId) {
    if (!confirm('Are you sure you want to permanently delete this employee from the database? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`${API_BASE}/api/employees/${employeeId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Employee permanently deleted from database', 'success');
            await loadEmployees();
            renderSection('employees');
        } else {
            showToast(data.message || 'Failed to delete employee', 'error');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showToast('Failed to delete employee', 'error');
    }
}

// Edit employee
async function editEmployee(employeeId) {
    const employee = state.employees.find(e => e.id === employeeId);
    if (!employee) {
        showToast('Employee not found', 'error');
        return;
    }
    
    const modalContent = `
        <form onsubmit="saveEmployeeEdit(event, ${employeeId}); return false;">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="editEmployeeName" class="form-control" value="${employee.name || ''}" required>
            </div>
            
            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="editEmployeeEmail" class="form-control" value="${employee.email || ''}" required>
            </div>
            
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="editEmployeePhone" class="form-control" value="${employee.phone || ''}" placeholder="(555) 123-4567">
            </div>
            
            <div class="form-group">
                <label>Role</label>
                <input type="text" id="editEmployeeRole" class="form-control" value="${employee.role || 'Team Member'}">
            </div>
            
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="editEmployeeStartDate" class="form-control" value="${employee.start_date || ''}">
            </div>
            
            <div class="form-group">
                <label>End Date (if terminated)</label>
                <input type="date" id="editEmployeeEndDate" class="form-control" value="${employee.end_date || ''}">
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea id="editEmployeeNotes" class="form-control" rows="4" placeholder="Add any notes about this employee...">${employee.notes || ''}</textarea>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="editEmployeeActive" ${employee.is_active !== false ? 'checked' : ''}>
                    <span>Employee is currently active</span>
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    `;
    
    showModal(`Edit Employee - ${employee.name}`, modalContent);
}

// Save employee edits
async function saveEmployeeEdit(event, employeeId) {
    event.preventDefault();
    
    const employeeData = {
        name: document.getElementById('editEmployeeName').value,
        email: document.getElementById('editEmployeeEmail').value,
        phone: document.getElementById('editEmployeePhone').value,
        role: document.getElementById('editEmployeeRole').value,
        start_date: document.getElementById('editEmployeeStartDate').value || null,
        end_date: document.getElementById('editEmployeeEndDate').value || null,
        notes: document.getElementById('editEmployeeNotes').value,
        is_active: document.getElementById('editEmployeeActive').checked
    };
    
    try {
        const response = await fetch(`${API_BASE}/api/employees/${employeeId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(employeeData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Employee updated successfully', 'success');
            closeModal();
            await loadEmployees();
            renderSection('employees');
        } else {
            showToast(data.message || 'Failed to update employee', 'error');
        }
    } catch (error) {
        console.error('Update employee error:', error);
        showToast('Failed to update employee', 'error');
    }
}

// Edit customer/lead
async function editCustomer(leadId) {
    const customer = [...state.leads, ...state.customers].find(c => c.id === leadId);
    if (!customer) {
        showToast('Customer not found', 'error');
        return;
    }
    
    const modalContent = `
        <form onsubmit="saveCustomerEdit(event, ${leadId}); return false;">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="editCustomerName" class="form-control" value="${customer.name || ''}" required>
            </div>
            
            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="editCustomerEmail" class="form-control" value="${customer.email || ''}" required>
            </div>
            
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="editCustomerPhone" class="form-control" value="${customer.phone || ''}" placeholder="(555) 123-4567">
            </div>
            
            <div class="form-group">
                <label>Company</label>
                <input type="text" id="editCustomerCompany" class="form-control" value="${customer.company || ''}" placeholder="Company Name">
            </div>
            
            <div class="form-group">
                <label>Project Type</label>
                <select id="editCustomerProjectType" class="form-control">
                    <option value="">Select type...</option>
                    <option value="website" ${customer.project_type === 'website' ? 'selected' : ''}>Website</option>
                    <option value="ecommerce" ${customer.project_type === 'ecommerce' ? 'selected' : ''}>E-commerce</option>
                    <option value="webapp" ${customer.project_type === 'webapp' ? 'selected' : ''}>Web App</option>
                    <option value="mobile" ${customer.project_type === 'mobile' ? 'selected' : ''}>Mobile App</option>
                    <option value="api" ${customer.project_type === 'api' ? 'selected' : ''}>API/Backend</option>
                    <option value="other" ${customer.project_type === 'other' ? 'selected' : ''}>Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Budget</label>
                <input type="number" id="editCustomerBudget" class="form-control" value="${customer.budget || ''}" placeholder="10000" step="100">
            </div>
            
            <div class="form-group">
                <label>Timeline</label>
                <input type="text" id="editCustomerTimeline" class="form-control" value="${customer.timeline || ''}" placeholder="e.g., 3 months">
            </div>
            
            <div class="form-group">
                <label>Address Line 1</label>
                <input type="text" id="editCustomerAddress1" class="form-control" value="${customer.address_line1 || ''}" placeholder="123 Main St">
            </div>
            
            <div class="form-group">
                <label>Address Line 2</label>
                <input type="text" id="editCustomerAddress2" class="form-control" value="${customer.address_line2 || ''}" placeholder="Apt 4B">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="editCustomerCity" class="form-control" value="${customer.city || ''}" placeholder="New York">
                </div>
                
                <div class="form-group">
                    <label>State</label>
                    <input type="text" id="editCustomerState" class="form-control" value="${customer.state || ''}" placeholder="NY" maxlength="2">
                </div>
                
                <div class="form-group">
                    <label>ZIP Code</label>
                    <input type="text" id="editCustomerZip" class="form-control" value="${customer.zip_code || ''}" placeholder="10001">
                </div>
            </div>
            
            <div class="form-group">
                <label>Country</label>
                <input type="text" id="editCustomerCountry" class="form-control" value="${customer.country || 'USA'}" placeholder="USA">
            </div>
            
            <div class="form-group">
                <label>Message/Notes</label>
                <textarea id="editCustomerMessage" class="form-control" rows="4" placeholder="Any additional information...">${customer.message || ''}</textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal(); openDetailModal('lead', ${leadId});">Cancel</button>
            </div>
        </form>
    `;
    
    closeDetailModal();
    showModal(`Edit ${customer.is_customer ? 'Customer' : 'Lead'} - ${customer.name}`, modalContent);
}

// Save customer edits
async function saveCustomerEdit(event, leadId) {
    event.preventDefault();
    
    const customerData = {
        name: document.getElementById('editCustomerName').value,
        email: document.getElementById('editCustomerEmail').value,
        phone: document.getElementById('editCustomerPhone').value,
        company: document.getElementById('editCustomerCompany').value,
        project_type: document.getElementById('editCustomerProjectType').value,
        budget: document.getElementById('editCustomerBudget').value || null,
        timeline: document.getElementById('editCustomerTimeline').value,
        address_line1: document.getElementById('editCustomerAddress1').value,
        address_line2: document.getElementById('editCustomerAddress2').value,
        city: document.getElementById('editCustomerCity').value,
        state: document.getElementById('editCustomerState').value,
        zip_code: document.getElementById('editCustomerZip').value,
        country: document.getElementById('editCustomerCountry').value,
        message: document.getElementById('editCustomerMessage').value
    };
    
    try {
        const response = await fetch(`${API_BASE}/api/leads/${leadId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(customerData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Customer updated successfully', 'success');
            closeModal();
            await loadLeads();
            await loadCustomers();
            openDetailModal('lead', leadId);
        } else {
            showToast(data.message || 'Failed to update customer', 'error');
        }
    } catch (error) {
        console.error('Update customer error:', error);
        showToast('Failed to update customer', 'error');
    }
}

// 7. DELETE LEAD (MISSING)
async function deleteLead(leadId) {
    if (!confirm('Delete this lead?')) return;
    
    try {
        const response = await fetch(`/api/leads/${leadId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Lead deleted', 'success');
            await loadLeads();
            renderSection(state.currentSection);
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showNotification('Failed to delete', 'error');
    }
}

// 8. FORMAT DATE HELPER (MISSING)
function formatDate(dateString) {
    if (!dateString) return '-';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric'
    });
}
function renderDashboard(content) {
    const totalLeads = state.leads.length;
    const newLeads = state.leads.filter(l => l.status === 'new').length;
    const activeCustomers = state.customers.length;
    const pendingInvoices = state.invoices.filter(i => i.status !== 'paid' && i.status !== 'cancelled' && i.status !== 'void').length;
    const totalRevenue = state.invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
    const pendingRevenue = state.invoices.filter(i => i.status !== 'paid' && i.status !== 'cancelled' && i.status !== 'void').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);

    content.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Total Leads</span>
                    <div class="stat-icon blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${totalLeads}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    ${newLeads} new this week
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Active Customers</span>
                    <div class="stat-icon green">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${activeCustomers}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    Growing
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Pending Invoices</span>
                    <div class="stat-icon amber">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">${pendingInvoices}</div>
                <div class="stat-change">$${pendingRevenue.toLocaleString()} awaiting payment</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Total Revenue</span>
                    <div class="stat-icon purple">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-value">$${totalRevenue.toLocaleString()}</div>
                <div class="stat-change positive">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    12% from last month
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 36px;">
            <div class="table-container">
                <div style="padding: 20px 18px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 15px; font-weight: 700;">Recent Leads</h3>
                    <button class="btn btn-sm btn-secondary" onclick="renderSection('leads')">View All</button>
                </div>
                ${renderLeadsTableHTML(state.leads.slice(0, 5))}
            </div>
            
            <div class="table-container">
                <div style="padding: 20px 18px; border-bottom: 1px solid var(--border-subtle);">
                    <h3 style="font-size: 15px; font-weight: 700;">Upcoming Tasks</h3>
                </div>
                <div style="padding: 16px;">
                    ${state.tasks.filter(t => !t.completed).slice(0, 5).map(task => `
                        <div class="task-item" style="margin-bottom: 10px;">
                            <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="task-content">
                                <div class="task-title">${task.title}</div>
                                <div class="task-meta">
                                    <div class="task-due ${new Date(task.dueDate) < new Date() ? 'overdue' : ''}">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        ${formatDate(task.dueDate)}
                                    </div>
                                    <span class="priority-badge priority-${task.priority}">${task.priority}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

// ==================== CLIENT PORTAL SECTION ====================
async function renderClientPortal() {
    const content = document.getElementById('contentArea');
    
    content.innerHTML = `
        <div class="section-header">
            <div class="header-content">
                <h2 class="section-title">Client Portal Management</h2>
                <p class="section-description"></p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openCreateClientModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                    Create Client Account
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon green">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Active Accounts</div>
                    <div class="stat-value" id="activeClientsCount">0</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Active Projects</div>
                    <div class="stat-value" id="activeProjectsCount">0</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon purple">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                        <polyline points="13 2 13 9 20 9"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Client Uploads</div>
                    <div class="stat-value" id="clientUploadsCount">0</div>
                </div>
            </div>
        </div>

        <div class="data-card">
            <div class="card-header">
                <div class="header-content">
                    <h3 class="card-title">Client Accounts</h3>
                    <p class="card-subtitle"></p>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Email</th>
                            <th>Company</th>
                            <th>Status</th>
                            <th>Projects</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientAccountsTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="data-card">
            <div class="card-header">
                <div class="header-content">
                    <h3 class="card-title">Client Uploads</h3>
                </div>
                <div class="card-actions">
                    <select class="form-select" id="clientFilterSelect" onchange="filterClientUploads(this.value)">
                        <option value="">All Clients</option>
                    </select>
                </div>
            </div>
            <div class="uploads-grid" id="clientUploadsGrid">
                <p>Loading...</p>
            </div>
        </div>
    `;

    await loadClientAccounts();
    await loadClientUploads();
}

async function loadClientAccounts() {
    try {
        const response = await fetch(`${API_URL}/api/admin/client-accounts`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
            const data = await response.json();
            state.clientAccounts = data.clients || [];
            renderClientAccountsTable();
            updateClientStats();
        }
    } catch (error) {
        console.error('Failed to load client accounts:', error);
        const tbody = document.getElementById('clientAccountsTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Failed to load accounts</td></tr>';
        }
    }
}

function renderClientAccountsTable() {
    const tbody = document.getElementById('clientAccountsTableBody');
    if (!tbody) return;
    
    if (!state.clientAccounts || state.clientAccounts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <p>No client accounts yet</p>
                    <button class="btn btn-sm btn-primary" onclick="openCreateClientModal()">Create First Account</button>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = state.clientAccounts.map(client => `
        <tr>
            <td>
                <div class="user-cell">
                    <div class="user-avatar">${getInitials(client.name)}</div>
                    <div class="user-info">
                        <div class="user-name">${client.name}</div>
                    </div>
                </div>
            </td>
            <td>${client.email}</td>
            <td>${client.company || ''}</td>
            <td>
                <span class="badge ${client.is_active ? 'badge-success' : 'badge-danger'}">
                    ${client.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>${client.project_count || 0}</td>
            <td>${client.last_login ? formatDate(client.last_login) : 'Never'}</td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="assignProject(${client.id})">Project</button>
                <button class="btn btn-sm btn-secondary" onclick="resetClientPassword(${client.id})">Reset PW</button>
            </td>
        </tr>
    `).join('');
}

function updateClientStats() {
    const activeClients = state.clientAccounts.filter(c => c.is_active).length;
    const totalProjects = state.clientAccounts.reduce((sum, c) => sum + (c.project_count || 0), 0);
    
    const activeCount = document.getElementById('activeClientsCount');
    const projectsCount = document.getElementById('activeProjectsCount');
    const badge = document.getElementById('clientPortalBadge');
    
    if (activeCount) activeCount.textContent = activeClients;
    if (projectsCount) projectsCount.textContent = totalProjects;
    if (badge) badge.textContent = activeClients;
}

async function loadClientUploads() {
    try {
        const response = await fetch(`${API_URL}/api/admin/client-uploads`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
            const data = await response.json();
            state.clientUploads = data.uploads || [];
            renderClientUploads();
            const count = document.getElementById('clientUploadsCount');
            if (count) count.textContent = state.clientUploads.length;
        }
    } catch (error) {
        console.error('Failed to load uploads:', error);
    }
}

function renderClientUploads() {
    const grid = document.getElementById('clientUploadsGrid');
    if (!grid) return;
    
    if (!state.clientUploads || state.clientUploads.length === 0) {
        grid.innerHTML = '<p class="empty-state">No uploads yet</p>';
        return;
    }

    grid.innerHTML = state.clientUploads.slice(0, 12).map(upload => `
        <div class="file-card" onclick="downloadClientFile(${upload.id})">
            <div class="file-icon"></div>
            <div class="file-name">${upload.filename}</div>
            <div class="file-meta">
                <span>${upload.client_name}</span>
                <span>${formatFileSize(upload.file_size)}</span>
            </div>
        </div>
    `).join('');
}

function openCreateClientModal() {
    const modalBody = `
        <form id="createClientForm" onsubmit="handleCreateClient(event)">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Select Lead</label>
                    <select class="form-select" id="selectLead" required>
                        <option value="">Choose a lead...</option>
                        ${state.leads.map(lead => `
                            <option value="${lead.id}" data-email="${lead.email}">
                                ${lead.name} - ${lead.company || 'No Company'}
                            </option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="clientEmail" required>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Temporary Password</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="tempPassword" required style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="generatePassword()">Generate</button>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label class="checkbox-label">
                        <input type="checkbox" id="sendWelcomeEmail" checked>
                        <span>Send welcome email</span>
                    </label>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </div>
        </form>
    `;

    document.getElementById('createModalTitle').textContent = 'Create Client Account';
    document.getElementById('createModalBody').innerHTML = modalBody;
    document.getElementById('createModal').classList.add('active');

    // Auto-fill email
    setTimeout(() => {
        document.getElementById('selectLead').addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            document.getElementById('clientEmail').value = selected.dataset.email || '';
        });
    }, 100);
}

function generatePassword() {
    const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
    let password = "";
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('tempPassword').value = password;
}

async function handleCreateClient(event) {
    event.preventDefault();

    const data = {
        leadId: document.getElementById('selectLead').value,
        email: document.getElementById('clientEmail').value,
        temporaryPassword: document.getElementById('tempPassword').value,
        sendWelcomeEmail: document.getElementById('sendWelcomeEmail').checked
    };

    try {
        const response = await fetch(`${API_URL}/api/admin/client-accounts`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showToast('Client account created!', 'success');
            closeCreateModal();
            await loadClientAccounts();
            alert(`Account Created!\n\nEmail: ${data.email}\nPassword: ${data.temporaryPassword}`);
        } else {
            showToast(result.message || 'Failed to create account', 'error');
        }
    } catch (error) {
        showToast('Error creating account', 'error');
    }
}

async function assignProject(clientId) {
    try {
        // Get client info
        const client = state.clients.find(c => c.id === clientId);
        if (!client) {
            showToast('Client not found', 'error');
            return;
        }
        
        // Load existing projects to show available ones
        const response = await fetch(`${API_BASE}/projects`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        let existingProjects = [];
        if (response.ok) {
            const data = await response.json();
            existingProjects = data.projects || [];
        }
        
        // Show modal with form to create/assign project
        showModal('Assign Project to ' + client.name, `
            <form id="projectForm" onsubmit="event.preventDefault(); saveProject(${clientId});">
                <div class="form-section">
                    <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Project Details</h3>
                    
                    <div class="form-group">
                        <label for="projectName">Project Name *</label>
                        <input type="text" id="projectName" required placeholder="e.g., Website Redesign" 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 14px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="projectDescription">Description</label>
                        <textarea id="projectDescription" placeholder="Project details..." 
                                  style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label for="projectStartDate">Start Date</label>
                            <input type="date" id="projectStartDate" 
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 14px;">
                        </div>
                        
                        <div class="form-group">
                            <label for="projectEndDate">End Date</label>
                            <input type="date" id="projectEndDate" 
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 14px;">
                        </div>
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label for="projectStatus">Status</label>
                            <select id="projectStatus" 
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 14px;">
                                <option value="active">Active</option>
                                <option value="on-hold">On Hold</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="projectBudget">Budget ($)</label>
                            <input type="number" id="projectBudget" step="0.01" placeholder="0.00" 
                                   style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <div class="form-section" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">Initial Milestones (Optional)</h3>
                    <p style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-muted);">Add milestones to track project progress</p>
                    
                    <div id="milestonesContainer">
                        <!-- Milestones will be added here -->
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="addMilestoneField()" style="margin-top: 12px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Milestone
                    </button>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 8px; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Create & Assign Project
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        Cancel
                    </button>
                </div>
            </form>
        `);
        
        // Set default start date to today
        document.getElementById('projectStartDate').valueAsDate = new Date();
        
    } catch (error) {
        console.error('Assign project error:', error);
        showToast('Failed to load project form', 'error');
    }
}

// Add milestone field to the form
let milestoneCounter = 0;
function addMilestoneField() {
    milestoneCounter++;
    const container = document.getElementById('milestonesContainer');
    
    const milestoneDiv = document.createElement('div');
    milestoneDiv.className = 'milestone-field';
    milestoneDiv.id = `milestone-${milestoneCounter}`;
    milestoneDiv.style.cssText = 'padding: 16px; background: var(--bg-hover); border-radius: var(--radius-sm); margin-bottom: 12px; position: relative;';
    
    milestoneDiv.innerHTML = `
        <button type="button" onclick="removeMilestoneField(${milestoneCounter})" 
                style="position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <div class="form-group">
            <label>Milestone Name *</label>
            <input type="text" class="milestone-name" required placeholder="e.g., Design Mockups" 
                   style="width: 100%; padding: 8px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 13px;">
        </div>
        
        <div class="form-group">
            <label>Description</label>
            <textarea class="milestone-description" placeholder="Milestone details..." 
                      style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 13px; resize: vertical;"></textarea>
        </div>
        
        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" class="milestone-due-date" 
                       style="width: 100%; padding: 8px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 13px;">
            </div>
            
            <div class="form-group">
                <label>Status</label>
                <select class="milestone-status" 
                        style="width: 100%; padding: 8px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-size: 13px;">
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
        </div>
    `;
    
    container.appendChild(milestoneDiv);
}

function removeMilestoneField(id) {
    const field = document.getElementById(`milestone-${id}`);
    if (field) {
        field.remove();
    }
}

// Save the project
async function saveProject(clientId) {
    try {
        // Get form values
        const projectData = {
            lead_id: clientId,
            name: document.getElementById('projectName').value.trim(),
            description: document.getElementById('projectDescription').value.trim(),
            start_date: document.getElementById('projectStartDate').value || null,
            end_date: document.getElementById('projectEndDate').value || null,
            status: document.getElementById('projectStatus').value,
            budget: parseFloat(document.getElementById('projectBudget').value) || null
        };
        
        // Validate
        if (!projectData.name) {
            showToast('Please enter a project name', 'error');
            return;
        }
        
        // Create project
        const response = await fetch(`${API_BASE}/projects`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(projectData)
        });
        
        if (!response.ok) {
            throw new Error('Failed to create project');
        }
        
        const data = await response.json();
        const newProject = data.project;
        
        // Collect milestones
        const milestoneFields = document.querySelectorAll('.milestone-field');
        const milestones = [];
        
        for (const field of milestoneFields) {
            const name = field.querySelector('.milestone-name').value.trim();
            if (name) {
                milestones.push({
                    name: name,
                    description: field.querySelector('.milestone-description').value.trim(),
                    due_date: field.querySelector('.milestone-due-date').value || null,
                    status: field.querySelector('.milestone-status').value,
                    completion_percentage: 0
                });
            }
        }
        
        // Create milestones
        for (const milestone of milestones) {
            try {
                await fetch(`${API_BASE}/projects/${newProject.id}/milestones`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(milestone)
                });
            } catch (err) {
                console.error('Failed to create milestone:', err);
            }
        }
        
        showToast(`Project "${projectData.name}" created successfully!`, 'success');
        closeModal();
        
        // Refresh the view if we're looking at this client
        if (state.currentSection === 'clients' && state.selectedClient?.id === clientId) {
            viewClient(clientId);
        }
        
    } catch (error) {
        console.error('Save project error:', error);
        showToast('Failed to create project', 'error');
    }
}

// Add this function:
async function openClientProjects(clientId) {
    try {
        const response = await fetch(`${API_BASE}/client/${clientId}/projects`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Show modal with client's projects
            showModal('Client Projects', `
                <div style="max-height: 60vh; overflow-y: auto;">
                    ${data.projects.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <p>This client has no projects yet.</p>
                            <button class="btn btn-primary" onclick="closeModal(); createProjectForClient(${clientId})">
                                Create First Project
                            </button>
                        </div>
                    ` : data.projects.map(proj => `
                        <div style="padding: 16px; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <h4 style="margin: 0; font-size: 16px;">${proj.name}</h4>
                                <span class="status-badge">${proj.status}</span>
                            </div>
                            <p style="margin: 8px 0; font-size: 13px; color: var(--text-secondary);">${proj.description || 'No description'}</p>
                            <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                                <span>Start: ${proj.start_date ? formatDate(proj.start_date) : 'N/A'}</span>
                                <span>End: ${proj.end_date ? formatDate(proj.end_date) : 'N/A'}</span>
                                <span>Milestones: ${proj.completed_milestones}/${proj.milestone_count}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${data.projects.length > 0 ? `
                    <button class="btn btn-primary" style="margin-top: 16px;" onclick="closeModal(); createProjectForClient(${clientId})">
                        + Add New Project
                    </button>
                ` : ''}
            `);
        }
    } catch (error) {
        console.error('Load client projects error:', error);
        showToast('Failed to load projects', 'error');
    }
}

async function resetClientPassword(clientId) {
    const newPassword = prompt('Enter new password:');
    if (!newPassword) return;

    try {
        const response = await fetch(`${API_URL}/api/admin/client-accounts/${clientId}/reset-password`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ newPassword })
        });

        const data = await response.json();
        if (data.success) {
            showToast('Password reset!', 'success');
        }
    } catch (error) {
        showToast('Error resetting password', 'error');
    }
}

function filterClientUploads(clientId) {
    // Will implement in next version
    console.log('Filter by client:', clientId);
}

async function downloadClientFile(fileId) {
    window.open(`${API_URL}/api/admin/client-uploads/${fileId}/download`, '_blank');
}

function getInitials(name) {
    if (!name) return '?';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// ========================================
// EMAIL TEMPLATE UI COMPONENTS
// Add these functions to your admin_portal.html
// ========================================

// ==================== EMAIL FUNCTIONS ====================

window.showEmailModal = function(leadId, leadName, leadEmail) {
    console.log('Email modal opening for:', leadId, leadName, leadEmail);
    
    const existing = document.getElementById('emailModal_' + leadId);
    if (existing) existing.remove();

    const inFollowUps = state.currentSection === 'followups';

    const modalHtml = `
        <div class="modal-overlay" id="emailModal_${leadId}" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
            <div class="modal" style="background: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow: auto;" onclick="event.stopPropagation()">
                <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">Send Email to ${leadName}</h3>
                    <button onclick="document.getElementById('emailModal_${leadId}').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#6b7280;">&times;</button>
                </div>
                <div style="padding: 20px;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email Template:</label>
                        <select id="emailTemplate_${leadId}" onchange="loadEmailTemplate(${leadId}, '${leadName.replace(/'/g, "\\'")}', '${leadEmail}')" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; box-sizing: border-box; font-size: 14px;">
                            <option value="">-- Select a Template --</option>
                            <option value="valentinessale"> Valentine's Day Sale (25% Off)</option>
                            <option value="springsale"> Spring Sale (25% Off)</option>
                            <option value="blackfriday"> Black Friday Sale (25% Off)</option>
                            <option value="initialsale"> Initial Sale (25% Off Spring)</option>
                            <option value="valentines14"> Valentine's 14% Promo (Original)</option>
                            <option value="initial"> Welcome Email (Professional)</option>
                            <option value="followup"> Follow-Up</option>
                            <option value="custom"> Custom (blank)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">To:</label>
                        <input type="email" value="${leadEmail}" readonly style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #f3f4f6; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Subject:</label>
                        <input type="text" id="emailSubject_${leadId}" placeholder="Email subject" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Message:</label>
                        <textarea id="emailBody_${leadId}" rows="10" placeholder="Type your message here..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; font-family: inherit; box-sizing: border-box;"></textarea>
                    </div>
                    ${inFollowUps ? `
                    <div style="margin-top: 18px; padding: 14px 16px; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <div style="flex: 1;">
                            <div style="font-size: 14px; font-weight: 600; color: #111;">Auto-Campaign</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">Automatically re-send this email every time this lead is due for follow-up</div>
                        </div>
                        <label style="position: relative; width: 44px; height: 24px; flex-shrink: 0; cursor: pointer;">
                            <input type="checkbox" id="autoSwitch_${leadId}" style="opacity:0;width:0;height:0;">
                            <span id="autoTrack_${leadId}" style="position:absolute;inset:0;background:#d1d5db;border-radius:24px;transition:.2s;"><span id="autoThumb_${leadId}" style="position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2);"></span></span>
                        </label>
                    </div>
                    ` : ''}
                </div>
                <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                    <span id="autoLabel_${leadId}" style="display:none;font-size:12px;color:#8a7d5a;margin-right:auto;align-items:center;gap:5px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#D4A847" stroke-width="2.5" style="width:14px;height:14px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                        Auto-campaign will be created
                    </span>
                    <button class="btn btn-secondary" onclick="document.getElementById('emailModal_${leadId}').remove()">Cancel</button>
                    <button class="btn btn-primary" id="sendEmailBtn_${leadId}" onclick="window.doSendEmail(${leadId}, '${leadEmail}')">Send Email</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const overlay = document.getElementById('emailModal_' + leadId);
    overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });

    // Wire toggle animation + label
    const sw = document.getElementById('autoSwitch_' + leadId);
    if (sw) {
        sw.addEventListener('change', function() {
            const track = document.getElementById('autoTrack_' + leadId);
            const thumb = document.getElementById('autoThumb_' + leadId);
            const label = document.getElementById('autoLabel_' + leadId);
            if (this.checked) {
                track.style.background = '#D4A847';
                thumb.style.left = '23px';
                label.style.display = 'flex';
            } else {
                track.style.background = '#d1d5db';
                thumb.style.left = '3px';
                label.style.display = 'none';
            }
        });
    }

    setTimeout(() => document.getElementById('emailTemplate_' + leadId)?.focus(), 100);
};

// Load email template content
window.loadEmailTemplate = function(leadId, leadName, leadEmail) {
    const templateSelect = document.getElementById('emailTemplate_' + leadId);
    const subjectField = document.getElementById('emailSubject_' + leadId);
    const bodyField = document.getElementById('emailBody_' + leadId);
    
    const template = templateSelect.value;
    
    if (template === 'custom' || template === '') {
        subjectField.value = '';
        bodyField.value = '';
        return;
    }
    
    // Define template content
    const templates = {
        valentinessale: {
            subject: `VALENTINE'S DAY: 25% OFF Everything for ${leadName}`,
            body: `[FULL HTML EMAIL WILL BE GENERATED BY SERVER]

This is a beautifully designed HTML email with:
 Pink background with colorful dots
 4 stacked "25% OFF" rows
 "SHOP NOW" call-to-action button
 Professional branding and styling

The server will automatically generate the complete HTML email when you send this.

You can edit the subject line above, but the body will use the pre-designed template.`
        },
        springsale: {
            subject: `Spring Event: 25% OFF Everything for ${leadName}`,
            body: `[FULL HTML EMAIL WILL BE GENERATED BY SERVER]

This is a beautifully designed HTML email with:
 Fresh spring colors with pastel background
 " Spring Event " badge
 Flower emoji decorations
 "Shop Spring Sale" button
 Professional branding and styling

The server will automatically generate the complete HTML email when you send this.

You can edit the subject line above, but the body will use the pre-designed template.`
        },
        blackfriday: {
            subject: `BLACK FRIDAY: 25% OFF Everything for ${leadName}`,
            body: `[FULL HTML EMAIL WILL BE GENERATED BY SERVER]

This is a beautifully designed HTML email with:
 Black background with dramatic styling
 4 stacked "25% OFF" rows (filled + outlined)
 "SHOP NOW" call-to-action button
 Yellow wavy footer
 Professional branding and styling

The server will automatically generate the complete HTML email when you send this.

You can edit the subject line above, but the body will use the pre-designed template.`
        },
        initialsale: {
            subject: `Spring Sale - 25% OFF All Services for ${leadName}`,
            body: `[FULL HTML EMAIL WILL BE GENERATED BY SERVER]

This is a beautifully designed HTML email with:
 Cyan background with subtle pattern
 "25% OFF" headline
 Benefits showcase section
 Service icons grid
 Professional branding and styling

The server will automatically generate the complete HTML email when you send this.

You can edit the subject line above, but the body will use the pre-designed template.`
        },
        valentines14: {
            subject: `Valentine's Day Special - 14% Off for ${leadName}`,
            body: `[FULL HTML EMAIL WILL BE GENERATED BY SERVER]

This is a beautifully designed HTML email with:
 Blue gradient background with tech icons
 Large "14% OFF" graphics
 "START NOW" call-to-action button
 Professional branding and styling

The server will automatically generate the complete HTML email when you send this.

You can edit the subject line above, but the body will use the pre-designed template.`
        },
        initial: {
            subject: `Welcome to Diamondback Coding - ${leadName}`,
            body: `[FULL HTML EMAIL WILL BE GENERATED BY SERVER]

This is a beautifully designed HTML welcome email with:
 Curved header with company branding
 About Us section with feature highlights
 Service cards (Web Dev, CRM, SEO)
 Professional contact information
 Orange accent colors (#F59E0B)

The server will automatically generate the complete HTML email when you send this.

You can edit the subject line above, but the body will use the pre-designed template.`
        },
        followup: {
            subject: `Following Up - ${leadName}`,
            body: `Hi ${leadName},

I wanted to follow up on my previous message about custom development solutions for your business.

Are you still interested in exploring how we could help with:
 Custom CRM systems
 Professional website development
 Business automation tools

Let me know if you'd like to schedule a brief call to discuss your needs.

Looking forward to hearing from you!

Best regards,
Diamondback Coding Team`
        }
    };
    
    if (templates[template]) {
        subjectField.value = templates[template].subject;
        bodyField.value = templates[template].body;
        
        // For HTML templates, disable the body field since server generates it
        if (['valentinessale', 'springsale', 'blackfriday', 'initialsale', 'valentines14', 'initial'].includes(template)) {
            bodyField.disabled = true;
            bodyField.style.opacity = '0.6';
            bodyField.style.cursor = 'not-allowed';
        } else {
            bodyField.disabled = false;
            bodyField.style.opacity = '1';
            bodyField.style.cursor = 'text';
        }
    }
};


window.doSendEmail = async function(leadId, leadEmail) {
    console.log('[EMAIL] Starting send for lead:', leadId);
    
    const subject = document.getElementById('emailSubject_' + leadId)?.value;
    const body = document.getElementById('emailBody_' + leadId)?.value;
    const template = document.getElementById('emailTemplate_' + leadId)?.value || 'custom';
    
    if (!subject || !body) {
        showToast('Please fill in both subject and message', 'error');
        return;
    }
    
    const token = getAuthToken();
    if (!token) {
        showToast('Session expired  please log in again', 'error');
        window.location.href = '/admin/login';
        return;
    }

    const isAuto = document.getElementById('autoSwitch_' + leadId)?.checked || false;

    const sendBtn = document.getElementById('sendEmailBtn_' + leadId);
    if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = 'Sending...'; sendBtn.style.opacity = '0.6'; }
    
    try {
        let response;
        if (isAuto) {
            // Create auto-campaign (server sends first email)
            response = await fetch(`${API_URL}/api/auto-campaigns`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ leadId, subject, body, template })
            });
        } else {
            // Use template endpoint if a template is selected, otherwise use custom send
            if (template && template !== 'custom' && template !== '') {
                // Template-based email - use follow-ups endpoint which handles templates
                response = await fetch(`${API_URL}/api/follow-ups/${leadId}/send-email`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, message: body, template })
                });
            } else {
                // Normal one-shot custom send
                response = await fetch(`${API_URL}/api/email/send-custom`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: leadEmail, subject, body, leadId, isFollowUp: state.currentSection === 'followups' })
                });
            }
        }
        
        if (response.status === 401) {
            showToast('Session expired  please log in again', 'error');
            window.location.href = '/admin/login';
            return;
        }
        
        let responseData = {};
        try { responseData = await response.json(); } catch(e) {}
        
        if (!response.ok) throw new Error(responseData.message || responseData.error || `Server error: ${response.status}`);
        
        // Close modal
        const modal = document.getElementById('emailModal_' + leadId);
        if (modal) modal.remove();
        
        showToast(isAuto ? `Auto-campaign created for ${leadEmail}  first email sent` : `Email sent successfully to ${leadEmail}`, 'success');
        console.log('[EMAIL]  Done');

        await loadLeads();
        updateBadges();
        if (state.currentSection === 'followups') await renderFollowUps(document.getElementById('contentArea'));
        else if (state.currentSection === 'contacted') renderSection('contacted');
        
    } catch (error) {
        console.error('[EMAIL]  Error:', error);
        showToast('Failed: ' + error.message, 'error');
        if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'Send Email'; sendBtn.style.opacity = '1'; }
    }
};






// Helper function to verify auth token is valid
async function verifyAuthToken() {
    const token = getAuthToken();
    
    if (!token) {
        console.warn('[AUTH] No token found');
        return false;
    }
    
    try {
        const response = await fetch(`${API_URL}/api/admin/verify`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            console.log('[AUTH]  Token is valid');
            return true;
        } else {
            console.warn('[AUTH]  Token is invalid or expired');
            return false;
        }
    } catch (error) {
        console.error('[AUTH]  Token verification failed:', error);
        return false;
    }
}

// Function to ensure user is authenticated before sending email
async function ensureAuthenticated() {
    const isValid = await verifyAuthToken();
    
    if (!isValid) {
        alert('Your session has expired. Please log in again.');
        localStorage.removeItem('adminToken');
        sessionStorage.removeItem('adminToken');
        window.location.href = '/admin/login';
        return false;
    }
    
    return true;
}



// Switch between template and compose tabs
function switchEmailTab(tab) {
    document.querySelectorAll('#createModal .tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('emailTemplatesTab').style.display = tab === 'templates' ? 'block' : 'none';
    document.getElementById('emailComposeTab').style.display = tab === 'compose' ? 'block' : 'none';
}

// Select and preview template
async function selectEmailTemplate(templateId, leadId) {
    const template = emailTemplates[templateId];
    const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    
    if (!template || !lead) return;
    
    // Prepare variables
    const variables = {
        clientName: lead.name,
        clientCompany: lead.company || '',
        projectType: lead.project_type || 'your project',
        senderName: 'DIAMONDBACK Team'
    };
    
    // Show preview modal
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Preview & Send: ' + template.name;
    
    const previewSubject = fillTemplate(template.subject, variables);
    const previewBody = fillTemplate(template.body, variables);
    
    bodyEl.innerHTML = `
        <div class="form-group full-width">
            <label class="form-label">To</label>
            <input type="email" class="form-input" value="${lead.email}" readonly>
        </div>
        
        <div class="form-group full-width">
            <label class="form-label">Subject</label>
            <input type="text" class="form-input" id="finalSubject" value="${previewSubject}">
        </div>
        
        <div class="form-group full-width">
            <label class="form-label">Message</label>
            <textarea class="form-textarea" id="finalBody" rows="14">${previewBody}</textarea>
        </div>
        
        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md); margin-top: 16px;">
            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--accent-amber); margin-bottom: 8px;">
                Customize Before Sending
            </div>
            <div style="font-size: 12px; color: var(--text-secondary);">
                Feel free to edit the subject and message above before sending. You can personalize it further or keep it as-is.
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="openEmailTemplateModal(${leadId})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Templates
            </button>
            <button type="button" class="btn btn-primary" onclick="sendFinalEmail(${leadId})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                </svg>
                Send Email
            </button>
        </div>
    `;
}

// Send the final email
async function sendFinalEmail(leadId) {
    const subject = document.getElementById('finalSubject').value;
    const body = document.getElementById('finalBody').value;
    const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    
    if (!subject || !body) {
        showToast('Please fill in subject and message', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/api/email/send-custom`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                to: lead.email,
                toName: lead.name,
                subject: subject,
                body: body,
                leadId: leadId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeCreateModal();
            showToast('Email sent successfully to ' + lead.email, 'success');
            
            // Add note to lead using the proper API
            await fetch(`${API_URL}/api/leads/${leadId}/notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ noteText: `Email sent: "${subject}"` })
            });
        } else {
            showToast('Failed to send email: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('Error sending email', 'error');
    }
}

// Send custom email
async function sendCustomEmail(event, leadId) {
    event.preventDefault();
    
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;
    const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    
    try {
        const response = await fetch(`${API_URL}/api/email/send-custom`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                to: lead.email,
                toName: lead.name,
                subject: subject,
                body: body,
                leadId: leadId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeCreateModal();
            showToast('Email sent successfully', 'success');
        } else {
            showToast('Failed to send email: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('Error sending email', 'error');
    }
}

// Copy to clipboard helper
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied: ' + text, 'success');
    });
}

// ========================================
// EMAIL TEMPLATES SYSTEM
// Add this to your admin portal
// ========================================

// Email template definitions
const emailTemplates = {
    followUp: {
        id: 'follow-up',
        name: 'Follow Up',
        subject: 'Following up on your inquiry',
        category: 'sales',
        body: `Hi {{clientName}},

I wanted to follow up on our recent conversation about {{projectType}}.

I'd love to discuss how we can help bring your vision to life. Are you available for a quick call this week?

Looking forward to hearing from you!

Best regards,
{{senderName}}
DIAMONDBACK`
    },
    
    blackFriday: {
        id: 'blackfriday',
        name: 'Black Friday Sale - 25% Off',
        subject: 'BLACK FRIDAY: 25% OFF Everything | Diamondback Coding',
        category: 'sales',
        description: 'Bold Black Friday promotional email with 4 stacked "25% OFF" rows, tech background, dramatic design',
        body: `Hi {{clientName}},

BLACK FRIDAY - 25% OFF EVERYTHING!

Our biggest sale of the year is here!

EVERYTHING 25% OFF FOR BLACK FRIDAY

Time to upgrade your business:
Our biggest sale of the year is here.

USE CODE: BLACKFRIDAY25

All services included:
 Custom Website Development
 Complete CRM System
 Lead Management Dashboard
 Mobile Design
 Performance Optimization

Limited Time Offer: Valid November 20 - December 3, 2026
New clients only. 25% discount applies to initial project quote.

Ready to get started?
 Visit: https://diamondbackcoding.com/contact.html

Best regards,
DIAMONDBACK CODING`
    },
    
    initialSale: {
        id: 'initialsale',
        name: 'Initial Sale - 25% Off Spring Promo',
        subject: 'Spring Sale - 25% OFF All Services | Diamondback Coding',
        category: 'sales',
        description: 'Professional spring sale email with 25% discount, cyan background, benefits section, service icons',
        body: `Hi {{clientName}},

SPRING SALE - 25% OFF ALL SERVICES!

Transform your business with cutting-edge development and CRM solutions. Save 25% on all new projects started before April 30, 2026.

**Discount applies to one service:**
 25% off per user for CRM Solution OR
 25% off Website Development
 Valid for all packages
 Choose one option per customer

WHY CHOOSE US:
 Fast Project Kickoff - Get started with our streamlined onboarding process
 Dedicated Support Team - Direct access to developers and account managers  
 Professional Results - Cutting-edge solutions built to scale with your business

ALL SERVICES 25% OFF:
 Web Development
 CRM Solutions
 Mobile Design
 Performance Optimization

Limited Time Offer: Valid February 9 - April 30, 2026
New clients only. 25% discount applies to initial project quote.

Ready to get started?
 Visit: https://diamondbackcoding.com/contact.html

Best regards,
DIAMONDBACK CODING
5000 Plaza on the Lake, Suite 100 PMB 2017 Austin, TX 78746
(512) 980-0393 | contact@diamondbackcoding.com`
    },
    
    valentinesSale: {
        id: 'valentinessale',
        name: 'Valentine\'s Day Sale - 25% Off',
        subject: 'VALENTINE\'S DAY: 25% OFF Everything | Diamondback Coding',
        category: 'sales',
        description: 'Bold pink Valentine\'s Day sale email with 4 stacked "25% OFF" rows, colorful dots, festive design',
        body: `Hi {{clientName}},

VALENTINE'S DAY - 25% OFF EVERYTHING!

Our biggest sale of the year is here!

EVERYTHING 25% OFF FOR VALENTINE'S DAY

Time to upgrade your business:
Our biggest sale of the year is here.

USE CODE: VALENTINE25

All services included:
 Custom Website Development
 Complete CRM System
 Lead Management Dashboard
 Mobile Design
 Performance Optimization

Limited Time Offer: Valid February 1 - February 14, 2026
New clients only. 25% discount applies to initial project quote.

Ready to get started?
 Visit: https://diamondbackcoding.com/contact.html

Best regards,
DIAMONDBACK CODING`
    },
    
    springSale: {
        id: 'springsale',
        name: 'Spring Sale - 25% Off Spring Event',
        subject: 'Spring Event: 25% OFF Everything | Diamondback Coding',
        category: 'sales',
        description: 'Fresh spring-themed email with pastel colors, wavy borders, flower icons, flavor vibe showcase',
        body: `Hi {{clientName}},

SPRING SALE - 25% OFF EVERYTHING SPRING!

Celebrate the season with us!

Fresh solutions are blooming! Enjoy 25% off everything in our collection.

 Spring Event 

PICK YOUR SOLUTION VIBE:
 Custom Web Development - Modern & Fresh
 CRM Solutions - Streamlined & Efficient
 Mobile Design - Clean & Professional
 Performance Optimization - Fast & Reliable

All services 25% off during our Spring Event!

Limited Time Offer: Valid March 1 - April 15, 2026
New clients only. 25% discount applies to initial project quote.

Ready to get started?
 Visit: https://diamondbackcoding.com/contact.html

Best regards,
DIAMONDBACK CODING`
    },
    
    valentines14Promo: {
        id: 'valentines14',
        name: 'Valentine\'s 14% Promo (Original)',
        subject: 'Valentine\'s Day Special - 14% Off Just for You!',
        category: 'sales',
        description: 'Eye-catching Valentine\'s promotional email with 14% discount, tech-themed design in company colors (Gold, Black, Blue)',
        body: `Hi {{clientName}},

VALENTINE'S DAY SPECIAL - 14% OFF!

Our biggest sale of the year is here! Get 14% off your first month per user on:

 Custom Website Development - Professional online presence built for your brand
 Complete CRM System - Never miss a lead with automated follow-ups
 Lead Management Dashboard - Track every opportunity in one place
 Client Portal Integration - Seamless communication with customers
 Payment Processing - Accept payments with integrated Stripe
 Analytics & Reporting - Data-driven insights to grow faster
 Dedicated Support - We're with you every step of the way

This 14% Valentine's discount is our way of spreading the love this season. We believe in building lasting partnerships and helping businesses like yours thrive with the right tools.

READY TO BOOST YOUR BUSINESS?
Click here to get started: https://diamondbackcoding.com/contact.html

Offer expires 2/28/2026 - Don't miss out!

Best regards,
{{senderName}}
DIAMONDBACK CODING`
    },
    
    proposal: {
        id: 'proposal',
        name: 'Send Proposal',
        subject: 'Your Custom Project Proposal',
        category: 'sales',
        body: `Hi {{clientName}},

Thank you for considering DIAMONDBACK for {{projectType}}.

I've attached a detailed proposal outlining:
- Project scope and deliverables
- Timeline and milestones
- Investment breakdown
- Our process and approach

Please review at your convenience. I'm happy to answer any questions or schedule a call to discuss further.

Best regards,
{{senderName}}
DIAMONDBACK`
    },
    
    thankYou: {
        id: 'thank-you',
        name: 'Thank You',
        subject: 'Thank you for choosing DIAMONDBACK!',
        category: 'onboarding',
        body: `Hi {{clientName}},

Thank you for choosing DIAMONDBACK for {{projectType}}!

We're excited to work with you and bring your vision to life. Here's what happens next:

1. Project kickoff meeting (scheduled for {{kickoffDate}})
2. Initial design concepts (Week 1-2)
3. Development begins (Week 2+)

I'll be your main point of contact throughout the project. Feel free to reach out anytime!

Best regards,
{{senderName}}
DIAMONDBACK`
    },
    
    projectUpdate: {
        id: 'project-update',
        name: 'Project Update',
        subject: 'Project Update: {{projectName}}',
        category: 'project',
        body: `Hi {{clientName}},

Quick update on {{projectName}}:

Progress: {{progress}}

Next Steps:
{{nextSteps}}

We're on track for delivery by {{deliveryDate}}. Let me know if you have any questions!

Best regards,
{{senderName}}
DIAMONDBACK`
    },
    
    invoiceReminder: {
        id: 'invoice-reminder',
        name: 'Invoice Reminder',
        subject: 'Friendly Reminder: Invoice {{invoiceNumber}} Due Soon',
        category: 'billing',
        body: `Hi {{clientName}},

This is a friendly reminder that invoice {{invoiceNumber}} for ${{amount}} is due on {{dueDate}}.

You can view and pay your invoice here: {{paymentLink}}

If you have any questions or need to discuss payment arrangements, please don't hesitate to reach out.

Thank you for your business!

Best regards,
{{senderName}}
DIAMONDBACK`
    },
    
    projectComplete: {
        id: 'project-complete',
        name: 'Project Complete',
        subject: ' Your Project is Complete!',
        category: 'project',
        body: `Hi {{clientName}},

Great news - {{projectName}} is complete and ready for launch! 

You can view your new {{projectType}} here: {{projectUrl}}

Included in your delivery:
- Full source code
- Documentation
- {{supportPeriod}} days of free support
- Training materials

Thank you for trusting us with your project. We'd love to hear your feedback!

Best regards,
{{senderName}}
DIAMONDBACK`
    },
    
    checkIn: {
        id: 'check-in',
        name: 'Client Check-in',
        subject: 'How are things going?',
        category: 'relationship',
        body: `Hi {{clientName}},

I hope this email finds you well! I wanted to check in and see how everything is going with {{projectType}}.

Are you happy with the results? Is there anything we can help you with?

We're always here to support you and would love to discuss any future projects you might have in mind.

Best regards,
{{senderName}}
DIAMONDBACK`
    },
    
    referralRequest: {
        id: 'referral-request',
        name: 'Request Referral',
        subject: 'Would you recommend us?',
        category: 'relationship',
        body: `Hi {{clientName}},

It's been great working with you on {{projectType}}! We're so glad you're happy with the results.

If you know anyone who could benefit from our services, we'd really appreciate the referral. As a thank you, we offer a 10% discount on future projects for every referral that becomes a client.

Thank you for being an amazing client!

Best regards,
{{senderName}}
DIAMONDBACK`
    }
};

// Variables that can be used in templates
const availableVariables = [
    { name: 'clientName', description: 'Client\'s name' },
    { name: 'clientCompany', description: 'Client\'s company name' },
    { name: 'projectType', description: 'Type of project' },
    { name: 'projectName', description: 'Project name' },
    { name: 'senderName', description: 'Your name' },
    { name: 'invoiceNumber', description: 'Invoice number' },
    { name: 'amount', description: 'Invoice amount' },
    { name: 'dueDate', description: 'Due date' },
    { name: 'paymentLink', description: 'Payment link' },
    { name: 'kickoffDate', description: 'Kickoff date' },
    { name: 'deliveryDate', description: 'Delivery date' },
    { name: 'progress', description: 'Progress update' },
    { name: 'nextSteps', description: 'Next steps' },
    { name: 'projectUrl', description: 'Project URL' },
    { name: 'supportPeriod', description: 'Support period (days)' }
];

// Function to replace template variables
function fillTemplate(template, variables) {
    let filled = template;
    Object.keys(variables).forEach(key => {
        const regex = new RegExp(`{{${key}}}`, 'g');
        filled = filled.replace(regex, variables[key] || '');
    });
    return filled;
}

// Function to send templated email
async function sendTemplatedEmail(templateId, leadId, customVariables = {}) {
    try {
        const template = emailTemplates[templateId];
        if (!template) {
            throw new Error('Template not found');
        }
        
        // Get lead data
        const lead = await fetch(`${API_URL}/api/leads/${leadId}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json());
        
        if (!lead.success) {
            throw new Error('Lead not found');
        }
        
        // Prepare variables
        const variables = {
            clientName: lead.lead.name,
            clientCompany: lead.lead.company || '',
            projectType: lead.lead.project_type || 'your project',
            senderName: 'DIAMONDBACK Team',
            ...customVariables
        };
        
        // Fill template
        const subject = fillTemplate(template.subject, variables);
        const body = fillTemplate(template.body, variables);
        
        // Send email
        const response = await fetch(`${API_URL}/api/email/send-template`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                to: lead.lead.email,
                subject: subject,
                body: body,
                leadId: leadId
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to send email');
        }
        
        return { success: true, message: 'Email sent successfully' };
    } catch (error) {
        console.error('Send template error:', error);
        return { success: false, message: error.message };
    }
}

// Export for use in admin portal
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        emailTemplates,
        availableVariables,
        fillTemplate,
        sendTemplatedEmail
    };
}

function renderAnalytics(content) {
    // Load analytics data
    Promise.all([
        fetch(`${API_URL}/api/analytics/revenue?period=30`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json()),
        fetch(`${API_URL}/api/analytics/funnel`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json()),
        fetch(`${API_URL}/api/analytics/employee-performance`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json()),
        fetch(`${API_URL}/api/analytics/sources`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json())
    ]).then(([revenueData, funnelData, performanceData, sourcesData]) => {
        
        const totalRevenue = revenueData.revenue.reduce((sum, day) => sum + parseFloat(day.revenue), 0);
        const avgDealSize = totalRevenue / (revenueData.revenue.reduce((sum, day) => sum + day.invoice_count, 0) || 1);
        
        content.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">30-Day Revenue</span>
                        <div class="stat-icon amber">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value">$${totalRevenue.toLocaleString()}</div>
                    <div class="stat-change positive">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="18 15 12 9 6 15"/>
                        </svg>
                        ${((totalRevenue / 30) * 30).toLocaleString()}/month avg
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Projected Revenue (90d)</span>
                        <div class="stat-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"/>
                                <path d="M18 17l-5-5-3 3-4-4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value">$${parseFloat(revenueData.projected || 0).toLocaleString()}</div>
                    <div class="stat-change">Based on probability</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Conversion Rate</span>
                        <div class="stat-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value">${funnelData.funnel.conversion_rate}%</div>
                    <div class="stat-change">Last 90 days</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Average Deal Size</span>
                        <div class="stat-icon purple">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18"/>
                                <path d="M9 21V9"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value">$${avgDealSize.toLocaleString()}</div>
                    <div class="stat-change">Per closed deal</div>
                </div>
            </div>
            
            <div class="analytics-grid">
                <!-- Conversion Funnel -->
                <div class="analytics-card">
                    <div class="analytics-header">
                        <h3 class="analytics-title">Conversion Funnel (90 days)</h3>
                    </div>
                    <div style="padding: 20px;">
                        ${renderFunnelChart(funnelData.funnel)}
                    </div>
                </div>
                
                <!-- Lead Sources -->
                <div class="analytics-card">
                    <div class="analytics-header">
                        <h3 class="analytics-title">Lead Sources</h3>
                    </div>
                    <div class="metrics-list">
                        ${sourcesData.sources.map(source => `
                            <div class="metric-item">
                                <div>
                                    <span class="metric-label">${source.source}</span>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                        ${source.conversion_rate}% conversion
                                    </div>
                                </div>
                                <span class="metric-value">${source.count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Revenue Trend -->
                <div class="analytics-card full-width">
                    <div class="analytics-header">
                        <h3 class="analytics-title">30-Day Revenue Trend</h3>
                    </div>
                    <div class="chart-container">
                        ${renderRevenueChart(revenueData.revenue)}
                    </div>
                </div>
                
                <!-- Employee Performance -->
                <div class="analytics-card full-width">
                    <div class="analytics-header">
                        <h3 class="analytics-title">Team Performance</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Total Leads</th>
                                    <th>Converted</th>
                                    <th>Conversion Rate</th>
                                    <th>Total Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${performanceData.performance.map(emp => `
                                    <tr>
                                        <td>
                                            <div class="contact-cell">
                                                <div class="contact-avatar">${getInitials(emp.name)}</div>
                                                <div class="contact-name">${emp.name}</div>
                                            </div>
                                        </td>
                                        <td>${emp.total_leads}</td>
                                        <td>${emp.converted}</td>
                                        <td>
                                            <span style="color: ${emp.conversion_rate >= 20 ? 'var(--status-contacted)' : 'var(--text-muted)'}">
                                                ${emp.conversion_rate}%
                                            </span>
                                        </td>
                                        <td style="font-family: var(--font-mono); font-weight: 600;">
                                            $${parseFloat(emp.total_revenue).toLocaleString()}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Email Open Rate Report -->
            <div id="emailOpenReport" style="margin-top: 28px;">
                <div style="background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 4px 0 0 0; overflow: hidden;">
                    <div style="padding: 20px 24px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;color:var(--text-secondary);">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            <h3 style="font-size: 16px; font-weight: 700; margin: 0;">Email Open Rate Report</h3>
                        </div>
                        <span style="font-size: 12px; color: var(--text-muted);">Follow-up emails sent through the system</span>
                    </div>
                    <div id="emailOpenReportContent" style="padding: 24px;">
                        <div style="text-align: center; color: var(--text-muted);">Loading email report...</div>
                    </div>
                </div>
            </div>
        `;

        // Load email open report asynchronously
        loadEmailOpenReport();
    });
}

async function loadEmailOpenReport() {
    const container = document.getElementById('emailOpenReportContent');
    if (!container) return;
    try {
        const res = await fetch(`${API_URL}/api/analytics/email-opens`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        const s = data.stats || {};
        const sent = parseInt(s.total_sent) || 0;
        const opened = parseInt(s.total_opened) || 0;
        const clicked = parseInt(s.total_clicked) || 0;
        const openRate = sent > 0 ? ((opened / sent) * 100).toFixed(1) : '0.0';
        const clickRate = sent > 0 ? ((clicked / sent) * 100).toFixed(1) : '0.0';
        const hotConversions = parseInt(s.opened_and_became_hot) || 0;

        const recentRows = (data.recent_opens || []).slice(0, 20).map(e => {
            const isOpened = !!e.opened_at;
            const isClicked = !!e.clicked_at;
            const isHot = e.lead_temperature === 'hot';
            return `<tr>
                <td style="max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${e.lead_name || ''}</td>
                <td style="max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--text-muted); font-size:12px;">${e.lead_email || ''}</td>
                <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${e.subject || ''}</td>
                <td>${e.sent_at ? formatDate(e.sent_at) : ''}</td>
                <td>
                    ${isOpened
                        ? `<span style="background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;"> Opened</span>`
                        : `<span style="background:#f3f4f6;color:#9ca3af;padding:2px 8px;border-radius:10px;font-size:11px;">Not opened</span>`
                    }
                </td>
                <td>
                    ${isClicked
                        ? `<span style="background:#dbeafe;color:#1d4ed8;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;"> Clicked</span>`
                        : `<span style="background:#f3f4f6;color:#9ca3af;padding:2px 8px;border-radius:10px;font-size:11px;"></span>`
                    }
                </td>
                <td>${isHot ? '<span style="background:#fef2f2;color:#ef4444;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;">HOT</span>' : '<span style="color:var(--text-muted);font-size:12px;">Cold</span>'}</td>
            </tr>`;
        }).join('');

        container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="background:var(--bg-secondary);border-radius:8px;padding:16px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;color:var(--text-primary);">${sent.toLocaleString()}</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Emails Sent</div>
                </div>
                <div style="background:#f0fdf4;border-radius:8px;padding:16px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;color:#16a34a;">${openRate}%</div>
                    <div style="font-size:12px;color:#16a34a;margin-top:4px;">Open Rate <span style="color:var(--text-muted);">(${opened.toLocaleString()} opens)</span></div>
                </div>
                <div style="background:#eff6ff;border-radius:8px;padding:16px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;color:#1d4ed8;">${clickRate}%</div>
                    <div style="font-size:12px;color:#1d4ed8;margin-top:4px;">Click Rate <span style="color:var(--text-muted);">(${clicked.toLocaleString()} clicks)</span></div>
                </div>
                <div style="background:#fef9f0;border-radius:8px;padding:16px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;color:#d97706;">${hotConversions.toLocaleString()}</div>
                    <div style="font-size:12px;color:#d97706;margin-top:4px;">Opened  Became Hot</div>
                </div>
            </div>
            ${sent === 0 ? `<div style="text-align:center;padding:40px;color:var(--text-muted);">No emails logged yet. Open tracking will populate as follow-up emails are sent.</div>` : `
            <div style="overflow-x:auto;">
                <table class="data-table" style="min-width:800px;">
                    <thead>
                        <tr>
                            <th>Lead</th>
                            <th>Email</th>
                            <th>Subject</th>
                            <th>Sent</th>
                            <th>Opened</th>
                            <th>Clicked</th>
                            <th>Temp</th>
                        </tr>
                    </thead>
                    <tbody>${recentRows || '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);">No emails recorded yet</td></tr>'}</tbody>
                </table>
            </div>
            `}
        `;
    } catch (e) {
        if (container) container.innerHTML = `<div style="color:var(--text-muted);text-align:center;padding:20px;">Could not load email report. The tracking data will populate as emails are sent.</div>`;
    }
}

function renderFunnelChart(funnel) {
    const stages = [
        { label: 'New Leads', count: funnel.new_leads, color: 'var(--status-new)' },
        { label: 'Contacted', count: funnel.contacted, color: 'var(--status-contacted)' },
        { label: 'Pending', count: funnel.pending, color: 'var(--status-pending)' },
        { label: 'Converted', count: funnel.converted, color: 'var(--status-closed)' }
    ];
    
    const maxCount = Math.max(...stages.map(s => s.count));
    
    return stages.map((stage, index) => {
        const width = (stage.count / maxCount) * 100;
        const dropoff = index > 0 ? stages[index - 1].count - stage.count : 0;
        
        return `
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 13px; font-weight: 600;">${stage.label}</span>
                    <span style="font-size: 14px; font-weight: 700; font-family: var(--font-mono);">${stage.count}</span>
                </div>
                <div style="position: relative; height: 30px; background: var(--bg-hover); border-radius: 4px; overflow: hidden;">
                    <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${width}%; background: ${stage.color}; border-radius: 4px; transition: width 0.5s ease;"></div>
                </div>
                ${dropoff > 0 ? `
                    <div style="font-size: 11px; color: var(--status-lost); margin-top: 4px;">
                         ${dropoff} dropped off (${((dropoff / stages[index - 1].count) * 100).toFixed(1)}%)
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function renderRevenueChart(data) {
    if (!data || data.length === 0) {
        return '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No revenue data yet</div>';
    }
    
    const maxRevenue = Math.max(...data.map(d => parseFloat(d.revenue)));
    
    return data.reverse().map(day => {
        const height = (parseFloat(day.revenue) / maxRevenue) * 180;
        const date = new Date(day.date);
        
        return `
            <div class="chart-bar" style="height: ${height}px; min-height: 24px;">
                <div class="chart-bar-value">$${parseFloat(day.revenue).toLocaleString()}</div>
                <div class="chart-bar-label">${date.getMonth() + 1}/${date.getDate()}</div>
            </div>
        `;
    }).join('');
}

// Find and REPLACE the renderInvoices function with this fixed version:
function renderInvoices(content) {
    // Filter by status first
    let filtered = state.invoices;
    if (state.currentFilter && state.currentFilter !== 'all') {
        filtered = filtered.filter(inv => inv.status === state.currentFilter);
    }
    
    // Then apply search
    if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        filtered = filtered.filter(inv => 
            inv.invoice_number.toLowerCase().includes(query) ||
            (inv.customer_name && inv.customer_name.toLowerCase().includes(query)) ||
            (inv.customer_email && inv.customer_email.toLowerCase().includes(query)) ||
            (inv.customer_company && inv.customer_company.toLowerCase().includes(query))
        );
    }
    
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" class="search-input" id="invoiceSearch" placeholder="Search invoices by number or customer..." value="${state.searchQuery}" onkeyup="handleInvoiceSearch(event)">
            </div>
            <div class="filter-group">
                <button class="filter-btn ${state.currentFilter === 'all' ? 'active' : ''}" onclick="filterInvoices('all')">All</button>
                <button class="filter-btn ${state.currentFilter === 'draft' ? 'active' : ''}" onclick="filterInvoices('draft')">Draft</button>
                <button class="filter-btn ${state.currentFilter === 'sent' ? 'active' : ''}" onclick="filterInvoices('sent')">Sent</button>
                <button class="filter-btn ${state.currentFilter === 'paid' ? 'active' : ''}" onclick="filterInvoices('paid')">Paid</button>
                <button class="filter-btn ${state.currentFilter === 'overdue' ? 'active' : ''}" onclick="filterInvoices('overdue')">Overdue</button>
            </div>
        </div>
        
        <div class="cards-grid">
            ${filtered.length > 0 ? filtered.map(inv => `
                <div class="card invoice-card" style="cursor: pointer;" onclick="openInvoiceDetail(${inv.id})">
                    <div class="invoice-card-header">
                        <div>
                            <div class="invoice-card-number">${inv.invoice_number}</div>
                            <div class="invoice-card-customer">${inv.customer_name || 'Unknown'}</div>
                        </div>
                        <span class="status-badge status-${inv.status}">
                            <span class="status-dot"></span>
                            ${inv.status}
                        </span>
                    </div>
                    <div>
                        <div class="invoice-card-amount">$${parseFloat(inv.total_amount).toLocaleString()}</div>
                        <div class="invoice-card-meta">
                            <div class="invoice-card-meta-item">
                                <div class="invoice-card-meta-label">Issued</div>
                                <div class="invoice-card-meta-value">${formatDate(inv.issue_date)}</div>
                            </div>
                            <div class="invoice-card-meta-item">
                                <div class="invoice-card-meta-label">Due</div>
                                <div class="invoice-card-meta-value">${formatDate(inv.due_date)}</div>
                            </div>
                        </div>
                    </div>
${inv.status !== 'paid' ? `
    <div style="display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
        ${inv.stripe_payment_link ? `
            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); copyPaymentLink('${inv.stripe_payment_link}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                Copy Link
            </button>
        ` : ''}
        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); openInvoiceDetail(${inv.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            View
        </button>
        <button class="btn btn-sm btn-success" style="flex: 1;" onclick="event.stopPropagation(); openPaymentModal(${inv.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            Mark Paid
        </button>
        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteInvoice(${inv.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
        </button>
    </div>
` : `
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
        <button class="btn btn-sm btn-secondary" style="width: 100%;" onclick="event.stopPropagation(); openInvoiceDetail(${inv.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            View Invoice
        </button>
    </div>
`}
                </div>
            `).join('') : `
                <div style="grid-column: 1 / -1;">
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div class="empty-title">No invoices found</div>
                        <div class="empty-description">
                            ${state.searchQuery ? 'Try adjusting your search' : 'Create your first invoice to get started'}
                        </div>
                    </div>
                </div>
            `}
        </div>
    `;
}

// ADD THIS NEW FUNCTION (place it after renderInvoices):
async function openInvoiceDetail(invoiceId) {
    console.log(' [INVOICE DETAIL] Function called with ID:', invoiceId);
    
    try {
        // CRITICAL: Ensure invoices are loaded first
        if (!state.invoices || state.invoices.length === 0) {
            console.log(' [INVOICE DETAIL] Invoices not in state, loading...');
            await loadInvoices();
        }
        
        console.log(' [INVOICE DETAIL] Total invoices in state:', state.invoices?.length);
        console.log(' [INVOICE DETAIL] Looking for invoice ID:', invoiceId, 'Type:', typeof invoiceId);
        
        // Find invoice - try both as number and string
        let invoice = state.invoices.find(i => i.id === parseInt(invoiceId));
        if (!invoice) {
            invoice = state.invoices.find(i => i.id == invoiceId); // Use loose equality
        }
        
        if (!invoice) {
            console.error(' [INVOICE DETAIL] Invoice not found!');
            console.error('Available IDs:', state.invoices.map(i => i.id));
            showToast('Invoice not found', 'error');
            return;
        }
        
        console.log(' [INVOICE DETAIL] Found invoice:', invoice.invoice_number);
        
        // Set current invoice in state
        state.currentInvoice = invoice;
        
        // Call the detail modal
        await openDetailModal('invoice', invoiceId);
        
    } catch (error) {
        console.error(' [INVOICE DETAIL] Error:', error);
        showToast('Error opening invoice: ' + error.message, 'error');
    }
}

function renderTasks(content) {
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" class="search-input" placeholder="Search tasks...">
            </div>
            <button class="btn btn-primary" onclick="openCreateModal('task')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Task
            </button>
        </div>
        
        <div class="tasks-container">
            ${state.tasks.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <div class="task-due ${new Date(task.dueDate) < new Date() && !task.completed ? 'overdue' : ''}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                ${formatDate(task.dueDate)}
                            </div>
                            <span>${task.assignee}</span>
                            <span class="priority-badge priority-${task.priority}">${task.priority}</span>
                        </div>
                    </div>
                    <div class="table-actions">
                        <button class="table-action-btn danger" onclick="deleteTask(${task.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderSettings(content) {
    // Set default tab if not set
    if (!state.currentSettingsTab) {
        state.currentSettingsTab = 'profile';
    }
    
    content.innerHTML = `
        <div class="settings-layout">
            <div class="settings-nav">
                <div class="settings-nav-item ${state.currentSettingsTab === 'profile' ? 'active' : ''}" onclick="switchSettingsTab('profile')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/>
                        <path d="M12 14c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z"/>
                    </svg>
                    Profile
                </div>
                <div class="settings-nav-item ${state.currentSettingsTab === 'notifications' ? 'active' : ''}" onclick="switchSettingsTab('notifications')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    Notifications
                </div>
                <div class="settings-nav-item ${state.currentSettingsTab === 'security' ? 'active' : ''}" onclick="switchSettingsTab('security')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    Security
                </div>
            </div>
            
            <div class="settings-panel" id="settingsPanelContent">
                ${renderSettingsTabContent(state.currentSettingsTab)}
            </div>
        </div>
    `;
}

function renderSettingsTabContent(tab) {
    if (tab === 'profile') {
        return `
            <div class="settings-section">
                <h3 class="settings-section-title">Account Information</h3>
                <p class="settings-section-desc">Manage your account details</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Username</div>
                        <div class="setting-desc">admin</div>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Email</div>
                        <div class="setting-desc">admin@craftedcode.dev</div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Appearance</h3>
                <p class="settings-section-desc">Customize the look and feel</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Dark Mode</div>
                        <div class="setting-desc">Use dark theme across the app</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.darkMode ? 'checked' : ''} onchange="toggleSetting('darkMode')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Automation</h3>
                <p class="settings-section-desc">Configure automated workflows</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Auto-assign Leads</div>
                        <div class="setting-desc">Automatically assign new leads to team members</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.autoAssign ? 'checked' : ''} onchange="toggleSetting('autoAssign')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        `;
    } else if (tab === 'notifications') {
        return `
            <div class="settings-section">
                <h3 class="settings-section-title">Notification Preferences</h3>
                <p class="settings-section-desc">Control how and when you receive notifications</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Email Notifications</div>
                        <div class="setting-desc">Receive email alerts for important events</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.emailNotifications ? 'checked' : ''} onchange="toggleSetting('emailNotifications')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">New Lead Notifications</div>
                        <div class="setting-desc">Get notified when new leads submit the contact form</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.newLeadNotifications !== false ? 'checked' : ''} onchange="toggleSetting('newLeadNotifications')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Payment Notifications</div>
                        <div class="setting-desc">Receive alerts when invoices are paid</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.paymentNotifications !== false ? 'checked' : ''} onchange="toggleSetting('paymentNotifications')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Task Reminders</div>
                        <div class="setting-desc">Get reminders for upcoming and overdue tasks</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.taskReminders !== false ? 'checked' : ''} onchange="toggleSetting('taskReminders')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Weekly Reports</div>
                        <div class="setting-desc">Receive a weekly summary of your CRM activity</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.weeklyReport ? 'checked' : ''} onchange="toggleSetting('weeklyReport')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Browser Notifications</div>
                        <div class="setting-desc">Show desktop notifications for real-time updates</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.pushNotifications ? 'checked' : ''} onchange="toggleSetting('pushNotifications')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Notification Schedule</h3>
                <p class="settings-section-desc">Set quiet hours to avoid notifications during specific times</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Quiet Hours</div>
                        <div class="setting-desc">Pause notifications during these hours</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.quietHours ? 'checked' : ''} onchange="toggleSetting('quietHours')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                ${state.settings.quietHours ? `
                <div class="setting-row" style="padding-left: 20px; border-left: 3px solid var(--accent-amber);">
                    <div class="setting-info">
                        <div class="setting-label">From</div>
                        <input type="time" class="form-input" value="${state.settings.quietHoursStart || '22:00'}" onchange="updateQuietHours('start', this.value)" style="max-width: 150px;">
                    </div>
                    <div class="setting-info" style="margin-left: 20px;">
                        <div class="setting-label">To</div>
                        <input type="time" class="form-input" value="${state.settings.quietHoursEnd || '08:00'}" onchange="updateQuietHours('end', this.value)" style="max-width: 150px;">
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    } else if (tab === 'security') {
        return `
            <div class="settings-section">
                <h3 class="settings-section-title">Password & Authentication</h3>
                <p class="settings-section-desc">Manage your login credentials and security settings</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Change Password</div>
                        <div class="setting-desc">Update your account password</div>
                    </div>
                    <button class="btn btn-secondary" onclick="openChangePasswordModal()">Change Password</button>
                </div>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Two-Factor Authentication</div>
                        <div class="setting-desc">Add an extra layer of security to your account</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.twoFactorAuth ? 'checked' : ''} onchange="toggleSetting('twoFactorAuth')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Session Management</h3>
                <p class="settings-section-desc">Control your login sessions and timeouts</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Session Timeout</div>
                        <div class="setting-desc">Automatically log out after period of inactivity</div>
                    </div>
                    <select class="form-select" onchange="updateSessionTimeout(this.value)" style="max-width: 200px;">
                        <option value="15" ${state.settings.sessionTimeout === 15 ? 'selected' : ''}>15 minutes</option>
                        <option value="30" ${state.settings.sessionTimeout === 30 ? 'selected' : ''}>30 minutes</option>
                        <option value="60" ${state.settings.sessionTimeout === 60 ? 'selected' : ''}>1 hour</option>
                        <option value="120" ${state.settings.sessionTimeout === 120 ? 'selected' : ''}>2 hours</option>
                        <option value="480" ${state.settings.sessionTimeout === 480 ? 'selected' : ''}>8 hours</option>
                        <option value="0" ${state.settings.sessionTimeout === 0 ? 'selected' : ''}>Never</option>
                    </select>
                </div>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Active Sessions</div>
                        <div class="setting-desc">View and manage your active login sessions</div>
                    </div>
                    <button class="btn btn-secondary" onclick="showActiveSessions()">View Sessions</button>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Access Control</h3>
                <p class="settings-section-desc">Restrict access to your account</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">IP Whitelist</div>
                        <div class="setting-desc">Only allow logins from specific IP addresses</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.ipWhitelistEnabled ? 'checked' : ''} onchange="toggleSetting('ipWhitelistEnabled')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                ${state.settings.ipWhitelistEnabled ? `
                <div class="setting-row" style="padding-left: 20px; border-left: 3px solid var(--accent-amber);">
                    <div class="setting-info full-width">
                        <div class="setting-label">Allowed IP Addresses</div>
                        <div class="setting-desc">Enter one IP address per line</div>
                        <textarea class="form-textarea" rows="4" placeholder="192.168.1.1
10.0.0.1" onchange="updateIPWhitelist(this.value)" style="margin-top: 12px; font-family: monospace;">${(state.settings.ipWhitelist || []).join('\n')}</textarea>
                    </div>
                </div>
                ` : ''}
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Login Alerts</div>
                        <div class="setting-desc">Get notified of new login attempts</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${state.settings.loginAlerts !== false ? 'checked' : ''} onchange="toggleSetting('loginAlerts')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-section-title">Activity Log</h3>
                <p class="settings-section-desc">View recent security-related activities</p>
                
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Recent Activity</div>
                        <div class="setting-desc">Last login: ${new Date().toLocaleString()}</div>
                    </div>
                    <button class="btn btn-secondary" onclick="showActivityLog()">View Full Log</button>
                </div>
            </div>
        `;
    }
}

function switchSettingsTab(tab) {
    state.currentSettingsTab = tab;
    document.getElementById('settingsPanelContent').innerHTML = renderSettingsTabContent(tab);
    
    // Update nav items
    document.querySelectorAll('.settings-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.settings-nav-item').classList.add('active');
}
// ========================================
// MODAL FUNCTIONS
// ========================================
async function openDetailModal(type, id) {
    const modal = document.getElementById('detailModal');
    const titleEl = document.getElementById('detailModalTitle');
    const bodyEl = document.getElementById('detailModalBody');
    const footerEl = document.getElementById('detailModalFooter');
    
    if (type === 'lead') {
        const lead = [...state.leads, ...state.customers].find(l => l.id === id);
        if (!lead) return;
        
        state.currentLead = lead;
        const expenses = await loadExpenses(id);
        
        // Fetch notes from the API (lead_notes table)
        let notes = [];
        try {
            const notesResponse = await fetch(`${API_URL}/api/leads/${id}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (notesResponse.ok) {
                const data = await notesResponse.json();
                notes = data.notes || [];
            }
        } catch (err) {
            console.error('Error fetching notes:', err);
        }
        
        const leadInvoices = state.invoices.filter(inv => inv.lead_id === id);
        
        titleEl.textContent = `${lead.is_customer ? 'Customer' : 'Lead'} Details`;
        
        bodyEl.innerHTML = `
            <div class="detail-section">
                <div class="section-header">
                    <h3 class="section-title">Contact Information</h3>
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Name</div>
                        <div class="detail-value">${lead.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${lead.email}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone</div>
                        <div class="detail-value">${lead.phone || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Company</div>
                        <div class="detail-value">${lead.company || 'N/A'}</div>
                    </div>
                    <div class="detail-item full-width">
                        <div class="detail-label">Billing Address</div>
                        <div class="detail-value">
                            ${lead.address_line1 || lead.address_line2 || lead.city ? `
                                ${lead.address_line1 ? lead.address_line1 + '<br>' : ''}
                                ${lead.address_line2 ? lead.address_line2 + '<br>' : ''}
                                ${lead.city ? lead.city + ', ' : ''}${lead.state || ''} ${lead.zip_code || ''}
                                ${lead.country && lead.country !== 'USA' ? '<br>' + lead.country : ''}
                            ` : '<span style="color: var(--text-muted);">No address on file</span>'}
                        </div>
                    </div>
                    <div class="detail-item full-width">
                        <div class="detail-label">Message</div>
                        <div class="detail-value">${lead.message || 'N/A'}</div>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="section-header">
                    <h3 class="section-title">Project Details</h3>
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Project Type</div>
                        <div class="detail-value">${lead.project_type || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Budget</div>
                        <div class="detail-value">${lead.budget ? `$${parseFloat(lead.budget).toLocaleString()}` : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Timeline</div>
                        <div class="detail-value">${lead.timeline || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <span class="status-badge status-${lead.status}">
                                <span class="status-dot"></span>
                                ${lead.status}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Priority</div>
                        <div class="detail-value">
                            <span class="priority-badge priority-${lead.priority || 'low'}">${lead.priority || 'low'}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email Status</div>
                        <div class="detail-value">
                            ${lead.unsubscribed 
                                ? '<span style="display:inline-flex;align-items:center;gap:6px;background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:6px;padding:4px 10px;font-size:13px;font-weight:600;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> Unsubscribed</span>'
                                : '<span style="color:var(--text-muted);font-size:13px;">Subscribed</span>'
                            }
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Created</div>
                        <div class="detail-value">${formatDate(lead.created_at)}</div>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="section-header">
                    <h3 class="section-title">Expenses</h3>
                </div>
                <div class="expense-list">
                    ${expenses.length > 0 ? expenses.map(exp => `
                        <div class="expense-item ${state.selectedExpenses.includes(exp.id) ? 'selected' : ''}" data-expense-id="${exp.id}">
                            <div class="expense-checkbox ${state.selectedExpenses.includes(exp.id) ? 'checked' : ''}" onclick="toggleExpense(${exp.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="expense-content">
                                <div class="expense-description">${exp.description}</div>
                                <div class="expense-meta">
                                    <div class="expense-meta-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        ${formatDate(exp.expense_date)}
                                    </div>
                                    ${exp.category ? `<span>${exp.category}</span>` : ''}
                                </div>
                            </div>
                            <div class="expense-amount">$${parseFloat(exp.amount).toLocaleString()}</div>
                            <div class="expense-actions">
                                <button class="table-action-btn danger" onclick="event.stopPropagation(); deleteExpense(${exp.id})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('') : '<div class="expense-empty">No expenses recorded yet</div>'}
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="openCreateModal('expense', ${id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Expense
                </button>
            </div>
            
            <div class="detail-section">
                <div class="section-header">
                    <h3 class="section-title">Invoices</h3>
                </div>
                <div class="expense-list">
                    ${leadInvoices.length > 0 ? leadInvoices.map(inv => `
                        <div class="expense-item" style="cursor: pointer;" onclick="closeDetailModal(); setTimeout(() => openDetailModal('invoice', ${inv.id}), 100);">
                            <div class="expense-content">
                                <div class="expense-description" style="font-family: var(--font-mono); font-weight: 600;">${inv.invoice_number}</div>
                                <div class="expense-meta">
                                    <div class="expense-meta-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        ${formatDate(inv.issue_date)}
                                    </div>
                                    <span>Due: ${formatDate(inv.due_date)}</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="status-badge status-${inv.status}">
                                    <span class="status-dot"></span>
                                    ${inv.status}
                                </span>
                                <div class="expense-amount">$${parseFloat(inv.total_amount).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('') : '<div class="expense-empty">No invoices yet</div>'}
                </div>
                ${leadInvoices.length > 0 ? `
                    <div style="display: flex; gap: 16px; margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-subtle);">
                        <div style="flex: 1; text-align: center;">
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Total Invoiced</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary); font-family: var(--font-mono);">$${leadInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0).toLocaleString()}</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Paid</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--status-contacted); font-family: var(--font-mono);">$${leadInvoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0).toLocaleString()}</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Outstanding</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--status-pending); font-family: var(--font-mono);">$${leadInvoices.filter(inv => inv.status !== 'paid' && inv.status !== 'cancelled').reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0).toLocaleString()}</div>
                        </div>
                    </div>
                ` : ''}
            </div>
            
            <div class="detail-section">
                <div class="section-header">
                    <h3 class="section-title">Documents</h3>
                </div>
                <div id="documentsSection${id}" class="documents-section">
                    <div class="documents-list" id="documentsList${id}">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading documents...</div>
                    </div>
                    <div class="document-upload-area" style="margin-top: 16px;">
                        <input type="file" id="documentUpload${id}" multiple style="display: none;" onchange="handleDocumentUpload(${id}, this.files)">
                        <button class="btn btn-secondary" style="width: 100%;" onclick="document.getElementById('documentUpload${id}').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Upload Documents
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="section-header">
                    <h3 class="section-title">Projects & Milestones</h3>
                </div>
                <div class="expense-list" id="projectsList${id}">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading projects...</div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="openCreateProjectModal(${id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Create Project
                </button>
            </div>
            
            <div class="detail-section">
                <div class="section-header">
                    <h3 class="section-title">Notes</h3>
                </div>
                <div class="notes-list">
                    ${notes.length > 0 ? notes.map(note => `
                        <div class="note-item">
                            <div class="note-header">
                                <span class="note-author">${note.created_by ? `Admin User #${note.created_by}` : 'System'}</span>
                                <span class="note-date">${formatDate(note.created_at)}</span>
                            </div>
                            <div class="note-text">${note.note_text}</div>
                        </div>
                    `).join('') : '<div class="note-empty">No notes yet</div>'}
                </div>
                <div class="form-group full-width">
                    <textarea class="form-textarea" id="newNote" placeholder="Add a new note..."></textarea>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addNote(${id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Note
                    </button>
                </div>
            </div>
        `;
        
        // Load documents for this lead/customer
        loadLeadDocuments(id);
        
        // Load projects for this lead/customer
        loadLeadProjects(id);
        
        footerEl.innerHTML = `
            <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
            <button class="btn btn-primary" onclick="editCustomer(${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit ${lead.is_customer ? 'Customer' : 'Lead'}
            </button>
            <button class="btn btn-secondary" onclick="changeLeadStatus(${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Change Status
            </button>
            ${!lead.is_customer ? `
                <button class="btn btn-success" onclick="convertToCustomer(${id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <polyline points="17 11 19 13 23 9"/>
                    </svg>
                    Convert to Customer
                </button>
            ` : ''}
            <button class="btn btn-secondary" onclick="assignEmployee(${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <line x1="20" y1="8" x2="20" y2="14"/>
                    <line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Assign Employee
            </button>
            <button class="btn btn-secondary" onclick="changePriority(${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                Change Priority
            </button>
            ${state.selectedExpenses.length > 0 ? `
                <button class="btn btn-success" onclick="createInvoiceFromExpenses()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Create Invoice (${state.selectedExpenses.length} selected)
                </button>
            ` : `
                <button class="btn btn-primary" onclick="openCreateModal('invoice', ${id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Create Invoice
                </button>
            `}
            <button class="btn btn-danger" onclick="deleteLead(${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete
            </button>
        `;
        
        modal.classList.add('active');
        
    } else if (type === 'invoice') {
        console.log(' Opening invoice modal for ID:', id);
        const invoice = state.invoices.find(i => i.id === id);
        if (!invoice) {
            console.error(' Invoice not found:', id);
            showToast('Invoice not found', 'error');
            return;
        }

        console.log(' Invoice found:', invoice);
        
        state.currentInvoice = invoice;
        
        titleEl.textContent = 'Invoice Details';
        
        // Generate the preview HTML
        const previewHTML = await renderInvoicePreview(invoice);
        bodyEl.innerHTML = previewHTML;

        // Build footer buttons
        let footerButtons = `
            <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
        `;

        // Add email button
        if (invoice.customer_email) {
            footerButtons += `
                <button class="btn btn-secondary" onclick="emailInvoiceToClient()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Email to Client
                </button>
            `;
        }

        // Add Mark as Paid button if not already paid
        if (invoice.status !== 'paid' && invoice.status !== 'void' && invoice.status !== 'cancelled') {
            footerButtons += `
                <button class="btn btn-success" onclick="openPaymentModal(${invoice.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Mark as Paid
                </button>
            `;
        }

        // Add print button
        footerButtons += `
            <button class="btn btn-primary" onclick="printInvoice()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 6 2 18 2 18 9"/>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                    <rect x="6" y="14" width="12" height="8"/>
                </svg>
                Print Invoice
            </button>
        `;

        // Add delete button (only for non-paid invoices)
        if (invoice.status !== 'paid') {
            footerButtons += `
                <button class="btn btn-danger" onclick="deleteInvoice(${invoice.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Delete Invoice
                </button>
            `;
        }

        footerEl.innerHTML = footerButtons;
        
        modal.classList.add('active');
        
    } else if (type === 'employee') {
        const employee = state.employees.find(e => e.id === id);
        if (!employee) return;
        
        titleEl.textContent = 'Employee Details';
        bodyEl.innerHTML = `
            <div class="detail-section">
                <h3>Employee Information</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Name</div>
                        <div class="detail-value">${employee.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${employee.email}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone</div>
                        <div class="detail-value">${employee.phone || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Role</div>
                        <div class="detail-value">${employee.role || 'N/A'}</div>
                    </div>
                </div>
            </div>
        `;
        
        footerEl.innerHTML = `
            <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
            <button class="btn btn-primary" onclick="closeDetailModal(); editEmployee(${employee.id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit Employee
            </button>
            <button class="btn btn-danger" onclick="deleteEmployee(${employee.id})">Delete</button>
        `;
        
        modal.classList.add('active');
    }
}
async function renderInvoicePreview(invoice) {
    const items = invoice.items || [];
    const taxAmount = parseFloat(invoice.tax_amount || 0);
    const discount = parseFloat(invoice.discount_amount || 0);
    
    // Generate or use existing Stripe payment link
    let paymentUrl = null;

    // If invoice already has a Stripe payment link, use it
    if (invoice.stripe_payment_link) {
        paymentUrl = invoice.stripe_payment_link;
        console.log(' Using existing payment link:', paymentUrl);
    } else if (invoice.id && invoice.status !== 'paid') {
        // Create new payment link
        try {
            console.log(' Creating payment link for invoice:', invoice.id);
            const response = await fetch(`${API_URL}/api/invoices/${invoice.id}/payment-link`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.paymentLink) {
                    paymentUrl = data.paymentLink;
                    invoice.stripe_payment_link = data.paymentLink;
                    console.log(' Stripe payment link created:', paymentUrl);
                } else {
                    console.warn(' Payment link creation returned success but no link');
                }
            } else {
                const errorText = await response.text();
                console.error(' Failed to create payment link:', response.status, errorText);
            }
        } catch (error) {
            console.error(' Error generating payment link:', error);
        }
    }

    // If no payment link available, use fallback
    if (!paymentUrl) {
        paymentUrl = `${FRONTEND_BASE_URL}/invoice/${invoice.invoice_number}`;
        console.log(' Using fallback URL:', paymentUrl);
    }
    
    // Generate unique QR code ID
    const qrCodeId = `qr-code-${invoice.id || Date.now()}`;
    
    const html = `
        <div class="invoice-preview">
            <div class="invoice-preview-header">
                <div class="invoice-company">
                    <div class="invoice-company-logo">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <div>
                        <div class="invoice-company-name">DIAMONDBACK</div>
                        <div class="invoice-company-tagline">Premium Development Services</div>
                    </div>
                </div>
                <div class="invoice-info">
                    <div class="invoice-title">INVOICE</div>
                    <div class="invoice-number">#${invoice.invoice_number}</div>
                </div>
            </div>
            
            <div class="invoice-preview-body">
                <div class="invoice-parties">
                    <div>
                        <div class="invoice-party-label">From</div>
                        <div class="invoice-party-name">DIAMONDBACK</div>
                        <div class="invoice-party-details">
                            5000 Plaza on the Lake, Suite 100 PMB 2017
                            Austin, TX 78746<br>
                            contact@diamondbackcoding.com
                        </div>
                    </div>
                    <div>
                        <div class="invoice-party-label">Bill To</div>
                        <div class="invoice-party-name">${invoice.customer_name || 'Customer'}</div>
                        <div class="invoice-party-details">
                            ${invoice.customer_company ? invoice.customer_company + '<br>' : ''}
                            ${invoice.customer_email || ''}${invoice.customer_phone ? '<br>' : ''}
                            ${invoice.customer_phone || ''}
                        </div>
                    </div>
                </div>
                
                <div class="invoice-dates">
                    <div class="invoice-date-item">
                        <div class="invoice-date-label">Issue Date</div>
                        <div class="invoice-date-value">${formatDate(invoice.issue_date)}</div>
                    </div>
                    <div class="invoice-date-item">
                        <div class="invoice-date-label">Due Date</div>
                        <div class="invoice-date-value">${formatDate(invoice.due_date)}</div>
                    </div>
                </div>
                
                <table class="invoice-items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity || 1}</td>
                                <td>$${parseFloat(item.unit_price || item.amount).toLocaleString()}</td>
                                <td>$${parseFloat(item.amount).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="invoice-totals">
                    <div class="invoice-total-row">
                        <span class="invoice-total-label">Subtotal</span>
                        <span class="invoice-total-value">$${parseFloat(invoice.subtotal).toLocaleString()}</span>
                    </div>
                    ${taxAmount > 0 ? `
                        <div class="invoice-total-row">
                            <span class="invoice-total-label">Tax (${invoice.tax_rate}%)</span>
                            <span class="invoice-total-value">$${taxAmount.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    ${discount > 0 ? `
                        <div class="invoice-total-row">
                            <span class="invoice-total-label">Discount</span>
                            <span class="invoice-total-value">-$${discount.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    <div class="invoice-total-row grand">
                        <span class="invoice-total-label">Total</span>
                        <span class="invoice-total-value">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                    </div>
                </div>
                
${invoice.status !== 'paid' ? `
                    <div class="qr-code-section">
                        <div class="qr-code-title">
                            <svg style="width: 20px; height: 20px; display: inline; margin-right: 6px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            Payment Link & QR Code
                        </div>
                        
                        ${invoice.stripe_payment_link ? `
                            <div style="margin-bottom: 16px; display: flex; gap: 8px; align-items: center;">
                                <input type="text" readonly value="${invoice.stripe_payment_link}" 
                                       style="flex: 1; padding: 8px; border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 11px; background: var(--bg-hover); color: var(--text-primary);">
                                <button class="btn btn-sm btn-secondary" onclick="copyPaymentLink('${invoice.stripe_payment_link}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                    Copy
                                </button>
                            </div>
                        ` : '<div style="color: var(--text-muted); font-size: 12px; margin-bottom: 16px; text-align: center;">Payment link will be generated when you view this invoice</div>'}
                        
                        <div class="qr-code-container" id="${qrCodeId}"></div>
                        <div class="qr-code-instructions">
                            Share this QR code or payment link with your client for easy payment.
                        </div>
                        <div class="payment-url">
                            ${paymentUrl}
                        </div>
                    </div>
                ` : `
                    <div style="background: rgba(16,185,129,0.15); padding: 20px; border-radius: var(--radius-md); border: 2px solid var(--status-contacted); text-align: center; margin-top: 20px;">
                        <div style="font-size: 16px; font-weight: 700; color: var(--status-contacted); margin-bottom: 6px;">
                             Invoice Paid
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            Paid on ${invoice.paid_at ? formatDate(invoice.paid_at) : 'N/A'}
                            ${invoice.payment_method ? ` via ${invoice.payment_method}` : ''}
                        </div>
                        ${invoice.payment_reference ? `
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px; font-family: var(--font-mono);">
                                Ref: ${invoice.payment_reference}
                            </div>
                        ` : ''}
                    </div>
                `}
            </div>
            
            ${invoice.notes ? `
                <div class="invoice-preview-footer">
                    <div class="invoice-notes-title">Notes</div>
                    <div class="invoice-notes-text">${invoice.notes}</div>
                </div>
            ` : ''}
        </div>
    `;
    
    // Generate QR code after a small delay to ensure DOM is ready
    setTimeout(() => {
        const qrElement = document.getElementById(qrCodeId);
        if (qrElement && invoice.status !== 'paid') {
            // Clear any existing QR code
            qrElement.innerHTML = '';
            
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                console.error(' QRCode library not loaded');
                qrElement.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">QR code library not available</p>';
                return;
            }
            
            try {
                // Generate QR code
                new QRCode(qrElement, {
                    text: paymentUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#1a1a1a",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                console.log(' QR code generated for:', paymentUrl);
            } catch (error) {
                console.error(' QR code generation failed:', error);
                qrElement.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">QR code generation failed</p>';
            }
        }
    }, 100);
    
    return html;
}
function closeDetailModal() {
document.getElementById('detailModal').classList.remove('active');
state.currentLead = null;
state.selectedExpenses = [];
}
function openCreateModal(type, leadId = null) {
const modal = document.getElementById('createModal');
const titleEl = document.getElementById('createModalTitle');
const bodyEl = document.getElementById('createModalBody');
if (type === 'lead') {
    titleEl.textContent = 'Create New Lead';
    bodyEl.innerHTML = `
        <form id="createLeadForm" onsubmit="handleCreateLead(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Name <span class="required">*</span></label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email <span class="required">*</span></label>
                    <input type="email" class="form-input" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" name="phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" name="company">
                </div>
                <div class="form-group">
                    <label class="form-label">Project Type</label>
                    <select class="form-select" name="project_type">
                        <option value="">Select type...</option>
                        <option value="Web Development">Web Development</option>
                        <option value="Mobile App">Mobile App</option>
                        <option value="E-commerce">E-commerce</option>
                        <option value="Custom Software">Custom Software</option>
                        <option value="Consulting">Consulting</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Budget</label>
                    <input type="number" class="form-input" name="budget" step="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="new">New</option>
                        <option value="pending">Pending</option>
                        <option value="contacted">Contacted</option>
                        <option value="closed">Closed</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" name="priority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" name="message"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Lead</button>
            </div>
        </form>
    `;
} else if (type === 'expense') {
    titleEl.textContent = 'Add Expense';
    bodyEl.innerHTML = `
        <form id="createExpenseForm" onsubmit="handleCreateExpense(event, ${leadId})">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Description <span class="required">*</span></label>
                    <input type="text" class="form-input" name="description" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount <span class="required">*</span></label>
                    <input type="number" class="form-input" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-input" name="quantity" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" name="expense_date" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" name="category">
                        <option value="">Select category...</option>
                        <option value="Development">Development</option>
                        <option value="Design">Design</option>
                        <option value="Hosting">Hosting</option>
                        <option value="Consulting">Consulting</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" name="notes" rows="3"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </div>
        </form>
    `;
} else if (type === 'invoice') {
    if (leadId) {
        // If leadId provided, open invoice modal directly
        openInvoiceModal(leadId);
    } else {
        // If no leadId, show client selection first
        showClientSelectionForInvoice();
    }
    return;
} else if (type === 'employee') {
    titleEl.textContent = 'Add Team Member';
    bodyEl.innerHTML = `
        <form id="createEmployeeForm" onsubmit="handleCreateEmployee(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Name <span class="required">*</span></label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email <span class="required">*</span></label>
                    <input type="email" class="form-input" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" name="phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <input type="text" class="form-input" name="role" placeholder="e.g., Developer, Designer">
                </div>
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-input" name="start_date">
                </div>
                <div class="form-group">
                    <label class="form-label">End Date (if applicable)</label>
                    <input type="date" class="form-input" name="end_date">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Employee Documents</label>
                    <input type="file" class="form-input" id="employeeDocuments" multiple accept=".pdf,.doc,.docx,.png,.jpg,.jpeg">
                    <small style="font-size: 11px; color: var(--text-muted); display: block; margin-top: 4px;">Upload W-4, I-9, contracts, certifications, etc.</small>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" name="notes" rows="2" placeholder="Any additional information..."></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Employee</button>
            </div>
        </form>
    `;
} else if (type === 'task') {
    titleEl.textContent = 'Create Task';
    
    // Build employee options
    const employeeOptions = state.employees.map(emp => 
        `<option value="${emp.id}">${emp.name}</option>`
    ).join('');
    
    bodyEl.innerHTML = `
        <form id="createTaskForm" onsubmit="handleCreateTask(event)">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Task Title <span class="required">*</span></label>
                    <input type="text" class="form-input" name="title" required>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" name="description" rows="3" placeholder="Add task details..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" name="dueDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" name="priority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Assign To</label>
                    <select class="form-select" name="assigned_to">
                        <option value="">Unassigned</option>
                        ${employeeOptions}
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Task</button>
            </div>
        </form>
    `;
}

modal.classList.add('active');
}
function closeCreateModal() {
document.getElementById('createModal').classList.remove('active');
}
async function openInvoiceModal(leadId) {
    const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    if (!lead) {
        console.error(' Lead not found for ID:', leadId);
        showToast('Lead/Customer not found', 'error');
        return;
    }
    
    const expenses = await loadExpenses(leadId);
    const selectedExpenses = state.selectedExpenses.length > 0 
        ? expenses.filter(e => state.selectedExpenses.includes(e.id))
        : expenses;

    //  USE createModal instead of invoiceModal
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');

    if (!modal) {
        console.error(' createModal element not found in DOM!');
        showToast('Modal not found. Please refresh the page.', 'error');
        return;
    }

    titleEl.textContent = 'Create Invoice';

    const invoiceNumber = `INV-${Date.now().toString().slice(-6)}`;
    const today = new Date().toISOString().split('T')[0];
    const dueDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

bodyEl.innerHTML = `
    <div class="tabs" style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid var(--border-subtle); padding-bottom: 8px;">
        <button class="tab active" onclick="event.preventDefault(); switchInvoiceTab('details')" style="padding: 8px 16px; background: var(--accent-amber); color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">Details</button>
        <button class="tab" onclick="event.preventDefault(); switchInvoiceTab('items')" style="padding: 8px 16px; background: var(--bg-hover); color: var(--text-primary); border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">Items</button>
        <button class="tab" onclick="event.preventDefault(); switchInvoiceTab('preview')" style="padding: 8px 16px; background: var(--bg-hover); color: var(--text-primary); border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">Preview</button>
    </div>
        
        <div id="invoiceDetailsTab">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Invoice Number</label>
                    <input type="text" class="form-input" id="invoiceNumber" value="${invoiceNumber}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="invoiceStatus">
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Invoice Description (for payment page) <span class="required">*</span></label>
                    <input type="text" class="form-input" id="invoiceShortDescription" 
                           placeholder="e.g., Website Development Services" 
                           maxlength="100" required>
                    <small style="font-size: 11px; color: var(--text-muted); margin-top: 4px; display: block;">
                        This appears on the Stripe payment page
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Issue Date</label>
                    <input type="date" class="form-input" id="invoiceIssueDate" value="${today}">
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="invoiceDueDate" value="${dueDate}">
                </div>
                <div class="form-group">
                    <label class="form-label">Tax Rate (%)</label>
                    <input type="number" class="form-input" id="invoiceTaxRate" value="0" step="0.01" oninput="recalculateInvoice()">
                </div>
                <div class="form-group">
                    <label class="form-label">Discount</label>
                    <input type="number" class="form-input" id="invoiceDiscount" value="0" step="0.01" oninput="recalculateInvoice()">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="invoiceNotes" placeholder="Payment terms, thank you message, etc."></textarea>
                </div>
            </div>
        </div>
        
        <div id="invoiceItemsTab" style="display: none;">
            <div id="invoiceItemsList">
                ${selectedExpenses.map((exp, idx) => `
                    <div class="expense-item selected" data-item-index="${idx}">
                        <div class="expense-content">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-meta">
                                <div class="expense-meta-item">Qty: ${exp.quantity || 1}</div>
                                <div class="expense-meta-item">${exp.category || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="expense-amount">$${parseFloat(exp.amount).toLocaleString()}</div>
                        <div class="expense-actions">
                            <button class="table-action-btn danger" onclick="removeInvoiceItem(${idx})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="addCustomInvoiceItem()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Custom Item
            </button>
        </div>
        
        <div id="invoicePreviewTab" style="display: none;"></div>
        
        <!--  ADD FOOTER BUTTONS DIRECTLY IN THE BODY -->
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
            <button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveInvoice()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                Save Invoice
            </button>
        </div>
    `;

    // Store invoice data in state
    state.currentInvoice = {
        leadId,
        lead,
        items: selectedExpenses.map(exp => ({
            description: exp.description,
            quantity: exp.quantity || 1,
            unit_price: parseFloat(exp.amount),
            amount: parseFloat(exp.amount) * (exp.quantity || 1),
            expense_id: exp.id
        }))
    };

    modal.classList.add('active');
}
function closeInvoiceModal() {
    document.getElementById('createModal').classList.remove('active'); //  Changed from invoiceModal
    state.currentInvoice = null;
}

// Add this function for editing addresses
async function editAddress(leadId) {
    const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    if (!lead) return;
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Edit Billing Address';
    bodyEl.innerHTML = `
        <form id="editAddressForm" onsubmit="handleEditAddress(event, ${leadId})">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Address Line 1</label>
                    <input type="text" class="form-input" name="address_line1" value="${lead.address_line1 || ''}" placeholder="Street address">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Address Line 2</label>
                    <input type="text" class="form-input" name="address_line2" value="${lead.address_line2 || ''}" placeholder="Apt, suite, unit, etc. (optional)">
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" class="form-input" name="city" value="${lead.city || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">State / Province</label>
                    <input type="text" class="form-input" name="state" value="${lead.state || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">ZIP / Postal Code</label>
                    <input type="text" class="form-input" name="zip_code" value="${lead.zip_code || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <input type="text" class="form-input" name="country" value="${lead.country || 'USA'}">
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Address</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleEditAddress(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = {
        address_line1: formData.get('address_line1'),
        address_line2: formData.get('address_line2'),
        city: formData.get('city'),
        state: formData.get('state'),
        zip_code: formData.get('zip_code'),
        country: formData.get('country')
    };
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) throw new Error('Failed to update address');
        
        await loadAllData();
        closeCreateModal();
        showToast('Address updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating address', 'error');
    }
}

// ========================================
// FORM HANDLERS
// ========================================
async function handleCreateLead(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    try {
        const r = await fetch(`${API_URL}/api/leads`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) {
            const errorData = await r.json();
            throw new Error(errorData.message || 'Failed to create lead');
        }
        
        // Force complete data reload
        await loadAllData();
        closeCreateModal();
        showToast('Lead created successfully', 'success');
        renderSection(state.currentSection);
    } catch (e) {
        console.error('Create lead error:', e);
        showToast(e.message || 'Error creating lead', 'error');
    }
}
async function handleCreateExpense(event, leadId) {
event.preventDefault();
const form = event.target;
const formData = new FormData(form);
const data = Object.fromEntries(formData.entries());
try {
    const r = await fetch(`${API_URL}/api/leads/${leadId}/expenses`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(data)
    });
    
    if (!r.ok) throw new Error('Failed to create expense');
    
    closeCreateModal();
    showToast('Expense added successfully', 'success');
    openDetailModal('lead', leadId);
} catch (e) {
    showToast('Error adding expense', 'error');
}
}
async function handleCreateEmployee(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    console.log('Creating employee with data:', data);
    
    if (!data.name || !data.email) {
        showToast('Name and email are required', 'error');
        return;
    }
    
    try {
        // First, create the employee
        const r = await fetch(`${API_URL}/api/employees`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                name: data.name.trim(),
                email: data.email.trim(),
                phone: data.phone || null,
                role: data.role || 'Team Member',
                start_date: data.start_date || null,
                end_date: data.end_date || null,
                notes: data.notes || null
            })
        });
        
        const result = await r.json();
        console.log('Server response:', result);
        
        if (!r.ok || !result.success) {
            throw new Error(result.message || 'Failed to create employee');
        }
        
        // If files were uploaded, handle them
        const employeeId = result.employee?.id;
        const filesInput = document.getElementById('employeeDocuments');
        if (filesInput && filesInput.files.length > 0 && employeeId) {
            const uploadFormData = new FormData();
            for (let file of filesInput.files) {
                uploadFormData.append('documents', file);
            }
            uploadFormData.append('employee_id', employeeId);
            
            try {
                await fetch(`${API_URL}/api/employees/${employeeId}/documents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: uploadFormData
                });
            } catch (uploadError) {
                console.error('Error uploading employee documents:', uploadError);
                // Don't fail the whole operation, just warn
                showToast('Employee added but document upload failed', 'warning');
            }
        }
        
        await loadEmployees();
        closeCreateModal();
        showToast('Employee added successfully', 'success');
        renderSection('employees');
    } catch (e) {
        console.error('Create employee error:', e);
        showToast(e.message || 'Error adding employee', 'error');
    }
}
async function handleCreateTask(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch(`${API_URL}/api/tasks`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: data.title,
                description: data.description || '',
                due_date: data.dueDate,
                priority: data.priority,
                assigned_to: data.assigned_to ? parseInt(data.assigned_to) : null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add to local state
            state.tasks.push({
                id: result.task.id,
                title: result.task.title,
                description: result.task.description,
                dueDate: result.task.due_date,
                assignee: result.task.assigned_name || 'Unassigned',
                assigned_to: result.task.assigned_to,
                priority: result.task.priority,
                completed: false,
                created_at: result.task.created_at
            });
            
            closeCreateModal();
            showToast('Task created successfully', 'success');
            renderSection('tasks');
        } else {
            showToast(result.message || 'Failed to create task', 'error');
        }
    } catch (error) {
        console.error('Create task error:', error);
        showToast('Error creating task', 'error');
    }
}
// ========================================
// INVOICE FUNCTIONS
// ========================================
function switchInvoiceTab(tab) {
    // Remove active class from all tabs
    document.querySelectorAll('#createModal .tab').forEach(t => t.classList.remove('active'));
    
    // Add active class to clicked tab
    const tabs = document.querySelectorAll('#createModal .tab');
    if (tab === 'details') tabs[0]?.classList.add('active');
    if (tab === 'items') tabs[1]?.classList.add('active');
    if (tab === 'preview') tabs[2]?.classList.add('active');
    
    // Hide all tab contents
    document.getElementById('invoiceDetailsTab').style.display = tab === 'details' ? 'block' : 'none';
    document.getElementById('invoiceItemsTab').style.display = tab === 'items' ? 'block' : 'none';
    document.getElementById('invoicePreviewTab').style.display = tab === 'preview' ? 'block' : 'none';

    // If switching to preview, update it
    if (tab === 'preview') {
        updateInvoicePreview();
    }
}
function recalculateInvoice() {
    if (state.currentInvoice && state.currentInvoice.items) {
        const subtotal = state.currentInvoice.items.reduce((sum, item) => sum + parseFloat(item.amount), 0);
        const taxRate = parseFloat(document.getElementById('invoiceTaxRate')?.value || 0);
        const discount = parseFloat(document.getElementById('invoiceDiscount')?.value || 0);
        
        state.currentInvoice.subtotal = subtotal;
        state.currentInvoice.tax_amount = subtotal * (taxRate / 100);
        state.currentInvoice.discount_amount = discount;
        state.currentInvoice.total_amount = subtotal + state.currentInvoice.tax_amount - discount;
    }
}
function addCustomInvoiceItem() {
const description = prompt('Item description:');
if (!description) return;
const quantity = parseInt(prompt('Quantity:', '1')) || 1;
const unitPrice = parseFloat(prompt('Unit price:', '0')) || 0;

const item = {
    description,
    quantity,
    unit_price: unitPrice,
    amount: quantity * unitPrice
};

state.currentInvoice.items.push(item);
recalculateInvoice();

const list = document.getElementById('invoiceItemsList');
const idx = state.currentInvoice.items.length - 1;
list.innerHTML += `
    <div class="expense-item selected" data-item-index="${idx}">
        <div class="expense-content">
            <div class="expense-description">${item.description}</div>
            <div class="expense-meta">
                <div class="expense-meta-item">Qty: ${item.quantity}</div>
                <div class="expense-meta-item">@ $${item.unit_price.toLocaleString()}</div>
            </div>
        </div>
        <div class="expense-amount">$${item.amount.toLocaleString()}</div>
        <div class="expense-actions">
            <button class="table-action-btn danger" onclick="removeInvoiceItem(${idx})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
    </div>
`;
}
function removeInvoiceItem(idx) {
state.currentInvoice.items.splice(idx, 1);
recalculateInvoice();
document.querySelector(`[data-item-index="${idx}"]`).remove();
}
function updateInvoicePreview() {
    recalculateInvoice();
    
    const invoice = {
        invoice_number: document.getElementById('invoiceNumber').value,
        issue_date: document.getElementById('invoiceIssueDate').value,
        due_date: document.getElementById('invoiceDueDate').value,
        customer_name: state.currentInvoice.lead.name,
        customer_email: state.currentInvoice.lead.email,
        customer_company: state.currentInvoice.lead.company,
        subtotal: state.currentInvoice.subtotal || 0,
        tax_rate: parseFloat(document.getElementById('invoiceTaxRate').value) || 0,
        tax_amount: state.currentInvoice.tax_amount || 0,
        discount_amount: state.currentInvoice.discount_amount || 0,
        total_amount: state.currentInvoice.total_amount || 0,
        notes: document.getElementById('invoiceNotes').value,
        items: state.currentInvoice.items,
        status: 'preview' // Don't show payment link in preview
    };

    // Generate preview HTML (reuse your existing renderInvoicePreview function)
    renderInvoicePreview(invoice).then(html => {
        document.getElementById('invoicePreviewTab').innerHTML = html;
    });
}
async function saveInvoice() {
    console.log(' saveInvoice called');
    
    if (!state.currentInvoice || !state.currentInvoice.items || state.currentInvoice.items.length === 0) {
        showToast('Please add at least one item to the invoice', 'error');
        return;
    }
    
    const shortDescription = document.getElementById('invoiceShortDescription')?.value.trim();
    if (!shortDescription) {
        showToast('Please enter an invoice description', 'error');
        // Switch back to details tab to show the error
        switchInvoiceTab('details');
        document.getElementById('invoiceShortDescription')?.focus();
        return;
    }
    
    recalculateInvoice();

    const invoiceData = {
        invoice_number: document.getElementById('invoiceNumber').value,
        lead_id: state.currentInvoice.leadId,
        issue_date: document.getElementById('invoiceIssueDate').value,
        due_date: document.getElementById('invoiceDueDate').value,
        subtotal: state.currentInvoice.subtotal || 0,
        tax_rate: parseFloat(document.getElementById('invoiceTaxRate').value) || 0,
        tax_amount: state.currentInvoice.tax_amount || 0,
        discount_amount: state.currentInvoice.discount_amount || 0,
        total_amount: state.currentInvoice.total_amount || 0,
        status: document.getElementById('invoiceStatus').value,
        short_description: shortDescription,
        notes: document.getElementById('invoiceNotes').value,
        items: state.currentInvoice.items
    };

    console.log(' Sending invoice data:', invoiceData);

    try {
        showToast('Creating invoice...', 'info');
        
        const r = await fetch(`${API_URL}/api/invoices`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(invoiceData)
        });
        
        const responseData = await r.json();
        console.log(' Server response:', responseData);
        
        if (!r.ok) {
            throw new Error(responseData.message || 'Failed to create invoice');
        }
        
        await loadInvoices();
        updateBadges();
        closeCreateModal(); //  Changed from closeInvoiceModal
        state.currentInvoice = null;
        showToast('Invoice created successfully', 'success');
        renderSection('invoices');
    } catch (e) {
        console.error(' Error creating invoice:', e);
        showToast('Error creating invoice: ' + e.message, 'error');
    }
}
async function createInvoiceFromExpenses() {
if (state.selectedExpenses.length === 0) {
showToast('Please select expenses first', 'error');
return;
}
closeDetailModal();
await openInvoiceModal(state.currentLead.id);
}
// ========================================
// UTILITY FUNCTIONS
// ========================================
function toggleExpense(expenseId) {
const idx = state.selectedExpenses.indexOf(expenseId);
if (idx > -1) {
state.selectedExpenses.splice(idx, 1);
} else {
state.selectedExpenses.push(expenseId);
}
const checkbox = document.querySelector(`[data-expense-id="${expenseId}"] .expense-checkbox`);
const item = document.querySelector(`[data-expense-id="${expenseId}"]`);

if (state.selectedExpenses.includes(expenseId)) {
    checkbox.classList.add('checked');
    item.classList.add('selected');
} else {
    checkbox.classList.remove('checked');
    item.classList.remove('selected');
}

openDetailModal('lead', state.currentLead.id);
}
async function addNote(leadId) {
    const text = document.getElementById('newNote').value.trim();
    if (!text) return;

    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/notes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ noteText: text })
        });
        
        if (!r.ok) throw new Error('Failed to add note');
        
        await loadLeads();
        showToast('Note added successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        console.error('Error adding note:', e);
        showToast('Error adding note', 'error');
    }
}

// ========================================
// DOCUMENT MANAGEMENT FUNCTIONS
// ========================================

async function loadLeadDocuments(leadId) {
    const documentsList = document.getElementById(`documentsList${leadId}`);
    if (!documentsList) return;
    
    try {
        const response = await fetch(`${API_URL}/api/leads/${leadId}/documents`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            const documents = data.documents || [];
            
            if (documents.length === 0) {
                documentsList.innerHTML = '<div class="expense-empty">No documents uploaded yet</div>';
                return;
            }
            
            documentsList.innerHTML = documents.map(doc => `
                <div class="expense-item">
                    <div class="expense-content">
                        <div class="expense-description">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; display: inline; margin-right: 8px;">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                                <polyline points="13 2 13 9 20 9"/>
                            </svg>
                            ${doc.file_name}
                        </div>
                        <div class="expense-meta">
                            <div class="expense-meta-item">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                ${formatDate(doc.uploaded_at)}
                            </div>
                            <span>${formatFileSize(doc.file_size)}</span>
                            ${doc.uploaded_by === 'client' ? '<span class="status-badge status-pending">Client Upload</span>' : '<span class="status-badge status-contacted">Admin Upload</span>'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="table-action-btn" onclick="downloadDocument(${doc.id}, '${doc.file_name}')" title="Download">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                        <button class="table-action-btn danger" onclick="deleteDocument(${doc.id}, ${leadId})" title="Delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            documentsList.innerHTML = '<div class="expense-empty">Error loading documents</div>';
        }
    } catch (error) {
        console.error('Error loading documents:', error);
        documentsList.innerHTML = '<div class="expense-empty">Error loading documents</div>';
    }
}

async function handleDocumentUpload(leadId, files) {
    if (!files || files.length === 0) return;
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('documents', files[i]);
    }
    formData.append('lead_id', leadId);
    formData.append('uploaded_by', 'admin');
    
    try {
        showToast('Uploading documents...', 'info');
        
        const response = await fetch(`${API_URL}/api/leads/${leadId}/documents`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`${files.length} document(s) uploaded successfully`, 'success');
            loadLeadDocuments(leadId);
            // Clear the file input
            document.getElementById(`documentUpload${leadId}`).value = '';
        } else {
            showToast(data.message || 'Error uploading documents', 'error');
        }
    } catch (error) {
        console.error('Error uploading documents:', error);
        showToast('Error uploading documents', 'error');
    }
}

async function downloadDocument(documentId, fileName) {
    try {
        const response = await fetch(`${API_URL}/api/documents/${documentId}/download`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showToast('Document downloaded', 'success');
        } else {
            showToast('Error downloading document', 'error');
        }
    } catch (error) {
        console.error('Error downloading document:', error);
        showToast('Error downloading document', 'error');
    }
}

async function deleteDocument(documentId, leadId) {
    if (!confirm('Are you sure you want to delete this document?')) return;
    
    try {
        const response = await fetch(`${API_URL}/api/documents/${documentId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Document deleted successfully', 'success');
            loadLeadDocuments(leadId);
        } else {
            showToast(data.message || 'Error deleting document', 'error');
        }
    } catch (error) {
        console.error('Error deleting document:', error);
        showToast('Error deleting document', 'error');
    }
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

async function deleteLead(id) {
if (!confirm('Are you sure you want to delete this lead?')) return;
try {
    const r = await fetch(`${API_URL}/api/leads/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete lead');
    
    await loadLeads();
    updateBadges();
    closeDetailModal();
    showToast('Lead deleted successfully', 'success');
    renderSection(state.currentSection);
} catch (e) {
    showToast('Error deleting lead', 'error');
}
}
async function deleteExpense(id) {
if (!confirm('Are you sure you want to delete this expense?')) return;
try {
    const r = await fetch(`${API_URL}/api/expenses/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete expense');
    
    showToast('Expense deleted successfully', 'success');
    openDetailModal('lead', state.currentLead.id);
} catch (e) {
    showToast('Error deleting expense', 'error');
}
}

// Delete Invoice Function
async function deleteInvoice(id) {
    const invoice = state.invoices.find(i => i.id === id);
    
    if (!confirm(`Are you sure you want to delete invoice ${invoice?.invoice_number || id}?`)) {
        return;
    }
    
    try {
        const r = await fetch(`${API_URL}/api/invoices/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!r.ok) {
            const data = await r.json();
            throw new Error(data.message || 'Failed to delete invoice');
        }
        
        await loadInvoices();
        await loadLeads();
        updateBadges();
        closeDetailModal();
        showToast('Invoice deleted successfully', 'success');
        renderSection('invoices');
    } catch (e) {
        showToast(e.message || 'Error deleting invoice', 'error');
    }
}

// Open Payment Modal
function openPaymentModal(invoiceId) {
    const invoice = state.invoices.find(i => i.id === invoiceId);
    if (!invoice) return;
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Record Payment';
    
    bodyEl.innerHTML = `
        <form id="paymentForm" onsubmit="handlePaymentSubmit(event, ${invoiceId})">
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: var(--radius-md); margin-bottom: 24px; border: 1px solid var(--border-subtle);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Invoice Number</span>
                    <span style="color: var(--text-primary); font-weight: 600; font-family: var(--font-mono);">${invoice.invoice_number}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Customer</span>
                    <span style="color: var(--text-primary); font-weight: 600;">${invoice.customer_name || 'Unknown'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 2px solid var(--accent-amber); margin-top: 12px;">
                    <span style="color: var(--text-secondary); font-size: 14px; font-weight: 600;">Total Amount</span>
                    <span style="color: var(--accent-amber); font-weight: 800; font-size: 24px; font-family: var(--font-mono);">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Payment Method <span class="required">*</span></label>
                    <select class="form-select" name="paymentMethod" required>
                        <option value="">Select method...</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="ACH">ACH</option>
                        <option value="Check">Check</option>
                        <option value="Cash">Cash</option>
                        <option value="PayPal">PayPal</option>
                        <option value="Stripe">Stripe</option>
                        <option value="Venmo">Venmo</option>
                        <option value="Zelle">Zelle</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Reference</label>
                    <input type="text" class="form-input" name="paymentReference" placeholder="Transaction ID, Check #, etc.">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Payment Notes</label>
                    <textarea class="form-textarea" name="paymentNotes" rows="3" placeholder="Additional payment details..."></textarea>
                </div>
            </div>
            
            <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); padding: 16px; border-radius: var(--radius-md); margin-top: 24px;">
                <div style="display: flex; gap: 12px; align-items: flex-start;">
                    <svg style="width: 20px; height: 20px; color: var(--status-contacted); flex-shrink: 0; margin-top: 2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <div>
                        <div style="font-weight: 600; color: var(--status-contacted); margin-bottom: 4px;">Payment Processing</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            When you mark this invoice as paid:
                            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                <li>The customer will be marked as ACTIVE</li>
                                <li>Their lifetime value will be updated</li>
                                <li>A payment note will be added to their record</li>
                                <li>Invoice status will change to PAID</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-success">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Confirm Payment
                </button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

// Close Payment Modal
function closePaymentModal() {
    closeCreateModal(); // Just reuse the existing function since we're using createModal now
}

// Handle Payment Submission
async function handlePaymentSubmit(event, invoiceId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {
        status: 'paid',
        paymentMethod: formData.get('paymentMethod'),
        paymentReference: formData.get('paymentReference'),
        paymentNotes: formData.get('paymentNotes')
    };
    
    if (!data.paymentMethod) {
        showToast('Please select a payment method', 'error');
        return;
    }
    
    try {
        showToast('Recording payment...', 'info');
        
        const r = await fetch(`${API_URL}/api/invoices/${invoiceId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) {
            const errorData = await r.json();
            throw new Error(errorData.message || 'Failed to update invoice status');
        }
        
        const result = await r.json();
        
        await loadInvoices();
        await loadLeads();
        updateBadges();
        closeCreateModal();
        closeDetailModal(); // Close the detail modal too if it's open
        showToast('Payment recorded successfully! Customer updated to ACTIVE status.', 'success');
        renderSection('invoices');
    } catch (e) {
        console.error('Payment error:', e);
        showToast('Error recording payment: ' + e.message, 'error');
    }
}

async function deleteEmployee(id) {
if (!confirm('Are you sure you want to delete this employee?')) return;
try {
    const r = await fetch(`${API_URL}/api/employees/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!r.ok) throw new Error('Failed to delete employee');
    
    await loadEmployees();
    showToast('Employee deleted successfully', 'success');
    renderSection('employees');
} catch (e) {
    showToast('Error deleting employee', 'error');
}
}
async function deleteTask(id) {
    if (!confirm('Are you sure you want to delete this task?')) return;
    
    try {
        const response = await fetch(`${API_URL}/api/tasks/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            showToast('Task deleted successfully', 'success');
            renderSection('tasks');
        } else {
            showToast('Failed to delete task', 'error');
        }
    } catch (error) {
        console.error('Delete task error:', error);
        showToast('Error deleting task', 'error');
    }
}
async function toggleTask(id) {
    try {
        const task = state.tasks.find(t => t.id === id);
        if (!task) return;
        
        const newCompletedStatus = !task.completed;
        
        const response = await fetch(`${API_URL}/api/tasks/${id}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ completed: newCompletedStatus })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update local state
            task.completed = newCompletedStatus;
            task.completed_at = data.task.completed_at;
            
            showToast(newCompletedStatus ? 'Task marked as complete' : 'Task marked as incomplete', 'success');
            renderSection('tasks');
        } else {
            showToast('Failed to update task', 'error');
        }
    } catch (error) {
        console.error('Toggle task error:', error);
        showToast('Error updating task', 'error');
    }
}
function filterLeads(type) {
state.currentFilter = type;
renderSection(state.currentSection);
}
function handleInvoiceSearch(event) {
    state.searchQuery = event.target.value.toLowerCase();
    renderSection('invoices');
}
function filterInvoices(status) {
    state.currentFilter = status;
    renderSection('invoices');
}
function handleSearch(query) {
state.searchQuery = query.toLowerCase();
renderSection(state.currentSection);
}
async function toggleSetting(setting) {
    state.settings[setting] = !state.settings[setting];
    applySettings(); // Apply the visual changes immediately
    await saveSettings();
    showToast('Setting updated', 'success');
}

async function saveSettings() {
    // Save to localStorage as backup
    localStorage.setItem('adminSettings', JSON.stringify(state.settings));
    
    try {
        const response = await fetch(`${API_URL}/api/settings`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(state.settings)
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Failed to save settings:', data.message);
        }
    } catch (error) {
        console.error('Save settings error:', error);
        // Still saved to localStorage so user doesn't lose settings
    }
}

async function loadSettings() {
    try {
        const response = await fetch(`${API_URL}/api/settings`, {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        if (data.success && data.settings) {
            state.settings = {
                ...state.settings,
                ...data.settings
            };
        }
    } catch (error) {
        console.error('Load settings error:', error);
    }
}

async function updateSessionTimeout(minutes) {
    state.settings.sessionTimeout = parseInt(minutes);
    await saveSettings();
    showToast('Session timeout updated', 'success');
}

async function updateQuietHours(type, value) {
    if (type === 'start') {
        state.settings.quietHoursStart = value;
    } else {
        state.settings.quietHoursEnd = value;
    }
    await saveSettings();
    showToast('Quiet hours updated', 'success');
}

async function updateIPWhitelist(value) {
    const ips = value.split('\n').map(ip => ip.trim()).filter(ip => ip.length > 0);
    state.settings.ipWhitelist = ips;
    await saveSettings();
    showToast('IP whitelist updated', 'success');
}

function openChangePasswordModal() {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Change Password';
    bodyEl.innerHTML = `
        <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
            <div class="form-group">
                <label class="form-label">Current Password <span class="required">*</span></label>
                <input type="password" class="form-input" name="currentPassword" required>
            </div>
            <div class="form-group">
                <label class="form-label">New Password <span class="required">*</span></label>
                <input type="password" class="form-input" name="newPassword" required minlength="8">
                <small style="font-size: 11px; color: var(--text-muted); display: block; margin-top: 4px;">Minimum 8 characters</small>
            </div>
            <div class="form-group">
                <label class="form-label">Confirm New Password <span class="required">*</span></label>
                <input type="password" class="form-input" name="confirmPassword" required>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Change Password</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleChangePassword(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (data.newPassword !== data.confirmPassword) {
        showToast('Passwords do not match', 'error');
        return;
    }
    
    if (data.newPassword.length < 8) {
        showToast('Password must be at least 8 characters', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/api/admin/change-password`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                currentPassword: data.currentPassword,
                newPassword: data.newPassword
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Password changed successfully', 'success');
            closeCreateModal();
        } else {
            showToast(result.message || 'Failed to change password', 'error');
        }
    } catch (error) {
        console.error('Change password error:', error);
        showToast('Error changing password', 'error');
    }
}

async function showActiveSessions() {
    try {
        const response = await fetch(`${API_URL}/api/admin/sessions`, {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (!data.success) {
            showToast('Failed to load sessions', 'error');
            return;
        }
        
        const modal = document.getElementById('createModal');
        const titleEl = document.getElementById('createModalTitle');
        const bodyEl = document.getElementById('createModalBody');
        
        titleEl.textContent = 'Active Sessions';
        
        const sessionsHtml = data.sessions.map((session, index) => {
            const createdDate = new Date(session.created_at).toLocaleString();
            const lastActivity = new Date(session.last_activity).toLocaleString();
            const isCurrent = index === 0; // First one is usually current
            
            return `
                <div class="session-item" style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 12px; border: 1px solid var(--border-default);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                ${session.user_agent ? session.user_agent.substring(0, 60) : 'Unknown Device'}
                                ${isCurrent ? '<span style="background: var(--accent-amber); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">CURRENT</span>' : ''}
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted);">
                                IP: ${session.ip_address || 'Unknown'}
                            </div>
                        </div>
                        ${!isCurrent ? `
                            <button class="btn btn-danger" onclick="revokeSession(${session.id})" style="padding: 6px 12px; font-size: 12px;">
                                Revoke
                            </button>
                        ` : ''}
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted); display: flex; gap: 20px;">
                        <span>Created: ${createdDate}</span>
                        <span>Last Activity: ${lastActivity}</span>
                    </div>
                </div>
            `;
        }).join('');
        
        bodyEl.innerHTML = `
            <div style="max-height: 500px; overflow-y: auto;">
                ${sessionsHtml || '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No active sessions found</p>'}
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-default);">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Close</button>
            </div>
        `;
        
        modal.classList.add('active');
    } catch (error) {
        console.error('Load sessions error:', error);
        showToast('Error loading sessions', 'error');
    }
}

async function revokeSession(sessionId) {
    if (!confirm('Are you sure you want to revoke this session?')) return;
    
    try {
        const response = await fetch(`${API_URL}/api/admin/sessions/${sessionId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Session revoked successfully', 'success');
            showActiveSessions(); // Refresh the list
        } else {
            showToast('Failed to revoke session', 'error');
        }
    } catch (error) {
        console.error('Revoke session error:', error);
        showToast('Error revoking session', 'error');
    }
}

async function showActivityLog() {
    try {
        const response = await fetch(`${API_URL}/api/admin/activity-log?limit=50`, {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (!data.success) {
            showToast('Failed to load activity log', 'error');
            return;
        }
        
        const modal = document.getElementById('createModal');
        const titleEl = document.getElementById('createModalTitle');
        const bodyEl = document.getElementById('createModalBody');
        
        titleEl.textContent = 'Activity Log';
        
        const activitiesHtml = data.activities.map(activity => {
            const timestamp = new Date(activity.created_at).toLocaleString();
            const actionLabel = activity.action.replace(/_/g, ' ');
            
            let actionColor = 'var(--text-secondary)';
            if (activity.action === 'LOGIN') actionColor = 'var(--status-success)';
            if (activity.action === 'PASSWORD_CHANGED') actionColor = 'var(--status-pending)';
            if (activity.action.includes('DELETE')) actionColor = 'var(--status-danger)';
            
            return `
                <div class="activity-item" style="padding: 12px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: ${actionColor}; margin-bottom: 4px;">
                            ${actionLabel}
                            ${activity.resource_type ? `<span style="color: var(--text-muted); font-weight: 400;">  ${activity.resource_type}</span>` : ''}
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            ${timestamp}
                            ${activity.ip_address ? `  IP: ${activity.ip_address}` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        bodyEl.innerHTML = `
            <div style="max-height: 500px; overflow-y: auto;">
                ${activitiesHtml || '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No activity found</p>'}
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-default);">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Close</button>
            </div>
        `;
        
        modal.classList.add('active');
    } catch (error) {
        console.error('Load activity log error:', error);
        showToast('Error loading activity log', 'error');
    }
}

function applySettings() {
    // Apply dark/light mode
    if (state.settings.darkMode) {
        document.documentElement.style.setProperty('--bg-void', '#000000');
        document.documentElement.style.setProperty('--bg-primary', '#0a0a0a');
        document.documentElement.style.setProperty('--bg-secondary', '#121212');
        document.documentElement.style.setProperty('--bg-tertiary', '#1a1a1a');
        document.documentElement.style.setProperty('--bg-elevated', '#1e1e1e');
        document.documentElement.style.setProperty('--bg-hover', '#242424');
        document.documentElement.style.setProperty('--text-primary', '#f4f4f5');
        document.documentElement.style.setProperty('--text-secondary', '#a1a1aa');
        document.documentElement.style.setProperty('--text-muted', '#71717a');
        document.documentElement.style.setProperty('--text-faint', '#52525b');
        document.documentElement.style.setProperty('--border-subtle', 'rgba(255,255,255,0.04)');
        document.documentElement.style.setProperty('--border-default', 'rgba(255,255,255,0.08)');
        document.documentElement.style.setProperty('--border-strong', 'rgba(255,255,255,0.12)');
        document.body.classList.remove('light-mode');
    } else {
        // Light mode colors
        document.documentElement.style.setProperty('--bg-void', '#f5f5f7');
        document.documentElement.style.setProperty('--bg-primary', '#ffffff');
        document.documentElement.style.setProperty('--bg-secondary', '#f8f9fa');
        document.documentElement.style.setProperty('--bg-tertiary', '#f1f3f5');
        document.documentElement.style.setProperty('--bg-elevated', '#ffffff');
        document.documentElement.style.setProperty('--bg-hover', '#e9ecef');
        document.documentElement.style.setProperty('--text-primary', '#1a1a1a');
        document.documentElement.style.setProperty('--text-secondary', '#495057');
        document.documentElement.style.setProperty('--text-muted', '#6c757d');
        document.documentElement.style.setProperty('--text-faint', '#adb5bd');
        document.documentElement.style.setProperty('--border-subtle', 'rgba(0,0,0,0.06)');
        document.documentElement.style.setProperty('--border-default', 'rgba(0,0,0,0.1)');
        document.documentElement.style.setProperty('--border-strong', 'rgba(0,0,0,0.15)');
        document.body.classList.add('light-mode');
    }
}

function loadSettings() {
    const saved = localStorage.getItem('adminSettings');
    if (saved) {
        try {
            state.settings = { ...state.settings, ...JSON.parse(saved) };
        } catch (e) {
            console.error('Error loading settings:', e);
        }
    }
    applySettings();
}
function printInvoice() {
    const invoice = state.currentInvoice;
    if (!invoice) {
        showToast('No invoice selected', 'error');
        return;
    }
    
    const items = invoice.items || [];
    const taxAmount = parseFloat(invoice.tax_amount || 0);
    const discount = parseFloat(invoice.discount_amount || 0);
    
    const paymentUrl = invoice.stripe_payment_link || `${FRONTEND_BASE_URL}/invoice/${invoice.invoice_number}`;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Invoice ${invoice.invoice_number}</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; color: #1a1a1a; background: #fff; }
                .container { max-width: 800px; margin: 0 auto; }
                .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 30px; border-bottom: 4px solid #D4A574; margin-bottom: 30px; }
                .company-info h1 { font-size: 24px; font-weight: 800; margin-bottom: 5px; }
                .company-info p { color: #666; font-size: 13px; }
                .invoice-title { font-size: 32px; font-weight: 800; color: #D4A574; }
                .invoice-number { font-size: 14px; color: #666; }
                .parties { display: flex; justify-content: space-between; margin-bottom: 30px; }
                .party-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #D4A574; margin-bottom: 8px; }
                .party-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
                .party-details { font-size: 13px; color: #555; line-height: 1.6; }
                .dates { display: flex; gap: 30px; margin-bottom: 30px; }
                .date-item { background: #f5f5f5; padding: 12px 16px; border-radius: 6px; }
                .date-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #666; }
                .date-value { font-size: 14px; font-weight: 600; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                th { text-align: left; padding: 12px; background: #f5f5f5; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #666; }
                td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
                .totals { text-align: right; }
                .total-row { display: flex; justify-content: flex-end; margin-bottom: 8px; }
                .total-label { width: 150px; text-align: right; padding-right: 20px; color: #666; }
                .total-value { width: 100px; text-align: right; font-weight: 600; }
                .grand-total { font-size: 24px; color: #D4A574; font-weight: 800; border-top: 2px solid #D4A574; padding-top: 12px; margin-top: 12px; }
                @media print { body { padding: 20px; } }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <div class="company-info">
                        <h1>DIAMONDBACK</h1>
                        <p>Premium Development Services</p>
                        <p>5000 Plaza on the Lake, Suite 100 PMB 2017 Austin, TX 78746</p>
                        <p>contact@diamondbackcoding.com</p>
                    </div>
                    <div style="text-align: right;">
                        <div class="invoice-title">INVOICE</div>
                        <div class="invoice-number">#${invoice.invoice_number}</div>
                    </div>
                </div>
                
                <div class="parties">
                    <div>
                        <div class="party-label">From</div>
                        <div class="party-name">DIAMONDBACK</div>
                        <div class="party-details">5000 Plaza on the Lake, Suite 100 PMB 2017<br>Austin, TX 78746</div>
                    </div>
                    <div>
                        <div class="party-label">Bill To</div>
                        <div class="party-name">${invoice.customer_name || 'Customer'}</div>
                        <div class="party-details">
                            ${invoice.customer_company ? invoice.customer_company + '<br>' : ''}
                            ${invoice.customer_email || ''}
                        </div>
                    </div>
                </div>
                
                <div class="dates">
                    <div class="date-item">
                        <div class="date-label">Issue Date</div>
                        <div class="date-value">${formatDate(invoice.issue_date)}</div>
                    </div>
                    <div class="date-item">
                        <div class="date-label">Due Date</div>
                        <div class="date-value">${formatDate(invoice.due_date)}</div>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th style="text-align: right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity || 1}</td>
                                <td>$${parseFloat(item.unit_price || item.amount).toLocaleString()}</td>
                                <td style="text-align: right;">$${parseFloat(item.amount).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="totals">
                    <div class="total-row">
                        <span class="total-label">Subtotal</span>
                        <span class="total-value">$${parseFloat(invoice.subtotal).toLocaleString()}</span>
                    </div>
                    ${taxAmount > 0 ? `
                        <div class="total-row">
                            <span class="total-label">Tax (${invoice.tax_rate}%)</span>
                            <span class="total-value">$${taxAmount.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    ${discount > 0 ? `
                        <div class="total-row">
                            <span class="total-label">Discount</span>
                            <span class="total-value">-$${discount.toLocaleString()}</span>
                        </div>
                    ` : ''}
                    <div class="total-row grand-total">
                        <span class="total-label">Total</span>
                        <span class="total-value">$${parseFloat(invoice.total_amount).toLocaleString()}</span>
                    </div>
                </div>
                
                ${invoice.notes ? `<div style="margin-top: 30px; padding: 16px; background: #f5f5f5; border-radius: 6px;"><strong>Notes:</strong> ${invoice.notes}</div>` : ''}
            </div>
            <script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }<\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}
function openExportModal() {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Export Data';
    bodyEl.innerHTML = `
        <div class="form-group">
            <label class="form-label">What would you like to export?</label>
            <select class="form-select" id="exportType">
                <option value="leads">All Leads</option>
                <option value="customers">All Customers</option>
                <option value="invoices">All Invoices</option>
                <option value="employees">All Employees</option>
                <option value="all">Everything</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Export Format</label>
            <select class="form-select" id="exportFormat">
                <option value="csv">CSV (Excel compatible)</option>
                <option value="json">JSON</option>
            </select>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="performExport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
            </button>
        </div>
    `;
    
    modal.classList.add('active');
}

function performExport() {
    const exportType = document.getElementById('exportType').value;
    const exportFormat = document.getElementById('exportFormat').value;
    
    let data = [];
    let filename = '';
    
    switch (exportType) {
        case 'leads':
            data = state.leads;
            filename = 'leads';
            break;
        case 'customers':
            data = state.customers;
            filename = 'customers';
            break;
        case 'invoices':
            data = state.invoices;
            filename = 'invoices';
            break;
        case 'employees':
            data = state.employees;
            filename = 'employees';
            break;
        case 'all':
            data = {
                leads: state.leads,
                customers: state.customers,
                invoices: state.invoices,
                employees: state.employees
            };
            filename = 'all_data';
            break;
    }
    
    if (exportFormat === 'csv') {
        if (exportType === 'all') {
            // Export each type as separate CSV
            downloadCSV(state.leads, 'leads');
            downloadCSV(state.customers, 'customers');
            downloadCSV(state.invoices, 'invoices');
            downloadCSV(state.employees, 'employees');
        } else {
            downloadCSV(data, filename);
        }
    } else {
        downloadJSON(data, filename);
    }
    
    closeCreateModal();
    showToast('Export completed successfully', 'success');
}

function downloadCSV(data, filename) {
    if (!data || data.length === 0) {
        showToast(`No ${filename} data to export`, 'warning');
        return;
    }
    
    // Get headers from first object
    const headers = Object.keys(data[0]);
    
    // Build CSV content
    let csv = headers.join(',') + '\n';
    
    data.forEach(row => {
        const values = headers.map(header => {
            let value = row[header];
            
            // Handle null/undefined
            if (value === null || value === undefined) {
                return '';
            }
            
            // Handle objects/arrays (like notes or items)
            if (typeof value === 'object') {
                value = JSON.stringify(value);
            }
            
            // Convert to string and escape quotes
            value = String(value).replace(/"/g, '""');
            
            // Wrap in quotes if contains comma, newline, or quotes
            if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                value = `"${value}"`;
            }
            
            return value;
        });
        csv += values.join(',') + '\n';
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
}

function downloadJSON(data, filename) {
    if (!data || (Array.isArray(data) && data.length === 0)) {
        showToast(`No ${filename} data to export`, 'warning');
        return;
    }
    
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(link.href);
}
function logout() {
localStorage.removeItem('adminToken');
sessionStorage.removeItem('adminToken');
window.location.href = '/admin';
}
function showToast(message, type = 'success') {
    console.log(' showToast called:', message, type); // Debug log
    
    let container = document.getElementById('toastContainer');
    
    // Create container if it doesn't exist
    if (!container) {
        console.log('Creating toast container');
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = `
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        `;
        document.body.appendChild(container);
    }
    
    const icons = {
        success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
        warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
    };
    
    const colors = {
        success: { border: '#10b981', icon: '#10b981', bg: '#ecfdf5' },
        error: { border: '#ef4444', icon: '#ef4444', bg: '#fef2f2' },
        warning: { border: '#f59e0b', icon: '#f59e0b', bg: '#fffbeb' },
        info: { border: '#3b82f6', icon: '#3b82f6', bg: '#eff6ff' }
    };
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.style.cssText = `
        min-width: 320px;
        max-width: 480px;
        background: white;
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        pointer-events: auto;
        animation: slideIn 0.3s ease-out;
        border-left: 4px solid ${colors[type].border};
        position: relative;
        overflow: hidden;
    `;
    
    toast.innerHTML = `
        <div style="flex-shrink: 0; width: 24px; height: 24px; color: ${colors[type].icon};">
            ${icons[type]}
        </div>
        <div style="flex: 1; font-size: 14px; font-weight: 500; line-height: 1.5; color: #1f2937;">
            ${message}
        </div>
        <button onclick="this.parentElement.remove()" style="flex-shrink: 0; width: 24px; height: 24px; background: none; border: none; cursor: pointer; padding: 0; color: #6b7280; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        <div style="position: absolute; bottom: 0; left: 0; height: 3px; background: ${colors[type].border}; opacity: 0.3; animation: progress 5s linear forwards;"></div>
    `;
    
    container.appendChild(toast);
    console.log('Toast added to container');
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Add animations if not already present
if (!document.getElementById('toast-animations')) {
    const style = document.createElement('style');
    style.id = 'toast-animations';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        @keyframes progress {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }
    `;
    document.head.appendChild(style);
}
// ========================================
// LEAD ACTION FUNCTIONS (MISSING!)
// ========================================

// Change lead status
// Change lead status - WITH UI MODAL
async function changeLeadStatus(leadId) {
    const statuses = ['new', 'pending', 'contacted', 'closed', 'lost'];
    const currentLead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    const currentStatus = currentLead?.status || 'new';
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Change Status';
    bodyEl.innerHTML = `
        <form id="changeStatusForm" onsubmit="handleChangeStatus(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Status</label>
                <select class="form-select" name="status" required>
                    ${statuses.map(s => `
                        <option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s.toUpperCase()}</option>
                    `).join('')}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleChangeStatus(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const status = formData.get('status');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ status })
        });
        
        if (!r.ok) throw new Error('Failed to update status');
        
        await loadAllData();
        closeCreateModal();
        showToast('Status updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating status', 'error');
    }
}

async function emailInvoiceToClient() {
    const invoice = state.currentInvoice;
    if (!invoice) {
        showToast('No invoice to email', 'error');
        return;
    }
    
    if (!invoice.customer_email) {
        showToast('No customer email address found', 'error');
        return;
    }
    
    // Show loading toast
    showToast('Sending invoice email...', 'info');
    
    try {
        const response = await fetch(`${API_URL}/api/email/send-invoice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                invoice: invoice,
                clientEmail: invoice.customer_email,
                clientName: invoice.customer_name
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.message || 'Failed to send email');
        }
        
        if (result.success) {
            //  Success notification
            showToast(` Invoice successfully sent to ${invoice.customer_email}`, 'success');
        } else {
            throw new Error(result.message || 'Failed to send email');
        }
    } catch (error) {
        console.error('Email error:', error);
        //  Error notification
        showToast(` Failed to send email: ${error.message}`, 'error');
    }
}

// Convert lead to customer
async function convertToCustomer(leadId) {
    if (!confirm('Convert this lead to a customer?')) return;
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ 
                status: 'closed',
                isCustomer: true,
                customerStatus: 'active'
            })
        });
        
        if (!r.ok) throw new Error('Failed to convert to customer');
        
        await loadAllData();
        closeDetailModal();
        showToast('Lead converted to customer successfully!', 'success');
        renderSection('customers');
    } catch (e) {
        showToast('Error converting to customer', 'error');
    }
}

// Assign employee to lead
async function assignEmployee(leadId) {
    if (state.employees.length === 0) {
        showToast('No employees available. Add employees first.', 'warning');
        return;
    }
    
    const employeeOptions = state.employees.map(emp => 
        `<option value="${emp.id}">${emp.name} (${emp.role})</option>`
    ).join('');
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Assign Employee';
    bodyEl.innerHTML = `
        <form id="assignEmployeeForm" onsubmit="handleAssignEmployee(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Employee</label>
                <select class="form-select" name="employeeId" required>
                    <option value="">Choose employee...</option>
                    ${employeeOptions}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Assign</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleAssignEmployee(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const employeeId = formData.get('employeeId');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/assign`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ employeeId: parseInt(employeeId) })
        });
        
        if (!r.ok) throw new Error('Failed to assign employee');
        
        await loadAllData();
        closeCreateModal();
        showToast('Employee assigned successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error assigning employee', 'error');
    }
}

// Change lead priority
async function changePriority(leadId) {
    const priorities = ['low', 'medium', 'high'];
    const currentLead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    const currentPriority = currentLead?.priority || 'medium';
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Change Priority';
    bodyEl.innerHTML = `
        <form id="changePriorityForm" onsubmit="handleChangePriority(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Select Priority</label>
                <select class="form-select" name="priority" required>
                    ${priorities.map(p => `
                        <option value="${p}" ${p === currentPriority ? 'selected' : ''}>${p.toUpperCase()}</option>
                    `).join('')}
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

async function handleChangePriority(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const priority = formData.get('priority');
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}/priority`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ priority })
        });
        
        if (!r.ok) throw new Error('Failed to update priority');
        
        await loadAllData();
        closeCreateModal();
        showToast('Priority updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating priority', 'error');
    }
}

// Edit customer/lead address
function editAddress(leadId) {
    const lead = [...state.leads, ...state.customers].find(l => l.id === leadId);
    if (!lead) return;
    
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Edit Billing Address';
    bodyEl.innerHTML = `
        <form id="editAddressForm" onsubmit="handleEditAddress(event, ${leadId})">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Address Line 1</label>
                    <input type="text" class="form-input" name="address_line1" value="${lead.address_line1 || ''}" placeholder="Street address">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Address Line 2</label>
                    <input type="text" class="form-input" name="address_line2" value="${lead.address_line2 || ''}" placeholder="Apt, suite, unit, etc. (optional)">
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" class="form-input" name="city" value="${lead.city || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">State / Province</label>
                    <input type="text" class="form-input" name="state" value="${lead.state || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">ZIP / Postal Code</label>
                    <input type="text" class="form-input" name="zip_code" value="${lead.zip_code || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <input type="text" class="form-input" name="country" value="${lead.country || 'USA'}">
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Address</button>
            </div>
        </form>
    `;
    
    modal.classList.add('active');
}

// ========================================
// RENDER PROJECTS
// ========================================
// In renderProjects function, replace the stats icons section:

function renderProjects(content) {
    console.log(' renderProjects called with content element:', content);
    
    if (!content) {
        console.error(' Content element is null or undefined!');
        return;
    }
    
    try {
        const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
        console.log(' Found timelines:', savedTimelines);
        console.log(' servicePackages available:', typeof servicePackages, Object.keys(servicePackages).length);
        
        const htmlContent = `
            <div class="controls-bar">
                <div class="search-box">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" class="search-input" id="projectSearch" placeholder="Search projects by client name, company, or project..." onkeyup="handleProjectSearch(event)">
                </div>
            </div>
            
            <div class="cards-grid" id="projectTimelinesGrid">
                ${savedTimelines.length > 0 ? savedTimelines.map((timeline, index) => `
                    <div class="card" style="cursor: pointer;" onclick="viewProjectTimeline(${index})">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${timeline.clientName}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">${timeline.clientCompany || 'No company'}</div>
                            </div>
                            <span class="status-badge status-${timeline.status || 'pending'}">
                                <span class="status-dot"></span>
                                ${timeline.status || 'Draft'}
                            </span>
                        </div>
                        <div style="margin-bottom: 16px;">
                            ${(timeline.packages && Array.isArray(timeline.packages)) ? timeline.packages.map(pkg => `
                                <span style="display: inline-block; background: var(--accent-amber-dim); color: var(--accent-amber); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 6px; margin-bottom: 6px;">${servicePackages[pkg]?.name || pkg}</span>
                            `).join('') : '<span style="color: var(--text-muted); font-size: 12px;">No packages selected</span>'}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <div style="font-size: 12px; color: var(--text-muted);">
                                Created: ${formatDate(timeline.createdAt)}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="table-action-btn" onclick="event.stopPropagation(); exportProjectTimeline(${index})" title="Export">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                </button>
                                <button class="table-action-btn danger" onclick="event.stopPropagation(); deleteProjectTimeline(${index})" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('') : `
                    <div style="grid-column: 1 / -1;">
                        <div class="empty-state">
                            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                            </svg>
                            <div class="empty-title">No Project Timelines Yet</div>
                            <div class="empty-description">Create your first project timeline to get started</div>
                        </div>
                    </div>
                `}
            </div>
        `;
        
        console.log(' Setting innerHTML, content HTML length:', htmlContent.length);
        content.innerHTML = htmlContent;
        console.log(' renderProjects completed successfully');
    } catch (error) {
        console.error(' Error in renderProjects:', error);
        content.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--status-lost);">Error loading project timelines</div>';
    }
}

function handleProjectSearch(event) {
    const query = event.target.value.toLowerCase();
    const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
    
    if (!query) {
        renderProjects(document.getElementById('contentArea'));
        return;
    }
    
    const filtered = savedTimelines.filter(t => 
        t.clientName.toLowerCase().includes(query) ||
        (t.clientCompany && t.clientCompany.toLowerCase().includes(query)) ||
        (t.projectName && t.projectName.toLowerCase().includes(query))
    );
    
    const grid = document.getElementById('projectTimelinesGrid');
    
    if (filtered.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1 / -1;">
                <div class="empty-state">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <div class="empty-title">No Results Found</div>
                    <div class="empty-description">Try adjusting your search terms</div>
                </div>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = filtered.map((timeline, filteredIndex) => {
        const originalIndex = savedTimelines.findIndex(t => t.createdAt === timeline.createdAt);
        return `
            <div class="card" style="cursor: pointer;" onclick="viewProjectTimeline(${originalIndex})">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                    <div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${timeline.clientName}</div>
                        <div style="font-size: 13px; color: var(--text-muted);">${timeline.clientCompany || 'No company'}</div>
                    </div>
                    <span class="status-badge status-${timeline.status || 'pending'}">
                        <span class="status-dot"></span>
                        ${timeline.status || 'Draft'}
                    </span>
                </div>
                <div style="margin-bottom: 16px;">
                    ${timeline.packages.map(pkg => `
                        <span style="display: inline-block; background: var(--accent-amber-dim); color: var(--accent-amber); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 6px; margin-bottom: 6px;">${servicePackages[pkg]?.name || pkg}</span>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        Created: ${formatDate(timeline.createdAt)}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="table-action-btn" onclick="event.stopPropagation(); exportProjectTimeline(${originalIndex})" title="Export">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                        <button class="table-action-btn danger" onclick="event.stopPropagation(); deleteProjectTimeline(${originalIndex})" title="Delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Open Project Timeline Modal
function openProjectTimelineModal() {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    titleEl.textContent = 'Create Project Timeline & SLA';
    
    // Initialize package selection
    // Make sure this is initialized at the top of openProjectTimelineModal()
    window.selectedPackages = window.selectedPackages || [];
    window.selectedPackages = []; // Initialize empty array
    
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    const today = new Date().toISOString().split('T')[0];
    
    bodyEl.innerHTML = `
        <div class="form-grid">
            <div class="form-group full-width">
                <label class="form-label">Select Existing Client (Optional)</label>
                <select class="form-select" id="timelineClient" onchange="populateClientInfo()">
                    <option value="">New Client / Manual Entry</option>
                    ${allLeadsAndCustomers.map(lead => `
                        <option value="${lead.id}">${lead.name}${lead.company ? ' - ' + lead.company : ''} (${lead.email})</option>
                    `).join('')}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Client Name <span class="required">*</span></label>
                <input type="text" class="form-input" id="timelineClientName" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Company</label>
                <input type="text" class="form-input" id="timelineClientCompany">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email <span class="required">*</span></label>
                <input type="email" class="form-input" id="timelineClientEmail" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-input" id="timelineClientPhone">
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Client Address</label>
                <textarea class="form-textarea" id="timelineClientAddress" rows="2" placeholder="Street address, City, State ZIP"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Estimated Start Date</label>
                <input type="date" class="form-input" id="timelineStartDate" value="${today}">
            </div>
            
            <div class="form-group">
                <label class="form-label">Estimated Completion Date</label>
                <input type="date" class="form-input" id="timelineEndDate">
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Project Name / Description</label>
                <input type="text" class="form-input" id="timelineProjectName" placeholder="e.g., Company Website Redesign, E-commerce Store, etc.">
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Select Service Packages <span class="required">*</span></label>
                <div id="packagesList" style="display: grid; gap: 12px; margin-top: 12px; max-height: 400px; overflow-y: auto; padding-right: 8px;">
                    
                    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--status-contacted); margin-top: 8px; padding: 8px; background: rgba(16,185,129,0.1); border-radius: var(--radius-sm);">
                        FREE PACKAGES - No Payment Required
                    </div>
                    
                    ${Object.entries(servicePackages).filter(([key, pkg]) => pkg.isFree).map(([key, pkg]) => `
                        <div class="expense-item" style="cursor: pointer; border: 2px solid var(--status-contacted);" onclick="togglePackageSelection('${key}', this)">
                            <div class="expense-checkbox" id="pkg-check-${key}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="expense-content" style="flex: 1;">
                                <div class="expense-description">
                                    ${pkg.name}
                                    <span style="margin-left: 8px; background: var(--status-contacted); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700;">FREE</span>
                                </div>
                                <div class="expense-meta">
                                    <span>${pkg.description}</span>
                                    <span>Duration: ${pkg.duration}</span>
                                </div>
                            </div>
                            <div class="expense-amount" style="color: var(--status-contacted);">FREE</div>
                        </div>
                    `).join('')}
                    
                    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--accent-amber); margin-top: 16px; padding: 8px; background: var(--accent-amber-dim); border-radius: var(--radius-sm);">
                        PAID PACKAGES - Payment Due Upon Completion
                    </div>
                    
                    ${Object.entries(servicePackages).filter(([key, pkg]) => !pkg.isFree).map(([key, pkg]) => `
                        <div class="expense-item" style="cursor: pointer;" onclick="togglePackageSelection('${key}', this)">
                            <div class="expense-checkbox" id="pkg-check-${key}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="expense-content" style="flex: 1;">
                                <div class="expense-description">${pkg.name}</div>
                                <div class="expense-meta">
                                    <span>${pkg.description}</span>
                                    <span>Duration: ${pkg.duration}</span>
                                </div>
                            </div>
                            <div class="expense-amount">${pkg.price === 0 ? 'Custom' : '$' + pkg.price.toLocaleString()}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="form-group full-width" id="paymentTermsSection" style="display: none;">
                <label class="form-label">Payment Terms</label>
                <select class="form-select" id="paymentTerms">
                    <option value="completion">100% Due Upon Project Completion</option>
                    <option value="net30">Net 30 (Payment due 30 days after completion)</option>
                    <option value="net15">Net 15 (Payment due 15 days after completion)</option>
                    <option value="milestone">Milestone-Based (Split across project phases)</option>
                    <option value="custom">Custom Payment Plan</option>
                </select>
            </div>
            
            <div class="form-group full-width" id="customPaymentSection" style="display: none;">
                <label class="form-label">Custom Payment Details</label>
                <textarea class="form-textarea" id="customPaymentDetails" rows="2" placeholder="Describe the custom payment arrangement..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Include Monthly Maintenance?</label>
                <select class="form-select" id="maintenanceIncluded" onchange="toggleMaintenanceOptions()">
                    <option value="no">No Maintenance Included</option>
                    <option value="free">Yes - FREE Maintenance Included</option>
                    <option value="paid">Yes - Paid Maintenance Included</option>
                </select>
            </div>
            
            <div class="form-group" id="maintenanceFeeSection" style="display: none;">
                <label class="form-label">Monthly Maintenance Fee ($)</label>
                <input type="number" class="form-input" id="maintenanceFee" value="59.99" step="0.01" min="0">
            </div>
            
            <div class="form-group full-width" id="maintenanceDetailsSection" style="display: none;">
                <label class="form-label">Maintenance Details / What's Included</label>
                <textarea class="form-textarea" id="maintenanceDetails" rows="2" placeholder="Bug fixes, security updates, content changes, etc.">Bug fixes, security updates, minor content modifications (up to 2 hours/month), plugin/software updates, uptime monitoring, priority email support.</textarea>
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Special Requirements / Scope Notes</label>
                <textarea class="form-textarea" id="timelineScope" rows="3" placeholder="Any specific features, integrations, or requirements for this project..."></textarea>
            </div>
            
            <div class="form-group full-width">
                <label class="form-label">Additional Notes / Terms</label>
                <textarea class="form-textarea" id="timelineNotes" rows="2" placeholder="Any other notes or special terms..."></textarea>
            </div>
        </div>
        
        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md); margin-top: 20px;">
            <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--accent-amber); margin-bottom: 8px;">Selected Packages Summary</div>
            <div id="packagesSummary" style="font-size: 13px; color: var(--text-muted);">No packages selected</div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
            <button type="button" class="btn btn-secondary" onclick="previewProjectTimeline()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                Preview SLA
            </button>
            <button type="button" class="btn btn-primary" onclick="saveProjectTimeline()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                Save Timeline
            </button>
        </div>
    `;
    
    // Add event listener for payment terms
    setTimeout(function() {
        const paymentTermsSelect = document.getElementById('paymentTerms');
        if (paymentTermsSelect) {
            paymentTermsSelect.addEventListener('change', function() {
                const customSection = document.getElementById('customPaymentSection');
                if (this.value === 'custom') {
                    customSection.style.display = 'block';
                } else {
                    customSection.style.display = 'none';
                }
            });
        }
    }, 100);
    
    modal.classList.add('active');
    console.log('Service packages available:', Object.keys(servicePackages).length);
}

function toggleMaintenanceOptions() {
    const maintenanceSelect = document.getElementById('maintenanceIncluded');
    const feeSection = document.getElementById('maintenanceFeeSection');
    const detailsSection = document.getElementById('maintenanceDetailsSection');
    
    if (maintenanceSelect.value === 'no') {
        feeSection.style.display = 'none';
        detailsSection.style.display = 'none';
    } else if (maintenanceSelect.value === 'free') {
        feeSection.style.display = 'none';
        detailsSection.style.display = 'block';
    } else if (maintenanceSelect.value === 'paid') {
        feeSection.style.display = 'block';
        detailsSection.style.display = 'block';
    }
}

function populateClientInfo() {
    const select = document.getElementById('timelineClient');
    const leadId = parseInt(select.value);
    
    if (!leadId) {
        // Clear fields if "New Client" selected
        document.getElementById('timelineClientName').value = '';
        document.getElementById('timelineClientCompany').value = '';
        document.getElementById('timelineClientEmail').value = '';
        document.getElementById('timelineClientPhone').value = '';
        return;
    }
    
    const allLeadsAndCustomers = [...state.leads, ...state.customers];
    const lead = allLeadsAndCustomers.find(l => l.id === leadId);
    
    if (lead) {
        document.getElementById('timelineClientName').value = lead.name || '';
        document.getElementById('timelineClientCompany').value = lead.company || '';
        document.getElementById('timelineClientEmail').value = lead.email || '';
        document.getElementById('timelineClientPhone').value = lead.phone || '';
        
        // Also populate address if available
        if (document.getElementById('timelineClientAddress')) {
            const addressParts = [];
            if (lead.address_line1) addressParts.push(lead.address_line1);
            if (lead.address_line2) addressParts.push(lead.address_line2);
            if (lead.city) addressParts.push(lead.city + ', ' + (lead.state || '') + ' ' + (lead.zip_code || ''));
            document.getElementById('timelineClientAddress').value = addressParts.join('\n');
        }
    }
}

// Update packages summary
function updatePackagesSummary() {
    const summaryEl = document.getElementById('packagesSummary');
    const paymentSection = document.getElementById('paymentTermsSection');
    const maintenanceSection = document.getElementById('maintenanceSection');
    const maintenanceFeeSection = document.getElementById('maintenanceFeeSection');
    
    if (window.selectedPackages.length === 0) {
        summaryEl.innerHTML = 'No packages selected';
        if (paymentSection) paymentSection.style.display = 'none';
        if (maintenanceSection) maintenanceSection.style.display = 'none';
        if (maintenanceFeeSection) maintenanceFeeSection.style.display = 'none';
        return;
    }
    
    let total = 0;
    let hasPaidPackage = false;
    let hasFreePackage = false;
    let hasMaintenanceEligible = false;
    
    const packages = window.selectedPackages.map(function(key) {
        const pkg = servicePackages[key];
        if (pkg.isFree) {
            hasFreePackage = true;
        } else {
            hasPaidPackage = true;
            total += pkg.price;
        }
        // Check if package has support period (eligible for maintenance)
        if (key === 'starter-website' || key === 'professional-website' || key === 'enterprise-website') {
            hasMaintenanceEligible = true;
        }
        return pkg.name + (pkg.isFree ? ' (FREE)' : ' ($' + pkg.price.toLocaleString() + ')');
    });
    
    let summaryHtml = '<div style="margin-bottom: 8px;">' + packages.join(', ') + '</div>';
    
    if (hasPaidPackage) {
        summaryHtml += '<div style="font-size: 16px; font-weight: 700; color: var(--accent-amber);">Total Investment: $' + total.toLocaleString() + '</div>';
        summaryHtml += '<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;"> Payment due upon project completion</div>';
    } else if (hasFreePackage) {
        summaryHtml += '<div style="font-size: 16px; font-weight: 700; color: var(--status-contacted);">Total: FREE</div>';
        summaryHtml += '<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;"> No payment required for free packages</div>';
    }
    
    summaryEl.innerHTML = summaryHtml;
    
    // Show/hide payment terms section (only for paid packages)
    if (paymentSection) {
        paymentSection.style.display = hasPaidPackage ? 'block' : 'none';
    }
    
    // Show/hide maintenance sections (only for packages with support periods)
    if (maintenanceSection) {
        maintenanceSection.style.display = hasMaintenanceEligible ? 'block' : 'none';
    }
    if (maintenanceFeeSection) {
        maintenanceFeeSection.style.display = hasMaintenanceEligible ? 'block' : 'none';
    }
}

async function handleEditAddress(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = {
        address_line1: formData.get('address_line1'),
        address_line2: formData.get('address_line2'),
        city: formData.get('city'),
        state: formData.get('state'),
        zip_code: formData.get('zip_code'),
        country: formData.get('country')
    };
    
    try {
        const r = await fetch(`${API_URL}/api/leads/${leadId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });
        
        if (!r.ok) throw new Error('Failed to update address');
        
        await loadAllData();
        closeCreateModal();
        showToast('Address updated successfully', 'success');
        openDetailModal('lead', leadId);
    } catch (e) {
        showToast('Error updating address', 'error');
    }
}

// Helper functions
function formatDate(dateString) {
if (!dateString) return 'N/A';
const date = new Date(dateString);
return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function getInitials(name) {
return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}
function getMonthlyData(leads) {
const months = new Array(6).fill(0);
const now = new Date();
leads.forEach(lead => {
    const created = new Date(lead.created_at);
    const monthDiff = (now.getFullYear() - created.getFullYear()) * 12 + (now.getMonth() - created.getMonth());
    if (monthDiff >= 0 && monthDiff < 6) {
        months[5 - monthDiff]++;
    }
});

return months;
}
function getMonthlyRevenue() {
const total = state.invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
const pending = state.invoices.filter(i => i.status === 'sent').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
const overdue = state.invoices.filter(i => i.status === 'overdue').reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
return { total, pending, overdue };
}
function getMonthName(index) {
const names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
const month = new Date().getMonth() - (5 - index);
return names[month < 0 ? month + 12 : month];
}
function calculateConversionRate() {
if (state.leads.length === 0) return 0;
return Math.round((state.customers.length / (state.leads.length + state.customers.length)) * 100);
}
function filterLeads(data) {
let filtered = data;
if (state.currentFilter !== 'all') {
    filtered = filtered.filter(l => l.status === state.currentFilter);
}

if (state.searchQuery) {
    filtered = filtered.filter(l => 
        l.name.toLowerCase().includes(state.searchQuery) ||
        l.email.toLowerCase().includes(state.searchQuery) ||
        (l.company && l.company.toLowerCase().includes(state.searchQuery))
    );
}

return filtered;
}

// Preview Project Timeline
function previewProjectTimeline() {
    if (window.selectedPackages.length === 0) {
        showToast('Please select at least one service package', 'error');
        return;
    }
    
    const clientName = document.getElementById('timelineClientName').value;
    if (!clientName) {
        showToast('Please enter a client name', 'error');
        return;
    }
    
    // Check if any paid packages selected
    let hasPaidPackage = false;
    let totalPrice = 0;
    window.selectedPackages.forEach(function(key) {
        if (servicePackages[key] && !servicePackages[key].isFree) {
            hasPaidPackage = true;
            totalPrice += servicePackages[key].price;
        }
    });
    
    const maintenanceIncluded = document.getElementById('maintenanceIncluded').value;
    
    const timeline = {
        clientId: document.getElementById('timelineClient').value || null,
        clientName: clientName,
        clientCompany: document.getElementById('timelineClientCompany').value,
        clientEmail: document.getElementById('timelineClientEmail').value,
        clientPhone: document.getElementById('timelineClientPhone').value,
        clientAddress: document.getElementById('timelineClientAddress').value,
        startDate: document.getElementById('timelineStartDate').value,
        endDate: document.getElementById('timelineEndDate').value,
        projectName: document.getElementById('timelineProjectName').value,
        scope: document.getElementById('timelineScope').value,
        notes: document.getElementById('timelineNotes').value,
        packages: window.selectedPackages,
        totalPrice: totalPrice,
        isFreeProject: !hasPaidPackage,
        paymentTerms: hasPaidPackage ? (document.getElementById('paymentTerms') ? document.getElementById('paymentTerms').value : 'completion') : 'none',
        customPaymentDetails: document.getElementById('customPaymentDetails') ? document.getElementById('customPaymentDetails').value : '',
        maintenanceIncluded: maintenanceIncluded,
        maintenanceFee: maintenanceIncluded === 'paid' ? (parseFloat(document.getElementById('maintenanceFee').value) || 59.99) : 0,
        maintenanceDetails: document.getElementById('maintenanceDetails') ? document.getElementById('maintenanceDetails').value : '',
        status: 'draft',
        createdAt: new Date().toISOString()
    };
    
    closeCreateModal();
    openTimelinePreviewModal(timeline);
}

// Toggle package selection
function togglePackageSelection(packageKey, element) {
    const checkbox = document.getElementById(`pkg-check-${packageKey}`);
    const index = window.selectedPackages.indexOf(packageKey);
    
    if (index > -1) {
        window.selectedPackages.splice(index, 1);
        checkbox.classList.remove('checked');
        element.classList.remove('selected');
    } else {
        window.selectedPackages.push(packageKey);
        checkbox.classList.add('checked');
        element.classList.add('selected');
    }
    
    updatePackagesSummary();
}

// Save Project Timeline
function saveProjectTimeline() {
    if (window.selectedPackages.length === 0) {
        showToast('Please select at least one service package', 'error');
        return;
    }
    
    const clientName = document.getElementById('timelineClientName').value;
    if (!clientName) {
        showToast('Please enter a client name', 'error');
        return;
    }
    
    const clientEmail = document.getElementById('timelineClientEmail').value;
    if (!clientEmail) {
        showToast('Please enter a client email', 'error');
        return;
    }
    
    // Check if any paid packages selected
    let hasPaidPackage = false;
    let totalPrice = 0;
    window.selectedPackages.forEach(function(key) {
        if (servicePackages[key] && !servicePackages[key].isFree) {
            hasPaidPackage = true;
            totalPrice += servicePackages[key].price;
        }
    });
    
    const maintenanceIncluded = document.getElementById('maintenanceIncluded').value;
    
    const timeline = {
        clientId: document.getElementById('timelineClient').value || null,
        clientName: clientName,
        clientCompany: document.getElementById('timelineClientCompany').value,
        clientEmail: clientEmail,
        clientPhone: document.getElementById('timelineClientPhone').value,
        clientAddress: document.getElementById('timelineClientAddress').value,
        startDate: document.getElementById('timelineStartDate').value,
        endDate: document.getElementById('timelineEndDate').value,
        projectName: document.getElementById('timelineProjectName').value,
        scope: document.getElementById('timelineScope').value,
        notes: document.getElementById('timelineNotes').value,
        packages: window.selectedPackages,
        totalPrice: totalPrice,
        isFreeProject: !hasPaidPackage,
        paymentTerms: hasPaidPackage ? (document.getElementById('paymentTerms') ? document.getElementById('paymentTerms').value : 'completion') : 'none',
        customPaymentDetails: document.getElementById('customPaymentDetails') ? document.getElementById('customPaymentDetails').value : '',
        maintenanceIncluded: maintenanceIncluded,
        maintenanceFee: maintenanceIncluded === 'paid' ? (parseFloat(document.getElementById('maintenanceFee').value) || 59.99) : 0,
        maintenanceDetails: document.getElementById('maintenanceDetails') ? document.getElementById('maintenanceDetails').value : '',
        status: 'draft',
        createdAt: new Date().toISOString()
    };
    
    // Save to localStorage
    const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
    savedTimelines.unshift(timeline);
    localStorage.setItem('projectTimelines', JSON.stringify(savedTimelines));
    
    closeCreateModal();
    showToast('Project timeline saved successfully', 'success');
    renderSection('projects');
}

// ==================== CLIENT SUPPORT TICKET ENDPOINTS ====================

// Get all tickets for authenticated client
app.get('/api/client/tickets', authenticateClient, async (req, res) => {
    try {
        const clientId = req.user.id;
        
        const result = await pool.query(`
            SELECT st.*,
                   COUNT(tr.id) as response_count,
                   MAX(tr.created_at) as last_response_at
            FROM support_tickets st
            LEFT JOIN ticket_responses tr ON st.id = tr.ticket_id
            WHERE st.lead_id = $1
            GROUP BY st.id
            ORDER BY st.created_at DESC
        `, [clientId]);
        
        res.json({
            success: true,
            tickets: result.rows
        });
    } catch (error) {
        console.error('Get client tickets error:', error);
        res.status(500).json({ 
            success: false, 
            message: 'Failed to load tickets' 
        });
    }
});

// Create new ticket (client)
app.post('/api/client/tickets', authenticateClient, async (req, res) => {
    try {
        const clientId = req.user.id;
        const { subject, message, priority } = req.body;
        
        const result = await pool.query(`
            INSERT INTO support_tickets (lead_id, subject, message, priority, status)
            VALUES ($1, $2, $3, $4, 'open')
            RETURNING *
        `, [clientId, subject, message, priority || 'normal']);
        
        res.json({
            success: true,
            ticket: result.rows[0]
        });
    } catch (error) {
        console.error('Create ticket error:', error);
        res.status(500).json({ 
            success: false, 
            message: 'Failed to create ticket' 
        });
    }
});

// Get responses for a ticket (client)
app.get('/api/client/tickets/:ticketId/responses', authenticateClient, async (req, res) => {
    try {
        const clientId = req.user.id;
        const ticketId = req.params.ticketId;
        
        // Verify ticket belongs to client
        const ticketCheck = await pool.query(
            'SELECT id FROM support_tickets WHERE id = $1 AND lead_id = $2',
            [ticketId, clientId]
        );
        
        if (ticketCheck.rows.length === 0) {
            return res.status(404).json({ 
                success: false, 
                message: 'Ticket not found' 
            });
        }
        
        const result = await pool.query(`
            SELECT tr.*,
                   CASE 
                       WHEN tr.user_type = 'client' THEN l.name
                       WHEN tr.user_type = 'admin' THEN u.username
                   END as user_name
            FROM ticket_responses tr
            LEFT JOIN leads l ON tr.user_type = 'client' AND tr.user_id = l.id
            LEFT JOIN users u ON tr.user_type = 'admin' AND tr.user_id = u.id
            WHERE tr.ticket_id = $1
            ORDER BY tr.created_at ASC
        `, [ticketId]);
        
        res.json({
            success: true,
            responses: result.rows
        });
    } catch (error) {
        console.error('Get ticket responses error:', error);
        res.status(500).json({ 
            success: false, 
            message: 'Failed to load responses' 
        });
    }
});

// Add response to ticket (client)
app.post('/api/client/tickets/:ticketId/responses', authenticateClient, async (req, res) => {
    try {
        const clientId = req.user.id;
        const ticketId = req.params.ticketId;
        const { message } = req.body;
        
        // Verify ticket belongs to client
        const ticketCheck = await pool.query(
            'SELECT id FROM support_tickets WHERE id = $1 AND lead_id = $2',
            [ticketId, clientId]
        );
        
        if (ticketCheck.rows.length === 0) {
            return res.status(404).json({ 
                success: false, 
                message: 'Ticket not found' 
            });
        }
        
        const result = await pool.query(`
            INSERT INTO ticket_responses (ticket_id, user_type, user_id, message)
            VALUES ($1, 'client', $2, $3)
            RETURNING *
        `, [ticketId, clientId, message]);
        
        // Update ticket status to 'in-progress' if it was 'open'
        await pool.query(`
            UPDATE support_tickets 
            SET status = CASE WHEN status = 'open' THEN 'in-progress' ELSE status END,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = $1
        `, [ticketId]);
        
        res.json({
            success: true,
            response: result.rows[0]
        });
    } catch (error) {
        console.error('Add ticket response error:', error);
        res.status(500).json({ 
            success: false, 
            message: 'Failed to add response' 
        });
    }
});

// ==================== ADMIN SUPPORT TICKET ENDPOINTS ====================

// Get all tickets (admin)
app.get('/api/tickets', authenticateToken, async (req, res) => {
    try {
        const result = await pool.query(`
            SELECT st.*, l.name as client_name, l.email as client_email,
                   COUNT(tr.id) as response_count,
                   MAX(tr.created_at) as last_response_at
            FROM support_tickets st
            LEFT JOIN leads l ON st.lead_id = l.id
            LEFT JOIN ticket_responses tr ON st.id = tr.ticket_id
            GROUP BY st.id, l.name, l.email
            ORDER BY 
                CASE st.status 
                    WHEN 'open' THEN 1
                    WHEN 'in-progress' THEN 2
                    WHEN 'resolved' THEN 3
                    WHEN 'closed' THEN 4
                END,
                st.created_at DESC
        `);
        
        res.json({
            success: true,
            tickets: result.rows
        });
    } catch (error) {
        console.error('Get tickets error:', error);
        res.status(500).json({ 
            success: false, 
            message: 'Failed to load tickets' 
        });
    }
});

// Get responses for a ticket (admin)
app.get('/api/tickets/:ticketId/responses', authenticateToken, async (req, res) => {
    try {
        const ticketId = req.params.ticketId;
        
        const result = await pool.query(`
            SELECT tr.*,
                   CASE 
                       WHEN tr.user_type = 'client' THEN l.name
                       WHEN tr.user_type = 'admin' THEN u.username
                   END as user_name
            FROM ticket_responses tr
            LEFT JOIN leads l ON tr.user_type = 'client' AND tr.user_id = l.id
            LEFT JOIN users u ON tr.user_type = 'admin' AND tr.user_id = u.id
            WHERE tr.ticket_id = $1
            ORDER BY tr.created_at ASC
        `, [ticketId]);
        
        res.json({
            success: true,
            responses: result.rows
        });
    } catch (error) {
        console.error('Get ticket responses error:', error);
        res.status(500).json({ 
            success: false, 
            message: 'Failed to load responses' 
        });
    }
});

// Add response to ticket (admin)
app.post('/api/tickets/:ticketId/responses', authenticateToken, async (req, res) => {
    try {
        const ticketId = req.params.ticketId;
        const adminId = req.user.id;
        const { message } = req.body;
        
        const result = await pool.query(`
            INSERT INTO ticket_responses (ticket_id, user_type, user_id, message)
            VALUES ($1, 'admin', $2, $3)
            RETURNING *
        `, [ticketId, adminId, message]);
        
        // Update ticket timestamp
        await pool.query(`
            UPDATE support_tickets 
            SET updated_at = CURRENT_TIMESTAMP
            WHERE id = $1
        `, [ticketId]);
        
        res.json({
            success: true,
            response: result.rows[0]
        });
    } catch (error) {
        console.error('Add ticket response error:', error);
        res.status(500).json({ 
            success: false, 
            message: 'Failed to add response' 
        });
    }
});

// Update ticket status (admin)
app.put('/api/tickets/:ticketId/status', authenticateToken, async (req, res) => {
    try {
        const ticketId = req.params.ticketId;
        const { status } = req.body;
        
        const resolvedAt = status === 'resolved' || status === 'closed' 
            ? 'CURRENT_TIMESTAMP' 
            : 'NULL';
        
        const result = await pool.query(`
            UPDATE support_tickets 
            SET status = $1, 
                updated_at = CURRENT_TIMESTAMP,
                resolved_at = ${resolvedAt}
            WHERE id = $2
            RETURNING *
        `, [status, ticketId]);
        
        if (result.rows.length === 0) {
            return res.status(404).json({ 
                success: false, 
                message: 'Ticket not found' 
            });
        }
        
        res.json({
            success: true,
            ticket: result.rows[0]
        });
    } catch (error) {
        console.error('Update ticket status error:', error);
        res.status(500).json({ 
            success: false, 
            message: 'Failed to update ticket status' 
        });
    }
});

// Open Timeline Preview Modal
// Open Timeline Preview Modal
function openTimelinePreviewModal(timeline) {
    const modal = document.getElementById('detailModal');
    const titleEl = document.getElementById('detailModalTitle');
    const bodyEl = document.getElementById('detailModalBody');
    const footerEl = document.getElementById('detailModalFooter');

    titleEl.textContent = 'Project Timeline & SLA Preview';

    // Calculate totals
    let totalPrice = 0;
    let hasPaidPackage = false;
    timeline.packages.forEach(function(key) {
        if (servicePackages[key] && !servicePackages[key].isFree) {
            hasPaidPackage = true;
            totalPrice += servicePackages[key].price;
        }
    });

    // Generate overview content
    const overviewContent = `
        <h3 style="margin-bottom: 16px;">Quick Summary</h3>
        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: var(--radius-md);">
            <div style="margin-bottom: 12px;"><strong>Client:</strong> ${timeline.clientName}${timeline.clientCompany ? ' / ' + timeline.clientCompany : ''}</div>
            <div style="margin-bottom: 12px;"><strong>Email:</strong> ${timeline.clientEmail}</div>
            <div style="margin-bottom: 12px;"><strong>Project:</strong> ${timeline.projectName || 'Web Development Project'}</div>
            <div style="margin-bottom: 12px;"><strong>Packages:</strong> ${timeline.packages.map(k => servicePackages[k]?.name || k).join(', ')}</div>
            <div style="margin-bottom: 12px;"><strong>Total:</strong> ${timeline.isFreeProject ? 'FREE' : '$' + totalPrice.toLocaleString()}</div>
            <div style="margin-bottom: 12px;"><strong>Start:</strong> ${formatDate(timeline.startDate)}</div>
            <div><strong>End:</strong> ${formatDate(timeline.endDate || 'TBD')}</div>
        </div>
    `;

    // Generate timeline phases content
    const timelineContent = `
        <h3 style="margin-bottom: 16px;">Project Phases</h3>
        <div style="max-height: 500px; overflow-y: auto;">
            ${standardWebsitePhases.map((phase, index) => `
                <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border-left: 3px solid var(--accent-amber);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <span style="display: inline-block; background: var(--accent-amber); color: var(--bg-void); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; margin-right: 8px;">Phase ${index + 1}</span>
                            <span style="font-size: 15px; font-weight: 600;">${phase.name}</span>
                        </div>
                        <span style="font-size: 12px; color: var(--text-muted);">${phase.duration}</span>
                    </div>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        ${phase.tasks.map(task => `
                            <li style="padding: 6px 0; padding-left: 20px; position: relative; font-size: 13px; color: var(--text-secondary);">
                                <span style="position: absolute; left: 0; top: 6px; color: var(--accent-amber);"></span>
                                ${task}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('')}
        </div>
    `;

    // Set up the modal structure with tabs
    bodyEl.innerHTML = `
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="timeline">Timeline</button>
            <button class="tab" data-tab="preview">Full SLA Preview</button>
        </div>

        <div id="tab-overview" class="tab-content" style="padding: 24px;">
            ${overviewContent}
        </div>

        <div id="tab-timeline" class="tab-content" style="display: none; padding: 24px;">
            ${timelineContent}
        </div>

        <div id="tab-preview" class="tab-content" style="display: none; padding: 24px;">
            <!-- Will be populated when tab is clicked -->
        </div>
    `;

footerEl.innerHTML = `
    <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
    <button class="btn btn-secondary" onclick="emailTimelineToClient()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
        </svg>
        Email to Client
    </button>
    <button class="btn btn-primary" onclick="exportTimelineAsPDF()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export as PDF
    </button>
`;

    // Store for export
    window.currentTimelinePreview = timeline;

    modal.classList.add('active');

    // Set up tab click handlers AFTER modal is visible
    setTimeout(() => {
        document.querySelectorAll('#detailModal .tab').forEach(tab => {
            tab.addEventListener('click', function () {
                // Remove active from all tabs
                document.querySelectorAll('#detailModal .tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Hide all contents
                document.querySelectorAll('#detailModal .tab-content').forEach(c => c.style.display = 'none');

                // Show selected
                const tabId = 'tab-' + this.dataset.tab;
                const content = document.getElementById(tabId);
                if (content) {
                    content.style.display = 'block';

                    // Special case: when user clicks "Full SLA Preview" tab  generate content
                    if (this.dataset.tab === 'preview') {
                        content.innerHTML = generateTimelineHTML(timeline);
                    }
                }
            });
        });
    }, 100);
}

async function emailTimelineToClient() {
    const timeline = window.currentTimelinePreview;
    if (!timeline) {
        showToast('No timeline to email', 'error');
        return;
    }
    
    if (!timeline.clientEmail) {
        showToast('No client email address found', 'error');
        return;
    }
    
    // Show loading toast
    showToast('Sending email...', 'warning');
    
    try {
        const response = await fetch(`${API_URL}/api/email/send-timeline`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
                timeline: timeline,
                clientEmail: timeline.clientEmail,
                clientName: timeline.clientName
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast(` SLA emailed successfully to ${timeline.clientEmail}`, 'success');
        } else {
            throw new Error(result.message || 'Failed to send email');
        }
    } catch (error) {
        console.error('Email error:', error);
        showToast('Failed to send email: ' + error.message, 'error');
    }
}

// Generate Timeline HTML (generates the SLA document)
function generateTimelineHTML(timeline) {
    // Use the SAME HTML generation logic as PDF export
    let totalPrice = 0;
    let hasPaidPackage = false;
    
    timeline.packages.forEach(function(key) {
        if (servicePackages[key] && !servicePackages[key].isFree) {
            hasPaidPackage = true;
            totalPrice += servicePackages[key].price;
        }
    });
    
    const companySignatureDate = formatDate(timeline.createdAt);
    const documentId = `SLA-${new Date(timeline.createdAt).getFullYear()}-${String(Date.now()).slice(-6)}`;
    
    // Get longest support period
    let longestSupportPeriod = 0;
    timeline.packages.forEach(key => {
        if (key === 'starter-website') longestSupportPeriod = Math.max(longestSupportPeriod, 90);
        if (key === 'professional-website') longestSupportPeriod = Math.max(longestSupportPeriod, 120);
        if (key === 'enterprise-website') longestSupportPeriod = Math.max(longestSupportPeriod, 365);
    });
    
    // Build packages HTML
    let packagesListHtml = '';
    timeline.packages.forEach(function(key) {
        if (servicePackages[key]) {
            const pkg = servicePackages[key];
            packagesListHtml += '<span style="display: inline-block; background: var(--accent-amber-dim); color: var(--accent-amber); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin: 4px;">' + pkg.name + (pkg.isFree ? ' (FREE)' : '') + '</span>';
        }
    });
    
    // Build phases HTML
    let phasesHtml = '';
    let phaseNumber = 1;
    timeline.packages.forEach(function(packageKey) {
        const pkg = servicePackages[packageKey];
        if (!pkg) return;
        
        phasesHtml += '<div style="margin-bottom: 24px; padding: 20px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md);">';
        phasesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--accent-amber);">';
        phasesHtml += '<div><div style="font-size: 16px; font-weight: 700; color: var(--text-primary);">' + pkg.name + '</div>';
        phasesHtml += '<div style="font-size: 12px; color: var(--text-secondary);">' + pkg.description + '</div></div>';
        phasesHtml += '<div style="text-align: right;"><div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted);">Duration</div>';
        phasesHtml += '<div style="font-size: 14px; font-weight: 700; color: var(--text-primary);">' + pkg.duration + '</div></div></div>';
        
        if (pkg.phases) {
            pkg.phases.forEach(function(phase) {
                phasesHtml += '<div style="margin-bottom: 16px; padding-left: 16px; border-left: 3px solid var(--accent-amber);">';
                phasesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                phasesHtml += '<div><span style="display: inline-block; background: var(--accent-amber); color: var(--bg-void); padding: 2px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; margin-right: 8px;">Phase ' + phaseNumber + '</span>';
                phasesHtml += '<span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">' + phase.name + '</span></div>';
                phasesHtml += '<span style="font-size: 11px; color: var(--text-muted); background: var(--bg-hover); padding: 4px 10px; border-radius: var(--radius-sm);">' + phase.duration + '</span></div>';
                phasesHtml += '<ul style="list-style: none; padding: 0; margin: 0;">';
                
                phase.tasks.forEach(function(task) {
                    phasesHtml += '<li style="display: flex; align-items: flex-start; gap: 8px; padding: 5px 0; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border-subtle);">';
                    phasesHtml += '<svg style="width: 14px; height: 14px; color: var(--accent-amber); flex-shrink: 0; margin-top: 3px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
                    phasesHtml += task + '</li>';
                });
                
                phasesHtml += '</ul></div>';
                phaseNumber++;
            });
        }
        
        // Features list
        if (pkg.features) {
            phasesHtml += '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">';
            phasesHtml += '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px;">Included Features</div>';
            phasesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
            pkg.features.forEach(function(feature) {
                phasesHtml += '<span style="background: var(--bg-hover); color: var(--text-secondary); padding: 3px 8px; border-radius: 12px; font-size: 10px; border: 1px solid var(--border-subtle);">' + feature + '</span>';
            });
            phasesHtml += '</div></div>';
        }
        
        phasesHtml += '</div>';
    });
    
    // Payment terms
    let paymentTermsHtml = '';
    if (timeline.isFreeProject || !hasPaidPackage) {
        paymentTermsHtml = 'No Payment Required';
    } else {
        switch (timeline.paymentTerms) {
            case 'completion':
                paymentTermsHtml = '100% Due Upon Completion';
                break;
            case 'net30':
                paymentTermsHtml = 'Net 30 (Payment due 30 days after completion)';
                break;
            case 'net15':
                paymentTermsHtml = 'Net 15 (Payment due 15 days after completion)';
                break;
            case 'milestone':
                paymentTermsHtml = 'Milestone-Based (Split across project phases)';
                break;
            case 'custom':
                paymentTermsHtml = timeline.customPaymentDetails || 'Custom Payment Plan';
                break;
            default:
                paymentTermsHtml = '100% Due Upon Completion';
        }
    }
    
    // Maintenance section
    let maintenanceHtml = '';
    if (timeline.maintenanceIncluded && timeline.maintenanceIncluded !== 'no') {
        maintenanceHtml = '<div style="background: var(--bg-tertiary); padding: 20px; border: 1px solid var(--border-subtle); border-left: 4px solid ' + (timeline.maintenanceIncluded === 'free' ? 'var(--status-contacted)' : 'var(--accent-amber)') + '; border-radius: var(--radius-md); margin-bottom: 24px;">';
        maintenanceHtml += '<div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 12px;">Maintenance & Support Terms</div>';
        
        if (timeline.maintenanceIncluded === 'free') {
            maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: var(--status-contacted); margin-bottom: 12px;"> FREE Maintenance';
            if (longestSupportPeriod > 0) {
                maintenanceHtml += ' During ' + longestSupportPeriod + '-Day Support Period';
            }
            maintenanceHtml += '</div>';
        } else if (timeline.maintenanceIncluded === 'paid') {
            maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">Post-Support Maintenance: $' + parseFloat(timeline.maintenanceFee || 59.99).toFixed(2) + '/month';
            if (longestSupportPeriod > 0) {
                maintenanceHtml += ' (After ' + longestSupportPeriod + '-Day Free Support Period)';
            }
            maintenanceHtml += '</div>';
        }
        
        maintenanceHtml += '<div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">';
        if (timeline.maintenanceDetails) {
            maintenanceHtml += timeline.maintenanceDetails;
        } else {
            maintenanceHtml += 'Bug fixes, security updates, minor content modifications (up to 2 hours/month), plugin/software updates, uptime monitoring, priority email support.';
        }
        maintenanceHtml += '</div></div>';
    } else if (longestSupportPeriod > 0) {
        maintenanceHtml = '<div style="background: var(--bg-tertiary); padding: 20px; border: 1px solid var(--border-subtle); border-left: 4px solid var(--accent-amber); border-radius: var(--radius-md); margin-bottom: 24px;">';
        maintenanceHtml += '<div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 12px;">Post-Launch Support</div>';
        maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">' + longestSupportPeriod + ' Days of FREE Priority Support Included</div>';
        maintenanceHtml += '<div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">Following project launch, you will receive ' + longestSupportPeriod + ' days of free priority support including bug fixes, technical assistance, and minor adjustments.</div></div>';
    }
    
    // Scope section
    let scopeHtml = '';
    if (timeline.scope) {
        scopeHtml = '<div style="background: var(--bg-tertiary); padding: 16px; border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 24px;">';
        scopeHtml += '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px;">Project Scope / Special Requirements</div>';
        scopeHtml += '<p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.7;">' + timeline.scope + '</p></div>';
    }
    
    // Return the SAME structure as PDF
    return `
        <div style="padding: 24px;">
            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md); margin-bottom: 32px; border-left: 4px solid var(--accent-amber);">
                <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 12px;">Agreement Overview</div>
                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                    This Service Level Agreement is entered into as of <strong>${companySignatureDate}</strong> by and between 
                    <strong>DIAMONDBACK</strong> and <strong>${timeline.clientName}${timeline.clientCompany ? ' / ' + timeline.clientCompany : ''}</strong>.
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 32px;">
                <div>
                    <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 6px;">Service Provider</div>
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">DIAMONDBACK</div>
                    <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;">
                        5000 Plaza on the Lake, Suite 100 PMB 2017<br>
                        Austin, TX 78746<br>
                        contact@diamondbackcoding.com<br>
                        (512) 980-0393
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-hover); border-radius: var(--radius-sm);">
                        <div style="font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px;">Company Signature</div>
                        <div style="font-family: cursive; font-size: 20px; color: var(--accent-amber); margin-bottom: 4px;">DIAMONDBACK</div>
                        <div style="font-size: 10px; color: var(--text-muted);">Digitally Signed: ${companySignatureDate}</div>
                    </div>
                </div>
                <div>
                    <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 6px;">Client</div>
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">${timeline.clientName}</div>
                    <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;">
                        ${timeline.clientCompany ? timeline.clientCompany + '<br>' : ''}
                        ${timeline.clientEmail || ''}${timeline.clientPhone || timeline.clientAddress ? '<br>' : ''}
                        ${timeline.clientPhone || ''}${timeline.clientAddress ? '<br>' : ''}
                        ${timeline.clientAddress ? timeline.clientAddress.replace(/\n/g, '<br>') : ''}
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-hover); border-radius: var(--radius-sm); border: 2px dashed var(--border-strong);">
                        <div style="font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px;">Client Signature Required</div>
                        <div style="height: 40px; border-bottom: 1px solid var(--text-muted); margin-bottom: 4px;"></div>
                        <div style="font-size: 10px; color: var(--text-muted);">Date: _______________</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 32px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Project Details</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Project Name</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${timeline.projectName || 'Web Development Project'}</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Estimated Start Date</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${formatDate(timeline.startDate)}</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Total Investment</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--accent-amber);">${timeline.isFreeProject ? 'FREE' : '$' + totalPrice.toLocaleString()}</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md);">
                        <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Payment Terms</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${paymentTermsHtml}</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 32px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Selected Services</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${packagesListHtml}
                </div>
            </div>
            
            ${scopeHtml}

            <!-- STANDARDIZED WEBSITE DEVELOPMENT TIMELINE -->
<div style="margin-bottom: 32px;">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Website Development Process</div>
    
    <div style="margin-bottom: 32px; padding: 24px; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle);">
        ${standardWebsitePhases.map((phase, index) => `
            <div style="margin-bottom: 20px; padding-left: 20px; border-left: 3px solid var(--accent-amber);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div>
                        <span style="display: inline-block; background: var(--accent-amber); color: var(--bg-void); padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; margin-right: 8px;">Phase ${index + 1}</span>
                        <span style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${phase.name}</span>
                    </div>
                    <span style="font-size: 12px; color: var(--text-muted); background: var(--bg-hover); padding: 4px 10px; border-radius: var(--radius-sm);">${phase.duration}</span>
                </div>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    ${phase.tasks.map(task => `
                        <li style="display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border-subtle);">
                            <svg style="width: 16px; height: 16px; color: var(--accent-amber); flex-shrink: 0; margin-top: 2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 11 12 14 22 4"/>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                            ${task}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `).join('')}
    </div>
</div>

<!-- DETAILED PROJECT TIMELINE -->
<div style="margin-bottom: 32px;">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Detailed Project Timeline</div>
            
            <div style="margin-bottom: 32px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Service Level Commitments</div>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex-shrink: 0; width: 24px; height: 24px; background: var(--accent-amber); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-void); font-weight: 700; font-size: 12px;">1</div>
                        <div><div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Timeline Adherence</div><div style="font-size: 13px; color: var(--text-secondary);">Provider commits to delivering all project phases within specified timeframes.</div></div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex-shrink: 0; width: 24px; height: 24px; background: var(--accent-amber); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-void); font-weight: 700; font-size: 12px;">2</div>
                        <div><div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Communication Response Time</div><div style="font-size: 13px; color: var(--text-secondary);">Provider will respond within 24 business hours (Mon-Fri, 8 AM - 5 PM CST).</div></div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex-shrink: 0; width: 24px; height: 24px; background: var(--accent-amber); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-void); font-weight: 700; font-size: 12px;">3</div>
                        <div><div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Quality Assurance</div><div style="font-size: 13px; color: var(--text-secondary);">All deliverables undergo comprehensive testing across major browsers and devices.</div></div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex-shrink: 0; width: 24px; height: 24px; background: var(--accent-amber); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-void); font-weight: 700; font-size: 12px;">4</div>
                        <div><div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Post-Launch Support</div><div style="font-size: 13px; color: var(--text-secondary);">Free priority support period begins immediately after launch.</div></div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 32px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 16px;">Detailed Project Timeline</div>
                ${phasesHtml}
            </div>
            
            ${maintenanceHtml}
            
            <div style="background: var(--bg-tertiary); padding: 20px; border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 24px;">
                <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent-amber); margin-bottom: 12px;">Client Responsibilities</div>
                <ul style="margin: 12px 0 0 20px; padding: 0; font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                    <li style="margin-bottom: 8px;">Provide all required content within 3 business days of request</li>
                    <li style="margin-bottom: 8px;">Respond to design/development reviews within 5 business days</li>
                    <li style="margin-bottom: 8px;">Attend scheduled bi-weekly progress meetings during draft phase</li>
                    <li style="margin-bottom: 8px;">Designate a single point of contact for project communications</li>
                    <li style="margin-bottom: 8px;">Make payments according to agreed schedule</li>
                    <li style="margin-bottom: 8px;">Provide access to necessary accounts, hosting, and domain credentials</li>
                </ul>
            </div>
            
            <div style="background: var(--bg-hover); padding: 20px; border: 1px solid var(--border-subtle); border-radius: var(--radius-md); border-left: 4px solid var(--accent-amber); margin-bottom: 24px;">
                <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--accent-amber); margin-bottom: 8px;">Governing Law</div>
                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.7;">
                    This Agreement shall be governed by the laws of the State of Texas. Any disputes shall be resolved in Texas state or federal courts.
                </div>
            </div>
            
            ${timeline.notes ? '<div style="margin-top: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-md); border-left: 3px solid var(--accent-amber);"><div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">Additional Notes</div><div style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">' + timeline.notes + '</div></div>' : ''}
            
            <div style="background: rgba(245,158,11,0.1); border: 2px solid var(--accent-amber); padding: 20px; border-radius: var(--radius-md); text-align: center; margin-top: 32px;">
                <div style="font-size: 14px; font-weight: 700; color: var(--accent-amber); margin-bottom: 8px;"> Client Signature Required</div>
                <div style="font-size: 13px; color: var(--text-secondary);">Please sign and date this SLA in the Client section above. This document becomes legally binding once both parties have signed.</div>
            </div>
        </div>
    `;
}

function getPaymentTermsText(timeline) {
    if (timeline.isFreeProject) {
        return 'No Payment Required';
    }
    
    switch (timeline.paymentTerms) {
        case 'completion':
            return '100% Due Upon Completion';
        case 'net30':
            return 'Net 30 Days After Completion';
        case 'net15':
            return 'Net 15 Days After Completion';
        case 'milestone':
            return 'Milestone-Based Payments';
        case 'custom':
            return timeline.customPaymentDetails || 'Custom Payment Plan';
        default:
            return '100% Due Upon Completion';
    }
}

// Delete project timeline
function deleteProjectTimeline(index) {
if (!confirm('Are you sure you want to delete this project timeline?')) return;
const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
savedTimelines.splice(index, 1);
localStorage.setItem('projectTimelines', JSON.stringify(savedTimelines));

showToast('Timeline deleted successfully', 'success');
renderSection('projects');
}
// Export project timeline
function exportProjectTimeline(index) {
const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
const timeline = savedTimelines[index];
if (!timeline) {
    showToast('Timeline not found', 'error');
    return;
}

window.currentTimelinePreview = timeline;
exportTimelineAsPDF();
}
function exportTimelineAsPDF() {
    const timeline = window.currentTimelinePreview;
    if (!timeline) {
        showToast('No timeline to export', 'error');
        return;
    }
    
    closeDetailModal();
    
    setTimeout(function() {
        let totalPrice = 0;
        let hasPaidPackage = false;
        
        timeline.packages.forEach(function(key) {
            if (servicePackages[key] && !servicePackages[key].isFree) {
                hasPaidPackage = true;
                totalPrice += servicePackages[key].price;
            }
        });
        
        const companySignatureDate = formatDate(timeline.createdAt);
        const documentId = 'SLA-' + new Date(timeline.createdAt).getFullYear() + '-' + String(Date.now()).slice(-6);
        
        // Get longest support period
        let longestSupportPeriod = 0;
        timeline.packages.forEach(key => {
            if (key === 'starter-website') longestSupportPeriod = Math.max(longestSupportPeriod, 90);
            if (key === 'professional-website') longestSupportPeriod = Math.max(longestSupportPeriod, 120);
            if (key === 'enterprise-website') longestSupportPeriod = Math.max(longestSupportPeriod, 365);
        });
        
        // Build packages HTML
        let packagesListHtml = '';
        timeline.packages.forEach(function(key) {
            if (servicePackages[key]) {
                const pkg = servicePackages[key];
                packagesListHtml += '<div style="display: inline-block; background: #f8f9fa; border: 1px solid #D4A574; color: #000; padding: 6px 14px; border-radius: 4px; font-size: 11px; font-weight: 600; margin: 0 8px 8px 0;">' + pkg.name + (pkg.isFree ? ' <span style="color: #D4A574;">(FREE)</span>' : '') + '</div>';
            }
        });
        
        // Build standardized phases
        let standardPhasesHtml = '<div style="margin-bottom: 40px;">' +
            '<div style="font-size: 13px; font-weight: 700; color: #D4A574; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #D4A574;">WEBSITE DEVELOPMENT PROCESS</div>';

        standardWebsitePhases.forEach(function(phase, index) {
            standardPhasesHtml += '<div style="margin-bottom: 24px; background: #f8f9fa; padding: 20px; border-left: 4px solid #D4A574; border-radius: 4px;">';
            standardPhasesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
            standardPhasesHtml += '<div style="display: flex; align-items: center; gap: 10px;">';
            standardPhasesHtml += '<span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #D4A574; color: white; border-radius: 50%; font-size: 13px; font-weight: 700;">' + (index + 1) + '</span>';
            standardPhasesHtml += '<span style="font-size: 15px; font-weight: 700; color: #000;">' + phase.name + '</span></div>';
            standardPhasesHtml += '<span style="font-size: 12px; color: #666; background: white; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd;">' + phase.duration + '</span></div>';
            standardPhasesHtml += '<ul style="list-style: none; padding: 0; margin: 12px 0 0 0;">';
            
            phase.tasks.forEach(function(task) {
                standardPhasesHtml += '<li style="padding: 8px 0; padding-left: 28px; position: relative; font-size: 12px; color: #333; line-height: 1.6;">';
                standardPhasesHtml += '<span style="position: absolute; left: 8px; top: 8px; color: #D4A574; font-weight: bold;"></span>';
                standardPhasesHtml += task + '</li>';
            });
            
            standardPhasesHtml += '</ul></div>';
        });

        standardPhasesHtml += '</div>';
        
        // Build detailed phases HTML
        let phasesHtml = '';
        let phaseNumber = 1;
        timeline.packages.forEach(function(packageKey) {
            const pkg = servicePackages[packageKey];
            if (!pkg) return;
            
            phasesHtml += '<div style="margin-bottom: 30px; background: white; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden;">';
            phasesHtml += '<div style="background: #D4A574; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;">';
            phasesHtml += '<div><div style="font-size: 16px; font-weight: 700;">' + pkg.name + '</div>';
            phasesHtml += '<div style="font-size: 12px; opacity: 0.95; margin-top: 2px;">' + pkg.description + '</div></div>';
            phasesHtml += '<div style="text-align: right;"><div style="font-size: 10px; text-transform: uppercase; opacity: 0.9;">Duration</div>';
            phasesHtml += '<div style="font-size: 14px; font-weight: 700;">' + pkg.duration + '</div></div></div>';
            
            phasesHtml += '<div style="padding: 20px;">';
            
            if (pkg.phases) {
                pkg.phases.forEach(function(phase) {
                    phasesHtml += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                    phasesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
                    phasesHtml += '<div><span style="display: inline-block; background: #000; color: white; padding: 4px 10px; border-radius: 3px; font-size: 10px; font-weight: 700; margin-right: 8px;">PHASE ' + phaseNumber + '</span>';
                    phasesHtml += '<span style="font-size: 14px; font-weight: 600; color: #000;">' + phase.name + '</span></div>';
                    phasesHtml += '<span style="font-size: 11px; color: #666; background: #f8f9fa; padding: 4px 10px; border-radius: 3px;">' + phase.duration + '</span></div>';
                    phasesHtml += '<ul style="list-style: none; padding: 0; margin: 0;">';
                    
                    phase.tasks.forEach(function(task) {
                        phasesHtml += '<li style="padding: 6px 0; padding-left: 24px; position: relative; font-size: 12px; color: #444; line-height: 1.5;">';
                        phasesHtml += '<span style="position: absolute; left: 4px; top: 6px; color: #D4A574; font-weight: bold;"></span>';
                        phasesHtml += task + '</li>';
                    });
                    
                    phasesHtml += '</ul></div>';
                    phaseNumber++;
                });
            }
            
            // Features list
            if (pkg.features) {
                phasesHtml += '<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #f0f0f0;">';
                phasesHtml += '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #D4A574; margin-bottom: 12px;">INCLUDED FEATURES</div>';
                phasesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
                pkg.features.forEach(function(feature) {
                    phasesHtml += '<span style="background: #f8f9fa; color: #333; padding: 4px 10px; border-radius: 3px; font-size: 10px; border: 1px solid #e0e0e0;">' + feature + '</span>';
                });
                phasesHtml += '</div></div>';
            }
            
            phasesHtml += '</div></div>';
        });
        
        // Payment terms
        let paymentTermsHtml = '';
        if (timeline.isFreeProject || !hasPaidPackage) {
            paymentTermsHtml = 'No Payment Required';
        } else {
            switch (timeline.paymentTerms) {
                case 'completion':
                    paymentTermsHtml = '100% Due Upon Completion';
                    break;
                case 'net30':
                    paymentTermsHtml = '50% Deposit + 50% Net 30';
                    break;
                case 'net15':
                    paymentTermsHtml = '50% Deposit + 50% Net 15';
                    break;
                case 'milestone':
                    paymentTermsHtml = 'Milestone-Based Payments';
                    break;
                case 'custom':
                    paymentTermsHtml = timeline.customPaymentDetails || 'Custom Payment Plan';
                    break;
                default:
                    paymentTermsHtml = '100% Due Upon Completion';
            }
        }
        
        // Maintenance section
        let maintenanceHtml = '';
        if (timeline.maintenanceIncluded && timeline.maintenanceIncluded !== 'no') {
            maintenanceHtml = '<div style="background: #f8f9fa; padding: 20px; border: 1px solid #e0e0e0; border-left: 4px solid #D4A574; border-radius: 4px; margin-bottom: 30px;">';
            maintenanceHtml += '<div style="font-size: 13px; font-weight: 700; color: #D4A574; margin-bottom: 12px; text-transform: uppercase;">Maintenance & Support Terms</div>';
            
            if (timeline.maintenanceIncluded === 'free') {
                maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: #000; margin-bottom: 10px;"> FREE Maintenance';
                if (longestSupportPeriod > 0) {
                    maintenanceHtml += ' During ' + longestSupportPeriod + '-Day Support Period';
                }
                maintenanceHtml += '</div>';
            } else if (timeline.maintenanceIncluded === 'paid') {
                maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: #000; margin-bottom: 10px;">Monthly Maintenance: $' + parseFloat(timeline.maintenanceFee || 59.99).toFixed(2) + '/month';
                if (longestSupportPeriod > 0) {
                    maintenanceHtml += ' (After ' + longestSupportPeriod + '-Day Free Period)';
                }
                maintenanceHtml += '</div>';
            }
            
            maintenanceHtml += '<div style="font-size: 12px; color: #444; line-height: 1.6;">';
            if (timeline.maintenanceDetails) {
                maintenanceHtml += timeline.maintenanceDetails;
            } else {
                maintenanceHtml += 'Includes: Bug fixes, security updates, minor content modifications (up to 2 hours/month), plugin updates, uptime monitoring, and priority support.';
            }
            maintenanceHtml += '</div></div>';
        } else if (longestSupportPeriod > 0) {
            maintenanceHtml = '<div style="background: #f8f9fa; padding: 20px; border: 1px solid #e0e0e0; border-left: 4px solid #D4A574; border-radius: 4px; margin-bottom: 30px;">';
            maintenanceHtml += '<div style="font-size: 13px; font-weight: 700; color: #D4A574; margin-bottom: 12px; text-transform: uppercase;">Post-Launch Support</div>';
            maintenanceHtml += '<div style="font-size: 14px; font-weight: 600; color: #000; margin-bottom: 10px;">' + longestSupportPeriod + ' Days of FREE Priority Support Included</div>';
            maintenanceHtml += '<div style="font-size: 12px; color: #444; line-height: 1.6;">Following project launch, you will receive ' + longestSupportPeriod + ' days of free priority support including bug fixes, technical assistance, and minor adjustments.</div></div>';
        }
        
        // Scope section
        let scopeHtml = '';
        if (timeline.scope) {
            scopeHtml = '<div style="background: #f8f9fa; padding: 18px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 30px;">';
            scopeHtml += '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #D4A574; margin-bottom: 8px;">Project Scope / Special Requirements</div>';
            scopeHtml += '<p style="font-size: 12px; color: #444; margin: 0; line-height: 1.6;">' + timeline.scope + '</p></div>';
        }
        
        const printWindow = window.open('', '_blank', 'width=900,height=700');
        
        if (!printWindow) {
            showToast('Please allow popups to export', 'error');
            return;
        }
        
        const htmlContent = '<!DOCTYPE html>' +
        '<html>' +
        '<head>' +
            '<title>SLA - ' + timeline.clientName + '</title>' +
            '<style>' +
                '* { margin: 0; padding: 0; box-sizing: border-box; }' +
                'body { font-family: "Segoe UI", Arial, sans-serif; background: #ffffff; color: #000; line-height: 1.5; }' +
                '.container { max-width: 900px; margin: 0 auto; }' +
                '.page { background: white; padding: 50px; }' +
                '@media print { body { margin: 0; } .page { padding: 40px; page-break-inside: avoid; } }' +
            '</style>' +
        '</head>' +
        '<body>' +
            '<div class="container">' +
                '<div class="page">' +
                    // HEADER WITH GREEN BAR
                    '<div style="background: #000; padding: 30px 40px; margin: -50px -50px 40px -50px; border-radius: 0;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                            '<div>' +
                                '<div style="font-size: 32px; font-weight: 800; color: white; letter-spacing: -0.5px; margin-bottom: 4px;">DIAMONDBACK CODING</div>' +
                                '<div style="font-size: 12px; color: rgba(255,255,255,0.95); font-weight: 500; letter-spacing: 1px;">PREMIUM DEVELOPMENT SERVICES</div>' +
                            '</div>' +
                            '<div style="text-align: right;">' +
                                '<div style="font-size: 11px; color: rgba(255,255,255,0.9); font-weight: 600; margin-bottom: 4px;">DOCUMENT ID</div>' +
                                '<div style="font-size: 13px; color: white; font-weight: 700; font-family: monospace;">' + documentId + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    // TITLE
                    '<div style="text-align: center; margin-bottom: 40px;">' +
                        '<div style="font-size: 28px; font-weight: 800; color: #000; margin-bottom: 8px; letter-spacing: -0.5px;">SERVICE LEVEL AGREEMENT</div>' +
                        '<div style="font-size: 13px; color: #666; font-weight: 500;">Project Timeline & Terms of Service</div>' +
                    '</div>' +
                    
                    // AGREEMENT OVERVIEW
                    '<div style="background: #f8f9fa; padding: 24px; border-left: 4px solid #D4A574; border-radius: 4px; margin-bottom: 40px;">' +
                        '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #D4A574; margin-bottom: 12px;">Agreement Overview</div>' +
                        '<div style="font-size: 12px; color: #444; line-height: 1.7;">This Service Level Agreement ("Agreement") is entered into as of <strong>' + companySignatureDate + '</strong> by and between <strong>DIAMONDBACK</strong> ("Provider"), a Texas-based web development company, and <strong>' + timeline.clientName + (timeline.clientCompany ? ' / ' + timeline.clientCompany : '') + '</strong> ("Client").</div>' +
                    '</div>' +
                    
                    // PARTIES (TWO COLUMNS)
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">' +
                        // PROVIDER
                        '<div style="background: white; border: 2px solid #e0e0e0; border-radius: 4px; padding: 24px;">' +
                            '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #D4A574; margin-bottom: 12px;">Service Provider</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #000; margin-bottom: 8px;">DIAMONDBACK</div>' +
                            '<div style="font-size: 11px; color: #666; line-height: 1.6; margin-bottom: 16px;">' +
                                '5000 Plaza on the Lake, Suite 100 PMB 2017<br>' +
                                'Austin, TX 78746<br>' +
                                'contact@diamondbackcoding.com<br>' +
                                '(512) 980-0393' +
                            '</div>' +
                            '<div style="background: #f8f9fa; padding: 16px; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                '<div style="font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 8px;">Authorized Signature</div>' +
                                '<div style="font-family: Brush Script MT, cursive; font-size: 28px; color: #D4A574; margin-bottom: 4px; line-height: 1;">DIAMONDBACK</div>' +
                                '<div style="height: 1px; background: #D4A574; margin: 8px 0;"></div>' +
                                '<div style="font-size: 10px; color: #666;">Date: ' + companySignatureDate + '</div>' +
                                '<div style="font-size: 9px; color: #999; margin-top: 4px;">Digitally Authorized Representative</div>' +
                            '</div>' +
                        '</div>' +
                        
                        // CLIENT
                        '<div style="background: white; border: 2px solid #e0e0e0; border-radius: 4px; padding: 24px;">' +
                            '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #D4A574; margin-bottom: 12px;">Client</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #000; margin-bottom: 8px;">' + timeline.clientName + '</div>' +
                            '<div style="font-size: 11px; color: #666; line-height: 1.6; margin-bottom: 16px;">' +
                                (timeline.clientCompany ? timeline.clientCompany + '<br>' : '') +
                                (timeline.clientEmail || '') + (timeline.clientPhone || timeline.clientAddress ? '<br>' : '') +
                                (timeline.clientPhone || '') + (timeline.clientAddress ? '<br>' : '') +
                                (timeline.clientAddress ? timeline.clientAddress.replace(/\n/g, '<br>') : '') +
                            '</div>' +
                            '<div style="background: white; padding: 16px; border-radius: 4px; border: 2px dashed #D4A574;">' +
                                '<div style="font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 8px;">Client Signature Required</div>' +
                                '<div style="height: 50px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>' +
                                '<div style="font-size: 10px; color: #666;">Date: _______________</div>' +
                                '<div style="font-size: 9px; color: #999; margin-top: 8px; line-height: 1.4;">By signing, Client agrees to all terms, timelines, and pricing outlined in this SLA.</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    // PROJECT DETAILS (4 BOXES)
                    '<div style="margin-bottom: 40px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #D4A574; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #D4A574;">PROJECT DETAILS</div>' +
                        '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">' +
                            '<div style="background: #f8f9fa; padding: 18px; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #666; margin-bottom: 6px;">Project Name</div>' +
                                '<div style="font-size: 15px; font-weight: 700; color: #000;">' + (timeline.projectName || 'Web Development Project') + '</div>' +
                            '</div>' +
                            '<div style="background: #f8f9fa; padding: 18px; border-radius: 4px; border: 1px solid #e0e0e0;">' +
                                '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #666; margin-bottom: 6px;">Start Date</div>' +
                                '<div style="font-size: 15px; font-weight: 700; color: #000; font-family: monospace;">' + formatDate(timeline.startDate) + '</div>' +
                            '</div>' +
                            '<div style="background: #D4A574; padding: 18px; border-radius: 4px;">' +
                                '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.9); margin-bottom: 6px;">Total Investment</div>' +
                                '<div style="font-size: 22px; font-weight: 800; color: white; font-family: monospace;">' + (timeline.isFreeProject ? 'FREE' : '$' + totalPrice.toLocaleString()) + '</div>' +
                            '</div>' +
                            '<div style="background: #000; padding: 18px; border-radius: 4px;">' +
                                '<div style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: rgba(255,255,255,0.7); margin-bottom: 6px;">Payment Terms</div>' +
                                '<div style="font-size: 13px; font-weight: 700; color: white; line-height: 1.3;">' + paymentTermsHtml + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    // SELECTED SERVICES
                    '<div style="margin-bottom: 40px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #D4A574; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #D4A574;">SELECTED SERVICES</div>' +
                        '<div>' + packagesListHtml + '</div>' +
                    '</div>' +
                    
                    scopeHtml +
                    
                    // STANDARDIZED PHASES
                    standardPhasesHtml +
                    
                    // SERVICE LEVEL COMMITMENTS
                    '<div style="margin-bottom: 40px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #D4A574; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #D4A574;">SERVICE LEVEL COMMITMENTS</div>' +
                        '<div style="display: grid; gap: 16px;">' +
                            '<div style="display: flex; gap: 12px; align-items: start;">' +
                                '<div style="flex-shrink: 0; width: 32px; height: 32px; background: #D4A574; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">1</div>' +
                                '<div><div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 4px;">Timeline Adherence</div><div style="font-size: 12px; color: #666; line-height: 1.5;">Provider commits to delivering all project phases within specified timeframes, subject to timely Client feedback and approval.</div></div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 12px; align-items: start;">' +
                                '<div style="flex-shrink: 0; width: 32px; height: 32px; background: #D4A574; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">2</div>' +
                                '<div><div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 4px;">Communication Response Time</div><div style="font-size: 12px; color: #666; line-height: 1.5;">Provider will respond to Client inquiries within 24 business hours during regular business hours (Mon-Fri, 8 AM - 5 PM CST).</div></div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 12px; align-items: start;">' +
                                '<div style="flex-shrink: 0; width: 32px; height: 32px; background: #D4A574; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">3</div>' +
                                '<div><div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 4px;">Quality Assurance</div><div style="font-size: 12px; color: #666; line-height: 1.5;">All deliverables undergo comprehensive testing across major browsers and devices before client review.</div></div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 12px; align-items: start;">' +
                                '<div style="flex-shrink: 0; width: 32px; height: 32px; background: #D4A574; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">4</div>' +
                                '<div><div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 4px;">Post-Launch Support</div><div style="font-size: 12px; color: #666; line-height: 1.5;">Free priority support period begins immediately after launch (duration specified in selected package).</div></div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    // DETAILED TIMELINE
                    '<div style="margin-bottom: 40px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #D4A574; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #D4A574;">DETAILED PROJECT TIMELINE</div>' +
                        phasesHtml +
                    '</div>' +
                    
                    maintenanceHtml +
                    
                    // CLIENT RESPONSIBILITIES
                    '<div style="background: #f8f9fa; padding: 24px; border: 1px solid #e0e0e0; border-left: 4px solid #000; border-radius: 4px; margin-bottom: 30px;">' +
                        '<div style="font-size: 13px; font-weight: 700; color: #000; margin-bottom: 16px; text-transform: uppercase;">Client Responsibilities</div>' +
                        '<ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #444; line-height: 1.8;">' +
                            '<li style="margin-bottom: 8px;">Provide all required content, images, and materials within 3 business days of request</li>' +
                            '<li style="margin-bottom: 8px;">Respond to design/development reviews within 5 business days</li>' +
                            '<li style="margin-bottom: 8px;">Attend scheduled bi-weekly progress meetings during draft phase</li>' +
                            '<li style="margin-bottom: 8px;">Designate a single point of contact for project communications</li>' +
                            '<li style="margin-bottom: 8px;">Make payments according to the agreed schedule</li>' +
                            '<li style="margin-bottom: 8px;">Provide access to necessary accounts, hosting, and domain credentials</li>' +
                            '<li>Notify Provider immediately of any changes to project scope or requirements</li>' +
                        '</ul>' +
                    '</div>' +
                    
                    // GOVERNING LAW
                    '<div style="background: #fff; padding: 20px; border: 2px solid #e0e0e0; border-radius: 4px; margin-bottom: 30px;">' +
                        '<div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #D4A574; margin-bottom: 8px;">Governing Law</div>' +
                        '<div style="font-size: 11px; color: #666; line-height: 1.6;">This Agreement shall be governed by and construed in accordance with the laws of the State of Texas, without regard to its conflict of law provisions. Any disputes arising from this Agreement shall be resolved in the state or federal courts located in Texas.</div>' +
                    '</div>' +
                    
                    (timeline.notes ? '<div style="background: #f8f9fa; padding: 20px; border: 1px solid #e0e0e0; border-left: 4px solid #D4A574; border-radius: 4px; margin-bottom: 30px;"><div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #D4A574; margin-bottom: 8px;">Additional Notes</div><div style="font-size: 12px; color: #444; line-height: 1.6;">' + timeline.notes + '</div></div>' : '') +
                    
                    // SIGNATURE REMINDER
                    '<div style="background: linear-gradient(135deg, #D4A574 0%, #B88F5F 100%); color: white; padding: 24px; border-radius: 4px; text-align: center; margin-bottom: 40px;">' +
                        '<div style="font-size: 15px; font-weight: 700; margin-bottom: 8px;"> CLIENT SIGNATURE REQUIRED</div>' +
                        '<div style="font-size: 12px; opacity: 0.95; line-height: 1.5;">Please sign and date this SLA in the Client section above. This document becomes legally binding once both parties have signed.</div>' +
                    '</div>' +
                    
                    // FOOTER
                    '<div style="text-align: center; padding-top: 30px; border-top: 2px solid #e0e0e0;">' +
                        '<div style="font-size: 12px; color: #666; margin-bottom: 6px;">Questions about this SLA?</div>' +
                        '<div style="font-size: 11px; color: #999; margin-bottom: 12px;">Contact us at contact@diamondbackcoding.com or (512) 980-0393</div>' +
                        '<div style="font-size: 10px; color: #bbb;">Document ID: ' + documentId + '  Generated: ' + companySignatureDate + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>' +
        '</body>' +
        '</html>';
        
        printWindow.document.write(htmlContent);
        printWindow.document.close();
    }, 300);
}

async function renderTickets() {
    const content = document.getElementById('contentArea');
    
    // Show loading state
    content.innerHTML = '<div style="text-align: center; padding: 40px;">Loading tickets...</div>';
    
    // Load tickets
    await loadTickets();
    
    const filter = state.currentFilter || 'all';
    const filteredTickets = filter === 'all' 
        ? (state.tickets || [])
        : (state.tickets || []).filter(t => t.status === filter);
    
    const statusColors = {
        'open': '#ef4444',
        'in-progress': '#10b981',
        'resolved': '#8b5cf6',
        'closed': '#6b7280'
    };

    const priorityColors = {
        'low': '#6b7280',
        'normal': '#10b981',
        'high': '#f59e0b',
        'urgent': '#ef4444'
    };

    content.innerHTML = `
        <div class="controls-bar">
            <h2 style="font-size: 18px; font-weight: 700; margin: 0;">Support Tickets</h2>
            <div class="filter-group">
                <button class="filter-btn ${filter === 'all' ? 'active' : ''}" onclick="filterTickets('all')">All</button>
                <button class="filter-btn ${filter === 'open' ? 'active' : ''}" onclick="filterTickets('open')">Open</button>
                <button class="filter-btn ${filter === 'in-progress' ? 'active' : ''}" onclick="filterTickets('in-progress')">In Progress</button>
                <button class="filter-btn ${filter === 'resolved' ? 'active' : ''}" onclick="filterTickets('resolved')">Resolved</button>
                <button class="filter-btn ${filter === 'closed' ? 'active' : ''}" onclick="filterTickets('closed')">Closed</button>
            </div>
        </div>
        
        <div class="tickets-grid" style="display: grid; gap: 16px; margin-top: 24px;">
            ${filteredTickets.length > 0 ? filteredTickets.map(ticket => `
                <div class="ticket-card" onclick="openTicketDetail(${ticket.id})" style="cursor: pointer; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 20px; background: var(--bg-primary); transition: all 0.2s ease;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">${ticket.subject}</h3>
                                <span class="status-badge" style="background: ${statusColors[ticket.status]}; color: white; font-size: 11px; padding: 4px 8px; border-radius: 12px;">
                                    ${ticket.status}
                                </span>
                                <span class="status-badge" style="background: ${priorityColors[ticket.priority]}; color: white; font-size: 11px; padding: 4px 8px; border-radius: 12px;">
                                    ${ticket.priority}
                                </span>
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                <strong>${ticket.client_name || 'Unknown Client'}</strong> (${ticket.client_email || 'No email'})
                            </div>
                            <p style="margin: 0; font-size: 14px; color: var(--text-secondary); line-height: 1.5;">
                                ${ticket.message ? ticket.message.substring(0, 150) : 'No message'}${ticket.message && ticket.message.length > 150 ? '...' : ''}
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-muted); padding-top: 12px; border-top: 1px solid var(--border-subtle);">
                        <span>Created: ${formatDate(ticket.created_at)}</span>
                        <span>Responses: ${ticket.response_count || 0}</span>
                        ${ticket.last_response_at ? `<span>Last reply: ${formatDate(ticket.last_response_at)}</span>` : ''}
                    </div>
                </div>
            `).join('') : `
                <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <h3>No tickets found</h3>
                    <p>No support tickets match your filter criteria</p>
                </div>
            `}
        </div>
    `;
}

function filterTickets(status) {
    state.currentFilter = status;
    renderTickets();
}

async function openTicketDetail(ticketId) {
    const ticket = state.tickets.find(t => t.id === ticketId);
    if (!ticket) return;
    
    try {
        // Load responses
        const response = await fetch(`${API_BASE}/api/tickets/${ticketId}/responses`, {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        const data = await response.json();
        const responses = data.responses || [];
        
        const statusColors = {
            'open': 'var(--status-danger)',
            'in-progress': 'var(--status-contacted)',
            'resolved': 'var(--status-success)',
            'closed': 'var(--text-muted)'
        };
        
        showModal('Support Ticket', `
            <div style="max-height: 70vh; overflow-y: auto;">
                <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <h3 style="margin: 0; font-size: 18px;">${ticket.subject}</h3>
                        <span class="status-badge" style="background: ${statusColors[ticket.status]};">
                            ${ticket.status}
                        </span>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                        From: <strong>${ticket.client_name}</strong> (${ticket.client_email})
                    </div>
                    <p style="margin: 0; font-size: 14px; line-height: 1.6;">${ticket.message}</p>
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                        Created: ${formatDate(ticket.created_at)}
                    </div>
                </div>
                
                ${responses.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">
                            Conversation
                        </h4>
                        ${responses.map(resp => `
                            <div style="padding: 12px; background: ${resp.user_type === 'admin' ? 'var(--accent-amber-dim)' : 'var(--bg-hover)'}; border-radius: 8px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <strong style="font-size: 13px;">${resp.user_name}</strong>
                                    <span style="font-size: 11px; color: var(--text-muted);">${formatDate(resp.created_at)}</span>
                                </div>
                                <p style="margin: 0; font-size: 13px; line-height: 1.5;">${resp.message}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div>
                    <textarea id="ticketResponse" placeholder="Type your response..." 
                              style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-primary" onclick="sendTicketResponse(${ticketId})">
                            Send Response
                        </button>
                        
                        ${ticket.status !== 'resolved' ? `
                            <button class="btn btn-success" onclick="updateTicketStatus(${ticketId}, 'resolved')">
                                Mark as Resolved
                            </button>
                        ` : ''}
                        
                        ${ticket.status !== 'closed' ? `
                            <button class="btn btn-secondary" onclick="updateTicketStatus(${ticketId}, 'closed')">
                                Close Ticket
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-danger" onclick="deleteTicket(${ticketId})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Ticket
                        </button>
                    </div>
                </div>
            </div>
        `);
    } catch (error) {
        console.error('Load ticket detail error:', error);
        showToast('Failed to load ticket details', 'error');
    }
}

async function sendTicketResponse(ticketId) {
    const message = document.getElementById('ticketResponse').value.trim();
    
    if (!message) {
        showToast('Please enter a response', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/api/tickets/${ticketId}/responses`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({ message })
        });
        
        if (response.ok) {
            showToast('Response sent successfully', 'success');
            closeModal();
            loadTickets();
        } else {
            const data = await response.json();
            throw new Error(data.message || 'Failed to send response');
        }
    } catch (error) {
        console.error('Send response error:', error);
        showToast('Failed to send response: ' + error.message, 'error');
    }
}

async function updateTicketStatus(ticketId, status) {
    try {
        const response = await fetch(`${API_BASE}/api/tickets/${ticketId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({ status })
        });
        
        if (response.ok) {
            showToast(`Ticket ${status}`, 'success');
            closeModal();
            loadTickets();
        } else {
            const data = await response.json();
            throw new Error(data.message || 'Failed to update status');
        }
    } catch (error) {
        console.error('Update ticket status error:', error);
        showToast('Failed to update ticket status: ' + error.message, 'error');
    }
}

// ==================== PHASE 5: DOCUMENT MANAGEMENT - FRONTEND ====================
// Add these functions to your admin_portal.html <script> section

// Render Documents page
function renderDocuments(content) {
    content.innerHTML = '<div style="text-align: center; padding: 40px;">Loading documents...</div>';
    
    Promise.all([
        fetch(`${API_URL}/api/documents`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json()),
        fetch(`${API_URL}/api/documents/stats`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json())
    ])
    .then(([documentsData, statsData]) => {
        content.innerHTML = `
            <div class="page-header">
                <div>
                    <h2>Document Management</h2>
                    <p class="page-description"></p>
                </div>
                <button class="btn btn-primary" onclick="openUploadDocumentModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload Document
                </button>
            </div>
            
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Total Documents</span>
            <div class="stat-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">${statsData.stats.total_documents || 0}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Storage Used</span>
            <div class="stat-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="5" rx="9" ry="3"/>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">${formatFileSize(statsData.stats.total_size || 0)}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Contracts</span>
            <div class="stat-icon amber">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">${statsData.stats.contracts || 0}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Proposals</span>
            <div class="stat-icon purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">${statsData.stats.proposals || 0}</div>
    </div>
</div>
            
            <!-- Documents Table -->
            <div class="table-container" style="margin-top: 24px;">
                <div style="padding: 20px 18px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 15px; font-weight: 700;">All Documents</h3>
                    <div style="display: flex; gap: 8px;">
                        <select id="docTypeFilter" onchange="filterDocuments(this.value)" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);">
                            <option value="">All Types</option>
                            <option value="contract">Contracts</option>
                            <option value="proposal">Proposals</option>
                            <option value="invoice">Invoices</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                </div>
                <table class="data-table" id="documentsTable">
                    <thead>
                        <tr>
                            <th>Document</th>
                            <th>Type</th>
                            <th>Lead</th>
                            <th>Size</th>
                            <th>Uploaded By</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${documentsData.documents && documentsData.documents.length > 0 ? documentsData.documents.map(doc => `
                            <tr data-doc-type="${doc.document_type || 'general'}">
                                <td>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 32px; height: 32px; border-radius: 6px; background: var(--bg-hover); display: flex; align-items: center; justify-content: center;">
                                            ${getFileIconSVG(doc.mime_type)}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600;">${doc.original_filename}</div>
                                            ${doc.description ? `<div style="font-size: 11px; color: var(--text-muted);">${doc.description}</div>` : ''}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-${doc.document_type || 'general'}">
                                        ${doc.document_type || 'General'}
                                    </span>
                                </td>
                                <td>${doc.lead_name || '-'}</td>
                                <td>${formatFileSize(doc.file_size)}</td>
                                <td>${doc.uploaded_by_name || 'Unknown'}</td>
                                <td>${new Date(doc.created_at).toLocaleDateString()}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-icon" onclick="downloadDocument(${doc.id}, '${doc.original_filename}')" title="Download">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                <polyline points="7 10 12 15 17 10"/>
                                                <line x1="12" y1="15" x2="12" y2="3"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon" onclick="shareDocument(${doc.id})" title="Share">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="18" cy="5" r="3"/>
                                                <circle cx="6" cy="12" r="3"/>
                                                <circle cx="18" cy="19" r="3"/>
                                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon" onclick="viewDocumentVersions(${doc.id})" title="Versions">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <polyline points="12 6 12 12 16 14"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon" onclick="editDocument(${doc.id})" title="Edit">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon danger" onclick="deleteDocument(${doc.id})" title="Delete">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('') : `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    No documents yet. Upload your first document to get started.
                                </td>
                            </tr>
                        `}
                    </tbody>
                </table>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error loading documents:', error);
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: red;">Error loading documents</div>';
    });
}

// Helper functions
function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIconSVG(mimeType) {
    if (!mimeType) {
        return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
        </svg>`;
    }
    if (mimeType.includes('pdf')) {
        return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>`;
    }
    if (mimeType.includes('word')) {
        return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
        </svg>`;
    }
    if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) {
        return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 3v18h18V3H3z"/>
            <path d="M3 9h18M3 15h18M9 3v18"/>
        </svg>`;
    }
    if (mimeType.includes('image')) {
        return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
        </svg>`;
    }
    if (mimeType.includes('text')) {
        return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>`;
    }
    return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
    </svg>`;
}

function filterDocuments(type) {
    const rows = document.querySelectorAll('#documentsTable tbody tr');
    rows.forEach(row => {
        const docType = row.getAttribute('data-doc-type');
        if (!type || docType === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Open upload document modal
async function openUploadDocumentModal() {
    // Load leads and customers for dropdown
    const leadsRes = await fetch(`${API_URL}/api/leads`, {
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    const leadsData = await leadsRes.json();
    
    // Combine leads and customers
    const allLeadsAndCustomers = leadsData.leads || [];
    
    const modalContent = `
        <h3>Upload Document</h3>
        <form id="uploadDocumentForm" onsubmit="uploadDocument(event)">
            <div class="form-group">
                <label>Select File *</label>
                <input type="file" name="file" id="fileInput" required multiple
                       accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.txt">
                <small>Max file size: 50MB per file. Allowed: PDF, DOC, DOCX, XLS, XLSX, images, TXT. You can select multiple files.</small>
            </div>
            
            <div class="form-group">
                <label>Document Type *</label>
                <select name="document_type" required>
                    <option value="general">General</option>
                    <option value="contract">Contract</option>
                    <option value="proposal">Proposal</option>
                    <option value="invoice">Invoice</option>
                    <option value="presentation">Presentation</option>
                    <option value="report">Report</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Assign to Lead/Customer</label>
                <select name="lead_id" id="leadCustomerSelect">
                    <option value="">No assignment (general document)</option>
                    <optgroup label="Customers">
                        ${allLeadsAndCustomers.filter(l => l.is_customer).map(customer => `
                            <option value="${customer.id}">${customer.name} - ${customer.company || 'No company'}</option>
                        `).join('')}
                    </optgroup>
                    <optgroup label="Leads">
                        ${allLeadsAndCustomers.filter(l => !l.is_customer).map(lead => `
                            <option value="${lead.id}">${lead.name} - ${lead.company || 'No company'}</option>
                        `).join('')}
                    </optgroup>
                </select>
                <small>Documents assigned to a lead/customer will appear in their Documents section</small>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" rows="3" placeholder="Optional description of this document"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload Document(s)</button>
            </div>
        </form>
    `;
    
    showModal(modalContent);
}

// Upload document
async function uploadDocument(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    try {
        showToast('Uploading document...', 'info');
        
        const response = await fetch(`${API_URL}/api/documents/upload`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Document uploaded successfully!', 'success');
            closeModal();
            navigateTo('documents');
        } else {
            showToast(data.message || 'Error uploading document', 'error');
        }
    } catch (error) {
        console.error('Upload error:', error);
        showToast('Error uploading document', 'error');
    }
}

// Download document
async function downloadDocument(documentId, filename) {
    try {
        const response = await fetch(`${API_URL}/api/documents/${documentId}/download`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) {
            throw new Error('Download failed');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast('Document downloaded', 'success');
    } catch (error) {
        console.error('Download error:', error);
        showToast('Error downloading document', 'error');
    }
}

// Share document
async function shareDocument(documentId) {
    const modalContent = `
        <h3>Share Document</h3>
        <form id="shareDocumentForm" onsubmit="createShareLink(event, ${documentId})">
            <div class="form-group">
                <label>Share with Email (optional)</label>
                <input type="email" name="email" placeholder="recipient@example.com">
            </div>
            
            <div class="form-group">
                <label>Link expires in</label>
                <select name="expires_in_days">
                    <option value="1">1 day</option>
                    <option value="7" selected>7 days</option>
                    <option value="30">30 days</option>
                    <option value="365">1 year</option>
                </select>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Share Link</button>
            </div>
        </form>
    `;
    
    showModal(modalContent);
}

// Create share link
async function createShareLink(event, documentId) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        email: formData.get('email') || null,
        expires_in_days: parseInt(formData.get('expires_in_days'))
    };
    
    try {
        const response = await fetch(`${API_URL}/api/documents/${documentId}/share`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeModal();
            
            // Show share link modal
            const linkModalContent = `
                <h3>Share Link Created</h3>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Share URL:</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="shareUrlInput" value="${result.share_url}" 
                               readonly style="flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 12px;">
                        <button class="btn btn-primary" onclick="copyShareUrl()">Copy</button>
                    </div>
                    <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                        This link will expire on ${new Date(result.share.expires_at).toLocaleDateString()}
                    </small>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;
            
            showModal(linkModalContent);
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        console.error('Create share link error:', error);
        showToast('Error creating share link', 'error');
    }
}

// Copy share URL to clipboard
function copyShareUrl() {
    const input = document.getElementById('shareUrlInput');
    input.select();
    document.execCommand('copy');
    showToast('Link copied to clipboard!', 'success');
}

// View document versions
async function viewDocumentVersions(documentId) {
    try {
        const response = await fetch(`${API_URL}/api/documents/${documentId}/versions`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const modalContent = `
                <h3>Document Versions</h3>
                <div style="margin: 20px 0;">
                    ${data.versions && data.versions.length > 0 ? data.versions.map(version => `
                        <div style="padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">Version ${version.version_number}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    ${new Date(version.created_at).toLocaleString()} by ${version.uploaded_by_name}
                                </div>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: var(--text-muted);">${formatFileSize(version.file_size)}</span>
                            </div>
                        </div>
                    `).join('') : '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No previous versions</div>'}
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    <button class="btn btn-primary" onclick="uploadNewVersion(${documentId})">Upload New Version</button>
                </div>
            `;
            
            showModal(modalContent);
        }
    } catch (error) {
        console.error('View versions error:', error);
        showToast('Error loading versions', 'error');
    }
}

// Edit document metadata
async function editDocument(documentId) {
    // Load document details first
    const response = await fetch(`${API_URL}/api/documents`, {
        headers: { 'Authorization': `Bearer ${authToken}` }
    });
    const data = await response.json();
    const doc = data.documents.find(d => d.id === documentId);
    
    if (!doc) return;
    
    const modalContent = `
        <h3>Edit Document</h3>
        <form id="editDocumentForm" onsubmit="saveDocumentEdit(event, ${documentId})">
            <div class="form-group">
                <label>Document Type</label>
                <select name="document_type">
                    <option value="general" ${doc.document_type === 'general' ? 'selected' : ''}>General</option>
                    <option value="contract" ${doc.document_type === 'contract' ? 'selected' : ''}>Contract</option>
                    <option value="proposal" ${doc.document_type === 'proposal' ? 'selected' : ''}>Proposal</option>
                    <option value="invoice" ${doc.document_type === 'invoice' ? 'selected' : ''}>Invoice</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" rows="3">${doc.description || ''}</textarea>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="is_shared" ${doc.is_shared ? 'checked' : ''}>
                    <span>Mark as shared with client</span>
                </label>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    `;
    
    showModal(modalContent);
}

// Save document edit
async function saveDocumentEdit(event, documentId) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        document_type: formData.get('document_type'),
        description: formData.get('description'),
        is_shared: formData.get('is_shared') === 'on'
    };
    
    try {
        const response = await fetch(`${API_URL}/api/documents/${documentId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Document updated successfully', 'success');
            closeModal();
            navigateTo('documents');
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        console.error('Update document error:', error);
        showToast('Error updating document', 'error');
    }
}

// Delete document
async function deleteDocument(documentId) {
    if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`${API_URL}/api/documents/${documentId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Document deleted successfully', 'success');
            navigateTo('documents');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Delete document error:', error);
        showToast('Error deleting document', 'error');
    }
}

// Render Sales Pipeline page
function renderPipeline(content) {
    content.innerHTML = '<div style="text-align: center; padding: 40px;">Loading pipeline...</div>';
    
    Promise.all([
        fetch(`${API_URL}/api/pipeline/stages`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json()),
        fetch(`${API_URL}/api/pipeline/deals`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json()),
        fetch(`${API_URL}/api/pipeline/stats`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json())
    ])
    .then(([stagesData, dealsData, statsData]) => {
        content.innerHTML = `
            <div class="page-header">
                <div>
                    <h2>Sales Pipeline</h2>
                    <p class="page-description"></p>
                </div>
                <button class="btn btn-primary" onclick="openCreateDealModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    New Deal
                </button>
            </div>
            
            <!-- Pipeline Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Total Deals</span>
            <div class="stat-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">${statsData.stats.total_deals || 0}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Pipeline Value</span>
            <div class="stat-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">$${parseFloat(statsData.stats.total_value || 0).toLocaleString()}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Weighted Value</span>
            <div class="stat-icon amber">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">$${parseFloat(statsData.stats.weighted_value || 0).toLocaleString()}</div>
        <div class="stat-change">Based on probability</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Win Rate</span>
            <div class="stat-icon purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="8" r="7"/>
                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">
            ${statsData.stats.won_deals && statsData.stats.total_deals ? 
                ((statsData.stats.won_deals / statsData.stats.total_deals) * 100).toFixed(1) : 0}%
        </div>
        <div class="stat-change">${statsData.stats.won_deals || 0} won / ${statsData.stats.lost_deals || 0} lost</div>
    </div>
</div>
            
            <!-- Kanban Board -->
            <div class="kanban-board" style="margin-top: 24px;">
                ${stagesData.stages.map(stage => {
                    const stageDeals = dealsData.deals.filter(d => d.stage_id === stage.id);
                    const stageTotalValue = stageDeals.reduce((sum, d) => sum + parseFloat(d.value || 0), 0);
                    
                    return `
                        <div class="kanban-column" data-stage-id="${stage.id}">
                            <div class="kanban-column-header" style="border-bottom: 3px solid ${stage.color}">
                                <div>
                                    <h3 style="font-size: 14px; font-weight: 700; margin: 0;">${stage.name}</h3>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                        ${stageDeals.length} deals  $${stageTotalValue.toLocaleString()}
                                    </div>
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    ${stage.probability}% prob
                                </div>
                            </div>
                            
                            <div class="kanban-cards" 
                                 ondragover="handleDragOver(event)" 
                                 ondrop="handleDrop(event, ${stage.id})"
                                 data-stage-id="${stage.id}">
                                ${stageDeals.length > 0 ? stageDeals.map(deal => `
                                    <div class="kanban-card" 
                                         draggable="true" 
                                         ondragstart="handleDragStart(event, ${deal.id})"
                                         ondragend="handleDragEnd(event)"
                                         data-deal-id="${deal.id}">
                                        <div class="kanban-card-header">
                                            <div style="font-weight: 600; font-size: 13px;">${deal.title}</div>
                                            <button class="card-menu-btn" onclick="openDealMenu(event, ${deal.id})">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="1"/>
                                                    <circle cx="12" cy="5" r="1"/>
                                                    <circle cx="12" cy="19" r="1"/>
                                                </svg>
                                            </button>
                                        </div>
                                        
                                        <div style="margin: 8px 0;">
                                            <div style="font-size: 11px; color: var(--text-muted);">
                                                ${deal.lead_name || 'No lead'}
                                                ${deal.lead_company ? `  ${deal.lead_company}` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="kanban-card-footer">
                                            <div style="font-weight: 700; color: var(--status-contacted); font-family: var(--font-mono);">
                                                $${parseFloat(deal.value || 0).toLocaleString()}
                                            </div>
                                            ${deal.expected_close_date ? `
                                                <div style="font-size: 11px; color: var(--text-muted);">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
    <line x1="16" y1="2" x2="16" y2="6"/>
    <line x1="8" y1="2" x2="8" y2="6"/>
    <line x1="3" y1="10" x2="21" y2="10"/>
</svg> ${new Date(deal.expected_close_date).toLocaleDateString()}
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        ${deal.assigned_to_name ? `
                                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-subtle); font-size: 11px; color: var(--text-muted);">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
    <circle cx="12" cy="7" r="4"/>
</svg> ${deal.assigned_to_name}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('') : `
                                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">
                                        No deals in this stage
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        // Add kanban board styles if not already present
        if (!document.getElementById('kanban-styles')) {
            const style = document.createElement('style');
            style.id = 'kanban-styles';
            style.textContent = `
                .kanban-board {
                    display: flex;
                    gap: 16px;
                    overflow-x: auto;
                    padding: 16px;
                    background: var(--bg-secondary);
                    border-radius: 12px;
                }
                
                .kanban-column {
                    flex: 0 0 300px;
                    background: var(--bg);
                    border-radius: 12px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                
                .kanban-column-header {
                    padding: 16px;
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                }
                
                .kanban-cards {
                    padding: 8px;
                    min-height: 200px;
                }
                
                .kanban-card {
                    background: var(--bg);
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 8px;
                    cursor: move;
                    transition: all 0.2s;
                }
                
                .kanban-card:hover {
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    transform: translateY(-2px);
                }
                
                .kanban-card.dragging {
                    opacity: 0.5;
                }
                
                .kanban-card-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                }
                
                .card-menu-btn {
                    background: none;
                    border: none;
                    cursor: pointer;
                    padding: 4px;
                    border-radius: 4px;
                    color: var(--text-muted);
                }
                
                .card-menu-btn:hover {
                    background: var(--bg-hover);
                }
                
                .kanban-card-footer {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 8px;
                }
            `;
            document.head.appendChild(style);
        }
    })
    .catch(error => {
        console.error('Error loading pipeline:', error);
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: red;">Error loading pipeline</div>';
    });
}

// Drag and drop handlers
let draggedDealId = null;

function handleDragStart(event, dealId) {
    draggedDealId = dealId;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(event) {
    event.target.classList.remove('dragging');
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
}

async function handleDrop(event, stageId) {
    event.preventDefault();
    
    if (!draggedDealId) return;
    
    try {
        const response = await fetch(`${API_URL}/api/pipeline/deals/${draggedDealId}/move`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ stage_id: stageId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Deal moved successfully', 'success');
            navigateTo('pipeline');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Move deal error:', error);
        showToast('Error moving deal', 'error');
    }
    
    draggedDealId = null;
}

// Open create deal modal
async function openCreateDealModal() {
    const [stagesRes, leadsRes, usersRes] = await Promise.all([
        fetch(`${API_URL}/api/pipeline/stages`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }),
        fetch(`${API_URL}/api/leads`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }),
        fetch(`${API_URL}/api/employees`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        })
    ]);
    
    const stagesData = await stagesRes.json();
    const leadsData = await leadsRes.json();
    const usersData = await usersRes.json();
    
    const modalContent = `
        <h3>Create New Deal</h3>
        <form id="createDealForm" onsubmit="saveDeal(event)">
            <div class="form-group">
                <label>Deal Title *</label>
                <input type="text" name="title" required placeholder="e.g., Acme Corp - Enterprise License">
            </div>
            
            <div class="form-group">
                <label>Associated Lead *</label>
                <select name="lead_id" required>
                    <option value="">Select a lead...</option>
                    ${leadsData.leads.map(lead => `
                        <option value="${lead.id}">${lead.name} - ${lead.company || 'No company'}</option>
                    `).join('')}
                </select>
            </div>
            
            <div class="form-group">
                <label>Pipeline Stage *</label>
                <select name="stage_id" required>
                    ${stagesData.stages.map(stage => `
                        <option value="${stage.id}">${stage.name}</option>
                    `).join('')}
                </select>
            </div>
            
            <div class="form-group">
                <label>Deal Value *</label>
                <input type="number" name="value" required min="0" step="0.01" placeholder="0.00">
            </div>
            
            <div class="form-group">
                <label>Expected Close Date</label>
                <input type="date" name="expected_close_date">
            </div>
            
            <div class="form-group">
                <label>Probability (%)</label>
                <input type="number" name="probability" min="0" max="100" value="50">
            </div>
            
            <div class="form-group">
                <label>Assign To</label>
                <select name="assigned_to">
                    <option value="">Unassigned</option>
                    ${usersData.employees ? usersData.employees.map(user => `
                        <option value="${user.id}">${user.name}</option>
                    `).join('') : ''}
                </select>
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" rows="3" placeholder="Additional notes about this deal..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Deal</button>
            </div>
        </form>
    `;
    
    showModal(modalContent);
}

// Save deal
async function saveDeal(event, dealId = null) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        lead_id: parseInt(formData.get('lead_id')),
        stage_id: parseInt(formData.get('stage_id')),
        title: formData.get('title'),
        value: parseFloat(formData.get('value')),
        expected_close_date: formData.get('expected_close_date') || null,
        probability: parseInt(formData.get('probability')) || 50,
        notes: formData.get('notes') || null,
        assigned_to: formData.get('assigned_to') ? parseInt(formData.get('assigned_to')) : null
    };
    
    try {
        const response = await fetch(`${API_URL}/api/pipeline/deals${dealId ? '/' + dealId : ''}`, {
            method: dealId ? 'PUT' : 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            closeModal();
            navigateTo('pipeline');
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        console.error('Save deal error:', error);
        showToast('Error saving deal', 'error');
    }
}

// Open deal menu
function openDealMenu(event, dealId) {
    event.stopPropagation();
    
    const menuContent = `
        <div style="padding: 8px;">
            <button class="menu-item" onclick="viewDealDetails(${dealId})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                View Details
            </button>
            <button class="menu-item" onclick="editDeal(${dealId})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit Deal
            </button>
            <button class="menu-item" onclick="addDealNote(${dealId})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                Add Note
            </button>
            <button class="menu-item danger" onclick="deleteDeal(${dealId})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete Deal
            </button>
        </div>
    `;
    
    // Create and position popup menu (simplified - you can enhance this)
    const existingMenu = document.getElementById('deal-menu');
    if (existingMenu) existingMenu.remove();
    
    const menu = document.createElement('div');
    menu.id = 'deal-menu';
    menu.innerHTML = menuContent;
    menu.style.cssText = `
        position: fixed;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
    `;
    
    const rect = event.target.getBoundingClientRect();
    menu.style.left = rect.left + 'px';
    menu.style.top = (rect.bottom + 5) + 'px';
    
    document.body.appendChild(menu);
    
    // Close menu when clicking outside
    setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        });
    }, 100);
}

// View deal details
async function viewDealDetails(dealId) {
    try {
        const [dealRes, activitiesRes] = await Promise.all([
            fetch(`${API_URL}/api/pipeline/deals`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            }),
            fetch(`${API_URL}/api/pipeline/deals/${dealId}/activities`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
        ]);
        
        const dealsData = await dealRes.json();
        const activitiesData = await activitiesRes.json();
        const deal = dealsData.deals.find(d => d.id === dealId);
        
        if (!deal) {
            showToast('Deal not found', 'error');
            return;
        }
        
        const modalContent = `
            <h3>${deal.title}</h3>
            
            <div style="margin: 20px 0;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                    <div>
                        <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">LEAD</label>
                        <div style="font-weight: 600;">${deal.lead_name}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">${deal.lead_company || ''}</div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">VALUE</label>
                        <div style="font-weight: 700; font-size: 18px; color: var(--status-contacted);">
                            $${parseFloat(deal.value).toLocaleString()}
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">STAGE</label>
                        <span class="badge" style="background: ${deal.stage_color}; color: white;">
                            ${deal.stage_name}
                        </span>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">CLOSE DATE</label>
                        <div>${deal.expected_close_date ? new Date(deal.expected_close_date).toLocaleDateString() : 'Not set'}</div>
                    </div>
                </div>
                
                ${deal.notes ? `
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">NOTES</label>
                        <div style="padding: 12px; background: var(--bg-hover); border-radius: 8px; font-size: 13px;">
                            ${deal.notes}
                        </div>
                    </div>
                ` : ''}
                
                <div>
                    <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 8px;">ACTIVITY TIMELINE</label>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${activitiesData.activities && activitiesData.activities.length > 0 ? activitiesData.activities.map(activity => `
                            <div style="padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 13px; font-weight: 600;">${activity.activity_type}</div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">
                                        ${activity.description}
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                        by ${activity.created_by_name}  ${new Date(activity.created_at).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No activity yet</div>'}
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="closeModal(); editDeal(${dealId})">Edit Deal</button>
            </div>
        `;
        
        showModal(modalContent);
    } catch (error) {
        console.error('View deal details error:', error);
        showToast('Error loading deal details', 'error');
    }
}

// Edit deal
async function editDeal(dealId) {
    // Load deal data and show edit modal (similar to create but with data pre-filled)
    // Implementation similar to openCreateDealModal but with existing data
    showToast('Edit functionality - implement similar to create modal with pre-filled data', 'info');
}

// Add note to deal
async function addDealNote(dealId) {
    const modalContent = `
        <h3>Add Note</h3>
        <form id="addNoteForm" onsubmit="saveNote(event, ${dealId})">
            <div class="form-group">
                <label>Note</label>
                <textarea name="note" rows="5" required placeholder="Enter your note..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Note</button>
            </div>
        </form>
    `;
    
    showModal(modalContent);
}

// Save note
async function saveNote(event, dealId) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch(`${API_URL}/api/pipeline/deals/${dealId}/note`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ note: formData.get('note') })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Note added successfully', 'success');
            closeModal();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Add note error:', error);
        showToast('Error adding note', 'error');
    }
}

// Delete deal
async function deleteDeal(dealId) {
    if (!confirm('Are you sure you want to delete this deal?')) return;
    
    try {
        const response = await fetch(`${API_URL}/api/pipeline/deals/${dealId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Deal deleted successfully', 'success');
            navigateTo('pipeline');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Delete deal error:', error);
        showToast('Error deleting deal', 'error');
    }
}

// Add this navigation item to your sidebar:
/*
<a href="#pipeline" class="nav-link" onclick="navigateTo('pipeline')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7"/>
        <rect x="14" y="3" width="7" height="7"/>
        <rect x="14" y="14" width="7" height="7"/>
        <rect x="3" y="14" width="7" height="7"/>
    </svg>
    <span>Sales Pipeline</span>
</a>
*/

// Add this case to your navigateTo function:
/*
case 'pipeline':
    renderPipeline(content);
    break;
*/

// Add menu item styles:
/*
<style>
.menu-item {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 10px 16px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    font-size: 13px;
    border-radius: 6px;
}

.menu-item:hover {
    background: var(--bg-hover);
}

.menu-item.danger {
    color: var(--status-lost);
}

.menu-item.danger:hover {
    background: rgba(239, 68, 68, 0.1);
}
</style>
*/

// ==================== PHASE 4: LEAD SCORING SYSTEM - FRONTEND ====================
// Add these functions to your admin_portal.html <script> section

// Render Lead Scoring page
function renderLeadScoring(content) {
    content.innerHTML = '<div style="text-align: center; padding: 40px;">Loading lead scores...</div>';
    
    Promise.all([
        fetch(`${API_URL}/api/scoring/leaderboard?limit=100`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json()),
        fetch(`${API_URL}/api/scoring/stats`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        }).then(r => r.json())
    ])
    .then(([leaderboardData, statsData]) => {
        content.innerHTML = `
            <div class="page-header">
                <div>
                    <h2>Lead Scoring</h2>
                    <p class="page-description"></p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="navigateTo('scoring-rules')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6m5.196-15.804l-4.243 4.242m-6.364 6.364l-4.243 4.242m15.804 0l-4.242-4.242m-6.364-6.364l-4.242-4.242"/>
                        </svg>
                        Manage Rules
                    </button>
                    <button class="btn btn-primary" onclick="recalculateAllScores()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <polyline points="1 20 1 14 7 14"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                        Recalculate All
                    </button>
                </div>
            </div>
            
            <!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Total Leads Scored</span>
            <div class="stat-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/>
                    <path d="M18 17V9"/>
                    <path d="M13 17V5"/>
                    <path d="M8 17v-3"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">${statsData.stats.total_leads || 0}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Average Score</span>
            <div class="stat-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">${statsData.stats.avg_score || 0}</div>
        <div class="stat-change">Out of ${statsData.stats.max_score || 0} max</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">A-Grade Leads</span>
            <div class="stat-icon amber">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
            </div>
        </div>
        <div class="stat-value">${statsData.stats.grade_a_count || 0}</div>
        <div class="stat-change">${((statsData.stats.grade_a_count / statsData.stats.total_leads) * 100 || 0).toFixed(1)}% of total</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Grade Distribution</span>
            <div class="stat-icon purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10"/>
                    <line x1="18" y1="20" x2="18" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="16"/>
                </svg>
            </div>
        </div>
        <div style="font-size: 12px; margin-top: 8px;">
            A: ${statsData.stats.grade_a_count || 0} | 
            B: ${statsData.stats.grade_b_count || 0} | 
            C: ${statsData.stats.grade_c_count || 0} | 
            D: ${statsData.stats.grade_d_count || 0} | 
            F: ${statsData.stats.grade_f_count || 0}
        </div>
    </div>
</div>
            
            <!-- Leaderboard -->
            <div class="table-container" style="margin-top: 24px;">
                <div style="padding: 20px 18px; border-bottom: 1px solid var(--border-subtle);">
                    <h3 style="font-size: 15px; font-weight: 700;">Lead Score Leaderboard</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Lead</th>
                            <th>Company</th>
                            <th>Grade</th>
                            <th>Total Score</th>
                            <th>Engagement</th>
                            <th>Demographic</th>
                            <th>Behavioral</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${leaderboardData.leaderboard && leaderboardData.leaderboard.length > 0 ? leaderboardData.leaderboard.map(lead => `
                            <tr>
                                <td>
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: ${
                                        lead.rank === 1 ? '#fbbf24' :
                                        lead.rank === 2 ? '#d1d5db' :
                                        lead.rank === 3 ? '#f97316' : 'var(--bg-hover)'
                                    }; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                                        ${lead.rank}
                                    </div>
                                </td>
                                <td>
                                    <div class="contact-cell">
                                        <div class="contact-avatar">${getInitials(lead.name)}</div>
                                        <div>
                                            <div class="contact-name">${lead.name}</div>
                                            <div class="contact-email">${lead.email}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>${lead.company || '-'}</td>
                                <td>
                                    <span class="grade-badge grade-${lead.grade}">
                                        ${lead.grade}
                                    </span>
                                </td>
                                <td>
                                    <strong style="font-family: var(--font-mono); font-size: 16px;">
                                        ${lead.total_score}
                                    </strong>
                                </td>
                                <td>${lead.engagement_score}</td>
                                <td>${lead.demographic_score}</td>
                                <td>${lead.behavioral_score}</td>
                                <td>
                                    <span class="status-badge status-${lead.status}">
                                        ${lead.status}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-icon" onclick="viewScoreHistory(${lead.lead_id})" title="View History">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <polyline points="12 6 12 12 16 14"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon" onclick="recalculateScore(${lead.lead_id})" title="Recalculate">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="23 4 23 10 17 10"/>
                                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('') : `
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    No scored leads yet. Click "Recalculate All" to score your leads.
                                </td>
                            </tr>
                        `}
                    </tbody>
                </table>
            </div>
        `;
        
        // Add grade badge styles if not already present
        if (!document.getElementById('grade-badge-styles')) {
            const style = document.createElement('style');
            style.id = 'grade-badge-styles';
            style.textContent = `
                .grade-badge {
                    display: inline-block;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    text-align: center;
                    line-height: 32px;
                    font-weight: 700;
                    font-size: 16px;
                }
                .grade-A { background: #10b981; color: white; }
                .grade-B { background: #3b82f6; color: white; }
                .grade-C { background: #f59e0b; color: white; }
                .grade-D { background: #ef4444; color: white; }
                .grade-F { background: #6b7280; color: white; }
            `;
            document.head.appendChild(style);
        }
    })
    .catch(error => {
        console.error('Error loading lead scoring:', error);
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: red;">Error loading lead scoring</div>';
    });
}



// Update the getFollowUpLabel function
function getFollowUpLabel(step) {
    const labels = {
        0: 'Initial Contact (Day 1)',
        1: 'Follow-Up 1 (Day 3)',
        2: 'Follow-Up 2 (Day 7)',
        3: 'Follow-Up 3 (Day 8)',
        4: 'Follow-Up 4 (Day 10)',
        5: 'Follow-Up 5 (Day 15)',
        6: 'Weekly Follow-Up (Every 7 Days)'
    };
    return labels[step] || 'Follow-Up Required';
}

// Render Scoring Rules page
function renderScoringRules(content) {
    content.innerHTML = '<div style="text-align: center; padding: 40px;">Loading scoring rules...</div>';
    
    fetch(`${API_URL}/api/scoring/rules`, {
        headers: { 'Authorization': `Bearer ${authToken}` }
    })
    .then(r => r.json())
    .then(data => {
        content.innerHTML = `
            <div class="page-header">
                <div>
                    <h2>Scoring Rules</h2>
                    <p class="page-description"></p>
                </div>
                <button class="btn btn-primary" onclick="openScoringRuleModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    New Rule
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Rule Name</th>
                            <th>Type</th>
                            <th>Condition</th>
                            <th>Points</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.rules && data.rules.length > 0 ? data.rules.map(rule => `
                            <tr>
                                <td>
                                    <div style="font-weight: 600;">${rule.name}</div>
                                    ${rule.description ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${rule.description}</div>` : ''}
                                </td>
                                <td>
                                    <span class="badge badge-${rule.rule_type}">
                                        ${rule.rule_type.charAt(0).toUpperCase() + rule.rule_type.slice(1)}
                                    </span>
                                </td>
                                <td>
                                    <code style="font-size: 11px; background: var(--bg-hover); padding: 4px 8px; border-radius: 4px;">
                                        ${rule.field_name} ${rule.operator} ${rule.value || ''}
                                    </code>
                                </td>
                                <td>
                                    <strong style="color: var(--status-contacted); font-family: var(--font-mono);">
                                        +${rule.points}
                                    </strong>
                                </td>
                                <td>
                                    <span class="status-badge ${rule.is_active ? 'status-contacted' : 'status-lost'}">
                                        ${rule.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-icon" onclick="editScoringRule(${rule.id})" title="Edit">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon danger" onclick="deleteScoringRule(${rule.id})" title="Delete">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('') : `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    No scoring rules yet. Create your first rule to start scoring leads.
                                </td>
                            </tr>
                        `}
                    </tbody>
                </table>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error loading scoring rules:', error);
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: red;">Error loading scoring rules</div>';
    });
}

// Open scoring rule modal
function openScoringRuleModal(ruleId = null) {
    // For simplicity, this will be a basic form - you can enhance it
    const modalContent = `
        <h3>${ruleId ? 'Edit Scoring Rule' : 'Create Scoring Rule'}</h3>
        <form id="scoringRuleForm" onsubmit="saveScoringRule(event, ${ruleId})">
            <div class="form-group">
                <label>Rule Name *</label>
                <input type="text" name="name" required placeholder="e.g., Email Opened">
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" rows="2" placeholder="Brief description of this rule"></textarea>
            </div>
            
            <div class="form-group">
                <label>Rule Type *</label>
                <select name="rule_type" required>
                    <option value="engagement">Engagement</option>
                    <option value="demographic">Demographic</option>
                    <option value="behavioral">Behavioral</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Field Name *</label>
                <input type="text" name="field_name" required placeholder="e.g., email_opened, lifetime_value">
            </div>
            
            <div class="form-group">
                <label>Operator *</label>
                <select name="operator" required>
                    <option value="equals">Equals</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="greater_than">Greater Than</option>
                    <option value="less_than">Less Than</option>
                    <option value="contains">Contains</option>
                    <option value="is_not_null">Is Not Null</option>
                    <option value="is_null">Is Null</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Value</label>
                <input type="text" name="value" placeholder="Comparison value (leave blank for null checks)">
            </div>
            
            <div class="form-group">
                <label>Points *</label>
                <input type="number" name="points" required min="0" placeholder="e.g., 10">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    ${ruleId ? 'Update Rule' : 'Create Rule'}
                </button>
            </div>
        </form>
    `;
    
    showModal(modalContent);
}

// Add this function near the bottom of your <script> section:

function copyPaymentLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        showToast('Payment link copied to clipboard!', 'success');
    }).catch(() => {
        showToast('Failed to copy link', 'error');
    });
}

// Modal helper functions
function showModal(titleOrContent, optionalContent) {
    const modal = document.getElementById('createModal');
    const titleEl = document.getElementById('createModalTitle');
    const bodyEl = document.getElementById('createModalBody');
    
    // Check if this is a two-parameter call (title, content) or one-parameter call (content only)
    if (optionalContent !== undefined) {
        // Two parameters: first is title, second is content
        titleEl.textContent = titleOrContent;
        bodyEl.innerHTML = optionalContent;
    } else {
        // One parameter: it's just content, keep default title
        bodyEl.innerHTML = titleOrContent;
    }
    
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('createModal').classList.remove('active');
}

// Navigation helper
function navigateTo(section) {
    state.currentSection = section;
    renderSection(section);
    
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.dataset.section === section) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

// Save scoring rule
async function saveScoringRule(event, ruleId) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        rule_type: formData.get('rule_type'),
        field_name: formData.get('field_name'),
        operator: formData.get('operator'),
        value: formData.get('value'),
        points: parseInt(formData.get('points'))
    };
    
    try {
        const response = await fetch(`${API_URL}/api/scoring/rules${ruleId ? '/' + ruleId : ''}`, {
            method: ruleId ? 'PUT' : 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            closeModal();
            navigateTo('scoring-rules');
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        console.error('Save scoring rule error:', error);
        showToast('Error saving scoring rule', 'error');
    }
}

// Delete scoring rule
async function deleteScoringRule(ruleId) {
    if (!confirm('Are you sure you want to delete this scoring rule?')) return;
    
    try {
        const response = await fetch(`${API_URL}/api/scoring/rules/${ruleId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Scoring rule deleted successfully', 'success');
            navigateTo('scoring-rules');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Delete scoring rule error:', error);
        showToast('Error deleting scoring rule', 'error');
    }
}

// Recalculate single lead score
async function recalculateScore(leadId) {
    try {
        showToast('Calculating score...', 'info');
        
        const response = await fetch(`${API_URL}/api/scoring/calculate/${leadId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`Score calculated: ${data.score.totalScore} (Grade ${data.score.grade})`, 'success');
            navigateTo('lead-scoring');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Recalculate score error:', error);
        showToast('Error calculating score', 'error');
    }
}

// Recalculate all lead scores
async function recalculateAllScores() {
    if (!confirm('This will recalculate scores for all leads. This may take a while. Continue?')) return;
    
    try {
        showToast('Recalculating all scores...', 'info');
        
        const response = await fetch(`${API_URL}/api/scoring/recalculate-all`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            navigateTo('lead-scoring');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Recalculate all scores error:', error);
        showToast('Error recalculating scores', 'error');
    }
}

// View score history
async function viewScoreHistory(leadId) {
    try {
        const response = await fetch(`${API_URL}/api/scoring/history/${leadId}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const modalContent = `
                <h3>Score History</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${data.history && data.history.length > 0 ? data.history.map(item => `
                        <div style="padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                            <div>
                                <div style="font-weight: 600;">${item.rule_name || item.reason}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    ${new Date(item.created_at).toLocaleString()}
                                </div>
                            </div>
                            <div style="font-weight: 700; color: var(--status-contacted); font-family: var(--font-mono);">
                                +${item.points_added}
                            </div>
                        </div>
                    `).join('') : '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No score history</div>'}
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;
            
            showModal(modalContent);
        }
    } catch (error) {
        console.error('View score history error:', error);
        showToast('Error loading score history', 'error');
    }
}

function renderLeadsTable(content, type) {
    const data = type === 'customers' ? state.customers : state.leads;
    const filtered = filterLeads(data);
    
    content.innerHTML = `
        <div class="controls-bar">
            <!-- search and filters -->
        </div>
        <div class="table-container">
            ${renderLeadsTableHTML(filtered)}
        </div>
    `;
}

function renderEmployees(content) {
    content.innerHTML = `
        <div class="cards-grid">
            ${state.employees.map(emp => `
                <div class="employee-card card">
                    <!-- employee card HTML -->
                </div>
            `).join('')}
        </div>
    `;
}

// Missing renderLeadsTable
function renderLeadsTable(content, type) {
    const data = type === 'customers' ? state.customers : state.leads;
    const filtered = filterLeads(data);
    
    content.innerHTML = `
        <div class="controls-bar">
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" class="search-input" placeholder="Search..." 
                       onkeyup="handleSearch(this.value)">
            </div>
            <div class="filter-group">
                <button class="filter-btn ${state.currentFilter === 'all' ? 'active' : ''}" 
                        onclick="filterLeads('all')">All</button>
                <button class="filter-btn ${state.currentFilter === 'new' ? 'active' : ''}" 
                        onclick="filterLeads('new')">New</button>
                <button class="filter-btn ${state.currentFilter === 'pending' ? 'active' : ''}" 
                        onclick="filterLeads('pending')">Pending</button>
                <button class="filter-btn ${state.currentFilter === 'contacted' ? 'active' : ''}" 
                        onclick="filterLeads('contacted')">Contacted</button>
            </div>
        </div>
        <div class="table-container">
            ${renderLeadsTableHTML(filtered)}
        </div>
    `;
}

// Missing renderEmployees
function renderEmployees(content) {
    content.innerHTML = `
        <div class="cards-grid">
            ${state.employees.map(emp => `
                <div class="card employee-card">
                    <div class="card-header">
                        <div class="employee-avatar-lg">${getInitials(emp.name)}</div>
                        <div class="employee-details">
                            <div class="employee-name">${emp.name}</div>
                            <div class="employee-role">${emp.role || 'Team Member'}</div>
                        </div>
                    </div>
                    <div class="employee-meta">
                        <div class="employee-meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            ${emp.email}
                        </div>
                        ${emp.phone ? `
                            <div class="employee-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
                                </svg>
                                ${emp.phone}
                            </div>
                        ` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" 
                                onclick="openDetailModal('employee', ${emp.id})">View</button>
                        <button class="btn btn-sm btn-danger" 
                                onclick="deleteEmployee(${emp.id})">Delete</button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Filter project timelines
function filterProjectTimelines(query) {
    const savedTimelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
    let filtered;
    if (query) {
        filtered = savedTimelines.filter(function(t) {
            return t.clientName.toLowerCase().indexOf(query.toLowerCase()) !== -1 ||
                (t.clientCompany && t.clientCompany.toLowerCase().indexOf(query.toLowerCase()) !== -1) ||
                (t.projectName && t.projectName.toLowerCase().indexOf(query.toLowerCase()) !== -1);
        });
    } else {
        filtered = savedTimelines;
    }
    renderProjectsList(filtered, savedTimelines);
}
function renderProjectsList(filtered, allTimelines) {
    const grid = document.getElementById('projectTimelinesGrid');
    if (filtered.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1 / -1;"><div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><div class="empty-title">No Results Found</div><div class="empty-description">Try adjusting your search terms</div></div></div>';
        return;
    }

    let html = '';
    filtered.forEach(function(timeline) {
        const originalIndex = allTimelines.findIndex(function(t) { return t.createdAt === timeline.createdAt; });
        let packagesHtml = '';
        timeline.packages.forEach(function(pkg) {
            const pkgName = servicePackages[pkg] ? servicePackages[pkg].name : pkg;
            packagesHtml += '<span style="display: inline-block; background: var(--accent-amber-dim); color: var(--accent-amber); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 6px; margin-bottom: 6px;">' + pkgName + '</span>';
        });
        
        html += '<div class="card" style="cursor: pointer;" onclick="viewProjectTimeline(' + originalIndex + ')">' +
            '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">' +
                '<div>' +
                    '<div style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">' + timeline.clientName + '</div>' +
                    '<div style="font-size: 13px; color: var(--text-muted);">' + (timeline.clientCompany || 'No company') + '</div>' +
                '</div>' +
                '<span class="status-badge status-' + (timeline.status || 'pending') + '">' +
                    '<span class="status-dot"></span>' +
                    (timeline.status || 'Draft') +
                '</span>' +
            '</div>' +
            '<div style="margin-bottom: 16px;">' + packagesHtml + '</div>' +
            '<div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-subtle);">' +
                '<div style="font-size: 12px; color: var(--text-muted);">Created: ' + formatDate(timeline.createdAt) + '</div>' +
                '<div style="display: flex; gap: 8px;">' +
                    '<button class="table-action-btn" onclick="event.stopPropagation(); exportProjectTimeline(' + originalIndex + ')" title="Export">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>' +
                    '</button>' +
                    '<button class="table-action-btn danger" onclick="event.stopPropagation(); deleteProjectTimeline(' + originalIndex + ')" title="Delete">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>' +
                    '</button>' +
                '</div>' +
            '</div>' +
        '</div>';
    });
    
    grid.innerHTML = html;
}

// ==================== PROJECT & MILESTONE MANAGEMENT ====================

async function loadLeadProjects(leadId) {
    try {
        const response = await fetch(`${API_BASE}/api/client/${leadId}/projects`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        const data = await response.json();
        const projects = data.projects || [];
        
        const container = document.getElementById(`projectsList${leadId}`);
        
        if (!container) return;
        
        if (projects.length === 0) {
            container.innerHTML = '<div class="expense-empty">No projects yet</div>';
            return;
        }
        
        container.innerHTML = projects.map(project => `
            <div class="expense-item" style="cursor: pointer;" onclick="openProjectMilestones(${project.id}, '${project.name.replace(/'/g, "\\'")}', ${leadId})">
                <div class="expense-content">
                    <div class="expense-description">${project.name}</div>
                    <div class="expense-meta">
                        <div class="expense-meta-item">
                            ${project.description || 'No description'}
                        </div>
                        <span>${project.milestone_count || 0} milestones</span>
                        <span>${project.completed_milestones || 0} completed</span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="status-badge status-${project.status}">
                        ${project.status}
                    </span>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('[PROJECTS] Load error:', error);
        const container = document.getElementById(`projectsList${leadId}`);
        if (container) {
            container.innerHTML = '<div class="expense-empty">Error loading projects</div>';
        }
    }
}

function openCreateProjectModal(leadId) {
    showModal('Create New Project', `
        <form id="createProjectForm" onsubmit="handleCreateProject(event, ${leadId})">
            <div class="form-group">
                <label class="form-label">Project Name *</label>
                <input type="text" class="form-input" name="name" required placeholder="Website Redesign">
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" name="description" rows="3" placeholder="Full website redesign with new branding..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-input" name="start_date">
            </div>
            
            <div class="form-group">
                <label class="form-label">End Date (Optional)</label>
                <input type="date" class="form-input" name="end_date">
            </div>
            
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" name="status">
                    <option value="active">Active</option>
                    <option value="on-hold">On Hold</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Project</button>
            </div>
        </form>
    `);
}

async function handleCreateProject(event, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const projectData = {
        lead_id: leadId,
        name: formData.get('name'),
        description: formData.get('description'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        status: formData.get('status')
    };
    
    try {
        const response = await fetch(`${API_BASE}/api/projects`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(projectData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Project created successfully', 'success');
            closeModal();
            loadLeadProjects(leadId);
        } else {
            showToast(data.message || 'Failed to create project', 'error');
        }
    } catch (error) {
        console.error('[PROJECT] Create error:', error);
        showToast('Failed to create project', 'error');
    }
}

async function openProjectMilestones(projectId, projectName, leadId) {
    try {
        const response = await fetch(`${API_BASE}/api/client/projects/${projectId}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load project');
        }
        
        const data = await response.json();
        const milestones = data.milestones || [];
        
        showModal(`${projectName} - Milestones`, `
            <div class="milestone-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                ${milestones.length > 0 ? milestones.map(milestone => `
                    <div class="expense-item" style="margin-bottom: 12px;">
                        <div class="expense-content">
                            <div class="expense-description">${milestone.name}</div>
                            <div class="expense-meta">
                                <span>${milestone.description || ''}</span>
                                ${milestone.due_date ? `<span>Due: ${formatDate(milestone.due_date)}</span>` : ''}
                                <span>${milestone.completion_percentage}% complete</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <span class="status-badge status-${milestone.status}">${milestone.status}</span>
                            <button class="table-action-btn" onclick="editMilestone(${milestone.id}, ${projectId}, '${projectName.replace(/'/g, "\\'")}', ${leadId})" title="Edit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('') : '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No milestones yet</p>'}
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="openCreateMilestoneModal(${projectId}, '${projectName.replace(/'/g, "\\'")}', ${leadId})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Milestone
                </button>
            </div>
        `);
    } catch (error) {
        console.error('[MILESTONES] Load error:', error);
        showToast('Failed to load milestones', 'error');
    }
}

function openCreateMilestoneModal(projectId, projectName, leadId) {
    showModal(`Add Milestone to ${projectName}`, `
        <form id="createMilestoneForm" onsubmit="handleCreateMilestone(event, ${projectId}, '${projectName.replace(/'/g, "\\'")}', ${leadId})">
            <div class="form-group">
                <label class="form-label">Milestone Name *</label>
                <input type="text" class="form-input" name="name" required placeholder="Phase 1: Design Mockups">
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" name="description" rows="3" placeholder="Create initial design mockups for homepage..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-input" name="due_date">
            </div>
            
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" name="status">
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="approved">Approved</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Completion %</label>
                <input type="number" class="form-input" name="completion_percentage" min="0" max="100" value="0">
            </div>
            
            <div class="form-group">
                <label class="form-label">Order</label>
                <input type="number" class="form-input" name="order_index" value="1" min="1">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="openProjectMilestones(${projectId}, '${projectName.replace(/'/g, "\\'")}', ${leadId})">Back</button>
                <button type="submit" class="btn btn-primary">Add Milestone</button>
            </div>
        </form>
    `);
}

async function handleCreateMilestone(event, projectId, projectName, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const milestoneData = {
        name: formData.get('name'),
        description: formData.get('description'),
        due_date: formData.get('due_date'),
        status: formData.get('status'),
        completion_percentage: parseInt(formData.get('completion_percentage')) || 0,
        order_index: parseInt(formData.get('order_index')) || 1
    };
    
    try {
        const response = await fetch(`${API_BASE}/api/projects/${projectId}/milestones`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(milestoneData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Milestone added successfully', 'success');
            openProjectMilestones(projectId, projectName, leadId);
        } else {
            showToast(data.message || 'Failed to add milestone', 'error');
        }
    } catch (error) {
        console.error('[MILESTONE] Create error:', error);
        showToast('Failed to add milestone', 'error');
    }
}

async function editMilestone(milestoneId, projectId, projectName, leadId) {
    try {
        // Load current milestone data
        const response = await fetch(`${API_BASE}/api/client/projects/${projectId}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        const data = await response.json();
        const milestone = data.milestones.find(m => m.id === milestoneId);
        
        if (!milestone) {
            showToast('Milestone not found', 'error');
            return;
        }
        
        showModal(`Edit Milestone`, `
            <form id="editMilestoneForm" onsubmit="handleUpdateMilestone(event, ${milestoneId}, ${projectId}, '${projectName.replace(/'/g, "\\'")}', ${leadId})">
                <div class="form-group">
                    <label class="form-label">Milestone Name *</label>
                    <input type="text" class="form-input" name="name" required value="${milestone.name}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" name="description" rows="3">${milestone.description || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" name="due_date" value="${milestone.due_date || ''}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="pending" ${milestone.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="in-progress" ${milestone.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="completed" ${milestone.status === 'completed' ? 'selected' : ''}>Completed</option>
                        <option value="approved" ${milestone.status === 'approved' ? 'selected' : ''}>Approved</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Completion %</label>
                    <input type="number" class="form-input" name="completion_percentage" min="0" max="100" value="${milestone.completion_percentage || 0}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Order</label>
                    <input type="number" class="form-input" name="order_index" value="${milestone.order_index || 1}" min="1">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="openProjectMilestones(${projectId}, '${projectName.replace(/'/g, "\\'")}', ${leadId})">Back</button>
                    <button type="submit" class="btn btn-primary">Update Milestone</button>
                </div>
            </form>
        `);
    } catch (error) {
        console.error('[MILESTONE] Load for edit error:', error);
        showToast('Failed to load milestone', 'error');
    }
}

async function handleUpdateMilestone(event, milestoneId, projectId, projectName, leadId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const milestoneData = {
        name: formData.get('name'),
        description: formData.get('description'),
        due_date: formData.get('due_date'),
        status: formData.get('status'),
        completion_percentage: parseInt(formData.get('completion_percentage')) || 0,
        order_index: parseInt(formData.get('order_index')) || 1
    };
    
    try {
        const response = await fetch(`${API_BASE}/api/milestones/${milestoneId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(milestoneData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Milestone updated successfully', 'success');
            openProjectMilestones(projectId, projectName, leadId);
        } else {
            showToast(data.message || 'Failed to update milestone', 'error');
        }
    } catch (error) {
        console.error('[MILESTONE] Update error:', error);
        showToast('Failed to update milestone', 'error');
    }
}

// ==================== MILESTONE MANAGEMENT ====================

// Open milestone manager for a project
async function openProjectMilestones(projectId, projectName, leadId) {
    try {
        const response = await fetch(`${API_BASE}/api/projects/${projectId}/milestones`, {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load milestones');
        }
        
        const data = await response.json();
        const milestones = data.milestones || [];
        
        const milestonesHtml = milestones.length > 0 ? milestones.map((milestone, index) => `
            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px; border-left: 4px solid ${milestone.status === 'completed' ? 'var(--accent-amber)' : 'var(--border-strong)'};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 4px 0; font-size: 15px;">${milestone.name}</h4>
                        <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">${milestone.description || 'No description'}</p>
                    </div>
                    <span class="status-badge status-${milestone.status}" style="margin-left: 12px;">
                        ${milestone.status}
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        Due: ${milestone.due_date ? formatDate(milestone.due_date) : 'No due date'}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-secondary" onclick="editMilestone(${projectId}, ${milestone.id}, '${projectName}', ${leadId})">
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMilestone(${projectId}, ${milestone.id}, '${projectName}', ${leadId})">
                            Delete
                        </button>
                    </div>
                </div>
                ${milestone.status !== 'completed' ? `
                    <div style="margin-top: 12px;">
                        <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
                            Progress: ${milestone.completion_percentage || 0}%
                        </label>
                        <div style="background: var(--bg-hover); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: var(--accent-amber); height: 100%; width: ${milestone.completion_percentage || 0}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                ` : ''}
            </div>
        `).join('') : '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No milestones yet</p>';
        
        const modalContent = `
            <div style="max-height: 60vh; overflow-y: auto; margin-bottom: 20px;">
                ${milestonesHtml}
            </div>
            <div style="padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                <button class="btn btn-primary" onclick="addMilestone(${projectId}, '${projectName}', ${leadId})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Milestone
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        `;
        
        showModal(`${projectName} - Milestones`, modalContent);
    } catch (error) {
        console.error('[MILESTONE] Load error:', error);
        showToast('Failed to load milestones', 'error');
    }
}

// Add new milestone
function addMilestone(projectId, projectName, leadId) {
    const modalContent = `
        <form onsubmit="saveMilestone(event, ${projectId}, '${projectName}', ${leadId}); return false;">
            <div class="form-group">
                <label>Milestone Name *</label>
                <input type="text" id="milestoneName" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="milestoneDescription" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="milestoneDueDate" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Status</label>
                <select id="milestoneStatus" class="form-control">
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Completion Percentage</label>
                <input type="number" id="milestonePercentage" class="form-control" min="0" max="100" value="0">
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">Save Milestone</button>
                <button type="button" class="btn btn-secondary" onclick="openProjectMilestones(${projectId}, '${projectName}', ${leadId})">Cancel</button>
            </div>
        </form>
    `;
    
    showModal('Add Milestone', modalContent);
}

// Save milestone
async function saveMilestone(event, projectId, projectName, leadId) {
    event.preventDefault();
    
    const milestoneData = {
        project_id: projectId,
        name: document.getElementById('milestoneName').value,
        description: document.getElementById('milestoneDescription').value,
        due_date: document.getElementById('milestoneDueDate').value || null,
        status: document.getElementById('milestoneStatus').value,
        completion_percentage: parseInt(document.getElementById('milestonePercentage').value) || 0
    };
    
    try {
        const response = await fetch(`${API_BASE}/api/projects/${projectId}/milestones`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(milestoneData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Milestone created successfully', 'success');
            openProjectMilestones(projectId, projectName, leadId);
        } else {
            showToast(data.message || 'Failed to create milestone', 'error');
        }
    } catch (error) {
        console.error('[MILESTONE] Create error:', error);
        showToast('Failed to create milestone', 'error');
    }
}

// Edit milestone
async function editMilestone(projectId, milestoneId, projectName, leadId) {
    try {
        // Get milestone data
        const response = await fetch(`${API_BASE}/api/projects/${projectId}/milestones`, {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        const data = await response.json();
        const milestone = data.milestones.find(m => m.id === milestoneId);
        
        if (!milestone) {
            showToast('Milestone not found', 'error');
            return;
        }
        
        const modalContent = `
            <form onsubmit="updateMilestone(event, ${projectId}, ${milestoneId}, '${projectName}', ${leadId}); return false;">
                <div class="form-group">
                    <label>Milestone Name *</label>
                    <input type="text" id="milestoneName" class="form-control" value="${milestone.name}" required>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="milestoneDescription" class="form-control" rows="3">${milestone.description || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" id="milestoneDueDate" class="form-control" value="${milestone.due_date || ''}">
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="milestoneStatus" class="form-control">
                        <option value="pending" ${milestone.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="in-progress" ${milestone.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="completed" ${milestone.status === 'completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Completion Percentage</label>
                    <input type="number" id="milestonePercentage" class="form-control" min="0" max="100" value="${milestone.completion_percentage || 0}">
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Update Milestone</button>
                    <button type="button" class="btn btn-secondary" onclick="openProjectMilestones(${projectId}, '${projectName}', ${leadId})">Cancel</button>
                </div>
            </form>
        `;
        
        showModal('Edit Milestone', modalContent);
    } catch (error) {
        console.error('[MILESTONE] Load for edit error:', error);
        showToast('Failed to load milestone', 'error');
    }
}

// Update milestone
async function updateMilestone(event, projectId, milestoneId, projectName, leadId) {
    event.preventDefault();
    
    const milestoneData = {
        name: document.getElementById('milestoneName').value,
        description: document.getElementById('milestoneDescription').value,
        due_date: document.getElementById('milestoneDueDate').value || null,
        status: document.getElementById('milestoneStatus').value,
        completion_percentage: parseInt(document.getElementById('milestonePercentage').value) || 0
    };
    
    try {
        const response = await fetch(`${API_BASE}/api/milestones/${milestoneId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(milestoneData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Milestone updated successfully', 'success');
            openProjectMilestones(projectId, projectName, leadId);
        } else {
            showToast(data.message || 'Failed to update milestone', 'error');
        }
    } catch (error) {
        console.error('[MILESTONE] Update error:', error);
        showToast('Failed to update milestone', 'error');
    }
}

// Delete milestone
async function deleteMilestone(projectId, milestoneId, projectName, leadId) {
    if (!confirm('Are you sure you want to delete this milestone?')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/api/milestones/${milestoneId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Milestone deleted successfully', 'success');
            openProjectMilestones(projectId, projectName, leadId);
        } else {
            showToast(data.message || 'Failed to delete milestone', 'error');
        }
    } catch (error) {
        console.error('[MILESTONE] Delete error:', error);
        showToast('Failed to delete milestone', 'error');
    }
}

// Render the follow-ups section
function renderFollowUps(categories) {
    const content = document.getElementById('main-content');  // Assuming your main content div has this ID
    if (!content) return;
    
    let html = `
        <h2>Follow-Up Queue</h2>
        <p></p>
    `;
    
    if (categories.length === 0) {
        html += `
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; color: var(--accent-amber);">
                    <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                <h3>All Caught Up!</h3>
                <p>No follow-ups needed right now</p>
            </div>
        `;
    } else {
        categories.forEach(category => {
            const categoryTitle = {
                'never_contacted': 'Never Contacted',
                '1_day': '1+ Day Ago',
                '3_day': '3+ Days Ago',
                '7_day': '7+ Days Ago',
                '14_day': '14+ Days Ago'
            }[category.follow_up_category] || category.follow_up_category;
            
            html += `
                <div class="category-section" style="margin-bottom: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 16px; font-weight: 600;">${categoryTitle}</h3>
                        <span style="background: var(--accent-amber-dim); padding: 4px 12px; border-radius: 20px; font-size: 13px;">${category.count}</span>
                    </div>
                    <button class="btn btn-primary" onclick="sendBulkEmailByCategory('${category.follow_up_category}')">Send Bulk Email to Category</button>
                    <div class="leads-list" style="margin-top: 16px;">
                        ${category.leads.map(lead => `
                            <div class="lead-card" style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px; border: 1px solid var(--border-subtle);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">${lead.name} (${lead.email})</span>
                                    <span style="color: var(--text-muted); font-size: 12px;">${lead.days_since_contact} days ago</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary btn-sm" onclick="sendIndividualEmail('${lead.id}')">Send Email</button>
                                </div>
                                <div class="notes-section" style="margin-top: 12px;">
                                    <button onclick="toggleNotes(this)" class="btn btn-secondary btn-sm">View Notes</button>
                                    <div class="notes-content" style="display: none; margin-top: 12px;">
                                        ${renderLeadNotes(lead.notes)}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
    }
    
    content.innerHTML = html;  // Or append to a specific follow-up div if you have one
}

// Send email to specific follow-up category
async function sendBulkEmailByCategory(category, subject, message) {
    try {
        const response = await fetch(`${API_URL}/api/follow-ups/send-by-category`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ category, subject, message, isFollowUp: true })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`Sent ${data.successCount} emails to ${category} category`, 'success');
            renderSection('followups'); // Refresh the view
        } else {
            showToast(data.message || 'Failed to send emails', 'error');
        }
    } catch (error) {
        console.error('[BULK EMAIL] Error:', error);
        showToast('Failed to send bulk email', 'error');
    }
}

function openCategoryEmailModal(category, categoryLabel, count) {
    console.log('[BULK EMAIL] Opening modal for:', category, categoryLabel, count);
    
    const existingModal = document.getElementById('bulkEmailModal');
    if (existingModal) existingModal.remove();

    const modalHtml = `
        <div class="modal-overlay" id="bulkEmailModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
            <div class="modal" style="background: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow: auto;" onclick="event.stopPropagation()">
                <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="margin: 0;">Email All - ${categoryLabel}</h3>
                </div>
                <div style="padding: 20px;">
                    <p style="margin-bottom: 20px; color: #666; padding: 12px; background: #f3f4f6; border-radius: 6px;">
                         This will send an email to <strong>${count} leads</strong> in this category.
                    </p>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Subject:</label>
                        <input type="text" id="bulkEmailSubject" placeholder="Email subject" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Message:</label>
                        <textarea id="bulkEmailBody" rows="10" placeholder="Type your message here..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; font-family: inherit; box-sizing: border-box;"></textarea>
                    </div>
                    <!-- Auto-Campaign Toggle -->
                    <div style="margin-top: 18px; padding: 14px 16px; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <div style="flex: 1;">
                            <div style="font-size: 14px; font-weight: 600; color: #111;">Auto-Campaign</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">Automatically re-send this email every time these leads are due for follow-up</div>
                        </div>
                        <label style="position: relative; width: 44px; height: 24px; flex-shrink: 0; cursor: pointer;">
                            <input type="checkbox" id="bulkAutoSwitch" style="opacity:0;width:0;height:0;">
                            <span id="bulkAutoTrack" style="position:absolute;inset:0;background:#d1d5db;border-radius:24px;transition:.2s;"><span id="bulkAutoThumb" style="position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2);"></span></span>
                        </label>
                    </div>
                </div>
                <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                    <span id="bulkAutoLabel" style="display:none;font-size:12px;color:#8a7d5a;margin-right:auto;align-items:center;gap:5px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#D4A847" stroke-width="2.5" style="width:14px;height:14px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                        Auto-campaigns will be created for all ${count} leads
                    </span>
                    <button class="btn btn-secondary" onclick="closeBulkEmailModal()">Cancel</button>
                    <button class="btn btn-primary" id="sendBulkEmailBtn" onclick="sendBulkEmail('${category}', ${count})">
                        Send to ${count} Leads
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    document.getElementById('bulkEmailModal').addEventListener('click', function(e) {
        if (e.target.id === 'bulkEmailModal') closeBulkEmailModal();
    });

    // Wire toggle
    const sw = document.getElementById('bulkAutoSwitch');
    if (sw) {
        sw.addEventListener('change', function() {
            const track = document.getElementById('bulkAutoTrack');
            const thumb = document.getElementById('bulkAutoThumb');
            const label = document.getElementById('bulkAutoLabel');
            if (this.checked) { track.style.background='#D4A847'; thumb.style.left='23px'; label.style.display='flex'; }
            else { track.style.background='#d1d5db'; thumb.style.left='3px'; label.style.display='none'; }
        });
    }
    
    setTimeout(() => { document.getElementById('bulkEmailSubject')?.focus(); }, 100);
}

function closeBulkEmailModal() {
    const modal = document.getElementById('bulkEmailModal');
    if (modal) {
        modal.remove();
    }
}

async function sendBulkEmail(category, count) {
    console.log('[BULK EMAIL] Sending to category:', category);
    
    const subject = document.getElementById('bulkEmailSubject')?.value;
    const body = document.getElementById('bulkEmailBody')?.value;
    
    if (!subject || !body) {
        showToast('Please fill in subject and message', 'error');
        return;
    }

    const isAuto = document.getElementById('bulkAutoSwitch')?.checked || false;
    
    const sendBtn = document.getElementById('sendBulkEmailBtn');
    if (!sendBtn) return;
    const originalText = sendBtn.innerHTML;
    sendBtn.disabled = true;
    sendBtn.innerHTML = 'Sending...';
    
    try {
        const token = getAuthToken();

        if (isAuto) {
            // AUTO MODE: fetch leads in this category, then create a campaign for each
            console.log('[BULK EMAIL] Auto-campaign mode');
            sendBtn.innerHTML = 'Creating campaigns...';

            const catRes = await fetch(`${API_URL}/api/follow-ups/categorized`, {
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            });
            const catData = await catRes.json();
            const targetCat = (catData.categories || []).find(c => c.follow_up_category === category);

            if (!targetCat?.leads?.length) {
                showToast('No leads found in this category', 'error');
                sendBtn.disabled = false; sendBtn.innerHTML = originalText;
                return;
            }

            let created = 0, skipped = 0, failed = 0;
            for (const lead of targetCat.leads) {
                try {
                    const res = await fetch(`${API_URL}/api/auto-campaigns`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ leadId: lead.id, subject, body })
                    });
                    if (res.ok) created++;
                    else if (res.status === 409) skipped++;
                    else failed++;
                } catch(e) { failed++; }
            }

            let msg = `Done: ${created} campaign${created !== 1 ? 's' : ''} created`;
            if (skipped) msg += `, ${skipped} already active`;
            if (failed) msg += `, ${failed} failed`;
            showToast(msg, 'success');
            closeBulkEmailModal();

        } else {
            // NORMAL ONE-SHOT BULK
            const response = await fetch(`${API_URL}/api/follow-ups/email-category`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, subject, body, isFollowUp: true })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to send bulk emails');
            }
            
            const result = await response.json();
            showToast(`Successfully sent ${result.sent_count || count} emails!`, 'success');
            closeBulkEmailModal();
        }
        
        updateBadges();
        const contentArea = document.getElementById('contentArea');
        if (contentArea) await renderFollowUps(contentArea);
        
    } catch (error) {
        console.error('[BULK EMAIL] Error:', error);
        showToast('Failed: ' + error.message, 'error');
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
    }
}

// Handle category email form submission
async function handleCategoryEmailSend(event, category) {
    event.preventDefault();
    
    const subject = document.getElementById('emailSubject').value;
    const message = document.getElementById('emailMessage').value;
    
    if (!subject || !message) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    
    closeCreateModal();
    await sendBulkEmailByCategory(category, subject, message);
}



async function markAsContacted(leadId) {
    try {
        const response = await fetch(`/api/leads/${leadId}/contacted`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Lead marked as contacted', 'success');
            loadFollowUps();
        } else {
            showNotification('Failed to update lead', 'error');
        }
    } catch (error) {
        console.error('Mark contacted error:', error);
        showNotification('Failed to update lead', 'error');
    }
}

function refreshFollowUps() {
    loadFollowUps();
}

function viewLead(leadId) {
    showSection('customers');
    setTimeout(() => {
        const leadRow = document.querySelector(`tr[data-lead-id="${leadId}"]`);
        if (leadRow) {
            leadRow.click();
        }
    }, 500);
}

// View saved project timeline
function viewProjectTimeline(index) {
    const timelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
    const timeline = timelines[index];
    
    if (!timeline) {
        showToast('Timeline not found', 'error');
        return;
    }
    
    // Store for export and email functions
    window.currentTimelinePreview = timeline;
    window.currentTimelineIndex = index;
    
    // Calculate totals
    let totalPrice = 0;
    let hasPaidPackage = false;
    timeline.packages.forEach(function(key) {
        if (servicePackages[key] && !servicePackages[key].isFree) {
            hasPaidPackage = true;
            totalPrice += servicePackages[key].price;
        }
    });
    
    // Generate overview content
    const overviewContent = `
        <h3 style="margin-bottom: 16px;">Quick Summary</h3>
        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: var(--radius-md);">
            <div style="margin-bottom: 12px;"><strong>Client:</strong> ${timeline.clientName}${timeline.clientCompany ? ' / ' + timeline.clientCompany : ''}</div>
            <div style="margin-bottom: 12px;"><strong>Email:</strong> ${timeline.clientEmail}</div>
            <div style="margin-bottom: 12px;"><strong>Project:</strong> ${timeline.projectName || 'Web Development Project'}</div>
            <div style="margin-bottom: 12px;"><strong>Packages:</strong> ${timeline.packages.map(k => servicePackages[k]?.name || k).join(', ')}</div>
            <div style="margin-bottom: 12px;"><strong>Total:</strong> ${timeline.isFreeProject ? 'FREE' : '$' + totalPrice.toLocaleString()}</div>
            <div style="margin-bottom: 12px;"><strong>Start:</strong> ${formatDate(timeline.startDate)}</div>
            <div><strong>End:</strong> ${formatDate(timeline.endDate || 'TBD')}</div>
        </div>
    `;
    
    // Generate timeline phases content
    const timelineContent = `
        <h3 style="margin-bottom: 16px;">Project Phases</h3>
        <div style="max-height: 500px; overflow-y: auto;">
            ${standardWebsitePhases.map((phase, index) => `
                <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border-left: 3px solid var(--accent-amber);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <span style="display: inline-block; background: var(--accent-amber); color: var(--bg-void); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; margin-right: 8px;">Phase ${index + 1}</span>
                            <span style="font-size: 15px; font-weight: 600;">${phase.name}</span>
                        </div>
                        <span style="font-size: 12px; color: var(--text-muted);">${phase.duration}</span>
                    </div>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        ${phase.tasks.map(task => `
                            <li style="padding: 6px 0; padding-left: 20px; position: relative; font-size: 13px; color: var(--text-secondary);">
                                <span style="position: absolute; left: 0; top: 6px; color: var(--accent-amber);"></span>
                                ${task}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('')}
        </div>
    `;
    
    // Build the modal content with tabs
    const modalContent = `
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="timeline">Timeline</button>
            <button class="tab" data-tab="preview">Full SLA Preview</button>
        </div>

        <div id="tab-overview" class="tab-content" style="padding: 24px;">
            ${overviewContent}
        </div>

        <div id="tab-timeline" class="tab-content" style="display: none; padding: 24px;">
            ${timelineContent}
        </div>

        <div id="tab-preview" class="tab-content" style="display: none; padding: 24px;">
            <!-- Will be populated when tab is clicked -->
        </div>
        
        <div class="modal-actions" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-secondary" onclick="emailSavedTimelineToClient()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
                Email to Client
            </button>
            <button class="btn btn-primary" onclick="exportProjectTimeline(${index})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export PDF
            </button>
            <button class="btn btn-danger" onclick="deleteProjectTimeline(${index})">Delete</button>
        </div>
    `;
    
    // Use your existing showModal function
    showModal(`Project Timeline - ${timeline.clientName}`, modalContent);
    
    // Set up tab click handlers AFTER modal is visible
    setTimeout(() => {
        document.querySelectorAll('#createModal .tab').forEach(tab => {
            tab.addEventListener('click', function () {
                // Remove active from all tabs
                document.querySelectorAll('#createModal .tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Hide all contents
                document.querySelectorAll('#createModal .tab-content').forEach(c => c.style.display = 'none');

                // Show selected
                const tabId = 'tab-' + this.dataset.tab;
                const content = document.getElementById(tabId);
                if (content) {
                    content.style.display = 'block';

                    // Special case: when user clicks "Full SLA Preview" tab  generate content
                    if (this.dataset.tab === 'preview') {
                        content.innerHTML = generateTimelineHTML(timeline);
                    }
                }
            });
        });
    }, 100);
}

// Email saved timeline to client
async function emailSavedTimelineToClient() {
    const timeline = window.currentTimelinePreview;
    if (!timeline) {
        showToast('No timeline to email', 'error');
        return;
    }
    
    if (!timeline.clientEmail) {
        showToast('No client email address found', 'error');
        return;
    }
    
    // Show loading toast
    showToast('Sending email...', 'warning');
    
    try {
        const response = await fetch(`${API_URL}/api/email/send-timeline`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
                timeline: timeline,
                clientEmail: timeline.clientEmail,
                clientName: timeline.clientName
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToast('Timeline emailed successfully to ' + timeline.clientEmail, 'success');
            closeModal();
        } else {
            throw new Error(data.message || 'Failed to send email');
        }
    } catch (error) {
        console.error('Email error:', error);
        showToast('Failed to send email: ' + error.message, 'error');
    }
}

// FIX 3: Export Timeline Function  
function exportProjectTimeline(index) {
    const timelines = JSON.parse(localStorage.getItem('projectTimelines') || '[]');
    const timeline = timelines[index];
    
    if (!timeline) {
        showToast('Timeline not found', 'error');
        return;
    }
    
    // Set the timeline for export and call the comprehensive PDF export function
    window.currentTimelinePreview = timeline;
    exportTimelineAsPDF();
}

// FIX 6: Delete Ticket Function
async function deleteTicket(ticketId) {
    if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/api/tickets/${ticketId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        if (response.ok) {
            showToast('Ticket deleted successfully', 'success');
            closeModal();
            loadTickets();
        } else {
            const data = await response.json();
            throw new Error(data.message || 'Failed to delete ticket');
        }
    } catch (error) {
        console.error('[TICKET] Delete error:', error);
        showToast('Failed to delete ticket: ' + error.message, 'error');
    }
}

// FIX 9: Assign Project Button Function
async function assignProject(clientId) {
    try {
        // Get client info
        const client = state.clientAccounts.find(c => c.id === clientId);
        if (!client) {
            showToast('Client not found', 'error');
            return;
        }
        
        // Get the lead info for this client
        const leadResponse = await fetch(`${API_BASE}/api/leads?email=${encodeURIComponent(client.email)}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        if (!leadResponse.ok) {
            throw new Error('Failed to find lead record');
        }
        
        const leadData = await leadResponse.json();
        const lead = leadData.leads && leadData.leads.length > 0 ? leadData.leads[0] : null;
        
        if (!lead) {
            showToast('No lead record found for this client', 'error');
            return;
        }
        
        // Open the create project modal pre-filled with this client's info
        openCreateProjectModal(lead.id);
        
    } catch (error) {
        console.error('[ASSIGN PROJECT] Error:', error);
        showToast('Failed to assign project', 'error');
    }
} 

// Add this function to render notes for a lead
function renderLeadNotes(notes) {
    if (!notes || notes.length === 0) {
        return '<p style="color: var(--text-muted);">No notes yet</p>';
    }
    try {
        const parsedNotes = typeof notes === 'string' ? JSON.parse(notes) : notes;
        return parsedNotes.map(note => `
            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 3px solid var(--accent-amber);">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">${note.date} - ${note.author}</div>
                <p>${note.text}</p>
            </div>
        `).join('');
    } catch (e) {
        return '<p style="color: var(--status-lost);">Error parsing notes</p>';
    }
}

// In your follow-up rendering code (e.g., inside the loop that renders leads in categories), add notes display.
// Assuming you have a function like renderCategoryLeads(category):
// Append this to each lead's HTML:
`
<div class="notes-section" style="margin-top: 12px;">
    <button onclick="toggleNotes(this)" class="btn btn-secondary btn-sm">View Notes</button>
    <div class="notes-content" style="display: none; margin-top: 12px;">
        ${renderLeadNotes(lead.notes)}
    </div>
</div>
`

// Add toggle function
function toggleNotes(button) {
    const content = button.nextElementSibling;
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
    button.textContent = content.style.display === 'block' ? 'Hide Notes' : 'View Notes';
}

// ==================== FOLLOW-UPS SYSTEM ====================

async function renderFollowUps(content) {
    console.log('[FOLLOW-UPS] Starting render with HOT/COLD/DEAD system...');
    
    try {
        content.innerHTML = '<div style="text-align: center; padding: 40px;">Loading follow-ups...</div>';
        
        const token = state.authToken || localStorage.getItem('token');
        const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

        // Fetch hot/cold leads and dead leads in parallel
        const [tempResponse, deadResponse] = await Promise.all([
            fetch(`${API_URL}/api/follow-ups/by-temperature`, { headers }),
            fetch(`${API_URL}/api/follow-ups/dead-leads`, { headers })
        ]);
        
        if (!tempResponse.ok) throw new Error(`API error: ${tempResponse.status}`);
        
        const data = await tempResponse.json();
        const hotLeads = data.data.hot || [];
        const coldLeads = data.data.cold || [];
        const deadLeads = deadResponse.ok ? ((await deadResponse.json()).leads || []) : [];
        
        console.log(`[FOLLOW-UPS]  Loaded ${hotLeads.length} hot, ${coldLeads.length} cold, ${deadLeads.length} dead leads`);
        
        // Store in state for tab switching
        state.hotLeads = hotLeads;
        state.coldLeads = coldLeads;
        state.deadLeads = deadLeads;
        state.currentFollowUpTab = state.currentFollowUpTab || 'cold';
        
        // Build the page HTML with tabs
        content.innerHTML = `
            <div class="page-header" style="margin-bottom: 24px;">
                <div>
                    <h2>Follow Ups</h2>
                    <p class="section-subtitle">Manage leads by engagement level</p>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid var(--border-subtle); padding-bottom: 0;">
                <button id="tabCold" onclick="switchFollowUpTemperatureTab('cold')" 
                    class="temperature-tab ${state.currentFollowUpTab === 'cold' ? 'active' : ''}"
                    style="padding: 12px 24px; background: ${state.currentFollowUpTab === 'cold' ? 'var(--bg-hover)' : 'transparent'}; 
                           border: none; border-bottom: 3px solid ${state.currentFollowUpTab === 'cold' ? '#3b82f6' : 'transparent'}; 
                           color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Cold Leads
                    <span style="display: inline-block; margin-left: 8px; background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;">${coldLeads.length}</span>
                </button>
                <button id="tabHot" onclick="switchFollowUpTemperatureTab('hot')" 
                    class="temperature-tab ${state.currentFollowUpTab === 'hot' ? 'active' : ''}"
                    style="padding: 12px 24px; background: ${state.currentFollowUpTab === 'hot' ? 'var(--bg-hover)' : 'transparent'}; 
                           border: none; border-bottom: 3px solid ${state.currentFollowUpTab === 'hot' ? '#ef4444' : 'transparent'}; 
                           color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Hot Leads
                    <span style="display: inline-block; margin-left: 8px; background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;">${hotLeads.length}</span>
                </button>
                <button id="tabDead" onclick="switchFollowUpTemperatureTab('dead')" 
                    class="temperature-tab ${state.currentFollowUpTab === 'dead' ? 'active' : ''}"
                    style="padding: 12px 24px; background: ${state.currentFollowUpTab === 'dead' ? 'var(--bg-hover)' : 'transparent'}; 
                           border: none; border-bottom: 3px solid ${state.currentFollowUpTab === 'dead' ? '#6b7280' : 'transparent'}; 
                           color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Dead Leads
                    <span style="display: inline-block; margin-left: 8px; background: #6b7280; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;">${deadLeads.length}</span>
                </button>
            </div>

            <!-- Tab Content Container -->
            <div id="followUpTabContent">
                ${buildFollowUpTabContent(state.currentFollowUpTab, hotLeads, coldLeads, deadLeads)}
            </div>
        `;
        
    } catch (error) {
        console.error('[FOLLOW-UPS]  Error:', error);
        content.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--status-lost);">
                <h3 style="margin-bottom: 12px;">Error Loading Follow-Ups</h3>
                <p style="color: var(--text-muted); margin-bottom: 8px;">${error.message}</p>
                <button class="btn btn-secondary" onclick="renderFollowUps(document.getElementById('contentArea'))">Try Again</button>
            </div>
        `;
    }
}

// Helper function to build tab content
function buildFollowUpTabContent(tab, hotLeads, coldLeads, deadLeads) {
    deadLeads = deadLeads || state.deadLeads || [];

    //  DEAD LEADS TAB 
    if (tab === 'dead') {
        if (deadLeads.length === 0) {
            return `
                <div style="text-align: center; padding: 60px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;margin:0 auto 16px;color:#6b7280;">
                        <circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                    </svg>
                    <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">No Dead Leads</div>
                    <div style="color: var(--text-muted);">No leads have unsubscribed yet. They will appear here when they opt out.</div>
                </div>
            `;
        }

        const deadHtml = deadLeads.map(lead => {
            const lastContact = lead.last_contact_date ? formatDate(lead.last_contact_date) : 'Never';
            return `
                <tr>
                    <td>
                        <div class="contact-cell">
                            <div class="contact-avatar" style="opacity:0.5;">${getInitials(lead.name || '?')}</div>
                            <div class="contact-info">
                                <div class="contact-name" style="color: var(--text-secondary);">${lead.name || 'Unknown'}
                                    <span style="font-size:10px;background:#6b7280;color:white;padding:2px 6px;border-radius:10px;margin-left:6px;font-weight:700;letter-spacing:0.5px;">UNSUBSCRIBED</span>
                                </div>
                                <div class="contact-email">${lead.email || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td style="color: var(--text-secondary);">${lead.company || ''}</td>
                    <td style="color: var(--text-secondary);">${lastContact}</td>
                    <td>
                        <a href="#" onclick="event.preventDefault(); openLeadModal(${lead.id})" style="font-size:12px; color: var(--text-muted); text-decoration: underline;">View Lead</a>
                    </td>
                </tr>
            `;
        }).join('');

        return `
            <div style="background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 28px;">
                <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid var(--border-subtle);">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;color:#6b7280;flex-shrink:0;">
                            <circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                        </svg>
                        <h3 style="font-size: 18px; font-weight: 700; margin: 0;">Dead Leads  Unsubscribed</h3>
                    </div>
                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">These leads have opted out of follow-up emails. They will not receive any future outreach.</p>
                    <p style="font-size: 13px; color: var(--text-primary); margin-top: 8px; font-weight: 600;">${deadLeads.length} ${deadLeads.length === 1 ? 'lead has' : 'leads have'} unsubscribed</p>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" style="min-width: 700px;">
                        <thead><tr><th>Lead</th><th>Company</th><th>Last Contacted</th><th>Actions</th></tr></thead>
                        <tbody>${deadHtml}</tbody>
                    </table>
                </div>
            </div>
        `;
    }

    //  HOT / COLD TABS with day-bucket sub-tabs 
    const leads = tab === 'hot' ? hotLeads : coldLeads;
    const isHot = tab === 'hot';
    const accentColor = isHot ? '#ef4444' : '#3b82f6';

    // Day bucket definitions
    const buckets = [
        { key: 'never',  label: 'Never Contacted', filter: l => !l.last_contact_date || parseInt(l.days_since_contact) === 999 },
        { key: '3day',   label: '36 Days',        filter: l => { const d = parseInt(l.days_since_contact); return d >= 3 && d < 7; } },
        { key: '7day',   label: '713 Days',       filter: l => { const d = parseInt(l.days_since_contact); return d >= 7 && d < 14; } },
        { key: '14day',  label: '14+ Days',        filter: l => { const d = parseInt(l.days_since_contact); return d >= 14; } },
    ];

    // Build bucketed lead sets
    const bucketed = buckets.map(b => ({ ...b, leads: leads.filter(b.filter) }));
    const nonEmpty = bucketed.filter(b => b.leads.length > 0);

    // Use state to track the active day sub-tab
    const stateKey = `currentDaySubTab_${tab}`;
    if (!state[stateKey] || !bucketed.find(b => b.key === state[stateKey] && b.leads.length > 0)) {
        state[stateKey] = (nonEmpty[0]?.key) || 'never';
    }
    const activeDayKey = state[stateKey];
    const activeBucket = bucketed.find(b => b.key === activeDayKey) || bucketed[0];

    if (leads.length === 0) {
        return `
            <div style="text-align: center; padding: 60px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;margin:0 auto 16px;color:${accentColor};">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">No ${isHot ? 'Hot' : 'Cold'} Leads</div>
                <div style="color: var(--text-muted);">
                    ${isHot ? 'Hot leads appear here when they engage with your emails or fill out contact forms.' : 'All your leads are either hot or do not need follow-up right now.'}
                </div>
            </div>
        `;
    }

    // Build day sub-tab nav
    const daySubTabNav = `
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;">
            ${bucketed.map(b => {
                const isActive = b.key === activeDayKey;
                const isEmpty = b.leads.length === 0;
                return `
                    <button onclick="switchDaySubTab('${tab}','${b.key}')"
                        style="padding:7px 14px; border-radius:20px; border: 1.5px solid ${isActive ? accentColor : 'var(--border-subtle)'};
                               background: ${isActive ? accentColor : 'transparent'}; color: ${isActive ? 'white' : isEmpty ? 'var(--text-muted)' : 'var(--text-primary)'};
                               font-size:12px; font-weight:600; cursor:${isEmpty ? 'default' : 'pointer'}; opacity:${isEmpty ? 0.45 : 1}; transition:all 0.15s;
                               pointer-events:${isEmpty ? 'none' : 'auto'};">
                        ${b.label}
                        <span style="margin-left:5px; background:${isActive ? 'rgba(255,255,255,0.25)' : 'var(--bg-hover)'}; color:${isActive ? 'white' : 'var(--text-muted)'}; padding:1px 7px; border-radius:10px; font-size:11px;">${b.leads.length}</span>
                    </button>
                `;
            }).join('')}
        </div>
    `;

    // Build lead rows for the active bucket
    const buildRows = (rowLeads) => rowLeads.map(lead => {
        const escapedName = (lead.name || 'Unknown').replace(/'/g, "\\'");
        const daysSince = (!lead.last_contact_date || parseInt(lead.days_since_contact) === 999) ? 'Never' : `${lead.days_since_contact} days`;
        const lastContactDisplay = lead.last_contact_date ? formatDate(lead.last_contact_date) : 'Never';
        return `
            <tr>
                <td>
                    <div class="contact-cell">
                        <div class="contact-avatar">${getInitials(lead.name || '?')}</div>
                        <div class="contact-info">
                            <div class="contact-name">${lead.name || 'Unknown'}
                                ${isHot ? `<span style="font-size:9px;background:#ef4444;color:white;padding:2px 6px;border-radius:10px;margin-left:6px;font-weight:700;letter-spacing:0.4px;">HOT</span>` : ''}
                            </div>
                            <div class="contact-email">${lead.email || ''}</div>
                        </div>
                    </div>
                </td>
                <td>${lastContactDisplay}</td>
                <td>
                    <span style="color: ${parseInt(lead.days_since_contact) > 7 ? 'var(--status-lost)' : 'var(--text-secondary)'}">
                        ${daysSince}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="markFollowedUp(${lead.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Mark Contacted
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="showEmailModal(${lead.id}, '${escapedName}', '${lead.email}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            Email
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    const description = isHot
        ? 'These leads have engaged with you (clicked links, filled forms, replied). They receive follow-ups every 3.5 days.'
        : "These leads haven't engaged yet. They follow your standard follow-up cadence.";

    const activeBucketLeads = activeBucket?.leads || [];

    return `
        <div style="background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 28px;">
            <!-- Header -->
            <div style="margin-bottom: 20px; padding-bottom: 18px; border-bottom: 2px solid var(--border-subtle);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 6px;">${isHot ? 'Hot Leads' : 'Cold Leads'}</h3>
                        <p style="font-size: 13px; color: var(--text-secondary); margin: 0 0 6px;">${description}</p>
                        <p style="font-size: 13px; color: var(--text-primary); font-weight: 600;">${leads.length} ${leads.length === 1 ? 'lead' : 'leads'} need follow-up</p>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="openTemperatureEmailModal('${tab}', '${isHot ? 'Hot Leads' : 'Cold Leads'}', ${leads.length})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        Email All
                    </button>
                </div>
            </div>

            <!-- Day bucket sub-tabs -->
            ${daySubTabNav}

            <!-- Active bucket heading -->
            <div style="margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;">
                <span style="font-size:13px;font-weight:600;color:var(--text-secondary);">${activeBucketLeads.length} lead${activeBucketLeads.length !== 1 ? 's' : ''}  ${activeBucket?.label || ''}</span>
            </div>

            <!-- Lead table -->
            <div style="overflow-x: auto;" id="dayBucketTable_${tab}">
                ${activeBucketLeads.length === 0 ? `
                    <div style="text-align:center;padding:40px;color:var(--text-muted);">No leads in this time bucket.</div>
                ` : `
                    <table class="data-table" style="min-width: 850px;">
                        <thead>
                            <tr>
                                <th style="width:250px;">Lead</th>
                                <th style="width:150px;">Last Contact</th>
                                <th style="width:120px;">Days Since</th>
                                <th style="min-width:280px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>${buildRows(activeBucketLeads)}</tbody>
                    </table>
                `}
            </div>
        </div>
    `;
}

// Switch day sub-tab within a temperature tab
function switchDaySubTab(temperatureTab, dayKey) {
    const stateKey = `currentDaySubTab_${temperatureTab}`;
    state[stateKey] = dayKey;
    // Re-render only the tab content (no full API refetch)
    const content = document.getElementById('followUpTabContent');
    if (content) {
        content.innerHTML = buildFollowUpTabContent(temperatureTab, state.hotLeads, state.coldLeads, state.deadLeads);
    }
}

// Tab switcher function
function switchFollowUpTemperatureTab(tab) {
    state.currentFollowUpTab = tab;
    
    // Update tab styling
    document.getElementById('tabCold').style.background = tab === 'cold' ? 'var(--bg-hover)' : 'transparent';
    document.getElementById('tabCold').style.borderBottom = `3px solid ${tab === 'cold' ? '#3b82f6' : 'transparent'}`;
    document.getElementById('tabHot').style.background = tab === 'hot' ? 'var(--bg-hover)' : 'transparent';
    document.getElementById('tabHot').style.borderBottom = `3px solid ${tab === 'hot' ? '#ef4444' : 'transparent'}`;
    const deadTab = document.getElementById('tabDead');
    if (deadTab) {
        deadTab.style.background = tab === 'dead' ? 'var(--bg-hover)' : 'transparent';
        deadTab.style.borderBottom = `3px solid ${tab === 'dead' ? '#6b7280' : 'transparent'}`;
    }
    
    // Update content
    document.getElementById('followUpTabContent').innerHTML = buildFollowUpTabContent(tab, state.hotLeads, state.coldLeads, state.deadLeads);
}

// Open email modal for temperature-based leads (hot/cold)
function openTemperatureEmailModal(temperature, temperatureLabel, count) {
    console.log('[BULK EMAIL] Opening modal for:', temperature, temperatureLabel, count);
    
    const existingModal = document.getElementById('bulkEmailModal');
    if (existingModal) existingModal.remove();

    const modalHtml = `
        <div class="modal-overlay" id="bulkEmailModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
            <div class="modal" style="background: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow: auto;" onclick="event.stopPropagation()">
                <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="margin: 0; color: #111;">Email All - ${temperatureLabel}</h3>
                </div>
                <div style="padding: 20px;">
                    <p style="margin-bottom: 20px; color: #666; padding: 12px; background: #f3f4f6; border-radius: 6px;">
                        This will send an email to <strong>${count} leads</strong> in this category.
                    </p>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #111;">Template:</label>
                        <select id="bulkEmailTemplate" onchange="loadEmailTemplate()" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; background: white; color: #111;">
                            <option value="">-- Select a template (optional) --</option>
                            <option value="followUp">Follow Up</option>
                            <option value="blackFriday">Black Friday Sale - 25% Off</option>
                            <option value="initialSale">Initial Sale - 25% Off Spring Promo</option>
                            <option value="valentinesSale">Valentine's Day Sale - 25% Off</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #111;">Subject:</label>
                        <input type="text" id="bulkEmailSubject" placeholder="Email subject" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; color: #111;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #111;">Message:</label>
                        <textarea id="bulkEmailBody" rows="10" placeholder="Type your message here..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; font-family: inherit; box-sizing: border-box; color: #111;"></textarea>
                    </div>
                </div>
                <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                    <button class="btn btn-secondary" onclick="closeBulkEmailModal()">Cancel</button>
                    <button class="btn btn-primary" id="sendBulkEmailBtn" onclick="sendTemperatureBulkEmail('${temperature}', ${count})">
                        Send to ${count} Leads
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    document.getElementById('bulkEmailModal').addEventListener('click', function(e) {
        if (e.target.id === 'bulkEmailModal') closeBulkEmailModal();
    });
    
    setTimeout(() => { document.getElementById('bulkEmailSubject')?.focus(); }, 100);
}

// Load email template into the modal
function loadEmailTemplate() {
    const templateSelect = document.getElementById('bulkEmailTemplate');
    const templateKey = templateSelect.value;
    
    if (!templateKey || !emailTemplates[templateKey]) {
        return;
    }
    
    const template = emailTemplates[templateKey];
    document.getElementById('bulkEmailSubject').value = template.subject;
    document.getElementById('bulkEmailBody').value = template.body;
}

function closeBulkEmailModal() {
    const modal = document.getElementById('bulkEmailModal');
    if (modal) {
        modal.remove();
    }
}

async function sendTemperatureBulkEmail(temperature, count) {
    console.log('[BULK EMAIL] Sending to temperature:', temperature);
    
    const subject = document.getElementById('bulkEmailSubject')?.value;
    const body = document.getElementById('bulkEmailBody')?.value;
    
    if (!subject || !body) {
        showToast('Please fill in subject and message', 'error');
        return;
    }
    
    const sendBtn = document.getElementById('sendBulkEmailBtn');
    if (!sendBtn) return;
    const originalText = sendBtn.innerHTML;
    sendBtn.disabled = true;
    sendBtn.innerHTML = 'Sending...';
    
    try {
        const token = getAuthToken();
        
        // Get the leads for this temperature
        const leads = temperature === 'hot' ? state.hotLeads : state.coldLeads;
        
        if (!leads || leads.length === 0) {
            showToast('No leads found in this category', 'error');
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalText;
            return;
        }
        
        // Send emails to all leads in this temperature category
        let sent = 0;
        let failed = 0;
        
        for (const lead of leads) {
            try {
                const response = await fetch(`${API_URL}/api/send-email`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ 
                        to: lead.email, 
                        subject, 
                        body, 
                        leadId: lead.id,
                        isFollowUp: true
                    })
                });
                
                if (response.ok) {
                    sent++;
                    // Update last contact date
                    await fetch(`${API_URL}/api/leads/${lead.id}`, {
                        method: 'PUT',
                        headers: { 
                            'Authorization': `Bearer ${token}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ 
                            last_contact_date: new Date().toISOString(),
                            status: 'contacted'
                        })
                    });
                } else {
                    failed++;
                }
            } catch (e) {
                console.error('Error sending to', lead.email, e);
                failed++;
            }
        }
        
        showToast(`Successfully sent ${sent} emails${failed > 0 ? ` (${failed} failed)` : ''}`, 'success');
        closeBulkEmailModal();
        
        updateBadges();
        const contentArea = document.getElementById('contentArea');
        if (contentArea) await renderFollowUps(contentArea);
        
    } catch (error) {
        console.error('[BULK EMAIL] Error:', error);
        showToast('Failed: ' + error.message, 'error');
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
    }
}

// Helper function to build category content - REMOVED (no longer needed)
// function buildCategoryContent() { ... }

// Switch between follow-up category tabs - REMOVED (no longer needed)  
// function switchFollowupTab() { ... }

async function markFollowedUp(leadId) {
    try {
        console.log('[FOLLOW-UP] Marking lead as followed up:', leadId);
        
        const token = state.authToken || localStorage.getItem('token');
        
        if (!token) {
            console.error('[FOLLOW-UP]  No authentication token found');
            showToast('Authentication error: Please refresh and log in again', 'error');
            return;
        }
        
        const response = await fetch(`${API_URL}/api/leads/${leadId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                status: 'contacted',
                last_contact_date: new Date().toISOString()
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to update lead');
        }
        
        const result = await response.json();
        console.log('[FOLLOW-UP]  Lead updated successfully:', result);
        
        showToast(' Marked as contacted', 'success');
        
        updateBadges();
        const contentArea = document.getElementById('contentArea');
        if (contentArea) {
            await renderFollowUps(contentArea);
        }
        
    } catch (error) {
        console.error('[FOLLOW-UP]  Error:', error);
        showToast('Failed to mark as contacted: ' + error.message, 'error');
    }
}

// ---- AUTO-CAMPAIGN ACTION HANDLERS ----

function openCampaignEdit(id) {
    const row = document.getElementById('campEdit_' + id);
    if (row) row.style.display = 'table-row';
}
function closeCampaignEdit(id) {
    const row = document.getElementById('campEdit_' + id);
    if (row) row.style.display = 'none';
}

async function saveCampaignEdit(id) {
    const subject = document.getElementById('campEditSubj_' + id)?.value;
    const body = document.getElementById('campEditBody_' + id)?.value;
    if (!subject || !body) { showToast('Subject and message are required', 'error'); return; }

    try {
        const res = await fetch(`${API_URL}/api/auto-campaigns/${id}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ subject, body })
        });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast('Campaign updated', 'success');
            closeCampaignEdit(id);
            await renderFollowUps(document.getElementById('contentArea'));
        } else {
            showToast('Failed: ' + (data.message || 'Unknown error'), 'error');
        }
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function toggleCampaign(id, currentlyActive) {
    try {
        const res = await fetch(`${API_URL}/api/auto-campaigns/${id}/toggle`, {
            method: 'PATCH',
            headers: { 'Authorization': `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast(currentlyActive ? 'Campaign paused  lead will reappear in normal follow-ups' : 'Campaign resumed', currentlyActive ? 'warning' : 'success');
            await renderFollowUps(document.getElementById('contentArea'));
        } else {
            showToast('Failed: ' + (data.message||''), 'error');
        }
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function removeCampaign(id) {
    if (!confirm('Remove this auto-campaign? The lead will reappear in the normal follow-up list on their next due date.')) return;
    try {
        const res = await fetch(`${API_URL}/api/auto-campaigns/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast('Campaign removed', 'success');
            await renderFollowUps(document.getElementById('contentArea'));
        } else {
            showToast('Failed: ' + (data.message||''), 'error');
        }
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

// Mark lead as contacted
async function markFollowedUp(leadId) {
    try {
        console.log('[FOLLOW-UP] Marking lead as followed up:', leadId);
        
        const token = state.authToken || localStorage.getItem('token');
        
        if (!token) {
            console.error('[FOLLOW-UP]  No authentication token found');
            showToast('Authentication error: Please refresh and log in again', 'error');
            return;
        }
        
        const response = await fetch(`${API_URL}/api/leads/${leadId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                status: 'contacted',
                last_contact_date: new Date().toISOString()
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to update lead');
        }
        
        const result = await response.json();
        console.log('[FOLLOW-UP]  Lead updated successfully:', result);
        
        showToast(' Marked as contacted', 'success');
        
        updateBadges();
        const contentArea = document.getElementById('contentArea');
        if (contentArea) {
            await renderFollowUps(contentArea);
        }
        
    } catch (error) {
        console.error('[FOLLOW-UP]  Error:', error);
        showToast('Failed to mark as contacted: ' + error.message, 'error');
    }
}

function getInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(' ');
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

async function testFollowUpSystem() {
    console.log('[TEST] Testing follow-up system...');
    
    const token = getAuthToken();
    console.log('[TEST] Auth token exists:', !!token);
    console.log('[TEST] API_URL:', API_URL);
    
    try {
        // Test stats endpoint
        const statsResponse = await fetch(`${API_URL}/api/follow-ups/stats`, {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        console.log('[TEST] Stats response:', statsResponse.status);
        
        // Test categorized endpoint
        const categorizedResponse = await fetch(`${API_URL}/api/follow-ups/categorized`, {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        console.log('[TEST] Categorized response:', categorizedResponse.status);
        
        if (statsResponse.ok && categorizedResponse.ok) {
            console.log('[TEST]  Follow-up system is working!');
            showToast('Follow-up system is working correctly', 'success');
        } else {
            console.error('[TEST]  Follow-up system has issues');
            showToast('Follow-up system needs attention', 'error');
        }
    } catch (error) {
        console.error('[TEST]  Follow-up system error:', error);
        showToast('Follow-up system error: ' + error.message, 'error');
    }
}


// ========================================
// RECRUITMENT
// ========================================

var recruitmentState = { jobs: [], applications: [], selectedJob: null, selectedApp: null, view: 'applications' };

async function renderRecruitment(content) {
    recruitmentState = { jobs: [], applications: [], selectedJob: null, selectedApp: null, view: 'applications' };
    content.innerHTML = `<div style="opacity:0.5;padding:40px;text-align:center;color:var(--text-muted);">Loading Recruitment...</div>`;
    try {
        await loadRecruitmentData();
        recruitmentState.view = 'applications';
        renderRecruitmentUI(content);
    } catch(e) {
        console.error('[RECRUITMENT]', e);
        content.innerHTML = `<div style="padding:40px;text-align:center;color:var(--status-danger);"><h3>Error loading recruitment data</h3><p style="color:var(--text-muted);margin-top:8px;">${e.message}</p><button class="btn btn-secondary" style="margin-top:16px;" onclick="renderRecruitment(document.getElementById('contentArea'))">Retry</button></div>`;
    }
}

async function loadRecruitmentData() {
    const token = getAuthToken();
    if (!token) throw new Error('Not authenticated  please log in again.');

    let jobsRes, appsRes;
    try {
        [jobsRes, appsRes] = await Promise.all([
            fetch(`${API_URL}/api/admin/jobs`, { headers: { Authorization: `Bearer ${token}` } }),
            fetch(`${API_URL}/api/admin/applications`, { headers: { Authorization: `Bearer ${token}` } })
        ]);
    } catch (networkErr) {
        throw new Error('Network error  check that your server is running. (' + networkErr.message + ')');
    }

    if (!jobsRes.ok) throw new Error('Jobs endpoint returned ' + jobsRes.status + '. Deploy the updated server.js first.');
    if (!appsRes.ok) throw new Error('Applications endpoint returned ' + appsRes.status + '. Deploy the updated server.js first.');

    let jobsData, appsData;
    try {
        jobsData = await jobsRes.json();
        appsData = await appsRes.json();
    } catch (parseErr) {
        throw new Error('Server returned non-JSON response. Deploy the updated server.js first. (' + parseErr.message + ')');
    }

    recruitmentState.jobs        = (jobsData && jobsData.jobs)               ? jobsData.jobs               : [];
    recruitmentState.applications = (appsData && appsData.applications)      ? appsData.applications       : [];
}

function renderRecruitmentUI(content) {
    const jobs = recruitmentState.jobs;
    const apps = recruitmentState.applications;
    const filterJobId = recruitmentState.selectedJob;
    const filteredApps = filterJobId ? apps.filter(a => String(a.job_id) === String(filterJobId)) : apps;

    // Stats
    const totalApps = apps.length;
    const newApps = apps.filter(a => a.status === 'new').length;
    const publishedJobs = jobs.filter(j => j.published).length;
    const totalJobs = jobs.length;

    content.innerHTML = `
    <!-- Recruitment Stats -->
    <div class="stats-grid" style="margin-bottom:24px;">
        <div class="stat-card" style="border-top:3px solid var(--accent-amber);">
            <div class="stat-header"><span class="stat-label">Open Positions</span>
                <div class="stat-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>
            </div>
            <div class="stat-value">${publishedJobs}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">${totalJobs - publishedJobs} draft${totalJobs - publishedJobs !== 1 ? 's' : ''}</div>
        </div>
        <div class="stat-card" style="border-top:3px solid var(--accent-amber);">
            <div class="stat-header"><span class="stat-label">Total Applications</span>
                <div class="stat-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
            </div>
            <div class="stat-value">${totalApps}</div>
        </div>
        <div class="stat-card" style="border-top:3px solid #D4A574;">
            <div class="stat-header"><span class="stat-label">New (Unreviewed)</span>
                <div class="stat-icon" style="background:rgba(212,165,116,0.12);color:#D4A574;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
            </div>
            <div class="stat-value" style="color:#D4A574;">${newApps}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header"><span class="stat-label">Hired</span>
                <div class="stat-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg></div>
            </div>
            <div class="stat-value">${apps.filter(a=>a.status==='hired').length}</div>
        </div>
    </div>

    <!-- Tabs: Applications | Jobs -->
    <div style="display:flex;gap:8px;margin-bottom:20px;align-items:center;flex-wrap:wrap;">
        <button class="btn ${recruitmentState.view==='applications'?'btn-primary':'btn-secondary'}" onclick="switchRecView('applications')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
            Applications
        </button>
        <button class="btn ${recruitmentState.view==='jobs'?'btn-primary':'btn-secondary'}" onclick="switchRecView('jobs')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            Manage Jobs
        </button>
        ${recruitmentState.view === 'applications' ? `
        <select onchange="filterByJob(this.value)" style="margin-left:auto;padding:8px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-tertiary);color:var(--text-primary);font-size:13px;min-width:200px;">
            <option value="">All Positions</option>
            ${jobs.map(j => `<option value="${j.id}" ${String(filterJobId)===String(j.id)?'selected':''}>
                ${j.title} (${apps.filter(a=>String(a.job_id)===String(j.id)).length})
                ${j.published ? '' : ' [Draft]'}
            </option>`).join('')}
        </select>` : ''}
    </div>

    <!-- Content area -->
    <div id="recContentArea">
    ${recruitmentState.view === 'applications' ? renderApplicationsTable(filteredApps) : renderJobsTable(jobs)}
    </div>

    <!-- Detail Modal (hidden) -->
    <div id="recDetailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
        <div id="recDetailInner" style="background:var(--bg-secondary);border-radius:var(--radius-lg);width:90%;max-width:720px;max-height:85vh;overflow-y:auto;padding:36px;position:relative;border:1px solid var(--border-default);"></div>
    </div>

    <!-- Job Modal (hidden) -->
    <div id="recJobModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
        <div id="recJobModalInner" style="background:var(--bg-secondary);border-radius:var(--radius-lg);width:90%;max-width:680px;max-height:85vh;overflow-y:auto;padding:36px;position:relative;border:1px solid var(--border-default);"></div>
    </div>
    `;
}

function renderApplicationsTable(apps) {
    if (apps.length === 0) return `<div style="text-align:center;padding:60px 20px;color:var(--text-muted);">No applications found.</div>`;
    return `
    <div class="table-container">
        <table class="data-table">
            <thead><tr>
                <th>Candidate</th>
                <th>Position</th>
                <th>Status</th>
                <th>Experience</th>
                <th>Applied</th>
                <th style="width:140px;">Actions</th>
            </tr></thead>
            <tbody>
            ${apps.map(a => `
                <tr>
                    <td>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="width:36px;height:36px;border-radius:50%;background:var(--bg-elevated);border:1px solid var(--border-default);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:var(--accent-amber);">${getInitials(a.first_name + ' ' + a.last_name)}</div>
                            <div>
                                <div style="font-weight:600;font-size:14px;">${a.first_name} ${a.last_name}</div>
                                <div style="font-size:12px;color:var(--text-muted);">${a.email}</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-size:13px;color:var(--text-secondary);">${a.job_title || ''}</td>
                    <td><span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;background:${getAppStatusBg(a.status)};color:${getAppStatusColor(a.status)};">${a.status}</span></td>
                    <td style="font-size:13px;color:var(--text-secondary);">${a.experience || ''}</td>
                    <td style="font-size:12px;color:var(--text-muted);">${formatDate(a.created_at)}</td>
                    <td>
                        <div style="display:flex;gap:6px;">
                            <button class="btn btn-secondary" style="padding:6px 10px;font-size:11px;" onclick="openAppDetail(${a.id})">View</button>
                            ${a.resume_path ? `<button class="btn btn-secondary" style="padding:6px 10px;font-size:11px;" onclick="downloadResume(${a.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('')}
            </tbody>
        </table>
    </div>`;
}

function renderJobsTable(jobs) {
    if (jobs.length === 0) return `<div style="text-align:center;padding:60px 20px;color:var(--text-muted);">No jobs created yet. Click "Create Job" to add one.</div>`;
    return `
    <div class="table-container">
        <table class="data-table">
            <thead><tr>
                <th>Title</th>
                <th>Department</th>
                <th>Type / Location</th>
                <th>Status</th>
                <th>Applications</th>
                <th style="width:180px;">Actions</th>
            </tr></thead>
            <tbody>
            ${jobs.map(j => {
                const appCount = recruitmentState.applications.filter(a => String(a.job_id) === String(j.id)).length;
                return `
                <tr>
                    <td style="font-weight:600;font-size:14px;">${j.title}</td>
                    <td style="font-size:13px;color:var(--text-secondary);">${j.department}</td>
                    <td style="font-size:13px;color:var(--text-secondary);">${j.type}  ${j.location}</td>
                    <td><span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;background:${j.published ? 'rgba(212,165,116,0.12)' : 'rgba(113,113,122,0.15)'};color:${j.published ? '#D4A574' : '#71717a'};">${j.published ? 'Published' : 'Draft'}</span></td>
                    <td style="font-size:14px;font-weight:600;color:var(--accent-amber);">${appCount}</td>
                    <td>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">
                            <button class="btn btn-secondary" style="padding:6px 10px;font-size:11px;" onclick="openJobModal(${j.id})">Edit</button>
                            <button class="btn btn-secondary" style="padding:6px 10px;font-size:11px;background:${j.published ? 'rgba(239,68,68,0.1)' : 'rgba(212,165,116,0.1)'};color:${j.published ? '#ef4444' : '#D4A574'};" onclick="toggleJobPublished(${j.id}, ${j.published})">
                                ${j.published ? 'Unpublish' : 'Publish'}
                            </button>
                            <button class="btn btn-secondary" style="padding:6px 10px;font-size:11px;color:#ef4444;" onclick="deleteJob(${j.id})">Delete</button>
                        </div>
                    </td>
                </tr>`;
            }).join('')}
            </tbody>
        </table>
    </div>`;
}

function getAppStatusBg(s) {
    const map = { new:'rgba(212,165,116,0.12)', reviewing:'rgba(245,158,11,0.12)', interviewing:'rgba(59,130,246,0.12)', hired:'rgba(212,165,116,0.2)', rejected:'rgba(239,68,68,0.12)', on_hold:'rgba(113,113,122,0.15)' };
    return map[s] || 'rgba(113,113,122,0.15)';
}
function getAppStatusColor(s) {
    const map = { new:'#D4A574', reviewing:'#f59e0b', interviewing:'#3b82f6', hired:'#B88F5F', rejected:'#ef4444', on_hold:'#71717a' };
    return map[s] || '#71717a';
}

function switchRecView(view) {
    recruitmentState.view = view;
    renderRecruitmentUI(document.getElementById('contentArea'));
}

function filterByJob(jobId) {
    recruitmentState.selectedJob = jobId || null;
    renderRecruitmentUI(document.getElementById('contentArea'));
}

//  Application Detail Modal 
function openAppDetail(appId) {
    const app = recruitmentState.applications.find(a => a.id === appId);
    if (!app) return;
    recruitmentState.selectedApp = app;

    const modal = document.getElementById('recDetailModal');
    const inner = document.getElementById('recDetailInner');

    inner.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;">
            <div>
                <h2 style="font-size:22px;font-weight:700;margin-bottom:4px;">${app.first_name} ${app.last_name}</h2>
                <p style="color:var(--text-muted);font-size:14px;">Applied for <strong style="color:var(--text-secondary);">${app.job_title || 'Unknown'}</strong>  ${formatDate(app.created_at)}</p>
            </div>
            <button onclick="closeAppDetail()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:22px;line-height:1;"></button>
        </div>

        <!-- Status Selector -->
        <div style="margin-bottom:20px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <span style="font-size:12px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Status:</span>
            ${['new','reviewing','interviewing','hired','rejected','on_hold'].map(s => `
                <button onclick="updateAppStatus(${app.id},'${s}')" style="padding:5px 12px;border-radius:14px;border:1px solid ${app.status===s?getAppStatusColor(s):'var(--border-default)'};background:${app.status===s?getAppStatusBg(s):'transparent'};color:${app.status===s?getAppStatusColor(s):'var(--text-secondary)'};font-size:11px;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;">${s.replace('_',' ')}</button>
            `).join('')}
        </div>

        <!-- Info Grid -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
            ${[
                ['Email', app.email],
                ['Phone', app.phone],
                ['City / State', [app.city, app.state].filter(Boolean).join(', ') || ''],
                ['Experience', app.experience || ''],
                ['Start Availability', app.start_date || ''],
                ['Expected Salary', app.expected_salary || ''],
                ['Referral Source', app.referral_source || ''],
                ['LinkedIn', app.linkedin_url ? `<a href="${app.linkedin_url}" target="_blank" style="color:var(--accent-amber);text-decoration:none;">${app.linkedin_url}</a>` : ''],
                ['Portfolio', app.portfolio_url ? `<a href="${app.portfolio_url}" target="_blank" style="color:var(--accent-amber);text-decoration:none;">${app.portfolio_url}</a>` : ''],
            ].map(([label, val]) => `
                <div style="background:var(--bg-tertiary);padding:12px 14px;border-radius:var(--radius-md);border:1px solid var(--border-subtle);">
                    <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:4px;">${label}</div>
                    <div style="font-size:13px;color:var(--text-primary);">${val}</div>
                </div>
            `).join('')}
        </div>

        <!-- Cover Letter -->
        ${app.cover_letter ? `
        <div style="margin-bottom:20px;">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:8px;">Cover Letter</div>
            <div style="background:var(--bg-tertiary);padding:16px;border-radius:var(--radius-md);border:1px solid var(--border-subtle);font-size:14px;color:var(--text-secondary);line-height:1.7;white-space:pre-wrap;">${app.cover_letter}</div>
        </div>` : ''}

        <!-- Resume Download -->
        ${app.resume_path ? `
        <div style="margin-bottom:20px;">
            <button class="btn btn-secondary" onclick="downloadResume(${app.id})" style="display:inline-flex;align-items:center;gap:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download Resume (${app.resume_original_name || 'resume'})
            </button>
        </div>` : ''}

        <!-- Admin Notes -->
        <div>
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:8px;">Admin Notes</div>
            <textarea id="appNotesTA" style="width:100%;min-height:100px;background:var(--bg-tertiary);border:1px solid var(--border-default);border-radius:var(--radius-md);padding:12px;color:var(--text-primary);font-size:13px;font-family:var(--font-display);resize:vertical;" placeholder="Add internal notes here...">${app.notes || ''}</textarea>
            <button class="btn btn-secondary" style="margin-top:8px;padding:6px 14px;font-size:12px;" onclick="saveAppNotes(${app.id})">Save Notes</button>
        </div>
    `;

    modal.style.display = 'flex';
}

function closeAppDetail() {
    document.getElementById('recDetailModal').style.display = 'none';
}

async function updateAppStatus(appId, status) {
    try {
        const res = await fetch(`${API_URL}/api/admin/applications/${appId}`, {
            method: 'PATCH',
            headers: { Authorization: `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
        if (res.ok) {
            showToast('Status updated to ' + status, 'success');
            await loadRecruitmentData();
            // Update in-place
            const app = recruitmentState.applications.find(a => a.id === appId);
            if (app) { recruitmentState.selectedApp = app; openAppDetail(appId); }
            renderRecruitmentUI(document.getElementById('contentArea'));
        } else {
            showToast('Failed to update status', 'error');
        }
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function saveAppNotes(appId) {
    const notes = document.getElementById('appNotesTA')?.value || '';
    try {
        const res = await fetch(`${API_URL}/api/admin/applications/${appId}`, {
            method: 'PATCH',
            headers: { Authorization: `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes })
        });
        if (res.ok) { showToast('Notes saved', 'success'); await loadRecruitmentData(); }
        else showToast('Failed to save notes', 'error');
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function downloadResume(appId) {
    try {
        const res = await fetch(`${API_URL}/api/admin/applications/${appId}/resume`, {
            headers: { Authorization: `Bearer ${getAuthToken()}` }
        });
        if (res.ok) {
            const blob = await res.blob();
            const cd = res.headers.get('content-disposition') || '';
            const match = cd.match(/filename="?([^";]+)"?/);
            const filename = match ? match[1] : 'resume';
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        } else showToast('No resume on file', 'error');
    } catch(e) { showToast('Error downloading resume', 'error'); }
}

//  Job Create/Edit Modal 
function openJobModal(jobId) {
    const job = jobId ? recruitmentState.jobs.find(j => j.id === jobId) : null;
    const modal = document.getElementById('recJobModal');
    const inner = document.getElementById('recJobModalInner');

    inner.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
            <h2 style="font-size:20px;font-weight:700;">${job ? 'Edit Job' : 'Create New Job'}</h2>
            <button onclick="closeJobModal()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:22px;"></button>
        </div>
        <div style="display:flex;flex-direction:column;gap:16px;">
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Job Title *</label>
                <input id="jobFormTitle" type="text" value="${job?.title||''}" style="width:100%;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-tertiary);color:var(--text-primary);font-size:14px;" required>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                <div>
                    <label style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Department *</label>
                    <input id="jobFormDept" type="text" value="${job?.department||''}" placeholder="e.g. Engineering" style="width:100%;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-tertiary);color:var(--text-primary);font-size:14px;" required>
                </div>
                <div>
                    <label style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Type *</label>
                    <select id="jobFormType" style="width:100%;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-tertiary);color:var(--text-primary);font-size:14px;">
                        <option value="Full-time" ${job?.type==='Full-time'?'selected':''}>Full-time</option>
                        <option value="Part-time" ${job?.type==='Part-time'?'selected':''}>Part-time</option>
                        <option value="Contract" ${job?.type==='Contract'?'selected':''}>Contract</option>
                        <option value="Internship" ${job?.type==='Internship'?'selected':''}>Internship</option>
                    </select>
                </div>
            </div>
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Location *</label>
                <input id="jobFormLocation" type="text" value="${job?.location||'Remote'}" style="width:100%;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-tertiary);color:var(--text-primary);font-size:14px;" required>
            </div>
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Description *</label>
                <textarea id="jobFormDesc" style="width:100%;min-height:120px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-tertiary);color:var(--text-primary);font-size:14px;font-family:var(--font-display);resize:vertical;" required>${job?.description||''}</textarea>
            </div>
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Duties (one per line)</label>
                <textarea id="jobFormDuties" style="width:100%;min-height:100px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-tertiary);color:var(--text-primary);font-size:14px;font-family:var(--font-display);resize:vertical;">${(job?.duties||[]).join('\n')}</textarea>
            </div>
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Requirements (one per line)</label>
                <textarea id="jobFormReqs" style="width:100%;min-height:100px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-tertiary);color:var(--text-primary);font-size:14px;font-family:var(--font-display);resize:vertical;">${(job?.requirements||[]).join('\n')}</textarea>
            </div>
            <div style="display:flex;align-items:center;gap:10px;padding:12px 0;border-top:1px solid var(--border-subtle);">
                <label style="position:relative;width:44px;height:24px;">
                    <input type="checkbox" id="jobFormPublished" ${job?.published?'checked':''} style="opacity:0;width:0;height:0;">
                    <span style="position:absolute;inset:0;background:var(--bg-hover);border-radius:24px;cursor:pointer;transition:0.2s;" onclick="this.parentElement.querySelector('input').click()"></span>
                    <span style="position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:var(--text-muted);border-radius:50%;transition:0.2s;pointer-events:none;"></span>
                </label>
                <span style="font-size:13px;color:var(--text-secondary);">Publish to careers page</span>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px;">
                <button class="btn btn-secondary" onclick="closeJobModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveJob(${jobId||'null'})">
                    ${job ? 'Save Changes' : 'Create Job'}
                </button>
            </div>
        </div>
    `;

    // Toggle switch styling
    const checkbox = document.getElementById('jobFormPublished');
    const track = inner.querySelector('label span:first-of-type');
    const thumb = inner.querySelector('label span:last-of-type');
    function updateToggle() {
        if (checkbox.checked) { track.style.background = 'var(--accent-amber)'; thumb.style.left = '23px'; }
        else { track.style.background = 'var(--bg-hover)'; thumb.style.left = '3px'; }
    }
    checkbox.addEventListener('change', updateToggle);
    updateToggle();

    modal.style.display = 'flex';
}

function closeJobModal() {
    document.getElementById('recJobModal').style.display = 'none';
}

async function saveJob(jobId) {
    const title = document.getElementById('jobFormTitle').value.trim();
    const department = document.getElementById('jobFormDept').value.trim();
    const type = document.getElementById('jobFormType').value;
    const location = document.getElementById('jobFormLocation').value.trim();
    const description = document.getElementById('jobFormDesc').value.trim();
    const duties = document.getElementById('jobFormDuties').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const requirements = document.getElementById('jobFormReqs').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const published = document.getElementById('jobFormPublished').checked;

    if (!title || !department || !type || !location || !description) {
        showToast('Please fill in all required fields', 'error');
        return;
    }

    const payload = { title, department, type, location, description, duties, requirements, published };
    try {
        let res;
        if (jobId) {
            res = await fetch(`${API_URL}/api/admin/jobs/${jobId}`, {
                method: 'PUT',
                headers: { Authorization: `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            res = await fetch(`${API_URL}/api/admin/jobs`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }
        const data = await res.json();
        if (res.ok && data.success) {
            showToast(jobId ? 'Job updated' : 'Job created', 'success');
            closeJobModal();
            await loadRecruitmentData();
            renderRecruitmentUI(document.getElementById('contentArea'));
        } else {
            showToast('Failed: ' + (data.message || 'Unknown error'), 'error');
        }
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function toggleJobPublished(jobId, currentlyPublished) {
    try {
        const res = await fetch(`${API_URL}/api/admin/jobs/${jobId}`, {
            method: 'PUT',
            headers: { Authorization: `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ published: !currentlyPublished })
        });
        if (res.ok) {
            showToast(currentlyPublished ? 'Job unpublished' : 'Job published to careers page', currentlyPublished ? 'warning' : 'success');
            await loadRecruitmentData();
            renderRecruitmentUI(document.getElementById('contentArea'));
        } else showToast('Failed to update', 'error');
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function deleteJob(jobId) {
    if (!confirm('Delete this job? All applications for it will be orphaned.')) return;
    try {
        const res = await fetch(`${API_URL}/api/admin/jobs/${jobId}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${getAuthToken()}` }
        });
        if (res.ok) {
            showToast('Job deleted', 'success');
            await loadRecruitmentData();
            renderRecruitmentUI(document.getElementById('contentArea'));
        } else showToast('Failed to delete', 'error');
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

</script>
</body>
</html>