<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM — Diamondback Coding</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
/* ============================================================
   DIAMONDBACK CRM — Attio-style
   Black & white, modern, minimal
============================================================ */

:root {
    --bg-0: #000000;
    --bg-1: #0a0a0a;
    --bg-2: #111111;
    --bg-3: #191919;
    --bg-hover: #1f1f1f;
    --bg-active: #252525;
    --border: #2a2a2a;
    --border-light: #222222;
    --text-0: #ffffff;
    --text-1: #ebebeb;
    --text-2: #a1a1a1;
    --text-3: #666666;
    --accent: #ffffff;
    --accent-dim: rgba(255,255,255,0.08);
    --green: #22c55e;
    --green-dim: rgba(34,197,94,0.12);
    --yellow: #f59e0b;
    --yellow-dim: rgba(245,158,11,0.12);
    --red: #ef4444;
    --red-dim: rgba(239,68,68,0.12);
    --blue: #3b82f6;
    --blue-dim: rgba(59,130,246,0.12);
    --purple: #a855f7;
    --r-sm: 6px;
    --r-md: 8px;
    --r-lg: 12px;
    --sidebar-w: 240px;
    --font: 'Geist', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'Geist Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
    font-family: var(--font);
    background: var(--bg-1);
    color: var(--text-1);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
}

/* ============================================================
   LOGIN
============================================================ */
.login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-0);
    padding: 24px;
}
.login-box {
    width: 100%;
    max-width: 400px;
    animation: fadeUp 0.4s ease;
}
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
}
.login-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 40px;
}
.login-logo-mark {
    width: 32px; height: 32px;
    background: var(--text-0);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
}
.login-logo-mark svg { color: var(--bg-0); width: 18px; height: 18px; }
.login-logo-name { font-size: 15px; font-weight: 600; color: var(--text-0); }
.login-logo-sub { font-size: 12px; color: var(--text-3); }
.login-heading { font-size: 24px; font-weight: 600; margin-bottom: 6px; color: var(--text-0); }
.login-sub { font-size: 14px; color: var(--text-3); margin-bottom: 32px; }
.field { margin-bottom: 16px; }
.field label { display: block; font-size: 12px; font-weight: 500; color: var(--text-2); margin-bottom: 6px; letter-spacing: 0.02em; text-transform: uppercase; }
.field input {
    width: 100%; padding: 10px 14px;
    background: var(--bg-2); border: 1px solid var(--border);
    border-radius: var(--r-md); color: var(--text-0);
    font-size: 14px; font-family: var(--font);
    transition: border-color 0.15s, box-shadow 0.15s;
}
.field input:focus { outline: none; border-color: rgba(255,255,255,0.3); box-shadow: 0 0 0 3px rgba(255,255,255,0.05); }
.field input::placeholder { color: var(--text-3); }
.btn-primary {
    width: 100%; padding: 11px;
    background: var(--text-0); color: var(--bg-0);
    border: none; border-radius: var(--r-md);
    font-size: 14px; font-weight: 600; font-family: var(--font);
    cursor: pointer; transition: opacity 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-primary:hover { opacity: 0.9; }
.btn-primary:disabled { opacity: 0.5; cursor: default; }
.login-error {
    display: none; background: var(--red-dim); border: 1px solid rgba(239,68,68,0.2);
    color: var(--red); padding: 10px 14px; border-radius: var(--r-md);
    font-size: 13px; margin-bottom: 16px; align-items: center; gap: 8px;
}
.login-error.show { display: flex; }

/* ============================================================
   APP LAYOUT
============================================================ */
.app { display: none; min-height: 100vh; background: var(--bg-1); }
.app.visible { display: flex; }

/* ============================================================
   SIDEBAR
============================================================ */
.sidebar {
    width: var(--sidebar-w);
    background: var(--bg-0);
    border-right: 1px solid var(--border);
    height: 100vh; position: fixed;
    display: flex; flex-direction: column;
    z-index: 100;
    overflow-y: auto;
}
.sidebar-top {
    padding: 20px 16px 12px;
    border-bottom: 1px solid var(--border);
}
.sidebar-brand {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 8px; border-radius: var(--r-md);
    cursor: default;
}
.sidebar-brand-icon {
    width: 28px; height: 28px; background: var(--text-0);
    border-radius: 7px; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.sidebar-brand-icon svg { width: 15px; height: 15px; color: var(--bg-0); }
.sidebar-brand-name { font-size: 13px; font-weight: 600; color: var(--text-0); }
.sidebar-brand-sub { font-size: 11px; color: var(--text-3); }
.sidebar-nav {
    padding: 12px 8px;
    flex: 1;
}
.nav-section { margin-bottom: 20px; }
.nav-section-title {
    font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text-3);
    padding: 0 8px 6px;
}
.nav-item {
    display: flex; align-items: center; gap: 9px;
    padding: 7px 8px; border-radius: var(--r-sm);
    cursor: pointer; color: var(--text-2);
    font-size: 13px; font-weight: 450;
    transition: background 0.1s, color 0.1s;
    text-decoration: none; position: relative;
    user-select: none;
}
.nav-item:hover { background: var(--bg-hover); color: var(--text-0); }
.nav-item.active { background: var(--bg-active); color: var(--text-0); font-weight: 500; }
.nav-item svg { width: 15px; height: 15px; flex-shrink: 0; opacity: 0.7; }
.nav-item.active svg { opacity: 1; }
.nav-badge {
    margin-left: auto; background: var(--red);
    color: #fff; font-size: 10px; font-weight: 700;
    padding: 1px 6px; border-radius: 10px;
}
.nav-item-admin-only { display: none; }
.settings-admin-only { display: none; }
.sidebar-footer {
    padding: 12px 8px;
    border-top: 1px solid var(--border);
}
.user-card {
    display: flex; align-items: center; gap: 10px;
    padding: 8px; border-radius: var(--r-md);
}
.user-avatar {
    width: 30px; height: 30px;
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 600; color: var(--text-1);
    flex-shrink: 0;
}
.user-info-text { flex: 1; min-width: 0; }
.user-name { font-size: 13px; font-weight: 500; color: var(--text-0); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-role { font-size: 11px; color: var(--text-3); }
.logout-btn {
    background: none; border: none; cursor: pointer;
    color: var(--text-3); padding: 4px;
    border-radius: var(--r-sm); transition: color 0.15s, background 0.15s;
}
.logout-btn:hover { color: var(--red); background: var(--red-dim); }
.logout-btn svg { width: 14px; height: 14px; display: block; }

/* ============================================================
   MAIN CONTENT
============================================================ */
.main {
    margin-left: var(--sidebar-w);
    flex: 1; min-height: 100vh;
    display: flex; flex-direction: column;
}
.page { display: none; flex: 1; flex-direction: column; }
.page.active { display: flex; }
.page-header {
    padding: 20px 32px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg-1);
    flex-shrink: 0;
    position: sticky; top: 0; z-index: 50;
}
.page-title-group {}
.page-title { font-size: 16px; font-weight: 600; color: var(--text-0); }
.page-subtitle { font-size: 13px; color: var(--text-3); margin-top: 2px; }
.page-actions { display: flex; gap: 8px; align-items: center; }
.page-body { padding: 24px 32px; flex: 1; }

/* ============================================================
   BUTTONS
============================================================ */
.btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: var(--r-sm);
    font-size: 13px; font-weight: 500; font-family: var(--font);
    cursor: pointer; transition: all 0.15s; border: 1px solid transparent;
    white-space: nowrap;
}
.btn svg { width: 14px; height: 14px; }
.btn-default { background: var(--bg-3); color: var(--text-1); border-color: var(--border); }
.btn-default:hover { background: var(--bg-hover); color: var(--text-0); }
.btn-white { background: var(--text-0); color: var(--bg-0); }
.btn-white:hover { opacity: 0.88; }
.btn-ghost { background: transparent; color: var(--text-2); border-color: transparent; }
.btn-ghost:hover { background: var(--bg-hover); color: var(--text-0); }
.btn-danger { background: var(--red-dim); color: var(--red); border-color: rgba(239,68,68,0.2); }
.btn-danger:hover { background: rgba(239,68,68,0.18); }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-xs { padding: 3px 8px; font-size: 11px; }

/* ============================================================
   STATS ROW
============================================================ */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1px; background: var(--border);
    border: 1px solid var(--border); border-radius: var(--r-lg);
    overflow: hidden; margin-bottom: 24px;
}
.stat-cell {
    background: var(--bg-2); padding: 20px 24px;
}
.stat-label { font-size: 11px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.06em; font-weight: 600; margin-bottom: 8px; }
.stat-value { font-size: 28px; font-weight: 600; color: var(--text-0); letter-spacing: -0.03em; }
.stat-sub { font-size: 12px; color: var(--text-3); margin-top: 4px; }

/* ============================================================
   TABLES
============================================================ */
.table-wrap {
    border: 1px solid var(--border); border-radius: var(--r-lg);
    overflow: hidden;
}
table { width: 100%; border-collapse: collapse; }
thead { background: var(--bg-2); }
th {
    text-align: left; padding: 11px 16px;
    font-size: 11px; font-weight: 600; color: var(--text-3);
    text-transform: uppercase; letter-spacing: 0.06em;
    border-bottom: 1px solid var(--border);
}
td { padding: 12px 16px; font-size: 13px; border-bottom: 1px solid var(--border-light); }
tr:last-child td { border-bottom: none; }
tbody tr { cursor: default; transition: background 0.1s; }
tbody tr:hover { background: var(--bg-hover); }

/* ============================================================
   BADGES / STATUS
============================================================ */
.badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 8px; border-radius: 20px;
    font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
}
.badge-green { background: var(--green-dim); color: var(--green); }
.badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
.badge-red { background: var(--red-dim); color: var(--red); }
.badge-blue { background: var(--blue-dim); color: var(--blue); }
.badge-gray { background: var(--bg-3); color: var(--text-3); }
.badge-purple { background: rgba(168,85,247,0.12); color: var(--purple); }
.badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

/* ============================================================
   CARDS
============================================================ */
.card {
    background: var(--bg-2); border: 1px solid var(--border);
    border-radius: var(--r-lg); margin-bottom: 16px;
}
.card-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
}
.card-title { font-size: 14px; font-weight: 600; color: var(--text-0); }
.card-body { padding: 20px; }

/* ============================================================
   MODAL
============================================================ */
.modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    z-index: 9999; display: none;
    align-items: center; justify-content: center; padding: 20px;
}
.modal-overlay.open { display: flex; }
.modal {
    background: var(--bg-2); border: 1px solid var(--border);
    border-radius: var(--r-lg); width: 100%; max-width: 520px;
    max-height: 90vh; overflow-y: auto;
    animation: fadeUp 0.2s ease;
    position: relative;
}
.modal-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-size: 15px; font-weight: 600; color: var(--text-0); }
.modal-close {
    background: none; border: none; cursor: pointer;
    color: var(--text-3); padding: 4px; border-radius: 4px;
    transition: color 0.15s, background 0.15s;
}
.modal-close:hover { color: var(--text-0); background: var(--bg-hover); }
.modal-close svg { width: 16px; height: 16px; display: block; }
.modal-body { padding: 20px 24px; }
.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex; gap: 8px; justify-content: flex-end;
}

/* Form fields inside modal */
.form-field { margin-bottom: 16px; }
.form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-2); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.02em; }
.form-input {
    width: 100%; padding: 9px 12px;
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: var(--r-sm); color: var(--text-0);
    font-size: 13px; font-family: var(--font);
    transition: border-color 0.15s;
}
.form-input:focus { outline: none; border-color: rgba(255,255,255,0.25); }
.form-input::placeholder { color: var(--text-3); }
.form-select {
    width: 100%; padding: 9px 12px;
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: var(--r-sm); color: var(--text-0);
    font-size: 13px; font-family: var(--font);
    cursor: pointer;
    -webkit-appearance: none;
}
.form-select:focus { outline: none; border-color: rgba(255,255,255,0.25); }
textarea.form-input { resize: vertical; min-height: 90px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-hint { font-size: 11px; color: var(--text-3); margin-top: 5px; }

/* ============================================================
   EMPTY STATE
============================================================ */
.empty-state {
    text-align: center; padding: 60px 24px; color: var(--text-3);
}
.empty-state svg { width: 40px; height: 40px; opacity: 0.3; margin-bottom: 12px; }
.empty-state h3 { font-size: 15px; font-weight: 500; color: var(--text-2); margin-bottom: 6px; }
.empty-state p { font-size: 13px; }

/* ============================================================
   SPINNER
============================================================ */
.spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid currentColor; border-top-color: transparent;
    border-radius: 50%; animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ============================================================
   NOTIFICATION TOAST
============================================================ */
.toast-container {
    position: fixed; bottom: 24px; right: 24px; z-index: 99999;
    display: flex; flex-direction: column; gap: 8px;
}
.toast {
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: var(--r-md); padding: 12px 16px;
    font-size: 13px; color: var(--text-1);
    display: flex; align-items: center; gap: 10px;
    animation: slideIn 0.25s ease; max-width: 320px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.toast.success { border-color: rgba(34,197,94,0.3); }
.toast.error { border-color: rgba(239,68,68,0.3); }
.toast svg { flex-shrink: 0; width: 15px; height: 15px; }
.toast.success svg { color: var(--green); }
.toast.error svg { color: var(--red); }
@keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* ============================================================
   CONTACTS / LEADS TABLE ROW INTERACTIONS
============================================================ */
.row-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.1s; }
tr:hover .row-actions { opacity: 1; }

/* ============================================================
   PIPELINE KANBAN
============================================================ */
.kanban { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 16px; }
.kanban-col {
    min-width: 260px; background: var(--bg-2);
    border: 1px solid var(--border); border-radius: var(--r-lg);
    display: flex; flex-direction: column;
}
.kanban-col-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
}
.kanban-col-title { font-size: 13px; font-weight: 600; color: var(--text-1); }
.kanban-count { font-size: 11px; color: var(--text-3); background: var(--bg-3); padding: 2px 7px; border-radius: 10px; }
.kanban-cards { padding: 10px; flex: 1; display: flex; flex-direction: column; gap: 8px; }
.kanban-card {
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: var(--r-md); padding: 12px;
    cursor: pointer; transition: border-color 0.15s, background 0.15s;
}
.kanban-card:hover { border-color: rgba(255,255,255,0.15); background: var(--bg-hover); }
.kanban-card-name { font-size: 13px; font-weight: 500; color: var(--text-0); margin-bottom: 4px; }
.kanban-card-meta { font-size: 11px; color: var(--text-3); }
.kanban-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }

/* ============================================================
   PROGRESS BAR
============================================================ */
.progress { background: var(--bg-3); border-radius: 100px; height: 6px; overflow: hidden; }
.progress-bar { background: var(--text-0); height: 100%; border-radius: 100px; transition: width 0.3s; }

/* ============================================================
   TIMELINE
============================================================ */
.timeline { position: relative; padding-left: 28px; }
.timeline::before { content: ''; position: absolute; left: 6px; top: 0; bottom: 0; width: 1px; background: var(--border); }
.timeline-item { position: relative; padding-bottom: 24px; }
.timeline-dot {
    position: absolute; left: -26px; top: 4px;
    width: 12px; height: 12px; border-radius: 50%;
    background: var(--bg-3); border: 2px solid var(--border); z-index: 1;
}
.timeline-date { font-size: 11px; color: var(--text-3); margin-bottom: 4px; font-weight: 500; }
.timeline-text { font-size: 13px; color: var(--text-1); }
.timeline-sub { font-size: 12px; color: var(--text-3); margin-top: 2px; }

/* ============================================================
   SUBSCRIPTION PLAN CARDS
============================================================ */
.plan-card {
    border: 2px solid var(--border); border-radius: var(--r-lg);
    padding: 20px; cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
}
.plan-card:hover { border-color: rgba(255,255,255,0.2); }
.plan-card.selected { border-color: var(--text-0); background: rgba(255,255,255,0.03); }
.plan-card.current { border-color: var(--green); }
.plan-name { font-size: 14px; font-weight: 600; color: var(--text-0); margin-bottom: 4px; }
.plan-price { font-size: 22px; font-weight: 700; color: var(--text-0); }
.plan-price span { font-size: 12px; font-weight: 400; color: var(--text-3); }
.plan-desc { font-size: 12px; color: var(--text-3); margin-top: 4px; }

/* ============================================================
   TEAM PERFORMANCE
============================================================ */
.perf-row {
    display: flex; align-items: center; gap: 16px;
    padding: 12px 0; border-bottom: 1px solid var(--border-light);
}
.perf-row:last-child { border-bottom: none; }
.perf-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-3); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: var(--text-1); flex-shrink: 0; }
.perf-name { flex: 1; font-size: 13px; font-weight: 500; color: var(--text-0); }
.perf-meta { font-size: 12px; color: var(--text-3); }
.perf-stats { display: flex; gap: 20px; }
.perf-stat { text-align: right; }
.perf-stat-val { font-size: 14px; font-weight: 600; color: var(--text-0); }
.perf-stat-label { font-size: 10px; color: var(--text-3); text-transform: uppercase; }

/* ============================================================
   SCHEDULER
============================================================ */
.cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; }
.cal-day-name { font-size: 11px; color: var(--text-3); text-align: center; padding: 4px; font-weight: 600; text-transform: uppercase; }
.cal-day {
    aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
    border-radius: var(--r-sm); font-size: 13px; color: var(--text-2);
    cursor: pointer; transition: background 0.1s;
}
.cal-day:hover { background: var(--bg-hover); color: var(--text-0); }
.cal-day.today { background: var(--text-0); color: var(--bg-0); font-weight: 600; }
.cal-day.has-event { position: relative; }
.cal-day.has-event::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--blue); }

/* ============================================================
   FILE UPLOAD
============================================================ */
.upload-zone {
    border: 2px dashed var(--border); border-radius: var(--r-lg);
    padding: 40px 24px; text-align: center; cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
}
.upload-zone:hover, .upload-zone.drag { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.02); }
.upload-zone svg { width: 36px; height: 36px; color: var(--text-3); margin-bottom: 12px; }
.upload-zone p { font-size: 14px; color: var(--text-2); }
.upload-zone small { font-size: 12px; color: var(--text-3); }

/* ============================================================
   FOLLOW-UP AUTO REPLY BUILDER
============================================================ */
.template-card {
    border: 1px solid var(--border); border-radius: var(--r-md);
    padding: 14px; margin-bottom: 10px;
}
.template-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.template-card-name { font-size: 13px; font-weight: 500; color: var(--text-0); }

/* ============================================================
   INLINE DETAIL PANEL (right drawer)
============================================================ */
.detail-panel {
    position: fixed; right: 0; top: 0; bottom: 0;
    width: 400px; background: var(--bg-1);
    border-left: 1px solid var(--border); z-index: 200;
    display: none; flex-direction: column;
    animation: slideInRight 0.2s ease;
}
.detail-panel.open { display: flex; }
@keyframes slideInRight { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.detail-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.detail-body { flex: 1; overflow-y: auto; padding: 20px; }
.detail-section { margin-bottom: 24px; }
.detail-section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-3); margin-bottom: 10px; }
.detail-field { margin-bottom: 10px; }
.detail-field-label { font-size: 11px; color: var(--text-3); margin-bottom: 3px; }
.detail-field-value { font-size: 13px; color: var(--text-1); }

/* ============================================================
   NOTE ITEM
============================================================ */
.note-item { padding: 12px; background: var(--bg-3); border-radius: var(--r-md); margin-bottom: 8px; }
.note-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
.note-author { font-size: 12px; font-weight: 600; color: var(--text-0); }
.note-time { font-size: 11px; color: var(--text-3); }
.note-body { font-size: 13px; color: var(--text-2); line-height: 1.5; }

/* ============================================================
   USER COUNT CONTROL
============================================================ */
.qty-control { display: flex; align-items: center; gap: 8px; }
.qty-btn {
    width: 32px; height: 32px; background: var(--bg-3); border: 1px solid var(--border);
    border-radius: var(--r-sm); color: var(--text-1); cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center; transition: background 0.15s;
}
.qty-btn:hover { background: var(--bg-hover); }
.qty-input {
    width: 60px; text-align: center; padding: 7px;
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: var(--r-sm); color: var(--text-0);
    font-size: 14px; font-weight: 600; font-family: var(--font);
}
.qty-input:focus { outline: none; border-color: rgba(255,255,255,0.2); }

/* ============================================================
   ADD USER POPUP (within CRM)
============================================================ */
.add-user-modal .modal { max-width: 600px; }

/* ============================================================
   VALIDATION DIALOG
============================================================ */
.validation-box {
    background: var(--bg-3); border: 1px solid var(--border);
    border-radius: var(--r-md); padding: 16px; margin-bottom: 16px;
}
.validation-box h4 { font-size: 13px; font-weight: 600; color: var(--text-0); margin-bottom: 4px; }
.validation-box p { font-size: 12px; color: var(--text-2); }

/* ============================================================
   SEARCH INPUT
============================================================ */
.search-input {
    display: flex; align-items: center; gap: 8px;
    background: var(--bg-2); border: 1px solid var(--border);
    border-radius: var(--r-sm); padding: 6px 12px;
    transition: border-color 0.15s;
}
.search-input:focus-within { border-color: rgba(255,255,255,0.2); }
.search-input svg { color: var(--text-3); width: 14px; height: 14px; flex-shrink: 0; }
.search-input input {
    background: none; border: none; color: var(--text-0);
    font-size: 13px; font-family: var(--font); width: 200px;
}
.search-input input:focus { outline: none; }
.search-input input::placeholder { color: var(--text-3); }

/* ============================================================
   OVERVIEW DASHBOARD
============================================================ */
.dash-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
}
.col-8 { grid-column: span 8; }
.col-4 { grid-column: span 4; }
.col-6 { grid-column: span 6; }
.col-12 { grid-column: span 12; }

.activity-item {
    display: flex; gap: 12px; padding: 10px 0;
    border-bottom: 1px solid var(--border-light);
}
.activity-item:last-child { border-bottom: none; }
.activity-icon {
    width: 28px; height: 28px;
    background: var(--bg-3); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.activity-icon svg { width: 12px; height: 12px; color: var(--text-2); }
.activity-text { font-size: 13px; color: var(--text-1); }
.activity-time { font-size: 11px; color: var(--text-3); margin-top: 2px; }

/* ============================================================
   RESPONSIVE
============================================================ */
@media (max-width: 900px) {
    :root { --sidebar-w: 220px; }
    .col-8, .col-4, .col-6 { grid-column: span 12; }
    .page-body { padding: 16px; }
    .page-header { padding: 16px; }
}
@media (max-width: 640px) {
    .sidebar { display: none; }
    .main { margin-left: 0; }
}

/* ============================================================
   SCROLLBAR
============================================================ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }
    </style>
</head>
<body>

<!-- ============================================================
     LOGIN SCREEN
============================================================ -->
<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <div class="login-logo">
            <div class="login-logo-mark">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div>
                <div class="login-logo-name">Diamondback Coding</div>
                <div class="login-logo-sub">CRM Platform</div>
            </div>
        </div>

        <h1 class="login-heading">Sign in</h1>
        <p class="login-sub">Access your CRM workspace</p>

        <div id="loginError" class="login-error">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            <span id="loginErrorText"></span>
        </div>

        <form id="loginForm">
            <div class="field">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="you@company.com" required autocomplete="email">
            </div>
            <div class="field">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="••••••••" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn-primary" id="loginBtn">
                Sign in
            </button>
        </form>

        <p style="margin-top:20px;font-size:12px;color:var(--text-3);text-align:center;">
            Need access? Contact your account manager or call (512) 980-0393
        </p>
    </div>
</div>

<!-- ============================================================
     APP
============================================================ -->
<div id="app" class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-top">
            <div class="sidebar-brand">
                <div class="sidebar-brand-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <div>
                    <div class="sidebar-brand-name">Diamondback</div>
                    <div style="font-size:11px;color:var(--text-3);">CRM</div>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <!-- MAIN -->
            <div class="nav-section">
                <div class="nav-section-title">Workspace</div>

                <div class="nav-item active" data-page="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    Dashboard
                </div>
                <div class="nav-item nav-item-admin-only" data-page="leads">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Leads
                </div>
                <div class="nav-item" data-page="myleads">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/><path d="M12 14v7"/><path d="M9 17h6"/></svg>
                    My Leads
                </div>
                <div class="nav-item nav-item-admin-only" data-page="contacts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Contacts
                </div>
                <div class="nav-item nav-item-admin-only" data-page="followups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    Follow-ups
                </div>
                <div class="nav-item nav-item-admin-only" data-page="marketing">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    Marketing
                </div>
                <div class="nav-item nav-item-admin-only" data-page="scheduling">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Scheduling
                </div>
            </div>

            <!-- FINANCIALS -->
            <div class="nav-section">
                <div class="nav-section-title">Financials</div>
                <div class="nav-item nav-item-admin-only" data-page="invoices">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Invoices
                </div>
                <div class="nav-item nav-item-admin-only" data-page="analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    Analytics
                </div>
            </div>

            <!-- ACCOUNT -->
            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <div class="nav-item" data-page="tasks">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    Tasks
                </div>
                <!-- Admin-only items hidden for regular users -->
                <div class="nav-item nav-item-admin-only" data-page="team" id="navTeam">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Team
                </div>
                <div class="nav-item nav-item-admin-only" data-page="company" id="navCompany">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="15" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
                    Company
                </div>
                <div class="nav-item" data-page="files" id="navFiles">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                    Files
                    <span class="nav-badge" id="navFilesBadge" style="display:none;"></span>
                </div>
                <div class="nav-item" data-page="support" id="navSupport">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    Support
                    <span class="nav-badge" id="ticketBadge" style="display:none;"></span>
                </div>
                <div class="nav-item" data-page="subscription" id="navSubscription">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                    Subscription
                </div>
                <div class="nav-item" data-page="settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    Settings
                </div>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-card">
                <div class="user-avatar" id="sidebarAvatar">--</div>
                <div class="user-info-text">
                    <div class="user-name" id="sidebarName">Loading...</div>
                    <div class="user-role" id="sidebarRole">Member</div>
                </div>
                <button class="logout-btn" onclick="logout()" title="Sign out">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">

        <!-- ==============================
             DASHBOARD
        ============================== -->
        <div class="page active" id="page-dashboard">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title" id="dashGreeting">Good morning</div>
                    <div class="page-subtitle">Here's what's happening today</div>
                </div>
                <div class="page-actions">
                    <button class="btn btn-default" onclick="navigate('leads')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        New Lead
                    </button>
                </div>
            </div>
            <div class="page-body">
                <div id="dashStats" class="stats-row">
                    <div class="stat-cell"><div class="stat-label">Total Leads</div><div class="stat-value" id="dStat1">—</div></div>
                    <div class="stat-cell"><div class="stat-label">Contacts</div><div class="stat-value" id="dStat2">—</div></div>
                    <div class="stat-cell"><div class="stat-label">Open Tasks</div><div class="stat-value" id="dStat3">—</div></div>
                    <div class="stat-cell"><div class="stat-label">Revenue (MTD)</div><div class="stat-value" id="dStat4">—</div></div>
                </div>
                <div class="dash-grid">
                    <div class="col-8">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Recent Activity</span></div>
                            <div class="card-body" id="dashActivity">
                                <div class="empty-state"><p>No recent activity</p></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Leads Pipeline</span>
                                <button class="btn btn-ghost btn-sm" onclick="navigate('leads')">View all</button>
                            </div>
                            <div class="card-body" id="dashLeads"></div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Upcoming</span></div>
                            <div class="card-body" id="dashUpcoming">
                                <div class="empty-state"><p>No upcoming events</p></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Tasks Due</span></div>
                            <div class="card-body" id="dashTasks">
                                <div class="empty-state"><p>No tasks due</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==============================
             LEADS
        ============================== -->
        <div class="page" id="page-leads">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Leads</div>
                </div>
                <div class="page-actions">
                    <div class="search-input">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="text" id="leadsSearch" placeholder="Search leads..." oninput="filterLeads()">
                    </div>
                    <button class="btn btn-default" onclick="openAddLeadModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Lead
                    </button>
                </div>
            </div>
            <div class="page-body">
                <!-- Tabs -->
                <div style="display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0;">
                    <button class="btn btn-ghost lead-tab active-tab" onclick="setLeadTab('all',this)" data-tab="all" style="border-radius:var(--r-sm) var(--r-sm) 0 0;border-bottom:2px solid var(--text-0);">All</button>
                    <button class="btn btn-ghost lead-tab" onclick="setLeadTab('new',this)" data-tab="new" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">New</button>
                    <button class="btn btn-ghost lead-tab" onclick="setLeadTab('contacted',this)" data-tab="contacted" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Contacted</button>
                    <button class="btn btn-ghost lead-tab" onclick="setLeadTab('pending',this)" data-tab="pending" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Pending</button>
                    <button class="btn btn-ghost lead-tab" onclick="setLeadTab('converted',this)" data-tab="converted" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Converted</button>
                </div>
                <div class="table-wrap" id="leadsTable">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                        <h3>No leads yet</h3>
                        <p>Add a lead to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==============================
             MY LEADS
        ============================== -->
        <div class="page" id="page-myleads">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">My Leads</div>
                    <div class="page-subtitle" id="myLeadsSubtitle">Leads & customers assigned to you</div>
                </div>
                <div class="page-actions">
                    <div class="search-input">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="text" id="myLeadsSearch" placeholder="Search my leads..." oninput="filterMyLeads()">
                    </div>
                </div>
            </div>
            <div class="page-body">
                <!-- Analytics bar chart -->
                <div id="myLeadsAnalytics" style="margin-bottom:20px;"></div>

                <!-- Status tabs -->
                <div style="display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0;">
                    <button class="btn btn-ghost my-lead-tab active-tab" onclick="setMyLeadTab('all',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;border-bottom:2px solid var(--text-0);">All</button>
                    <button class="btn btn-ghost my-lead-tab" onclick="setMyLeadTab('new',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">New</button>
                    <button class="btn btn-ghost my-lead-tab" onclick="setMyLeadTab('contacted',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Contacted</button>
                    <button class="btn btn-ghost my-lead-tab" onclick="setMyLeadTab('qualified',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Qualified</button>
                    <button class="btn btn-ghost my-lead-tab" onclick="setMyLeadTab('proposal',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Proposal</button>
                    <button class="btn btn-ghost my-lead-tab" onclick="setMyLeadTab('closed',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Closed</button>
                    <button class="btn btn-ghost my-lead-tab" onclick="setMyLeadTab('lost',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Lost</button>
                </div>

                <div class="table-wrap" id="myLeadsTable">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <h3>No leads assigned to you yet</h3>
                        <p>Leads assigned to you will appear here</p>
                    </div>
                </div>
            </div>
        </div>


        <div class="page" id="page-contacts">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Contacts</div>
                </div>
                <div class="page-actions">
                    <div class="search-input">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="text" id="contactsSearch" placeholder="Search contacts..." oninput="filterContacts()">
                    </div>
                    <button class="btn btn-default" onclick="openAddContactModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Contact
                    </button>
                </div>
            </div>
            <div class="page-body">
                <div class="table-wrap" id="contactsTable">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <h3>No contacts yet</h3>
                        <p>Add your first contact</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==============================
             FOLLOW-UPS
        ============================== -->
        <div class="page" id="page-followups">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Follow-ups</div>
                    <div class="page-subtitle">Cold &amp; hot lead outreach queue — temperature set by email engagement</div>
                </div>
                <div class="page-actions">
                    <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-2);cursor:pointer;">
                        <input type="checkbox" id="fuMineOnly" onchange="loadFollowups()" style="accent-color:var(--text-0);">
                        My leads only
                    </label>
                    <button class="btn btn-default" onclick="setFUMainTab('templates',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                        Templates
                    </button>
                    <button class="btn btn-default" onclick="setFUMainTab('chains',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        Chains
                    </button>
                </div>
            </div>
            <div class="page-body">
                <!-- Main tab row -->
                <div style="display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0;" id="fuMainTabBar">
                    <button class="btn btn-ghost fu-main-tab active-fu-main-tab" onclick="setFUMainTab('queue',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;border-bottom:2px solid var(--text-0);">Queue</button>
                    <button class="btn btn-ghost fu-main-tab" onclick="setFUMainTab('templates',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Templates</button>
                    <button class="btn btn-ghost fu-main-tab" onclick="setFUMainTab('chains',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Automated Chains</button>
                </div>

                <!-- Queue sub-tab content -->
                <div id="fuQueueSection">
                    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
                        <button class="btn btn-default fu-tab active-tab" onclick="setFUTab('all',this)">All Due</button>
                        <button class="btn btn-default fu-tab" onclick="setFUTab('hot',this)">🔥 Hot</button>
                        <button class="btn btn-default fu-tab" onclick="setFUTab('cold',this)">❄️ Cold</button>
                        <button class="btn btn-default fu-tab" onclick="setFUTab('overdue',this)">⚠️ Overdue</button>
                    </div>
                    <div id="followupsContent">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Templates sub-tab content -->
                <div id="fuTemplatesSection" style="display:none;">
                    <div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
                        <button class="btn btn-default" onclick="openFUTemplateBuilder(null)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            New Follow-up Template
                        </button>
                    </div>
                    <div id="fuTemplatesContent">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>

                <!-- Chains sub-tab content -->
                <div id="fuChainsSection" style="display:none;">
                    <div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
                        <button class="btn btn-default" onclick="openFUChainBuilder()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            New Follow-up Chain
                        </button>
                    </div>
                    <div id="fuChainsContent">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==============================
             MARKETING / EMAIL
        ============================== -->
        <div class="page" id="page-marketing">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Email Marketing</div>
                    <div class="page-subtitle">Templates, campaigns &amp; automated chains</div>
                </div>
                <div class="page-actions">
                    <button class="btn btn-ghost" onclick="setMKTab('chains',document.querySelector('[data-mktab=chains]'))">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        Chains
                    </button>
                    <button class="btn btn-default" onclick="openTemplateBuilder(null)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        New Template
                    </button>
                </div>
            </div>
            <div class="page-body">
                <div style="display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);">
                    <button class="btn btn-ghost mk-tab active-tab" data-mktab="templates" onclick="setMKTab('templates',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;border-bottom:2px solid var(--text-0);">Templates</button>
                    <button class="btn btn-ghost mk-tab" data-mktab="send" onclick="setMKTab('send',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Send Campaign</button>
                    <button class="btn btn-ghost mk-tab" data-mktab="chains" onclick="setMKTab('chains',this)" style="border-radius:var(--r-sm) var(--r-sm) 0 0;">Automated Chains</button>
                </div>
                <div id="marketingContent"></div>
            </div>
        </div>

        <!-- ==============================
             SCHEDULING
        ============================== -->
        <div class="page" id="page-scheduling">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Scheduling</div>
                </div>
                <div class="page-actions">
                    <button class="btn btn-default" onclick="openAddAppointmentModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Appointment
                    </button>
                    <button class="btn btn-default" onclick="copySchedulingLink()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        Copy Booking Link
                    </button>
                </div>
            </div>
            <div class="page-body">
                <div class="dash-grid">
                    <div class="col-8">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Upcoming Appointments</span></div>
                            <div class="card-body" id="schedulingList">
                                <div class="empty-state">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    <h3>No appointments</h3><p>Share your booking link to get started</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Booking Link</span></div>
                            <div class="card-body">
                                <p style="font-size:13px;color:var(--text-2);margin-bottom:12px;">Share this link with leads so they can book time with you directly.</p>
                                <div style="background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r-sm);padding:10px 12px;font-family:var(--font-mono);font-size:11px;color:var(--text-3);word-break:break-all;" id="bookingLinkDisplay">Loading...</div>
                                <button class="btn btn-default" style="margin-top:10px;width:100%;" onclick="copySchedulingLink()">Copy Link</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==============================
             INVOICES
        ============================== -->
        <div class="page" id="page-invoices">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Invoices</div>
                </div>
                <div class="page-actions">
                    <button class="btn btn-default" onclick="openCreateInvoiceModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Create Invoice
                    </button>
                </div>
            </div>
            <div class="page-body">
                <div class="table-wrap" id="invoicesTableWrap">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
                        <h3>No invoices</h3><p>Create your first invoice</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==============================
             ANALYTICS
        ============================== -->
        <div class="page" id="page-analytics">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Analytics</div>
                    <div class="page-subtitle" id="analyticsSubtitle">Your performance metrics</div>
                </div>
                <div class="page-actions" id="analyticsAdminControls" style="display:none;">
                    <select id="analyticsUserSelect" onchange="loadAnalytics()" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--r-md);background:var(--bg-1);color:var(--text-0);font-size:13px;min-width:180px;">
                        <option value="">My Analytics</option>
                    </select>
                </div>
            </div>
            <div class="page-body" id="analyticsContent">
                <div class="empty-state"><div class="spinner"></div></div>
            </div>
        </div>


        <!-- ==============================
             TASKS
        ============================== -->
        <div class="page" id="page-tasks">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Tasks</div>
                </div>
                <div class="page-actions">
                    <button class="btn btn-default" onclick="openAddTaskModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Task
                    </button>
                </div>
            </div>
            <div class="page-body">
                <div style="display:flex;gap:8px;margin-bottom:16px;">
                    <button class="btn btn-default task-tab active-tab" onclick="setTaskTab('pending',this)">Pending</button>
                    <button class="btn btn-default task-tab" onclick="setTaskTab('completed',this)">Completed</button>
                    <button class="btn btn-default task-tab" onclick="setTaskTab('all',this)">All</button>
                </div>
                <div id="tasksContent">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        <h3>No tasks</h3>
                        <p>Add a task to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==============================
             TEAM (admin-only)
        ============================== -->
        <div class="page" id="page-team">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Team Performance</div>
                    <div class="page-subtitle">Admin view</div>
                </div>
            </div>
            <div class="page-body" id="teamContent">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                    <h3>Loading team data...</h3>
                </div>
            </div>
        </div>

        <!-- ==============================
             COMPANY (admin-only)
        ============================== -->
        <div class="page" id="page-company">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Company Account</div>
                    <div class="page-subtitle">Manage team members and subscriptions</div>
                </div>
                <div class="page-actions" id="companyHeaderActions" style="display:none;">
                    <button class="btn btn-white" onclick="openAddUserModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add User
                    </button>
                </div>
            </div>
            <div class="page-body" id="companyContent">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="15" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
                    <h3>Loading company data...</h3>
                </div>
            </div>
        </div>

        <!-- ==============================
             FILES
        ============================== -->
        <div class="page" id="page-files">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Files</div>
                </div>
            </div>
            <div class="page-body">
                <div class="upload-zone" id="uploadZone">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <p>Drag & drop files here, or click to browse</p>
                    <small>All file types accepted</small>
                    <input type="file" id="fileInput" multiple style="display:none">
                </div>
                <div id="filesGrid" style="margin-top:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;"></div>
            </div>
        </div>

        <!-- ==============================
             SUPPORT
        ============================== -->
        <div class="page" id="page-support">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Support</div>
                </div>
                <div class="page-actions">
                    <button class="btn btn-white" onclick="openNewTicketModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        New Ticket
                    </button>
                </div>
            </div>
            <div class="page-body">
                <div id="ticketsContent">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <h3>No support tickets</h3>
                        <p>Open a ticket if you need help</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==============================
             SUBSCRIPTION
        ============================== -->
        <div class="page" id="page-subscription">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Subscription</div>
                </div>
            </div>
            <div class="page-body" id="subscriptionContent">
                <div class="empty-state"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- ==============================
             SETTINGS
        ============================== -->
        <div class="page" id="page-settings">
            <div class="page-header">
                <div class="page-title-group">
                    <div class="page-title">Settings</div>
                </div>
            </div>
            <div class="page-body">
                <!-- Profile -->
                <div class="card" style="max-width:620px;">
                    <div class="card-header"><span class="card-title">Profile</span></div>
                    <div class="card-body">
                        <div class="form-field">
                            <label class="form-label">Display Name</label>
                            <input class="form-input" id="settingsName" placeholder="Your name">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Login Email <span style="color:var(--text-3);font-size:11px;">(cannot be changed)</span></label>
                            <input class="form-input" id="settingsEmail" disabled placeholder="your@email.com" style="opacity:0.5;">
                        </div>
                        <!-- Username display for basic users (read-only) -->
                        <div class="form-field" id="settingsUsernameField" style="display:none;">
                            <label class="form-label">Username <span style="color:var(--text-3);font-size:11px;">(cannot be changed)</span></label>
                            <input class="form-input" id="settingsUsername" disabled style="opacity:0.5;" placeholder="—">
                        </div>
                        <button class="btn btn-white" onclick="saveProfile()">Save Changes</button>
                    </div>
                </div>

                <!-- Brevo Integration -->
                <div class="card settings-admin-only" style="max-width:620px;margin-top:16px;">
                    <div class="card-header">
                        <span class="card-title">Email Provider</span>
                        <span style="font-size:11px;color:var(--text-3);margin-top:3px;display:block;">Set up Brevo for full tracking, or use EmailJS as a fallback. Brevo takes priority when both are configured.</span>
                    </div>
                    <div class="card-body">
                        <!-- Brevo Section -->
                        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-2);margin-bottom:12px;">Brevo (Primary)</div>
                        <div style="background:#6366f111;border:1px solid #6366f133;border-radius:var(--r-md);padding:12px 16px;margin-bottom:16px;font-size:12px;color:var(--text-2);line-height:1.6;">
                            <strong style="color:var(--text-0);">How it works:</strong> Get your API key from <a href="https://app.brevo.com/settings/keys/api" target="_blank" style="color:#6366f1;">brevo.com → Settings → API Keys</a>.
                            Track email opens &amp; clicks — when a lead clicks the Schedule button, they automatically become a Hot lead.
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label">Brevo API Key</label>
                                <input class="form-input" id="settingsBrevoKey" type="password" placeholder="xkeysib-...">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Sender Email</label>
                                <input class="form-input" id="settingsSenderEmail" type="email" placeholder="hello@yourcompany.com">
                            </div>
                        </div>
                        <div class="form-field">
                            <label class="form-label">Sender Name</label>
                            <input class="form-input" id="settingsSenderName" placeholder="Acme Corp">
                        </div>

                        <!-- EmailJS fallback section -->
                        <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:8px;">
                            <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-2);margin-bottom:12px;">EmailJS (Fallback — used when Brevo is not configured)</div>
                            <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:var(--r-md);padding:12px 16px;margin-bottom:16px;font-size:12px;color:var(--text-2);line-height:1.6;">
                                <strong style="color:var(--text-0);">EmailJS:</strong> Get your credentials from <a href="https://www.emailjs.com" target="_blank" style="color:#3b82f6;">emailjs.com</a>. Emails will send from each user's configured sending email address.
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label class="form-label">EmailJS Service ID</label>
                                    <input class="form-input" id="settingsEmailJSService" placeholder="service_xxxxxxx">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">EmailJS Template ID</label>
                                    <input class="form-input" id="settingsEmailJSTemplate" placeholder="template_xxxxxxx">
                                </div>
                            </div>
                            <div class="form-field">
                                <label class="form-label">EmailJS Public Key</label>
                                <input class="form-input" id="settingsEmailJSPublicKey" placeholder="your_public_key">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Company Info -->
                <div class="settings-admin-only card" style="max-width:620px;margin-top:16px;">
                    <div class="card-header">
                        <span class="card-title">Company Info</span>
                        <span style="font-size:11px;color:var(--text-3);margin-top:3px;display:block;">Used in email template footers and auto-filled when building templates.</span>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label">Company Name</label>
                                <input class="form-input" id="settingsCompanyName" placeholder="Acme Corp">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Company Phone</label>
                                <input class="form-input" id="settingsCompanyPhone" placeholder="(555) 000-0000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label">Company Email</label>
                                <input class="form-input" id="settingsCompanyEmail" type="email" placeholder="info@yourcompany.com">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Website URL <span style="color:var(--text-3);font-weight:400;">(link that triggers hot conversion)</span></label>
                                <input class="form-input" id="settingsWebsiteUrl" placeholder="https://yourwebsite.com">
                            </div>
                        </div>
                        <div class="form-field">
                            <label class="form-label">Company Address</label>
                            <input class="form-input" id="settingsCompanyAddr" placeholder="123 Main St, Austin TX 78701">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Email Accent Color</label>
                            <div style="display:flex;gap:10px;align-items:center;">
                                <input type="color" id="settingsColorPicker" value="#FF6B35" oninput="document.getElementById('settingsAccentColor').value=this.value" style="width:44px;height:38px;border:none;border-radius:var(--r-sm);cursor:pointer;padding:2px;">
                                <input class="form-input" id="settingsAccentColor" placeholder="#FF6B35" oninput="document.getElementById('settingsColorPicker').value=this.value" style="max-width:120px;">
                            </div>
                        </div>
                        <button class="btn btn-white" onclick="saveEmailSettings()">Save Email Settings</button>
                    </div>
                </div>

                <!-- Change Password -->
                <div class="card" style="max-width:620px;margin-top:16px;">
                    <div class="card-header"><span class="card-title">Change Password</span></div>
                    <div class="card-body">
                        <div class="form-field">
                            <label class="form-label">Current Password</label>
                            <input class="form-input" type="password" id="currentPw" placeholder="••••••••">
                        </div>
                        <div class="form-field">
                            <label class="form-label">New Password</label>
                            <input class="form-input" type="password" id="newPw" placeholder="••••••••">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Confirm New Password</label>
                            <input class="form-input" type="password" id="confirmPw" placeholder="••••••••">
                        </div>
                        <button class="btn btn-white" onclick="changePassword()">Update Password</button>
                    </div>
                </div>
            </div>
        </div>


    </main><!-- end .main -->
</div><!-- end #app -->

<!-- ============================================================
     TOAST CONTAINER
============================================================ -->
<div class="toast-container" id="toastContainer"></div>

<!-- ============================================================
     MODALS
============================================================ -->

<!-- Add Lead Modal -->
<div class="modal-overlay" id="addLeadModal" onclick="closeOnOverlay(event,'addLeadModal')">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">New Lead</span>
            <button class="modal-close" onclick="closeModal('addLeadModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:var(--r-md);padding:10px 14px;margin-bottom:16px;font-size:12px;color:#a5b4fc;">
                New leads are automatically added to the Follow-ups queue as Cold leads. Temperature updates based on email engagement.
            </div>
            <div class="form-row">
                <div class="form-field"><label class="form-label">Name</label><input class="form-input" id="leadName" placeholder="Full name"></div>
                <div class="form-field"><label class="form-label">Email</label><input class="form-input" id="leadEmail" type="email" placeholder="email@example.com"></div>
            </div>
            <div class="form-row">
                <div class="form-field"><label class="form-label">Phone</label><input class="form-input" id="leadPhone" placeholder="(555) 000-0000"></div>
                <div class="form-field"><label class="form-label">Company</label><input class="form-input" id="leadCompany" placeholder="Company name"></div>
            </div>
            <div class="form-field">
                <label class="form-label">Source / Pipeline Stage</label>
                <select class="form-select" id="leadStatus">
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="pending">Pending</option>
                    <option value="qualified">Qualified</option>
                </select>
            </div>
            <div class="form-field">
                <label class="form-label">Follow-up Mode</label>
                <select class="form-select" id="leadFollowupMode">
                    <option value="manual">Manual — I'll follow up myself</option>
                    <option value="automatic">Automatic — enroll in a follow-up chain</option>
                </select>
            </div>
            <div class="form-field" id="leadChainField" style="display:none;">
                <label class="form-label">Select Chain</label>
                <select class="form-select" id="leadChainSelect">
                    <option value="">Loading chains...</option>
                </select>
            </div>
            <div class="form-field">
                <label class="form-label">Notes</label>
                <textarea class="form-input" id="leadNotes" placeholder="Initial notes..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('addLeadModal')">Cancel</button>
            <button class="btn btn-white" onclick="saveLead()">Create Lead</button>
        </div>
    </div>
</div>

<!-- Add Contact Modal -->
<div class="modal-overlay" id="addContactModal" onclick="closeOnOverlay(event,'addContactModal')">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">New Contact</span>
            <button class="modal-close" onclick="closeModal('addContactModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-field"><label class="form-label">Name</label><input class="form-input" id="contactName" placeholder="Full name"></div>
                <div class="form-field"><label class="form-label">Email</label><input class="form-input" id="contactEmail" type="email" placeholder="email@example.com"></div>
            </div>
            <div class="form-row">
                <div class="form-field"><label class="form-label">Phone</label><input class="form-input" id="contactPhone" placeholder="(555) 000-0000"></div>
                <div class="form-field"><label class="form-label">Company</label><input class="form-input" id="contactCompany" placeholder="Company name"></div>
            </div>
            <div class="form-field"><label class="form-label">Notes</label><textarea class="form-input" id="contactNotes" placeholder="Notes..."></textarea></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('addContactModal')">Cancel</button>
            <button class="btn btn-white" onclick="saveContact()">Create Contact</button>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal-overlay" id="addTaskModal" onclick="closeOnOverlay(event,'addTaskModal')">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">New Task</span>
            <button class="modal-close" onclick="closeModal('addTaskModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-field"><label class="form-label">Title</label><input class="form-input" id="taskTitle" placeholder="Task title"></div>
            <div class="form-field"><label class="form-label">Description</label><textarea class="form-input" id="taskDesc" placeholder="Details..."></textarea></div>
            <div class="form-row">
                <div class="form-field">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="taskPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-field"><label class="form-label">Due Date</label><input class="form-input" type="date" id="taskDue"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('addTaskModal')">Cancel</button>
            <button class="btn btn-white" onclick="saveTask()">Create Task</button>
        </div>
    </div>
</div>

<!-- New Ticket Modal -->
<div class="modal-overlay" id="newTicketModal" onclick="closeOnOverlay(event,'newTicketModal')">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">New Support Ticket</span>
            <button class="modal-close" onclick="closeModal('newTicketModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-field">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="ticketPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-field">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="ticketCategory">
                        <option value="general">General</option>
                        <option value="technical">Technical</option>
                        <option value="billing">Billing</option>
                        <option value="feature">Feature Request</option>
                    </select>
                </div>
            </div>
            <div class="form-field"><label class="form-label">Subject</label><input class="form-input" id="ticketSubject" placeholder="Brief description"></div>
            <div class="form-field"><label class="form-label">Message</label><textarea class="form-input" id="ticketMessage" style="min-height:120px;" placeholder="Describe your issue in detail..."></textarea></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('newTicketModal')">Cancel</button>
            <button class="btn btn-white" onclick="submitTicket()">Submit Ticket</button>
        </div>
    </div>
</div>

<!-- Campaign Modal -->
<div class="modal-overlay" id="newCampaignModal" onclick="closeOnOverlay(event,'newCampaignModal')">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">New Campaign</span>
            <button class="modal-close" onclick="closeModal('newCampaignModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-field"><label class="form-label">Campaign Name</label><input class="form-input" id="campaignName" placeholder="e.g., Summer Outreach"></div>
            <div class="form-field">
                <label class="form-label">Target Audience</label>
                <select class="form-select" id="campaignAudience">
                    <option value="all">All</option>
                    <option value="leads">Leads Only</option>
                    <option value="customers">Customers Only</option>
                    <option value="contacts">Contacts Only</option>
                </select>
            </div>
            <div class="form-field"><label class="form-label">Subject Line</label><input class="form-input" id="campaignSubject" placeholder="Email subject..."></div>
            <div class="form-field"><label class="form-label">Message</label><textarea class="form-input" id="campaignBody" style="min-height:150px;" placeholder="Email body..."></textarea></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('newCampaignModal')">Cancel</button>
            <button class="btn btn-default" id="campaignSaveDraftBtn" onclick="saveCampaignDraft()">Save Draft</button>
            <button class="btn btn-white" onclick="sendCampaign()">Send Now</button>
        </div>
    </div>
</div>

<!-- Create Invoice Modal -->
<div class="modal-overlay" id="createInvoiceModal" onclick="closeOnOverlay(event,'createInvoiceModal')">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Create Invoice</span>
            <button class="modal-close" onclick="closeModal('createInvoiceModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="form-field"><label class="form-label">Client Name</label><input class="form-input" id="invClient" placeholder="Client name"></div>
            <div class="form-field"><label class="form-label">Client Email</label><input class="form-input" id="invEmail" type="email" placeholder="client@example.com"></div>
            <div class="form-field"><label class="form-label">Description</label><input class="form-input" id="invDesc" placeholder="Service description"></div>
            <div class="form-row">
                <div class="form-field"><label class="form-label">Amount ($)</label><input class="form-input" id="invAmount" type="number" step="0.01" placeholder="0.00"></div>
                <div class="form-field"><label class="form-label">Due Date</label><input class="form-input" type="date" id="invDue"></div>
            </div>
            <div class="form-field" style="display:flex;align-items:center;gap:10px;margin-top:4px;">
                <input type="checkbox" id="invEmailCheck" style="width:16px;height:16px;accent-color:white;">
                <label for="invEmailCheck" style="font-size:13px;color:var(--text-2);cursor:pointer;">Send invoice to client via email</label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('createInvoiceModal')">Cancel</button>
            <button class="btn btn-white" onclick="createInvoice()">Create Invoice</button>
        </div>
    </div>
</div>

<!-- Add Company User Modal (in-CRM, replaces redirect to pricing) -->
<div class="modal-overlay add-user-modal" id="addUserModal" onclick="closeOnOverlay(event,'addUserModal')">
    <div class="modal" style="max-width:580px;">
        <div class="modal-header">
            <span class="modal-title">Add Team Member</span>
            <button class="modal-close" onclick="closeModal('addUserModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <!-- Seat availability banner -->
            <div id="addUserSeatBanner" style="border-radius:var(--r-md);padding:12px 16px;margin-bottom:16px;font-size:13px;font-weight:500;"></div>

            <!-- Plan selector — shown ONLY when seats are maxed out -->
            <div id="addUserPlanSection" style="display:none;margin-bottom:18px;">
                <label class="form-label" style="margin-bottom:8px;display:block;">Choose a plan for this new seat <span style="color:var(--text-3);font-weight:400;">(billed monthly per user)</span></label>
                <div style="display:grid;gap:8px;">
                    <label id="addUserPlan-crm-essential" style="display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:var(--r-md);padding:12px 14px;cursor:pointer;transition:border-color .15s,background .15s;">
                        <input type="radio" name="addUserPlan" value="crm-essential" style="accent-color:var(--accent);width:16px;height:16px;flex-shrink:0;">
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;">Essential</div>
                            <div style="font-size:12px;color:var(--text-3);">Core CRM features — leads, tasks, invoices</div>
                        </div>
                        <div style="font-weight:700;font-size:15px;color:var(--accent);">$19.99<span style="font-weight:400;font-size:11px;color:var(--text-3);">/mo</span></div>
                    </label>
                    <label id="addUserPlan-crm-professional" style="display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:var(--r-md);padding:12px 14px;cursor:pointer;transition:border-color .15s,background .15s;">
                        <input type="radio" name="addUserPlan" value="crm-professional" style="accent-color:var(--accent);width:16px;height:16px;flex-shrink:0;">
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;">Professional</div>
                            <div style="font-size:12px;color:var(--text-3);">+ Email marketing, analytics, scheduling</div>
                        </div>
                        <div style="font-weight:700;font-size:15px;color:var(--accent);">$49.99<span style="font-weight:400;font-size:11px;color:var(--text-3);">/mo</span></div>
                    </label>
                    <label id="addUserPlan-crm-enterprise" style="display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:var(--r-md);padding:12px 14px;cursor:pointer;transition:border-color .15s,background .15s;">
                        <input type="radio" name="addUserPlan" value="crm-enterprise" style="accent-color:var(--accent);width:16px;height:16px;flex-shrink:0;">
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;">Enterprise</div>
                            <div style="font-size:12px;color:var(--text-3);">Full suite — all features + priority support</div>
                        </div>
                        <div style="font-weight:700;font-size:15px;color:var(--accent);">$64.99<span style="font-weight:400;font-size:11px;color:var(--text-3);">/mo</span></div>
                    </label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field"><label class="form-label">Full Name</label><input class="form-input" id="addUserName" placeholder="Team member name"></div>
                <div class="form-field"><label class="form-label">Username / Login</label><input class="form-input" id="addUserUsername" placeholder="username (no spaces)"></div>
            </div>
            <div class="form-row">
                <div class="form-field"><label class="form-label">Login Email</label><input class="form-input" id="addUserEmail" type="email" placeholder="member@company.com"></div>
                <div class="form-field"><label class="form-label">Sending Email <span style="color:var(--text-3);font-weight:400;">(optional)</span></label><input class="form-input" id="addUserSendingEmail" type="email" placeholder="user@sendingdomain.com"></div>
            </div>
            <div class="form-row">
                <div class="form-field">
                    <label class="form-label">Password</label>
                    <input class="form-input" id="addUserPassword" type="password" placeholder="Set their login password">
                </div>
                <div class="form-field">
                    <label class="form-label">User Label (optional)</label>
                    <input class="form-input" id="addUserLabel" placeholder="e.g., Sales Rep, Manager...">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('addUserModal')">Cancel</button>
            <button class="btn btn-white" id="addUserBtn" onclick="addCompanyUser()">Add Team Member</button>
        </div>
    </div>
</div>

<!-- Reset User Password Modal -->
<div class="modal-overlay" id="resetUserPwModal" onclick="closeOnOverlay(event,'resetUserPwModal')">
    <div class="modal" style="max-width:440px;">
        <div class="modal-header">
            <span class="modal-title">Reset User Password</span>
            <button class="modal-close" onclick="closeModal('resetUserPwModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <p style="font-size:13px;color:var(--text-2);margin-bottom:16px;">Set a new password for <strong id="resetUserPwName"></strong>. They will receive an email with the new credentials.</p>
            <div class="form-field">
                <label class="form-label">New Password</label>
                <input class="form-input" type="password" id="resetUserPwInput" placeholder="Min. 6 characters">
            </div>
            <div class="form-field">
                <label class="form-label">Confirm New Password</label>
                <input class="form-input" type="password" id="resetUserPwConfirm" placeholder="Repeat password">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('resetUserPwModal')">Cancel</button>
            <button class="btn btn-white" id="resetUserPwBtn" onclick="confirmResetUserPassword()">Reset Password</button>
        </div>
    </div>
</div>

<!-- Subscription Change Plan Modal -->
<div class="modal-overlay" id="changePlanModal" onclick="closeOnOverlay(event,'changePlanModal')">
    <div class="modal" style="max-width:600px;">
        <div class="modal-header">
            <span class="modal-title">Change Plan</span>
            <button class="modal-close" onclick="closeModal('changePlanModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div id="changePlanOptions" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;"></div>
            <div class="form-field" id="changePlanUsersField" style="display:none;">
                <label class="form-label">Number of Users</label>
                <div class="qty-control">
                    <button class="qty-btn" onclick="adjustPlanQty(-1)">−</button>
                    <input type="number" class="qty-input" id="changePlanQty" value="1" min="1" max="999" oninput="updatePlanTotal()">
                    <button class="qty-btn" onclick="adjustPlanQty(1)">+</button>
                </div>
            </div>
            <div style="background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r-md);padding:16px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="font-size:13px;color:var(--text-3);">Current</span>
                    <span style="font-size:13px;font-weight:600;color:var(--text-1);" id="planCurrentAmt">—</span>
                </div>
                <div style="display:flex;justify-content:space-between;">
                    <span style="font-size:14px;font-weight:600;color:var(--text-0);">New Monthly Total</span>
                    <span style="font-size:20px;font-weight:700;color:var(--green);" id="planNewAmt">$0.00</span>
                </div>
            </div>
            <div id="planChangeNotice" style="margin-top:12px;padding:12px;border-radius:var(--r-sm);font-size:12px;display:none;"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('changePlanModal')">Cancel</button>
            <button class="btn btn-white" id="confirmPlanChangeBtn" onclick="confirmPlanChange()">Confirm Change</button>
        </div>
    </div>
</div>

<!-- Cancel Subscription Modal -->
<div class="modal-overlay" id="cancelSubModal" onclick="closeOnOverlay(event,'cancelSubModal')">
    <div class="modal" style="max-width:460px;">
        <div class="modal-header">
            <span class="modal-title" style="color:var(--red);">Cancel Subscription</span>
            <button class="modal-close" onclick="closeModal('cancelSubModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <p style="font-size:13px;color:var(--text-2);margin-bottom:16px;" id="cancelSubDesc">Are you sure you want to cancel?</p>
            <div style="background:var(--bg-3);border:1px solid var(--border);border-radius:var(--r-md);padding:14px;">
                <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="cancelImmediately" style="margin-top:2px;width:15px;height:15px;accent-color:var(--red);">
                    <div>
                        <div style="font-size:13px;font-weight:600;color:var(--text-0);margin-bottom:3px;">Cancel immediately</div>
                        <div style="font-size:12px;color:var(--text-3);">Access ends now. Leave unchecked to keep access until billing period ends.</div>
                    </div>
                </label>
            </div>
            <p style="font-size:12px;color:var(--text-3);margin-top:12px;">A confirmation email will be sent. To reactivate, contact us at (512) 980-0393.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('cancelSubModal')">Keep Subscription</button>
            <button class="btn btn-danger" id="confirmCancelBtn" onclick="confirmCancelSub()">Cancel Subscription</button>
        </div>
    </div>
</div>

<!-- Auto-Reply Builder Modal -->
<div class="modal-overlay" id="autoReplyModal" onclick="closeOnOverlay(event,'autoReplyModal')">
    <div class="modal" style="max-width:620px;">
        <div class="modal-header">
            <span class="modal-title">Auto-Reply Templates</span>
            <button class="modal-close" onclick="closeModal('autoReplyModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <p style="font-size:13px;color:var(--text-3);margin-bottom:16px;">When a lead is set to auto-reply, the system will automatically send these messages on a schedule.</p>
            <div id="autoReplyTemplates"></div>
            <button class="btn btn-default" style="width:100%;margin-top:8px;" onclick="addAutoReplyTemplate()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add Template
            </button>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('autoReplyModal')">Close</button>
            <button class="btn btn-white" onclick="saveAutoReplyTemplates()">Save Templates</button>
        </div>
    </div>
</div>

<!-- Admin Validation Modal (before company admin actions) -->
<div class="modal-overlay" id="adminValidationModal" onclick="closeOnOverlay(event,'adminValidationModal')">
    <div class="modal" style="max-width:420px;">
        <div class="modal-header">
            <span class="modal-title">Verify Identity</span>
            <button class="modal-close" onclick="closeModal('adminValidationModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <p style="font-size:13px;color:var(--text-2);margin-bottom:16px;" id="validationDesc">Please confirm your password to continue.</p>
            <div class="form-field">
                <label class="form-label">Your Password</label>
                <input class="form-input" type="password" id="validationPassword" placeholder="••••••••">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('adminValidationModal')">Cancel</button>
            <button class="btn btn-white" id="validationConfirmBtn" onclick="confirmValidation()">Confirm</button>
        </div>
    </div>
</div>

<!-- ============================================================
     UPGRADE TO COMPANY MODAL
============================================================ -->
<!-- upgradeToCompanyModal removed — individual plans are standalone; team accounts must purchase CRM Workspace directly -->

<!-- ============================================================
     CHANGE USER PLAN MODAL (admin changes a team member's plan)
============================================================ -->
<!-- changeUserPlanModal and companySubChangeModal removed — company subscription is a fixed $84.99/user rate, no plan changes permitted -->

<!-- ============================================================
     JAVASCRIPT
============================================================ -->
<script>
'use strict';

// ============================================================
// CONFIG
// ============================================================
const API_BASE = (() => {
    const h = window.location.hostname;
    if (h === 'diamondbackcoding.com' || h === 'www.diamondbackcoding.com')
        return 'https://diamondbackcoding.com/api';
    if (h === 'localhost' || h === '127.0.0.1')
        return 'http://localhost:3000/api';
    return `${window.location.protocol}//${h}:3000/api`;
})();

// ============================================================
// STATE
// ============================================================
const S = {
    token: null,
    user: null,
    isAdmin: false,   // true = company admin or co-admin
    isTrueAdmin: false, // true = designated company admin
    isIndividual: false,
    isCompanyMember: false,
    leads: [],
    contacts: [],
    tasks: [],
    invoices: [],
    tickets: [],
    files: [],
    companyData: null,
    currentPage: 'dashboard',
    leadTab: 'all',
    taskTab: 'pending',
    // Plan change state
    planState: { subId: null, selectedKey: null, selectedPrice: 0 },
    cancelSubId: null,
    // Validation callback
    validationCallback: null,
};

// Individual CRM plans (solo users — do NOT use for company/workspace subscriptions)
const CRM_PLANS = [
    { key: 'crm-essential',    name: 'Essential',    price: 19.99, isCompanyPlan: false },
    { key: 'crm-professional', name: 'Professional', price: 49.99, isCompanyPlan: false },
    { key: 'crm-enterprise',   name: 'Enterprise',   price: 64.99, isCompanyPlan: false },
];
// Company workspace plan (multi-seat shared subscription)
const COMPANY_PLANS = [
    { key: 'crm-workspace', name: 'CRM Workspace', price: 84.99, isCompanyPlan: true }
];

// setupAddUserPlanSelect: plan is inherited from company subscription — no UI select needed
function setupAddUserPlanSelect() {
    // Plan is determined server-side from the company's active subscription.
    // Nothing to wire up here — kept for forward compatibility.
}

// navigateTo is an alias for navigate (used in inline onclick links)
function navigateTo(page) { navigate(page); }

// previewTemplate: shows a preview of the current template being built
function previewTemplate() {
    const subject = document.getElementById('templateSubject')?.value || '(no subject)';
    const body    = document.getElementById('templateBody')?.value || '';
    const preview = window.open('', '_blank', 'width=600,height=500');
    if (preview) {
        preview.document.write(`<html><head><title>Preview: ${subject}</title></head><body style="font-family:sans-serif;padding:24px;max-width:600px;margin:0 auto;"><h3 style="color:#888;font-size:12px;text-transform:uppercase;letter-spacing:1px;">Subject</h3><p style="margin-bottom:24px;">${subject}</p><hr><div style="margin-top:24px;">${body.replace(/\n/g,'<br>')}</div></body></html>`);
        preview.document.close();
    }
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    setupLoginForm();
    setupNavigation();
    setupFileUpload();
    setupAddUserPlanSelect();

    // Auto-login from stored token
    const token = localStorage.getItem('clientToken');
    const user  = localStorage.getItem('clientUser');
    if (token && user) {
        S.token = token;
        S.user  = JSON.parse(user);
        showApp();
    }

    // Payment success redirect
    const params = new URLSearchParams(window.location.search);
    if (params.get('payment') === 'success') {
        setTimeout(() => {
            toast('Payment received — thank you!', 'success');
            history.replaceState({}, '', location.pathname);
        }, 500);
    }
});

// ============================================================
// AUTH
// ============================================================
function setupLoginForm() {
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const pass  = document.getElementById('loginPassword').value;
        const btn   = document.getElementById('loginBtn');
        const err   = document.getElementById('loginError');
        const errTxt = document.getElementById('loginErrorText');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Signing in...';
        err.classList.remove('show');

        try {
            const res  = await apiFetch('/client/login', 'POST', { email, password: pass }, false);
            const data = await res.json();

            if (data.success) {
                S.token = data.token;
                S.user  = data.client;
                localStorage.setItem('clientToken', data.token);
                localStorage.setItem('clientUser', JSON.stringify(data.client));
                showApp();
            } else {
                errTxt.textContent = data.message || 'Login failed';
                err.classList.add('show');
            }
        } catch {
            errTxt.textContent = 'Connection error. Please try again.';
            err.classList.add('show');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Sign in';
        }
    });
}

function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').classList.add('visible');

    const user = S.user;
    S.isAdmin         = user.isCompanyAdmin || user.isCoAdmin || false;
    S.isTrueAdmin     = user.isCompanyAdmin || false;
    S.isCompanyMember = !!(user.clientPortalId);
    S.isIndividual    = !S.isCompanyMember;

    // Update sidebar identity
    const initials = (user.name || 'U').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    document.getElementById('sidebarAvatar').textContent = initials;
    document.getElementById('sidebarName').textContent = user.name || user.email;
    document.getElementById('sidebarRole').textContent =
        S.isTrueAdmin ? 'Admin' :
        S.isAdmin     ? 'Co-Admin' :
        S.isCompanyMember ? 'Member' : 'Individual';

    // Admin-only nav items (Team, Company tabs + admin workspace items)
    document.querySelectorAll('.nav-item-admin-only').forEach(el => {
        el.style.display = S.isAdmin ? 'flex' : 'none';
    });

    // Admin-only settings sections
    document.querySelectorAll('.settings-admin-only').forEach(el => {
        el.style.display = S.isAdmin ? '' : 'none';
    });

    // Subscription nav: always visible for everyone
    const navSub = document.getElementById('navSubscription');
    if (navSub) navSub.style.display = 'flex';

    // Files and Support always visible
    document.getElementById('navFiles').style.display = 'flex';
    document.getElementById('navSupport').style.display = 'flex';

    // Greet
    const hour = new Date().getHours();
    const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
    document.getElementById('dashGreeting').textContent = `${greet}, ${(user.name||'').split(' ')[0] || 'there'}`;

    navigate('dashboard');
    loadInitialData();
}

function logout() {
    localStorage.removeItem('clientToken');
    localStorage.removeItem('clientUser');
    S.token = null; S.user = null;
    document.getElementById('app').classList.remove('visible');
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
}

// ============================================================
// NAVIGATION
// ============================================================
function setupNavigation() {
    document.querySelectorAll('.nav-item[data-page]').forEach(el => {
        el.addEventListener('click', () => navigate(el.dataset.page));
    });
}

function navigate(page) {
    // Update nav
    document.querySelectorAll('.nav-item[data-page]').forEach(el => {
        el.classList.toggle('active', el.dataset.page === page);
    });
    // Update pages
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const pageEl = document.getElementById('page-' + page);
    if (pageEl) pageEl.classList.add('active');

    S.currentPage = page;

    // Load data for page
    switch(page) {
        case 'dashboard':   loadDashboard();   break;
        case 'leads':       loadLeads();       break;
        case 'myleads':     loadMyLeads();     break;
        case 'contacts':    loadContacts();    break;
        case 'followups':
            // Initialize to queue tab
            const fuQueueBtn = document.querySelector('.fu-main-tab');
            setFUMainTab('queue', fuQueueBtn);
            break;
        case 'marketing':   loadMarketing();   break;
        case 'invoices':    loadInvoices();    break;
        case 'analytics':   loadAnalytics();   break;
        case 'tasks':       loadTasks();       break;
        case 'team':        if(S.isAdmin) loadTeam(); break;
        case 'company':     if(S.isAdmin) loadCompany(); break;
        case 'files':       loadFiles();       break;
        case 'support':     loadTickets();     break;
        case 'subscription': loadSubscription(); break;
        case 'scheduling':  loadScheduling();  break;
        case 'settings':    loadSettings();    break;
    }
}

// ============================================================
// API HELPER
// ============================================================
async function apiFetch(path, method='GET', body=null, auth=true) {
    const headers = { 'Content-Type': 'application/json' };
    if (auth && S.token) headers['Authorization'] = 'Bearer ' + S.token;
    return fetch(API_BASE + path, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined,
    });
}

// ============================================================
// LOAD INITIAL DATA
// ============================================================
async function loadInitialData() {
    await Promise.all([
        loadLeadsData(),
        loadContactsData(),
        loadTasksData(),
    ]);
}

// ============================================================
// DASHBOARD
// ============================================================
async function loadDashboard() {
    try {
        const [dashRes] = await Promise.all([
            apiFetch('/client/dashboard'),
        ]);
        const dashData = await dashRes.json();
        if (!dashData.success && !dashData.dashboard) return;

        const d = dashData.dashboard || {};
        const leads = d.leads || S.leads;
        const invoices = d.invoices || S.invoices;
        const tasks = d.tickets || [];

        // Stats
        const totalLeads = leads.length;
        const totalContacts = (S.contacts || []).length;
        const openTasks = (S.tasks || []).filter(t => t.status !== 'completed').length;
        const revenue = invoices.filter(i=>i.status==='paid').reduce((s,i)=>s+parseFloat(i.total_amount||i.amount||0),0);

        document.getElementById('dStat1').textContent = totalLeads;
        document.getElementById('dStat2').textContent = totalContacts;
        document.getElementById('dStat3').textContent = openTasks;
        document.getElementById('dStat4').textContent = '$' + revenue.toFixed(0);

        // Activity
        const activity = d.activity || [];
        const actEl = document.getElementById('dashActivity');
        if (activity.length) {
            actEl.innerHTML = activity.slice(0,8).map(a => `
                <div class="activity-item">
                    <div class="activity-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/></svg>
                    </div>
                    <div>
                        <div class="activity-text">${escHtml(a.description||a.details||'Activity')}</div>
                        <div class="activity-time">${fmtDate(a.created_at)}</div>
                    </div>
                </div>
            `).join('');
        } else {
            actEl.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
        }

        // Recent leads
        const dashLeadsEl = document.getElementById('dashLeads');
        const recentLeads = leads.slice(0,5);
        if (recentLeads.length) {
            dashLeadsEl.innerHTML = `
                <table style="width:100%;">
                    <thead><tr>
                        <th>Name</th><th>Status</th><th>Date</th>
                    </tr></thead>
                    <tbody>
                        ${recentLeads.map(l=>`<tr>
                            <td style="font-weight:500;">${escHtml(l.name||l.email||'—')}</td>
                            <td>${statusBadge(l.status||l.lead_temperature||'new')}</td>
                            <td style="color:var(--text-3);font-size:12px;">${fmtDate(l.created_at)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>`;
        } else {
            dashLeadsEl.innerHTML = '<div class="empty-state"><p>No leads yet</p></div>';
        }
    } catch(e) {
        console.error('Dashboard load error:', e);
    }
}

// ============================================================
// LEADS
// ============================================================
async function loadLeadsData() {
    try {
        const res = await apiFetch('/client/leads');
        const data = await res.json();
        S.leads = data.leads || data.contacts || [];
    } catch {}
}

async function loadLeads() {
    await loadLeadsData();
    renderLeads();
}

function renderLeads() {
    const tab = S.leadTab;
    let filtered = S.leads;

    // Filter out the logged-in user from the leads list (admin should not see themselves as a lead)
    if (S.user?.email) {
        filtered = filtered.filter(l => (l.email || '').toLowerCase() !== S.user.email.toLowerCase());
    }

    if (tab !== 'all') {
        filtered = filtered.filter(l => (l.status||l.lead_temperature||'new').toLowerCase() === tab ||
            (tab === 'converted' && l.is_customer));
    }
    // Search filter
    const q = (document.getElementById('leadsSearch')||{}).value?.toLowerCase() || '';
    if (q) {
        filtered = filtered.filter(l =>
            (l.name||'').toLowerCase().includes(q) ||
            (l.email||'').toLowerCase().includes(q) ||
            (l.company||'').toLowerCase().includes(q)
        );
    }

    const el = document.getElementById('leadsTable');
    if (!filtered.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
            <h3>No leads found</h3><p>Try a different filter</p></div>`;
        return;
    }
    el.innerHTML = `
        <table>
            <thead><tr>
                <th>Name</th><th>Email</th><th>Company</th>
                <th>Status</th><th>Assigned To</th><th>Added</th><th></th>
            </tr></thead>
            <tbody>
                ${filtered.map(l=>`<tr>
                    <td style="font-weight:500;cursor:pointer;" onclick="openLeadProfile(${JSON.stringify(l).replace(/"/g,'&quot;')})">${escHtml(l.name||'—')}</td>
                    <td style="color:var(--text-2);">${escHtml(l.email||'—')}</td>
                    <td style="color:var(--text-2);">${escHtml(l.company||'—')}</td>
                    <td>${statusBadge(l.status||l.lead_temperature||'new')}</td>
                    <td>
                        ${l.assigned_to_name
                            ? `<span style="font-size:12px;background:var(--bg-1);padding:3px 8px;border-radius:4px;white-space:nowrap;">${escHtml(l.assigned_to_name)}</span>`
                            : `<span style="font-size:12px;color:var(--text-3);">Unassigned</span>`
                        }
                    </td>
                    <td style="color:var(--text-3);font-size:12px;">${fmtDate(l.created_at)}</td>
                    <td>
                        <div class="row-actions">
                            <button class="btn btn-ghost btn-xs" onclick="openAssignModal(${l.id},'${escHtml(l.name||'')}',${l.crm_assigned_to||'null'})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                                Assign
                            </button>
                            <button class="btn btn-ghost btn-xs" onclick="sendFollowUpEmail(${l.id},'${escHtml(l.email||'')}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                Email
                            </button>
                            <button class="btn btn-ghost btn-xs" onclick="openEditLeadModal(${JSON.stringify(l).replace(/'/g,'&#39;')})">Edit</button>
                        </div>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>`;
}

function filterLeads() { renderLeads(); }

function setLeadTab(tab, el) {
    S.leadTab = tab;
    document.querySelectorAll('.lead-tab').forEach(b => {
        b.classList.toggle('active-tab', b === el);
        b.style.borderBottom = b === el ? '2px solid var(--text-0)' : '';
    });
    renderLeads();
}

function openAddLeadModal() {
    ['leadName','leadEmail','leadPhone','leadCompany','leadNotes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('leadStatus').value = 'new';
    document.getElementById('leadFollowupMode').value = 'manual';
    document.getElementById('leadChainField').style.display = 'none';

    // Load chains for the automatic follow-up option
    apiFetch('/client/email-chains').then(r=>r.json()).then(d=>{
        const chains = d.chains || [];
        const sel = document.getElementById('leadChainSelect');
        if (sel) {
            sel.innerHTML = chains.length
                ? chains.map(c=>`<option value="${c.id}">${escHtml(c.name)} (${c.steps?.length||0} steps)</option>`).join('')
                : '<option value="">No chains yet — create one in Follow-ups → Chains</option>';
        }
    }).catch(()=>{});

    // Toggle chain field visibility
    const modeEl = document.getElementById('leadFollowupMode');
    modeEl.onchange = function() {
        document.getElementById('leadChainField').style.display = this.value === 'automatic' ? 'block' : 'none';
    };

    openModal('addLeadModal');
}

async function saveLead() {
    const name = document.getElementById('leadName').value.trim();
    const email = document.getElementById('leadEmail').value.trim();
    if (!name || !email) { toast('Name and email required', 'error'); return; }

    const followupMode = document.getElementById('leadFollowupMode')?.value || 'manual';
    const chainId = document.getElementById('leadChainSelect')?.value || null;

    try {
        const res = await apiFetch('/client/leads', 'POST', {
            name, email,
            phone: document.getElementById('leadPhone').value,
            company: document.getElementById('leadCompany').value,
            status: document.getElementById('leadStatus').value,
            lead_temperature: 'cold',  // Always start as cold — auto-updated by engagement
            followup_mode: followupMode,
            chain_id: followupMode === 'automatic' && chainId ? parseInt(chainId) : null,
            notes: document.getElementById('leadNotes').value,
            createdBy: S.user.name || S.user.email,
        });
        const data = await res.json();
        if (data.success || data.lead || data.id) {
            toast('Lead created', 'success');
            closeModal('addLeadModal');
            await loadLeads();
        } else {
            toast(data.message || 'Failed to create lead', 'error');
        }
    } catch(e) {
        toast('Error creating lead', 'error');
    }
}

function openEditLeadModal(lead) {
    // Simple inline edit — for brevity opening add modal pre-filled
    toast('Edit functionality — use admin portal for advanced editing', 'success');
}

async function sendFollowUpEmail(leadId, email) {
    if (!email) { toast('No email on file', 'error'); return; }
    try {
        const res = await apiFetch(`/client/leads/${leadId}/followup`, 'POST', {
            sentBy: S.user.name || S.user.email,
        });
        const data = await res.json();
        toast(data.success ? 'Follow-up email sent' : (data.message||'Failed'), data.success?'success':'error');
    } catch {
        toast('Error sending email', 'error');
    }
}

// ============================================================
// MY LEADS — personal view with analytics
// ============================================================
const ML = { leads: [], analytics: null, tab: 'all', teamMembers: [] };

async function loadMyLeads() {
    const el = document.getElementById('myLeadsTable');
    el.innerHTML = `<div style="padding:40px;text-align:center;color:var(--text-3);"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="animation:spin 1s linear infinite;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto;"><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" stroke-opacity=".2"/><path d="M21 12a9 9 0 0 0-9-9"/></svg>Loading...</div>`;

    try {
        const [leadsRes, membersRes] = await Promise.all([
            apiFetch('/client/leads?mine=1').then(r => r.json()),
            apiFetch('/client/team-members').then(r => r.json()).catch(() => ({ members: [] }))
        ]);
        ML.leads = leadsRes.leads || [];
        ML.analytics = leadsRes.analytics || null;
        ML.teamMembers = membersRes.members || [];
    } catch(e) {
        ML.leads = []; ML.analytics = null;
    }

    renderMyLeadsAnalytics();
    renderMyLeads();
}

function renderMyLeadsAnalytics() {
    const el = document.getElementById('myLeadsAnalytics');
    if (!el || !ML.analytics) { el && (el.innerHTML = ''); return; }
    const a = ML.analytics;
    const total = parseInt(a.total) || 0;
    if (total === 0) { el.innerHTML = ''; return; }

    const statuses = [
        { key: 'new',         label: 'New',          color: '#6366f1' },
        { key: 'contacted',   label: 'Contacted',    color: '#3b82f6' },
        { key: 'qualified',   label: 'Qualified',    color: '#f59e0b' },
        { key: 'proposal',    label: 'Proposal',     color: '#8b5cf6' },
        { key: 'negotiation', label: 'Negotiation',  color: '#ec4899' },
        { key: 'closed',      label: 'Closed',       color: '#10b981' },
        { key: 'lost',        label: 'Lost',         color: '#ef4444' },
    ];

    const maxVal = Math.max(...statuses.map(s => parseInt(a[s.key]) || 0), 1);

    el.innerHTML = `
        <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 24px;margin-bottom:4px;">
            <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:16px;">
                <div style="font-size:13px;font-weight:700;color:var(--text-0);">Pipeline Overview</div>
                <div style="font-size:13px;color:var(--text-2);">${total} total assigned</div>
            </div>
            <div style="display:flex;align-items:flex-end;gap:10px;height:80px;">
                ${statuses.map(s => {
                    const val = parseInt(a[s.key]) || 0;
                    const pct = maxVal > 0 ? Math.round((val / maxVal) * 100) : 0;
                    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;height:100%;justify-content:flex-end;cursor:pointer;" onclick="setMyLeadTab('${s.key}', document.querySelector('[onclick*=\\'${s.key}\\']'))">
                        <div style="font-size:11px;font-weight:700;color:var(--text-1);">${val}</div>
                        <div style="width:100%;background:${s.color};border-radius:3px 3px 0 0;height:${Math.max(pct, val > 0 ? 8 : 2)}%;opacity:0.85;transition:opacity 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.85"></div>
                        <div style="font-size:10px;color:var(--text-3);white-space:nowrap;">${s.label}</div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
}

function renderMyLeads() {
    const el = document.getElementById('myLeadsTable');
    const q  = (document.getElementById('myLeadsSearch')||{}).value?.toLowerCase() || '';
    const tab = ML.tab;

    let filtered = ML.leads;
    if (tab !== 'all') {
        filtered = filtered.filter(l => {
            const s = (l.status || l.lead_temperature || 'new').toLowerCase();
            if (tab === 'closed') return s === 'closed' || l.is_customer;
            return s === tab;
        });
    }
    if (q) {
        filtered = filtered.filter(l =>
            (l.name||'').toLowerCase().includes(q) ||
            (l.email||'').toLowerCase().includes(q) ||
            (l.company||'').toLowerCase().includes(q)
        );
    }

    if (!filtered.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <h3>${tab === 'all' ? 'No leads assigned to you' : 'No ' + tab + ' leads'}</h3>
            <p>${tab === 'all' ? 'Leads assigned to you will appear here' : 'Try a different filter'}</p></div>`;
        return;
    }

    // Split active vs closed
    const active = filtered.filter(l => (l.status||'').toLowerCase() !== 'closed' && !l.is_customer || tab !== 'all');
    const closed = tab === 'all' ? filtered.filter(l => (l.status||'').toLowerCase() === 'closed' || l.is_customer) : [];

    const buildRows = (rows) => rows.map(l => `
        <tr style="cursor:pointer;" onclick="openLeadProfile(${JSON.stringify(l).replace(/"/g,'&quot;')})">
            <td style="font-weight:500;">${escHtml(l.name||'—')}</td>
            <td style="color:var(--text-2);">${escHtml(l.email||'—')}</td>
            <td style="color:var(--text-2);">${escHtml(l.company||'—')}</td>
            <td>${statusBadge(l.status||l.lead_temperature||'new')}</td>
            <td style="color:var(--text-3);font-size:12px;">${fmtDate(l.updated_at||l.created_at)}</td>
            <td>
                <div class="row-actions" onclick="event.stopPropagation()">
                    <button class="btn btn-ghost btn-xs" onclick="openAssignModal(${l.id},'${escHtml(l.name||'')}',${l.crm_assigned_to||'null'})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                        Assign
                    </button>
                </div>
            </td>
        </tr>`).join('');

    const thead = `<thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Status</th><th>Updated</th><th></th></tr></thead>`;

    let html = `<table>${thead}<tbody>${buildRows(tab === 'all' ? (active.length ? active : []) : filtered)}</tbody></table>`;

    if (tab === 'all' && closed.length) {
        html += `
            <div style="margin-top:24px;">
                <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);padding:0 4px 10px;">
                    Closed / Customers (${closed.length})
                </div>
                <div style="opacity:0.7;">
                    <table>${thead}<tbody>${buildRows(closed)}</tbody></table>
                </div>
            </div>`;
    }

    el.innerHTML = html;
}

function filterMyLeads() { renderMyLeads(); }

function setMyLeadTab(tab, el) {
    ML.tab = tab;
    document.querySelectorAll('.my-lead-tab').forEach(b => {
        b.classList.toggle('active-tab', b === el);
        b.style.borderBottom = b === el ? '2px solid var(--text-0)' : '';
    });
    renderMyLeads();
}

// ============================================================
// LEAD PROFILE MODAL — full info view
// ============================================================
function openLeadProfile(lead) {
    let modal = document.getElementById('leadProfileModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'leadProfileModal';
        modal.className = 'modal-overlay';
        modal.onclick = (e) => { if (e.target === modal) closeModal('leadProfileModal'); };
        document.body.appendChild(modal);
    }

    const statusColors = {
        new: '#6366f1', contacted: '#3b82f6', qualified: '#f59e0b',
        proposal: '#8b5cf6', negotiation: '#ec4899', closed: '#10b981',
        lost: '#ef4444', hot: '#ef4444', cold: '#6366f1', warm: '#f59e0b'
    };
    const st = (lead.status || lead.lead_temperature || 'new').toLowerCase();
    const stColor = statusColors[st] || '#6366f1';
    const isHot = lead.lead_temperature === 'hot';

    const field = (label, value) => value
        ? `<div style="margin-bottom:14px;"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);margin-bottom:3px;">${label}</div><div style="font-size:14px;color:var(--text-1);">${escHtml(String(value))}</div></div>`
        : '';

    modal.innerHTML = `
        <div class="modal" style="max-width:580px;width:calc(100% - 32px);">
            <div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <div style="width:44px;height:44px;border-radius:50%;background:${stColor}22;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:${stColor};">
                        ${(lead.name||'?').charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div style="font-size:17px;font-weight:800;color:var(--text-0);">${escHtml(lead.name||'Unnamed')}</div>
                        <div style="font-size:12px;color:var(--text-3);">${escHtml(lead.email||'')}</div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="background:${isHot?'#ef444422':'#6366f122'};color:${isHot?'#ef4444':'#6366f1'};padding:4px 12px;border-radius:20px;font-size:11px;font-weight:800;">
                        ${isHot ? '🔥 Hot' : '❄️ Cold'}
                    </span>
                    <button class="modal-close" onclick="closeModal('leadProfileModal')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Temperature toggle -->
                <div style="display:flex;gap:8px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);">
                    <button class="btn btn-xs ${isHot ? 'btn-ghost' : 'btn-default'}" style="font-size:12px;" onclick="toggleLeadTemperature(${lead.id},'cold','leadProfileModal')">
                        ❄️ Mark Cold
                    </button>
                    <button class="btn btn-xs ${isHot ? 'btn-default' : 'btn-ghost'}" style="font-size:12px;background:${isHot?'#ef4444':''};color:${isHot?'#fff':''};" onclick="toggleLeadTemperature(${lead.id},'hot','leadProfileModal')">
                        🔥 Mark Hot
                    </button>
                    ${isHot ? `<button class="btn btn-xs btn-ghost" style="font-size:12px;margin-left:auto;" onclick="openHotChainEnrollModal(${lead.id},'${escHtml(lead.name||'')}')">
                        ⚡ Start Hot Sequence
                    </button>` : ''}
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 24px;">
                    ${field('Phone', lead.phone)}
                    ${field('Company', lead.company)}
                    ${field('Source', lead.source)}
                    ${field('Assigned To', lead.assigned_to_name || 'Unassigned')}
                    ${field('Follow-up Count', lead.follow_up_count !== undefined ? lead.follow_up_count : null)}
                    ${field('Last Contact', lead.last_contact_date ? new Date(lead.last_contact_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'Never')}
                    ${field('Became Hot', lead.became_hot_at ? new Date(lead.became_hot_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : null)}
                    ${field('Customer Status', lead.customer_status)}
                    ${field('Created', lead.created_at ? new Date(lead.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : null)}
                </div>
                ${lead.notes ? `<div style="margin-top:4px;padding:14px;background:var(--bg-1);border-radius:var(--r-md);"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);margin-bottom:6px;">Notes</div><div style="font-size:13px;color:var(--text-1);white-space:pre-wrap;">${escHtml(lead.notes)}</div></div>` : ''}
                ${lead.address_line1 ? `<div style="margin-top:14px;">${field('Address', [lead.address_line1, lead.address_line2, lead.city, lead.state, lead.zip_code].filter(Boolean).join(', '))}</div>` : ''}
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('leadProfileModal')">Close</button>
                <button class="btn btn-ghost" onclick="closeModal('leadProfileModal');openAssignModal(${lead.id},'${escHtml(lead.name||'')}',${lead.crm_assigned_to||'null'})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                    Reassign
                </button>
                <button class="btn btn-default" onclick="closeModal('leadProfileModal');openEditLeadModal(${JSON.stringify(lead).replace(/"/g,'&quot;')})">Edit Lead</button>
            </div>
        </div>`;

    openModal('leadProfileModal');
}

// Toggle lead temperature (hot ↔ cold) from profile modal
async function toggleLeadTemperature(leadId, newTemp, closeModalId) {
    try {
        const res  = await apiFetch(`/client/leads/${leadId}`, 'PATCH', { lead_temperature: newTemp });
        const data = await res.json();
        if (data.success) {
            const action = newTemp === 'hot' ? '🔥 Lead marked Hot' : '❄️ Lead marked Cold';
            toast(action + (newTemp === 'hot' ? ' — timeline reset, cold chains paused' : ' — hot chains paused, timeline reset'), 'success');
            if (closeModalId) closeModal(closeModalId);
            // Refresh whichever view is active
            if (S.currentPage === 'followups') loadFollowups();
            else if (S.currentPage === 'leads') loadLeads();
            else if (S.currentPage === 'myleads') loadMyLeads();
        } else {
            toast(data.message || 'Could not update temperature', 'error');
        }
    } catch(e) { toast('Error updating lead', 'error'); }
}

// Hot-lead chain enrollment modal (start a specific chain as a hot-lead sequence)
async function openHotChainEnrollModal(leadId, leadName) {
    let chains = [];
    try {
        const r = await apiFetch('/client/email-chains');
        const d = await r.json();
        chains = d.chains || [];
    } catch {}

    let modal = document.getElementById('hotChainModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'hotChainModal';
        modal.className = 'modal-overlay';
        modal.onclick = e => { if (e.target === modal) closeModal('hotChainModal'); };
        document.body.appendChild(modal);
    }
    modal.innerHTML = `
        <div class="modal" style="max-width:420px;width:calc(100% - 32px);">
            <div class="modal-header">
                <div class="modal-title">Start Hot Lead Sequence</div>
                <div style="font-size:13px;color:var(--text-3);">${escHtml(leadName)} — 🔥 Hot</div>
                <button class="modal-close" onclick="closeModal('hotChainModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="modal-body">
                <p style="font-size:13px;color:var(--text-2);margin-bottom:14px;">Select an email chain to run for this hot lead. Their cold sequences will be stopped and this one starts immediately on the hot lead (3.5/7 day) timing.</p>
                ${chains.length === 0
                    ? `<p style="color:var(--text-3);font-size:13px;">No chains yet. <a href="#" onclick="navigateTo('marketing')" style="color:var(--text-0);">Build one in Email Marketing →</a></p>`
                    : `<div class="form-field">
                        <label>Choose Chain</label>
                        <select id="hotChainSelect">
                            <option value="">— Select a chain —</option>
                            ${chains.map(c=>`<option value="${c.id}">${escHtml(c.name)} (${c.steps?.length||0} steps${c.loop?' · loops':''})</option>`).join('')}
                        </select>
                       </div>`
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('hotChainModal')">Cancel</button>
                ${chains.length ? `<button class="btn btn-default" style="background:#ef4444;border-color:#ef4444;" onclick="confirmHotChainEnroll(${leadId})">🔥 Start Sequence</button>` : ''}
            </div>
        </div>`;
    openModal('hotChainModal');
}

async function confirmHotChainEnroll(leadId) {
    const chainId = document.getElementById('hotChainSelect')?.value;
    if (!chainId) { toast('Select a chain', 'error'); return; }
    try {
        const res  = await apiFetch(`/client/leads/${leadId}/hot-enroll`, 'POST', { chain_id: parseInt(chainId) });
        const data = await res.json();
        if (data.success) {
            toast('Hot lead sequence started', 'success');
            closeModal('hotChainModal');
        } else { toast(data.message || 'Failed', 'error'); }
    } catch { toast('Error starting sequence', 'error'); }
}



// ============================================================
// ASSIGN MODAL — assign any lead to any team member
// ============================================================
let _assignLeadId = null;

async function openAssignModal(leadId, leadName, currentAssigneeId) {
    _assignLeadId = leadId;

    // Fetch team members if not loaded
    if (!ML.teamMembers.length) {
        try {
            const r = await apiFetch('/client/team-members').then(res => res.json());
            ML.teamMembers = r.members || [];
        } catch {}
    }

    let modal = document.getElementById('assignLeadModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'assignLeadModal';
        modal.className = 'modal-overlay';
        modal.onclick = (e) => { if (e.target === modal) closeModal('assignLeadModal'); };
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="modal" style="max-width:420px;width:calc(100% - 32px);">
            <div class="modal-header">
                <div class="modal-title">Assign Lead</div>
                <div style="font-size:13px;color:var(--text-3);margin-top:2px;">${escHtml(leadName)}</div>
                <button class="modal-close" onclick="closeModal('assignLeadModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Assign to team member</label>
                    <select id="assigneeSelect">
                        <option value="">— Unassigned —</option>
                        ${ML.teamMembers.map(m => `
                            <option value="${m.id}" ${parseInt(currentAssigneeId) === m.id ? 'selected' : ''}>
                                ${escHtml(m.user_label ? m.user_label + ' — ' : '')}${escHtml(m.user_name)}${m.is_admin ? ' (Admin)' : ''}
                            </option>`).join('')}
                    </select>
                </div>
                ${ML.teamMembers.length === 0 ? '<p style="color:var(--text-3);font-size:13px;">No team members found. This may be an individual account.</p>' : ''}
                <div style="margin-top:8px;">
                    <button class="btn btn-ghost btn-sm" onclick="selfAssignLead(${leadId})" style="font-size:12px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Assign to myself
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('assignLeadModal')">Cancel</button>
                <button class="btn btn-default" onclick="saveAssignment()">Save Assignment</button>
            </div>
        </div>`;

    openModal('assignLeadModal');
}

async function selfAssignLead(leadId) {
    // Find this user's company_users record
    const myEntry = ML.teamMembers.find(m => m.user_email === S.user?.email);
    if (!myEntry) {
        toast('Could not find your team profile — make sure you are logged in as a company user', 'error');
        return;
    }
    document.getElementById('assigneeSelect').value = myEntry.id;
}

async function saveAssignment() {
    if (!_assignLeadId) return;
    const sel = document.getElementById('assigneeSelect');
    const companyUserId = sel.value ? parseInt(sel.value) : null;

    try {
        const res = await apiFetch(`/client/leads/${_assignLeadId}/assign`, 'POST', { companyUserId });
        const data = await res.json();
        if (data.success) {
            toast(data.message || 'Assignment saved', 'success');
            closeModal('assignLeadModal');
            // Refresh whichever view is active
            if (S.page === 'leads') await loadLeads();
            if (S.page === 'myleads') await loadMyLeads();
        } else {
            toast(data.message || 'Failed to save assignment', 'error');
        }
    } catch(e) {
        toast('Error saving assignment', 'error');
    }
}

// ============================================================
// CONTACTS
// ============================================================
async function loadContactsData() {
    try {
        const res = await apiFetch('/client/contacts');
        const data = await res.json();
        S.contacts = data.contacts || [];
    } catch {}
}

async function loadContacts() {
    await loadContactsData();
    renderContacts();
}

function renderContacts() {
    const q = (document.getElementById('contactsSearch')||{}).value?.toLowerCase() || '';
    let data = S.contacts;
    if (q) data = data.filter(c => (c.name||'').toLowerCase().includes(q)||(c.email||'').toLowerCase().includes(q));

    const el = document.getElementById('contactsTable');
    if (!data.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <h3>No contacts</h3><p>Add your first contact</p></div>`;
        return;
    }
    el.innerHTML = `
        <table>
            <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Company</th><th>Added By</th><th>Date</th></tr></thead>
            <tbody>
                ${data.map(c=>`<tr>
                    <td style="font-weight:500;">${escHtml(c.name||'—')}</td>
                    <td style="color:var(--text-2);">${escHtml(c.email||'—')}</td>
                    <td style="color:var(--text-2);">${escHtml(c.phone||'—')}</td>
                    <td style="color:var(--text-2);">${escHtml(c.company||'—')}</td>
                    <td style="color:var(--text-3);font-size:12px;">${escHtml(c.created_by_name||c.added_by||'—')}</td>
                    <td style="color:var(--text-3);font-size:12px;">${fmtDate(c.created_at)}</td>
                </tr>`).join('')}
            </tbody>
        </table>`;
}

function filterContacts() { renderContacts(); }

function openAddContactModal() {
    ['contactName','contactEmail','contactPhone','contactCompany','contactNotes'].forEach(id=>document.getElementById(id).value='');
    openModal('addContactModal');
}

async function saveContact() {
    const name = document.getElementById('contactName').value.trim();
    const email = document.getElementById('contactEmail').value.trim();
    if (!name) { toast('Name required', 'error'); return; }

    try {
        const res = await apiFetch('/client/contacts', 'POST', {
            name, email,
            phone: document.getElementById('contactPhone').value,
            company: document.getElementById('contactCompany').value,
            notes: document.getElementById('contactNotes').value,
            createdByName: S.user.name || S.user.email,
        });
        const data = await res.json();
        if (data.success || data.contact || data.id) {
            toast('Contact added', 'success');
            closeModal('addContactModal');
            await loadContacts();
        } else {
            toast(data.message||'Failed', 'error');
        }
    } catch {
        toast('Error adding contact', 'error');
    }
}

// ============================================================
// FOLLOW-UPS
// ============================================================
// ============================================================
// FOLLOW-UPS — cold/hot lead outreach queue
// ============================================================
const FU = { data: null, tab: 'all' };

async function loadFollowups() {
    const mine = document.getElementById('fuMineOnly')?.checked ? '1' : '0';
    document.getElementById('followupsContent').innerHTML = `<div style="padding:40px;text-align:center;color:var(--text-3);"><div class="spinner" style="margin:0 auto 8px;"></div>Loading...</div>`;
    try {
        const res  = await apiFetch(`/client/follow-ups?mine=${mine}`);
        const data = await res.json();
        FU.data = data;
        renderFollowups();
    } catch(e) {
        document.getElementById('followupsContent').innerHTML = `<div class="empty-state"><p>Could not load follow-ups. ${e.message}</p></div>`;
    }
}

function renderFollowups() {
    const el  = document.getElementById('followupsContent');
    if (!FU.data) return;
    const hot  = FU.data.hot  || [];
    const cold = FU.data.cold || [];
    const all  = [...hot, ...cold];
    const tab  = FU.tab;

    let leads = tab === 'hot'     ? hot
              : tab === 'cold'    ? cold
              : tab === 'overdue' ? all.filter(l => l.is_due && l.days_until_due === 0)
              : all;

    if (!leads.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            <h3>${tab === 'overdue' ? 'No overdue outreach' : 'Queue is clear'}</h3>
            <p>${tab === 'all' ? 'All leads are up to date' : 'Switch tabs to see other leads'}</p></div>`;
        return;
    }

    // Stats bar
    const overdue   = all.filter(l => l.is_due && l.days_until_due === 0).length;
    const dueSoon   = all.filter(l => !l.is_due || l.days_until_due > 0).length;

    el.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
            ${[
                ['Hot Leads',   hot.length,   '#ef4444'],
                ['Cold Leads',  cold.length,  '#6366f1'],
                ['Overdue',     overdue,      '#f59e0b'],
                ['Due Soon',    dueSoon,      '#10b981'],
            ].map(([label,val,color])=>`
                <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px 20px;">
                    <div style="font-size:26px;font-weight:800;color:${color};">${val}</div>
                    <div style="font-size:11px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;">${label}</div>
                </div>`).join('')}
        </div>
        <div class="table-wrap">
            <table>
                <thead><tr>
                    <th>Lead</th><th>Email</th><th>Temp</th>
                    <th>Last Contact</th><th>Follow-ups</th><th>Next Due</th><th></th>
                </tr></thead>
                <tbody>
                    ${leads.map(l => {
                        const isHot     = l.lead_temperature === 'hot';
                        const isOverdue = l.is_due && (parseFloat(l.days_until_due) === 0 || parseFloat(l.days_until_due) < 0);
                        const daysVal   = parseFloat(l.days_until_due);
                        const daysLabel = l.last_contact_date === null
                            ? `<span style="color:#10b981;font-weight:700;">Now</span>`
                            : isOverdue
                                ? `<span style="color:#ef4444;font-weight:700;">⚠ Overdue</span>`
                                : `<span style="color:var(--text-2);">${daysVal === Math.floor(daysVal) ? daysVal : daysVal.toFixed(1)}d</span>`;
                        return `<tr>
                            <td style="font-weight:500;cursor:pointer;" onclick="openLeadProfile(${JSON.stringify(l).replace(/"/g,'&quot;')})">${escHtml(l.name||'—')}</td>
                            <td style="color:var(--text-2);">${escHtml(l.email||'—')}</td>
                            <td>
                                <span style="font-size:11px;font-weight:800;padding:3px 8px;border-radius:20px;background:${isHot?'#ef444422':'#6366f122'};color:${isHot?'#ef4444':'#6366f1'};" title="Temperature set automatically by email engagement">
                                    ${isHot ? '🔥 Hot' : '❄️ Cold'}
                                </span>
                            </td>
                            <td style="font-size:12px;color:var(--text-3);">${l.last_contact_date ? new Date(l.last_contact_date).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '—'}</td>
                            <td style="font-size:12px;color:var(--text-2);">${l.follow_up_count||0}</td>
                            <td>${daysLabel}</td>
                            <td>
                                <div class="row-actions">
                                    <button class="btn btn-ghost btn-xs" onclick="openSendEmailModal(${l.id},'${escHtml(l.email||'')}','${escHtml(l.name||'')}')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:11px;height:11px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                        Send
                                    </button>
                                    ${isHot ? `<button class="btn btn-ghost btn-xs" style="color:#ef4444;" onclick="openHotChainEnrollModal(${l.id},'${escHtml(l.name||'')}')">⚡ Sequence</button>` : ''}
                                </div>
                            </td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>`;
}

function setFUTab(tab, el) {
    FU.tab = tab;
    document.querySelectorAll('.fu-tab').forEach(b => {
        b.classList.remove('active-tab');
        b.style.background = '';
    });
    el.classList.add('active-tab');
    renderFollowups();
}

// Follow-ups main tab (Queue / Templates / Chains)
const FU_MK = { templates: [], chains: [] };

function setFUMainTab(tab, el) {
    document.querySelectorAll('.fu-main-tab').forEach(b => {
        b.classList.remove('active-fu-main-tab');
        b.style.borderBottom = '';
    });
    if (el) { el.classList.add('active-fu-main-tab'); el.style.borderBottom = '2px solid var(--text-0)'; }

    document.getElementById('fuQueueSection').style.display    = tab === 'queue'     ? 'block' : 'none';
    document.getElementById('fuTemplatesSection').style.display = tab === 'templates' ? 'block' : 'none';
    document.getElementById('fuChainsSection').style.display   = tab === 'chains'    ? 'block' : 'none';

    if (tab === 'templates') loadFUTemplates();
    if (tab === 'chains')    loadFUChains();
    if (tab === 'queue')     loadFollowups();
}

async function loadFUTemplates() {
    const el = document.getElementById('fuTemplatesContent');
    el.innerHTML = `<div style="padding:40px;text-align:center;"><div class="spinner" style="margin:0 auto;"></div></div>`;
    try {
        const r = await apiFetch('/client/email-templates');
        const d = await r.json();
        FU_MK.templates = d.templates || [];
        renderFUTemplates();
    } catch { el.innerHTML = '<div class="empty-state"><p>Could not load templates</p></div>'; }
}

function renderFUTemplates() {
    const el = document.getElementById('fuTemplatesContent');
    if (!FU_MK.templates.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:40px;height:40px;"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            <h3>No follow-up templates</h3>
            <p>Create a template to use in follow-up chains and manual sends</p>
        </div>`;
        return;
    }
    el.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;">
        ${FU_MK.templates.map(t => `
            <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 22px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                    <div>
                        <div style="font-size:14px;font-weight:700;color:var(--text-0);">${escHtml(t.name)}</div>
                        <div style="font-size:11px;color:var(--text-3);margin-top:2px;">${escHtml(t.topic||'custom')}</div>
                    </div>
                    ${t.is_automated ? `<span style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:0.5px;padding:3px 8px;border-radius:20px;background:#6366f122;color:#6366f1;">Auto</span>` : ''}
                </div>
                <div style="font-size:12px;color:var(--text-2);margin-bottom:14px;font-style:italic;">"${escHtml(t.subject)}"</div>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-ghost btn-xs" onclick="openFUTemplateBuilder(${JSON.stringify(t).replace(/"/g,'&quot;')})">Edit</button>
                    <button class="btn btn-ghost btn-xs" style="color:#ef4444;" onclick="deleteFUTemplate(${t.id})">Delete</button>
                </div>
            </div>`).join('')}
    </div>`;
}

function openFUTemplateBuilder(existing) {
    // Delegate to the shared template builder — same builder used for marketing
    // but tagged as follow-up template
    openTemplateBuilder(existing);
}

async function deleteFUTemplate(id) {
    if (!confirm('Delete this template?')) return;
    try {
        await apiFetch(`/client/email-templates/${id}`, 'DELETE');
        toast('Template deleted', 'success');
        await loadFUTemplates();
    } catch { toast('Error', 'error'); }
}

async function loadFUChains() {
    const el = document.getElementById('fuChainsContent');
    el.innerHTML = `<div style="padding:40px;text-align:center;"><div class="spinner" style="margin:0 auto;"></div></div>`;
    try {
        const r = await apiFetch('/client/email-chains');
        const d = await r.json();
        FU_MK.chains = d.chains || [];
        renderFUChains();
    } catch { el.innerHTML = '<div class="empty-state"><p>Could not load chains</p></div>'; }
}

function renderFUChains() {
    const el = document.getElementById('fuChainsContent');
    if (!FU_MK.chains.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:40px;height:40px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            <h3>No follow-up chains</h3>
            <p>Build a chain to automatically send a sequence of emails to leads set to Automatic follow-up</p>
        </div>`;
        return;
    }
    el.innerHTML = FU_MK.chains.map(c => `
        <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 24px;margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <div>
                    <div style="font-size:15px;font-weight:700;">${escHtml(c.name)}</div>
                    <div style="font-size:11px;color:var(--text-3);margin-top:2px;">${c.steps?.length||0} steps · ${c.loop?'Loops indefinitely':'Runs once'}</div>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-ghost btn-xs" onclick="enrollInChain(${c.id},'${escHtml(c.name)}')">Enroll Leads</button>
                    <button class="btn btn-ghost btn-xs" style="color:#ef4444;" onclick="deleteFUChain(${c.id})">Delete</button>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:0;flex-wrap:wrap;">
                ${(c.steps||[]).map((s,i) => `
                    <div style="display:flex;align-items:center;">
                        <div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--r-md);padding:8px 14px;font-size:12px;">
                            <div style="font-weight:700;color:var(--text-0);">Step ${i+1}</div>
                            <div style="color:var(--text-2);">${escHtml(s.template_name||'?')}</div>
                            ${i > 0 ? `<div style="font-size:10px;color:var(--text-3);">After ${s.delay_days}d</div>` : ''}
                        </div>
                        ${i < (c.steps.length-1) ? `<div style="padding:0 6px;color:var(--text-3);">→</div>` : c.loop ? `<div style="padding:0 6px;color:#6366f1;font-size:11px;font-weight:700;">→ 🔄</div>` : ''}
                    </div>`).join('')}
            </div>
        </div>`).join('');
}

function openFUChainBuilder() {
    // Reuse the same chain builder modal
    openChainBuilder();
}

async function deleteFUChain(id) {
    if (!confirm('Delete this chain?')) return;
    try {
        await apiFetch(`/client/email-chains/${id}`, 'DELETE');
        toast('Chain deleted', 'success');
        await loadFUChains();
    } catch { toast('Error', 'error'); }
}

// Quick send-email modal from follow-up queue
async function openSendEmailModal(leadId, leadEmail, leadName) {
    // Load templates
    let templates = [];
    try {
        const r = await apiFetch('/client/email-templates');
        const d = await r.json();
        templates = d.templates || [];
    } catch {}

    let modal = document.getElementById('quickSendModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'quickSendModal';
        modal.className = 'modal-overlay';
        modal.onclick = e => { if (e.target === modal) closeModal('quickSendModal'); };
        document.body.appendChild(modal);
    }
    modal.innerHTML = `
        <div class="modal" style="max-width:460px;width:calc(100% - 32px);">
            <div class="modal-header">
                <div class="modal-title">Send Email</div>
                <div style="font-size:13px;color:var(--text-3);">${escHtml(leadName)} — ${escHtml(leadEmail)}</div>
                <button class="modal-close" onclick="closeModal('quickSendModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="modal-body">
                ${templates.length === 0
                    ? `<p style="color:var(--text-3);font-size:13px;">No templates yet. <a href="#" onclick="navigateTo('marketing')">Create one in Email Marketing →</a></p>`
                    : `<div class="form-field">
                        <label>Choose Template</label>
                        <select id="quickSendTemplate">
                            <option value="">— Select a template —</option>
                            ${templates.map(t=>`<option value="${t.id}">${escHtml(t.name)} — ${escHtml(t.subject)}</option>`).join('')}
                        </select>
                       </div>`
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('quickSendModal')">Cancel</button>
                ${templates.length ? `<button class="btn btn-default" onclick="quickSendEmail(${leadId})">Send Email</button>` : ''}
            </div>
        </div>`;
    openModal('quickSendModal');
}

async function quickSendEmail(leadId) {
    const templateId = document.getElementById('quickSendTemplate')?.value;
    if (!templateId) { toast('Select a template', 'error'); return; }
    try {
        const res = await apiFetch('/client/email/send', 'POST', { template_id: parseInt(templateId), lead_ids: [leadId] });
        const data = await res.json();
        if (data.success) {
            toast(`Email sent (${data.sent} sent, ${data.skipped} skipped)`, 'success');
            closeModal('quickSendModal');
            await loadFollowups();
        } else { toast(data.message||'Failed to send', 'error'); }
    } catch(e) { toast('Error sending email', 'error'); }
}


async function toggleAutoReply(leadId, enable) {
    try {
        const res = await apiFetch(`/client/leads/${leadId}/auto-reply`, 'POST', { enabled: enable });
        const data = await res.json();
        toast(data.success ? `Auto-reply ${enable ? 'enabled' : 'disabled'}` : (data.message||'Failed'), data.success?'success':'error');
        if (data.success) loadFollowups();
    } catch {
        toast('Error updating auto-reply', 'error');
    }
}

function openAutoReplyBuilder() {
    document.getElementById('autoReplyTemplates').innerHTML = `
        <div class="template-card">
            <div class="template-card-header">
                <span class="template-card-name">Day 1 — Initial Follow-up</span>
                <button class="btn btn-ghost btn-xs" onclick="this.closest('.template-card').remove()">Remove</button>
            </div>
            <div class="form-field"><label class="form-label">Subject</label><input class="form-input" value="Following up on our conversation"></div>
            <div class="form-field"><label class="form-label">Message</label><textarea class="form-input" style="min-height:80px;">Hi {{name}}, just following up to see if you had any questions...</textarea></div>
        </div>`;
    openModal('autoReplyModal');
}

function addAutoReplyTemplate() {
    const container = document.getElementById('autoReplyTemplates');
    const div = document.createElement('div');
    div.className = 'template-card';
    div.innerHTML = `
        <div class="template-card-header">
            <span class="template-card-name">New Template</span>
            <button class="btn btn-ghost btn-xs" onclick="this.closest('.template-card').remove()">Remove</button>
        </div>
        <div class="form-field"><label class="form-label">Subject</label><input class="form-input" placeholder="Email subject..."></div>
        <div class="form-field"><label class="form-label">Message</label><textarea class="form-input" style="min-height:80px;" placeholder="Use {{name}} for personalization..."></textarea></div>`;
    container.appendChild(div);
}

async function saveAutoReplyTemplates() {
    toast('Templates saved', 'success');
    closeModal('autoReplyModal');
}

// ============================================================
// MARKETING
// ============================================================
function setMKTab(tab, el) {
    document.querySelectorAll('.mk-tab').forEach(b => b.classList.remove('active-tab'));
    el.classList.add('active-tab');
}

function openNewCampaignModal() {
    ['campaignName','campaignSubject','campaignBody'].forEach(id=>document.getElementById(id).value='');
    openModal('newCampaignModal');
}

async function sendCampaign() {
    const name = document.getElementById('campaignName').value.trim();
    const subject = document.getElementById('campaignSubject').value.trim();
    const body = document.getElementById('campaignBody').value.trim();
    const audience = document.getElementById('campaignAudience').value;
    if (!name||!subject||!body) { toast('Please fill all fields', 'error'); return; }

    try {
        const res = await apiFetch('/client/campaigns', 'POST', { name, subject, body, audience, sentBy: S.user.name });
        const data = await res.json();
        toast(data.success ? 'Campaign sent!' : (data.message||'Failed'), data.success?'success':'error');
        if (data.success) closeModal('newCampaignModal');
    } catch {
        toast('Error sending campaign', 'error');
    }
}

async function saveCampaignDraft() {
    toast('Draft saved', 'success');
    closeModal('newCampaignModal');
}

// ============================================================
// SCHEDULING
// ============================================================
async function loadScheduling() {
    const linkEl = document.getElementById('bookingLinkDisplay');
    const listEl = document.getElementById('schedulingList');
    const link = `${window.location.origin}/schedule.html?uid=${S.user.id}`;
    linkEl.textContent = link;

    try {
        const res = await apiFetch('/client/appointments');
        const data = await res.json();
        const appts = data.appointments || [];
        if (!appts.length) {
            listEl.innerHTML = `<div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                <h3>No appointments</h3><p>Share your booking link to get started</p>
            </div>`;
            return;
        }
        listEl.innerHTML = `<div class="table-wrap"><table>
            <thead><tr><th>Client</th><th>Email</th><th>Date & Time</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
                ${appts.map(a=>`<tr>
                    <td style="font-weight:500;">${escHtml(a.name||a.client_name||'—')}</td>
                    <td style="color:var(--text-2);font-size:12px;">${escHtml(a.client_email||a.email||'—')}</td>
                    <td style="font-size:13px;">${fmtDateTime(a.scheduled_at||a.date)}</td>
                    <td>${statusBadge(a.status||'scheduled')}</td>
                    <td>
                        <div style="display:flex;gap:6px;">
                            <button class="btn btn-ghost btn-xs" onclick="openRescheduleModal(${a.id},'${escHtml(a.name||a.client_name||'')}','${escHtml(a.client_email||a.email||'')}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:11px;height:11px;"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                Reschedule
                            </button>
                            ${a.status !== 'cancelled' ? `<button class="btn btn-danger btn-xs" onclick="cancelAppointment(${a.id},'${escHtml(a.name||a.client_name||'')}','${escHtml(a.client_email||a.email||'')}')">Cancel</button>` : ''}
                        </div>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table></div>`;
    } catch {}
}

async function openAddAppointmentModal() {
    let modal = document.getElementById('addApptModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'addApptModal';
        modal.className = 'modal-overlay';
        modal.onclick = e => { if(e.target===modal) closeModal('addApptModal'); };
        document.body.appendChild(modal);
    }
    modal.innerHTML = `
        <div class="modal" style="max-width:480px;width:calc(100% - 32px);">
            <div class="modal-header">
                <div class="modal-title">Add Appointment</div>
                <button class="modal-close" onclick="closeModal('addApptModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-field"><label class="form-label">Client Name</label><input class="form-input" id="apptClientName" placeholder="Full name"></div>
                    <div class="form-field"><label class="form-label">Client Email</label><input class="form-input" id="apptClientEmail" type="email" placeholder="client@example.com"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label class="form-label">Date</label><input class="form-input" type="date" id="apptDate"></div>
                    <div class="form-field"><label class="form-label">Time</label><input class="form-input" type="time" id="apptTime"></div>
                </div>
                <div class="form-field"><label class="form-label">Notes</label><textarea class="form-input" id="apptNotes" placeholder="Meeting notes..."></textarea></div>
                <div style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:var(--r-md);padding:10px 14px;font-size:12px;color:#4ade80;">
                    A confirmation email will automatically be sent to the client.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('addApptModal')">Cancel</button>
                <button class="btn btn-white" onclick="saveNewAppointment()">Add Appointment</button>
            </div>
        </div>`;
    openModal('addApptModal');
}

async function saveNewAppointment() {
    const name  = document.getElementById('apptClientName')?.value.trim();
    const email = document.getElementById('apptClientEmail')?.value.trim();
    const date  = document.getElementById('apptDate')?.value;
    const time  = document.getElementById('apptTime')?.value;
    if (!name || !date || !time) { toast('Name, date and time required', 'error'); return; }

    const scheduledAt = new Date(`${date}T${time}`).toISOString();

    try {
        const res = await apiFetch('/client/appointments', 'POST', {
            clientName: name, clientEmail: email,
            scheduled_at: scheduledAt,
            notes: document.getElementById('apptNotes')?.value,
            sendConfirmation: true,
        });
        const data = await res.json();
        if (data.success || data.appointment) {
            toast('Appointment added — confirmation email sent', 'success');
            closeModal('addApptModal');
            await loadScheduling();
        } else { toast(data.message||'Failed', 'error'); }
    } catch { toast('Error adding appointment', 'error'); }
}

async function openRescheduleModal(apptId, clientName, clientEmail) {
    let modal = document.getElementById('rescheduleModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'rescheduleModal';
        modal.className = 'modal-overlay';
        modal.onclick = e => { if(e.target===modal) closeModal('rescheduleModal'); };
        document.body.appendChild(modal);
    }
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;width:calc(100% - 32px);">
            <div class="modal-header">
                <div class="modal-title">Reschedule Appointment</div>
                <div style="font-size:13px;color:var(--text-3);">${escHtml(clientName)}</div>
                <button class="modal-close" onclick="closeModal('rescheduleModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-field"><label class="form-label">New Date</label><input class="form-input" type="date" id="reschedDate"></div>
                    <div class="form-field"><label class="form-label">New Time</label><input class="form-input" type="time" id="reschedTime"></div>
                </div>
                <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:var(--r-md);padding:10px 14px;font-size:12px;color:#fbbf24;">
                    A reschedule confirmation email will be sent to ${escHtml(clientEmail || 'the client')}.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('rescheduleModal')">Cancel</button>
                <button class="btn btn-white" onclick="confirmReschedule(${apptId},'${escHtml(clientEmail)}')">Reschedule & Notify</button>
            </div>
        </div>`;
    openModal('rescheduleModal');
}

async function confirmReschedule(apptId, clientEmail) {
    const date = document.getElementById('reschedDate')?.value;
    const time = document.getElementById('reschedTime')?.value;
    if (!date || !time) { toast('Date and time required', 'error'); return; }

    const scheduledAt = new Date(`${date}T${time}`).toISOString();
    try {
        const res = await apiFetch(`/client/appointments/${apptId}/reschedule`, 'POST', {
            scheduled_at: scheduledAt, sendConfirmation: true
        });
        const data = await res.json();
        if (data.success) {
            toast('Appointment rescheduled — confirmation email sent', 'success');
            closeModal('rescheduleModal');
            await loadScheduling();
        } else { toast(data.message||'Failed', 'error'); }
    } catch { toast('Error rescheduling', 'error'); }
}

async function cancelAppointment(apptId, clientName, clientEmail) {
    if (!confirm(`Cancel appointment with ${clientName}? A cancellation email will be sent.`)) return;
    try {
        const res = await apiFetch(`/client/appointments/${apptId}/cancel`, 'POST', { sendConfirmation: true });
        const data = await res.json();
        if (data.success) {
            toast('Appointment cancelled — confirmation email sent', 'success');
            await loadScheduling();
        } else { toast(data.message||'Failed', 'error'); }
    } catch { toast('Error cancelling appointment', 'error'); }
}

function copySchedulingLink() {
    const link = `${window.location.origin}/schedule.html?uid=${S.user.id}`;
    navigator.clipboard.writeText(link).then(() => toast('Booking link copied!', 'success'));
}

// ============================================================
// INVOICES
// ============================================================
async function loadInvoices() {
    try {
        const res = await apiFetch('/client/invoices');
        const data = await res.json();
        S.invoices = data.invoices || [];
        renderInvoices();
    } catch {}
}

function renderInvoices() {
    const el = document.getElementById('invoicesTableWrap');
    if (!S.invoices.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
            <h3>No invoices</h3><p>Create your first invoice</p></div>`;
        return;
    }
    el.innerHTML = `<table>
        <thead><tr><th>Invoice</th><th>Description</th><th>Amount</th><th>Status</th><th>Due</th><th>Actions</th></tr></thead>
        <tbody>
            ${S.invoices.map(inv=>{
                const status = inv.status || 'pending';
                const amt = parseFloat(inv.total_amount||inv.amount||0);
                const badgeClass = status==='paid'?'badge-green':status==='overdue'?'badge-red':'badge-yellow';
                return `<tr>
                    <td style="font-family:var(--font-mono);font-size:12px;color:var(--text-3);">${escHtml(inv.invoice_number||'#'+inv.id)}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escHtml(inv.notes||inv.description||'—')}</td>
                    <td style="font-weight:600;">$${amt.toFixed(2)}</td>
                    <td><span class="badge ${badgeClass}">${status}</span></td>
                    <td style="font-size:12px;color:var(--text-3);">${fmtDate(inv.due_date)}</td>
                    <td>
                        <div style="display:flex;gap:6px;">
                            ${status !== 'paid' ? `<button class="btn btn-ghost btn-xs" onclick="payInvoice(${inv.id})">Pay</button>` : ''}
                            <button class="btn btn-ghost btn-xs" onclick="emailInvoice(${inv.id})">Email</button>
                        </div>
                    </td>
                </tr>`;
            }).join('')}
        </tbody>
    </table>`;
}

function openCreateInvoiceModal() {
    ['invClient','invEmail','invDesc','invAmount'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('invDue').value = '';
    document.getElementById('invEmailCheck').checked = true;
    openModal('createInvoiceModal');
}

async function createInvoice() {
    const client = document.getElementById('invClient').value.trim();
    const email  = document.getElementById('invEmail').value.trim();
    const desc   = document.getElementById('invDesc').value.trim();
    const amount = parseFloat(document.getElementById('invAmount').value);
    const due    = document.getElementById('invDue').value;
    const sendEmail = document.getElementById('invEmailCheck').checked;

    if (!client||!amount) { toast('Client and amount required', 'error'); return; }

    try {
        const res = await apiFetch('/client/invoices/create', 'POST', {
            clientName: client, clientEmail: email,
            description: desc, amount, dueDate: due,
            sendEmail, createdBy: S.user.name || S.user.email,
        });
        const data = await res.json();
        if (data.success || data.invoice) {
            toast('Invoice created' + (sendEmail ? ' and emailed' : ''), 'success');
            closeModal('createInvoiceModal');
            await loadInvoices();
        } else {
            toast(data.message||'Failed', 'error');
        }
    } catch {
        toast('Error creating invoice', 'error');
    }
}

async function payInvoice(invoiceId) {
    try {
        const res = await apiFetch(`/client/invoice/${invoiceId}/payment-link`);
        const data = await res.json();
        if (data.paymentLink) {
            window.location.href = data.paymentLink;
        } else if (data.isPaid) {
            toast('Invoice already paid', 'success');
            loadInvoices();
        } else {
            toast(data.message||'Cannot open payment link', 'error');
        }
    } catch {
        toast('Error loading payment', 'error');
    }
}

async function emailInvoice(invoiceId) {
    try {
        const res = await apiFetch(`/client/invoice/${invoiceId}/email`, 'POST', {});
        const data = await res.json();
        toast(data.success ? 'Invoice emailed' : (data.message||'Failed'), data.success?'success':'error');
    } catch {
        toast('Error sending email', 'error');
    }
}

// ============================================================
// ANALYTICS
// ============================================================
async function loadAnalytics() {
    const el = document.getElementById('analyticsContent');
    el.innerHTML = `<div style="padding:40px;text-align:center;"><div class="spinner" style="margin:0 auto 8px;"></div>Loading...</div>`;

    // Show admin controls if admin
    if (S.isAdmin) {
        const adminBar = document.getElementById('analyticsAdminControls');
        if (adminBar) {
            adminBar.style.display = '';
            // Populate team members dropdown if empty
            const sel = document.getElementById('analyticsUserSelect');
            if (sel && sel.options.length <= 1) {
                try {
                    const r = await apiFetch('/client/team-members');
                    const d = await r.json();
                    (d.members||[]).forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.user_email;
                        opt.textContent = (m.user_label ? m.user_label + ' — ' : '') + m.user_name;
                        sel.appendChild(opt);
                    });
                } catch {}
            }
        }
    }

    const selectedEmail = document.getElementById('analyticsUserSelect')?.value || '';
    const url = '/client/analytics' + (selectedEmail ? `?user_email=${encodeURIComponent(selectedEmail)}` : '');

    try {
        const [analyticsRes, teamRes] = await Promise.all([
            apiFetch(url).then(r => r.json()),
            S.isAdmin ? apiFetch('/client/analytics/team').then(r => r.json()).catch(()=>({team:[]})) : Promise.resolve({team:[]})
        ]);

        const a = analyticsRes.analytics || {};
        const em = a.email || {};
        const le = a.leads || {};

        const subtitle = document.getElementById('analyticsSubtitle');
        if (subtitle) subtitle.textContent = selectedEmail ? `Viewing: ${a.user_name || selectedEmail}` : 'Your performance metrics';

        const metricCard = (label, value, sub, color='var(--text-0)') => `
            <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 24px;">
                <div style="font-size:28px;font-weight:800;color:${color};">${value}</div>
                <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-2);margin-top:4px;">${label}</div>
                ${sub ? `<div style="font-size:11px;color:var(--text-3);margin-top:4px;">${sub}</div>` : ''}
            </div>`;

        const barRow = (label, val, max, color) => {
            const pct = max > 0 ? Math.round((val/max)*100) : 0;
            return `<div style="margin-bottom:14px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                    <span style="font-size:13px;color:var(--text-1);">${label}</span>
                    <span style="font-size:13px;font-weight:700;color:var(--text-0);">${val}</span>
                </div>
                <div style="height:6px;background:var(--bg-3);border-radius:3px;">
                    <div style="height:6px;width:${pct}%;background:${color};border-radius:3px;transition:width .4s;"></div>
                </div>
            </div>`;
        };

        let teamHtml = '';
        if (S.isAdmin && teamRes.team?.length) {
            teamHtml = `
                <div style="margin-top:24px;">
                    <div style="font-size:13px;font-weight:700;color:var(--text-0);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px;">Team Overview</div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr>
                                <th>Team Member</th><th>Leads</th><th>Hot</th><th>Closed</th>
                                <th>Close Rate</th><th>Emails Sent</th><th>Open Rate</th><th>Click Rate</th>
                            </tr></thead>
                            <tbody>
                                ${teamRes.team.map(m => `<tr style="cursor:pointer;" onclick="document.getElementById('analyticsUserSelect').value='${m.user_email}';loadAnalytics()">
                                    <td>
                                        <div style="font-weight:600;">${escHtml(m.user_name)}</div>
                                        ${m.user_label ? `<div style="font-size:11px;color:var(--text-3);">${escHtml(m.user_label)}</div>` : ''}
                                    </td>
                                    <td>${m.total_leads}</td>
                                    <td><span style="color:#ef4444;font-weight:700;">${m.hot_leads}</span></td>
                                    <td><span style="color:#10b981;font-weight:700;">${m.closed_leads}</span></td>
                                    <td>${m.close_rate}%</td>
                                    <td>${m.sent}</td>
                                    <td>${m.open_rate}%</td>
                                    <td>${m.click_rate}%</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        el.innerHTML = `
            <!-- Email metrics -->
            <div style="margin-bottom:8px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);">Email Performance</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                ${metricCard('Emails Sent', em.sent||0, 'Total sent via Brevo')}
                ${metricCard('Open Rate', (em.open_rate||0)+'%', `${em.opened||0} opened`, em.open_rate >= 25 ? '#10b981' : em.open_rate >= 15 ? '#f59e0b' : '#ef4444')}
                ${metricCard('Click Rate', (em.click_rate||0)+'%', `${em.clicked||0} clicked`, em.click_rate >= 5 ? '#10b981' : em.click_rate >= 2 ? '#f59e0b' : '#ef4444')}
            </div>

            <!-- Lead metrics -->
            <div style="margin-bottom:8px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);">Lead Pipeline</div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
                ${metricCard('Assigned Leads', le.total_assigned||0, 'Total in your name')}
                ${metricCard('Hot Leads', le.hot||0, 'Clicked your website', '#ef4444')}
                ${metricCard('Closed', le.closed||0, 'Converted to customers', '#10b981')}
                ${metricCard('Close Rate', (le.close_rate||0)+'%', 'Leads → customers', le.close_rate >= 20 ? '#10b981' : le.close_rate >= 10 ? '#f59e0b' : '#ef4444')}
            </div>

            <!-- Pipeline breakdown bars -->
            <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 24px;margin-bottom:20px;">
                <div style="font-size:13px;font-weight:700;margin-bottom:16px;">Pipeline Breakdown</div>
                ${barRow('New', le.new||0, le.total_assigned||1, '#6366f1')}
                ${barRow('Hot', le.hot||0, le.total_assigned||1, '#ef4444')}
                ${barRow('Closed', le.closed||0, le.total_assigned||1, '#10b981')}
                ${barRow('Lost', le.lost||0, le.total_assigned||1, '#9ca3af')}
            </div>

            ${teamHtml}`;
    } catch(e) {
        el.innerHTML = `<div class="empty-state"><p>Could not load analytics. ${e.message}</p></div>`;
    }
}


// ============================================================
// TASKS
// ============================================================
async function loadTasksData() {
    try {
        const res = await apiFetch('/client/tasks');
        const data = await res.json();
        S.tasks = data.tasks || [];
    } catch {}
}

async function loadTasks() {
    await loadTasksData();
    renderTasks();
}

function renderTasks() {
    const tab = S.taskTab;
    let data = S.tasks;
    if (tab === 'pending') data = data.filter(t=>t.status!=='completed');
    else if (tab === 'completed') data = data.filter(t=>t.status==='completed');

    const el = document.getElementById('tasksContent');
    if (!data.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="9 11 12 14 22 4"/></svg>
            <h3>No tasks</h3><p>${tab==='completed'?'No completed tasks yet':'All done!'}</p></div>`;
        return;
    }
    el.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px;">
        ${data.map(t=>{
            const priorityClass = t.priority==='high'?'badge-red':t.priority==='medium'?'badge-yellow':'badge-gray';
            return `<div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--r-md);padding:14px;display:flex;align-items:center;gap:12px;">
                <input type="checkbox" ${t.status==='completed'?'checked':''} onclick="toggleTask(${t.id})"
                    style="width:16px;height:16px;accent-color:white;cursor:pointer;flex-shrink:0;">
                <div style="flex:1;">
                    <div style="font-size:14px;font-weight:500;color:var(--text-0);${t.status==='completed'?'text-decoration:line-through;opacity:0.5;':''};">${escHtml(t.title||'Untitled')}</div>
                    ${t.description?`<div style="font-size:12px;color:var(--text-3);margin-top:3px;">${escHtml(t.description)}</div>`:''}
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="badge ${priorityClass}">${t.priority||'—'}</span>
                    ${t.due_date?`<span style="font-size:11px;color:var(--text-3);">${fmtDate(t.due_date)}</span>`:''}
                    <span style="font-size:11px;color:var(--text-3);">${escHtml(t.assigned_to_name||t.created_by_name||S.user.name||'You')}</span>
                    <button class="btn btn-ghost btn-xs" onclick="deleteTask(${t.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                    </button>
                </div>
            </div>`;
        }).join('')}
    </div>`;
}

function setTaskTab(tab, el) {
    S.taskTab = tab;
    document.querySelectorAll('.task-tab').forEach(b => b.classList.remove('active-tab'));
    el.classList.add('active-tab');
    renderTasks();
}

function openAddTaskModal() {
    ['taskTitle','taskDesc'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('taskPriority').value = 'medium';
    document.getElementById('taskDue').value = '';
    openModal('addTaskModal');
}

async function saveTask() {
    const title = document.getElementById('taskTitle').value.trim();
    if (!title) { toast('Title required', 'error'); return; }

    try {
        const res = await apiFetch('/client/tasks', 'POST', {
            title,
            description: document.getElementById('taskDesc').value,
            priority: document.getElementById('taskPriority').value,
            due_date: document.getElementById('taskDue').value,
            createdByName: S.user.name || S.user.email,
        });
        const data = await res.json();
        if (data.success || data.task || data.id) {
            toast('Task created', 'success');
            closeModal('addTaskModal');
            await loadTasks();
        } else {
            toast(data.message||'Failed', 'error');
        }
    } catch {
        toast('Error creating task', 'error');
    }
}

async function toggleTask(taskId) {
    try {
        await apiFetch(`/client/tasks/${taskId}/toggle`, 'POST', {});
        await loadTasks();
    } catch {}
}

async function deleteTask(taskId) {
    try {
        await apiFetch(`/client/tasks/${taskId}`, 'DELETE');
        await loadTasks();
    } catch {}
}

// ============================================================
// TEAM (admin-only)
// ============================================================
async function loadTeam() {
    if (!S.isAdmin) return;
    const el = document.getElementById('teamContent');
    try {
        const res = await apiFetch('/client/company');
        const data = await res.json();
        if (!data.success) { el.innerHTML = '<div class="empty-state"><p>Could not load team data</p></div>'; return; }

        const users = data.users || [];
        if (!users.length) { el.innerHTML = '<div class="empty-state"><h3>No team members</h3></div>'; return; }

        el.innerHTML = `
            <div class="card">
                <div class="card-header"><span class="card-title">Team Performance</span></div>
                <div class="card-body">
                    ${users.map(u=>{
                        const initials = (u.userName||u.user_name||'U').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
                        return `<div class="perf-row">
                            <div class="perf-avatar">${initials}</div>
                            <div style="flex:1;">
                                <div class="perf-name">${escHtml(u.userName||u.user_name||u.userEmail||'—')}</div>
                                <div class="perf-meta">${escHtml(u.userEmail||u.user_email||'—')} ${u.isAdmin?'<span class="badge badge-purple">Admin</span>':''}</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <span class="badge ${u.status==='active'?'badge-green':'badge-gray'}">${u.status||'active'}</span>
                                ${S.isTrueAdmin && !u.isAdmin ? `<button class="btn btn-ghost btn-xs" onclick="promoteUser(${u.id})">Give Admin</button>` : ''}
                                ${S.isTrueAdmin && u.isAdmin ? `<button class="btn btn-ghost btn-xs" onclick="demoteUser(${u.id})">Remove Admin</button>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
    } catch {
        el.innerHTML = '<div class="empty-state"><p>Error loading team</p></div>';
    }
}

async function promoteUser(userId) {
    try {
        const res = await apiFetch('/client/company/promote-admin', 'POST', { userId });
        const data = await res.json();
        toast(data.success ? 'Admin rights granted' : (data.message||'Failed'), data.success?'success':'error');
        if (data.success) loadTeam();
    } catch { toast('Error', 'error'); }
}

async function demoteUser(userId) {
    try {
        const res = await apiFetch('/client/company/demote-admin', 'POST', { userId });
        const data = await res.json();
        toast(data.success ? 'Admin rights removed' : (data.message||'Failed'), data.success?'success':'error');
        if (data.success) loadTeam();
    } catch { toast('Error', 'error'); }
}

// ============================================================
// COMPANY MANAGEMENT (admin-only)
// ============================================================
async function loadCompany() {
    if (!S.isAdmin) return;
    const el = document.getElementById('companyContent');
    const actionsEl = document.getElementById('companyHeaderActions');

    try {
        const res = await apiFetch('/client/company');
        const data = await res.json();
        if (!data.success) { el.innerHTML = '<div class="empty-state"><p>Could not load company data</p></div>'; return; }

        S.companyData = data;
        actionsEl.style.display = 'flex';

        const company = data.company || {};
        const users = data.users || [];
        // True monthly total = what the company is actually billed (from company record, includes all purchased seats)
        // This is calculated server-side as sum of all active+cancelling users' price_per_user
        const purchasedSeats = parseInt(company.purchasedSeats) || 0;
        // If server returned $0 but we have purchased seats, calculate client-side as last resort
        // (server auto-repairs DB, but this ensures the UI never shows $0 for a paid plan)
        let monthlyTotal = parseFloat(company.monthlyTotal || 0);
        if (monthlyTotal === 0 && purchasedSeats > 0) {
            // Find per-user price from user list
            const anyUser = (data.users || []).find(u => parseFloat(u.pricePerUser) > 0);
            const pricePerUser = parseFloat(anyUser?.pricePerUser) || 84.99;
            monthlyTotal = purchasedSeats * pricePerUser;
        }

        el.innerHTML = `
            <!-- Company Info -->
            <div class="card" style="margin-bottom:16px;">
                <div class="card-header"><span class="card-title">Account Info</span></div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;">
                        <div><div style="font-size:11px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Company</div><div style="font-weight:600;">${escHtml(company.companyName||'—')}</div></div>
                        <div><div style="font-size:11px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Portal ID</div>
                            <div style="display:flex;align-items:center;gap:8px;font-family:var(--font-mono);font-size:13px;">${escHtml(company.clientPortalId||'—')}
                                <button class="btn btn-ghost btn-xs" onclick="navigator.clipboard.writeText('${escHtml(company.clientPortalId||'')}').then(()=>toast('Copied!','success'))">Copy</button>
                            </div>
                        </div>
                        <div><div style="font-size:11px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Active Users</div><div style="font-weight:600;">${users.filter(u=>u.status==='active').length} of ${company.purchasedSeats||0} seats</div></div>
                        <div><div style="font-size:11px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Monthly Total</div><div style="font-weight:600;color:var(--green);">$${monthlyTotal.toFixed(2)}</div><div style="font-size:10px;color:var(--text-3);">${company.purchasedSeats||0} purchased seat${(company.purchasedSeats||0)!==1?'s':''}</div></div>
                    </div>
                    <div style="margin-top:14px;padding:12px;background:var(--bg-3);border-radius:var(--r-sm);border:1px solid var(--border);font-size:12px;color:var(--text-3);">
                        Share your Portal ID <strong style="color:var(--text-1);">${escHtml(company.clientPortalId||'—')}</strong> with team members so they can join your company account on the pricing page.
                    </div>
                </div>
            </div>

            <!-- Users -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Team Members (${users.length})</span>
                </div>
                <div class="card-body" style="padding:0;">
                    ${users.length ? `<table>
                        <thead><tr><th>Name/Label</th><th>Email</th><th>Plan</th><th>Cost</th><th>Status</th><th>Admin</th><th>Added</th><th></th></tr></thead>
                        <tbody>
                            ${users.map(u=>`<tr>
                                <td>
                                    <div style="font-weight:500;">${escHtml(u.userLabel||u.userName||'—')}</div>
                                    ${u.userLabel?`<div style="font-size:11px;color:var(--text-3);">${escHtml(u.userName||'')}</div>`:''}
                                </td>
                                <td style="color:var(--text-2);font-size:12px;">${escHtml(u.userEmail||'—')}</td>
                                <td style="font-size:12px;color:var(--text-2);">${escHtml(u.packageName||'—')}</td>
                                <td style="font-weight:600;">$${parseFloat(u.pricePerUser||0).toFixed(2)}/mo</td>
                                <td><span class="badge ${u.status==='active'?'badge-green':u.status==='cancelling'?'badge-yellow':'badge-red'}">${u.status==='cancelling'?'Cancelling':u.status||'active'}</span></td>
                                <td>${u.isAdmin?'<span class="badge badge-purple">Admin</span>':'—'}</td>
                                <td style="font-size:11px;color:var(--text-3);">${fmtDate(u.addedDate||u.created_at)}</td>
                                <td>
                                    <div class="row-actions">
                                        ${S.isTrueAdmin ? `` : ''}
                                        ${S.isTrueAdmin && !u.isAdmin ? `<button class="btn btn-ghost btn-xs" onclick="promoteUser(${u.id})">Admin+</button>` : ''}
                                        ${S.isTrueAdmin && u.isAdmin ? `<button class="btn btn-ghost btn-xs" onclick="demoteUser(${u.id})">Remove</button>` : ''}
                                        ${S.isTrueAdmin && !u.isAdmin ? `<button class="btn btn-ghost btn-xs" onclick="openResetUserPasswordModal(${u.id},'${escHtml(u.userName||u.userEmail||'')}')">Reset PW</button>` : ''}
                                        ${u.status==='active' ? `<button class="btn btn-danger btn-xs" onclick="cancelCompanyUser(${u.id},'${escHtml(u.userName||'')}')">Cancel</button>` : ''}
                                        ${u.status==='cancelling' ? `<button class="btn btn-ghost btn-xs" style="color:var(--green);" onclick="reinstateCompanyUser(${u.id},'${escHtml(u.userName||'')}')">Reinstate</button>` : ''}
                                    </div>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>` : `<div class="empty-state"><h3>No team members</h3><p>Click "Add User" to invite your first team member</p></div>`}
                </div>
            </div>`;
    } catch(e) {
        el.innerHTML = '<div class="empty-state"><p>Error loading company data</p></div>';
    }
}

async function openAddUserModal() {
    if (!S.isAdmin) return;

    // Reset all fields
    ['addUserName','addUserUsername','addUserEmail','addUserSendingEmail','addUserPassword','addUserLabel'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    document.querySelectorAll('input[name="addUserPlan"]').forEach(r => r.checked = false);
    document.querySelectorAll('#addUserPlanSection label[id^="addUserPlan-"]').forEach(l => {
        l.style.borderColor = 'var(--border)';
        l.style.background = '';
    });

    const banner      = document.getElementById('addUserSeatBanner');
    const planSection = document.getElementById('addUserPlanSection');

    // Show modal immediately with loading state
    banner.style.cssText = 'background:rgba(100,100,100,0.06);border:1px solid var(--border);border-radius:var(--r-md);padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--text-2);';
    banner.innerHTML = 'Checking seat availability...';
    if (planSection) planSection.style.display = 'none';
    openModal('addUserModal');

    // Always fetch fresh data — stale cache causes wrong seat counts
    try {
        const res  = await apiFetch('/client/company');
        const data = await res.json();
        if (data.success) S.companyData = data;
    } catch(e) { /* use cached data if fetch fails */ }

    const company   = S.companyData?.company || {};
    const purchased = parseInt(company.purchasedSeats) || 0;
    const occupied  = parseInt(company.totalActiveSeats) || 0;
    const available = Math.max(0, purchased - occupied);
    const pricePerUser = 84.99; // workspace price

    if (available > 0) {
        banner.style.cssText = 'background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:var(--r-md);padding:12px 16px;margin-bottom:16px;font-size:13px;font-weight:500;color:#4ade80;';
        banner.innerHTML = `✅ You have <strong>${available}</strong> available seat${available !== 1 ? 's' : ''} remaining. This user fills one — your monthly total will not change.`;
        if (planSection) planSection.style.display = 'none';
    } else {
        banner.style.cssText = 'background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.3);border-radius:var(--r-md);padding:12px 16px;margin-bottom:16px;font-size:13px;font-weight:500;color:#fbbf24;';
        banner.innerHTML = `⚠️ All <strong>${purchased}</strong> purchased seat${purchased !== 1 ? 's' : ''} are currently in use. Adding this user will add 1 seat ($${pricePerUser.toFixed(2)}/mo) to your subscription.`;
        if (planSection) planSection.style.display = 'none';
    }
}

async function addCompanyUser() {
    const name         = document.getElementById('addUserName').value.trim();
    const username     = document.getElementById('addUserUsername').value.trim();
    const email        = document.getElementById('addUserEmail').value.trim();
    const sendingEmail = document.getElementById('addUserSendingEmail').value.trim();
    const password     = document.getElementById('addUserPassword').value;
    const label        = document.getElementById('addUserLabel').value.trim();

    if (!name || !email) { toast('Name and email required', 'error'); return; }
    if (!password || password.length < 6) { toast('Password must be at least 6 characters', 'error'); return; }
    if (!S.companyData?.company?.clientPortalId) {
        toast('Company portal ID not found', 'error'); return;
    }

    // Check if we're over quota — require a plan to be selected
    const company   = S.companyData.company;
    const purchased = parseInt(company?.purchasedSeats) || 0;
    const occupied  = parseInt(company?.totalActiveSeats) || 0;
    const isOverQuota = occupied >= purchased;

    let selectedPlan = null; // server resolves plan from existing subscription

    const btn = document.getElementById('addUserBtn');
    btn.disabled = true; btn.textContent = 'Adding...';

    try {
        const res = await apiFetch('/client/company/add-user', 'POST', {
            name, username, email, sendingEmail,
            password,
            userLabel: label,
            clientPortalId: company.clientPortalId,
            packageKey: selectedPlan || null,   // null = use existing plan (seat already paid)
        });
        const data = await res.json();
        if (data.success) {
            if (!data.emailSent && data.tempPassword) {
                // Email failed — show credentials directly in the portal so the admin can relay them
                toast(data.message || 'User added (email failed — see credentials below)', 'warning');
                closeModal('addUserModal');
                await loadCompany();
                // Show a persistent alert with the credentials since email couldn't deliver them
                setTimeout(() => {
                    alert(`⚠️ Welcome email failed to send.\n\nPlease share these credentials manually with ${name}:\n\nLogin Email: ${email}\nPassword: ${data.tempPassword}\nPortal URL: ${window.location.origin}/client_portal.html`);
                }, 300);
            } else {
                toast(data.message || 'Team member added successfully!', 'success');
                closeModal('addUserModal');
                await loadCompany();
            }
        } else {
            toast(data.message || 'Failed to add user', 'error');
        }
    } catch {
        toast('Error adding user', 'error');
    } finally {
        btn.disabled = false; btn.textContent = 'Add Team Member';
    }
}

// ── Admin: Reset a team member's password ───────────────────────
let _resetUserPwTargetId = null;
function openResetUserPasswordModal(userId, userName) {
    _resetUserPwTargetId = userId;
    document.getElementById('resetUserPwName').textContent = userName;
    document.getElementById('resetUserPwInput').value = '';
    document.getElementById('resetUserPwConfirm').value = '';
    openModal('resetUserPwModal');
}

async function confirmResetUserPassword() {
    const newPw = document.getElementById('resetUserPwInput').value;
    const confirm = document.getElementById('resetUserPwConfirm').value;
    if (!newPw || newPw.length < 6) { toast('Password must be at least 6 characters', 'error'); return; }
    if (newPw !== confirm) { toast('Passwords do not match', 'error'); return; }
    if (!_resetUserPwTargetId) return;

    const btn = document.getElementById('resetUserPwBtn');
    btn.disabled = true; btn.textContent = 'Resetting...';
    try {
        const res = await apiFetch(`/client/company/user/${_resetUserPwTargetId}/reset-password`, 'POST', { newPassword: newPw });
        const data = await res.json();
        if (data.success) {
            toast(data.message || 'Password reset successfully', 'success');
            closeModal('resetUserPwModal');
        } else {
            toast(data.message || 'Failed to reset password', 'error');
        }
    } catch { toast('Error resetting password', 'error'); }
    finally { btn.disabled = false; btn.textContent = 'Reset Password'; }
}

async function cancelCompanyUser(userId, name) {
    const confirmed = await requireValidation(`Confirm your password to cancel ${name}'s subscription.`);
    if (!confirmed) return;

    try {
        const res = await apiFetch(`/client/company/user/${userId}/cancel`, 'POST', {});
        const data = await res.json();
        toast(data.success ? (data.message || name + ' has been removed.') : (data.message || 'Failed'), data.success ? 'success' : 'error');
        if (data.success) { S.companyData = null; await loadCompany(); }
    } catch { toast('Error', 'error'); }
}

async function reinstateCompanyUser(userId, name) {
    if (!confirm(`Reinstate ${name}'s subscription? They will continue being billed normally.`)) return;
    try {
        const res = await apiFetch(`/client/company/user/${userId}/reinstate`, 'POST', {});
        const data = await res.json();
        toast(data.success ? (data.message || `${name}'s subscription reinstated.`) : (data.message||'Failed'), data.success?'success':'error');
        if (data.success) loadCompany();
    } catch { toast('Error', 'error'); }
}

// ============================================================
// FILES
// ============================================================
function setupFileUpload() {
    const zone = document.getElementById('uploadZone');
    const input = document.getElementById('fileInput');
    if (!zone || !input) return;

    zone.addEventListener('click', () => input.click());
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
    zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('drag');
        handleFileUpload(e.dataTransfer.files);
    });
    input.addEventListener('change', e => handleFileUpload(e.target.files));
}

async function loadFiles() {
    try {
        const res = await apiFetch('/client/files');
        const data = await res.json();
        S.files = data.files || [];
        renderFiles();
    } catch {}
}

function renderFiles() {
    const el = document.getElementById('filesGrid');
    if (!S.files.length) { el.innerHTML = ''; return; }
    el.innerHTML = S.files.map(f => {
        const name = f.filename || f.original_filename || 'File';
        const size = fmtSize(f.file_size || 0);
        return `<div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--r-md);padding:14px;cursor:pointer;transition:border-color 0.15s;" onclick="downloadFile(${f.id},'${escHtml(name)}')" onmouseover="this.style.borderColor='rgba(255,255,255,0.15)'" onmouseout="this.style.borderColor='var(--border)'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:32px;height:32px;color:var(--text-3);margin-bottom:10px;"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
            <div style="font-size:13px;font-weight:500;color:var(--text-0);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(name)}</div>
            <div style="font-size:11px;color:var(--text-3);margin-top:4px;">${size}</div>
        </div>`;
    }).join('');
}

async function handleFileUpload(files) {
    if (!files?.length) return;
    toast(`Uploading ${files.length} file${files.length>1?'s':''}...`, 'success');
    for (const file of files) {
        const fd = new FormData();
        fd.append('file', file);
        try {
            await fetch(API_BASE + '/client/files/upload', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + S.token },
                body: fd,
            });
        } catch {}
    }
    await loadFiles();
    toast('Upload complete', 'success');
}

function downloadFile(fileId, filename) {
    fetch(API_BASE + `/files/${fileId}/download`, {
        headers: { 'Authorization': 'Bearer ' + S.token }
    }).then(r => r.blob()).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        URL.revokeObjectURL(url); a.remove();
    }).catch(() => toast('Download failed', 'error'));
}

// ============================================================
// SUPPORT TICKETS
// ============================================================
async function loadTickets() {
    try {
        const res = await apiFetch('/client/tickets');
        const data = await res.json();
        S.tickets = data.tickets || [];
        renderTickets();

        // Badge
        const open = S.tickets.filter(t=>t.status==='open').length;
        const badge = document.getElementById('ticketBadge');
        badge.textContent = open;
        badge.style.display = open > 0 ? 'inline-block' : 'none';
    } catch {}
}

function renderTickets() {
    const el = document.getElementById('ticketsContent');
    if (!S.tickets.length) {
        el.innerHTML = `<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <h3>No support tickets</h3><p>Open a ticket if you need help</p></div>`;
        return;
    }
    el.innerHTML = `<div class="table-wrap"><table>
        <thead><tr><th>Subject</th><th>Priority</th><th>Status</th><th>Created</th><th></th></tr></thead>
        <tbody>
            ${S.tickets.map(t=>{
                const pClass = t.priority==='high'?'badge-red':t.priority==='medium'?'badge-yellow':'badge-blue';
                const sClass = t.status==='open'?'badge-red':t.status==='resolved'?'badge-green':'badge-yellow';
                return `<tr>
                    <td style="font-weight:500;">${escHtml(t.subject)}</td>
                    <td><span class="badge ${pClass}">${t.priority}</span></td>
                    <td><span class="badge ${sClass}">${t.status}</span></td>
                    <td style="font-size:12px;color:var(--text-3);">${fmtDate(t.created_at)}</td>
                    <td><button class="btn btn-ghost btn-xs" onclick="viewTicket(${t.id})">View</button></td>
                </tr>`;
            }).join('')}
        </tbody>
    </table></div>`;
}

function openNewTicketModal() {
    ['ticketSubject','ticketMessage'].forEach(id=>document.getElementById(id).value='');
    openModal('newTicketModal');
}

async function submitTicket() {
    const subject  = document.getElementById('ticketSubject').value.trim();
    const message  = document.getElementById('ticketMessage').value.trim();
    const priority = document.getElementById('ticketPriority').value;
    const category = document.getElementById('ticketCategory').value;
    if (!subject || !message) { toast('Subject and message required', 'error'); return; }

    try {
        const res = await apiFetch('/client/support/ticket', 'POST', { subject, message, priority, category });
        const data = await res.json();
        if (data.success) {
            toast('Ticket submitted', 'success');
            closeModal('newTicketModal');
            await loadTickets();
        } else {
            toast(data.message||'Failed', 'error');
        }
    } catch { toast('Error submitting ticket', 'error'); }
}

async function viewTicket(ticketId) {
    try {
        const res = await apiFetch(`/client/tickets/${ticketId}`);
        const data = await res.json();
        if (!data.success) return;
        const ticket = data.ticket;
        const responses = data.responses || [];

        const modal = document.createElement('div');
        modal.className = 'modal-overlay open';
        modal.id = 'ticketViewModal';
        modal.onclick = (e) => { if(e.target===modal) modal.remove(); };
        modal.innerHTML = `
            <div class="modal" style="max-width:700px;">
                <div class="modal-header">
                    <span class="modal-title">${escHtml(ticket.subject)}</span>
                    <button class="modal-close" onclick="document.getElementById('ticketViewModal').remove()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="background:var(--bg-3);padding:14px;border-radius:var(--r-md);margin-bottom:16px;">
                        <div style="font-size:11px;color:var(--text-3);margin-bottom:6px;text-transform:uppercase;">Original Message</div>
                        <div style="font-size:13px;color:var(--text-1);">${escHtml(ticket.message)}</div>
                    </div>
                    ${responses.map(r=>`<div style="padding:12px;background:${r.user_type==='admin'?'rgba(59,130,246,0.06)':'var(--bg-3)'};border:1px solid var(--border);border-radius:var(--r-md);margin-bottom:8px;border-left:3px solid ${r.user_type==='admin'?'var(--blue)':'var(--border)'};">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <span style="font-size:12px;font-weight:600;color:var(--text-0);">${escHtml(r.user_name||r.author||'—')} ${r.user_type==='admin'?'<span class="badge badge-blue" style="font-size:10px;">Support</span>':''}</span>
                            <span style="font-size:11px;color:var(--text-3);">${fmtDate(r.created_at)}</span>
                        </div>
                        <div style="font-size:13px;color:var(--text-2);">${escHtml(r.message)}</div>
                    </div>`).join('')}
                    ${ticket.status !== 'closed' ? `<div style="margin-top:16px;">
                        <label class="form-label">Reply</label>
                        <textarea class="form-input" id="ticketReplyText" style="min-height:80px;" placeholder="Your reply..."></textarea>
                    </div>` : '<p style="text-align:center;color:var(--text-3);font-size:12px;">Ticket closed</p>'}
                </div>
                ${ticket.status !== 'closed' ? `<div class="modal-footer">
                    <button class="btn btn-ghost" onclick="document.getElementById('ticketViewModal').remove()">Close</button>
                    <button class="btn btn-white" onclick="replyToTicket(${ticketId})">Send Reply</button>
                </div>` : `<div class="modal-footer"><button class="btn btn-ghost" onclick="document.getElementById('ticketViewModal').remove()">Close</button></div>`}
            </div>`;
        document.body.appendChild(modal);
    } catch { toast('Error loading ticket', 'error'); }
}

async function replyToTicket(ticketId) {
    const msg = document.getElementById('ticketReplyText')?.value?.trim();
    if (!msg) { toast('Enter a reply', 'error'); return; }

    try {
        const res = await apiFetch(`/client/tickets/${ticketId}/responses`, 'POST', { message: msg });
        const data = await res.json();
        if (data.success) {
            toast('Reply sent', 'success');
            document.getElementById('ticketViewModal')?.remove();
            await loadTickets();
        } else {
            toast(data.message||'Failed', 'error');
        }
    } catch { toast('Error', 'error'); }
}

// ============================================================
// SUBSCRIPTION
// ============================================================
async function loadSubscription() {
    const el = document.getElementById('subscriptionContent');
    el.innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';
    try {
        const res = await apiFetch('/client/subscription');
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed to load');
        renderSubscription(data.subscriptions || []);
    } catch(e) {
        el.innerHTML = `<div class="empty-state">
            <h3>Could not load subscription</h3><p>${e.message}</p>
            <button class="btn btn-default" style="margin-top:12px;" onclick="loadSubscription()">Retry</button>
        </div>`;
    }
}

function renderSubscription(subs) {
    const el = document.getElementById('subscriptionContent');
    const fmtDate2 = d => d ? new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '—';
    const sCfg = {
        active:    {label:'Active',    cls:'badge-green'},
        canceling: {label:'Canceling', cls:'badge-yellow'},
        past_due:  {label:'Past Due',  cls:'badge-red'},
        cancelled: {label:'Cancelled', cls:'badge-gray'},
    };

    // Shared billing history renderer
    const renderHistory = (events) => {
        if (!events?.length) return '';
        const evLabels = {
            payment_succeeded:               {l:'Payment',   c:'var(--green)'},
            payment_failed:                  {l:'Failed',    c:'var(--red)'},
            subscription_created:            {l:'Started',   c:'var(--blue)'},
            subscription_updated:            {l:'Updated',   c:'var(--yellow)'},
            subscription_cancelled_immediate:{l:'Cancelled', c:'var(--red)'},
            subscription_deleted:            {l:'Ended',     c:'var(--text-3)'},
        };
        return `<div style="margin-top:16px;">
            <div style="font-size:12px;font-weight:600;text-transform:uppercase;color:var(--text-3);margin-bottom:8px;">Recent Activity</div>
            <div style="border:1px solid var(--border);border-radius:var(--r-sm);overflow:hidden;">
                ${events.map((ev,i)=>{
                    const info = evLabels[ev.event_type] || {l:ev.event_type,c:'var(--text-3)'};
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;${i<events.length-1?'border-bottom:1px solid var(--border-light);':''}">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="background:${info.c}20;color:${info.c};padding:2px 7px;border-radius:4px;font-size:10px;font-weight:700;">${info.l}</span>
                            <span style="font-size:12px;color:var(--text-2);">${escHtml(ev.description||ev.event_type)}</span>
                        </div>
                        <div style="text-align:right;">
                            ${ev.amount>0?`<div style="font-size:13px;font-weight:600;">$${parseFloat(ev.amount).toFixed(2)}</div>`:''}
                            <div style="font-size:11px;color:var(--text-3);">${fmtDate2(ev.created_at)}</div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    };

    // ── COMPANY MEMBER (non-admin) — read-only ─────────────────────────────
    if (S.isCompanyMember && !S.isAdmin) {
        el.innerHTML = `
        <div class="card" style="max-width:560px;">
            <div class="card-header"><span class="card-title">Your Account</span></div>
            <div class="card-body">
                <div style="display:flex;align-items:center;gap:14px;padding:16px;background:var(--bg-3);border-radius:var(--r-md);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:36px;height:36px;color:var(--accent);flex-shrink:0;"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    <div>
                        <div style="font-weight:600;font-size:15px;color:var(--text-0);">Company Member</div>
                        <div style="font-size:13px;color:var(--text-3);margin-top:2px;">Your subscription is managed by your company administrator.</div>
                    </div>
                </div>
                <p style="margin-top:16px;font-size:13px;color:var(--text-2);">To change your plan, cancel, or manage billing, contact your company admin or reach us at <strong>(512) 980-0393</strong>.</p>
            </div>
        </div>`;
        return;
    }

    const active = subs.filter(s=>['active','canceling','past_due'].includes(s.status));
    const past   = subs.filter(s=>s.status==='cancelled');

    if (!active.length) {
        el.innerHTML = `<div class="card" style="max-width:560px;text-align:center;padding:48px 24px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;margin:0 auto 16px;opacity:0.2;"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
            <h3 style="margin-bottom:8px;">No active subscription</h3>
            <p style="font-size:13px;color:var(--text-3);">Contact us at (512) 980-0393 to get started.</p>
        </div>
        ${past.length?`<div class="card" style="margin-top:16px;"><div class="card-header"><span class="card-title">Past Subscriptions</span></div><div class="card-body" style="padding:0;"><table><thead><tr><th>Plan</th><th>Amount</th><th>Cancelled</th></tr></thead><tbody>${past.map(s=>`<tr><td>${escHtml(s.package_name)}</td><td>$${parseFloat(s.monthly_total||0).toFixed(2)}/mo</td><td style="font-size:12px;color:var(--text-3);">${fmtDate2(s.cancelled_at)}</td></tr>`).join('')}</tbody></table></div></div>`:''}`;
        return;
    }

    let html = '';

    // ── COMPANY ADMIN — full company subscription control ──────────────────
    if (S.isAdmin) {
        const sub = active.sort((a,b)=>parseFloat(b.monthly_total)-parseFloat(a.monthly_total))[0];
        const sc = sCfg[sub.status] || sCfg.cancelled;
        const canCancel = ['active','past_due'].includes(sub.status);

        html += `
        <div class="card" style="margin-bottom:16px;">
            <div class="card-header" style="flex-wrap:wrap;gap:12px;">
                <div>
                    <div style="font-size:16px;font-weight:600;color:var(--text-0);margin-bottom:4px;">${escHtml(sub.package_name)} <span style="font-size:12px;color:var(--text-3);font-weight:400;">— Company Plan</span></div>
                    <span class="badge ${sc.cls}">${sc.label}</span>
                    ${sub.status==='canceling'?`<span style="font-size:12px;color:var(--text-3);margin-left:8px;">Access ends ${fmtDate2(sub.current_period_end)}</span>`:''}
                </div>
                <div style="text-align:right;">
                    <div style="font-size:26px;font-weight:700;color:var(--text-0);">$${parseFloat(sub.monthly_total||0).toFixed(2)}</div>
                    <div style="font-size:12px;color:var(--text-3);">${sub.user_count||1} seat${(sub.user_count||1)!==1?'s':''}/month</div>
                </div>
            </div>
            <div class="card-body">
                ${sub.status==='past_due'?`<div style="background:var(--red-dim);border:1px solid rgba(239,68,68,0.2);border-radius:var(--r-md);padding:14px;margin-bottom:16px;display:flex;gap:10px;align-items:flex-start;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" style="width:16px;height:16px;flex-shrink:0;margin-top:2px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><div style="font-size:13px;color:var(--red);">Payment past due — <button class="btn btn-danger btn-xs" onclick="openBillingPortal(${sub.id})" style="margin-left:6px;">Update Payment</button></div></div>`:''}
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;padding:14px;background:var(--bg-3);border-radius:var(--r-sm);margin-bottom:16px;">
                    <div><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Billing Period</div><div style="font-size:12px;font-weight:500;">${fmtDate2(sub.current_period_start)}</div><div style="font-size:11px;color:var(--text-3);">to ${fmtDate2(sub.current_period_end)}</div></div>
                    <div><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Next Charge</div><div style="font-size:12px;font-weight:500;">${sub.status==='canceling'?'None':'$'+parseFloat(sub.monthly_total||0).toFixed(2)}</div><div style="font-size:11px;color:var(--text-3);">${sub.status==='canceling'?'Cancelling':'on '+fmtDate2(sub.current_period_end)}</div></div>
                    <div><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Per Seat</div><div style="font-size:12px;font-weight:500;">$${parseFloat(sub.price_per_user||0).toFixed(2)}/seat/mo</div></div>
                    <div><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Member Since</div><div style="font-size:12px;font-weight:500;">${fmtDate2(sub.created_at)}</div></div>
                </div>

                <div style="display:flex;gap:8px;flex-wrap:wrap;padding-top:14px;border-top:1px solid var(--border);">
                    <button class="btn btn-default btn-sm" onclick="openBillingPortal(${sub.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                        Manage Billing
                    </button>
                    ${canCancel?`<button class="btn btn-danger btn-sm" onclick="openCancelSub(${sub.id},'${escHtml(sub.package_name||'')}','${fmtDate2(sub.current_period_end)}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                        Cancel Subscription
                    </button>`:''}
                </div>
                ${renderHistory(sub.events)}
            </div>
        </div>`;
    }

    // ── INDIVIDUAL — full plan management + upgrade-to-company offer ───────
    else {
        active.forEach(sub => {
            const sc = sCfg[sub.status] || sCfg.cancelled;
            const canChange = ['active','canceling'].includes(sub.status);
            const canCancel = ['active','past_due'].includes(sub.status);

            html += `<div class="card" style="margin-bottom:16px;">
                <div class="card-header" style="flex-wrap:wrap;gap:12px;">
                    <div>
                        <div style="font-size:16px;font-weight:600;color:var(--text-0);margin-bottom:4px;">${escHtml(sub.package_name)}</div>
                        <span class="badge ${sc.cls}">${sc.label}</span>
                        ${sub.status==='canceling'?`<span style="font-size:12px;color:var(--text-3);margin-left:8px;">Access ends ${fmtDate2(sub.current_period_end)}</span>`:''}
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:26px;font-weight:700;color:var(--text-0);">$${parseFloat(sub.monthly_total||0).toFixed(2)}</div>
                        <div style="font-size:12px;color:var(--text-3);">${sub.user_count||1} user${(sub.user_count||1)!==1?'s':''}/month</div>
                    </div>
                </div>
                <div class="card-body">
                    ${sub.status==='past_due'?`<div style="background:var(--red-dim);border:1px solid rgba(239,68,68,0.2);border-radius:var(--r-md);padding:14px;margin-bottom:16px;display:flex;gap:10px;align-items:flex-start;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" style="width:16px;height:16px;flex-shrink:0;margin-top:2px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><div style="font-size:13px;color:var(--red);">Payment past due — <button class="btn btn-danger btn-xs" onclick="openBillingPortal(${sub.id})" style="margin-left:6px;">Update Payment</button></div></div>`:''}

                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;padding:14px;background:var(--bg-3);border-radius:var(--r-sm);margin-bottom:16px;">
                        <div><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Current Period</div><div style="font-size:12px;font-weight:500;">${fmtDate2(sub.current_period_start)}</div><div style="font-size:11px;color:var(--text-3);">to ${fmtDate2(sub.current_period_end)}</div></div>
                        <div><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Next Charge</div><div style="font-size:12px;font-weight:500;">${sub.status==='canceling'?'None':'$'+parseFloat(sub.monthly_total||0).toFixed(2)}</div><div style="font-size:11px;color:var(--text-3);">${sub.status==='canceling'?'Cancelling':'on '+fmtDate2(sub.current_period_end)}</div></div>
                        <div><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;margin-bottom:4px;">Member Since</div><div style="font-size:12px;font-weight:500;">${fmtDate2(sub.created_at)}</div></div>
                    </div>

                    ${canChange?`
                    <div style="margin-bottom:16px;">
                        <div style="font-size:12px;font-weight:600;text-transform:uppercase;color:var(--text-3);margin-bottom:10px;">Change Plan</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
                            ${CRM_PLANS.map(plan=>{
                                const isCur = plan.key===sub.package_key;
                                const curPkg = CRM_PLANS.find(p=>p.key===sub.package_key);
                                const arrow = plan.price>(curPkg?.price||0)?'↑ Upgrade':plan.price<(curPkg?.price||0)?'↓ Downgrade':'';
                                return `<div class="plan-card ${isCur?'current':''}" onclick="${isCur?'':(`openChangePlan(${sub.id},'${plan.key}','${plan.name}',${plan.price},${sub.user_count||1},'${escHtml(sub.package_key||'')}',${parseFloat(sub.monthly_total||0)})`)}" style="${isCur?'cursor:default;':''}">
                                    <div class="plan-name">${plan.name}</div>
                                    <div class="plan-price">$${plan.price.toFixed(2)}<span>/user/mo</span></div>
                                    ${isCur?'<div style="font-size:10px;color:var(--green);margin-top:4px;font-weight:600;">CURRENT</div>':`<div style="font-size:11px;color:var(--text-3);margin-top:4px;">${arrow}</div>`}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`:''}

                    <div style="display:flex;gap:8px;flex-wrap:wrap;padding-top:14px;border-top:1px solid var(--border);">
                        <button class="btn btn-default btn-sm" onclick="openBillingPortal(${sub.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                            Manage Billing
                        </button>
                        ${canCancel?`<button class="btn btn-danger btn-sm" onclick="openCancelSub(${sub.id},'${escHtml(sub.package_name||'')}','${fmtDate2(sub.current_period_end)}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            Cancel
                        </button>`:''}
                    </div>
                    ${renderHistory(sub.events)}
                </div>
            </div>`;
        });

    }

    // Past subscriptions
    if (past.length) {
        html += `<div class="card" style="margin-top:16px;">
            <div class="card-header"><span class="card-title">Past Subscriptions</span></div>
            <div class="card-body" style="padding:0;">
                <table><thead><tr><th>Plan</th><th>Amount</th><th>Cancelled</th></tr></thead>
                <tbody>${past.map(s=>`<tr>
                    <td style="font-weight:500;">${escHtml(s.package_name)}</td>
                    <td style="color:var(--text-3);">$${parseFloat(s.monthly_total||0).toFixed(2)}/mo</td>
                    <td style="font-size:12px;color:var(--text-3);">${fmtDate2(s.cancelled_at)}</td>
                </tr>`).join('')}</tbody></table>
            </div>
        </div>`;
    }

    el.innerHTML = html;
}

// ── Individual / Admin own-plan change (existing changePlanModal) ──────────
let _planState = {};

function openChangePlan(subId, planKey, planName, price, currentQty, currentPlanKey, currentTotal) {
    _planState = { subId, selectedKey: planKey, selectedPrice: price, currentQty };
    const opts = CRM_PLANS.map(p => `<div class="plan-card ${p.key===planKey?'selected current':''}" id="popt-${p.key}" onclick="selectPlan('${p.key}',${p.price})">
        <div class="plan-name">${p.name}</div>
        <div class="plan-price">$${p.price.toFixed(2)}<span>/user/mo</span></div>
        ${p.key===currentPlanKey?'<div style="font-size:10px;color:var(--green);margin-top:4px;">CURRENT</div>':''}
    </div>`).join('');
    document.getElementById('changePlanOptions').innerHTML = opts;
    document.getElementById('changePlanUsersField').style.display = 'block';
    document.getElementById('changePlanQty').value = currentQty;
    document.getElementById('planCurrentAmt').textContent = '$' + parseFloat(currentTotal||0).toFixed(2) + '/mo';
    updatePlanTotal();
    openModal('changePlanModal');
}

function selectPlan(key, price) {
    _planState.selectedKey = key; _planState.selectedPrice = price;
    CRM_PLANS.forEach(p => { const el = document.getElementById('popt-'+p.key); if(el) el.classList.toggle('selected', p.key===key); });
    updatePlanTotal();
}

function adjustPlanQty(delta) {
    const inp = document.getElementById('changePlanQty');
    inp.value = Math.max(1, parseInt(inp.value||1)+delta);
    updatePlanTotal();
}

function updatePlanTotal() {
    const qty = parseInt(document.getElementById('changePlanQty')?.value||1);
    const total = (_planState.selectedPrice||0)*qty;
    const noticeEl = document.getElementById('planChangeNotice');
    document.getElementById('planNewAmt').textContent = '$'+total.toFixed(2);
    if(noticeEl) {
        noticeEl.style.display = 'block';
        noticeEl.style.background = 'var(--yellow-dim)';
        noticeEl.style.color = 'var(--yellow)';
        noticeEl.textContent = 'Prorations are handled automatically by Stripe.';
    }
}

async function confirmPlanChange() {
    const btn = document.getElementById('confirmPlanChangeBtn');
    const qty = parseInt(document.getElementById('changePlanQty').value||1);
    btn.disabled = true; btn.textContent = 'Processing...';
    try {
        const res = await apiFetch(`/client/subscription/${_planState.subId}/change-plan`, 'POST', {
            newPackageKey: _planState.selectedKey, newUserCount: qty,
        });
        const data = await res.json();
        if(data.success) { toast(data.message||'Plan updated','success'); closeModal('changePlanModal'); await loadSubscription(); }
        else { toast(data.message||'Failed','error'); }
    } catch { toast('Error','error'); }
    finally { btn.disabled=false; btn.textContent='Confirm Change'; }
}

// ── Company Admin — change their own company subscription tier ─────────────
// ── Cancel subscription ────────────────────────────────────────────────────
let _cancelSubId = null;

function openCancelSub(subId, planName, periodEnd) {
    _cancelSubId = subId;
    document.getElementById('cancelSubDesc').textContent = `Cancel your ${planName} subscription. You'll receive a confirmation email.`;
    document.getElementById('cancelImmediately').checked = false;
    openModal('cancelSubModal');
}

async function confirmCancelSub() {
    if (!_cancelSubId) return;
    const btn = document.getElementById('confirmCancelBtn');
    const immediate = document.getElementById('cancelImmediately').checked;
    btn.disabled = true; btn.textContent = 'Cancelling...';
    try {
        const res = await apiFetch(`/client/subscription/${_cancelSubId}/cancel`, 'POST', { immediate });
        const data = await res.json();
        if (data.success) {
            toast(data.message || 'Subscription cancelled', 'success');
            closeModal('cancelSubModal');
            await loadSubscription();
        } else { toast(data.message || 'Failed', 'error'); }
    } catch { toast('Error', 'error'); }
    finally { btn.disabled = false; btn.textContent = 'Cancel Subscription'; }
}

async function openBillingPortal(subId) {
    try {
        const res = await apiFetch(`/client/subscription/${subId}/billing-portal`, 'POST', {});
        const data = await res.json();
        if (data.success && data.portalUrl) window.location.href = data.portalUrl;
        else toast(data.message || 'Cannot open billing portal', 'error');
    } catch { toast('Error', 'error'); }
}

// ============================================================
// EMAIL MARKETING — template builder, campaigns, chains
// ============================================================
const MK = { templates: [], chains: [], tab: 'templates', settings: null };

const EMAIL_TOPICS = [
    { value: 'intro',         label: 'Introduction / First Contact' },
    { value: 'followup',      label: 'Follow-up / Check-in' },
    { value: 'offer',         label: 'Special Offer / Promotion' },
    { value: 'value',         label: 'Value / Tips & Insights' },
    { value: 'testimonial',   label: 'Case Study / Testimonial' },
    { value: 'reengagement',  label: 'Re-engagement / Win-back' },
    { value: 'newsletter',    label: 'Newsletter / Update' },
    { value: 'announcement',  label: 'Announcement / New Service' },
    { value: 'holiday',       label: 'Holiday / Seasonal' },
    { value: 'custom',        label: 'Custom (write your own)' },
];

// Pre-built body content per topic
const TOPIC_TEMPLATES = {
    intro: {
        eyebrow: 'REACHING OUT',
        headline: 'We\'d love to connect.',
        body: `<p>Hi there,</p>
<p>I wanted to take a moment to introduce myself and let you know what we're all about. We specialize in delivering <strong>results-driven solutions</strong> that help businesses like yours grow, save time, and reach new customers.</p>
<p>Whether you're looking to scale, streamline, or simply explore what's possible — we're here to help. We'd love to learn more about your goals and show you how we can make a real difference.</p>
<p>Would you be open to a quick 15-minute call this week?</p>
<p>Looking forward to connecting,<br><strong>The Team</strong></p>`,
        cta: 'Schedule a Call'
    },
    followup: {
        eyebrow: 'CHECKING IN',
        headline: 'Just wanted to follow up.',
        body: `<p>Hi,</p>
<p>I wanted to circle back after our recent conversation. I know things get busy, and I didn't want our discussion to get lost in the shuffle.</p>
<p>We genuinely believe we can add <strong>real value</strong> to what you're building — and I'd love the chance to show you how. Even a 10-minute conversation can open up a lot of possibilities.</p>
<p>What does your schedule look like this week? I'm flexible and happy to work around you.</p>`,
        cta: 'Let\'s Talk'
    },
    offer: {
        eyebrow: 'LIMITED TIME',
        headline: 'An exclusive offer for you.',
        body: `<p>Hi,</p>
<p>We're running a <strong>special promotion</strong> this month and wanted to make sure you knew about it before it ends.</p>
<p>For a limited time, we're offering new clients an exclusive deal that makes getting started easier than ever. This is our way of saying we're confident in what we deliver — and we want to prove it to you.</p>
<p>Spots are limited, so don't wait too long. Click below to learn more and take advantage of this offer.</p>`,
        cta: 'Claim Your Offer'
    },
    value: {
        eyebrow: 'QUICK TIP',
        headline: 'Something we thought you\'d find useful.',
        body: `<p>Hi,</p>
<p>We're always looking for ways to add value to the people we work with — even before they become clients. So here's something we wanted to share.</p>
<p><strong>Did you know</strong> that most businesses leave significant revenue on the table simply by not following up consistently with leads? Studies show it takes an average of 8 touch points before a prospect converts — but most businesses give up after just 2.</p>
<p>We've built our entire process around solving exactly this problem. And we'd love to show you how it works for your business specifically.</p>`,
        cta: 'See How It Works'
    },
    testimonial: {
        eyebrow: 'SUCCESS STORY',
        headline: 'Real results from real clients.',
        body: `<p>Hi,</p>
<p>We talk a lot about what we do — but we think our clients say it better than we ever could.</p>
<p>"Working with this team completely transformed how we handle leads. Within the first 90 days, our conversion rate improved by over 40%. I only wish we'd started sooner." <em>— Recent client</em></p>
<p>Results like this don't happen by accident. They come from a proven process, dedicated support, and a team that genuinely cares about your growth.</p>
<p>Ready to write your own success story?</p>`,
        cta: 'Get Started Today'
    },
    reengagement: {
        eyebrow: 'WE MISS YOU',
        headline: 'It\'s been a while.',
        body: `<p>Hi,</p>
<p>We noticed it's been some time since we last connected, and we wanted to reach out to see how things are going on your end.</p>
<p>A lot has changed since we last spoke — we've added new services, improved our process, and helped even more businesses like yours hit their goals. We'd love the chance to show you what's new.</p>
<p>No pressure at all — just a friendly check-in. If now isn't the right time, no worries. But if you're open to it, we'd love to reconnect.</p>`,
        cta: 'Let\'s Reconnect'
    },
    newsletter: {
        eyebrow: 'THIS MONTH',
        headline: 'What\'s new and what\'s coming.',
        body: `<p>Hi,</p>
<p>Here's a quick roundup of what's been happening and what we're excited about this month:</p>
<p><strong>📈 Industry Update:</strong> The market continues to shift, and businesses that adapt early are seeing the biggest gains. Here's what we're watching closely.</p>
<p><strong>🚀 What We've Been Up To:</strong> We've been heads down building and improving — and we can't wait to share what's coming.</p>
<p><strong>💡 Tip of the Month:</strong> Consistency beats intensity. Showing up for your leads and customers regularly, even in small ways, builds trust faster than any one-time big move.</p>`,
        cta: 'Read More'
    },
    announcement: {
        eyebrow: 'EXCITING NEWS',
        headline: 'Something new is here.',
        body: `<p>Hi,</p>
<p>We're thrilled to announce something we've been working hard on — and we wanted you to be among the first to know.</p>
<p>We've just launched <strong>a new service</strong> designed specifically to help businesses like yours move faster, grow smarter, and win more clients. It's built from real feedback from real clients, and we're incredibly proud of it.</p>
<p>We'd love to walk you through it personally and show you exactly how it applies to your situation.</p>`,
        cta: 'Learn More'
    },
    holiday: {
        eyebrow: 'SEASON\'S GREETINGS',
        headline: 'Wishing you a wonderful season.',
        body: `<p>Hi,</p>
<p>As the season winds down and we look ahead to a new year, we wanted to take a moment to reach out and say thank you.</p>
<p>Thank you for your time, your trust, and your consideration. It genuinely means a lot to us, and we don't take it for granted.</p>
<p>We wish you and your team a wonderful holiday season filled with rest, joy, and exciting plans for the year ahead.</p>
<p>We look forward to connecting in the new year — there's a lot of exciting things on the horizon, and we can't wait to share them with you.</p>`,
        cta: 'Visit Our Website'
    },
    custom: {
        eyebrow: '',
        headline: '',
        body: `<p>Write your message here...</p>`,
        cta: 'Learn More'
    }
};

async function loadMarketing() {
    // Load settings + templates + chains in parallel
    try {
        const [settingsRes, templatesRes, chainsRes] = await Promise.all([
            apiFetch('/client/email-settings').then(r=>r.json()).catch(()=>({})),
            apiFetch('/client/email-templates').then(r=>r.json()).catch(()=>({})),
            apiFetch('/client/email-chains').then(r=>r.json()).catch(()=>({chains:[]}))
        ]);
        MK.settings  = settingsRes.settings || {};
        MK.templates = templatesRes.templates || [];
        MK.chains    = chainsRes.chains || [];
    } catch {}
    renderMarketing();
}

function setMKTab(tab, el) {
    MK.tab = tab;
    document.querySelectorAll('.mk-tab').forEach(b => {
        b.classList.remove('active-tab');
        b.style.borderBottom = '';
    });
    if (el) {
        el.classList.add('active-tab');
        el.style.borderBottom = '2px solid var(--text-0)';
    }
    renderMarketing();
}

function renderMarketing() {
    const el = document.getElementById('marketingContent');
    if (!el) return;

    const brevoMissing = !MK.settings?.brevo_api_key_set && !MK.settings?.brevo_api_key;
    const brevoWarning = brevoMissing ? `
        <div style="background:#f59e0b22;border:1px solid #f59e0b44;border-radius:var(--r-md);padding:14px 18px;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" style="width:18px;height:18px;flex-shrink:0;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <span style="font-size:13px;color:#f59e0b;font-weight:600;">Brevo not configured. <a href="#" onclick="navigateTo('settings')" style="color:#f59e0b;text-decoration:underline;">Set up in Settings →</a></span>
        </div>` : '';

    if (MK.tab === 'templates') {
        el.innerHTML = brevoWarning + `
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;">
                <div onclick="openTemplateBuilder(null)" style="border:2px dashed var(--border);border-radius:var(--r-lg);padding:28px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--text-3);transition:border-color .2s;" onmouseover="this.style.borderColor='var(--text-0)'" onmouseout="this.style.borderColor='var(--border)'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span style="font-size:13px;font-weight:600;">New Template</span>
                </div>
                ${MK.templates.map(t => `
                    <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 22px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                            <div>
                                <div style="font-size:14px;font-weight:700;color:var(--text-0);">${escHtml(t.name)}</div>
                                <div style="font-size:11px;color:var(--text-3);margin-top:2px;">${escHtml(t.topic||'custom')}</div>
                            </div>
                            ${t.is_automated ? `<span style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:0.5px;padding:3px 8px;border-radius:20px;background:#6366f122;color:#6366f1;">Auto</span>` : ''}
                        </div>
                        <div style="font-size:12px;color:var(--text-2);margin-bottom:14px;font-style:italic;">"${escHtml(t.subject)}"</div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-ghost btn-xs" onclick="openTemplateBuilder(${JSON.stringify(t).replace(/"/g,'&quot;')})">Edit</button>
                            <button class="btn btn-ghost btn-xs" onclick="sendTemplateNow(${t.id},'${escHtml(t.name)}')">Send</button>
                            <button class="btn btn-ghost btn-xs" style="color:#ef4444;" onclick="deleteTemplate(${t.id})">Delete</button>
                        </div>
                    </div>`).join('')}
                ${MK.templates.length === 0 ? `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-3);font-size:13px;">No templates yet. Click the card above to create your first one.</div>` : ''}
            </div>`;
    } else if (MK.tab === 'send') {
        el.innerHTML = brevoWarning + `
            <div style="max-width:640px;">
                <div class="card">
                    <div class="card-header"><span class="card-title">Send to Leads</span></div>
                    <div class="card-body">
                        <div class="form-field">
                            <label>Template</label>
                            <select id="sendTemplate">
                                <option value="">— Choose a template —</option>
                                ${MK.templates.map(t=>`<option value="${t.id}">${escHtml(t.name)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-field">
                            <label>Recipients</label>
                            <select id="sendRecipientType" onchange="updateRecipientCount()">
                                <option value="all">All leads</option>
                                <option value="cold">Cold leads only</option>
                                <option value="hot">Hot leads only</option>
                                <option value="mine">My assigned leads</option>
                                <option value="uncontacted">Never contacted</option>
                            </select>
                        </div>
                        <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-md);padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--text-2);" id="recipientCountInfo">
                            Loading recipient count...
                        </div>
                        <button class="btn btn-default" onclick="sendCampaignNow()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                            Send Campaign
                        </button>
                    </div>
                </div>
            </div>`;
        updateRecipientCount();
    } else if (MK.tab === 'chains') {
        el.innerHTML = brevoWarning + `
            <div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
                <button class="btn btn-default" onclick="openChainBuilder()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    New Chain
                </button>
            </div>
            ${MK.chains.length === 0
                ? `<div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:40px;height:40px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    <h3>No chains yet</h3>
                    <p>Build a chain to automate a sequence of emails that sends on a schedule and loops indefinitely.</p>
                   </div>`
                : MK.chains.map(c => `
                    <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 24px;margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                            <div>
                                <div style="font-size:15px;font-weight:700;">${escHtml(c.name)}</div>
                                <div style="font-size:11px;color:var(--text-3);margin-top:2px;">${c.steps?.length||0} steps · ${c.loop?'Loops indefinitely':'Runs once'}</div>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn btn-ghost btn-xs" onclick="enrollInChain(${c.id},'${escHtml(c.name)}')">Enroll Leads</button>
                                <button class="btn btn-ghost btn-xs" style="color:#ef4444;" onclick="deleteChain(${c.id})">Delete</button>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:0;flex-wrap:wrap;">
                            ${(c.steps||[]).map((s,i) => `
                                <div style="display:flex;align-items:center;">
                                    <div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--r-md);padding:8px 14px;font-size:12px;">
                                        <div style="font-weight:700;color:var(--text-0);">Step ${i+1}</div>
                                        <div style="color:var(--text-2);">${escHtml(s.template_name||'?')}</div>
                                        ${i > 0 ? `<div style="font-size:10px;color:var(--text-3);">After ${s.delay_days}d</div>` : ''}
                                    </div>
                                    ${i < (c.steps.length-1) ? `<div style="padding:0 6px;color:var(--text-3);">→</div>` : c.loop ? `<div style="padding:0 6px;color:#6366f1;font-size:11px;font-weight:700;">→ 🔄</div>` : ''}
                                </div>`).join('')}
                        </div>
                    </div>`).join('')
            }`;
    }
}

// ── Template Builder Modal ────────────────────────────────────────
function openTemplateBuilder(existing) {
    let modal = document.getElementById('templateBuilderModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'templateBuilderModal';
        modal.className = 'modal-overlay';
        modal.onclick = e => { if (e.target === modal) closeModal('templateBuilderModal'); };
        document.body.appendChild(modal);
    }

    const s = MK.settings || {};
    const t = existing || {};

    modal.innerHTML = `
        <div class="modal" style="max-width:700px;width:calc(100% - 32px);max-height:90vh;overflow-y:auto;">
            <div class="modal-header">
                <div class="modal-title">${existing ? 'Edit Template' : 'New Email Template'}</div>
                <button class="modal-close" onclick="closeModal('templateBuilderModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="modal-body">

                <!-- Company info (pre-filled from settings) -->
                <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-md);padding:16px 18px;margin-bottom:20px;">
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);margin-bottom:12px;">Your Company Info (from Settings)</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div class="form-field" style="margin:0;">
                            <label>Company Name</label>
                            <input class="form-input" id="tb_company" value="${escHtml(s.company_name||'')}" placeholder="Acme Corp">
                        </div>
                        <div class="form-field" style="margin:0;">
                            <label>Phone</label>
                            <input class="form-input" id="tb_phone" value="${escHtml(s.company_phone||'')}" placeholder="(555) 000-0000">
                        </div>
                        <div class="form-field" style="margin:0;">
                            <label>Email</label>
                            <input class="form-input" id="tb_email" value="${escHtml(s.company_email||'')}" placeholder="hello@yourco.com">
                        </div>
                        <div class="form-field" style="margin:0;">
                            <label>Website URL</label>
                            <input class="form-input" id="tb_website" value="${escHtml(s.website_url||'')}" placeholder="https://yourwebsite.com">
                        </div>
                        <div class="form-field" style="margin:0;grid-column:1/-1;">
                            <label>Company Address</label>
                            <input class="form-input" id="tb_address" value="${escHtml(s.company_address||'')}" placeholder="123 Main St, Austin TX 78701">
                        </div>
                    </div>
                </div>

                <!-- Template details -->
                <div class="form-row">
                    <div class="form-field">
                        <label>Template Name</label>
                        <input class="form-input" id="tb_name" value="${escHtml(t.name||'')}" placeholder="e.g. First Touch, Follow-up #2">
                    </div>
                    <div class="form-field">
                        <label>Email Subject Line</label>
                        <input class="form-input" id="tb_subject" value="${escHtml(t.subject||'')}" placeholder="Quick question for you">
                    </div>
                </div>

                <div class="form-field">
                    <label>Topic — choose one to auto-generate a template</label>
                    <select id="tb_topic" onchange="applyTopicTemplate()">
                        <option value="">— Select a topic —</option>
                        ${EMAIL_TOPICS.map(o=>`<option value="${o.value}" ${t.topic===o.value?'selected':''}>${o.label}</option>`).join('')}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label>Eyebrow Text <span style="color:var(--text-3);font-weight:400;">(small caps above headline)</span></label>
                        <input class="form-input" id="tb_eyebrow" value="${escHtml(t.eyebrow||'')}" placeholder="REACHING OUT">
                    </div>
                    <div class="form-field">
                        <label>Headline</label>
                        <input class="form-input" id="tb_headline" value="${escHtml(t.headline||'')}" placeholder="We'd love to connect.">
                    </div>
                </div>

                <div class="form-field">
                    <label>Email Body <span style="color:var(--text-3);font-weight:400;">(HTML supported)</span></label>
                    <textarea class="form-input" id="tb_body" rows="8" style="resize:vertical;font-family:var(--font-mono);font-size:12px;">${escHtml(t.body_html||'')}</textarea>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label>CTA Button Label</label>
                        <input class="form-input" id="tb_cta" value="${escHtml(t.cta_label||'Learn More')}" placeholder="Visit Our Website">
                    </div>
                    <div class="form-field">
                        <label>Accent Color</label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="color" id="tb_color" value="${s.accent_color||'#FF6B35'}" style="width:44px;height:38px;border:none;border-radius:var(--r-sm);cursor:pointer;padding:2px;">
                            <input class="form-input" id="tb_color_hex" value="${s.accent_color||'#FF6B35'}" placeholder="#FF6B35" style="flex:1;" oninput="document.getElementById('tb_color').value=this.value">
                        </div>
                    </div>
                </div>

                <!-- Schedule button -->
                <div style="border:1px solid var(--border);border-radius:var(--r-md);padding:16px;margin-top:4px;margin-bottom:12px;">
                    <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-2);margin-bottom:10px;">Schedule Appointment Button</div>
                    <div style="font-size:12px;color:var(--text-3);margin-bottom:10px;">A "Book a Time" button will appear in the email. When a cold lead clicks it, they automatically become a Hot lead.</div>
                    <div class="form-row">
                        <div class="form-field" style="margin:0;">
                            <label>Button Label</label>
                            <input class="form-input" id="tb_schedule_label" value="${escHtml(t.schedule_btn_label||'📅 Book a Time')}" placeholder="📅 Book a Time">
                        </div>
                        <div class="form-field" style="margin:0;">
                            <label>Include in Email?</label>
                            <select class="form-select" id="tb_include_schedule">
                                <option value="yes" ${t.include_schedule_btn !== false ? 'selected' : ''}>Yes — include schedule button</option>
                                <option value="no" ${t.include_schedule_btn === false ? 'selected' : ''}>No — skip schedule button</option>
                            </select>
                        </div>
                    </div>
                </div>

                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-top:4px;">
                    <input type="checkbox" id="tb_automated" ${t.is_automated?'checked':''}>
                    Mark as automated (for use in chains)
                </label>

                <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
                    <div style="font-size:11px;color:var(--text-3);margin-bottom:4px;">✓ Unsubscribe link will be automatically added to every email footer.</div>
                    <div style="font-size:11px;color:var(--text-3);">✓ Website button click triggers cold → hot lead conversion.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('templateBuilderModal')">Cancel</button>
                <button class="btn btn-ghost" onclick="previewTemplate()">Preview</button>
                <button class="btn btn-default" onclick="saveTemplate(${existing ? existing.id : 'null'})">Save Template</button>
            </div>
        </div>`;

    // Sync color hex field with color picker
    document.getElementById('tb_color').addEventListener('input', function() {
        document.getElementById('tb_color_hex').value = this.value;
    });

    openModal('templateBuilderModal');
}

function applyTopicTemplate() {
    const topic = document.getElementById('tb_topic').value;
    if (!topic || topic === 'custom') return;
    const tmpl = TOPIC_TEMPLATES[topic];
    if (!tmpl) return;
    if (tmpl.eyebrow)  document.getElementById('tb_eyebrow').value  = tmpl.eyebrow;
    if (tmpl.headline) document.getElementById('tb_headline').value = tmpl.headline;
    if (tmpl.body)     document.getElementById('tb_body').value     = tmpl.body;
    if (tmpl.cta)      document.getElementById('tb_cta').value      = tmpl.cta;
}

async function saveTemplate(existingId) {
    const name     = document.getElementById('tb_name').value.trim();
    const subject  = document.getElementById('tb_subject').value.trim();
    const body_html= document.getElementById('tb_body').value.trim();
    if (!name)     { toast('Template name required', 'error'); return; }
    if (!subject)  { toast('Subject line required', 'error');  return; }
    if (!body_html){ toast('Email body required', 'error');    return; }

    // Save company info back to settings if changed
    const settingsPayload = {
        company_name:    document.getElementById('tb_company').value.trim(),
        company_phone:   document.getElementById('tb_phone').value.trim(),
        company_email:   document.getElementById('tb_email').value.trim(),
        company_address: document.getElementById('tb_address').value.trim(),
        website_url:     document.getElementById('tb_website').value.trim(),
        accent_color:    document.getElementById('tb_color_hex').value.trim(),
    };
    apiFetch('/client/email-settings', 'PUT', settingsPayload).catch(()=>{});
    Object.assign(MK.settings, settingsPayload);

    const payload = {
        name, subject, body_html,
        topic:                document.getElementById('tb_topic').value,
        eyebrow:              document.getElementById('tb_eyebrow').value.trim(),
        headline:             document.getElementById('tb_headline').value.trim(),
        cta_label:            document.getElementById('tb_cta').value.trim(),
        schedule_btn_label:   document.getElementById('tb_schedule_label')?.value.trim() || '📅 Book a Time',
        include_schedule_btn: document.getElementById('tb_include_schedule')?.value !== 'no',
        is_automated: document.getElementById('tb_automated').checked,
    };

    try {
        const method = existingId ? 'PUT' : 'POST';
        const url    = existingId ? `/client/email-templates/${existingId}` : '/client/email-templates';
        const res = await apiFetch(url, method, payload);
        const data = await res.json();
        if (data.success || data.template) {
            toast('Template saved', 'success');
            closeModal('templateBuilderModal');
            await loadMarketing();
        } else { toast(data.message||'Failed to save', 'error'); }
    } catch(e) { toast('Error saving template', 'error'); }
}

async function deleteTemplate(id) {
    if (!confirm('Delete this template?')) return;
    try {
        await apiFetch(`/client/email-templates/${id}`, 'DELETE');
        toast('Template deleted', 'success');
        await loadMarketing();
    } catch { toast('Error', 'error'); }
}

async function sendTemplateNow(templateId, templateName) {
    if (!confirm(`Send "${templateName}" to your selected leads?`)) return;
    document.getElementById('sendTemplate').value = templateId;
    setMKTab('send', document.querySelector('[data-mktab=send]'));
}

// ── Campaign send ─────────────────────────────────────────────────
let _campaignLeadIds = [];

async function updateRecipientCount() {
    const el = document.getElementById('recipientCountInfo');
    if (!el) return;
    const type = document.getElementById('sendRecipientType')?.value || 'all';
    try {
        const res  = await apiFetch('/client/leads');
        const data = await res.json();
        let leads  = data.leads || [];
        if (type === 'cold')        leads = leads.filter(l => l.lead_temperature !== 'hot');
        if (type === 'hot')         leads = leads.filter(l => l.lead_temperature === 'hot');
        if (type === 'mine')        leads = leads.filter(l => l.assigned_to_email === S.user?.email);
        if (type === 'uncontacted') leads = leads.filter(l => !l.last_contact_date);
        _campaignLeadIds = leads.map(l => l.id);
        el.innerHTML = `<strong>${leads.length}</strong> recipient${leads.length !== 1 ? 's' : ''} will receive this campaign.`;
    } catch { el.textContent = 'Could not load recipient count'; }
}

async function sendCampaignNow() {
    const templateId = document.getElementById('sendTemplate')?.value;
    if (!templateId) { toast('Select a template first', 'error'); return; }
    if (!_campaignLeadIds.length) { toast('No recipients found', 'error'); return; }
    if (!confirm(`Send to ${_campaignLeadIds.length} leads?`)) return;
    try {
        const res = await apiFetch('/client/email/send', 'POST', { template_id: parseInt(templateId), lead_ids: _campaignLeadIds });
        const data = await res.json();
        if (data.success) {
            toast(`Campaign sent — ${data.sent} delivered, ${data.skipped} skipped, ${data.errors} errors`, 'success');
        } else { toast(data.message||'Failed', 'error'); }
    } catch(e) { toast('Error sending campaign', 'error'); }
}

// ── Chain Builder Modal ───────────────────────────────────────────
let _chainSteps = [];

async function openChainBuilder() {
    _chainSteps = [];
    let modal = document.getElementById('chainBuilderModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'chainBuilderModal';
        modal.className = 'modal-overlay';
        modal.onclick = e => { if (e.target === modal) closeModal('chainBuilderModal'); };
        document.body.appendChild(modal);
    }
    renderChainBuilderModal(modal);
    openModal('chainBuilderModal');
}

function renderChainBuilderModal(modal) {
    modal.innerHTML = `
        <div class="modal" style="max-width:600px;width:calc(100% - 32px);">
            <div class="modal-header">
                <div class="modal-title">Build Email Chain</div>
                <button class="modal-close" onclick="closeModal('chainBuilderModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Chain Name</label>
                    <input class="form-input" id="chainName" placeholder="e.g. New Lead Nurture Sequence">
                </div>
                <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-bottom:16px;">
                    <input type="checkbox" id="chainLoop" checked>
                    Loop indefinitely (repeats after last step)
                </label>

                <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);margin-bottom:10px;">Steps</div>
                <div id="chainStepsList">
                    ${_chainSteps.length === 0 ? `<p style="color:var(--text-3);font-size:13px;">No steps yet. Add a template below.</p>` : ''}
                </div>

                <div style="background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-md);padding:14px 16px;margin-top:12px;">
                    <div style="font-size:12px;font-weight:600;color:var(--text-2);margin-bottom:10px;">Add Step</div>
                    <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;">
                        <div class="form-field" style="flex:2;min-width:160px;margin:0;">
                            <label>Template</label>
                            <select id="chainAddTemplate">
                                <option value="">— Choose —</option>
                                ${MK.templates.map(t=>`<option value="${t.id}" data-name="${escHtml(t.name)}">${escHtml(t.name)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-field" style="width:110px;margin:0;">
                            <label>Delay (days)</label>
                            <input class="form-input" id="chainAddDelay" type="number" min="1" max="365" value="3" placeholder="3">
                        </div>
                        <button class="btn btn-ghost" style="margin-bottom:2px;" onclick="addChainStep()">Add</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('chainBuilderModal')">Cancel</button>
                <button class="btn btn-default" onclick="saveChain()">Save Chain</button>
            </div>
        </div>`;
    renderChainStepsList();
}

function renderChainStepsList() {
    const el = document.getElementById('chainStepsList');
    if (!el) return;
    if (!_chainSteps.length) { el.innerHTML = `<p style="color:var(--text-3);font-size:13px;">No steps yet.</p>`; return; }
    el.innerHTML = _chainSteps.map((s, i) => `
        <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-md);margin-bottom:6px;">
            <div style="font-size:12px;font-weight:700;color:var(--text-3);width:20px;">S${i+1}</div>
            <div style="flex:1;font-size:13px;font-weight:600;">${escHtml(s.name)}</div>
            <div style="font-size:12px;color:var(--text-3);">${i === 0 ? 'Immediate' : `After ${s.delay_days}d`}</div>
            <button class="btn btn-ghost btn-xs" style="color:#ef4444;" onclick="_chainSteps.splice(${i},1);renderChainStepsList()">✕</button>
        </div>`).join('');
}

function addChainStep() {
    const sel   = document.getElementById('chainAddTemplate');
    const delay = parseInt(document.getElementById('chainAddDelay').value) || 3;
    const id    = sel.value;
    const name  = sel.options[sel.selectedIndex]?.dataset?.name || sel.options[sel.selectedIndex]?.text || '?';
    if (!id) { toast('Select a template', 'error'); return; }
    _chainSteps.push({ template_id: parseInt(id), name, delay_days: delay });
    renderChainStepsList();
}

async function saveChain() {
    const name = document.getElementById('chainName')?.value.trim();
    const loop = document.getElementById('chainLoop')?.checked !== false;
    if (!name) { toast('Chain name required', 'error'); return; }
    if (_chainSteps.length < 2) { toast('A chain needs at least 2 steps', 'error'); return; }
    try {
        const res  = await apiFetch('/client/email-chains', 'POST', { name, loop, steps: _chainSteps });
        const data = await res.json();
        if (data.success || data.chain) {
            toast('Chain saved', 'success');
            closeModal('chainBuilderModal');
            await loadMarketing();
        } else { toast(data.message||'Failed', 'error'); }
    } catch { toast('Error saving chain', 'error'); }
}

async function deleteChain(id) {
    if (!confirm('Delete this chain?')) return;
    try {
        await apiFetch(`/client/email-chains/${id}`, 'DELETE');
        toast('Chain deleted', 'success');
        await loadMarketing();
    } catch { toast('Error', 'error'); }
}

// ── Enroll leads in chain ─────────────────────────────────────────
async function enrollInChain(chainId, chainName) {
    const res  = await apiFetch('/client/leads');
    const data = await res.json();
    const leads = data.leads || [];

    let modal = document.getElementById('enrollModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'enrollModal';
        modal.className = 'modal-overlay';
        modal.onclick = e => { if (e.target === modal) closeModal('enrollModal'); };
        document.body.appendChild(modal);
    }
    modal.innerHTML = `
        <div class="modal" style="max-width:460px;width:calc(100% - 32px);">
            <div class="modal-header">
                <div class="modal-title">Enroll in Chain</div>
                <div style="font-size:13px;color:var(--text-3);">${escHtml(chainName)}</div>
                <button class="modal-close" onclick="closeModal('enrollModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Enroll which leads?</label>
                    <select id="enrollType">
                        <option value="all">All leads (${leads.length})</option>
                        <option value="cold">Cold leads (${leads.filter(l=>l.lead_temperature!=='hot').length})</option>
                        <option value="hot">Hot leads (${leads.filter(l=>l.lead_temperature==='hot').length})</option>
                        <option value="mine">My assigned leads (${leads.filter(l=>l.assigned_to_email===S.user?.email).length})</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('enrollModal')">Cancel</button>
                <button class="btn btn-default" onclick="confirmEnroll(${chainId})">Enroll</button>
            </div>
        </div>`;
    openModal('enrollModal');
    // Store leads for enroll
    window._enrollLeads = leads;
    window._enrollChainId = chainId;
}

async function confirmEnroll(chainId) {
    const type  = document.getElementById('enrollType').value;
    let leads   = window._enrollLeads || [];
    if (type === 'cold') leads = leads.filter(l => l.lead_temperature !== 'hot');
    if (type === 'hot')  leads = leads.filter(l => l.lead_temperature === 'hot');
    if (type === 'mine') leads = leads.filter(l => l.assigned_to_email === S.user?.email);
    if (!leads.length) { toast('No leads match', 'error'); return; }
    try {
        const res  = await apiFetch('/client/email/enroll', 'POST', { chain_id: chainId, lead_ids: leads.map(l=>l.id) });
        const data = await res.json();
        if (data.success) {
            toast(`${data.enrolled} leads enrolled in chain`, 'success');
            closeModal('enrollModal');
        } else { toast(data.message||'Failed', 'error'); }
    } catch { toast('Error enrolling leads', 'error'); }
}

// ============================================================
// SETTINGS
// ============================================================
async function loadSettings() {
    document.getElementById('settingsName').value  = S.user.name  || '';
    document.getElementById('settingsEmail').value = S.user.email || '';

    // Show username field (read-only) for basic (non-admin) users only
    const usernameField = document.getElementById('settingsUsernameField');
    const usernameInput = document.getElementById('settingsUsername');
    if (!S.isAdmin && usernameField && usernameInput) {
        // Username is typically the part before @ in email, or user may have a separate username
        // Use S.user.username if available, otherwise email prefix
        const uname = S.user.username || S.user.email || '';
        usernameInput.value = uname;
        usernameField.style.display = '';
    } else if (usernameField) {
        usernameField.style.display = 'none';
    }

    // Load Brevo settings
    try {
        const res  = await apiFetch('/client/email-settings');
        const data = await res.json();
        const s    = data.settings || {};
        MK.settings = s;
        const fill = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
        fill('settingsBrevoKey',          s.brevo_api_key_set ? '••••••••••••••••' : (s.brevo_api_key||''));
        fill('settingsSenderEmail',        s.sender_email);
        fill('settingsSenderName',         s.sender_name);
        fill('settingsCompanyName',        s.company_name);
        fill('settingsCompanyPhone',       s.company_phone);
        fill('settingsCompanyEmail',       s.company_email);
        fill('settingsCompanyAddr',        s.company_address);
        fill('settingsWebsiteUrl',         s.website_url);
        fill('settingsAccentColor',        s.accent_color || '#FF6B35');
        fill('settingsEmailJSService',     s.emailjs_service_id);
        fill('settingsEmailJSTemplate',    s.emailjs_template_id);
        fill('settingsEmailJSPublicKey',   s.emailjs_public_key);
        const colorPicker = document.getElementById('settingsColorPicker');
        if (colorPicker) colorPicker.value = s.accent_color || '#FF6B35';

        if (s.brevo_api_key_set) {
            const keyInput = document.getElementById('settingsBrevoKey');
            if (keyInput) {
                keyInput.placeholder = 'API key is set — type new key to update';
                keyInput.style.fontFamily = 'var(--font-mono)';
            }
        }
    } catch {}
}

async function saveEmailSettings() {
    const brevoKey = document.getElementById('settingsBrevoKey')?.value?.trim();
    const payload  = {
        sender_email:          document.getElementById('settingsSenderEmail')?.value?.trim(),
        sender_name:           document.getElementById('settingsSenderName')?.value?.trim(),
        company_name:          document.getElementById('settingsCompanyName')?.value?.trim(),
        company_phone:         document.getElementById('settingsCompanyPhone')?.value?.trim(),
        company_email:         document.getElementById('settingsCompanyEmail')?.value?.trim(),
        company_address:       document.getElementById('settingsCompanyAddr')?.value?.trim(),
        website_url:           document.getElementById('settingsWebsiteUrl')?.value?.trim(),
        accent_color:          document.getElementById('settingsAccentColor')?.value?.trim(),
        emailjs_service_id:    document.getElementById('settingsEmailJSService')?.value?.trim(),
        emailjs_template_id:   document.getElementById('settingsEmailJSTemplate')?.value?.trim(),
        emailjs_public_key:    document.getElementById('settingsEmailJSPublicKey')?.value?.trim(),
    };
    // Only include brevo key if user typed a non-masked value
    if (brevoKey && !brevoKey.includes('•')) payload.brevo_api_key = brevoKey;

    try {
        const res  = await apiFetch('/client/email-settings', 'PUT', payload);
        const data = await res.json();
        toast(data.success ? 'Settings saved' : (data.message||'Failed'), data.success ? 'success' : 'error');
        if (data.success) await loadSettings();
    } catch { toast('Error saving settings', 'error'); }
}



async function saveProfile() {
    const name = document.getElementById('settingsName').value.trim();
    if (!name) { toast('Name required', 'error'); return; }
    try {
        const res = await apiFetch('/client/profile', 'PUT', { name });
        const data = await res.json();
        if (data.success) {
            S.user.name = name;
            localStorage.setItem('clientUser', JSON.stringify(S.user));
            document.getElementById('sidebarName').textContent = name;
            toast('Profile updated', 'success');
        } else {
            toast(data.message||'Failed', 'error');
        }
    } catch { toast('Error', 'error'); }
}

async function changePassword() {
    const current = document.getElementById('currentPw').value;
    const newPw   = document.getElementById('newPw').value;
    const confirm = document.getElementById('confirmPw').value;
    if (!current||!newPw) { toast('All fields required', 'error'); return; }
    if (newPw !== confirm) { toast('Passwords do not match', 'error'); return; }

    try {
        const res = await apiFetch('/client/change-password', 'POST', { currentPassword: current, newPassword: newPw });
        const data = await res.json();
        if (data.success) {
            toast('Password updated', 'success');
            ['currentPw','newPw','confirmPw'].forEach(id=>document.getElementById(id).value='');
        } else {
            toast(data.message||'Failed', 'error');
        }
    } catch { toast('Error', 'error'); }
}

// ============================================================
// ADMIN VALIDATION
// ============================================================
function requireValidation(message) {
    return new Promise((resolve) => {
        document.getElementById('validationDesc').textContent = message || 'Confirm your password to continue.';
        document.getElementById('validationPassword').value = '';
        S.validationCallback = resolve;
        openModal('adminValidationModal');
    });
}

async function confirmValidation() {
    const pw = document.getElementById('validationPassword').value;
    if (!pw) { toast('Enter your password', 'error'); return; }

    try {
        const res = await apiFetch('/client/validate-password', 'POST', { password: pw });
        const data = await res.json();
        if (data.success || data.valid) {
            closeModal('adminValidationModal');
            if (S.validationCallback) { S.validationCallback(true); S.validationCallback = null; }
        } else {
            toast('Incorrect password', 'error');
            if (S.validationCallback) { S.validationCallback(false); }
        }
    } catch {
        toast('Verification error', 'error');
        if (S.validationCallback) { S.validationCallback(false); S.validationCallback = null; }
    }
}

// ============================================================
// MODAL HELPERS
// ============================================================
function openModal(id) { document.getElementById(id)?.classList.add('open'); }
function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }
function closeOnOverlay(e, id) { if(e.target===document.getElementById(id)) closeModal(id); }

// ============================================================
// TOAST
// ============================================================
function toast(message, type='success') {
    const container = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    const icon = type==='success'
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
    el.innerHTML = icon + `<span>${escHtml(message)}</span>`;
    container.appendChild(el);
    setTimeout(() => el.remove(), 3500);
}

// ============================================================
// EMAIL SENDING — Brevo primary, EmailJS fallback
// ============================================================
async function sendEmailWithFallback(leadId, leadEmail, leadName, templateId, scheduleConversion) {
    const settings = MK.settings || {};
    const hasBrevo   = settings.brevo_api_key_set || settings.brevo_api_key;
    const hasEmailJS = settings.emailjs_service_id && settings.emailjs_template_id && settings.emailjs_public_key;

    // Always try the server route first — it handles Brevo and returns
    // an emailjsQueue if EmailJS fallback is needed.
    const res  = await apiFetch('/client/email/send', 'POST', {
        template_id: parseInt(templateId),
        lead_ids: [leadId],
        schedule_conversion: scheduleConversion || false,
    });
    const data = await res.json();

    // If server returned EmailJS payloads, send them from the browser now
    if (data.emailjsQueue && data.emailjsQueue.length > 0) {
        await _flushEmailJSQueue(data.emailjsQueue);
        // Count the EmailJS sends as "sent" for the UI
        data.sent = (data.sent || 0) + data.emailjsQueue.length;
    }

    return data;
}

// Sends all EmailJS payloads returned by the server (client-side only)
async function _flushEmailJSQueue(queue) {
    if (!queue || !queue.length) return;
    const settings = MK.settings || {};

    // Dynamically load EmailJS SDK if not already loaded
    if (typeof emailjs === 'undefined') {
        await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
            s.onload = resolve; s.onerror = reject;
            document.head.appendChild(s);
        });
    }
    emailjs.init(settings.emailjs_public_key);

    // The "from" email is always the logged-in user's sending email
    const senderEmail = S.user.sending_email || S.user.email;

    for (const item of queue) {
        try {
            await emailjs.send(item.serviceId, item.templateId, {
                ...item.templateParams,
                // Override from_email with the actual logged-in user's email
                from_email:  senderEmail,
                from_name:   S.user.name || senderEmail,
                reply_to:    senderEmail,
                to_name:     item.leadName || item.leadEmail,
                to_email:    item.leadEmail,
                subject:     item.templateParams?.subject || '',
            });
            // Record the EmailJS send so analytics are tracked
            await apiFetch('/client/email/record-send', 'POST', {
                lead_id: item.leadId, template_id: item.templateId || null, log_id: item.logId
            }).catch(() => {});
        } catch(e) {
            console.error('[EmailJS] Send failed for', item.leadEmail, e?.text || e?.message || e);
        }
    }
}

// When a lead clicks the schedule link in an email, they become hot
async function convertLeadToHot(leadId) {
    try {
        const res = await apiFetch(`/client/leads/${leadId}/temperature`, 'POST', { temperature: 'hot', reason: 'schedule_button_click' });
        const data = await res.json();
        return data.success;
    } catch { return false; }
}

// ============================================================
// HELPERS
// ============================================================
function escHtml(str) {
    if (!str && str !== 0) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function fmtDate(d) {
    if (!d) return '—';
    return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}

function fmtDateTime(d) {
    if (!d) return '—';
    return new Date(d).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
}

function fmtSize(bytes) {
    if (!bytes) return '0 B';
    if (bytes<1024) return bytes+' B';
    if (bytes<1024*1024) return (bytes/1024).toFixed(1)+' KB';
    return (bytes/(1024*1024)).toFixed(1)+' MB';
}

function statusBadge(status) {
    const map = {
        new:       'badge-gray',
        contacted: 'badge-blue',
        pending:   'badge-yellow',
        qualified: 'badge-purple',
        converted: 'badge-green',
        active:    'badge-green',
        hot:       'badge-red',
        warm:      'badge-yellow',
        cold:      'badge-gray',
        scheduled: 'badge-blue',
        open:      'badge-red',
        resolved:  'badge-green',
        closed:    'badge-gray',
        'in-progress': 'badge-yellow',
    };
    return `<span class="badge ${map[status?.toLowerCase()]||'badge-gray'}">${escHtml(status||'—')}</span>`;
}
</script>
</body>
</html>